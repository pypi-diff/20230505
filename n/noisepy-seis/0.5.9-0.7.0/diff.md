# Comparing `tmp/noisepy_seis-0.5.9.tar.gz` & `tmp/noisepy_seis-0.7.0.tar.gz`

## Comparing `noisepy_seis-0.5.9.tar` & `noisepy_seis-0.7.0.tar`

### file list

```diff
@@ -1,17 +1,24 @@
--rw-r--r--   0        0        0    13086 2020-02-02 00:00:00.000000 noisepy_seis-0.5.9/src/noisepy/seis/S0A_download_ASDF_MPI.py
--rw-r--r--   0        0        0     9645 2020-02-02 00:00:00.000000 noisepy_seis-0.5.9/src/noisepy/seis/S0B_to_ASDF.py
--rw-r--r--   0        0        0    19873 2020-02-02 00:00:00.000000 noisepy_seis-0.5.9/src/noisepy/seis/S1_fft_cc_MPI.py
--rw-r--r--   0        0        0    16250 2020-02-02 00:00:00.000000 noisepy_seis-0.5.9/src/noisepy/seis/S2_stacking.py
--rw-r--r--   0        0        0     1292 2020-02-02 00:00:00.000000 noisepy_seis-0.5.9/src/noisepy/seis/__init__.py
--rw-r--r--   0        0        0     3668 2020-02-02 00:00:00.000000 noisepy_seis-0.5.9/src/noisepy/seis/main.py
--rw-r--r--   0        0        0   112593 2020-02-02 00:00:00.000000 noisepy_seis-0.5.9/src/noisepy/seis/noise_module.py
--rw-r--r--   0        0        0    35203 2020-02-02 00:00:00.000000 noisepy_seis-0.5.9/src/noisepy/seis/plotting_modules.py
--rw-r--r--   0        0        0    12253 2020-02-02 00:00:00.000000 noisepy_seis-0.5.9/src/noisepy/seis/application_modules/comp_stacking.py
--rw-r--r--   0        0        0     6880 2020-02-02 00:00:00.000000 noisepy_seis-0.5.9/src/noisepy/seis/application_modules/dispersion_analysis.py
--rw-r--r--   0        0        0    14886 2020-02-02 00:00:00.000000 noisepy_seis-0.5.9/src/noisepy/seis/application_modules/measure_dvv.py
--rw-r--r--   0        0        0     4697 2020-02-02 00:00:00.000000 noisepy_seis-0.5.9/src/noisepy/seis/application_modules/write_sac.py
--rw-r--r--   0        0        0       21 2020-02-02 00:00:00.000000 noisepy_seis-0.5.9/.gitignore
--rw-r--r--   0        0        0     1088 2020-02-02 00:00:00.000000 noisepy_seis-0.5.9/LICENSE
--rw-r--r--   0        0        0    13682 2020-02-02 00:00:00.000000 noisepy_seis-0.5.9/README.md
--rw-r--r--   0        0        0     1529 2020-02-02 00:00:00.000000 noisepy_seis-0.5.9/pyproject.toml
--rw-r--r--   0        0        0    16027 2020-02-02 00:00:00.000000 noisepy_seis-0.5.9/PKG-INFO
+-rw-r--r--   0        0        0    11984 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/S0A_download_ASDF_MPI.py
+-rw-r--r--   0        0        0     9641 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/S0B_to_ASDF.py
+-rw-r--r--   0        0        0    12728 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/S1_fft_cc_MPI.py
+-rw-r--r--   0        0        0    16328 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/S2_stacking.py
+-rw-r--r--   0        0        0     1484 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/__init__.py
+-rw-r--r--   0        0        0      160 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/_version.py
+-rw-r--r--   0        0        0     6493 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/asdfstore.py
+-rw-r--r--   0        0        0     5179 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/channelcatalog.py
+-rw-r--r--   0        0        0      158 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/constants.py
+-rw-r--r--   0        0        0     5521 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/datatypes.py
+-rw-r--r--   0        0        0     6793 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/main.py
+-rw-r--r--   0        0        0   112952 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/noise_module.py
+-rw-r--r--   0        0        0    35394 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/plotting_modules.py
+-rw-r--r--   0        0        0     4346 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/scedc_s3store.py
+-rw-r--r--   0        0        0     1994 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/stores.py
+-rw-r--r--   0        0        0    12253 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/application_modules/comp_stacking.py
+-rw-r--r--   0        0        0     6880 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/application_modules/dispersion_analysis.py
+-rw-r--r--   0        0        0    14886 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/application_modules/measure_dvv.py
+-rw-r--r--   0        0        0     4697 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/src/noisepy/seis/application_modules/write_sac.py
+-rw-r--r--   0        0        0     3223 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/.gitignore
+-rw-r--r--   0        0        0     1088 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/LICENSE
+-rw-r--r--   0        0        0     6327 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/README.md
+-rw-r--r--   0        0        0     1704 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/pyproject.toml
+-rw-r--r--   0        0        0     8729 2020-02-02 00:00:00.000000 noisepy_seis-0.7.0/PKG-INFO
```

### Comparing `noisepy_seis-0.5.9/src/noisepy/seis/S0A_download_ASDF_MPI.py` & `noisepy_seis-0.7.0/src/noisepy/seis/S0A_download_ASDF_MPI.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,26 +1,30 @@
 """ S0A_download_ASDF_MPI.py
     Step 0: Download module
 
    isort:skip_file
 """
 
 
+import logging
 import sys
 import time
 from typing import List
 import obspy
 import pyasdf
 import os
 import numpy as np
 import pandas as pd
+
+from noisepy.seis.datatypes import ConfigParameters
 from . import noise_module
 from mpi4py import MPI
 from obspy.clients.fdsn import Client
 
+logger = logging.getLogger(__name__)
 if not sys.warnoptions:
     import warnings
 
     warnings.simplefilter("ignore")
 
 """
 This script:
@@ -58,93 +62,52 @@
 #########################################################
 ################ PARAMETER SECTION ######################
 #########################################################
 tt0 = time.time()
 
 # download parameters
 client = Client("SCEDC")  # client/data center. see https://docs.obspy.org/packages/obspy.clients.fdsn.html for a list
-down_list = False  # download stations from a pre-compiled list or not
-flag = False  # print progress when running the script; recommend to use it at the begining
-samp_freq = 20  # targeted sampling rate at X samples per seconds
-rm_resp = "no"  # select 'no' to not remove response and use 'inv',
-# 'spectrum','RESP', or 'polozeros' to remove response
-freqmin = 0.05  # pre filtering frequency bandwidth
-freqmax = 2  # note this cannot exceed Nquist freq
-
-# targeted region/station information: only needed when down_list is False
-lamin, lamax, lomin, lomax = (
-    32.9,
-    35.9,
-    -120.7,
-    -118.5,
-)  # regional box: min lat, min lon, max lat, max lon (-114.0)
-net_list = ["CI"]  # network list
 
 # get rough estimate of memory needs to ensure it now below up in S1
-cc_len = 1800  # basic unit of data length for fft (s)
-step = 450  # overlapping between each cc_len (s)
 MAX_MEM = 5.0  # maximum memory allowed per core in GB
 
 ##################################################
 # we expect no parameters need to be changed below
 
 
 def download(
-    rootpath: str,
+    direc: str,
     chan_list: List[str],
     sta_list: List[str],
-    start_date: List[str],
-    end_date: List[str],
-    inc_hours: int,
+    prepro_para: ConfigParameters,
 ):
-    direc = os.path.join(rootpath, "RAW_DATA")  # where to store the downloaded data
     dlist = os.path.join(direc, "station.txt")  # CSV file for station location info
-    respdir = os.path.join(
-        rootpath, "resp"
+    prepro_para.respdir = os.path.join(
+        direc, "../resp"
     )  # directory where resp files are located (required if rm_resp is neither 'no' nor 'inv')
     # time tags
-    starttime = obspy.UTCDateTime(start_date[0])
-    endtime = obspy.UTCDateTime(end_date[0])
-    if flag:
-        print(
-            "station.list selected [%s] for data from %s to %s with %sh interval"
-            % (down_list, starttime, endtime, inc_hours)
-        )
-    print(
+    starttime = obspy.UTCDateTime(prepro_para.start_date)
+    endtime = obspy.UTCDateTime(prepro_para.end_date)
+    logger.debug(
+        "station.list selected [%s] for data from %s to %s with %sh interval"
+        % (prepro_para.down_list, starttime, endtime, prepro_para.inc_hours)
+    )
+    logger.info(
         f"""Download
         From: {starttime}
         To: {endtime}
         Stations: {sta_list}
         Channels: {chan_list}
         """
     )
     ncomp = len(chan_list)
-    # assemble parameters used for pre-processing
-    prepro_para = {
-        "rm_resp": rm_resp,
-        "respdir": respdir,
-        "freqmin": freqmin,
-        "freqmax": freqmax,
-        "samp_freq": samp_freq,
-        "start_date": str(starttime),
-        "end_date": str(endtime),
-        "inc_hours": inc_hours,
-        "cc_len": cc_len,
-        "step": step,
-        "MAX_MEM": MAX_MEM,
-        "lamin": lamin,
-        "lamax": lamax,
-        "lomin": lomin,
-        "lomax": lomax,
-        "ncomp": ncomp,
-    }
     metadata = os.path.join(direc, "download_info.txt")
 
     # prepare station info (existing station list vs. fetching from client)
-    if down_list:
+    if prepro_para.down_list:
         if not os.path.isfile(dlist):
             raise IOError("file %s not exist! double check!" % dlist)
 
         # read station info from list
         locs = pd.read_csv(dlist)
         nsta = len(locs)
         chan = list(locs.iloc[:]["channel"])
@@ -165,32 +128,31 @@
         net = []
         chan = []
         location = []
         lon = []
         lat = []
         elev = []
         nsta = 0
-
         # loop through specified network, station and channel lists
-        for inet in net_list:
+        for inet in prepro_para.net_list:
             for ista in sta_list:
                 for ichan in chan_list:
                     # gather station info
                     try:
                         inv = client.get_stations(
                             network=inet,
                             station=ista,
                             channel=ichan,
                             location="*",
                             starttime=starttime,
                             endtime=endtime,
-                            minlatitude=lamin,
-                            maxlatitude=lamax,
-                            minlongitude=lomin,
-                            maxlongitude=lomax,
+                            minlatitude=prepro_para.lamin,
+                            maxlatitude=prepro_para.lamax,
+                            minlongitude=prepro_para.lomin,
+                            maxlongitude=prepro_para.lomax,
                             level="response",
                         )
                     except Exception as e:
                         raise Exception("Abort at S0A client.get_stations due to " + str(e))
 
                     for K in inv:
                         for tsta in K:
@@ -203,20 +165,19 @@
                             # sometimes one station has many locations and
                             # here we only get the first location
                             if tsta[0].location_code:
                                 location.append(tsta[0].location_code)
                             else:
                                 location.append("*")
                             nsta += 1
-        prepro_para["nsta"] = nsta
 
     # rough estimation on memory needs (assume float32 dtype)
-    nsec_chunk = inc_hours / 24 * 86400
-    nseg_chunk = int(np.floor((nsec_chunk - cc_len) / step)) + 1
-    npts_chunk = int(nseg_chunk * cc_len * samp_freq)
+    nsec_chunk = prepro_para.inc_hours / 24 * 86400
+    nseg_chunk = int(np.floor((nsec_chunk - prepro_para.cc_len) / prepro_para.step)) + 1
+    npts_chunk = int(nseg_chunk * prepro_para.cc_len * prepro_para.samp_freq)
     memory_size = nsta * npts_chunk * 4 / 1024**3
     if memory_size > MAX_MEM:
         raise ValueError(
             "Require %5.3fG memory but only %5.3fG provided)! Reduce inc_hours to avoid this issue!"
             % (memory_size, MAX_MEM)
         )
 
@@ -226,21 +187,18 @@
 
     # --------MPI---------
     comm = MPI.COMM_WORLD
     rank = comm.Get_rank()
     size = comm.Get_size()
 
     if rank == 0:
-        if not os.path.isdir(rootpath):
-            os.mkdir(rootpath)
-        if not os.path.isdir(direc):
-            os.mkdir(direc)
+        os.makedirs(direc, exist_ok=True)
 
         # output station list
-        if not down_list:
+        if not prepro_para.down_list:
             dict = {
                 "network": net,
                 "station": sta,
                 "channel": chan,
                 "latitude": lat,
                 "longitude": lon,
                 "elevation": elev,
@@ -250,30 +208,29 @@
 
         # save parameters for future reference
         fout = open(metadata, "w")
         fout.write(str(prepro_para))
         fout.close()
 
         # get MPI variables ready
-        all_chunk = noise_module.get_event_list(start_date[0], end_date[0], inc_hours)
+        all_chunk = noise_module.get_event_list(prepro_para.start_date, prepro_para.end_date, prepro_para.inc_hours)
         if len(all_chunk) < 1:
-            raise ValueError("Abort! no data chunk between %s and %s" % (start_date[0], end_date[0]))
+            raise ValueError("Abort! no data chunk between %s and %s" % (prepro_para.start_date, prepro_para.end_date))
         splits = len(all_chunk) - 1
     else:
         splits, all_chunk = [None for _ in range(2)]
 
     # broadcast the variables
     splits = comm.bcast(splits, root=0)
     all_chunk = comm.bcast(all_chunk, root=0)
     tp = 0
     # MPI: loop through each time chunk
     for ick in range(rank, splits, size):
-        s1 = obspy.UTCDateTime(all_chunk[ick])
-        s2 = obspy.UTCDateTime(all_chunk[ick + 1])
-        date_info = {"starttime": s1, "endtime": s2}
+        starttime = obspy.UTCDateTime(all_chunk[ick])
+        endtime = obspy.UTCDateTime(all_chunk[ick + 1])
 
         # keep a track of the channels already exists
         num_records = np.zeros(nsta, dtype=np.int16)
 
         # filename of the ASDF file
         ff = os.path.join(direc, all_chunk[ick] + "T" + all_chunk[ick + 1] + ".h5")
         if not os.path.isfile(ff):
@@ -297,20 +254,20 @@
 
                 # get inventory for specific station
                 try:
                     sta_inv = client.get_stations(
                         network=net[ista],
                         station=sta[ista],
                         location=location[ista],
-                        starttime=s1,
-                        endtime=s2,
+                        starttime=starttime,
+                        endtime=endtime,
                         level="response",
                     )
                 except Exception as e:
-                    print(e)
+                    logger.error(e)
                     continue
 
                 # add the inventory for all components + all time of this tation
                 try:
                     ds.add_stationxml(sta_inv)
                 except Exception:
                     pass
@@ -319,42 +276,47 @@
                     # get data
                     t0 = time.time()
                     tr = client.get_waveforms(
                         network=net[ista],
                         station=sta[ista],
                         channel=chan[ista],
                         location=location[ista],
-                        starttime=s1,
-                        endtime=s2,
+                        starttime=starttime,
+                        endtime=endtime,
                     )
                     t1 = time.time()
                 except Exception as e:
-                    print(e, "for", sta[ista])
+                    logger.error(f"{e} for {sta[ista]}")
                     continue
 
                 # preprocess to clean data
-                print(sta[ista])
-                tr = noise_module.preprocess_raw(tr, sta_inv, prepro_para, date_info)
+                tr = noise_module.preprocess_raw(
+                    tr,
+                    sta_inv,
+                    prepro_para,
+                    starttime,
+                    endtime,
+                )
                 t2 = time.time()
                 tp += t2 - t1
 
                 if len(tr):
                     if location[ista] == "*":
                         tlocation = str("00")
                     else:
                         tlocation = location[ista]
                     new_tags = "{0:s}_{1:s}".format(chan[ista].lower(), tlocation.lower())
+                    # above we should change the dag for: net.sta.loc.chan
                     ds.add_waveforms(tr, tag=new_tags)
 
                 # if flag:
-                print(ds, new_tags)
-                print("downloading data %6.2f s; pre-process %6.2f s" % ((t1 - t0), (t2 - t1)))
+                logger.info("downloading data %6.2f s; pre-process %6.2f s" % ((t1 - t0), (t2 - t1)))
 
     tt1 = time.time()
-    print("downloading step takes %6.2f s with %6.2f for preprocess" % (tt1 - tt0, tp))
+    logger.info("downloading step takes %6.2f s with %6.2f for preprocess" % (tt1 - tt0, tp))
 
     comm.barrier()
 
 
 # Point people to new entry point:
 if __name__ == "__main__":
     print("Please see:\n\npython noisepy.py download --help\n")
```

### Comparing `noisepy_seis-0.5.9/src/noisepy/seis/S0B_to_ASDF.py` & `noisepy_seis-0.7.0/src/noisepy/seis/S0B_to_ASDF.py`

 * *Files 2% similar despite different names*

```diff
@@ -170,28 +170,27 @@
 allfiles = comm.bcast(allfiles, root=0)
 
 # MPI: loop through each time-chunk
 for ick in range(rank, splits, size):
     t0 = time.time()
 
     # time window defining the time-chunk
-    s1 = obspy.UTCDateTime(all_chunk[ick])
-    s2 = obspy.UTCDateTime(all_chunk[ick + 1])
-    date_info = {"starttime": s1, "endtime": s2}
-    time1 = s1 - obspy.UTCDateTime(1970, 1, 1)
-    time2 = s2 - obspy.UTCDateTime(1970, 1, 1)
+    starttime = obspy.UTCDateTime(all_chunk[ick])
+    endtime = obspy.UTCDateTime(all_chunk[ick + 1])
+    time1 = starttime - obspy.UTCDateTime(1970, 1, 1)
+    time2 = endtime - obspy.UTCDateTime(1970, 1, 1)
 
     # find all data pieces having data of the time-chunk
     indx1 = np.where((time1 >= all_stimes[:, 0]) & (time1 < all_stimes[:, 1]))[0]
     indx2 = np.where((time2 > all_stimes[:, 0]) & (time2 <= all_stimes[:, 1]))[0]
     indx3 = np.where((time1 <= all_stimes[:, 0]) & (time2 >= all_stimes[:, 1]))[0]
     indx4 = np.concatenate((indx1, indx2, indx3))
     indx = np.unique(indx4)
     if not len(indx):
-        print("continue! no data found between %s-%s" % (s1, s2))
+        print("continue! no data found between %s-%s" % (starttime, endtime))
         continue
 
     # trim down the sac/mseed file list with time in time-chunk
     tfiles = []
     for ii in indx:
         tfiles.append(allfiles[ii])
 
@@ -226,15 +225,15 @@
         # jump if no good data left
         if not len(source):
             continue
 
         # make inventory to save into ASDF file
         t1 = time.time()
         inv1 = noise_module.stats2inv(source[0].stats, prepro_para, locs=locs)
-        tr = noise_module.preprocess_raw(source, inv1, prepro_para, date_info)
+        tr = noise_module.preprocess_raw(source, inv1, prepro_para, starttime, endtime)
         # jump if no good data left
         if not len(tr):
             continue
         if np.all(tr[0].data == 0):
             continue
         t2 = time.time()
         if flag:
```

### Comparing `noisepy_seis-0.5.9/src/noisepy/seis/S2_stacking.py` & `noisepy_seis-0.7.0/src/noisepy/seis/S2_stacking.py`

 * *Files 5% similar despite different names*

```diff
@@ -1,19 +1,21 @@
 import glob
+import logging
 import os
 import sys
 import time
 
 import numpy as np
 import pandas as pd
 import pyasdf
 from mpi4py import MPI
 
 from . import noise_module
 
+logger = logging.getLogger(__name__)
 if not sys.warnoptions:
     import warnings
 
     warnings.simplefilter("ignore")
 
 """
 Stacking script of NoisePy to:
@@ -38,46 +40,43 @@
 ########################################
 # #######PARAMETER SECTION##############
 ########################################
 
 
 # define new stacking para
 keep_substack = False  # keep all sub-stacks in final ASDF file
-flag = True  # output intermediate args for debugging
 
 # new rotation para
 rotation = True  # rotation from E-N-Z to R-T-Z
 correction = False  # angle correction due to mis-orientation
 
 # maximum memory allowed per core in GB
 MAX_MEM = 4.0
 
 
 # TODO: make stack_method an enum
-def stack(rootpath: str, stack_method: str):
+def stack(raw_dir: str, ccf_dir: str, stack_dir: str, stack_method: str):
     if rotation and correction:
-        corrfile = os.path.join(rootpath, "meso_angles.txt")  # csv file containing angle info to be corrected
+        corrfile = os.path.join(ccf_dir, "../meso_angles.txt")  # csv file containing angle info to be corrected
         locs = pd.read_csv(corrfile)
     else:
         locs = []
 
     # absolute path parameters
-    CCFDIR = os.path.join(rootpath, "CCF")  # dir where CC data is stored
-    STACKDIR = os.path.join(rootpath, "STACK")  # dir where stacked data is going to
     locations = os.path.join(
-        rootpath, "RAW_DATA/station.txt"
+        raw_dir, "station.txt"
     )  # station info including network,station,channel,latitude,longitude,elevation
     if not os.path.isfile(locations):
         raise ValueError("Abort! station info is needed for this script")
 
     ##################################################
     # we expect no parameters need to be changed below
 
     # load fc_para parameters from Step1
-    fc_metadata = os.path.join(CCFDIR, "fft_cc_data.txt")
+    fc_metadata = os.path.join(ccf_dir, "fft_cc_data.txt")
     fc_para = eval(open(fc_metadata).read())
     ncomp = fc_para["ncomp"]
     samp_freq = fc_para["samp_freq"]
     start_date = fc_para["start_date"]
     end_date = fc_para["end_date"]
     inc_hours = fc_para["inc_hours"]
     cc_len = fc_para["cc_len"]
@@ -95,55 +94,55 @@
     rtz_components = ["ZR", "ZT", "ZZ", "RR", "RT", "RZ", "TR", "TT", "TZ"]
 
     # make a dictionary to store all variables: also for later cc
     stack_para = {
         "samp_freq": samp_freq,
         "cc_len": cc_len,
         "step": step,
-        "rootpath": rootpath,
-        "STACKDIR": STACKDIR,
-        "start_date": start_date[0],
-        "end_date": end_date[0],
+        "stack_dir": stack_dir,
+        "start_date": start_date,
+        "end_date": end_date,
         "inc_hours": inc_hours,
         "substack": substack,
         "substack_len": substack_len,
         "maxlag": maxlag,
         "keep_substack": keep_substack,
         "stack_method": stack_method,
         "rotation": rotation,
         "correction": correction,
     }
     # save fft metadata for future reference
-    stack_metadata = os.path.join(STACKDIR, "stack_data.txt")
+    stack_metadata = os.path.join(stack_dir, "stack_data.txt")
 
     #######################################
     # #########PROCESSING SECTION##########
     #######################################
 
     # --------MPI---------
     comm = MPI.COMM_WORLD
     rank = comm.Get_rank()
     size = comm.Get_size()
 
     if rank == 0:
-        if not os.path.isdir(STACKDIR):
-            os.mkdir(STACKDIR)
+        if not os.path.isdir(stack_dir):
+            os.mkdir(stack_dir)
         # save metadata
         fout = open(stack_metadata, "w")
         fout.write(str(stack_para))
         fout.close()
 
         # cross-correlation files
-        ccfiles = sorted(glob.glob(os.path.join(CCFDIR, "*.h5")))
+        ccfiles = sorted(glob.glob(os.path.join(ccf_dir, "*.h5")))
+        logger.debug(ccfiles)
 
         # load station info
         tlocs = pd.read_csv(locations)
         sta = sorted(np.unique(tlocs["network"] + "." + tlocs["station"]))
         for ii in range(len(sta)):
-            tmp = os.path.join(STACKDIR, sta[ii])
+            tmp = os.path.join(stack_dir, sta[ii])
             if not os.path.isdir(tmp):
                 os.mkdir(tmp)
 
         # station-pairs
         pairs_all = []
         for ii in range(len(sta) - 1):
             for jj in range(ii, len(sta)):
@@ -161,30 +160,29 @@
     ccfiles = comm.bcast(ccfiles, root=0)
     pairs_all = comm.bcast(pairs_all, root=0)
 
     # MPI loop: loop through each user-defined time chunck
     for ipair in range(rank, splits, size):
         t0 = time.time()
 
-        if flag:
-            print("%dth path for station-pair %s" % (ipair, pairs_all[ipair]))
+        logger.debug("%dth path for station-pair %s" % (ipair, pairs_all[ipair]))
         # source folder
         ttr = pairs_all[ipair].split("_")
         snet, ssta = ttr[0].split(".")
         rnet, rsta = ttr[1].split(".")
         idir = ttr[0]
 
         # check if it is auto-correlation
         if ssta == rsta and snet == rnet:
             fauto = 1
         else:
             fauto = 0
 
-        # continue when file is done
-        toutfn = os.path.join(STACKDIR, idir + "/" + pairs_all[ipair] + ".tmp")
+        # continue when file is done: TODO: Remove this and use a Store.contains() function.
+        toutfn = os.path.join(stack_dir, idir + "/" + pairs_all[ipair] + ".tmp")
         if os.path.isfile(toutfn):
             continue
 
         # crude estimation on memory needs (assume float32)
         nccomp = ncomp * ncomp
         num_chunck = len(ccfiles) * nccomp
         num_segmts = 1
@@ -197,46 +195,46 @@
         memory_size = num_chunck * num_segmts * npts_segmt * 4 / 1024**3
 
         if memory_size > MAX_MEM:
             raise ValueError(
                 "Require %5.3fG memory but only %5.3fG provided)! Cannot load cc data all once!"
                 % (memory_size, MAX_MEM)
             )
-        if flag:
-            print("Good on memory (need %5.2f G and %s G provided)!" % (memory_size, MAX_MEM))
+        logger.debug("Good on memory (need %5.2f G and %s G provided)!" % (memory_size, MAX_MEM))
         # allocate array to store fft data/info
         cc_array = np.zeros((num_chunck * num_segmts, npts_segmt), dtype=np.float32)
-        cc_time = np.zeros(num_chunck * num_segmts, dtype=np.float)
+        cc_time = np.zeros(num_chunck * num_segmts, dtype=np.float32)
         cc_ngood = np.zeros(num_chunck * num_segmts, dtype=np.int16)
         cc_comp = np.chararray(num_chunck * num_segmts, itemsize=2, unicode=True)
 
         # loop through all time-chuncks
         iseg = 0
         dtype = pairs_all[ipair]
         for ifile in ccfiles:
             # load the data from daily compilation
             ds = pyasdf.ASDFDataSet(ifile, mpi=False, mode="r")
             try:
                 path_list = ds.auxiliary_data[dtype].list()
                 tparameters = ds.auxiliary_data[dtype][path_list[0]].parameters
             except Exception:
-                if flag:
-                    print("continue! no pair of %s in %s" % (dtype, ifile))
+                logger.debug("continue! no pair of %s in %s" % (dtype, ifile))
                 continue
-
+            logger.debug(f"path_list for {dtype}: {path_list}")
             # seperate auto and cross-correlation
             if fauto == 1:
                 if ncomp == 3 and len(path_list) < 6:
-                    if flag:
-                        print("continue! not enough cross components for auto-correlation %s in %s" % (dtype, ifile))
+                    logger.warning(
+                        "continue! not enough cross components for auto-correlation %s in %s" % (dtype, ifile)
+                    )
                     continue
             else:
                 if ncomp == 3 and len(path_list) < 9:
-                    if flag:
-                        print("continue! not enough cross components for cross-correlation %s in %s" % (dtype, ifile))
+                    logger.warning(
+                        "continue! not enough cross components for cross-correlation %s in %s" % (dtype, ifile)
+                    )
                     continue
 
             if len(path_list) > 9:
                 raise ValueError("more than 9 cross-component exists for %s %s! please double check" % (ifile, dtype))
 
             # load the 9-component data, which is in order in the ASDF
             for tpath in path_list:
@@ -260,53 +258,54 @@
                     cc_array[iseg] = tdata
                     cc_time[iseg] = ttime
                     cc_ngood[iseg] = tgood
                     cc_comp[iseg] = tcmp1 + tcmp2
                     iseg += 1
 
         t1 = time.time()
-        if flag:
-            print("loading CCF data takes %6.2fs" % (t1 - t0))
+        logger.debug("loading CCF data takes %6.2fs" % (t1 - t0))
 
         # continue when there is no data or for auto-correlation
         if iseg <= 1 or fauto == 1:
             continue
         outfn = pairs_all[ipair] + ".h5"
-        if flag:
-            print("ready to output to %s" % (outfn))
+        logger.debug("ready to output to %s" % (outfn))
 
         # matrix used for rotation
         if rotation:
             bigstack = np.zeros(shape=(9, npts_segmt), dtype=np.float32)
         if stack_method == "all":
             bigstack1 = np.zeros(shape=(9, npts_segmt), dtype=np.float32)
             bigstack2 = np.zeros(shape=(9, npts_segmt), dtype=np.float32)
 
         # loop through cross-component for stacking
         iflag = 1
         for icomp in range(nccomp):
             comp = enz_system[icomp]
             indx = np.where(cc_comp == comp)[0]
+            logger.debug(f"index to find the comp: {indx}")
 
             # jump if there are not enough data
             if len(indx) < 2:
                 iflag = 0
                 break
 
-            stack_h5 = os.path.join(STACKDIR, idir + "/" + outfn)
+            stack_h5 = os.path.join(stack_dir, idir + "/" + outfn)
+            logger.debug(f"h5 stack path: {stack_h5}")
             # output stacked data
             (
                 cc_final,
                 ngood_final,
                 stamps_final,
                 allstacks1,
                 allstacks2,
                 allstacks3,
                 nstacks,
             ) = noise_module.stacking(cc_array[indx], cc_time[indx], cc_ngood[indx], stack_para)
+            logger.debug(f"after stacking nstacks: {nstacks}")
             if not len(allstacks1):
                 continue
             if rotation:
                 bigstack[icomp] = allstacks1
                 if stack_method == "all":
                     bigstack1[icomp] = allstacks2
                     bigstack2[icomp] = allstacks3
@@ -338,15 +337,14 @@
                     )
                     ds.add_auxiliary_data(
                         data=allstacks3,
                         data_type="Allstack_robust",
                         path=comp,
                         parameters=tparameters,
                     )
-
             # keep a track of all sub-stacked data from S1
             if keep_substack:
                 for ii in range(cc_final.shape[0]):
                     with pyasdf.ASDFDataSet(stack_h5, mpi=False) as ds:
                         tparameters["time"] = stamps_final[ii]
                         tparameters["ngood"] = ngood_final[ii]
                         data_type = "T" + str(int(stamps_final[ii]))
@@ -354,25 +352,24 @@
                             data=cc_final[ii],
                             data_type=data_type,
                             path=comp,
                             parameters=tparameters,
                         )
 
             t3 = time.time()
-            if flag:
-                print("takes %6.2fs to stack one component with %s stacking method" % (t3 - t1, stack_method))
+            logger.debug("takes %6.2fs to stack one component with %s stacking method" % (t3 - t1, stack_method))
 
         # do rotation if needed
         if rotation and iflag:
             if np.all(bigstack == 0):
                 continue
             tparameters["station_source"] = ssta
             tparameters["station_receiver"] = rsta
             if stack_method != "all":
-                bigstack_rotated = noise_module.rotation(bigstack, tparameters, locs, flag)
+                bigstack_rotated = noise_module.rotation(bigstack, tparameters, locs)
 
                 # write to file
                 for icomp in range(nccomp):
                     comp = rtz_components[icomp]
                     tparameters["time"] = stamps_final[0]
                     tparameters["ngood"] = nstacks
                     data_type = "Allstack_" + stack_method
@@ -380,17 +377,17 @@
                         ds2.add_auxiliary_data(
                             data=bigstack_rotated[icomp],
                             data_type=data_type,
                             path=comp,
                             parameters=tparameters,
                         )
             else:
-                bigstack_rotated = noise_module.rotation(bigstack, tparameters, locs, flag)
-                bigstack_rotated1 = noise_module.rotation(bigstack1, tparameters, locs, flag)
-                bigstack_rotated2 = noise_module.rotation(bigstack2, tparameters, locs, flag)
+                bigstack_rotated = noise_module.rotation(bigstack, tparameters, locs)
+                bigstack_rotated1 = noise_module.rotation(bigstack1, tparameters, locs)
+                bigstack_rotated2 = noise_module.rotation(bigstack2, tparameters, locs)
 
                 # write to file
                 for icomp in range(nccomp):
                     comp = rtz_components[icomp]
                     tparameters["time"] = stamps_final[0]
                     tparameters["ngood"] = nstacks
                     with pyasdf.ASDFDataSet(stack_h5, mpi=False) as ds2:
@@ -410,23 +407,22 @@
                             data=bigstack_rotated2[icomp],
                             data_type="Allstack_robust",
                             path=comp,
                             parameters=tparameters,
                         )
 
         t4 = time.time()
-        if flag:
-            print("takes %6.2fs to stack/rotate all station pairs %s" % (t4 - t1, pairs_all[ipair]))
+        logger.debug("takes %6.2fs to stack/rotate all station pairs %s" % (t4 - t1, pairs_all[ipair]))
 
         # write file stamps
         ftmp = open(toutfn, "w")
         ftmp.write("done")
         ftmp.close()
 
     tt1 = time.time()
-    print("it takes %6.2fs to process step 2 in total" % (tt1 - tt0))
+    logger.info("it takes %6.2fs to process step 2 in total" % (tt1 - tt0))
     comm.barrier()
 
 
 # Point people to new entry point:
 if __name__ == "__main__":
     print("Please see:\n\npython noisepy.py stack --help\n")
```

### Comparing `noisepy_seis-0.5.9/src/noisepy/seis/__init__.py` & `noisepy_seis-0.7.0/src/noisepy/seis/__init__.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,13 +1,15 @@
 # no-qa F401
+import logging
+
+from ._version import __version__  # noqa: F401
 from .S0A_download_ASDF_MPI import download  # noqa: F401
 from .S1_fft_cc_MPI import cross_correlate  # noqa: F401
 from .S2_stacking import stack  # noqa: F401
 
-__version__ = "0.5.9"
 """
 NoisePy is a Python package designed for fast and easy computation of ambient noise cross-correlation functions.
 It provides additional functionality for noise monitoring and surface wave dispersion analysis.
 
 The main functions exported by the package are:
 - download:         download continous noise data based on obspy's core functions of
                     https://docs.obspy.org/packages/autogen/obspy.clients.fdsn.client.Client.get_stations.html and
@@ -15,7 +17,10 @@
 - cross_correlate:  This is the core function of NoisePy, which performs Fourier transform to all noise data first
                     and loads them into the memory before they are further cross-correlated
 - stack:            Used to assemble and/or stack all cross-correlation functions computed for the staion pairs in
                     the cross_correlate step
 - noise_module:     Collection of functions used in the cross_correlate and stacking steps
 - plotting_modules: Utility functions for plotting the data
 """
+
+logging.basicConfig(level=logging.INFO, format="%(asctime)s %(levelname)s %(module)s %(funcName)s %(message)s")
+logger = logging.getLogger(__name__)
```

### Comparing `noisepy_seis-0.5.9/src/noisepy/seis/noise_module.py` & `noisepy_seis-0.7.0/src/noisepy/seis/noise_module.py`

 * *Files 0% similar despite different names*

```diff
@@ -37,7002 +37,7024 @@
 00000240: 6f6e 0a66 726f 6d20 6f62 7370 792e 7369  on.from obspy.si
 00000250: 676e 616c 2e75 7469 6c20 696d 706f 7274  gnal.util import
 00000260: 205f 6e70 7473 326e 6666 740a 6672 6f6d   _npts2nfft.from
 00000270: 2073 6369 7079 2e66 6674 7061 636b 2069   scipy.fftpack i
 00000280: 6d70 6f72 7420 6e65 7874 5f66 6173 745f  mport next_fast_
 00000290: 6c65 6e0a 6672 6f6d 2073 6369 7079 2e73  len.from scipy.s
 000002a0: 6967 6e61 6c20 696d 706f 7274 2068 696c  ignal import hil
-000002b0: 6265 7274 0a0a 2222 220a 5468 6973 2056  bert..""".This V
-000002c0: 4552 5920 4c4f 4e47 206e 6f69 7365 206d  ERY LONG noise m
-000002d0: 6f64 756c 6520 6669 6c65 2069 7320 6e65  odule file is ne
-000002e0: 6365 7373 6172 7920 746f 206b 6565 7020  cessary to keep 
-000002f0: 7468 6520 4e6f 6973 6550 7920 776f 726b  the NoisePy work
-00000300: 696e 6720 7072 6f70 6572 6c79 2e20 496e  ing properly. In
-00000310: 2067 656e 6572 616c 2c0a 7468 6520 6d6f   general,.the mo
-00000320: 6475 6c65 7320 6172 6520 6f72 6761 6e69  dules are organi
-00000330: 7a65 6420 6261 7365 6420 6f6e 2074 6865  zed based on the
-00000340: 6972 2066 756e 6374 696f 6e61 6c69 7479  ir functionality
-00000350: 2069 6e20 7468 6520 666f 6c6c 6f77 696e   in the followin
-00000360: 6720 7761 792e 2069 7420 696e 636c 7564  g way. it includ
-00000370: 6573 3a0a 0a31 2920 636f 7265 2066 756e  es:..1) core fun
-00000380: 6374 696f 6e73 2063 616c 6c65 6420 6469  ctions called di
-00000390: 7265 6374 6c79 2062 7920 7468 6520 6d61  rectly by the ma
-000003a0: 696e 204e 6f69 7365 5079 2073 6372 6970  in NoisePy scrip
-000003b0: 7473 3b0a 3229 2075 7469 6c69 7479 2066  ts;.2) utility f
-000003c0: 756e 6374 696f 6e73 2075 7365 6420 6279  unctions used by
-000003d0: 2074 6865 2063 6f72 6520 6675 6e63 7469   the core functi
-000003e0: 6f6e 733b 0a33 2920 6d6f 6e69 746f 7269  ons;.3) monitori
-000003f0: 6e67 2066 756e 6374 696f 6e73 2072 6570  ng functions rep
-00000400: 7265 7365 6e74 696e 6720 6469 6666 6572  resenting differ
-00000410: 656e 7420 6d65 7468 6f64 7320 746f 206d  ent methods to m
-00000420: 6561 7375 7265 2064 762f 763b 0a34 2920  easure dv/v;.4) 
-00000430: 6d6f 6e69 746f 7269 6e67 2075 7469 6c69  monitoring utili
-00000440: 7479 2066 756e 6374 696f 6e73 2075 7365  ty functions use
-00000450: 6420 6279 2074 6865 206d 6f6e 6974 6f72  d by the monitor
-00000460: 696e 6720 6675 6e63 7469 6f6e 732e 0a0a  ing functions...
-00000470: 6279 3a20 4368 656e 6778 696e 204a 6961  by: Chengxin Jia
-00000480: 6e67 2028 6368 656e 6778 696e 5f6a 6961  ng (chengxin_jia
-00000490: 6e67 4066 6173 2e68 6172 7661 7264 2e65  ng@fas.harvard.e
-000004a0: 6475 290a 2020 2020 4d61 7269 6e65 2044  du).    Marine D
-000004b0: 656e 6f6c 6c65 2028 6d64 656e 6f6c 6c65  enolle (mdenolle
-000004c0: 4066 6173 2e68 6172 7661 7264 2e65 6475  @fas.harvard.edu
-000004d0: 290a 0a73 6576 6572 616c 2075 7469 6c69  )..several utili
-000004e0: 7479 2066 756e 6374 696f 6e73 2061 7265  ty functions are
-000004f0: 206d 6f64 6966 6965 6420 6261 7365 6420   modified based 
-00000500: 6f6e 2068 7474 7073 3a2f 2f67 6974 6875  on https://githu
-00000510: 622e 636f 6d2f 7463 6c65 6d65 6e74 732f  b.com/tclements/
-00000520: 6e6f 6973 650a 2222 220a 0a23 2323 2323  noise."""..#####
-00000530: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000540: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000550: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00000560: 2323 2323 2323 2323 2323 2323 2323 2043  ############## C
-00000570: 4f52 4520 4655 4e43 5449 4f4e 5320 2323  ORE FUNCTIONS ##
-00000580: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000590: 2323 2323 0a23 2323 2323 2323 2323 2323  ####.###########
+000002b0: 6265 7274 0a0a 6672 6f6d 206e 6f69 7365  bert..from noise
+000002c0: 7079 2e73 6569 732e 6461 7461 7479 7065  py.seis.datatype
+000002d0: 7320 696d 706f 7274 2043 6861 6e6e 656c  s import Channel
+000002e0: 4461 7461 0a66 726f 6d20 6e6f 6973 6570  Data.from noisep
+000002f0: 792e 7365 6973 2e53 315f 6666 745f 6363  y.seis.S1_fft_cc
+00000300: 5f4d 5049 2069 6d70 6f72 7420 436f 6e66  _MPI import Conf
+00000310: 6967 5061 7261 6d65 7465 7273 0a0a 2222  igParameters..""
+00000320: 220a 5468 6973 2056 4552 5920 4c4f 4e47  ".This VERY LONG
+00000330: 206e 6f69 7365 206d 6f64 756c 6520 6669   noise module fi
+00000340: 6c65 2069 7320 6e65 6365 7373 6172 7920  le is necessary 
+00000350: 746f 206b 6565 7020 7468 6520 4e6f 6973  to keep the Nois
+00000360: 6550 7920 776f 726b 696e 6720 7072 6f70  ePy working prop
+00000370: 6572 6c79 2e20 496e 2067 656e 6572 616c  erly. In general
+00000380: 2c0a 7468 6520 6d6f 6475 6c65 7320 6172  ,.the modules ar
+00000390: 6520 6f72 6761 6e69 7a65 6420 6261 7365  e organized base
+000003a0: 6420 6f6e 2074 6865 6972 2066 756e 6374  d on their funct
+000003b0: 696f 6e61 6c69 7479 2069 6e20 7468 6520  ionality in the 
+000003c0: 666f 6c6c 6f77 696e 6720 7761 792e 2069  following way. i
+000003d0: 7420 696e 636c 7564 6573 3a0a 0a31 2920  t includes:..1) 
+000003e0: 636f 7265 2066 756e 6374 696f 6e73 2063  core functions c
+000003f0: 616c 6c65 6420 6469 7265 6374 6c79 2062  alled directly b
+00000400: 7920 7468 6520 6d61 696e 204e 6f69 7365  y the main Noise
+00000410: 5079 2073 6372 6970 7473 3b0a 3229 2075  Py scripts;.2) u
+00000420: 7469 6c69 7479 2066 756e 6374 696f 6e73  tility functions
+00000430: 2075 7365 6420 6279 2074 6865 2063 6f72   used by the cor
+00000440: 6520 6675 6e63 7469 6f6e 733b 0a33 2920  e functions;.3) 
+00000450: 6d6f 6e69 746f 7269 6e67 2066 756e 6374  monitoring funct
+00000460: 696f 6e73 2072 6570 7265 7365 6e74 696e  ions representin
+00000470: 6720 6469 6666 6572 656e 7420 6d65 7468  g different meth
+00000480: 6f64 7320 746f 206d 6561 7375 7265 2064  ods to measure d
+00000490: 762f 763b 0a34 2920 6d6f 6e69 746f 7269  v/v;.4) monitori
+000004a0: 6e67 2075 7469 6c69 7479 2066 756e 6374  ng utility funct
+000004b0: 696f 6e73 2075 7365 6420 6279 2074 6865  ions used by the
+000004c0: 206d 6f6e 6974 6f72 696e 6720 6675 6e63   monitoring func
+000004d0: 7469 6f6e 732e 0a0a 6279 3a20 4368 656e  tions...by: Chen
+000004e0: 6778 696e 204a 6961 6e67 2028 6368 656e  gxin Jiang (chen
+000004f0: 6778 696e 5f6a 6961 6e67 4066 6173 2e68  gxin_jiang@fas.h
+00000500: 6172 7661 7264 2e65 6475 290a 2020 2020  arvard.edu).    
+00000510: 4d61 7269 6e65 2044 656e 6f6c 6c65 2028  Marine Denolle (
+00000520: 6d64 656e 6f6c 6c65 4066 6173 2e68 6172  mdenolle@fas.har
+00000530: 7661 7264 2e65 6475 290a 0a73 6576 6572  vard.edu)..sever
+00000540: 616c 2075 7469 6c69 7479 2066 756e 6374  al utility funct
+00000550: 696f 6e73 2061 7265 206d 6f64 6966 6965  ions are modifie
+00000560: 6420 6261 7365 6420 6f6e 2068 7474 7073  d based on https
+00000570: 3a2f 2f67 6974 6875 622e 636f 6d2f 7463  ://github.com/tc
+00000580: 6c65 6d65 6e74 732f 6e6f 6973 650a 2222  lements/noise.""
+00000590: 220a 0a23 2323 2323 2323 2323 2323 2323  "..#############
 000005a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 000005b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000005c0: 2323 2323 2323 2323 230a 0a0a 6465 6620  #########...def 
-000005d0: 6765 745f 6576 656e 745f 6c69 7374 2873  get_event_list(s
-000005e0: 7472 312c 2073 7472 322c 2069 6e63 5f68  tr1, str2, inc_h
-000005f0: 6f75 7273 293a 0a20 2020 2022 2222 0a20  ours):.    """. 
-00000600: 2020 2074 6869 7320 6675 6e63 7469 6f6e     this function
-00000610: 2063 616c 6375 6c61 7465 7320 7468 6520   calculates the 
-00000620: 6576 656e 7420 6c69 7374 2062 6574 7765  event list betwe
-00000630: 656e 2074 696d 6531 2061 6e64 2074 696d  en time1 and tim
-00000640: 6532 2062 7920 696e 6372 656d 656e 7420  e2 by increment 
-00000650: 6f66 2069 6e63 5f68 6f75 7273 0a20 2020  of inc_hours.   
-00000660: 2069 6e20 7468 6520 666f 726d 6174 6520   in the formate 
-00000670: 6f66 2025 595f 256d 5f25 645f 2548 5f25  of %Y_%m_%d_%H_%
-00000680: 4d5f 2553 2720 2875 7365 6420 696e 2053  M_%S' (used in S
-00000690: 3041 2026 2053 3042 290a 2020 2020 5041  0A & S0B).    PA
-000006a0: 5241 4d45 5445 5253 3a0a 2020 2020 2d2d  RAMETERS:.    --
-000006b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
-000006c0: 2020 2073 7472 313a 2073 7472 696e 6720     str1: string 
-000006d0: 6f66 2074 6865 2073 7461 7274 696e 6720  of the starting 
-000006e0: 7469 6d65 202d 3e20 3230 3130 5f30 315f  time -> 2010_01_
-000006f0: 3031 5f30 5f30 0a20 2020 2073 7472 323a  01_0_0.    str2:
-00000700: 2073 7472 696e 6720 6f66 2074 6865 2065   string of the e
-00000710: 6e64 696e 6720 7469 6d65 202d 3e20 3230  nding time -> 20
-00000720: 3130 5f31 305f 3131 5f30 5f30 0a20 2020  10_10_11_0_0.   
-00000730: 2069 6e63 5f68 6f75 7273 3a20 696e 7465   inc_hours: inte
-00000740: 6765 7220 6f66 2069 6e63 7265 6d65 6e74  ger of increment
-00000750: 616c 2068 6f75 7273 0a20 2020 2052 4554  al hours.    RET
-00000760: 5552 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d  URNS:.    ------
-00000770: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2065  ----------.    e
-00000780: 7665 6e74 3a20 6120 6e75 6d70 7920 6368  vent: a numpy ch
-00000790: 6172 6163 7465 7220 6c69 7374 0a20 2020  aracter list.   
-000007a0: 2022 2222 0a20 2020 2064 6174 6531 203d   """.    date1 =
-000007b0: 2073 7472 312e 7370 6c69 7428 225f 2229   str1.split("_")
-000007c0: 0a20 2020 2064 6174 6532 203d 2073 7472  .    date2 = str
-000007d0: 322e 7370 6c69 7428 225f 2229 0a20 2020  2.split("_").   
-000007e0: 2079 3120 3d20 696e 7428 6461 7465 315b   y1 = int(date1[
-000007f0: 305d 290a 2020 2020 6d31 203d 2069 6e74  0]).    m1 = int
-00000800: 2864 6174 6531 5b31 5d29 0a20 2020 2064  (date1[1]).    d
-00000810: 3120 3d20 696e 7428 6461 7465 315b 325d  1 = int(date1[2]
-00000820: 290a 2020 2020 6831 203d 2069 6e74 2864  ).    h1 = int(d
-00000830: 6174 6531 5b33 5d29 0a20 2020 206d 6d31  ate1[3]).    mm1
-00000840: 203d 2069 6e74 2864 6174 6531 5b34 5d29   = int(date1[4])
-00000850: 0a20 2020 206d 6e31 203d 2069 6e74 2864  .    mn1 = int(d
-00000860: 6174 6531 5b35 5d29 0a20 2020 2079 3220  ate1[5]).    y2 
-00000870: 3d20 696e 7428 6461 7465 325b 305d 290a  = int(date2[0]).
-00000880: 2020 2020 6d32 203d 2069 6e74 2864 6174      m2 = int(dat
-00000890: 6532 5b31 5d29 0a20 2020 2064 3220 3d20  e2[1]).    d2 = 
-000008a0: 696e 7428 6461 7465 325b 325d 290a 2020  int(date2[2]).  
-000008b0: 2020 6832 203d 2069 6e74 2864 6174 6532    h2 = int(date2
-000008c0: 5b33 5d29 0a20 2020 206d 6d32 203d 2069  [3]).    mm2 = i
-000008d0: 6e74 2864 6174 6532 5b34 5d29 0a20 2020  nt(date2[4]).   
-000008e0: 206d 6e32 203d 2069 6e74 2864 6174 6532   mn2 = int(date2
-000008f0: 5b35 5d29 0a0a 2020 2020 6431 203d 2064  [5])..    d1 = d
-00000900: 6174 6574 696d 652e 6461 7465 7469 6d65  atetime.datetime
-00000910: 2879 312c 206d 312c 2064 312c 2068 312c  (y1, m1, d1, h1,
-00000920: 206d 6d31 2c20 6d6e 3129 0a20 2020 2064   mm1, mn1).    d
-00000930: 3220 3d20 6461 7465 7469 6d65 2e64 6174  2 = datetime.dat
-00000940: 6574 696d 6528 7932 2c20 6d32 2c20 6432  etime(y2, m2, d2
-00000950: 2c20 6832 2c20 6d6d 322c 206d 6e32 290a  , h2, mm2, mn2).
-00000960: 2020 2020 6474 203d 2064 6174 6574 696d      dt = datetim
-00000970: 652e 7469 6d65 6465 6c74 6128 686f 7572  e.timedelta(hour
-00000980: 733d 696e 635f 686f 7572 7329 0a0a 2020  s=inc_hours)..  
-00000990: 2020 6576 656e 7420 3d20 5b5d 0a20 2020    event = [].   
-000009a0: 2077 6869 6c65 2064 3120 3c20 6432 3a0a   while d1 < d2:.
-000009b0: 2020 2020 2020 2020 6576 656e 742e 6170          event.ap
-000009c0: 7065 6e64 2864 312e 7374 7266 7469 6d65  pend(d1.strftime
-000009d0: 2822 2559 5f25 6d5f 2564 5f25 485f 254d  ("%Y_%m_%d_%H_%M
-000009e0: 5f25 5322 2929 0a20 2020 2020 2020 2064  _%S")).        d
-000009f0: 3120 2b3d 2064 740a 2020 2020 6576 656e  1 += dt.    even
-00000a00: 742e 6170 7065 6e64 2864 322e 7374 7266  t.append(d2.strf
-00000a10: 7469 6d65 2822 2559 5f25 6d5f 2564 5f25  time("%Y_%m_%d_%
-00000a20: 485f 254d 5f25 5322 2929 0a0a 2020 2020  H_%M_%S"))..    
-00000a30: 7265 7475 726e 2065 7665 6e74 0a0a 0a64  return event...d
-00000a40: 6566 206d 616b 655f 7469 6d65 7374 616d  ef make_timestam
-00000a50: 7073 2870 7265 7072 6f5f 7061 7261 293a  ps(prepro_para):
-00000a60: 0a20 2020 2022 2222 0a20 2020 2074 6869  .    """.    thi
-00000a70: 7320 6675 6e63 7469 6f6e 2070 7265 7061  s function prepa
-00000a80: 7265 7320 7468 6520 7469 6d65 7374 616d  res the timestam
-00000a90: 7073 206f 6620 626f 7468 2074 6865 2073  ps of both the s
-00000aa0: 7461 7274 696e 6720 616e 6420 656e 6469  tarting and endi
-00000ab0: 6e67 2074 696d 6520 6f66 2065 6163 6820  ng time of each 
-00000ac0: 6d73 6565 642f 7361 6320 6669 6c65 2074  mseed/sac file t
-00000ad0: 6861 740a 2020 2020 6973 2073 746f 7265  hat.    is store
-00000ae0: 6420 6f6e 206c 6f63 616c 206d 6163 6869  d on local machi
-00000af0: 6e65 2e20 7468 6973 2074 696d 6520 696e  ne. this time in
-00000b00: 666f 2069 7320 7573 6564 2074 6f20 7365  fo is used to se
-00000b10: 6172 6368 2061 6c6c 2073 7461 7469 6f6e  arch all station
-00000b20: 7320 696e 2073 7065 6369 6669 6320 7469  s in specific ti
-00000b30: 6d65 2063 6875 6e63 6b0a 2020 2020 7768  me chunck.    wh
-00000b40: 656e 2070 7265 7061 7269 6e67 206e 6f69  en preparing noi
-00000b50: 7365 2064 6174 6120 696e 2041 5344 4620  se data in ASDF 
-00000b60: 666f 726d 6174 2e20 6974 2063 7265 6174  format. it creat
-00000b70: 6573 2061 2063 7376 2066 696c 6520 636f  es a csv file co
-00000b80: 6e74 6169 6e69 6e67 2061 6c6c 2074 696d  ntaining all tim
-00000b90: 6573 7461 6d70 2069 6e66 6f20 6966 2074  estamp info if t
-00000ba0: 6865 0a20 2020 2066 696c 6520 646f 6573  he.    file does
-00000bb0: 206e 6f74 2065 7869 7374 2028 7573 6564   not exist (used
-00000bc0: 2069 6e20 5330 4229 660a 2020 2020 5041   in S0B)f.    PA
-00000bd0: 5241 4d45 5445 5253 3a0a 2020 2020 2d2d  RAMETERS:.    --
-00000be0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000bf0: 2d2d 2d2d 2d0a 2020 2020 7072 6570 726f  -----.    prepro
-00000c00: 5f70 6172 613a 2061 2064 6963 2063 6f6e  _para: a dic con
-00000c10: 7461 696e 696e 6720 616c 6c20 7072 652d  taining all pre-
-00000c20: 7072 6f63 6573 7369 6e67 2070 6172 616d  processing param
-00000c30: 6574 6572 7320 7573 6564 2069 6e20 5330  eters used in S0
-00000c40: 420a 2020 2020 5245 5455 524e 533a 0a20  B.    RETURNS:. 
-00000c50: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
-00000c60: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2061  ----------.    a
-00000c70: 6c6c 5f73 7469 6d65 733a 206e 756d 7079  ll_stimes: numpy
-00000c80: 2066 6c6f 6174 2061 7272 6179 2063 6f6e   float array con
-00000c90: 7461 696e 696e 6720 7374 6172 7474 696e  taining starttin
-00000ca0: 6720 616e 6420 656e 6469 6e67 2074 696d  g and ending tim
-00000cb0: 6520 666f 7220 616c 6c20 5341 432f 6d73  e for all SAC/ms
-00000cc0: 6565 6420 6669 6c65 730a 2020 2020 2222  eed files.    ""
-00000cd0: 220a 2020 2020 2320 6c6f 6164 2070 6172  ".    # load par
-00000ce0: 616d 6574 6572 7320 6672 6f6d 2070 6172  ameters from par
-00000cf0: 6120 6469 630a 2020 2020 7769 6b69 5f66  a dic.    wiki_f
-00000d00: 696c 6520 3d20 7072 6570 726f 5f70 6172  ile = prepro_par
-00000d10: 615b 2277 696b 695f 6669 6c65 225d 0a20  a["wiki_file"]. 
-00000d20: 2020 206d 6573 7379 6461 7461 203d 2070     messydata = p
-00000d30: 7265 7072 6f5f 7061 7261 5b22 6d65 7373  repro_para["mess
-00000d40: 7964 6174 6122 5d0a 2020 2020 5241 5744  ydata"].    RAWD
-00000d50: 4154 4120 3d20 7072 6570 726f 5f70 6172  ATA = prepro_par
-00000d60: 615b 2252 4157 4441 5441 225d 0a20 2020  a["RAWDATA"].   
-00000d70: 2061 6c6c 6669 6c65 735f 7061 7468 203d   allfiles_path =
-00000d80: 2070 7265 7072 6f5f 7061 7261 5b22 616c   prepro_para["al
-00000d90: 6c66 696c 6573 5f70 6174 6822 5d0a 0a20  lfiles_path"].. 
-00000da0: 2020 2069 6620 6f73 2e70 6174 682e 6973     if os.path.is
-00000db0: 6669 6c65 2877 696b 695f 6669 6c65 293a  file(wiki_file):
-00000dc0: 0a20 2020 2020 2020 2074 6d70 203d 2070  .        tmp = p
-00000dd0: 642e 7265 6164 5f63 7376 2877 696b 695f  d.read_csv(wiki_
-00000de0: 6669 6c65 290a 2020 2020 2020 2020 616c  file).        al
-00000df0: 6c66 696c 6573 203d 2074 6d70 5b22 6e61  lfiles = tmp["na
-00000e00: 6d65 7322 5d0a 2020 2020 2020 2020 616c  mes"].        al
-00000e10: 6c5f 7374 696d 6573 203d 206e 702e 7a65  l_stimes = np.ze
-00000e20: 726f 7328 7368 6170 653d 286c 656e 2861  ros(shape=(len(a
-00000e30: 6c6c 6669 6c65 7329 2c20 3229 2c20 6474  llfiles), 2), dt
-00000e40: 7970 653d 6e70 2e66 6c6f 6174 290a 2020  ype=np.float).  
-00000e50: 2020 2020 2020 616c 6c5f 7374 696d 6573        all_stimes
-00000e60: 5b3a 2c20 305d 203d 2074 6d70 5b22 7374  [:, 0] = tmp["st
-00000e70: 6172 7474 696d 6522 5d0a 2020 2020 2020  arttime"].      
-00000e80: 2020 616c 6c5f 7374 696d 6573 5b3a 2c20    all_stimes[:, 
-00000e90: 315d 203d 2074 6d70 5b22 656e 6474 696d  1] = tmp["endtim
-00000ea0: 6522 5d0a 0a20 2020 2023 2068 6176 6520  e"]..    # have 
-00000eb0: 746f 2072 6561 6420 6561 6368 2073 6163  to read each sac
-00000ec0: 2f6d 7365 6564 2064 6174 6120 6f6e 6520  /mseed data one 
-00000ed0: 6279 206f 6e65 0a20 2020 2065 6c73 653a  by one.    else:
-00000ee0: 0a20 2020 2020 2020 2061 6c6c 6669 6c65  .        allfile
-00000ef0: 7320 3d20 676c 6f62 2e67 6c6f 6228 616c  s = glob.glob(al
-00000f00: 6c66 696c 6573 5f70 6174 6829 0a20 2020  lfiles_path).   
-00000f10: 2020 2020 206e 6669 6c65 7320 3d20 6c65       nfiles = le
-00000f20: 6e28 616c 6c66 696c 6573 290a 2020 2020  n(allfiles).    
-00000f30: 2020 2020 6966 206e 6f74 206e 6669 6c65      if not nfile
-00000f40: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
-00000f50: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00000f60: 2241 626f 7274 2120 6e6f 2064 6174 6120  "Abort! no data 
-00000f70: 666f 756e 6420 696e 2073 7562 6469 7265  found in subdire
-00000f80: 6374 6f72 7920 6f66 2025 7322 2025 2052  ctory of %s" % R
-00000f90: 4157 4441 5441 290a 2020 2020 2020 2020  AWDATA).        
-00000fa0: 616c 6c5f 7374 696d 6573 203d 206e 702e  all_stimes = np.
-00000fb0: 7a65 726f 7328 7368 6170 653d 286e 6669  zeros(shape=(nfi
-00000fc0: 6c65 732c 2032 292c 2064 7479 7065 3d6e  les, 2), dtype=n
-00000fd0: 702e 666c 6f61 7429 0a0a 2020 2020 2020  p.float)..      
-00000fe0: 2020 6966 206d 6573 7379 6461 7461 3a0a    if messydata:.
-00000ff0: 2020 2020 2020 2020 2020 2020 2320 6765              # ge
-00001000: 7420 5645 5259 2070 7265 6369 7365 2074  t VERY precise t
-00001010: 7261 6365 2d74 696d 6520 6672 6f6d 2074  race-time from t
-00001020: 6865 2068 6561 6465 720a 2020 2020 2020  he header.      
-00001030: 2020 2020 2020 666f 7220 6969 2069 6e20        for ii in 
-00001040: 7261 6e67 6528 6e66 696c 6573 293a 0a20  range(nfiles):. 
-00001050: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00001060: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00001070: 2020 2020 2020 2020 7472 203d 206f 6273          tr = obs
-00001080: 7079 2e72 6561 6428 616c 6c66 696c 6573  py.read(allfiles
-00001090: 5b69 695d 290a 2020 2020 2020 2020 2020  [ii]).          
-000010a0: 2020 2020 2020 2020 2020 616c 6c5f 7374            all_st
-000010b0: 696d 6573 5b69 692c 2030 5d20 3d20 7472  imes[ii, 0] = tr
-000010c0: 5b30 5d2e 7374 6174 732e 7374 6172 7474  [0].stats.startt
-000010d0: 696d 6520 2d20 6f62 7370 792e 5554 4344  ime - obspy.UTCD
-000010e0: 6174 6554 696d 6528 3139 3730 2c20 312c  ateTime(1970, 1,
-000010f0: 2031 290a 2020 2020 2020 2020 2020 2020   1).            
-00001100: 2020 2020 2020 2020 616c 6c5f 7374 696d          all_stim
-00001110: 6573 5b69 692c 2031 5d20 3d20 7472 5b30  es[ii, 1] = tr[0
-00001120: 5d2e 7374 6174 732e 656e 6474 696d 6520  ].stats.endtime 
-00001130: 2d20 6f62 7370 792e 5554 4344 6174 6554  - obspy.UTCDateT
-00001140: 696d 6528 3139 3730 2c20 312c 2031 290a  ime(1970, 1, 1).
-00001150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001160: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00001170: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-00001180: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00001190: 2865 290a 2020 2020 2020 2020 2020 2020  (e).            
-000011a0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-000011b0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000011c0: 2020 2020 2020 2020 2020 2023 2067 6574             # get
-000011d0: 2072 6f75 6768 2065 7374 696d 6174 6573   rough estimates
-000011e0: 206f 6620 7468 6520 7469 6d65 2062 6173   of the time bas
-000011f0: 6564 206f 6e20 7468 6520 666f 6c64 6572  ed on the folder
-00001200: 3a20 6e65 6564 206d 6f64 6966 6965 6420  : need modified 
-00001210: 746f 2061 6363 6f6d 6d6f 6461 7465 2079  to accommodate y
-00001220: 6f75 7220 6461 7461 0a20 2020 2020 2020  our data.       
-00001230: 2020 2020 2066 6f72 2069 6920 696e 2072       for ii in r
-00001240: 616e 6765 286e 6669 6c65 7329 3a0a 2020  ange(nfiles):.  
-00001250: 2020 2020 2020 2020 2020 2020 2020 7965                ye
-00001260: 6172 203d 2069 6e74 2861 6c6c 6669 6c65  ar = int(allfile
-00001270: 735b 6969 5d2e 7370 6c69 7428 222f 2229  s[ii].split("/")
-00001280: 5b2d 325d 2e73 706c 6974 2822 5f22 295b  [-2].split("_")[
-00001290: 315d 290a 2020 2020 2020 2020 2020 2020  1]).            
-000012a0: 2020 2020 2320 6a75 6c69 6120 3d20 696e      # julia = in
-000012b0: 7428 616c 6c66 696c 6573 5b69 695d 2e73  t(allfiles[ii].s
-000012c0: 706c 6974 2827 2f27 295b 2d32 5d2e 7370  plit('/')[-2].sp
-000012d0: 6c69 7428 275f 2729 5b32 5d29 0a20 2020  lit('_')[2]).   
-000012e0: 2020 2020 2020 2020 2020 2020 2023 2061               # a
-000012f0: 6c6c 5f73 7469 6d65 735b 6969 2c30 5d20  ll_stimes[ii,0] 
-00001300: 3d20 6f62 7370 792e 5554 4344 6174 6554  = obspy.UTCDateT
-00001310: 696d 6528 7965 6172 3d79 6561 722c 6a75  ime(year=year,ju
-00001320: 6c64 6179 3d6a 756c 6961 290a 2020 2020  lday=julia).    
-00001330: 2020 2020 2020 2020 2020 2020 2320 2d6f              # -o
-00001340: 6273 7079 2e55 5443 4461 7465 5469 6d65  bspy.UTCDateTime
-00001350: 2879 6561 723d 3139 3730 2c6d 6f6e 7468  (year=1970,month
-00001360: 3d31 2c64 6179 3d31 290a 2020 2020 2020  =1,day=1).      
-00001370: 2020 2020 2020 2020 2020 6d6f 6e74 6820            month 
-00001380: 3d20 696e 7428 616c 6c66 696c 6573 5b69  = int(allfiles[i
-00001390: 695d 2e73 706c 6974 2822 2f22 295b 2d32  i].split("/")[-2
-000013a0: 5d2e 7370 6c69 7428 225f 2229 5b32 5d29  ].split("_")[2])
-000013b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000013c0: 2064 6179 203d 2069 6e74 2861 6c6c 6669   day = int(allfi
-000013d0: 6c65 735b 6969 5d2e 7370 6c69 7428 222f  les[ii].split("/
-000013e0: 2229 5b2d 325d 2e73 706c 6974 2822 5f22  ")[-2].split("_"
-000013f0: 295b 335d 290a 2020 2020 2020 2020 2020  )[3]).          
-00001400: 2020 2020 2020 616c 6c5f 7374 696d 6573        all_stimes
-00001410: 5b69 692c 2030 5d20 3d20 6f62 7370 792e  [ii, 0] = obspy.
-00001420: 5554 4344 6174 6554 696d 6528 7965 6172  UTCDateTime(year
-00001430: 3d79 6561 722c 206d 6f6e 7468 3d6d 6f6e  =year, month=mon
-00001440: 7468 2c20 6461 793d 6461 7929 202d 206f  th, day=day) - o
-00001450: 6273 7079 2e55 5443 4461 7465 5469 6d65  bspy.UTCDateTime
-00001460: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00001470: 2020 2020 2020 7965 6172 3d31 3937 302c        year=1970,
-00001480: 206d 6f6e 7468 3d31 2c20 6461 793d 310a   month=1, day=1.
-00001490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000014a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000014b0: 2020 616c 6c5f 7374 696d 6573 5b69 692c    all_stimes[ii,
-000014c0: 2031 5d20 3d20 616c 6c5f 7374 696d 6573   1] = all_stimes
-000014d0: 5b69 692c 2030 5d20 2b20 3836 3430 300a  [ii, 0] + 86400.
-000014e0: 0a20 2020 2020 2020 2023 2073 6176 6520  .        # save 
-000014f0: 6e61 6d65 2061 6e64 2074 696d 6520 696e  name and time in
-00001500: 666f 2066 6f72 206c 6174 6572 2075 7365  fo for later use
-00001510: 2069 6620 7468 6520 6669 6c65 206e 6f74   if the file not
-00001520: 2065 7869 7374 0a20 2020 2020 2020 2069   exist.        i
-00001530: 6620 6e6f 7420 6f73 2e70 6174 682e 6973  f not os.path.is
-00001540: 6669 6c65 2877 696b 695f 6669 6c65 293a  file(wiki_file):
-00001550: 0a20 2020 2020 2020 2020 2020 2077 696b  .            wik
-00001560: 695f 696e 666f 203d 207b 0a20 2020 2020  i_info = {.     
-00001570: 2020 2020 2020 2020 2020 2022 6e61 6d65             "name
-00001580: 7322 3a20 616c 6c66 696c 6573 2c0a 2020  s": allfiles,.  
-00001590: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-000015a0: 7461 7274 7469 6d65 223a 2061 6c6c 5f73  tarttime": all_s
-000015b0: 7469 6d65 735b 3a2c 2030 5d2c 0a20 2020  times[:, 0],.   
-000015c0: 2020 2020 2020 2020 2020 2020 2022 656e               "en
-000015d0: 6474 696d 6522 3a20 616c 6c5f 7374 696d  dtime": all_stim
-000015e0: 6573 5b3a 2c20 315d 2c0a 2020 2020 2020  es[:, 1],.      
-000015f0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00001600: 2020 2020 6466 203d 2070 642e 4461 7461      df = pd.Data
-00001610: 4672 616d 6528 7769 6b69 5f69 6e66 6f2c  Frame(wiki_info,
-00001620: 2063 6f6c 756d 6e73 3d5b 226e 616d 6573   columns=["names
-00001630: 222c 2022 7374 6172 7474 696d 6522 2c20  ", "starttime", 
-00001640: 2265 6e64 7469 6d65 225d 290a 2020 2020  "endtime"]).    
-00001650: 2020 2020 2020 2020 6466 2e74 6f5f 6373          df.to_cs
-00001660: 7628 7769 6b69 5f66 696c 6529 0a20 2020  v(wiki_file).   
-00001670: 2072 6574 7572 6e20 616c 6c5f 7374 696d   return all_stim
-00001680: 6573 0a0a 0a64 6566 2070 7265 7072 6f63  es...def preproc
-00001690: 6573 735f 7261 7728 7374 2c20 696e 762c  ess_raw(st, inv,
-000016a0: 2070 7265 7072 6f5f 7061 7261 2c20 6461   prepro_para, da
-000016b0: 7465 5f69 6e66 6f29 3a0a 2020 2020 2222  te_info):.    ""
-000016c0: 220a 2020 2020 7468 6973 2066 756e 6374  ".    this funct
-000016d0: 696f 6e20 7072 652d 7072 6f63 6573 7365  ion pre-processe
-000016e0: 7320 7468 6520 7261 7720 6461 7461 2073  s the raw data s
-000016f0: 7472 6561 6d20 6279 3a0a 2020 2020 2020  tream by:.      
-00001700: 2020 3129 2063 6865 636b 2073 616d 7069    1) check sampi
-00001710: 6e67 2072 6174 6520 616e 6420 6761 7073  ng rate and gaps
-00001720: 2069 6e20 7468 6520 6461 7461 3b0a 2020   in the data;.  
-00001730: 2020 2020 2020 3229 2072 656d 6f76 6520        2) remove 
-00001740: 7369 6775 6c61 7269 7479 2c20 7472 656e  sigularity, tren
-00001750: 6420 616e 6420 6d65 616e 206f 6620 6561  d and mean of ea
-00001760: 6368 2074 7261 6365 0a20 2020 2020 2020  ch trace.       
-00001770: 2033 2920 6669 6c74 6572 2061 6e64 2063   3) filter and c
-00001780: 6f72 7265 6374 2074 6865 2074 696d 6520  orrect the time 
-00001790: 6966 2069 6e74 6567 6572 2074 696d 6520  if integer time 
-000017a0: 6172 6520 6265 7477 6565 6e20 7361 6d70  are between samp
-000017b0: 6c69 6e67 2070 6f69 6e74 730a 2020 2020  ling points.    
-000017c0: 2020 2020 3429 2072 656d 6f76 6520 696e      4) remove in
-000017d0: 7374 7275 6d65 6e74 2072 6573 706f 6e73  strument respons
-000017e0: 6573 2077 6974 6820 7365 6c65 6374 6564  es with selected
-000017f0: 206d 6574 686f 6473 2069 6e63 6c75 6469   methods includi
-00001800: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
-00001810: 2269 6e76 2220 2020 2d3e 2075 7369 6e67  "inv"   -> using
-00001820: 2069 6e76 656e 746f 7279 2069 6e66 6f72   inventory infor
-00001830: 6d61 7469 6f6e 2074 6f20 7265 6d6f 7665  mation to remove
-00001840: 5f72 6573 706f 6e73 653b 0a20 2020 2020  _response;.     
-00001850: 2020 2020 2020 2022 7370 6563 7472 756d         "spectrum
-00001860: 2220 2020 2d3e 2075 7365 2074 6865 2069  "   -> use the i
-00001870: 6e76 6572 7365 206f 6620 7265 7370 6f6e  nverse of respon
-00001880: 7365 2073 7065 6374 7275 6d2e 0a20 2020  se spectrum..   
-00001890: 2020 2020 2020 2020 2028 6120 7363 7269           (a scri
-000018a0: 7074 2069 7320 7072 6f76 6964 6564 2069  pt is provided i
-000018b0: 6e20 6164 6469 7469 6f6e 616c 5f6d 6f64  n additional_mod
-000018c0: 756c 6520 746f 2065 7374 696d 6174 6520  ule to estimate 
-000018d0: 7265 7370 6f6e 7365 2073 7065 6374 7275  response spectru
-000018e0: 6d20 6672 6f6d 2052 4553 5020 6669 6c65  m from RESP file
-000018f0: 7329 0a20 2020 2020 2020 2020 2020 2022  s).            "
-00001900: 5245 5350 5f66 696c 6573 2220 2d3e 2075  RESP_files" -> u
-00001910: 7365 2074 6865 2072 6177 2064 6f77 6e6c  se the raw downl
-00001920: 6f61 6420 5245 5350 2066 696c 6573 0a20  oad RESP files. 
-00001930: 2020 2020 2020 2020 2020 2022 706f 6c65             "pole
-00001940: 7a65 726f 7322 2020 2d3e 2075 7365 2070  zeros"  -> use p
-00001950: 6f6c 652f 7a65 726f 2069 6e66 6f20 666f  ole/zero info fo
-00001960: 7220 6120 6372 7564 6520 636f 7272 6563  r a crude correc
-00001970: 7469 6f6e 206f 6620 7265 7370 6f6e 7365  tion of response
-00001980: 0a20 2020 2020 2020 2035 2920 7472 696d  .        5) trim
-00001990: 2064 6174 6120 746f 2061 2064 6179 2d6c   data to a day-l
-000019a0: 6f6e 6720 7365 7175 656e 6365 2061 6e64  ong sequence and
-000019b0: 2069 6e74 6572 706f 6c61 7465 2069 7420   interpolate it 
-000019c0: 746f 2065 6e73 7572 6520 7374 6172 7469  to ensure starti
-000019d0: 6e67 2061 7420 3030 3a30 303a 3030 2e30  ng at 00:00:00.0
-000019e0: 3030 0a20 2020 2028 7573 6564 2069 6e20  00.    (used in 
-000019f0: 5330 4120 2620 5330 4229 0a20 2020 2050  S0A & S0B).    P
-00001a00: 4152 414d 4554 4552 533a 0a20 2020 202d  ARAMETERS:.    -
-00001a10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001a20: 2d2d 2d2d 2d2d 0a20 2020 2073 743a 2020  ------.    st:  
-00001a30: 6f62 7370 7920 7374 7265 616d 206f 626a  obspy stream obj
-00001a40: 6563 742c 2063 6f6e 7461 696e 696e 6720  ect, containing 
-00001a50: 6e6f 6973 6520 6461 7461 2074 6f20 6265  noise data to be
-00001a60: 2070 726f 6365 7373 6564 0a20 2020 2069   processed.    i
-00001a70: 6e76 3a20 6f62 7370 7920 696e 7665 6e74  nv: obspy invent
-00001a80: 6f72 7920 6f62 6a65 6374 2c20 636f 6e74  ory object, cont
-00001a90: 6169 6e69 6e67 2073 7461 7469 6f6e 7320  aining stations 
-00001aa0: 696e 666f 0a20 2020 2070 7265 7072 6f5f  info.    prepro_
-00001ab0: 7061 7261 3a20 6469 6374 2063 6f6e 7461  para: dict conta
-00001ac0: 696e 696e 6720 6666 7420 7061 7261 6d65  ining fft parame
-00001ad0: 7465 7273 2c20 7375 6368 2061 7320 6672  ters, such as fr
-00001ae0: 6571 7565 6e63 7920 6261 6e64 7320 616e  equency bands an
-00001af0: 640a 2020 2020 7365 6c65 6374 696f 6e20  d.    selection 
-00001b00: 666f 7220 696e 7374 7275 6d65 6e74 2072  for instrument r
-00001b10: 6573 706f 6e73 6520 7265 6d6f 7661 6c20  esponse removal 
-00001b20: 6574 632e 0a20 2020 2064 6174 655f 696e  etc..    date_in
-00001b30: 666f 3a20 2020 6469 6374 206f 6620 7374  fo:   dict of st
-00001b40: 6172 7420 616e 6420 656e 6420 7469 6d65  art and end time
-00001b50: 206f 6620 7468 6520 7374 7265 616d 2064   of the stream d
-00001b60: 6174 610a 2020 2020 5245 5455 524e 533a  ata.    RETURNS:
-00001b70: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
-00001b80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
-00001b90: 206e 7472 3a20 6f62 7370 7920 7374 7265   ntr: obspy stre
-00001ba0: 616d 206f 626a 6563 7420 6f66 2063 6c65  am object of cle
-00001bb0: 616e 6564 2c20 6d65 7267 6564 2061 6e64  aned, merged and
-00001bc0: 2066 696c 7465 7265 6420 6e6f 6973 6520   filtered noise 
-00001bd0: 6461 7461 0a20 2020 2022 2222 0a20 2020  data.    """.   
-00001be0: 2023 206c 6f61 6420 7061 7261 6d74 6572   # load paramter
-00001bf0: 7320 6672 6f6d 2066 6674 2064 6963 740a  s from fft dict.
-00001c00: 2020 2020 726d 5f72 6573 7020 3d20 7072      rm_resp = pr
-00001c10: 6570 726f 5f70 6172 615b 2272 6d5f 7265  epro_para["rm_re
-00001c20: 7370 225d 0a20 2020 2069 6620 2272 6d5f  sp"].    if "rm_
-00001c30: 7265 7370 5f6f 7574 2220 696e 2070 7265  resp_out" in pre
-00001c40: 7072 6f5f 7061 7261 2e6b 6579 7328 293a  pro_para.keys():
-00001c50: 0a20 2020 2020 2020 2072 6d5f 7265 7370  .        rm_resp
-00001c60: 5f6f 7574 203d 2070 7265 7072 6f5f 7061  _out = prepro_pa
-00001c70: 7261 5b22 726d 5f72 6573 705f 6f75 7422  ra["rm_resp_out"
-00001c80: 5d0a 2020 2020 656c 7365 3a0a 2020 2020  ].    else:.    
-00001c90: 2020 2020 726d 5f72 6573 705f 6f75 7420      rm_resp_out 
-00001ca0: 3d20 2256 454c 220a 2020 2020 7265 7370  = "VEL".    resp
-00001cb0: 6469 7220 3d20 7072 6570 726f 5f70 6172  dir = prepro_par
-00001cc0: 615b 2272 6573 7064 6972 225d 0a20 2020  a["respdir"].   
-00001cd0: 2066 7265 716d 696e 203d 2070 7265 7072   freqmin = prepr
-00001ce0: 6f5f 7061 7261 5b22 6672 6571 6d69 6e22  o_para["freqmin"
-00001cf0: 5d0a 2020 2020 6672 6571 6d61 7820 3d20  ].    freqmax = 
-00001d00: 7072 6570 726f 5f70 6172 615b 2266 7265  prepro_para["fre
-00001d10: 716d 6178 225d 0a20 2020 2073 616d 705f  qmax"].    samp_
-00001d20: 6672 6571 203d 2070 7265 7072 6f5f 7061  freq = prepro_pa
-00001d30: 7261 5b22 7361 6d70 5f66 7265 7122 5d0a  ra["samp_freq"].
-00001d40: 0a20 2020 2023 2070 6172 616d 6574 6572  .    # parameter
-00001d50: 7320 666f 7220 6275 7474 6572 776f 7274  s for butterwort
-00001d60: 6820 6669 6c74 6572 0a20 2020 2066 3120  h filter.    f1 
-00001d70: 3d20 302e 3920 2a20 6672 6571 6d69 6e0a  = 0.9 * freqmin.
-00001d80: 2020 2020 6632 203d 2066 7265 716d 696e      f2 = freqmin
-00001d90: 0a20 2020 2069 6620 312e 3120 2a20 6672  .    if 1.1 * fr
-00001da0: 6571 6d61 7820 3e20 302e 3435 202a 2073  eqmax > 0.45 * s
-00001db0: 616d 705f 6672 6571 3a0a 2020 2020 2020  amp_freq:.      
-00001dc0: 2020 6633 203d 2030 2e34 202a 2073 616d    f3 = 0.4 * sam
-00001dd0: 705f 6672 6571 0a20 2020 2020 2020 2066  p_freq.        f
-00001de0: 3420 3d20 302e 3435 202a 2073 616d 705f  4 = 0.45 * samp_
-00001df0: 6672 6571 0a20 2020 2065 6c73 653a 0a20  freq.    else:. 
-00001e00: 2020 2020 2020 2066 3320 3d20 6672 6571         f3 = freq
-00001e10: 6d61 780a 2020 2020 2020 2020 6634 203d  max.        f4 =
-00001e20: 2031 2e31 202a 2066 7265 716d 6178 0a20   1.1 * freqmax. 
-00001e30: 2020 2070 7265 5f66 696c 7420 3d20 5b66     pre_filt = [f
-00001e40: 312c 2066 322c 2066 332c 2066 345d 0a0a  1, f2, f3, f4]..
-00001e50: 2020 2020 2320 6368 6563 6b20 7361 6d70      # check samp
-00001e60: 6c69 6e67 2072 6174 6520 616e 6420 7472  ling rate and tr
-00001e70: 6163 6520 6c65 6e67 7468 0a20 2020 2073  ace length.    s
-00001e80: 7420 3d20 6368 6563 6b5f 7361 6d70 6c65  t = check_sample
-00001e90: 5f67 6170 7328 7374 2c20 6461 7465 5f69  _gaps(st, date_i
-00001ea0: 6e66 6f29 0a20 2020 2069 6620 6c65 6e28  nfo).    if len(
-00001eb0: 7374 2920 3d3d 2030 3a0a 2020 2020 2020  st) == 0:.      
-00001ec0: 2020 7072 696e 7428 224e 6f20 7472 6163    print("No trac
-00001ed0: 6573 2069 6e20 5374 7265 616d 3a20 436f  es in Stream: Co
-00001ee0: 6e74 696e 7565 2122 290a 2020 2020 2020  ntinue!").      
-00001ef0: 2020 7265 7475 726e 2073 740a 2020 2020    return st.    
-00001f00: 7370 7320 3d20 696e 7428 7374 5b30 5d2e  sps = int(st[0].
-00001f10: 7374 6174 732e 7361 6d70 6c69 6e67 5f72  stats.sampling_r
-00001f20: 6174 6529 0a20 2020 2073 7461 7469 6f6e  ate).    station
-00001f30: 203d 2073 745b 305d 2e73 7461 7473 2e73   = st[0].stats.s
-00001f40: 7461 7469 6f6e 0a0a 2020 2020 2320 7265  tation..    # re
-00001f50: 6d6f 7665 206e 616e 2f69 6e66 2c20 6d65  move nan/inf, me
-00001f60: 616e 2061 6e64 2074 7265 6e64 206f 6620  an and trend of 
-00001f70: 6561 6368 2074 7261 6365 2062 6566 6f72  each trace befor
-00001f80: 6520 6d65 7267 696e 670a 2020 2020 666f  e merging.    fo
-00001f90: 7220 6969 2069 6e20 7261 6e67 6528 6c65  r ii in range(le
-00001fa0: 6e28 7374 2929 3a0a 2020 2020 2020 2020  n(st)):.        
-00001fb0: 2320 2d2d 2d2d 2d73 6574 206e 616e 2f69  # -----set nan/i
-00001fc0: 6e66 2076 616c 7565 7320 746f 207a 6572  nf values to zer
-00001fd0: 6f73 2028 6974 2064 6f65 7320 6861 7070  os (it does happ
-00001fe0: 656e 7321 292d 2d2d 2d2d 0a20 2020 2020  ens!)-----.     
-00001ff0: 2020 2074 7474 696e 6478 203d 206e 702e     tttindx = np.
-00002000: 7768 6572 6528 6e70 2e69 736e 616e 2873  where(np.isnan(s
-00002010: 745b 6969 5d2e 6461 7461 2929 0a20 2020  t[ii].data)).   
-00002020: 2020 2020 2069 6620 6c65 6e28 7474 7469       if len(ttti
-00002030: 6e64 7829 203e 2030 3a0a 2020 2020 2020  ndx) > 0:.      
-00002040: 2020 2020 2020 7374 5b69 695d 2e64 6174        st[ii].dat
-00002050: 615b 7474 7469 6e64 785d 203d 2030 0a20  a[tttindx] = 0. 
-00002060: 2020 2020 2020 2074 7474 696e 6478 203d         tttindx =
-00002070: 206e 702e 7768 6572 6528 6e70 2e69 7369   np.where(np.isi
-00002080: 6e66 2873 745b 6969 5d2e 6461 7461 2929  nf(st[ii].data))
-00002090: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-000020a0: 7474 7469 6e64 7829 203e 2030 3a0a 2020  tttindx) > 0:.  
-000020b0: 2020 2020 2020 2020 2020 7374 5b69 695d            st[ii]
-000020c0: 2e64 6174 615b 7474 7469 6e64 785d 203d  .data[tttindx] =
-000020d0: 2030 0a0a 2020 2020 2020 2020 7374 5b69   0..        st[i
-000020e0: 695d 2e64 6174 6120 3d20 6e70 2e66 6c6f  i].data = np.flo
-000020f0: 6174 3332 2873 745b 6969 5d2e 6461 7461  at32(st[ii].data
-00002100: 290a 2020 2020 2020 2020 7374 5b69 695d  ).        st[ii]
-00002110: 2e64 6174 6120 3d20 7363 6970 792e 7369  .data = scipy.si
-00002120: 676e 616c 2e64 6574 7265 6e64 2873 745b  gnal.detrend(st[
-00002130: 6969 5d2e 6461 7461 2c20 7479 7065 3d22  ii].data, type="
-00002140: 636f 6e73 7461 6e74 2229 0a20 2020 2020  constant").     
-00002150: 2020 2073 745b 6969 5d2e 6461 7461 203d     st[ii].data =
-00002160: 2073 6369 7079 2e73 6967 6e61 6c2e 6465   scipy.signal.de
-00002170: 7472 656e 6428 7374 5b69 695d 2e64 6174  trend(st[ii].dat
-00002180: 612c 2074 7970 653d 226c 696e 6561 7222  a, type="linear"
-00002190: 290a 0a20 2020 2023 206d 6572 6765 2c20  )..    # merge, 
-000021a0: 7461 7065 7220 616e 6420 6669 6c74 6572  taper and filter
-000021b0: 2074 6865 2064 6174 610a 2020 2020 6966   the data.    if
-000021c0: 206c 656e 2873 7429 203e 2031 3a0a 2020   len(st) > 1:.  
-000021d0: 2020 2020 2020 7374 2e6d 6572 6765 286d        st.merge(m
-000021e0: 6574 686f 643d 312c 2066 696c 6c5f 7661  ethod=1, fill_va
-000021f0: 6c75 653d 3029 0a20 2020 2073 745b 305d  lue=0).    st[0]
-00002200: 2e74 6170 6572 286d 6178 5f70 6572 6365  .taper(max_perce
-00002210: 6e74 6167 653d 302e 3035 2c20 6d61 785f  ntage=0.05, max_
-00002220: 6c65 6e67 7468 3d35 3029 2020 2320 7461  length=50)  # ta
-00002230: 7065 7220 7769 6e64 6f77 0a20 2020 2073  per window.    s
-00002240: 745b 305d 2e64 6174 6120 3d20 6e70 2e66  t[0].data = np.f
-00002250: 6c6f 6174 3332 2862 616e 6470 6173 7328  loat32(bandpass(
-00002260: 7374 5b30 5d2e 6461 7461 2c20 7072 655f  st[0].data, pre_
-00002270: 6669 6c74 5b30 5d2c 2070 7265 5f66 696c  filt[0], pre_fil
-00002280: 745b 2d31 5d2c 2064 663d 7370 732c 2063  t[-1], df=sps, c
-00002290: 6f72 6e65 7273 3d34 2c20 7a65 726f 7068  orners=4, zeroph
-000022a0: 6173 653d 5472 7565 2929 0a0a 2020 2020  ase=True))..    
-000022b0: 2320 6d61 6b65 2064 6f77 6e73 616d 706c  # make downsampl
-000022c0: 696e 6720 6966 206e 6565 6465 640a 2020  ing if needed.  
-000022d0: 2020 6966 2061 6273 2873 616d 705f 6672    if abs(samp_fr
-000022e0: 6571 202d 2073 7073 2920 3e20 3165 2d34  eq - sps) > 1e-4
-000022f0: 3a0a 2020 2020 2020 2020 2320 646f 776e  :.        # down
-00002300: 7361 6d70 6c69 6e67 2068 6572 650a 2020  sampling here.  
-00002310: 2020 2020 2020 7374 2e69 6e74 6572 706f        st.interpo
-00002320: 6c61 7465 2873 616d 705f 6672 6571 2c20  late(samp_freq, 
-00002330: 6d65 7468 6f64 3d22 7765 6967 6874 6564  method="weighted
-00002340: 5f61 7665 7261 6765 5f73 6c6f 7065 7322  _average_slopes"
-00002350: 290a 2020 2020 2020 2020 6465 6c74 6120  ).        delta 
-00002360: 3d20 7374 5b30 5d2e 7374 6174 732e 6465  = st[0].stats.de
-00002370: 6c74 610a 0a20 2020 2020 2020 2023 2077  lta..        # w
-00002380: 6865 6e20 7374 6172 7474 696d 6573 2061  hen starttimes a
-00002390: 7265 2062 6574 7765 656e 2073 616d 706c  re between sampl
-000023a0: 696e 6720 706f 696e 7473 0a20 2020 2020  ing points.     
-000023b0: 2020 2066 7269 6320 3d20 7374 5b30 5d2e     fric = st[0].
-000023c0: 7374 6174 732e 7374 6172 7474 696d 652e  stats.starttime.
-000023d0: 6d69 6372 6f73 6563 6f6e 6420 2520 2864  microsecond % (d
-000023e0: 656c 7461 202a 2031 6536 290a 2020 2020  elta * 1e6).    
-000023f0: 2020 2020 6966 2066 7269 6320 3e20 3165      if fric > 1e
-00002400: 2d34 3a0a 2020 2020 2020 2020 2020 2020  -4:.            
-00002410: 7374 5b30 5d2e 6461 7461 203d 2073 6567  st[0].data = seg
-00002420: 6d65 6e74 5f69 6e74 6572 706f 6c61 7465  ment_interpolate
-00002430: 286e 702e 666c 6f61 7433 3228 7374 5b30  (np.float32(st[0
-00002440: 5d2e 6461 7461 292c 2066 6c6f 6174 2866  ].data), float(f
-00002450: 7269 6320 2f20 2864 656c 7461 202a 2031  ric / (delta * 1
-00002460: 6536 2929 290a 2020 2020 2020 2020 2020  e6))).          
-00002470: 2020 2320 2d2d 7265 7365 7420 7468 6520    # --reset the 
-00002480: 7469 6d65 2074 6f20 7265 6d6f 7665 2074  time to remove t
-00002490: 6865 2064 6973 6372 6570 616e 6379 2d2d  he discrepancy--
-000024a0: 2d0a 2020 2020 2020 2020 2020 2020 7374  -.            st
-000024b0: 5b30 5d2e 7374 6174 732e 7374 6172 7474  [0].stats.startt
-000024c0: 696d 6520 2d3d 2066 7269 6320 2a20 3165  ime -= fric * 1e
-000024d0: 2d36 0a0a 2020 2020 2320 7265 6d6f 7665  -6..    # remove
-000024e0: 2074 7261 6365 7320 6f66 2074 6f6f 2073   traces of too s
-000024f0: 6d61 6c6c 206c 656e 6774 680a 0a20 2020  mall length..   
-00002500: 2023 206f 7074 696f 6e73 2074 6f20 7265   # options to re
-00002510: 6d6f 7665 2069 6e73 7472 756d 656e 7420  move instrument 
-00002520: 7265 7370 6f6e 7365 0a20 2020 2069 6620  response.    if 
-00002530: 726d 5f72 6573 7020 213d 2022 6e6f 223a  rm_resp != "no":
-00002540: 0a20 2020 2020 2020 2069 6620 726d 5f72  .        if rm_r
-00002550: 6573 7020 213d 2022 696e 7622 3a0a 2020  esp != "inv":.  
-00002560: 2020 2020 2020 2020 2020 6966 2028 7265            if (re
-00002570: 7370 6469 7220 6973 204e 6f6e 6529 206f  spdir is None) o
-00002580: 7220 286e 6f74 206f 732e 7061 7468 2e69  r (not os.path.i
-00002590: 7364 6972 2872 6573 7064 6972 2929 3a0a  sdir(respdir)):.
-000025a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000025b0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-000025c0: 2822 7265 7370 6f6e 7365 2066 696c 6520  ("response file 
-000025d0: 666f 6c64 6572 206e 6f74 2066 6f75 6e64  folder not found
-000025e0: 2120 6162 6f72 7421 2229 0a0a 2020 2020  ! abort!")..    
-000025f0: 2020 2020 6966 2072 6d5f 7265 7370 203d      if rm_resp =
-00002600: 3d20 2269 6e76 223a 0a20 2020 2020 2020  = "inv":.       
-00002610: 2020 2020 2023 202d 2d2d 2d63 6865 636b       # ----check
-00002620: 2077 6865 7468 6572 2069 6e76 656e 746f   whether invento
-00002630: 7279 2069 7320 6174 7461 6368 6564 2d2d  ry is attached--
-00002640: 2d2d 0a20 2020 2020 2020 2020 2020 2069  --.            i
-00002650: 6620 6e6f 7420 696e 765b 305d 5b30 5d5b  f not inv[0][0][
-00002660: 305d 2e72 6573 706f 6e73 653a 0a20 2020  0].response:.   
-00002670: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00002680: 7365 2056 616c 7565 4572 726f 7228 226e  se ValueError("n
-00002690: 6f20 7265 7370 6f6e 7365 2066 6f75 6e64  o response found
-000026a0: 2069 6e20 7468 6520 696e 7665 6e74 6f72   in the inventor
-000026b0: 7921 2061 626f 7274 2122 290a 2020 2020  y! abort!").    
-000026c0: 2020 2020 2020 2020 656c 6966 2069 6e76          elif inv
-000026d0: 5b30 5d5b 305d 5b30 5d2e 7265 7370 6f6e  [0][0][0].respon
-000026e0: 7365 203d 3d20 6f62 7370 792e 636f 7265  se == obspy.core
-000026f0: 2e69 6e76 656e 746f 7279 2e72 6573 706f  .inventory.respo
-00002700: 6e73 652e 5265 7370 6f6e 7365 2829 3a0a  nse.Response():.
-00002710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002720: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00002730: 2822 5468 6520 7265 7370 6f6e 7365 2066  ("The response f
-00002740: 6f75 6e64 2069 6e20 7468 6520 696e 7665  ound in the inve
-00002750: 6e74 6f72 7920 6973 2065 6d70 7479 2028  ntory is empty (
-00002760: 6e6f 2073 7461 6765 7329 2120 6162 6f72  no stages)! abor
-00002770: 7421 2229 0a20 2020 2020 2020 2020 2020  t!").           
-00002780: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00002790: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-000027a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000027b0: 7072 696e 7428 2272 656d 6f76 696e 6720  print("removing 
-000027c0: 7265 7370 6f6e 7365 2066 6f72 2025 7320  response for %s 
-000027d0: 7573 696e 6720 696e 7622 2025 2073 745b  using inv" % st[
-000027e0: 305d 290a 2020 2020 2020 2020 2020 2020  0]).            
-000027f0: 2020 2020 2020 2020 7374 5b30 5d2e 6174          st[0].at
-00002800: 7461 6368 5f72 6573 706f 6e73 6528 696e  tach_response(in
-00002810: 7629 0a20 2020 2020 2020 2020 2020 2020  v).             
-00002820: 2020 2020 2020 2073 745b 305d 2e72 656d         st[0].rem
-00002830: 6f76 655f 7265 7370 6f6e 7365 286f 7574  ove_response(out
-00002840: 7075 743d 726d 5f72 6573 705f 6f75 742c  put=rm_resp_out,
-00002850: 2070 7265 5f66 696c 743d 7072 655f 6669   pre_filt=pre_fi
-00002860: 6c74 2c20 7761 7465 725f 6c65 7665 6c3d  lt, water_level=
-00002870: 3630 290a 2020 2020 2020 2020 2020 2020  60).            
-00002880: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-00002890: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
-000028a0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-000028b0: 2257 4152 4e49 4e47 3a20 4661 696c 6564  "WARNING: Failed
-000028c0: 2074 6f20 7265 6d6f 7665 2072 6573 706f   to remove respo
-000028d0: 6e73 6520 6672 6f6d 2025 732e 2052 6574  nse from %s. Ret
-000028e0: 7572 6e69 6e67 2065 6d70 7479 2073 7472  urning empty str
-000028f0: 6561 6d2e 2220 2520 7374 5b30 5d29 0a20  eam." % st[0]). 
-00002900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002910: 2020 2073 7420 3d20 5b5d 0a20 2020 2020     st = [].     
-00002920: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00002930: 6574 7572 6e20 7374 0a0a 2020 2020 2020  eturn st..      
-00002940: 2020 656c 6966 2072 6d5f 7265 7370 203d    elif rm_resp =
-00002950: 3d20 2273 7065 6374 7275 6d22 3a0a 2020  = "spectrum":.  
-00002960: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00002970: 2272 656d 6f76 6520 7265 7370 6f6e 7365  "remove response
-00002980: 2075 7369 6e67 2073 7065 6374 7275 6d22   using spectrum"
-00002990: 290a 2020 2020 2020 2020 2020 2020 7370  ).            sp
-000029a0: 6563 6669 6c65 203d 2067 6c6f 622e 676c  ecfile = glob.gl
-000029b0: 6f62 286f 732e 7061 7468 2e6a 6f69 6e28  ob(os.path.join(
-000029c0: 7265 7370 6469 722c 2022 2a22 202b 2073  respdir, "*" + s
-000029d0: 7461 7469 6f6e 202b 2022 2a22 2929 0a20  tation + "*")). 
-000029e0: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-000029f0: 6e28 7370 6563 6669 6c65 2920 3d3d 2030  n(specfile) == 0
-00002a00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00002a10: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-00002a20: 6f72 2822 6e6f 2072 6573 706f 6e73 6520  or("no response 
-00002a30: 7365 7063 7472 756d 2066 6f75 6e64 2066  sepctrum found f
-00002a40: 6f72 2025 7322 2025 2073 7461 7469 6f6e  or %s" % station
-00002a50: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
-00002a60: 203d 2072 6573 705f 7370 6563 7472 756d   = resp_spectrum
-00002a70: 2873 742c 2073 7065 6366 696c 655b 305d  (st, specfile[0]
-00002a80: 2c20 7361 6d70 5f66 7265 712c 2070 7265  , samp_freq, pre
-00002a90: 5f66 696c 7429 0a0a 2020 2020 2020 2020  _filt)..        
-00002aa0: 656c 6966 2072 6d5f 7265 7370 203d 3d20  elif rm_resp == 
-00002ab0: 2252 4553 5022 3a0a 2020 2020 2020 2020  "RESP":.        
-00002ac0: 2020 2020 7072 696e 7428 2272 656d 6f76      print("remov
-00002ad0: 6520 7265 7370 6f6e 7365 2075 7369 6e67  e response using
-00002ae0: 2052 4553 5020 6669 6c65 7322 290a 2020   RESP files").  
-00002af0: 2020 2020 2020 2020 2020 7265 7370 203d            resp =
-00002b00: 2067 6c6f 622e 676c 6f62 286f 732e 7061   glob.glob(os.pa
-00002b10: 7468 2e6a 6f69 6e28 7265 7370 6469 722c  th.join(respdir,
-00002b20: 2022 5245 5350 2e22 202b 2073 7461 7469   "RESP." + stati
-00002b30: 6f6e 202b 2022 2a22 2929 0a20 2020 2020  on + "*")).     
-00002b40: 2020 2020 2020 2069 6620 6c65 6e28 7265         if len(re
-00002b50: 7370 2920 3d3d 2030 3a0a 2020 2020 2020  sp) == 0:.      
-00002b60: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00002b70: 5661 6c75 6545 7272 6f72 2822 6e6f 2052  ValueError("no R
-00002b80: 4553 5020 6669 6c65 7320 666f 756e 6420  ESP files found 
-00002b90: 666f 7220 2573 2220 2520 7374 6174 696f  for %s" % statio
-00002ba0: 6e29 0a20 2020 2020 2020 2020 2020 2073  n).            s
-00002bb0: 6565 6472 6573 7020 3d20 7b0a 2020 2020  eedresp = {.    
-00002bc0: 2020 2020 2020 2020 2020 2020 2266 696c              "fil
-00002bd0: 656e 616d 6522 3a20 7265 7370 5b30 5d2c  ename": resp[0],
-00002be0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002bf0: 2022 6461 7465 223a 2064 6174 655f 696e   "date": date_in
-00002c00: 666f 5b22 7374 6172 7474 696d 6522 5d2c  fo["starttime"],
-00002c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002c20: 2022 756e 6974 7322 3a20 2244 4953 222c   "units": "DIS",
-00002c30: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-00002c40: 2020 2020 2020 2020 2020 2073 742e 7369             st.si
-00002c50: 6d75 6c61 7465 2870 617a 5f72 656d 6f76  mulate(paz_remov
-00002c60: 653d 4e6f 6e65 2c20 7072 655f 6669 6c74  e=None, pre_filt
-00002c70: 3d70 7265 5f66 696c 742c 2073 6565 6472  =pre_filt, seedr
-00002c80: 6573 703d 7365 6564 7265 7370 5b30 5d29  esp=seedresp[0])
-00002c90: 0a0a 2020 2020 2020 2020 656c 6966 2072  ..        elif r
-00002ca0: 6d5f 7265 7370 203d 3d20 2270 6f6c 6f7a  m_resp == "poloz
-00002cb0: 6572 6f73 223a 0a20 2020 2020 2020 2020  eros":.         
-00002cc0: 2020 2070 7269 6e74 2822 7265 6d6f 7665     print("remove
-00002cd0: 2072 6573 706f 6e73 6520 7573 696e 6720   response using 
-00002ce0: 706f 6c6f 7320 616e 6420 7a65 726f 7322  polos and zeros"
-00002cf0: 290a 2020 2020 2020 2020 2020 2020 7061  ).            pa
-00002d00: 7a5f 7374 7320 3d20 676c 6f62 2e67 6c6f  z_sts = glob.glo
-00002d10: 6228 6f73 2e70 6174 682e 6a6f 696e 2872  b(os.path.join(r
-00002d20: 6573 7064 6972 2c20 222a 2220 2b20 7374  espdir, "*" + st
-00002d30: 6174 696f 6e20 2b20 222a 2229 290a 2020  ation + "*")).  
-00002d40: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-00002d50: 2870 617a 5f73 7473 2920 3d3d 2030 3a0a  (paz_sts) == 0:.
-00002d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002d70: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00002d80: 2822 6e6f 2070 6f6c 6f7a 6572 6f73 2066  ("no polozeros f
-00002d90: 6f75 6e64 2066 6f72 2025 7322 2025 2073  ound for %s" % s
-00002da0: 7461 7469 6f6e 290a 2020 2020 2020 2020  tation).        
-00002db0: 2020 2020 7374 2e73 696d 756c 6174 6528      st.simulate(
-00002dc0: 7061 7a5f 7265 6d6f 7665 3d70 617a 5f73  paz_remove=paz_s
-00002dd0: 7473 5b30 5d2c 2070 7265 5f66 696c 743d  ts[0], pre_filt=
-00002de0: 7072 655f 6669 6c74 290a 0a20 2020 2020  pre_filt)..     
-00002df0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00002e00: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00002e10: 4572 726f 7228 226e 6f20 7375 6368 206f  Error("no such o
-00002e20: 7074 696f 6e20 666f 7220 726d 5f72 6573  ption for rm_res
-00002e30: 7021 2070 6c65 6173 6520 646f 7562 6c65  p! please double
-00002e40: 2063 6865 636b 2122 290a 0a20 2020 206e   check!")..    n
-00002e50: 7472 203d 206f 6273 7079 2e53 7472 6561  tr = obspy.Strea
-00002e60: 6d28 290a 2020 2020 2320 7472 696d 2061  m().    # trim a
-00002e70: 2063 6f6e 7469 6e6f 7573 2073 6567 6d65   continous segme
-00002e80: 6e74 2069 6e74 6f20 7573 6572 2d64 6566  nt into user-def
-00002e90: 696e 6564 2073 6571 7565 6e63 6573 0a20  ined sequences. 
-00002ea0: 2020 2073 745b 305d 2e74 7269 6d28 0a20     st[0].trim(. 
-00002eb0: 2020 2020 2020 2073 7461 7274 7469 6d65         starttime
-00002ec0: 3d64 6174 655f 696e 666f 5b22 7374 6172  =date_info["star
-00002ed0: 7474 696d 6522 5d2c 0a20 2020 2020 2020  ttime"],.       
-00002ee0: 2065 6e64 7469 6d65 3d64 6174 655f 696e   endtime=date_in
-00002ef0: 666f 5b22 656e 6474 696d 6522 5d2c 0a20  fo["endtime"],. 
-00002f00: 2020 2020 2020 2070 6164 3d54 7275 652c         pad=True,
-00002f10: 0a20 2020 2020 2020 2066 696c 6c5f 7661  .        fill_va
-00002f20: 6c75 653d 302c 0a20 2020 2029 0a20 2020  lue=0,.    ).   
-00002f30: 206e 7472 2e61 7070 656e 6428 7374 5b30   ntr.append(st[0
-00002f40: 5d29 0a0a 2020 2020 7265 7475 726e 206e  ])..    return n
-00002f50: 7472 0a0a 0a64 6566 2073 7461 7473 3269  tr...def stats2i
-00002f60: 6e76 2873 7461 7473 2c20 7072 6570 726f  nv(stats, prepro
-00002f70: 5f70 6172 612c 206c 6f63 733d 4e6f 6e65  _para, locs=None
-00002f80: 293a 0a20 2020 2022 2222 0a20 2020 2074  ):.    """.    t
-00002f90: 6869 7320 6675 6e63 7469 6f6e 2063 7265  his function cre
-00002fa0: 6174 6573 2069 6e76 656e 746f 7279 2067  ates inventory g
-00002fb0: 6976 656e 2074 6865 2073 7461 7473 2070  iven the stats p
-00002fc0: 6172 616d 6574 6572 7320 696e 2061 6e20  arameters in an 
-00002fd0: 6f62 7370 7920 7374 7265 616d 206f 7220  obspy stream or 
-00002fe0: 6120 7374 6174 696f 6e20 6c69 7374 2e0a  a station list..
-00002ff0: 2020 2020 2875 7365 6420 696e 2053 3042      (used in S0B
-00003000: 290a 2020 2020 5041 5241 4d45 5445 5253  ).    PARAMETERS
-00003010: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
-00003020: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
-00003030: 2020 2073 7461 7473 3a20 6f62 7370 7920     stats: obspy 
-00003040: 7472 6163 6520 7374 6174 7320 6f62 6a65  trace stats obje
-00003050: 6374 2063 6f6e 7461 696e 696e 6720 616c  ct containing al
-00003060: 6c20 7374 6174 696f 6e20 6865 6164 6572  l station header
-00003070: 2069 6e66 6f0a 2020 2020 7072 6570 726f   info.    prepro
-00003080: 5f70 6172 613a 2064 6963 7420 636f 6e74  _para: dict cont
-00003090: 6169 6e69 6e67 2066 6674 2070 6172 616d  aining fft param
-000030a0: 6574 6572 732c 2073 7563 6820 6173 2066  eters, such as f
-000030b0: 7265 7175 656e 6379 2062 616e 6473 2061  requency bands a
-000030c0: 6e64 2073 656c 6563 7469 6f6e 2066 6f72  nd selection for
-000030d0: 2069 6e73 7472 756d 656e 740a 2020 2020   instrument.    
-000030e0: 7265 7370 6f6e 7365 2072 656d 6f76 616c  response removal
-000030f0: 2065 7463 2e0a 2020 2020 6c6f 6373 3a20   etc..    locs: 
-00003100: 2070 616e 6461 2064 6174 6120 6672 616d   panda data fram
-00003110: 6520 6f66 2074 6865 2073 7461 7469 6f6e  e of the station
-00003120: 206c 6973 742e 2069 7420 6973 206e 6565   list. it is nee
-00003130: 6465 6420 666f 7220 636f 6e76 6572 696e  ded for converin
-00003140: 6720 6d69 6e69 7365 6564 2066 696c 6573  g miniseed files
-00003150: 2069 6e74 6f20 4153 4446 0a20 2020 2052   into ASDF.    R
-00003160: 4554 5552 4e53 3a0a 2020 2020 2d2d 2d2d  ETURNS:.    ----
-00003170: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00003180: 2d2d 2d2d 0a20 2020 2069 6e76 3a20 6f62  ----.    inv: ob
-00003190: 7370 7920 696e 7665 6e74 6f72 7920 6f62  spy inventory ob
-000031a0: 6a65 6374 206f 6620 616c 6c20 7374 6174  ject of all stat
-000031b0: 696f 6e20 696e 666f 2074 6f20 6265 2075  ion info to be u
-000031c0: 7365 6420 6c61 7465 720a 2020 2020 2222  sed later.    ""
-000031d0: 220a 2020 2020 7374 6178 6d6c 203d 2070  ".    staxml = p
-000031e0: 7265 7072 6f5f 7061 7261 5b22 7374 6174  repro_para["stat
-000031f0: 696f 6e78 6d6c 225d 0a20 2020 2072 6573  ionxml"].    res
-00003200: 7064 6972 203d 2070 7265 7072 6f5f 7061  pdir = prepro_pa
-00003210: 7261 5b22 7265 7370 6469 7222 5d0a 2020  ra["respdir"].  
-00003220: 2020 696e 7075 745f 666d 7420 3d20 7072    input_fmt = pr
-00003230: 6570 726f 5f70 6172 615b 2269 6e70 7574  epro_para["input
-00003240: 5f66 6d74 225d 0a0a 2020 2020 6966 2073  _fmt"]..    if s
-00003250: 7461 786d 6c3a 0a20 2020 2020 2020 2069  taxml:.        i
-00003260: 6620 6e6f 7420 7265 7370 6469 723a 0a20  f not respdir:. 
-00003270: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00003280: 2056 616c 7565 4572 726f 7228 2241 626f   ValueError("Abo
-00003290: 7274 2120 7374 6178 6d6c 2069 7320 7365  rt! staxml is se
-000032a0: 6c65 6374 6564 2062 7574 206e 6f20 6469  lected but no di
-000032b0: 7265 6374 6f72 7920 6973 2067 6976 656e  rectory is given
-000032c0: 2074 6f20 6163 6365 7373 2074 6865 2066   to access the f
-000032d0: 696c 6573 2229 0a20 2020 2020 2020 2065  iles").        e
-000032e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000032f0: 2069 6e76 6669 6c65 6c69 7374 203d 2067   invfilelist = g
-00003300: 6c6f 622e 676c 6f62 286f 732e 7061 7468  lob.glob(os.path
-00003310: 2e6a 6f69 6e28 7265 7370 6469 722c 2022  .join(respdir, "
-00003320: 2a22 202b 2073 7461 7473 2e73 7461 7469  *" + stats.stati
-00003330: 6f6e 202b 2022 2a22 2929 0a20 2020 2020  on + "*")).     
-00003340: 2020 2020 2020 2069 6620 6c65 6e28 696e         if len(in
-00003350: 7666 696c 656c 6973 7429 203e 2030 3a0a  vfilelist) > 0:.
-00003360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003370: 696e 7666 696c 6520 3d20 696e 7666 696c  invfile = invfil
-00003380: 656c 6973 745b 305d 0a20 2020 2020 2020  elist[0].       
-00003390: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-000033a0: 696e 7666 696c 656c 6973 7429 203e 2031  invfilelist) > 1
-000033b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000033c0: 2020 2020 2020 7072 696e 7428 0a20 2020        print(.   
-000033d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000033e0: 2020 2020 2028 0a20 2020 2020 2020 2020       (.         
-000033f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003400: 2020 2022 5761 726e 696e 6721 204d 6f72     "Warning! Mor
-00003410: 6520 7468 616e 206f 6e65 2053 7461 7469  e than one Stati
-00003420: 6f6e 584d 4c20 6669 6c65 2077 6173 2066  onXML file was f
-00003430: 6f75 6e64 2066 6f72 2073 7461 7469 6f6e  ound for station
-00003440: 2025 732e 220a 2020 2020 2020 2020 2020   %s.".          
-00003450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003460: 2020 2b20 224b 6565 7069 6e67 2074 6865    + "Keeping the
-00003470: 2066 6972 7374 2066 696c 6520 696e 206c   first file in l
-00003480: 6973 742e 220a 2020 2020 2020 2020 2020  ist.".          
-00003490: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-000034a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000034b0: 2020 2020 2020 2020 2520 7374 6174 732e          % stats.
-000034c0: 7374 6174 696f 6e0a 2020 2020 2020 2020  station.        
-000034d0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000034e0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000034f0: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
-00003500: 7374 7228 696e 7666 696c 6529 293a 0a20  str(invfile)):. 
+000005c0: 2323 2323 2323 230a 2323 2323 2323 2323  #######.########
+000005d0: 2323 2323 2323 2043 4f52 4520 4655 4e43  ###### CORE FUNC
+000005e0: 5449 4f4e 5320 2323 2323 2323 2323 2323  TIONS ##########
+000005f0: 2323 2323 2323 2323 2323 2323 0a23 2323  ############.###
+00000600: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000610: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000620: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000630: 230a 0a0a 6465 6620 6765 745f 6576 656e  #...def get_even
+00000640: 745f 6c69 7374 2873 7472 312c 2073 7472  t_list(str1, str
+00000650: 322c 2069 6e63 5f68 6f75 7273 293a 0a20  2, inc_hours):. 
+00000660: 2020 2022 2222 0a20 2020 2074 6869 7320     """.    this 
+00000670: 6675 6e63 7469 6f6e 2063 616c 6375 6c61  function calcula
+00000680: 7465 7320 7468 6520 6576 656e 7420 6c69  tes the event li
+00000690: 7374 2062 6574 7765 656e 2074 696d 6531  st between time1
+000006a0: 2061 6e64 2074 696d 6532 2062 7920 696e   and time2 by in
+000006b0: 6372 656d 656e 7420 6f66 2069 6e63 5f68  crement of inc_h
+000006c0: 6f75 7273 0a20 2020 2069 6e20 7468 6520  ours.    in the 
+000006d0: 666f 726d 6174 6520 6f66 2025 595f 256d  formate of %Y_%m
+000006e0: 5f25 645f 2548 5f25 4d5f 2553 2720 2875  _%d_%H_%M_%S' (u
+000006f0: 7365 6420 696e 2053 3041 2026 2053 3042  sed in S0A & S0B
+00000700: 290a 2020 2020 5041 5241 4d45 5445 5253  ).    PARAMETERS
+00000710: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
+00000720: 2d2d 2d2d 2d2d 0a20 2020 2073 7472 313a  ------.    str1:
+00000730: 2073 7472 696e 6720 6f66 2074 6865 2073   string of the s
+00000740: 7461 7274 696e 6720 7469 6d65 202d 3e20  tarting time -> 
+00000750: 3230 3130 5f30 315f 3031 5f30 5f30 0a20  2010_01_01_0_0. 
+00000760: 2020 2073 7472 323a 2073 7472 696e 6720     str2: string 
+00000770: 6f66 2074 6865 2065 6e64 696e 6720 7469  of the ending ti
+00000780: 6d65 202d 3e20 3230 3130 5f31 305f 3131  me -> 2010_10_11
+00000790: 5f30 5f30 0a20 2020 2069 6e63 5f68 6f75  _0_0.    inc_hou
+000007a0: 7273 3a20 696e 7465 6765 7220 6f66 2069  rs: integer of i
+000007b0: 6e63 7265 6d65 6e74 616c 2068 6f75 7273  ncremental hours
+000007c0: 0a20 2020 2052 4554 5552 4e53 3a0a 2020  .    RETURNS:.  
+000007d0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
+000007e0: 2d2d 0a20 2020 2065 7665 6e74 3a20 6120  --.    event: a 
+000007f0: 6e75 6d70 7920 6368 6172 6163 7465 7220  numpy character 
+00000800: 6c69 7374 0a20 2020 2022 2222 0a20 2020  list.    """.   
+00000810: 2064 6174 6531 203d 2073 7472 312e 7370   date1 = str1.sp
+00000820: 6c69 7428 225f 2229 0a20 2020 2064 6174  lit("_").    dat
+00000830: 6532 203d 2073 7472 322e 7370 6c69 7428  e2 = str2.split(
+00000840: 225f 2229 0a20 2020 2079 3120 3d20 696e  "_").    y1 = in
+00000850: 7428 6461 7465 315b 305d 290a 2020 2020  t(date1[0]).    
+00000860: 6d31 203d 2069 6e74 2864 6174 6531 5b31  m1 = int(date1[1
+00000870: 5d29 0a20 2020 2064 3120 3d20 696e 7428  ]).    d1 = int(
+00000880: 6461 7465 315b 325d 290a 2020 2020 6831  date1[2]).    h1
+00000890: 203d 2069 6e74 2864 6174 6531 5b33 5d29   = int(date1[3])
+000008a0: 0a20 2020 206d 6d31 203d 2069 6e74 2864  .    mm1 = int(d
+000008b0: 6174 6531 5b34 5d29 0a20 2020 206d 6e31  ate1[4]).    mn1
+000008c0: 203d 2069 6e74 2864 6174 6531 5b35 5d29   = int(date1[5])
+000008d0: 0a20 2020 2079 3220 3d20 696e 7428 6461  .    y2 = int(da
+000008e0: 7465 325b 305d 290a 2020 2020 6d32 203d  te2[0]).    m2 =
+000008f0: 2069 6e74 2864 6174 6532 5b31 5d29 0a20   int(date2[1]). 
+00000900: 2020 2064 3220 3d20 696e 7428 6461 7465     d2 = int(date
+00000910: 325b 325d 290a 2020 2020 6832 203d 2069  2[2]).    h2 = i
+00000920: 6e74 2864 6174 6532 5b33 5d29 0a20 2020  nt(date2[3]).   
+00000930: 206d 6d32 203d 2069 6e74 2864 6174 6532   mm2 = int(date2
+00000940: 5b34 5d29 0a20 2020 206d 6e32 203d 2069  [4]).    mn2 = i
+00000950: 6e74 2864 6174 6532 5b35 5d29 0a0a 2020  nt(date2[5])..  
+00000960: 2020 6431 203d 2064 6174 6574 696d 652e    d1 = datetime.
+00000970: 6461 7465 7469 6d65 2879 312c 206d 312c  datetime(y1, m1,
+00000980: 2064 312c 2068 312c 206d 6d31 2c20 6d6e   d1, h1, mm1, mn
+00000990: 3129 0a20 2020 2064 3220 3d20 6461 7465  1).    d2 = date
+000009a0: 7469 6d65 2e64 6174 6574 696d 6528 7932  time.datetime(y2
+000009b0: 2c20 6d32 2c20 6432 2c20 6832 2c20 6d6d  , m2, d2, h2, mm
+000009c0: 322c 206d 6e32 290a 2020 2020 6474 203d  2, mn2).    dt =
+000009d0: 2064 6174 6574 696d 652e 7469 6d65 6465   datetime.timede
+000009e0: 6c74 6128 686f 7572 733d 696e 635f 686f  lta(hours=inc_ho
+000009f0: 7572 7329 0a0a 2020 2020 6576 656e 7420  urs)..    event 
+00000a00: 3d20 5b5d 0a20 2020 2077 6869 6c65 2064  = [].    while d
+00000a10: 3120 3c20 6432 3a0a 2020 2020 2020 2020  1 < d2:.        
+00000a20: 6576 656e 742e 6170 7065 6e64 2864 312e  event.append(d1.
+00000a30: 7374 7266 7469 6d65 2822 2559 5f25 6d5f  strftime("%Y_%m_
+00000a40: 2564 5f25 485f 254d 5f25 5322 2929 0a20  %d_%H_%M_%S")). 
+00000a50: 2020 2020 2020 2064 3120 2b3d 2064 740a         d1 += dt.
+00000a60: 2020 2020 6576 656e 742e 6170 7065 6e64      event.append
+00000a70: 2864 322e 7374 7266 7469 6d65 2822 2559  (d2.strftime("%Y
+00000a80: 5f25 6d5f 2564 5f25 485f 254d 5f25 5322  _%m_%d_%H_%M_%S"
+00000a90: 2929 0a0a 2020 2020 7265 7475 726e 2065  ))..    return e
+00000aa0: 7665 6e74 0a0a 0a64 6566 206d 616b 655f  vent...def make_
+00000ab0: 7469 6d65 7374 616d 7073 2870 7265 7072  timestamps(prepr
+00000ac0: 6f5f 7061 7261 293a 0a20 2020 2022 2222  o_para):.    """
+00000ad0: 0a20 2020 2074 6869 7320 6675 6e63 7469  .    this functi
+00000ae0: 6f6e 2070 7265 7061 7265 7320 7468 6520  on prepares the 
+00000af0: 7469 6d65 7374 616d 7073 206f 6620 626f  timestamps of bo
+00000b00: 7468 2074 6865 2073 7461 7274 696e 6720  th the starting 
+00000b10: 616e 6420 656e 6469 6e67 2074 696d 6520  and ending time 
+00000b20: 6f66 2065 6163 6820 6d73 6565 642f 7361  of each mseed/sa
+00000b30: 6320 6669 6c65 2074 6861 740a 2020 2020  c file that.    
+00000b40: 6973 2073 746f 7265 6420 6f6e 206c 6f63  is stored on loc
+00000b50: 616c 206d 6163 6869 6e65 2e20 7468 6973  al machine. this
+00000b60: 2074 696d 6520 696e 666f 2069 7320 7573   time info is us
+00000b70: 6564 2074 6f20 7365 6172 6368 2061 6c6c  ed to search all
+00000b80: 2073 7461 7469 6f6e 7320 696e 2073 7065   stations in spe
+00000b90: 6369 6669 6320 7469 6d65 2063 6875 6e63  cific time chunc
+00000ba0: 6b0a 2020 2020 7768 656e 2070 7265 7061  k.    when prepa
+00000bb0: 7269 6e67 206e 6f69 7365 2064 6174 6120  ring noise data 
+00000bc0: 696e 2041 5344 4620 666f 726d 6174 2e20  in ASDF format. 
+00000bd0: 6974 2063 7265 6174 6573 2061 2063 7376  it creates a csv
+00000be0: 2066 696c 6520 636f 6e74 6169 6e69 6e67   file containing
+00000bf0: 2061 6c6c 2074 696d 6573 7461 6d70 2069   all timestamp i
+00000c00: 6e66 6f20 6966 2074 6865 0a20 2020 2066  nfo if the.    f
+00000c10: 696c 6520 646f 6573 206e 6f74 2065 7869  ile does not exi
+00000c20: 7374 2028 7573 6564 2069 6e20 5330 4229  st (used in S0B)
+00000c30: 660a 2020 2020 5041 5241 4d45 5445 5253  f.    PARAMETERS
+00000c40: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
+00000c50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
+00000c60: 2020 7072 6570 726f 5f70 6172 613a 2061    prepro_para: a
+00000c70: 2064 6963 2063 6f6e 7461 696e 696e 6720   dic containing 
+00000c80: 616c 6c20 7072 652d 7072 6f63 6573 7369  all pre-processi
+00000c90: 6e67 2070 6172 616d 6574 6572 7320 7573  ng parameters us
+00000ca0: 6564 2069 6e20 5330 420a 2020 2020 5245  ed in S0B.    RE
+00000cb0: 5455 524e 533a 0a20 2020 202d 2d2d 2d2d  TURNS:.    -----
+00000cc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00000cd0: 2d2d 0a20 2020 2061 6c6c 5f73 7469 6d65  --.    all_stime
+00000ce0: 733a 206e 756d 7079 2066 6c6f 6174 2061  s: numpy float a
+00000cf0: 7272 6179 2063 6f6e 7461 696e 696e 6720  rray containing 
+00000d00: 7374 6172 7474 696e 6720 616e 6420 656e  startting and en
+00000d10: 6469 6e67 2074 696d 6520 666f 7220 616c  ding time for al
+00000d20: 6c20 5341 432f 6d73 6565 6420 6669 6c65  l SAC/mseed file
+00000d30: 730a 2020 2020 2222 220a 2020 2020 2320  s.    """.    # 
+00000d40: 6c6f 6164 2070 6172 616d 6574 6572 7320  load parameters 
+00000d50: 6672 6f6d 2070 6172 6120 6469 630a 2020  from para dic.  
+00000d60: 2020 7769 6b69 5f66 696c 6520 3d20 7072    wiki_file = pr
+00000d70: 6570 726f 5f70 6172 615b 2277 696b 695f  epro_para["wiki_
+00000d80: 6669 6c65 225d 0a20 2020 206d 6573 7379  file"].    messy
+00000d90: 6461 7461 203d 2070 7265 7072 6f5f 7061  data = prepro_pa
+00000da0: 7261 5b22 6d65 7373 7964 6174 6122 5d0a  ra["messydata"].
+00000db0: 2020 2020 5241 5744 4154 4120 3d20 7072      RAWDATA = pr
+00000dc0: 6570 726f 5f70 6172 615b 2252 4157 4441  epro_para["RAWDA
+00000dd0: 5441 225d 0a20 2020 2061 6c6c 6669 6c65  TA"].    allfile
+00000de0: 735f 7061 7468 203d 2070 7265 7072 6f5f  s_path = prepro_
+00000df0: 7061 7261 5b22 616c 6c66 696c 6573 5f70  para["allfiles_p
+00000e00: 6174 6822 5d0a 0a20 2020 2069 6620 6f73  ath"]..    if os
+00000e10: 2e70 6174 682e 6973 6669 6c65 2877 696b  .path.isfile(wik
+00000e20: 695f 6669 6c65 293a 0a20 2020 2020 2020  i_file):.       
+00000e30: 2074 6d70 203d 2070 642e 7265 6164 5f63   tmp = pd.read_c
+00000e40: 7376 2877 696b 695f 6669 6c65 290a 2020  sv(wiki_file).  
+00000e50: 2020 2020 2020 616c 6c66 696c 6573 203d        allfiles =
+00000e60: 2074 6d70 5b22 6e61 6d65 7322 5d0a 2020   tmp["names"].  
+00000e70: 2020 2020 2020 616c 6c5f 7374 696d 6573        all_stimes
+00000e80: 203d 206e 702e 7a65 726f 7328 7368 6170   = np.zeros(shap
+00000e90: 653d 286c 656e 2861 6c6c 6669 6c65 7329  e=(len(allfiles)
+00000ea0: 2c20 3229 2c20 6474 7970 653d 6e70 2e66  , 2), dtype=np.f
+00000eb0: 6c6f 6174 290a 2020 2020 2020 2020 616c  loat).        al
+00000ec0: 6c5f 7374 696d 6573 5b3a 2c20 305d 203d  l_stimes[:, 0] =
+00000ed0: 2074 6d70 5b22 7374 6172 7474 696d 6522   tmp["starttime"
+00000ee0: 5d0a 2020 2020 2020 2020 616c 6c5f 7374  ].        all_st
+00000ef0: 696d 6573 5b3a 2c20 315d 203d 2074 6d70  imes[:, 1] = tmp
+00000f00: 5b22 656e 6474 696d 6522 5d0a 0a20 2020  ["endtime"]..   
+00000f10: 2023 2068 6176 6520 746f 2072 6561 6420   # have to read 
+00000f20: 6561 6368 2073 6163 2f6d 7365 6564 2064  each sac/mseed d
+00000f30: 6174 6120 6f6e 6520 6279 206f 6e65 0a20  ata one by one. 
+00000f40: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00000f50: 2061 6c6c 6669 6c65 7320 3d20 676c 6f62   allfiles = glob
+00000f60: 2e67 6c6f 6228 616c 6c66 696c 6573 5f70  .glob(allfiles_p
+00000f70: 6174 6829 0a20 2020 2020 2020 206e 6669  ath).        nfi
+00000f80: 6c65 7320 3d20 6c65 6e28 616c 6c66 696c  les = len(allfil
+00000f90: 6573 290a 2020 2020 2020 2020 6966 206e  es).        if n
+00000fa0: 6f74 206e 6669 6c65 733a 0a20 2020 2020  ot nfiles:.     
+00000fb0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00000fc0: 7565 4572 726f 7228 2241 626f 7274 2120  ueError("Abort! 
+00000fd0: 6e6f 2064 6174 6120 666f 756e 6420 696e  no data found in
+00000fe0: 2073 7562 6469 7265 6374 6f72 7920 6f66   subdirectory of
+00000ff0: 2025 7322 2025 2052 4157 4441 5441 290a   %s" % RAWDATA).
+00001000: 2020 2020 2020 2020 616c 6c5f 7374 696d          all_stim
+00001010: 6573 203d 206e 702e 7a65 726f 7328 7368  es = np.zeros(sh
+00001020: 6170 653d 286e 6669 6c65 732c 2032 292c  ape=(nfiles, 2),
+00001030: 2064 7479 7065 3d6e 702e 666c 6f61 7429   dtype=np.float)
+00001040: 0a0a 2020 2020 2020 2020 6966 206d 6573  ..        if mes
+00001050: 7379 6461 7461 3a0a 2020 2020 2020 2020  sydata:.        
+00001060: 2020 2020 2320 6765 7420 5645 5259 2070      # get VERY p
+00001070: 7265 6369 7365 2074 7261 6365 2d74 696d  recise trace-tim
+00001080: 6520 6672 6f6d 2074 6865 2068 6561 6465  e from the heade
+00001090: 720a 2020 2020 2020 2020 2020 2020 666f  r.            fo
+000010a0: 7220 6969 2069 6e20 7261 6e67 6528 6e66  r ii in range(nf
+000010b0: 696c 6573 293a 0a20 2020 2020 2020 2020  iles):.         
+000010c0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000010d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000010e0: 7472 203d 206f 6273 7079 2e72 6561 6428  tr = obspy.read(
+000010f0: 616c 6c66 696c 6573 5b69 695d 290a 2020  allfiles[ii]).  
+00001100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001110: 2020 616c 6c5f 7374 696d 6573 5b69 692c    all_stimes[ii,
+00001120: 2030 5d20 3d20 7472 5b30 5d2e 7374 6174   0] = tr[0].stat
+00001130: 732e 7374 6172 7474 696d 6520 2d20 6f62  s.starttime - ob
+00001140: 7370 792e 5554 4344 6174 6554 696d 6528  spy.UTCDateTime(
+00001150: 3139 3730 2c20 312c 2031 290a 2020 2020  1970, 1, 1).    
+00001160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001170: 616c 6c5f 7374 696d 6573 5b69 692c 2031  all_stimes[ii, 1
+00001180: 5d20 3d20 7472 5b30 5d2e 7374 6174 732e  ] = tr[0].stats.
+00001190: 656e 6474 696d 6520 2d20 6f62 7370 792e  endtime - obspy.
+000011a0: 5554 4344 6174 6554 696d 6528 3139 3730  UTCDateTime(1970
+000011b0: 2c20 312c 2031 290a 2020 2020 2020 2020  , 1, 1).        
+000011c0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+000011d0: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
+000011e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000011f0: 2020 2070 7269 6e74 2865 290a 2020 2020     print(e).    
+00001200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001210: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
+00001220: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00001230: 2020 2023 2067 6574 2072 6f75 6768 2065     # get rough e
+00001240: 7374 696d 6174 6573 206f 6620 7468 6520  stimates of the 
+00001250: 7469 6d65 2062 6173 6564 206f 6e20 7468  time based on th
+00001260: 6520 666f 6c64 6572 3a20 6e65 6564 206d  e folder: need m
+00001270: 6f64 6966 6965 6420 746f 2061 6363 6f6d  odified to accom
+00001280: 6d6f 6461 7465 2079 6f75 7220 6461 7461  modate your data
+00001290: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000012a0: 2069 6920 696e 2072 616e 6765 286e 6669   ii in range(nfi
+000012b0: 6c65 7329 3a0a 2020 2020 2020 2020 2020  les):.          
+000012c0: 2020 2020 2020 7965 6172 203d 2069 6e74        year = int
+000012d0: 2861 6c6c 6669 6c65 735b 6969 5d2e 7370  (allfiles[ii].sp
+000012e0: 6c69 7428 222f 2229 5b2d 325d 2e73 706c  lit("/")[-2].spl
+000012f0: 6974 2822 5f22 295b 315d 290a 2020 2020  it("_")[1]).    
+00001300: 2020 2020 2020 2020 2020 2020 2320 6a75              # ju
+00001310: 6c69 6120 3d20 696e 7428 616c 6c66 696c  lia = int(allfil
+00001320: 6573 5b69 695d 2e73 706c 6974 2827 2f27  es[ii].split('/'
+00001330: 295b 2d32 5d2e 7370 6c69 7428 275f 2729  )[-2].split('_')
+00001340: 5b32 5d29 0a20 2020 2020 2020 2020 2020  [2]).           
+00001350: 2020 2020 2023 2061 6c6c 5f73 7469 6d65       # all_stime
+00001360: 735b 6969 2c30 5d20 3d20 6f62 7370 792e  s[ii,0] = obspy.
+00001370: 5554 4344 6174 6554 696d 6528 7965 6172  UTCDateTime(year
+00001380: 3d79 6561 722c 6a75 6c64 6179 3d6a 756c  =year,julday=jul
+00001390: 6961 290a 2020 2020 2020 2020 2020 2020  ia).            
+000013a0: 2020 2020 2320 2d6f 6273 7079 2e55 5443      # -obspy.UTC
+000013b0: 4461 7465 5469 6d65 2879 6561 723d 3139  DateTime(year=19
+000013c0: 3730 2c6d 6f6e 7468 3d31 2c64 6179 3d31  70,month=1,day=1
+000013d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000013e0: 2020 6d6f 6e74 6820 3d20 696e 7428 616c    month = int(al
+000013f0: 6c66 696c 6573 5b69 695d 2e73 706c 6974  lfiles[ii].split
+00001400: 2822 2f22 295b 2d32 5d2e 7370 6c69 7428  ("/")[-2].split(
+00001410: 225f 2229 5b32 5d29 0a20 2020 2020 2020  "_")[2]).       
+00001420: 2020 2020 2020 2020 2064 6179 203d 2069           day = i
+00001430: 6e74 2861 6c6c 6669 6c65 735b 6969 5d2e  nt(allfiles[ii].
+00001440: 7370 6c69 7428 222f 2229 5b2d 325d 2e73  split("/")[-2].s
+00001450: 706c 6974 2822 5f22 295b 335d 290a 2020  plit("_")[3]).  
+00001460: 2020 2020 2020 2020 2020 2020 2020 616c                al
+00001470: 6c5f 7374 696d 6573 5b69 692c 2030 5d20  l_stimes[ii, 0] 
+00001480: 3d20 6f62 7370 792e 5554 4344 6174 6554  = obspy.UTCDateT
+00001490: 696d 6528 7965 6172 3d79 6561 722c 206d  ime(year=year, m
+000014a0: 6f6e 7468 3d6d 6f6e 7468 2c20 6461 793d  onth=month, day=
+000014b0: 6461 7929 202d 206f 6273 7079 2e55 5443  day) - obspy.UTC
+000014c0: 4461 7465 5469 6d65 280a 2020 2020 2020  DateTime(.      
+000014d0: 2020 2020 2020 2020 2020 2020 2020 7965                ye
+000014e0: 6172 3d31 3937 302c 206d 6f6e 7468 3d31  ar=1970, month=1
+000014f0: 2c20 6461 793d 310a 2020 2020 2020 2020  , day=1.        
+00001500: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00001510: 2020 2020 2020 2020 2020 616c 6c5f 7374            all_st
+00001520: 696d 6573 5b69 692c 2031 5d20 3d20 616c  imes[ii, 1] = al
+00001530: 6c5f 7374 696d 6573 5b69 692c 2030 5d20  l_stimes[ii, 0] 
+00001540: 2b20 3836 3430 300a 0a20 2020 2020 2020  + 86400..       
+00001550: 2023 2073 6176 6520 6e61 6d65 2061 6e64   # save name and
+00001560: 2074 696d 6520 696e 666f 2066 6f72 206c   time info for l
+00001570: 6174 6572 2075 7365 2069 6620 7468 6520  ater use if the 
+00001580: 6669 6c65 206e 6f74 2065 7869 7374 0a20  file not exist. 
+00001590: 2020 2020 2020 2069 6620 6e6f 7420 6f73         if not os
+000015a0: 2e70 6174 682e 6973 6669 6c65 2877 696b  .path.isfile(wik
+000015b0: 695f 6669 6c65 293a 0a20 2020 2020 2020  i_file):.       
+000015c0: 2020 2020 2077 696b 695f 696e 666f 203d       wiki_info =
+000015d0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000015e0: 2020 2022 6e61 6d65 7322 3a20 616c 6c66     "names": allf
+000015f0: 696c 6573 2c0a 2020 2020 2020 2020 2020  iles,.          
+00001600: 2020 2020 2020 2273 7461 7274 7469 6d65        "starttime
+00001610: 223a 2061 6c6c 5f73 7469 6d65 735b 3a2c  ": all_stimes[:,
+00001620: 2030 5d2c 0a20 2020 2020 2020 2020 2020   0],.           
+00001630: 2020 2020 2022 656e 6474 696d 6522 3a20       "endtime": 
+00001640: 616c 6c5f 7374 696d 6573 5b3a 2c20 315d  all_stimes[:, 1]
+00001650: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
+00001660: 2020 2020 2020 2020 2020 2020 6466 203d              df =
+00001670: 2070 642e 4461 7461 4672 616d 6528 7769   pd.DataFrame(wi
+00001680: 6b69 5f69 6e66 6f2c 2063 6f6c 756d 6e73  ki_info, columns
+00001690: 3d5b 226e 616d 6573 222c 2022 7374 6172  =["names", "star
+000016a0: 7474 696d 6522 2c20 2265 6e64 7469 6d65  ttime", "endtime
+000016b0: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
+000016c0: 6466 2e74 6f5f 6373 7628 7769 6b69 5f66  df.to_csv(wiki_f
+000016d0: 696c 6529 0a20 2020 2072 6574 7572 6e20  ile).    return 
+000016e0: 616c 6c5f 7374 696d 6573 0a0a 0a64 6566  all_stimes...def
+000016f0: 2070 7265 7072 6f63 6573 735f 7261 7728   preprocess_raw(
+00001700: 0a20 2020 2073 743a 206f 6273 7079 2e53  .    st: obspy.S
+00001710: 7472 6561 6d2c 0a20 2020 2069 6e76 3a20  tream,.    inv: 
+00001720: 6f62 7370 792e 496e 7665 6e74 6f72 792c  obspy.Inventory,
+00001730: 0a20 2020 2070 7265 7072 6f5f 7061 7261  .    prepro_para
+00001740: 3a20 436f 6e66 6967 5061 7261 6d65 7465  : ConfigParamete
+00001750: 7273 2c0a 2020 2020 7374 6172 7474 696d  rs,.    starttim
+00001760: 653a 206f 6273 7079 2e55 5443 4461 7465  e: obspy.UTCDate
+00001770: 5469 6d65 2c0a 2020 2020 656e 6474 696d  Time,.    endtim
+00001780: 653a 206f 6273 7079 2e55 5443 4461 7465  e: obspy.UTCDate
+00001790: 5469 6d65 2c0a 293a 0a20 2020 2022 2222  Time,.):.    """
+000017a0: 0a20 2020 2074 6869 7320 6675 6e63 7469  .    this functi
+000017b0: 6f6e 2070 7265 2d70 726f 6365 7373 6573  on pre-processes
+000017c0: 2074 6865 2072 6177 2064 6174 6120 7374   the raw data st
+000017d0: 7265 616d 2062 793a 0a20 2020 2020 2020  ream by:.       
+000017e0: 2031 2920 6368 6563 6b20 7361 6d70 696e   1) check sampin
+000017f0: 6720 7261 7465 2061 6e64 2067 6170 7320  g rate and gaps 
+00001800: 696e 2074 6865 2064 6174 613b 0a20 2020  in the data;.   
+00001810: 2020 2020 2032 2920 7265 6d6f 7665 2073       2) remove s
+00001820: 6967 756c 6172 6974 792c 2074 7265 6e64  igularity, trend
+00001830: 2061 6e64 206d 6561 6e20 6f66 2065 6163   and mean of eac
+00001840: 6820 7472 6163 650a 2020 2020 2020 2020  h trace.        
+00001850: 3329 2066 696c 7465 7220 616e 6420 636f  3) filter and co
+00001860: 7272 6563 7420 7468 6520 7469 6d65 2069  rrect the time i
+00001870: 6620 696e 7465 6765 7220 7469 6d65 2061  f integer time a
+00001880: 7265 2062 6574 7765 656e 2073 616d 706c  re between sampl
+00001890: 696e 6720 706f 696e 7473 0a20 2020 2020  ing points.     
+000018a0: 2020 2034 2920 7265 6d6f 7665 2069 6e73     4) remove ins
+000018b0: 7472 756d 656e 7420 7265 7370 6f6e 7365  trument response
+000018c0: 7320 7769 7468 2073 656c 6563 7465 6420  s with selected 
+000018d0: 6d65 7468 6f64 7320 696e 636c 7564 696e  methods includin
+000018e0: 673a 0a20 2020 2020 2020 2020 2020 2022  g:.            "
+000018f0: 696e 7622 2020 202d 3e20 7573 696e 6720  inv"   -> using 
+00001900: 696e 7665 6e74 6f72 7920 696e 666f 726d  inventory inform
+00001910: 6174 696f 6e20 746f 2072 656d 6f76 655f  ation to remove_
+00001920: 7265 7370 6f6e 7365 3b0a 2020 2020 2020  response;.      
+00001930: 2020 2020 2020 2273 7065 6374 7275 6d22        "spectrum"
+00001940: 2020 202d 3e20 7573 6520 7468 6520 696e     -> use the in
+00001950: 7665 7273 6520 6f66 2072 6573 706f 6e73  verse of respons
+00001960: 6520 7370 6563 7472 756d 2e0a 2020 2020  e spectrum..    
+00001970: 2020 2020 2020 2020 2861 2073 6372 6970          (a scrip
+00001980: 7420 6973 2070 726f 7669 6465 6420 696e  t is provided in
+00001990: 2061 6464 6974 696f 6e61 6c5f 6d6f 6475   additional_modu
+000019a0: 6c65 2074 6f20 6573 7469 6d61 7465 2072  le to estimate r
+000019b0: 6573 706f 6e73 6520 7370 6563 7472 756d  esponse spectrum
+000019c0: 2066 726f 6d20 5245 5350 2066 696c 6573   from RESP files
+000019d0: 290a 2020 2020 2020 2020 2020 2020 2252  ).            "R
+000019e0: 4553 505f 6669 6c65 7322 202d 3e20 7573  ESP_files" -> us
+000019f0: 6520 7468 6520 7261 7720 646f 776e 6c6f  e the raw downlo
+00001a00: 6164 2052 4553 5020 6669 6c65 730a 2020  ad RESP files.  
+00001a10: 2020 2020 2020 2020 2020 2270 6f6c 657a            "polez
+00001a20: 6572 6f73 2220 202d 3e20 7573 6520 706f  eros"  -> use po
+00001a30: 6c65 2f7a 6572 6f20 696e 666f 2066 6f72  le/zero info for
+00001a40: 2061 2063 7275 6465 2063 6f72 7265 6374   a crude correct
+00001a50: 696f 6e20 6f66 2072 6573 706f 6e73 650a  ion of response.
+00001a60: 2020 2020 2020 2020 3529 2074 7269 6d20          5) trim 
+00001a70: 6461 7461 2074 6f20 6120 6461 792d 6c6f  data to a day-lo
+00001a80: 6e67 2073 6571 7565 6e63 6520 616e 6420  ng sequence and 
+00001a90: 696e 7465 7270 6f6c 6174 6520 6974 2074  interpolate it t
+00001aa0: 6f20 656e 7375 7265 2073 7461 7274 696e  o ensure startin
+00001ab0: 6720 6174 2030 303a 3030 3a30 302e 3030  g at 00:00:00.00
+00001ac0: 300a 2020 2020 2875 7365 6420 696e 2053  0.    (used in S
+00001ad0: 3041 2026 2053 3042 290a 2020 2020 5041  0A & S0B).    PA
+00001ae0: 5241 4d45 5445 5253 3a0a 2020 2020 2d2d  RAMETERS:.    --
+00001af0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001b00: 2d2d 2d2d 2d0a 2020 2020 7374 3a20 206f  -----.    st:  o
+00001b10: 6273 7079 2073 7472 6561 6d20 6f62 6a65  bspy stream obje
+00001b20: 6374 2c20 636f 6e74 6169 6e69 6e67 206e  ct, containing n
+00001b30: 6f69 7365 2064 6174 6120 746f 2062 6520  oise data to be 
+00001b40: 7072 6f63 6573 7365 640a 2020 2020 696e  processed.    in
+00001b50: 763a 206f 6273 7079 2069 6e76 656e 746f  v: obspy invento
+00001b60: 7279 206f 626a 6563 742c 2063 6f6e 7461  ry object, conta
+00001b70: 696e 696e 6720 7374 6174 696f 6e73 2069  ining stations i
+00001b80: 6e66 6f0a 2020 2020 7072 6570 726f 5f70  nfo.    prepro_p
+00001b90: 6172 613a 2064 6963 7420 636f 6e74 6169  ara: dict contai
+00001ba0: 6e69 6e67 2066 6674 2070 6172 616d 6574  ning fft paramet
+00001bb0: 6572 732c 2073 7563 6820 6173 2066 7265  ers, such as fre
+00001bc0: 7175 656e 6379 2062 616e 6473 2061 6e64  quency bands and
+00001bd0: 0a20 2020 2073 656c 6563 7469 6f6e 2066  .    selection f
+00001be0: 6f72 2069 6e73 7472 756d 656e 7420 7265  or instrument re
+00001bf0: 7370 6f6e 7365 2072 656d 6f76 616c 2065  sponse removal e
+00001c00: 7463 2e0a 2020 2020 6461 7465 5f69 6e66  tc..    date_inf
+00001c10: 6f3a 2020 2064 6963 7420 6f66 2073 7461  o:   dict of sta
+00001c20: 7274 2061 6e64 2065 6e64 2074 696d 6520  rt and end time 
+00001c30: 6f66 2074 6865 2073 7472 6561 6d20 6461  of the stream da
+00001c40: 7461 0a20 2020 2052 4554 5552 4e53 3a0a  ta.    RETURNS:.
+00001c50: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
+00001c60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
+00001c70: 6e74 723a 206f 6273 7079 2073 7472 6561  ntr: obspy strea
+00001c80: 6d20 6f62 6a65 6374 206f 6620 636c 6561  m object of clea
+00001c90: 6e65 642c 206d 6572 6765 6420 616e 6420  ned, merged and 
+00001ca0: 6669 6c74 6572 6564 206e 6f69 7365 2064  filtered noise d
+00001cb0: 6174 610a 2020 2020 2222 220a 2020 2020  ata.    """.    
+00001cc0: 2320 6c6f 6164 2070 6172 616d 7465 7273  # load paramters
+00001cd0: 2066 726f 6d20 6666 7420 6469 6374 0a20   from fft dict. 
+00001ce0: 2020 2072 6d5f 7265 7370 203d 2070 7265     rm_resp = pre
+00001cf0: 7072 6f5f 7061 7261 5b22 726d 5f72 6573  pro_para["rm_res
+00001d00: 7022 5d0a 2020 2020 726d 5f72 6573 705f  p"].    rm_resp_
+00001d10: 6f75 7420 3d20 7072 6570 726f 5f70 6172  out = prepro_par
+00001d20: 615b 2272 6d5f 7265 7370 5f6f 7574 225d  a["rm_resp_out"]
+00001d30: 0a20 2020 2072 6573 7064 6972 203d 2070  .    respdir = p
+00001d40: 7265 7072 6f5f 7061 7261 5b22 7265 7370  repro_para["resp
+00001d50: 6469 7222 5d0a 2020 2020 6672 6571 6d69  dir"].    freqmi
+00001d60: 6e20 3d20 7072 6570 726f 5f70 6172 615b  n = prepro_para[
+00001d70: 2266 7265 716d 696e 225d 0a20 2020 2066  "freqmin"].    f
+00001d80: 7265 716d 6178 203d 2070 7265 7072 6f5f  reqmax = prepro_
+00001d90: 7061 7261 5b22 6672 6571 6d61 7822 5d0a  para["freqmax"].
+00001da0: 2020 2020 7361 6d70 5f66 7265 7120 3d20      samp_freq = 
+00001db0: 7072 6570 726f 5f70 6172 615b 2273 616d  prepro_para["sam
+00001dc0: 705f 6672 6571 225d 0a0a 2020 2020 2320  p_freq"]..    # 
+00001dd0: 7061 7261 6d65 7465 7273 2066 6f72 2062  parameters for b
+00001de0: 7574 7465 7277 6f72 7468 2066 696c 7465  utterworth filte
+00001df0: 720a 2020 2020 6631 203d 2030 2e39 202a  r.    f1 = 0.9 *
+00001e00: 2066 7265 716d 696e 0a20 2020 2066 3220   freqmin.    f2 
+00001e10: 3d20 6672 6571 6d69 6e0a 2020 2020 6966  = freqmin.    if
+00001e20: 2031 2e31 202a 2066 7265 716d 6178 203e   1.1 * freqmax >
+00001e30: 2030 2e34 3520 2a20 7361 6d70 5f66 7265   0.45 * samp_fre
+00001e40: 713a 0a20 2020 2020 2020 2066 3320 3d20  q:.        f3 = 
+00001e50: 302e 3420 2a20 7361 6d70 5f66 7265 710a  0.4 * samp_freq.
+00001e60: 2020 2020 2020 2020 6634 203d 2030 2e34          f4 = 0.4
+00001e70: 3520 2a20 7361 6d70 5f66 7265 710a 2020  5 * samp_freq.  
+00001e80: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00001e90: 6633 203d 2066 7265 716d 6178 0a20 2020  f3 = freqmax.   
+00001ea0: 2020 2020 2066 3420 3d20 312e 3120 2a20       f4 = 1.1 * 
+00001eb0: 6672 6571 6d61 780a 2020 2020 7072 655f  freqmax.    pre_
+00001ec0: 6669 6c74 203d 205b 6631 2c20 6632 2c20  filt = [f1, f2, 
+00001ed0: 6633 2c20 6634 5d0a 0a20 2020 2023 2063  f3, f4]..    # c
+00001ee0: 6865 636b 2073 616d 706c 696e 6720 7261  heck sampling ra
+00001ef0: 7465 2061 6e64 2074 7261 6365 206c 656e  te and trace len
+00001f00: 6774 680a 2020 2020 7374 203d 2063 6865  gth.    st = che
+00001f10: 636b 5f73 616d 706c 655f 6761 7073 2873  ck_sample_gaps(s
+00001f20: 742c 2073 7461 7274 7469 6d65 2c20 656e  t, starttime, en
+00001f30: 6474 696d 6529 0a20 2020 2069 6620 6c65  dtime).    if le
+00001f40: 6e28 7374 2920 3d3d 2030 3a0a 2020 2020  n(st) == 0:.    
+00001f50: 2020 2020 7072 696e 7428 224e 6f20 7472      print("No tr
+00001f60: 6163 6573 2069 6e20 5374 7265 616d 3a20  aces in Stream: 
+00001f70: 436f 6e74 696e 7565 2122 290a 2020 2020  Continue!").    
+00001f80: 2020 2020 7265 7475 726e 2073 740a 2020      return st.  
+00001f90: 2020 7370 7320 3d20 696e 7428 7374 5b30    sps = int(st[0
+00001fa0: 5d2e 7374 6174 732e 7361 6d70 6c69 6e67  ].stats.sampling
+00001fb0: 5f72 6174 6529 0a20 2020 2073 7461 7469  _rate).    stati
+00001fc0: 6f6e 203d 2073 745b 305d 2e73 7461 7473  on = st[0].stats
+00001fd0: 2e73 7461 7469 6f6e 0a0a 2020 2020 2320  .station..    # 
+00001fe0: 7265 6d6f 7665 206e 616e 2f69 6e66 2c20  remove nan/inf, 
+00001ff0: 6d65 616e 2061 6e64 2074 7265 6e64 206f  mean and trend o
+00002000: 6620 6561 6368 2074 7261 6365 2062 6566  f each trace bef
+00002010: 6f72 6520 6d65 7267 696e 670a 2020 2020  ore merging.    
+00002020: 666f 7220 6969 2069 6e20 7261 6e67 6528  for ii in range(
+00002030: 6c65 6e28 7374 2929 3a0a 2020 2020 2020  len(st)):.      
+00002040: 2020 2320 2d2d 2d2d 2d73 6574 206e 616e    # -----set nan
+00002050: 2f69 6e66 2076 616c 7565 7320 746f 207a  /inf values to z
+00002060: 6572 6f73 2028 6974 2064 6f65 7320 6861  eros (it does ha
+00002070: 7070 656e 7321 292d 2d2d 2d2d 0a20 2020  ppens!)-----.   
+00002080: 2020 2020 2074 7474 696e 6478 203d 206e       tttindx = n
+00002090: 702e 7768 6572 6528 6e70 2e69 736e 616e  p.where(np.isnan
+000020a0: 2873 745b 6969 5d2e 6461 7461 2929 0a20  (st[ii].data)). 
+000020b0: 2020 2020 2020 2069 6620 6c65 6e28 7474         if len(tt
+000020c0: 7469 6e64 7829 203e 2030 3a0a 2020 2020  tindx) > 0:.    
+000020d0: 2020 2020 2020 2020 7374 5b69 695d 2e64          st[ii].d
+000020e0: 6174 615b 7474 7469 6e64 785d 203d 2030  ata[tttindx] = 0
+000020f0: 0a20 2020 2020 2020 2074 7474 696e 6478  .        tttindx
+00002100: 203d 206e 702e 7768 6572 6528 6e70 2e69   = np.where(np.i
+00002110: 7369 6e66 2873 745b 6969 5d2e 6461 7461  sinf(st[ii].data
+00002120: 2929 0a20 2020 2020 2020 2069 6620 6c65  )).        if le
+00002130: 6e28 7474 7469 6e64 7829 203e 2030 3a0a  n(tttindx) > 0:.
+00002140: 2020 2020 2020 2020 2020 2020 7374 5b69              st[i
+00002150: 695d 2e64 6174 615b 7474 7469 6e64 785d  i].data[tttindx]
+00002160: 203d 2030 0a0a 2020 2020 2020 2020 7374   = 0..        st
+00002170: 5b69 695d 2e64 6174 6120 3d20 6e70 2e66  [ii].data = np.f
+00002180: 6c6f 6174 3332 2873 745b 6969 5d2e 6461  loat32(st[ii].da
+00002190: 7461 290a 2020 2020 2020 2020 7374 5b69  ta).        st[i
+000021a0: 695d 2e64 6174 6120 3d20 7363 6970 792e  i].data = scipy.
+000021b0: 7369 676e 616c 2e64 6574 7265 6e64 2873  signal.detrend(s
+000021c0: 745b 6969 5d2e 6461 7461 2c20 7479 7065  t[ii].data, type
+000021d0: 3d22 636f 6e73 7461 6e74 2229 0a20 2020  ="constant").   
+000021e0: 2020 2020 2073 745b 6969 5d2e 6461 7461       st[ii].data
+000021f0: 203d 2073 6369 7079 2e73 6967 6e61 6c2e   = scipy.signal.
+00002200: 6465 7472 656e 6428 7374 5b69 695d 2e64  detrend(st[ii].d
+00002210: 6174 612c 2074 7970 653d 226c 696e 6561  ata, type="linea
+00002220: 7222 290a 0a20 2020 2023 206d 6572 6765  r")..    # merge
+00002230: 2c20 7461 7065 7220 616e 6420 6669 6c74  , taper and filt
+00002240: 6572 2074 6865 2064 6174 610a 2020 2020  er the data.    
+00002250: 6966 206c 656e 2873 7429 203e 2031 3a0a  if len(st) > 1:.
+00002260: 2020 2020 2020 2020 7374 2e6d 6572 6765          st.merge
+00002270: 286d 6574 686f 643d 312c 2066 696c 6c5f  (method=1, fill_
+00002280: 7661 6c75 653d 3029 0a20 2020 2073 745b  value=0).    st[
+00002290: 305d 2e74 6170 6572 286d 6178 5f70 6572  0].taper(max_per
+000022a0: 6365 6e74 6167 653d 302e 3035 2c20 6d61  centage=0.05, ma
+000022b0: 785f 6c65 6e67 7468 3d35 3029 2020 2320  x_length=50)  # 
+000022c0: 7461 7065 7220 7769 6e64 6f77 0a20 2020  taper window.   
+000022d0: 2073 745b 305d 2e64 6174 6120 3d20 6e70   st[0].data = np
+000022e0: 2e66 6c6f 6174 3332 2862 616e 6470 6173  .float32(bandpas
+000022f0: 7328 7374 5b30 5d2e 6461 7461 2c20 7072  s(st[0].data, pr
+00002300: 655f 6669 6c74 5b30 5d2c 2070 7265 5f66  e_filt[0], pre_f
+00002310: 696c 745b 2d31 5d2c 2064 663d 7370 732c  ilt[-1], df=sps,
+00002320: 2063 6f72 6e65 7273 3d34 2c20 7a65 726f   corners=4, zero
+00002330: 7068 6173 653d 5472 7565 2929 0a0a 2020  phase=True))..  
+00002340: 2020 2320 6d61 6b65 2064 6f77 6e73 616d    # make downsam
+00002350: 706c 696e 6720 6966 206e 6565 6465 640a  pling if needed.
+00002360: 2020 2020 6966 2061 6273 2873 616d 705f      if abs(samp_
+00002370: 6672 6571 202d 2073 7073 2920 3e20 3165  freq - sps) > 1e
+00002380: 2d34 3a0a 2020 2020 2020 2020 2320 646f  -4:.        # do
+00002390: 776e 7361 6d70 6c69 6e67 2068 6572 650a  wnsampling here.
+000023a0: 2020 2020 2020 2020 7374 2e69 6e74 6572          st.inter
+000023b0: 706f 6c61 7465 2873 616d 705f 6672 6571  polate(samp_freq
+000023c0: 2c20 6d65 7468 6f64 3d22 7765 6967 6874  , method="weight
+000023d0: 6564 5f61 7665 7261 6765 5f73 6c6f 7065  ed_average_slope
+000023e0: 7322 290a 2020 2020 2020 2020 6465 6c74  s").        delt
+000023f0: 6120 3d20 7374 5b30 5d2e 7374 6174 732e  a = st[0].stats.
+00002400: 6465 6c74 610a 0a20 2020 2020 2020 2023  delta..        #
+00002410: 2077 6865 6e20 7374 6172 7474 696d 6573   when starttimes
+00002420: 2061 7265 2062 6574 7765 656e 2073 616d   are between sam
+00002430: 706c 696e 6720 706f 696e 7473 0a20 2020  pling points.   
+00002440: 2020 2020 2066 7269 6320 3d20 7374 5b30       fric = st[0
+00002450: 5d2e 7374 6174 732e 7374 6172 7474 696d  ].stats.starttim
+00002460: 652e 6d69 6372 6f73 6563 6f6e 6420 2520  e.microsecond % 
+00002470: 2864 656c 7461 202a 2031 6536 290a 2020  (delta * 1e6).  
+00002480: 2020 2020 2020 6966 2066 7269 6320 3e20        if fric > 
+00002490: 3165 2d34 3a0a 2020 2020 2020 2020 2020  1e-4:.          
+000024a0: 2020 7374 5b30 5d2e 6461 7461 203d 2073    st[0].data = s
+000024b0: 6567 6d65 6e74 5f69 6e74 6572 706f 6c61  egment_interpola
+000024c0: 7465 286e 702e 666c 6f61 7433 3228 7374  te(np.float32(st
+000024d0: 5b30 5d2e 6461 7461 292c 2066 6c6f 6174  [0].data), float
+000024e0: 2866 7269 6320 2f20 2864 656c 7461 202a  (fric / (delta *
+000024f0: 2031 6536 2929 290a 2020 2020 2020 2020   1e6))).        
+00002500: 2020 2020 2320 2d2d 7265 7365 7420 7468      # --reset th
+00002510: 6520 7469 6d65 2074 6f20 7265 6d6f 7665  e time to remove
+00002520: 2074 6865 2064 6973 6372 6570 616e 6379   the discrepancy
+00002530: 2d2d 2d0a 2020 2020 2020 2020 2020 2020  ---.            
+00002540: 7374 5b30 5d2e 7374 6174 732e 7374 6172  st[0].stats.star
+00002550: 7474 696d 6520 2d3d 2066 7269 6320 2a20  ttime -= fric * 
+00002560: 3165 2d36 0a0a 2020 2020 2320 7265 6d6f  1e-6..    # remo
+00002570: 7665 2074 7261 6365 7320 6f66 2074 6f6f  ve traces of too
+00002580: 2073 6d61 6c6c 206c 656e 6774 680a 0a20   small length.. 
+00002590: 2020 2023 206f 7074 696f 6e73 2074 6f20     # options to 
+000025a0: 7265 6d6f 7665 2069 6e73 7472 756d 656e  remove instrumen
+000025b0: 7420 7265 7370 6f6e 7365 0a20 2020 2069  t response.    i
+000025c0: 6620 726d 5f72 6573 7020 213d 2022 6e6f  f rm_resp != "no
+000025d0: 223a 0a20 2020 2020 2020 2069 6620 726d  ":.        if rm
+000025e0: 5f72 6573 7020 213d 2022 696e 7622 3a0a  _resp != "inv":.
+000025f0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00002600: 7265 7370 6469 7220 6973 204e 6f6e 6529  respdir is None)
+00002610: 206f 7220 286e 6f74 206f 732e 7061 7468   or (not os.path
+00002620: 2e69 7364 6972 2872 6573 7064 6972 2929  .isdir(respdir))
+00002630: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00002640: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00002650: 6f72 2822 7265 7370 6f6e 7365 2066 696c  or("response fil
+00002660: 6520 666f 6c64 6572 206e 6f74 2066 6f75  e folder not fou
+00002670: 6e64 2120 6162 6f72 7421 2229 0a0a 2020  nd! abort!")..  
+00002680: 2020 2020 2020 6966 2072 6d5f 7265 7370        if rm_resp
+00002690: 203d 3d20 2269 6e76 223a 0a20 2020 2020   == "inv":.     
+000026a0: 2020 2020 2020 2023 202d 2d2d 2d63 6865         # ----che
+000026b0: 636b 2077 6865 7468 6572 2069 6e76 656e  ck whether inven
+000026c0: 746f 7279 2069 7320 6174 7461 6368 6564  tory is attached
+000026d0: 2d2d 2d2d 0a20 2020 2020 2020 2020 2020  ----.           
+000026e0: 2069 6620 6e6f 7420 696e 765b 305d 5b30   if not inv[0][0
+000026f0: 5d5b 305d 2e72 6573 706f 6e73 653a 0a20  ][0].response:. 
+00002700: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00002710: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00002720: 226e 6f20 7265 7370 6f6e 7365 2066 6f75  "no response fou
+00002730: 6e64 2069 6e20 7468 6520 696e 7665 6e74  nd in the invent
+00002740: 6f72 7921 2061 626f 7274 2122 290a 2020  ory! abort!").  
+00002750: 2020 2020 2020 2020 2020 656c 6966 2069            elif i
+00002760: 6e76 5b30 5d5b 305d 5b30 5d2e 7265 7370  nv[0][0][0].resp
+00002770: 6f6e 7365 203d 3d20 6f62 7370 792e 636f  onse == obspy.co
+00002780: 7265 2e69 6e76 656e 746f 7279 2e72 6573  re.inventory.res
+00002790: 706f 6e73 652e 5265 7370 6f6e 7365 2829  ponse.Response()
+000027a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000027b0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+000027c0: 6f72 2822 5468 6520 7265 7370 6f6e 7365  or("The response
+000027d0: 2066 6f75 6e64 2069 6e20 7468 6520 696e   found in the in
+000027e0: 7665 6e74 6f72 7920 6973 2065 6d70 7479  ventory is empty
+000027f0: 2028 6e6f 2073 7461 6765 7329 2120 6162   (no stages)! ab
+00002800: 6f72 7421 2229 0a20 2020 2020 2020 2020  ort!").         
+00002810: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00002820: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00002830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002840: 2020 7072 696e 7428 2272 656d 6f76 696e    print("removin
+00002850: 6720 7265 7370 6f6e 7365 2066 6f72 2025  g response for %
+00002860: 7320 7573 696e 6720 696e 7622 2025 2073  s using inv" % s
+00002870: 745b 305d 290a 2020 2020 2020 2020 2020  t[0]).          
+00002880: 2020 2020 2020 2020 2020 7374 5b30 5d2e            st[0].
+00002890: 6174 7461 6368 5f72 6573 706f 6e73 6528  attach_response(
+000028a0: 696e 7629 0a20 2020 2020 2020 2020 2020  inv).           
+000028b0: 2020 2020 2020 2020 2073 745b 305d 2e72           st[0].r
+000028c0: 656d 6f76 655f 7265 7370 6f6e 7365 286f  emove_response(o
+000028d0: 7574 7075 743d 726d 5f72 6573 705f 6f75  utput=rm_resp_ou
+000028e0: 742c 2070 7265 5f66 696c 743d 7072 655f  t, pre_filt=pre_
+000028f0: 6669 6c74 2c20 7761 7465 725f 6c65 7665  filt, water_leve
+00002900: 6c3d 3630 290a 2020 2020 2020 2020 2020  l=60).          
+00002910: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+00002920: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+00002930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002940: 2070 7269 6e74 2822 5741 524e 494e 473a   print("WARNING:
+00002950: 2046 6169 6c65 6420 746f 2072 656d 6f76   Failed to remov
+00002960: 6520 7265 7370 6f6e 7365 2066 726f 6d20  e response from 
+00002970: 2573 2e20 5265 7475 726e 696e 6720 656d  %s. Returning em
+00002980: 7074 7920 7374 7265 616d 2e20 2573 2220  pty stream. %s" 
+00002990: 2520 2873 745b 305d 2c20 6529 290a 2020  % (st[0], e)).  
+000029a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000029b0: 2020 7374 203d 205b 5d0a 2020 2020 2020    st = [].      
+000029c0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000029d0: 7475 726e 2073 740a 0a20 2020 2020 2020  turn st..       
+000029e0: 2065 6c69 6620 726d 5f72 6573 7020 3d3d   elif rm_resp ==
+000029f0: 2022 7370 6563 7472 756d 223a 0a20 2020   "spectrum":.   
+00002a00: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
+00002a10: 7265 6d6f 7665 2072 6573 706f 6e73 6520  remove response 
+00002a20: 7573 696e 6720 7370 6563 7472 756d 2229  using spectrum")
+00002a30: 0a20 2020 2020 2020 2020 2020 2073 7065  .            spe
+00002a40: 6366 696c 6520 3d20 676c 6f62 2e67 6c6f  cfile = glob.glo
+00002a50: 6228 6f73 2e70 6174 682e 6a6f 696e 2872  b(os.path.join(r
+00002a60: 6573 7064 6972 2c20 222a 2220 2b20 7374  espdir, "*" + st
+00002a70: 6174 696f 6e20 2b20 222a 2229 290a 2020  ation + "*")).  
+00002a80: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+00002a90: 2873 7065 6366 696c 6529 203d 3d20 303a  (specfile) == 0:
+00002aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002ab0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00002ac0: 7228 226e 6f20 7265 7370 6f6e 7365 2073  r("no response s
+00002ad0: 6570 6374 7275 6d20 666f 756e 6420 666f  epctrum found fo
+00002ae0: 7220 2573 2220 2520 7374 6174 696f 6e29  r %s" % station)
+00002af0: 0a20 2020 2020 2020 2020 2020 2073 7420  .            st 
+00002b00: 3d20 7265 7370 5f73 7065 6374 7275 6d28  = resp_spectrum(
+00002b10: 7374 2c20 7370 6563 6669 6c65 5b30 5d2c  st, specfile[0],
+00002b20: 2073 616d 705f 6672 6571 2c20 7072 655f   samp_freq, pre_
+00002b30: 6669 6c74 290a 0a20 2020 2020 2020 2065  filt)..        e
+00002b40: 6c69 6620 726d 5f72 6573 7020 3d3d 2022  lif rm_resp == "
+00002b50: 5245 5350 223a 0a20 2020 2020 2020 2020  RESP":.         
+00002b60: 2020 2070 7269 6e74 2822 7265 6d6f 7665     print("remove
+00002b70: 2072 6573 706f 6e73 6520 7573 696e 6720   response using 
+00002b80: 5245 5350 2066 696c 6573 2229 0a20 2020  RESP files").   
+00002b90: 2020 2020 2020 2020 2072 6573 7020 3d20           resp = 
+00002ba0: 676c 6f62 2e67 6c6f 6228 6f73 2e70 6174  glob.glob(os.pat
+00002bb0: 682e 6a6f 696e 2872 6573 7064 6972 2c20  h.join(respdir, 
+00002bc0: 2252 4553 502e 2220 2b20 7374 6174 696f  "RESP." + statio
+00002bd0: 6e20 2b20 222a 2229 290a 2020 2020 2020  n + "*")).      
+00002be0: 2020 2020 2020 6966 206c 656e 2872 6573        if len(res
+00002bf0: 7029 203d 3d20 303a 0a20 2020 2020 2020  p) == 0:.       
+00002c00: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00002c10: 616c 7565 4572 726f 7228 226e 6f20 5245  alueError("no RE
+00002c20: 5350 2066 696c 6573 2066 6f75 6e64 2066  SP files found f
+00002c30: 6f72 2025 7322 2025 2073 7461 7469 6f6e  or %s" % station
+00002c40: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+00002c50: 6564 7265 7370 203d 207b 0a20 2020 2020  edresp = {.     
+00002c60: 2020 2020 2020 2020 2020 2022 6669 6c65             "file
+00002c70: 6e61 6d65 223a 2072 6573 705b 305d 2c0a  name": resp[0],.
+00002c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002c90: 2264 6174 6522 3a20 7374 6172 7474 696d  "date": starttim
+00002ca0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00002cb0: 2020 2022 756e 6974 7322 3a20 2244 4953     "units": "DIS
+00002cc0: 222c 0a20 2020 2020 2020 2020 2020 207d  ",.            }
+00002cd0: 0a20 2020 2020 2020 2020 2020 2073 742e  .            st.
+00002ce0: 7369 6d75 6c61 7465 2870 617a 5f72 656d  simulate(paz_rem
+00002cf0: 6f76 653d 4e6f 6e65 2c20 7072 655f 6669  ove=None, pre_fi
+00002d00: 6c74 3d70 7265 5f66 696c 742c 2073 6565  lt=pre_filt, see
+00002d10: 6472 6573 703d 7365 6564 7265 7370 290a  dresp=seedresp).
+00002d20: 0a20 2020 2020 2020 2065 6c69 6620 726d  .        elif rm
+00002d30: 5f72 6573 7020 3d3d 2022 706f 6c6f 7a65  _resp == "poloze
+00002d40: 726f 7322 3a0a 2020 2020 2020 2020 2020  ros":.          
+00002d50: 2020 7072 696e 7428 2272 656d 6f76 6520    print("remove 
+00002d60: 7265 7370 6f6e 7365 2075 7369 6e67 2070  response using p
+00002d70: 6f6c 6f73 2061 6e64 207a 6572 6f73 2229  olos and zeros")
+00002d80: 0a20 2020 2020 2020 2020 2020 2070 617a  .            paz
+00002d90: 5f73 7473 203d 2067 6c6f 622e 676c 6f62  _sts = glob.glob
+00002da0: 286f 732e 7061 7468 2e6a 6f69 6e28 7265  (os.path.join(re
+00002db0: 7370 6469 722c 2022 2a22 202b 2073 7461  spdir, "*" + sta
+00002dc0: 7469 6f6e 202b 2022 2a22 2929 0a20 2020  tion + "*")).   
+00002dd0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+00002de0: 7061 7a5f 7374 7329 203d 3d20 303a 0a20  paz_sts) == 0:. 
+00002df0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00002e00: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00002e10: 226e 6f20 706f 6c6f 7a65 726f 7320 666f  "no polozeros fo
+00002e20: 756e 6420 666f 7220 2573 2220 2520 7374  und for %s" % st
+00002e30: 6174 696f 6e29 0a20 2020 2020 2020 2020  ation).         
+00002e40: 2020 2073 742e 7369 6d75 6c61 7465 2870     st.simulate(p
+00002e50: 617a 5f72 656d 6f76 653d 7061 7a5f 7374  az_remove=paz_st
+00002e60: 735b 305d 2c20 7072 655f 6669 6c74 3d70  s[0], pre_filt=p
+00002e70: 7265 5f66 696c 7429 0a0a 2020 2020 2020  re_filt)..      
+00002e80: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00002e90: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00002ea0: 7272 6f72 2822 6e6f 2073 7563 6820 6f70  rror("no such op
+00002eb0: 7469 6f6e 2066 6f72 2072 6d5f 7265 7370  tion for rm_resp
+00002ec0: 2120 706c 6561 7365 2064 6f75 626c 6520  ! please double 
+00002ed0: 6368 6563 6b21 2229 0a0a 2020 2020 6e74  check!")..    nt
+00002ee0: 7220 3d20 6f62 7370 792e 5374 7265 616d  r = obspy.Stream
+00002ef0: 2829 0a20 2020 2023 2074 7269 6d20 6120  ().    # trim a 
+00002f00: 636f 6e74 696e 6f75 7320 7365 676d 656e  continous segmen
+00002f10: 7420 696e 746f 2075 7365 722d 6465 6669  t into user-defi
+00002f20: 6e65 6420 7365 7175 656e 6365 730a 2020  ned sequences.  
+00002f30: 2020 7374 5b30 5d2e 7472 696d 280a 2020    st[0].trim(.  
+00002f40: 2020 2020 2020 7374 6172 7474 696d 653d        starttime=
+00002f50: 7374 6172 7474 696d 652c 0a20 2020 2020  starttime,.     
+00002f60: 2020 2065 6e64 7469 6d65 3d65 6e64 7469     endtime=endti
+00002f70: 6d65 2c0a 2020 2020 2020 2020 7061 643d  me,.        pad=
+00002f80: 5472 7565 2c0a 2020 2020 2020 2020 6669  True,.        fi
+00002f90: 6c6c 5f76 616c 7565 3d30 2c0a 2020 2020  ll_value=0,.    
+00002fa0: 290a 2020 2020 6e74 722e 6170 7065 6e64  ).    ntr.append
+00002fb0: 2873 745b 305d 290a 0a20 2020 2072 6574  (st[0])..    ret
+00002fc0: 7572 6e20 6e74 720a 0a0a 6465 6620 7374  urn ntr...def st
+00002fd0: 6174 7332 696e 7628 7374 6174 732c 2070  ats2inv(stats, p
+00002fe0: 7265 7072 6f5f 7061 7261 2c20 6c6f 6373  repro_para, locs
+00002ff0: 3d4e 6f6e 6529 3a0a 2020 2020 2222 220a  =None):.    """.
+00003000: 2020 2020 7468 6973 2066 756e 6374 696f      this functio
+00003010: 6e20 6372 6561 7465 7320 696e 7665 6e74  n creates invent
+00003020: 6f72 7920 6769 7665 6e20 7468 6520 7374  ory given the st
+00003030: 6174 7320 7061 7261 6d65 7465 7273 2069  ats parameters i
+00003040: 6e20 616e 206f 6273 7079 2073 7472 6561  n an obspy strea
+00003050: 6d20 6f72 2061 2073 7461 7469 6f6e 206c  m or a station l
+00003060: 6973 742e 0a20 2020 2028 7573 6564 2069  ist..    (used i
+00003070: 6e20 5330 4229 0a20 2020 2050 4152 414d  n S0B).    PARAM
+00003080: 4554 4552 533a 0a20 2020 202d 2d2d 2d2d  ETERS:.    -----
+00003090: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000030a0: 2d2d 2d0a 2020 2020 7374 6174 733a 206f  ---.    stats: o
+000030b0: 6273 7079 2074 7261 6365 2073 7461 7473  bspy trace stats
+000030c0: 206f 626a 6563 7420 636f 6e74 6169 6e69   object containi
+000030d0: 6e67 2061 6c6c 2073 7461 7469 6f6e 2068  ng all station h
+000030e0: 6561 6465 7220 696e 666f 0a20 2020 2070  eader info.    p
+000030f0: 7265 7072 6f5f 7061 7261 3a20 6469 6374  repro_para: dict
+00003100: 2063 6f6e 7461 696e 696e 6720 6666 7420   containing fft 
+00003110: 7061 7261 6d65 7465 7273 2c20 7375 6368  parameters, such
+00003120: 2061 7320 6672 6571 7565 6e63 7920 6261   as frequency ba
+00003130: 6e64 7320 616e 6420 7365 6c65 6374 696f  nds and selectio
+00003140: 6e20 666f 7220 696e 7374 7275 6d65 6e74  n for instrument
+00003150: 0a20 2020 2072 6573 706f 6e73 6520 7265  .    response re
+00003160: 6d6f 7661 6c20 6574 632e 0a20 2020 206c  moval etc..    l
+00003170: 6f63 733a 2020 7061 6e64 6120 6461 7461  ocs:  panda data
+00003180: 2066 7261 6d65 206f 6620 7468 6520 7374   frame of the st
+00003190: 6174 696f 6e20 6c69 7374 2e20 6974 2069  ation list. it i
+000031a0: 7320 6e65 6564 6564 2066 6f72 2063 6f6e  s needed for con
+000031b0: 7665 7269 6e67 206d 696e 6973 6565 6420  vering miniseed 
+000031c0: 6669 6c65 7320 696e 746f 2041 5344 460a  files into ASDF.
+000031d0: 2020 2020 5245 5455 524e 533a 0a20 2020      RETURNS:.   
+000031e0: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
+000031f0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 696e  ---------.    in
+00003200: 763a 206f 6273 7079 2069 6e76 656e 746f  v: obspy invento
+00003210: 7279 206f 626a 6563 7420 6f66 2061 6c6c  ry object of all
+00003220: 2073 7461 7469 6f6e 2069 6e66 6f20 746f   station info to
+00003230: 2062 6520 7573 6564 206c 6174 6572 0a20   be used later. 
+00003240: 2020 2022 2222 0a20 2020 2073 7461 786d     """.    staxm
+00003250: 6c20 3d20 7072 6570 726f 5f70 6172 615b  l = prepro_para[
+00003260: 2273 7461 7469 6f6e 786d 6c22 5d0a 2020  "stationxml"].  
+00003270: 2020 7265 7370 6469 7220 3d20 7072 6570    respdir = prep
+00003280: 726f 5f70 6172 615b 2272 6573 7064 6972  ro_para["respdir
+00003290: 225d 0a20 2020 2069 6e70 7574 5f66 6d74  "].    input_fmt
+000032a0: 203d 2070 7265 7072 6f5f 7061 7261 5b22   = prepro_para["
+000032b0: 696e 7075 745f 666d 7422 5d0a 2020 2020  input_fmt"].    
+000032c0: 6966 2073 7461 786d 6c3a 0a20 2020 2020  if staxml:.     
+000032d0: 2020 2072 6574 7572 6e20 7374 6174 7332     return stats2
+000032e0: 496e 765f 7374 6178 6d6c 2873 7461 7473  Inv_staxml(stats
+000032f0: 2c20 7265 7370 6469 7229 0a20 2020 2069  , respdir).    i
+00003300: 6620 696e 7075 745f 666d 7420 3d3d 2022  f input_fmt == "
+00003310: 7361 6322 3a0a 2020 2020 2020 2020 7265  sac":.        re
+00003320: 7475 726e 2073 7461 7473 3269 6e76 5f73  turn stats2inv_s
+00003330: 6163 2873 7461 7473 290a 2020 2020 656c  ac(stats).    el
+00003340: 6966 2069 6e70 7574 5f66 6d74 203d 3d20  if input_fmt == 
+00003350: 226d 7365 6564 223a 0a20 2020 2020 2020  "mseed":.       
+00003360: 2072 6574 7572 6e20 7374 6174 7332 696e   return stats2in
+00003370: 765f 6d73 6565 6428 7374 6174 732c 206c  v_mseed(stats, l
+00003380: 6f63 7329 0a0a 0a64 6566 2073 7461 7473  ocs)...def stats
+00003390: 3249 6e76 5f73 7461 786d 6c28 7374 6174  2Inv_staxml(stat
+000033a0: 732c 2072 6573 7064 6972 2920 2d3e 2049  s, respdir) -> I
+000033b0: 6e76 656e 746f 7279 3a0a 2020 2020 6966  nventory:.    if
+000033c0: 206e 6f74 2072 6573 7064 6972 3a0a 2020   not respdir:.  
+000033d0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+000033e0: 6545 7272 6f72 2822 4162 6f72 7421 2073  eError("Abort! s
+000033f0: 7461 786d 6c20 6973 2073 656c 6563 7465  taxml is selecte
+00003400: 6420 6275 7420 6e6f 2064 6972 6563 746f  d but no directo
+00003410: 7279 2069 7320 6769 7665 6e20 746f 2061  ry is given to a
+00003420: 6363 6573 7320 7468 6520 6669 6c65 7322  ccess the files"
+00003430: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00003440: 2020 2020 696e 7666 696c 656c 6973 7420      invfilelist 
+00003450: 3d20 676c 6f62 2e67 6c6f 6228 6f73 2e70  = glob.glob(os.p
+00003460: 6174 682e 6a6f 696e 2872 6573 7064 6972  ath.join(respdir
+00003470: 2c20 222a 2220 2b20 7374 6174 732e 7374  , "*" + stats.st
+00003480: 6174 696f 6e20 2b20 222a 2229 290a 2020  ation + "*")).  
+00003490: 2020 2020 2020 6966 206c 656e 2869 6e76        if len(inv
+000034a0: 6669 6c65 6c69 7374 2920 3e20 303a 0a20  filelist) > 0:. 
+000034b0: 2020 2020 2020 2020 2020 2069 6e76 6669             invfi
+000034c0: 6c65 203d 2069 6e76 6669 6c65 6c69 7374  le = invfilelist
+000034d0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+000034e0: 6966 206c 656e 2869 6e76 6669 6c65 6c69  if len(invfileli
+000034f0: 7374 2920 3e20 313a 0a20 2020 2020 2020  st) > 1:.       
+00003500: 2020 2020 2020 2020 2070 7269 6e74 280a           print(.
 00003510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003520: 2020 2069 6e76 203d 206f 6273 7079 2e72     inv = obspy.r
-00003530: 6561 645f 696e 7665 6e74 6f72 7928 696e  ead_inventory(in
-00003540: 7666 696c 6529 0a20 2020 2020 2020 2020  vfile).         
-00003550: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00003560: 6e20 696e 760a 2020 2020 2020 2020 2020  n inv.          
-00003570: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00003580: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00003590: 6c75 6545 7272 6f72 2822 436f 756c 6420  lueError("Could 
-000035a0: 6e6f 7420 6669 6e64 2061 2053 7461 7469  not find a Stati
-000035b0: 6f6e 584d 4c20 6669 6c65 2066 6f72 2073  onXML file for s
-000035c0: 7461 7469 6f6e 3a20 2573 2e22 2025 2073  tation: %s." % s
-000035d0: 7461 7473 2e73 7461 7469 6f6e 290a 0a20  tats.station).. 
-000035e0: 2020 2069 6e76 203d 2049 6e76 656e 746f     inv = Invento
-000035f0: 7279 286e 6574 776f 726b 733d 5b5d 2c20  ry(networks=[], 
-00003600: 736f 7572 6365 3d22 686f 6d65 6772 6f77  source="homegrow
-00003610: 6e22 290a 0a20 2020 2069 6620 696e 7075  n")..    if inpu
-00003620: 745f 666d 7420 3d3d 2022 7361 6322 3a0a  t_fmt == "sac":.
-00003630: 2020 2020 2020 2020 6e65 7420 3d20 4e65          net = Ne
-00003640: 7477 6f72 6b28 0a20 2020 2020 2020 2020  twork(.         
-00003650: 2020 2023 2054 6869 7320 6973 2074 6865     # This is the
-00003660: 206e 6574 776f 726b 2063 6f64 6520 6163   network code ac
-00003670: 636f 7264 696e 6720 746f 2074 6865 2053  cording to the S
-00003680: 4545 4420 7374 616e 6461 7264 2e0a 2020  EED standard..  
-00003690: 2020 2020 2020 2020 2020 636f 6465 3d73            code=s
-000036a0: 7461 7473 2e6e 6574 776f 726b 2c0a 2020  tats.network,.  
-000036b0: 2020 2020 2020 2020 2020 7374 6174 696f            statio
-000036c0: 6e73 3d5b 5d2c 0a20 2020 2020 2020 2020  ns=[],.         
-000036d0: 2020 2064 6573 6372 6970 7469 6f6e 3d22     description="
-000036e0: 6372 6561 7465 6420 6672 6f6d 2053 4143  created from SAC
-000036f0: 2061 6e64 2072 6573 7020 6669 6c65 7322   and resp files"
-00003700: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
-00003710: 6172 745f 6461 7465 3d73 7461 7473 2e73  art_date=stats.s
-00003720: 7461 7274 7469 6d65 2c0a 2020 2020 2020  tarttime,.      
-00003730: 2020 290a 0a20 2020 2020 2020 2073 7461    )..        sta
-00003740: 203d 2053 7461 7469 6f6e 280a 2020 2020   = Station(.    
-00003750: 2020 2020 2020 2020 2320 5468 6973 2069          # This i
-00003760: 7320 7468 6520 7374 6174 696f 6e20 636f  s the station co
-00003770: 6465 2061 6363 6f72 6469 6e67 2074 6f20  de according to 
-00003780: 7468 6520 5345 4544 2073 7461 6e64 6172  the SEED standar
-00003790: 642e 0a20 2020 2020 2020 2020 2020 2063  d..            c
-000037a0: 6f64 653d 7374 6174 732e 7374 6174 696f  ode=stats.statio
-000037b0: 6e2c 0a20 2020 2020 2020 2020 2020 206c  n,.            l
-000037c0: 6174 6974 7564 653d 7374 6174 732e 7361  atitude=stats.sa
-000037d0: 635b 2273 746c 6122 5d2c 0a20 2020 2020  c["stla"],.     
-000037e0: 2020 2020 2020 206c 6f6e 6769 7475 6465         longitude
-000037f0: 3d73 7461 7473 2e73 6163 5b22 7374 6c6f  =stats.sac["stlo
-00003800: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-00003810: 656c 6576 6174 696f 6e3d 7374 6174 732e  elevation=stats.
-00003820: 7361 635b 2273 7465 6c22 5d2c 0a20 2020  sac["stel"],.   
-00003830: 2020 2020 2020 2020 2063 7265 6174 696f           creatio
-00003840: 6e5f 6461 7465 3d73 7461 7473 2e73 7461  n_date=stats.sta
-00003850: 7274 7469 6d65 2c0a 2020 2020 2020 2020  rttime,.        
-00003860: 2020 2020 7369 7465 3d53 6974 6528 6e61      site=Site(na
-00003870: 6d65 3d22 4669 7273 7420 7374 6174 696f  me="First statio
-00003880: 6e22 292c 0a20 2020 2020 2020 2029 0a0a  n"),.        )..
-00003890: 2020 2020 2020 2020 6368 6120 3d20 4368          cha = Ch
-000038a0: 616e 6e65 6c28 0a20 2020 2020 2020 2020  annel(.         
-000038b0: 2020 2023 2054 6869 7320 6973 2074 6865     # This is the
-000038c0: 2063 6861 6e6e 656c 2063 6f64 6520 6163   channel code ac
-000038d0: 636f 7264 696e 6720 746f 2074 6865 2053  cording to the S
-000038e0: 4545 4420 7374 616e 6461 7264 2e0a 2020  EED standard..  
-000038f0: 2020 2020 2020 2020 2020 636f 6465 3d73            code=s
-00003900: 7461 7473 2e63 6861 6e6e 656c 2c0a 2020  tats.channel,.  
-00003910: 2020 2020 2020 2020 2020 2320 5468 6973            # This
-00003920: 2069 7320 7468 6520 6c6f 6361 7469 6f6e   is the location
-00003930: 2063 6f64 6520 6163 636f 7264 696e 6720   code according 
-00003940: 746f 2074 6865 2053 4545 4420 7374 616e  to the SEED stan
-00003950: 6461 7264 2e0a 2020 2020 2020 2020 2020  dard..          
-00003960: 2020 6c6f 6361 7469 6f6e 5f63 6f64 653d    location_code=
-00003970: 7374 6174 732e 6c6f 6361 7469 6f6e 2c0a  stats.location,.
-00003980: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
-00003990: 7465 2074 6861 7420 7468 6573 6520 636f  te that these co
-000039a0: 6f72 6469 6e61 7465 7320 6361 6e20 6469  ordinates can di
-000039b0: 6666 6572 2066 726f 6d20 7468 6520 7374  ffer from the st
-000039c0: 6174 696f 6e20 636f 6f72 6469 6e61 7465  ation coordinate
-000039d0: 732e 0a20 2020 2020 2020 2020 2020 206c  s..            l
-000039e0: 6174 6974 7564 653d 7374 6174 732e 7361  atitude=stats.sa
-000039f0: 635b 2273 746c 6122 5d2c 0a20 2020 2020  c["stla"],.     
-00003a00: 2020 2020 2020 206c 6f6e 6769 7475 6465         longitude
-00003a10: 3d73 7461 7473 2e73 6163 5b22 7374 6c6f  =stats.sac["stlo
-00003a20: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-00003a30: 656c 6576 6174 696f 6e3d 7374 6174 732e  elevation=stats.
-00003a40: 7361 635b 2273 7465 6c22 5d2c 0a20 2020  sac["stel"],.   
-00003a50: 2020 2020 2020 2020 2064 6570 7468 3d2d           depth=-
-00003a60: 7374 6174 732e 7361 635b 2273 7465 6c22  stats.sac["stel"
-00003a70: 5d2c 0a20 2020 2020 2020 2020 2020 2061  ],.            a
-00003a80: 7a69 6d75 7468 3d73 7461 7473 2e73 6163  zimuth=stats.sac
-00003a90: 5b22 636d 7061 7a22 5d2c 0a20 2020 2020  ["cmpaz"],.     
-00003aa0: 2020 2020 2020 2064 6970 3d73 7461 7473         dip=stats
-00003ab0: 2e73 6163 5b22 636d 7069 6e63 225d 2c0a  .sac["cmpinc"],.
-00003ac0: 2020 2020 2020 2020 2020 2020 7361 6d70              samp
-00003ad0: 6c65 5f72 6174 653d 7374 6174 732e 7361  le_rate=stats.sa
-00003ae0: 6d70 6c69 6e67 5f72 6174 652c 0a20 2020  mpling_rate,.   
-00003af0: 2020 2020 2029 0a0a 2020 2020 656c 6966       )..    elif
-00003b00: 2069 6e70 7574 5f66 6d74 203d 3d20 226d   input_fmt == "m
-00003b10: 7365 6564 223a 0a20 2020 2020 2020 2069  seed":.        i
-00003b20: 7374 6120 3d20 6c6f 6373 5b6c 6f63 735b  sta = locs[locs[
-00003b30: 2273 7461 7469 6f6e 225d 203d 3d20 7374  "station"] == st
-00003b40: 6174 732e 7374 6174 696f 6e5d 2e69 6e64  ats.station].ind
-00003b50: 6578 2e76 616c 7565 732e 6173 7479 7065  ex.values.astype
-00003b60: 2822 696e 7436 3422 295b 305d 0a0a 2020  ("int64")[0]..  
-00003b70: 2020 2020 2020 6e65 7420 3d20 4e65 7477        net = Netw
-00003b80: 6f72 6b28 0a20 2020 2020 2020 2020 2020  ork(.           
-00003b90: 2023 2054 6869 7320 6973 2074 6865 206e   # This is the n
-00003ba0: 6574 776f 726b 2063 6f64 6520 6163 636f  etwork code acco
-00003bb0: 7264 696e 6720 746f 2074 6865 2053 4545  rding to the SEE
-00003bc0: 4420 7374 616e 6461 7264 2e0a 2020 2020  D standard..    
-00003bd0: 2020 2020 2020 2020 636f 6465 3d6c 6f63          code=loc
-00003be0: 732e 696c 6f63 5b69 7374 615d 5b22 6e65  s.iloc[ista]["ne
-00003bf0: 7477 6f72 6b22 5d2c 0a20 2020 2020 2020  twork"],.       
-00003c00: 2020 2020 2073 7461 7469 6f6e 733d 5b5d       stations=[]
-00003c10: 2c0a 2020 2020 2020 2020 2020 2020 6465  ,.            de
-00003c20: 7363 7269 7074 696f 6e3d 2263 7265 6174  scription="creat
-00003c30: 6564 2066 726f 6d20 5341 4320 616e 6420  ed from SAC and 
-00003c40: 7265 7370 2066 696c 6573 222c 0a20 2020  resp files",.   
-00003c50: 2020 2020 2020 2020 2073 7461 7274 5f64           start_d
-00003c60: 6174 653d 7374 6174 732e 7374 6172 7474  ate=stats.startt
-00003c70: 696d 652c 0a20 2020 2020 2020 2029 0a0a  ime,.        )..
-00003c80: 2020 2020 2020 2020 7374 6120 3d20 5374          sta = St
-00003c90: 6174 696f 6e28 0a20 2020 2020 2020 2020  ation(.         
-00003ca0: 2020 2023 2054 6869 7320 6973 2074 6865     # This is the
-00003cb0: 2073 7461 7469 6f6e 2063 6f64 6520 6163   station code ac
-00003cc0: 636f 7264 696e 6720 746f 2074 6865 2053  cording to the S
-00003cd0: 4545 4420 7374 616e 6461 7264 2e0a 2020  EED standard..  
-00003ce0: 2020 2020 2020 2020 2020 636f 6465 3d6c            code=l
-00003cf0: 6f63 732e 696c 6f63 5b69 7374 615d 5b22  ocs.iloc[ista]["
-00003d00: 7374 6174 696f 6e22 5d2c 0a20 2020 2020  station"],.     
-00003d10: 2020 2020 2020 206c 6174 6974 7564 653d         latitude=
-00003d20: 6c6f 6373 2e69 6c6f 635b 6973 7461 5d5b  locs.iloc[ista][
-00003d30: 226c 6174 6974 7564 6522 5d2c 0a20 2020  "latitude"],.   
-00003d40: 2020 2020 2020 2020 206c 6f6e 6769 7475           longitu
-00003d50: 6465 3d6c 6f63 732e 696c 6f63 5b69 7374  de=locs.iloc[ist
-00003d60: 615d 5b22 6c6f 6e67 6974 7564 6522 5d2c  a]["longitude"],
-00003d70: 0a20 2020 2020 2020 2020 2020 2065 6c65  .            ele
-00003d80: 7661 7469 6f6e 3d6c 6f63 732e 696c 6f63  vation=locs.iloc
-00003d90: 5b69 7374 615d 5b22 656c 6576 6174 696f  [ista]["elevatio
-00003da0: 6e22 5d2c 0a20 2020 2020 2020 2020 2020  n"],.           
-00003db0: 2063 7265 6174 696f 6e5f 6461 7465 3d73   creation_date=s
-00003dc0: 7461 7473 2e73 7461 7274 7469 6d65 2c0a  tats.starttime,.
-00003dd0: 2020 2020 2020 2020 2020 2020 7369 7465              site
-00003de0: 3d53 6974 6528 6e61 6d65 3d22 4669 7273  =Site(name="Firs
-00003df0: 7420 7374 6174 696f 6e22 292c 0a20 2020  t station"),.   
-00003e00: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00003e10: 6368 6120 3d20 4368 616e 6e65 6c28 0a20  cha = Channel(. 
-00003e20: 2020 2020 2020 2020 2020 2063 6f64 653d             code=
-00003e30: 7374 6174 732e 6368 616e 6e65 6c2c 0a20  stats.channel,. 
-00003e40: 2020 2020 2020 2020 2020 206c 6f63 6174             locat
-00003e50: 696f 6e5f 636f 6465 3d73 7461 7473 2e6c  ion_code=stats.l
-00003e60: 6f63 6174 696f 6e2c 0a20 2020 2020 2020  ocation,.       
-00003e70: 2020 2020 206c 6174 6974 7564 653d 6c6f       latitude=lo
-00003e80: 6373 2e69 6c6f 635b 6973 7461 5d5b 226c  cs.iloc[ista]["l
-00003e90: 6174 6974 7564 6522 5d2c 0a20 2020 2020  atitude"],.     
-00003ea0: 2020 2020 2020 206c 6f6e 6769 7475 6465         longitude
-00003eb0: 3d6c 6f63 732e 696c 6f63 5b69 7374 615d  =locs.iloc[ista]
-00003ec0: 5b22 6c6f 6e67 6974 7564 6522 5d2c 0a20  ["longitude"],. 
-00003ed0: 2020 2020 2020 2020 2020 2065 6c65 7661             eleva
-00003ee0: 7469 6f6e 3d6c 6f63 732e 696c 6f63 5b69  tion=locs.iloc[i
-00003ef0: 7374 615d 5b22 656c 6576 6174 696f 6e22  sta]["elevation"
-00003f00: 5d2c 0a20 2020 2020 2020 2020 2020 2064  ],.            d
-00003f10: 6570 7468 3d2d 6c6f 6373 2e69 6c6f 635b  epth=-locs.iloc[
-00003f20: 6973 7461 5d5b 2265 6c65 7661 7469 6f6e  ista]["elevation
-00003f30: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-00003f40: 617a 696d 7574 683d 302c 0a20 2020 2020  azimuth=0,.     
-00003f50: 2020 2020 2020 2064 6970 3d30 2c0a 2020         dip=0,.  
-00003f60: 2020 2020 2020 2020 2020 7361 6d70 6c65            sample
-00003f70: 5f72 6174 653d 7374 6174 732e 7361 6d70  _rate=stats.samp
-00003f80: 6c69 6e67 5f72 6174 652c 0a20 2020 2020  ling_rate,.     
-00003f90: 2020 2029 0a0a 2020 2020 7265 7370 6f6e     )..    respon
-00003fa0: 7365 203d 206f 6273 7079 2e63 6f72 652e  se = obspy.core.
-00003fb0: 696e 7665 6e74 6f72 792e 7265 7370 6f6e  inventory.respon
-00003fc0: 7365 2e52 6573 706f 6e73 6528 290a 0a20  se.Response().. 
-00003fd0: 2020 2023 204e 6f77 2074 6965 2069 7420     # Now tie it 
-00003fe0: 616c 6c20 746f 6765 7468 6572 2e0a 2020  all together..  
-00003ff0: 2020 6368 612e 7265 7370 6f6e 7365 203d    cha.response =
-00004000: 2072 6573 706f 6e73 650a 2020 2020 7374   response.    st
-00004010: 612e 6368 616e 6e65 6c73 2e61 7070 656e  a.channels.appen
-00004020: 6428 6368 6129 0a20 2020 206e 6574 2e73  d(cha).    net.s
-00004030: 7461 7469 6f6e 732e 6170 7065 6e64 2873  tations.append(s
-00004040: 7461 290a 2020 2020 696e 762e 6e65 7477  ta).    inv.netw
-00004050: 6f72 6b73 2e61 7070 656e 6428 6e65 7429  orks.append(net)
-00004060: 0a0a 2020 2020 7265 7475 726e 2069 6e76  ..    return inv
-00004070: 0a0a 0a64 6566 2073 7461 5f69 6e66 6f5f  ...def sta_info_
-00004080: 6672 6f6d 5f69 6e76 2869 6e76 293a 0a20  from_inv(inv):. 
-00004090: 2020 2022 2222 0a20 2020 2074 6869 7320     """.    this 
-000040a0: 6675 6e63 7469 6f6e 206f 7574 7075 7473  function outputs
-000040b0: 2073 7461 7469 6f6e 2069 6e66 6f20 6672   station info fr
-000040c0: 6f6d 2074 6865 206f 6273 7079 2069 6e76  om the obspy inv
-000040d0: 656e 746f 7279 206f 626a 6563 740a 2020  entory object.  
-000040e0: 2020 2875 7365 6420 696e 2053 3042 290a    (used in S0B).
-000040f0: 2020 2020 5041 5241 4d45 5445 5253 3a0a      PARAMETERS:.
-00004100: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
-00004110: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2069  ----------.    i
-00004120: 6e76 3a20 6f62 7370 7920 696e 7665 6e74  nv: obspy invent
-00004130: 6f72 7920 6f62 6a65 6374 0a20 2020 2052  ory object.    R
-00004140: 4554 5552 4e53 3a0a 2020 2020 2d2d 2d2d  ETURNS:.    ----
-00004150: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00004160: 2d2d 0a20 2020 2073 7461 3a20 7374 6174  --.    sta: stat
-00004170: 696f 6e20 6e61 6d65 0a20 2020 206e 6574  ion name.    net
-00004180: 3a20 6e65 746f 7772 6b20 6e61 6d65 0a20  : netowrk name. 
-00004190: 2020 206c 6f6e 3a20 6c6f 6e67 6974 7564     lon: longitud
-000041a0: 6520 6f66 2074 6865 2073 7461 7469 6f6e  e of the station
-000041b0: 0a20 2020 206c 6174 3a20 6c61 7469 7475  .    lat: latitu
-000041c0: 6465 206f 6620 7468 6520 7374 6174 696f  de of the statio
-000041d0: 6e0a 2020 2020 656c 763a 2065 6c65 7661  n.    elv: eleva
-000041e0: 7469 6f6e 206f 6620 7468 6520 7374 6174  tion of the stat
-000041f0: 696f 6e0a 2020 2020 6c6f 6361 7469 6f6e  ion.    location
-00004200: 3a20 6c6f 6361 7469 6f6e 2063 6f64 6520  : location code 
-00004210: 6f66 2074 6865 2073 7461 7469 6f6e 0a20  of the station. 
-00004220: 2020 2022 2222 0a20 2020 2023 206c 6f61     """.    # loa
-00004230: 6420 6672 6f6d 2073 7461 7469 6f6e 2069  d from station i
-00004240: 6e76 656e 746f 7279 0a20 2020 2073 7461  nventory.    sta
-00004250: 203d 2069 6e76 5b30 5d5b 305d 2e63 6f64   = inv[0][0].cod
-00004260: 650a 2020 2020 6e65 7420 3d20 696e 765b  e.    net = inv[
-00004270: 305d 2e63 6f64 650a 2020 2020 6c6f 6e20  0].code.    lon 
-00004280: 3d20 696e 765b 305d 5b30 5d2e 6c6f 6e67  = inv[0][0].long
-00004290: 6974 7564 650a 2020 2020 6c61 7420 3d20  itude.    lat = 
-000042a0: 696e 765b 305d 5b30 5d2e 6c61 7469 7475  inv[0][0].latitu
-000042b0: 6465 0a20 2020 2069 6620 696e 765b 305d  de.    if inv[0]
-000042c0: 5b30 5d2e 656c 6576 6174 696f 6e3a 0a20  [0].elevation:. 
-000042d0: 2020 2020 2020 2065 6c76 203d 2069 6e76         elv = inv
-000042e0: 5b30 5d5b 305d 2e65 6c65 7661 7469 6f6e  [0][0].elevation
-000042f0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00004300: 2020 2065 6c76 203d 2030 2e30 0a0a 2020     elv = 0.0..  
-00004310: 2020 6966 2069 6e76 5b30 5d5b 305d 5b30    if inv[0][0][0
-00004320: 5d2e 6c6f 6361 7469 6f6e 5f63 6f64 653a  ].location_code:
-00004330: 0a20 2020 2020 2020 206c 6f63 6174 696f  .        locatio
-00004340: 6e20 3d20 696e 765b 305d 5b30 5d5b 305d  n = inv[0][0][0]
-00004350: 2e6c 6f63 6174 696f 6e5f 636f 6465 0a20  .location_code. 
-00004360: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00004370: 206c 6f63 6174 696f 6e20 3d20 2230 3022   location = "00"
-00004380: 0a0a 2020 2020 7265 7475 726e 2073 7461  ..    return sta
-00004390: 2c20 6e65 742c 206c 6f6e 2c20 6c61 742c  , net, lon, lat,
-000043a0: 2065 6c76 2c20 6c6f 6361 7469 6f6e 0a0a   elv, location..
-000043b0: 0a64 6566 2063 7574 5f74 7261 6365 5f6d  .def cut_trace_m
-000043c0: 616b 655f 7374 6174 2866 635f 7061 7261  ake_stat(fc_para
-000043d0: 2c20 736f 7572 6365 293a 0a20 2020 2022  , source):.    "
-000043e0: 2222 0a20 2020 2074 6869 7320 6675 6e63  "".    this func
-000043f0: 7469 6f6e 2063 7574 7320 636f 6e74 696e  tion cuts contin
-00004400: 6f75 7320 6e6f 6973 6520 6461 7461 2069  ous noise data i
-00004410: 6e74 6f20 7573 6572 2d64 6566 696e 6564  nto user-defined
-00004420: 2073 6567 6d65 6e74 732c 2065 7374 696d   segments, estim
-00004430: 6174 6520 7468 6520 7374 6174 6973 7469  ate the statisti
-00004440: 6373 206f 660a 2020 2020 6561 6368 2073  cs of.    each s
-00004450: 6567 6d65 6e74 2061 6e64 206b 6565 7020  egment and keep 
-00004460: 7469 6d65 7374 616d 7020 6f66 2065 6163  timestamp of eac
-00004470: 6820 7365 676d 656e 7420 666f 7220 6c61  h segment for la
-00004480: 7465 7220 7573 652e 2028 7573 6564 2069  ter use. (used i
-00004490: 6e20 5331 290a 2020 2020 5041 5241 4d45  n S1).    PARAME
-000044a0: 5445 5253 3a0a 2020 2020 2d2d 2d2d 2d2d  TERS:.    ------
-000044b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000044c0: 0a20 2020 2066 6674 5f70 6172 613a 2041  .    fft_para: A
-000044d0: 2064 6963 7469 6f6e 6172 7920 636f 6e74   dictionary cont
-000044e0: 6169 6e69 6e67 2061 6c6c 2066 6674 2061  aining all fft a
-000044f0: 6e64 2063 6320 7061 7261 6d65 7465 7273  nd cc parameters
-00004500: 2e0a 2020 2020 736f 7572 6365 3a20 6f62  ..    source: ob
-00004510: 7370 7920 7374 7265 616d 206f 626a 6563  spy stream objec
-00004520: 740a 2020 2020 5245 5455 524e 533a 0a20  t.    RETURNS:. 
-00004530: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
-00004540: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7472  ---------.    tr
-00004550: 6163 655f 7374 6453 3a20 7374 616e 6461  ace_stdS: standa
-00004560: 7264 2064 6576 6961 7469 6f6e 206f 6620  rd deviation of 
-00004570: 7468 6520 6e6f 6973 6520 616d 706c 6974  the noise amplit
-00004580: 7564 6520 6f66 2065 6163 6820 7365 676d  ude of each segm
-00004590: 656e 740a 2020 2020 6461 7461 535f 743a  ent.    dataS_t:
-000045a0: 2020 2020 7469 6d65 7374 616d 7073 206f      timestamps o
-000045b0: 6620 6561 6368 2073 6567 6d65 6e74 0a20  f each segment. 
-000045c0: 2020 2064 6174 6153 3a20 2020 2020 2032     dataS:      2
-000045d0: 4420 6d61 7472 6978 206f 6620 7468 6520  D matrix of the 
-000045e0: 7365 676d 656e 7465 6420 6461 7461 0a20  segmented data. 
-000045f0: 2020 2022 2222 0a20 2020 2023 2064 6566     """.    # def
-00004600: 696e 6520 7265 7475 726e 2076 6172 6961  ine return varia
-00004610: 626c 6573 2066 6972 7374 0a20 2020 2073  bles first.    s
-00004620: 6f75 7263 655f 7061 7261 6d73 203d 205b  ource_params = [
-00004630: 5d0a 2020 2020 6461 7461 535f 7420 3d20  ].    dataS_t = 
-00004640: 5b5d 0a20 2020 2064 6174 6153 203d 205b  [].    dataS = [
-00004650: 5d0a 0a20 2020 2023 206c 6f61 6420 7061  ]..    # load pa
-00004660: 7261 6d65 7465 7220 6672 6f6d 2064 6963  rameter from dic
-00004670: 0a20 2020 2069 6e63 5f68 6f75 7273 203d  .    inc_hours =
-00004680: 2066 635f 7061 7261 5b22 696e 635f 686f   fc_para["inc_ho
-00004690: 7572 7322 5d0a 2020 2020 6363 5f6c 656e  urs"].    cc_len
-000046a0: 203d 2066 635f 7061 7261 5b22 6363 5f6c   = fc_para["cc_l
-000046b0: 656e 225d 0a20 2020 2073 7465 7020 3d20  en"].    step = 
-000046c0: 6663 5f70 6172 615b 2273 7465 7022 5d0a  fc_para["step"].
-000046d0: 0a20 2020 2023 2075 7365 6675 6c20 7061  .    # useful pa
-000046e0: 7261 6d65 7465 7273 2066 6f72 2074 7261  rameters for tra
-000046f0: 6365 2073 6c69 6469 6e67 0a20 2020 206e  ce sliding.    n
-00004700: 7365 6720 3d20 696e 7428 6e70 2e66 6c6f  seg = int(np.flo
-00004710: 6f72 2828 696e 635f 686f 7572 7320 2f20  or((inc_hours / 
-00004720: 3234 202a 2038 3634 3030 202d 2063 635f  24 * 86400 - cc_
-00004730: 6c65 6e29 202f 2073 7465 7029 290a 2020  len) / step)).  
-00004740: 2020 7370 7320 3d20 696e 7428 736f 7572    sps = int(sour
-00004750: 6365 5b30 5d2e 7374 6174 732e 7361 6d70  ce[0].stats.samp
-00004760: 6c69 6e67 5f72 6174 6529 0a20 2020 2073  ling_rate).    s
-00004770: 7461 7274 7469 6d65 203d 2073 6f75 7263  tarttime = sourc
-00004780: 655b 305d 2e73 7461 7473 2e73 7461 7274  e[0].stats.start
-00004790: 7469 6d65 202d 206f 6273 7079 2e55 5443  time - obspy.UTC
-000047a0: 4461 7465 5469 6d65 2831 3937 302c 2031  DateTime(1970, 1
-000047b0: 2c20 3129 0a20 2020 2023 2063 6f70 7920  , 1).    # copy 
-000047c0: 6461 7461 2069 6e74 6f20 6172 7261 790a  data into array.
-000047d0: 2020 2020 6461 7461 203d 2073 6f75 7263      data = sourc
-000047e0: 655b 305d 2e64 6174 610a 0a20 2020 2023  e[0].data..    #
-000047f0: 2069 6620 7468 6520 6461 7461 2069 7320   if the data is 
-00004800: 7368 6f72 7465 7220 7468 616e 2074 6865  shorter than the
-00004810: 2074 696d 2063 6875 6e63 6b2c 2072 6574   tim chunck, ret
-00004820: 7572 6e20 7a65 726f 2076 616c 7565 730a  urn zero values.
-00004830: 2020 2020 6966 2064 6174 612e 7369 7a65      if data.size
-00004840: 203c 2073 7073 202a 2069 6e63 5f68 6f75   < sps * inc_hou
-00004850: 7273 202a 2033 3630 303a 0a20 2020 2020  rs * 3600:.     
-00004860: 2020 2072 6574 7572 6e20 736f 7572 6365     return source
-00004870: 5f70 6172 616d 732c 2064 6174 6153 5f74  _params, dataS_t
-00004880: 2c20 6461 7461 530a 0a20 2020 2023 2073  , dataS..    # s
-00004890: 7461 7469 7374 6963 2074 6f20 6465 7465  tatistic to dete
-000048a0: 6374 2073 6567 6d65 6e74 7320 7468 6174  ct segments that
-000048b0: 206d 6179 2062 6520 6173 736f 6369 6174   may be associat
-000048c0: 6564 2077 6974 6820 6561 7274 6871 7561  ed with earthqua
-000048d0: 6b65 730a 2020 2020 616c 6c5f 6d61 6453  kes.    all_madS
-000048e0: 203d 206d 6164 2864 6174 6129 2020 2320   = mad(data)  # 
-000048f0: 6d65 6469 616e 2061 6273 6f6c 7574 6520  median absolute 
-00004900: 6465 7669 6174 696f 6e20 6f76 6572 2061  deviation over a
-00004910: 6c6c 206e 6f69 7365 2077 696e 646f 770a  ll noise window.
-00004920: 2020 2020 616c 6c5f 7374 6453 203d 206e      all_stdS = n
-00004930: 702e 7374 6428 6461 7461 2920 2023 2073  p.std(data)  # s
-00004940: 7461 6e64 6172 6420 6465 7669 6174 696f  tandard deviatio
-00004950: 6e20 6f76 6572 2061 6c6c 206e 6f69 7365  n over all noise
-00004960: 2077 696e 646f 770a 2020 2020 6966 2061   window.    if a
-00004970: 6c6c 5f6d 6164 5320 3d3d 2030 206f 7220  ll_madS == 0 or 
-00004980: 616c 6c5f 7374 6453 203d 3d20 3020 6f72  all_stdS == 0 or
-00004990: 206e 702e 6973 6e61 6e28 616c 6c5f 6d61   np.isnan(all_ma
-000049a0: 6453 2920 6f72 206e 702e 6973 6e61 6e28  dS) or np.isnan(
-000049b0: 616c 6c5f 7374 6453 293a 0a20 2020 2020  all_stdS):.     
-000049c0: 2020 2070 7269 6e74 2822 636f 6e74 696e     print("contin
-000049d0: 7565 2120 6d61 6453 206f 7220 7374 6453  ue! madS or stdS
-000049e0: 2065 7175 616c 7320 746f 2030 2066 6f72   equals to 0 for
-000049f0: 2025 7322 2025 2073 6f75 7263 6529 0a20   %s" % source). 
-00004a00: 2020 2020 2020 2072 6574 7572 6e20 736f         return so
-00004a10: 7572 6365 5f70 6172 616d 732c 2064 6174  urce_params, dat
-00004a20: 6153 5f74 2c20 6461 7461 530a 0a20 2020  aS_t, dataS..   
-00004a30: 2023 2069 6e69 7469 616c 697a 6520 7661   # initialize va
-00004a40: 7269 6162 6c65 730a 2020 2020 6e70 7473  riables.    npts
-00004a50: 203d 2063 635f 6c65 6e20 2a20 7370 730a   = cc_len * sps.
-00004a60: 2020 2020 2320 7472 6163 655f 6d61 6453      # trace_madS
-00004a70: 203d 206e 702e 7a65 726f 7328 6e73 6567   = np.zeros(nseg
-00004a80: 2c64 7479 7065 3d6e 702e 666c 6f61 7433  ,dtype=np.float3
-00004a90: 3229 0a20 2020 2074 7261 6365 5f73 7464  2).    trace_std
-00004aa0: 5320 3d20 6e70 2e7a 6572 6f73 286e 7365  S = np.zeros(nse
-00004ab0: 672c 2064 7479 7065 3d6e 702e 666c 6f61  g, dtype=np.floa
-00004ac0: 7433 3229 0a20 2020 2064 6174 6153 203d  t32).    dataS =
-00004ad0: 206e 702e 7a65 726f 7328 7368 6170 653d   np.zeros(shape=
-00004ae0: 286e 7365 672c 206e 7074 7329 2c20 6474  (nseg, npts), dt
-00004af0: 7970 653d 6e70 2e66 6c6f 6174 3332 290a  ype=np.float32).
-00004b00: 2020 2020 6461 7461 535f 7420 3d20 6e70      dataS_t = np
-00004b10: 2e7a 6572 6f73 286e 7365 672c 2064 7479  .zeros(nseg, dty
-00004b20: 7065 3d6e 702e 666c 6f61 7429 0a0a 2020  pe=np.float)..  
-00004b30: 2020 696e 6478 3120 3d20 300a 2020 2020    indx1 = 0.    
-00004b40: 666f 7220 6973 6567 2069 6e20 7261 6e67  for iseg in rang
-00004b50: 6528 6e73 6567 293a 0a20 2020 2020 2020  e(nseg):.       
-00004b60: 2069 6e64 7832 203d 2069 6e64 7831 202b   indx2 = indx1 +
-00004b70: 206e 7074 730a 2020 2020 2020 2020 6461   npts.        da
-00004b80: 7461 535b 6973 6567 5d20 3d20 6461 7461  taS[iseg] = data
-00004b90: 5b69 6e64 7831 3a69 6e64 7832 5d0a 2020  [indx1:indx2].  
-00004ba0: 2020 2020 2020 2320 7472 6163 655f 6d61        # trace_ma
-00004bb0: 6453 5b69 7365 675d 203d 2028 6e70 2e6d  dS[iseg] = (np.m
-00004bc0: 6178 286e 702e 6162 7328 6461 7461 535b  ax(np.abs(dataS[
-00004bd0: 6973 6567 5d29 292f 616c 6c5f 6d61 6453  iseg]))/all_madS
-00004be0: 290a 2020 2020 2020 2020 7472 6163 655f  ).        trace_
-00004bf0: 7374 6453 5b69 7365 675d 203d 206e 702e  stdS[iseg] = np.
-00004c00: 6d61 7828 6e70 2e61 6273 2864 6174 6153  max(np.abs(dataS
-00004c10: 5b69 7365 675d 2929 202f 2061 6c6c 5f73  [iseg])) / all_s
-00004c20: 7464 530a 2020 2020 2020 2020 6461 7461  tdS.        data
-00004c30: 535f 745b 6973 6567 5d20 3d20 7374 6172  S_t[iseg] = star
-00004c40: 7474 696d 6520 2b20 7374 6570 202a 2069  ttime + step * i
-00004c50: 7365 670a 2020 2020 2020 2020 696e 6478  seg.        indx
-00004c60: 3120 3d20 696e 6478 3120 2b20 7374 6570  1 = indx1 + step
-00004c70: 202a 2073 7073 0a0a 2020 2020 2320 3244   * sps..    # 2D
-00004c80: 2061 7272 6179 2070 726f 6365 7373 696e   array processin
-00004c90: 670a 2020 2020 6461 7461 5320 3d20 6465  g.    dataS = de
-00004ca0: 6d65 616e 2864 6174 6153 290a 2020 2020  mean(dataS).    
-00004cb0: 6461 7461 5320 3d20 6465 7472 656e 6428  dataS = detrend(
-00004cc0: 6461 7461 5329 0a20 2020 2064 6174 6153  dataS).    dataS
-00004cd0: 203d 2074 6170 6572 2864 6174 6153 290a   = taper(dataS).
-00004ce0: 0a20 2020 2072 6574 7572 6e20 7472 6163  .    return trac
-00004cf0: 655f 7374 6453 2c20 6461 7461 535f 742c  e_stdS, dataS_t,
-00004d00: 2064 6174 6153 0a0a 0a64 6566 206e 6f69   dataS...def noi
-00004d10: 7365 5f70 726f 6365 7373 696e 6728 6666  se_processing(ff
-00004d20: 745f 7061 7261 2c20 6461 7461 5329 3a0a  t_para, dataS):.
-00004d30: 2020 2020 2222 220a 2020 2020 7468 6973      """.    this
-00004d40: 2066 756e 6374 696f 6e20 7065 7266 6f72   function perfor
-00004d50: 6d73 2074 696d 6520 646f 6d61 696e 2061  ms time domain a
-00004d60: 6e64 2066 7265 7175 656e 6379 2064 6f6d  nd frequency dom
-00004d70: 6169 6e20 6e6f 726d 616c 697a 6174 696f  ain normalizatio
-00004d80: 6e20 6966 206e 6565 6465 642e 2069 6e20  n if needed. in 
-00004d90: 7265 616c 2063 6173 652c 2077 6520 7072  real case, we pr
-00004da0: 6566 6572 2075 7365 2069 6e63 6c75 6465  efer use include
-00004db0: 0a20 2020 2074 6865 206e 6f72 6d61 6c69  .    the normali
-00004dc0: 7a61 7469 6f6e 2069 6e20 7468 6520 6372  zation in the cr
-00004dd0: 6f73 732d 636f 7272 6561 6c74 696f 6e20  oss-correaltion 
-00004de0: 7374 6570 7320 6279 2073 656c 6563 7469  steps by selecti
-00004df0: 6e67 2063 6f68 6572 656e 6379 206f 7220  ng coherency or 
-00004e00: 6465 636f 6e0a 2020 2020 2850 7269 6574  decon.    (Priet
-00004e10: 6f20 6574 2061 6c2c 2032 3030 382c 2032  o et al, 2008, 2
-00004e20: 3030 393b 2044 656e 6f6c 6c65 2065 7420  009; Denolle et 
-00004e30: 616c 2c20 3230 3133 290a 2020 2020 5041  al, 2013).    PA
-00004e40: 524d 4145 5445 5253 3a0a 2020 2020 2d2d  RMAETERS:.    --
-00004e50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00004e60: 2d2d 2d2d 2d2d 0a20 2020 2066 6674 5f70  ------.    fft_p
-00004e70: 6172 613a 2064 6963 7469 6f6e 6172 7920  ara: dictionary 
-00004e80: 636f 6e74 6169 6e69 6e67 2061 6c6c 2075  containing all u
-00004e90: 7365 6675 6c20 7661 7269 6162 6c65 7320  seful variables 
-00004ea0: 7573 6564 2066 6f72 2066 6674 2061 6e64  used for fft and
-00004eb0: 2063 630a 2020 2020 6461 7461 533a 2032   cc.    dataS: 2
-00004ec0: 4420 6d61 7472 6978 206f 6620 616c 6c20  D matrix of all 
-00004ed0: 7365 676d 656e 7465 6420 6e6f 6973 6520  segmented noise 
-00004ee0: 6461 7461 0a20 2020 2023 204f 5554 5055  data.    # OUTPU
-00004ef0: 5420 5641 5249 4142 4c45 533a 0a20 2020  T VARIABLES:.   
-00004f00: 2073 6f75 7263 655f 7768 6974 653a 2032   source_white: 2
-00004f10: 4420 6d61 7472 6978 206f 6620 6461 7461  D matrix of data
-00004f20: 2073 7065 6374 7261 0a20 2020 2022 2222   spectra.    """
-00004f30: 0a20 2020 2023 206c 6f61 6420 7061 7261  .    # load para
-00004f40: 6d65 7465 7273 2066 6972 7374 0a20 2020  meters first.   
-00004f50: 2074 696d 655f 6e6f 726d 203d 2066 6674   time_norm = fft
-00004f60: 5f70 6172 615b 2274 696d 655f 6e6f 726d  _para["time_norm
-00004f70: 225d 0a20 2020 2066 7265 715f 6e6f 726d  "].    freq_norm
-00004f80: 203d 2066 6674 5f70 6172 615b 2266 7265   = fft_para["fre
-00004f90: 715f 6e6f 726d 225d 0a20 2020 2073 6d6f  q_norm"].    smo
-00004fa0: 6f74 685f 4e20 3d20 6666 745f 7061 7261  oth_N = fft_para
-00004fb0: 5b22 736d 6f6f 7468 5f4e 225d 0a20 2020  ["smooth_N"].   
-00004fc0: 204e 203d 2064 6174 6153 2e73 6861 7065   N = dataS.shape
-00004fd0: 5b30 5d0a 0a20 2020 2023 202d 2d2d 2d2d  [0]..    # -----
-00004fe0: 2d74 6f20 6e6f 726d 616c 697a 6520 696e  -to normalize in
-00004ff0: 2074 696d 6520 6f72 206e 6f74 2d2d 2d2d   time or not----
-00005000: 2d2d 0a20 2020 2069 6620 7469 6d65 5f6e  --.    if time_n
-00005010: 6f72 6d20 213d 2022 6e6f 223a 0a20 2020  orm != "no":.   
-00005020: 2020 2020 2069 6620 7469 6d65 5f6e 6f72       if time_nor
-00005030: 6d20 3d3d 2022 6f6e 655f 6269 7422 3a20  m == "one_bit": 
-00005040: 2023 2073 6967 6e20 6e6f 726d 616c 697a   # sign normaliz
-00005050: 6174 696f 6e0a 2020 2020 2020 2020 2020  ation.          
-00005060: 2020 7768 6974 6520 3d20 6e70 2e73 6967    white = np.sig
-00005070: 6e28 6461 7461 5329 0a20 2020 2020 2020  n(dataS).       
-00005080: 2065 6c69 6620 7469 6d65 5f6e 6f72 6d20   elif time_norm 
-00005090: 3d3d 2022 726d 6122 3a20 2023 2072 756e  == "rma":  # run
-000050a0: 6e69 6e67 206d 6561 6e3a 206e 6f72 6d61  ning mean: norma
-000050b0: 6c69 7a61 7469 6f6e 206f 7665 7220 736d  lization over sm
-000050c0: 6f6f 7468 6564 2061 6273 6f6c 7574 6520  oothed absolute 
-000050d0: 6176 6572 6167 650a 2020 2020 2020 2020  average.        
-000050e0: 2020 2020 7768 6974 6520 3d20 6e70 2e7a      white = np.z
-000050f0: 6572 6f73 2873 6861 7065 3d64 6174 6153  eros(shape=dataS
-00005100: 2e73 6861 7065 2c20 6474 7970 653d 6461  .shape, dtype=da
-00005110: 7461 532e 6474 7970 6529 0a20 2020 2020  taS.dtype).     
-00005120: 2020 2020 2020 2066 6f72 206b 6b6b 2069         for kkk i
-00005130: 6e20 7261 6e67 6528 4e29 3a0a 2020 2020  n range(N):.    
-00005140: 2020 2020 2020 2020 2020 2020 7768 6974              whit
-00005150: 655b 6b6b 6b2c 203a 5d20 3d20 6461 7461  e[kkk, :] = data
-00005160: 535b 6b6b 6b2c 203a 5d20 2f20 6d6f 7669  S[kkk, :] / movi
-00005170: 6e67 5f61 7665 286e 702e 6162 7328 6461  ng_ave(np.abs(da
-00005180: 7461 535b 6b6b 6b2c 203a 5d29 2c20 736d  taS[kkk, :]), sm
-00005190: 6f6f 7468 5f4e 290a 0a20 2020 2065 6c73  ooth_N)..    els
-000051a0: 653a 2020 2320 646f 6e27 7420 6e6f 726d  e:  # don't norm
-000051b0: 616c 697a 650a 2020 2020 2020 2020 7768  alize.        wh
-000051c0: 6974 6520 3d20 6461 7461 530a 0a20 2020  ite = dataS..   
-000051d0: 2023 202d 2d2d 2d2d 746f 2077 6869 7465   # -----to white
-000051e0: 6e20 6f72 206e 6f74 2d2d 2d2d 2d2d 0a20  n or not------. 
-000051f0: 2020 2069 6620 6672 6571 5f6e 6f72 6d20     if freq_norm 
-00005200: 213d 2022 6e6f 223a 0a20 2020 2020 2020  != "no":.       
-00005210: 2073 6f75 7263 655f 7768 6974 6520 3d20   source_white = 
-00005220: 7768 6974 656e 2877 6869 7465 2c20 6666  whiten(white, ff
-00005230: 745f 7061 7261 2920 2023 2077 6869 7465  t_para)  # white
-00005240: 6e20 616e 6420 7265 7475 726e 2046 4654  n and return FFT
-00005250: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00005260: 2020 204e 6666 7420 3d20 696e 7428 6e65     Nfft = int(ne
-00005270: 7874 5f66 6173 745f 6c65 6e28 696e 7428  xt_fast_len(int(
-00005280: 6461 7461 532e 7368 6170 655b 315d 2929  dataS.shape[1]))
-00005290: 290a 2020 2020 2020 2020 736f 7572 6365  ).        source
-000052a0: 5f77 6869 7465 203d 2073 6369 7079 2e66  _white = scipy.f
-000052b0: 6674 7061 636b 2e66 6674 2877 6869 7465  ftpack.fft(white
-000052c0: 2c20 4e66 6674 2c20 6178 6973 3d31 2920  , Nfft, axis=1) 
-000052d0: 2023 2072 6574 7572 6e20 4646 540a 0a20   # return FFT.. 
-000052e0: 2020 2072 6574 7572 6e20 736f 7572 6365     return source
-000052f0: 5f77 6869 7465 0a0a 0a64 6566 2073 6d6f  _white...def smo
-00005300: 6f74 685f 736f 7572 6365 5f73 7065 6374  oth_source_spect
-00005310: 2863 635f 7061 7261 2c20 6666 7431 293a  (cc_para, fft1):
-00005320: 0a20 2020 2022 2222 0a20 2020 2074 6869  .    """.    thi
-00005330: 7320 6675 6e63 7469 6f6e 2073 6d6f 6f74  s function smoot
-00005340: 6865 7320 616d 706c 6974 7564 6520 7370  hes amplitude sp
-00005350: 6563 7472 756d 206f 6620 7468 6520 3244  ectrum of the 2D
-00005360: 2073 7065 6374 7261 6c20 6d61 7472 6978   spectral matrix
-00005370: 2e20 2875 7365 6420 696e 2053 3129 0a20  . (used in S1). 
-00005380: 2020 2050 4152 414d 4554 4552 533a 0a20     PARAMETERS:. 
-00005390: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
-000053a0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 635f  --------.    cc_
-000053b0: 7061 7261 3a20 6469 6374 696f 6e61 7279  para: dictionary
-000053c0: 2063 6f6e 7461 696e 696e 6720 7573 6566   containing usef
-000053d0: 756c 2063 6320 7061 7261 6d65 7465 7273  ul cc parameters
-000053e0: 0a20 2020 2066 6674 313a 2020 2020 736f  .    fft1:    so
-000053f0: 7572 6365 2073 7065 6374 7275 6d20 6d61  urce spectrum ma
-00005400: 7472 6978 0a0a 2020 2020 5245 5455 524e  trix..    RETURN
-00005410: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
-00005420: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
-00005430: 2073 6666 7431 3a20 636f 6d70 6c65 7820   sfft1: complex 
-00005440: 6e75 6d70 7920 6172 7261 7920 7769 7468  numpy array with
-00005450: 206e 6f72 6d61 6c69 7a65 6420 7370 6563   normalized spec
-00005460: 7472 756d 0a20 2020 2022 2222 0a20 2020  trum.    """.   
-00005470: 2063 635f 6d65 7468 6f64 203d 2063 635f   cc_method = cc_
-00005480: 7061 7261 5b22 6363 5f6d 6574 686f 6422  para["cc_method"
-00005490: 5d0a 2020 2020 736d 6f6f 7468 7370 6563  ].    smoothspec
-000054a0: 745f 4e20 3d20 6363 5f70 6172 615b 2273  t_N = cc_para["s
-000054b0: 6d6f 6f74 6873 7065 6374 5f4e 225d 0a0a  moothspect_N"]..
-000054c0: 2020 2020 6966 2063 635f 6d65 7468 6f64      if cc_method
-000054d0: 203d 3d20 2264 6563 6f6e 7622 3a0a 2020   == "deconv":.  
-000054e0: 2020 2020 2020 2320 2d2d 2d2d 2d6e 6f72        # -----nor
-000054f0: 6d61 6c69 7a65 2073 696e 676c 652d 7374  malize single-st
-00005500: 6174 696f 6e20 6363 2074 6f20 7a20 636f  ation cc to z co
-00005510: 6d70 6f6e 656e 742d 2d2d 2d2d 0a20 2020  mponent-----.   
-00005520: 2020 2020 2074 656d 7020 3d20 6d6f 7669       temp = movi
-00005530: 6e67 5f61 7665 286e 702e 6162 7328 6666  ng_ave(np.abs(ff
-00005540: 7431 292c 2073 6d6f 6f74 6873 7065 6374  t1), smoothspect
-00005550: 5f4e 290a 2020 2020 2020 2020 7472 793a  _N).        try:
-00005560: 0a20 2020 2020 2020 2020 2020 2073 6666  .            sff
-00005570: 7431 203d 206e 702e 636f 6e6a 2866 6674  t1 = np.conj(fft
-00005580: 3129 202f 2074 656d 702a 2a32 0a20 2020  1) / temp**2.   
-00005590: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-000055a0: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
-000055b0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-000055c0: 726f 7228 2273 6d6f 6f74 6865 6420 7370  ror("smoothed sp
-000055d0: 6563 7472 756d 2068 6173 207a 6572 6f20  ectrum has zero 
-000055e0: 7661 6c75 6573 2229 0a0a 2020 2020 656c  values")..    el
-000055f0: 6966 2063 635f 6d65 7468 6f64 203d 3d20  if cc_method == 
-00005600: 2263 6f68 6572 656e 6379 223a 0a20 2020  "coherency":.   
-00005610: 2020 2020 2074 656d 7020 3d20 6d6f 7669       temp = movi
-00005620: 6e67 5f61 7665 286e 702e 6162 7328 6666  ng_ave(np.abs(ff
-00005630: 7431 292c 2073 6d6f 6f74 6873 7065 6374  t1), smoothspect
-00005640: 5f4e 290a 2020 2020 2020 2020 7472 793a  _N).        try:
-00005650: 0a20 2020 2020 2020 2020 2020 2073 6666  .            sff
-00005660: 7431 203d 206e 702e 636f 6e6a 2866 6674  t1 = np.conj(fft
-00005670: 3129 202f 2074 656d 700a 2020 2020 2020  1) / temp.      
-00005680: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-00005690: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-000056a0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-000056b0: 2822 736d 6f6f 7468 6564 2073 7065 6374  ("smoothed spect
-000056c0: 7275 6d20 6861 7320 7a65 726f 2076 616c  rum has zero val
-000056d0: 7565 7322 290a 0a20 2020 2065 6c69 6620  ues")..    elif 
-000056e0: 6363 5f6d 6574 686f 6420 3d3d 2022 7863  cc_method == "xc
-000056f0: 6f72 7222 3a0a 2020 2020 2020 2020 7366  orr":.        sf
-00005700: 6674 3120 3d20 6e70 2e63 6f6e 6a28 6666  ft1 = np.conj(ff
-00005710: 7431 290a 0a20 2020 2065 6c73 653a 0a20  t1)..    else:. 
-00005720: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00005730: 7565 4572 726f 7228 226e 6f20 636f 7272  ueError("no corr
-00005740: 6563 7469 6f6e 2063 6f72 7265 6c61 7469  ection correlati
-00005750: 6f6e 206d 6574 686f 6420 6973 2073 656c  on method is sel
-00005760: 6563 7465 6420 6174 204c 3539 2229 0a0a  ected at L59")..
-00005770: 2020 2020 7265 7475 726e 2073 6666 7431      return sfft1
-00005780: 0a0a 0a64 6566 2063 6f72 7265 6c61 7465  ...def correlate
-00005790: 2866 6674 315f 736d 6f6f 7468 6564 5f61  (fft1_smoothed_a
-000057a0: 6273 2c20 6666 7432 2c20 442c 204e 6666  bs, fft2, D, Nff
-000057b0: 742c 2064 6174 6153 5f74 293a 0a20 2020  t, dataS_t):.   
-000057c0: 2022 2222 0a20 2020 2074 6869 7320 6675   """.    this fu
-000057d0: 6e63 7469 6f6e 2064 6f65 7320 7468 6520  nction does the 
-000057e0: 6372 6f73 732d 636f 7272 656c 6174 696f  cross-correlatio
-000057f0: 6e20 696e 2066 7265 7120 646f 6d61 696e  n in freq domain
-00005800: 2061 6e64 2068 6173 2074 6865 206f 7074   and has the opt
-00005810: 696f 6e20 746f 206b 6565 7020 7375 622d  ion to keep sub-
-00005820: 7374 6163 6b73 206f 660a 2020 2020 7468  stacks of.    th
-00005830: 6520 6372 6f73 732d 636f 7272 656c 6174  e cross-correlat
-00005840: 696f 6e20 6966 206e 6565 6465 642e 2069  ion if needed. i
-00005850: 7420 7461 6b65 7320 6164 7661 6e74 6167  t takes advantag
-00005860: 6520 6f66 2074 6865 206c 696e 6561 7220  e of the linear 
-00005870: 7265 6c61 7469 6f6e 7368 6970 206f 6620  relationship of 
-00005880: 6966 6674 2c20 736f 2074 6861 740a 2020  ifft, so that.  
-00005890: 2020 7374 6163 6b69 6e67 2069 7320 7065    stacking is pe
-000058a0: 7266 6f72 6d65 6420 696e 2073 7065 6374  rformed in spect
-000058b0: 7275 6d20 646f 6d61 696e 2066 6972 7374  rum domain first
-000058c0: 2074 6f20 7265 6475 6365 2074 6865 2074   to reduce the t
-000058d0: 6f74 616c 206e 756d 6265 7220 6f66 2069  otal number of i
-000058e0: 6666 742e 2028 7573 6564 2069 6e20 5331  fft. (used in S1
-000058f0: 290a 2020 2020 5041 5241 4d45 5445 5253  ).    PARAMETERS
-00005900: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
-00005910: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
-00005920: 6666 7431 5f73 6d6f 6f74 6865 645f 6162  fft1_smoothed_ab
-00005930: 733a 2073 6d6f 6f74 6865 6420 706f 7765  s: smoothed powe
-00005940: 7220 7370 6563 7472 616c 2064 656e 7369  r spectral densi
-00005950: 7479 206f 6620 7468 6520 4646 5420 666f  ty of the FFT fo
-00005960: 7220 7468 6520 736f 7572 6365 2073 7461  r the source sta
-00005970: 7469 6f6e 0a20 2020 2066 6674 323a 2072  tion.    fft2: r
-00005980: 6177 2046 4654 2073 7065 6374 7275 6d20  aw FFT spectrum 
-00005990: 6f66 2074 6865 2072 6563 6569 7665 7220  of the receiver 
-000059a0: 7374 6174 696f 6e0a 2020 2020 443a 2064  station.    D: d
-000059b0: 6963 7469 6f6e 6172 7920 636f 6e74 6169  ictionary contai
-000059c0: 6e69 6e67 2066 6f6c 6c6f 7769 6e67 2070  ning following p
-000059d0: 6172 616d 6574 6572 733a 0a20 2020 2020  arameters:.     
-000059e0: 2020 206d 6178 6c61 673a 2020 6d61 7869     maxlag:  maxi
-000059f0: 6d75 6d20 6c61 6773 2074 6f20 6b65 6570  mum lags to keep
-00005a00: 2069 6e20 7468 6520 6372 6f73 7320 636f   in the cross co
-00005a10: 7272 656c 6174 696f 6e0a 2020 2020 2020  rrelation.      
-00005a20: 2020 6474 3a20 2020 2020 2073 616d 706c    dt:      sampl
-00005a30: 696e 6720 7261 7465 2028 696e 2073 290a  ing rate (in s).
-00005a40: 2020 2020 2020 2020 6e77 696e 3a20 2020          nwin:   
-00005a50: 206e 756d 6265 7220 6f66 2073 6567 6d65   number of segme
-00005a60: 6e74 7320 696e 2074 6865 2032 4420 6d61  nts in the 2D ma
-00005a70: 7472 6978 0a20 2020 2020 2020 206d 6574  trix.        met
-00005a80: 686f 643a 2020 6372 6f73 732d 636f 7272  hod:  cross-corr
-00005a90: 656c 6174 696f 6e20 6d65 7468 6f64 7320  elation methods 
-00005aa0: 7365 6c65 6374 6564 2062 7920 7468 6520  selected by the 
-00005ab0: 7573 6572 0a20 2020 2020 2020 2066 7265  user.        fre
-00005ac0: 716d 696e 3a20 6d69 6e69 6d75 6d20 6672  qmin: minimum fr
-00005ad0: 6571 7565 6e63 7920 2848 7a29 0a20 2020  equency (Hz).   
-00005ae0: 2020 2020 2066 7265 716d 6178 3a20 6d61       freqmax: ma
-00005af0: 7869 6d75 6d20 6672 6571 7565 6e63 7920  ximum frequency 
-00005b00: 2848 7a29 0a20 2020 204e 6666 743a 2020  (Hz).    Nfft:  
-00005b10: 2020 6e75 6d62 6572 206f 6620 6672 6571    number of freq
-00005b20: 7565 6e63 7920 706f 696e 7473 2066 6f72  uency points for
-00005b30: 2069 6666 740a 2020 2020 6461 7461 535f   ifft.    dataS_
-00005b40: 743a 206d 6174 7269 7820 6f66 2064 6174  t: matrix of dat
-00005b50: 6574 696d 6520 6f62 6a65 6374 2e0a 0a20  etime object... 
-00005b60: 2020 2052 4554 5552 4e53 3a0a 2020 2020     RETURNS:.    
-00005b70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00005b80: 2d2d 2d2d 2d0a 2020 2020 735f 636f 7272  -----.    s_corr
-00005b90: 3a20 3144 206f 7220 3244 206d 6174 7269  : 1D or 2D matri
-00005ba0: 7820 6f66 2074 6865 2061 7665 7261 6765  x of the average
-00005bb0: 6420 6f72 2073 7562 2d73 7461 636b 7320  d or sub-stacks 
-00005bc0: 6f66 2063 726f 7373 2d63 6f72 7265 6c61  of cross-correla
-00005bd0: 7469 6f6e 2066 756e 6374 696f 6e73 2069  tion functions i
-00005be0: 6e20 7469 6d65 2064 6f6d 6169 6e0a 2020  n time domain.  
-00005bf0: 2020 745f 636f 7272 3a20 7469 6d65 7374    t_corr: timest
-00005c00: 616d 7020 666f 7220 6561 6368 2073 7562  amp for each sub
-00005c10: 2d73 7461 636b 206f 7220 6176 6572 6167  -stack or averag
-00005c20: 6564 2066 756e 6374 696f 6e0a 2020 2020  ed function.    
-00005c30: 6e5f 636f 7272 3a20 6e75 6d62 6572 206f  n_corr: number o
-00005c40: 6620 696e 636c 7564 6564 2073 6567 6d65  f included segme
-00005c50: 6e74 7320 666f 7220 6561 6368 2073 7562  nts for each sub
-00005c60: 2d73 7461 636b 206f 7220 6176 6572 6167  -stack or averag
-00005c70: 6564 2066 756e 6374 696f 6e0a 0a20 2020  ed function..   
-00005c80: 204d 4f44 4946 4943 4154 494f 4e53 3a0a   MODIFICATIONS:.
-00005c90: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
-00005ca0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6f75  ---------.    ou
-00005cb0: 7470 7574 2074 6865 206c 696e 6561 7220  tput the linear 
-00005cc0: 7374 6163 6b20 6f66 2065 6163 6820 7469  stack of each ti
-00005cd0: 6d65 2063 6875 6e6b 2065 7665 6e20 7768  me chunk even wh
-00005ce0: 656e 2073 7562 7374 6163 6b20 6973 2073  en substack is s
-00005cf0: 656c 6563 7465 6420 2862 7920 4368 656e  elected (by Chen
-00005d00: 6778 696e 2040 4175 6732 3032 3029 0a20  gxin @Aug2020). 
-00005d10: 2020 2022 2222 0a20 2020 2023 202d 2d2d     """.    # ---
-00005d20: 2d6c 6f61 6420 7061 7261 6d74 6572 732d  -load paramters-
-00005d30: 2d2d 2d0a 2020 2020 6474 203d 2044 5b22  ---.    dt = D["
-00005d40: 6474 225d 0a20 2020 206d 6178 6c61 6720  dt"].    maxlag 
-00005d50: 3d20 445b 226d 6178 6c61 6722 5d0a 2020  = D["maxlag"].  
-00005d60: 2020 6d65 7468 6f64 203d 2044 5b22 6363    method = D["cc
-00005d70: 5f6d 6574 686f 6422 5d0a 2020 2020 6363  _method"].    cc
-00005d80: 5f6c 656e 203d 2044 5b22 6363 5f6c 656e  _len = D["cc_len
-00005d90: 225d 0a20 2020 2073 7562 7374 6163 6b20  "].    substack 
-00005da0: 3d20 445b 2273 7562 7374 6163 6b22 5d0a  = D["substack"].
-00005db0: 2020 2020 7375 6273 7461 636b 5f6c 656e      substack_len
-00005dc0: 203d 2044 5b22 7375 6273 7461 636b 5f6c   = D["substack_l
-00005dd0: 656e 225d 0a20 2020 2073 6d6f 6f74 6873  en"].    smooths
-00005de0: 7065 6374 5f4e 203d 2044 5b22 736d 6f6f  pect_N = D["smoo
-00005df0: 7468 7370 6563 745f 4e22 5d0a 0a20 2020  thspect_N"]..   
-00005e00: 206e 7769 6e20 3d20 6666 7431 5f73 6d6f   nwin = fft1_smo
-00005e10: 6f74 6865 645f 6162 732e 7368 6170 655b  othed_abs.shape[
-00005e20: 305d 0a20 2020 204e 6666 7432 203d 2066  0].    Nfft2 = f
-00005e30: 6674 315f 736d 6f6f 7468 6564 5f61 6273  ft1_smoothed_abs
-00005e40: 2e73 6861 7065 5b31 5d0a 0a20 2020 2023  .shape[1]..    #
-00005e50: 202d 2d2d 2d2d 2d63 6f6e 7665 7274 2061   ------convert a
-00005e60: 6c6c 2032 4420 6172 7261 7973 2069 6e74  ll 2D arrays int
-00005e70: 6f20 3144 2074 6f20 7370 6565 6420 7570  o 1D to speed up
-00005e80: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 6f72  --------.    cor
-00005e90: 7220 3d20 6e70 2e7a 6572 6f73 286e 7769  r = np.zeros(nwi
-00005ea0: 6e20 2a20 4e66 6674 322c 2064 7479 7065  n * Nfft2, dtype
-00005eb0: 3d6e 702e 636f 6d70 6c65 7836 3429 0a20  =np.complex64). 
-00005ec0: 2020 2063 6f72 7220 3d20 6666 7431 5f73     corr = fft1_s
-00005ed0: 6d6f 6f74 6865 645f 6162 732e 7265 7368  moothed_abs.resh
-00005ee0: 6170 6528 0a20 2020 2020 2020 2066 6674  ape(.        fft
-00005ef0: 315f 736d 6f6f 7468 6564 5f61 6273 2e73  1_smoothed_abs.s
-00005f00: 697a 652c 0a20 2020 2029 202a 2066 6674  ize,.    ) * fft
-00005f10: 322e 7265 7368 6170 6528 0a20 2020 2020  2.reshape(.     
-00005f20: 2020 2066 6674 322e 7369 7a65 2c0a 2020     fft2.size,.  
-00005f30: 2020 290a 0a20 2020 2069 6620 6d65 7468    )..    if meth
-00005f40: 6f64 203d 3d20 2263 6f68 6572 656e 6379  od == "coherency
-00005f50: 223a 0a20 2020 2020 2020 2074 656d 7020  ":.        temp 
-00005f60: 3d20 6d6f 7669 6e67 5f61 7665 280a 2020  = moving_ave(.  
-00005f70: 2020 2020 2020 2020 2020 6e70 2e61 6273            np.abs
-00005f80: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00005f90: 2020 6666 7432 2e72 6573 6861 7065 280a    fft2.reshape(.
-00005fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005fb0: 2020 2020 6666 7432 2e73 697a 652c 0a20      fft2.size,. 
-00005fc0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00005fd0: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
-00005fe0: 2020 2020 2020 2020 2020 2020 736d 6f6f              smoo
-00005ff0: 7468 7370 6563 745f 4e2c 0a20 2020 2020  thspect_N,.     
-00006000: 2020 2029 0a20 2020 2020 2020 2063 6f72     ).        cor
-00006010: 7220 2f3d 2074 656d 700a 2020 2020 636f  r /= temp.    co
-00006020: 7272 203d 2063 6f72 722e 7265 7368 6170  rr = corr.reshap
-00006030: 6528 6e77 696e 2c20 4e66 6674 3229 0a0a  e(nwin, Nfft2)..
-00006040: 2020 2020 6966 2073 7562 7374 6163 6b3a      if substack:
-00006050: 0a20 2020 2020 2020 2069 6620 7375 6273  .        if subs
-00006060: 7461 636b 5f6c 656e 203d 3d20 6363 5f6c  tack_len == cc_l
-00006070: 656e 3a0a 2020 2020 2020 2020 2020 2020  en:.            
-00006080: 2320 6368 6f6f 7365 2074 6f20 6b65 6570  # choose to keep
-00006090: 2061 6c6c 2066 6674 2064 6174 6120 666f   all fft data fo
-000060a0: 7220 6120 6461 790a 2020 2020 2020 2020  r a day.        
-000060b0: 2020 2020 735f 636f 7272 203d 206e 702e      s_corr = np.
-000060c0: 7a65 726f 7328 7368 6170 653d 286e 7769  zeros(shape=(nwi
-000060d0: 6e2c 204e 6666 7429 2c20 6474 7970 653d  n, Nfft), dtype=
-000060e0: 6e70 2e66 6c6f 6174 3332 2920 2023 2073  np.float32)  # s
-000060f0: 7461 636b 6564 2063 6f72 7265 6c61 7469  tacked correlati
-00006100: 6f6e 0a20 2020 2020 2020 2020 2020 2061  on.            a
-00006110: 6d70 6d61 7820 3d20 6e70 2e7a 6572 6f73  mpmax = np.zeros
-00006120: 286e 7769 6e2c 2064 7479 7065 3d6e 702e  (nwin, dtype=np.
-00006130: 666c 6f61 7433 3229 0a20 2020 2020 2020  float32).       
-00006140: 2020 2020 206e 5f63 6f72 7220 3d20 6e70       n_corr = np
-00006150: 2e7a 6572 6f73 286e 7769 6e2c 2064 7479  .zeros(nwin, dty
-00006160: 7065 3d6e 702e 696e 7431 3629 2020 2320  pe=np.int16)  # 
-00006170: 6e75 6d62 6572 206f 6620 636f 7272 656c  number of correl
-00006180: 6174 696f 6e73 2066 6f72 2065 6163 6820  ations for each 
-00006190: 7375 6273 7461 636b 0a20 2020 2020 2020  substack.       
-000061a0: 2020 2020 2074 5f63 6f72 7220 3d20 6461       t_corr = da
-000061b0: 7461 535f 7420 2023 2074 696d 6573 7461  taS_t  # timesta
-000061c0: 6d70 0a20 2020 2020 2020 2020 2020 2063  mp.            c
-000061d0: 7261 7020 3d20 6e70 2e7a 6572 6f73 284e  rap = np.zeros(N
-000061e0: 6666 742c 2064 7479 7065 3d6e 702e 636f  fft, dtype=np.co
-000061f0: 6d70 6c65 7836 3429 0a20 2020 2020 2020  mplex64).       
-00006200: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
-00006210: 6e67 6528 6e77 696e 293a 0a20 2020 2020  nge(nwin):.     
-00006220: 2020 2020 2020 2020 2020 206e 5f63 6f72             n_cor
-00006230: 725b 695d 203d 2031 0a20 2020 2020 2020  r[i] = 1.       
-00006240: 2020 2020 2020 2020 2063 7261 705b 3a4e           crap[:N
-00006250: 6666 7432 5d20 3d20 636f 7272 5b69 2c20  fft2] = corr[i, 
-00006260: 3a5d 0a20 2020 2020 2020 2020 2020 2020  :].             
-00006270: 2020 2063 7261 705b 3a4e 6666 7432 5d20     crap[:Nfft2] 
-00006280: 3d20 6372 6170 5b3a 4e66 6674 325d 202d  = crap[:Nfft2] -
-00006290: 206e 702e 6d65 616e 2863 7261 705b 3a4e   np.mean(crap[:N
-000062a0: 6666 7432 5d29 2020 2320 7265 6d6f 7665  fft2])  # remove
-000062b0: 2074 6865 206d 6561 6e20 696e 2066 7265   the mean in fre
-000062c0: 7120 646f 6d61 696e 2028 7370 696b 6520  q domain (spike 
-000062d0: 6174 2074 3d30 290a 2020 2020 2020 2020  at t=0).        
-000062e0: 2020 2020 2020 2020 6372 6170 5b2d 284e          crap[-(N
-000062f0: 6666 7432 2920 2b20 3120 3a5d 203d 206e  fft2) + 1 :] = n
-00006300: 702e 666c 6970 286e 702e 636f 6e6a 2863  p.flip(np.conj(c
-00006310: 7261 705b 313a 284e 6666 7432 295d 292c  rap[1:(Nfft2)]),
-00006320: 2061 7869 733d 3029 0a20 2020 2020 2020   axis=0).       
-00006330: 2020 2020 2020 2020 2063 7261 705b 305d           crap[0]
-00006340: 203d 2063 6f6d 706c 6578 2830 2c20 3029   = complex(0, 0)
-00006350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006360: 2073 5f63 6f72 725b 692c 203a 5d20 3d20   s_corr[i, :] = 
-00006370: 6e70 2e72 6561 6c28 6e70 2e66 6674 2e69  np.real(np.fft.i
-00006380: 6666 7473 6869 6674 2873 6369 7079 2e66  fftshift(scipy.f
-00006390: 6674 7061 636b 2e69 6666 7428 6372 6170  ftpack.ifft(crap
-000063a0: 2c20 4e66 6674 2c20 6178 6973 3d30 2929  , Nfft, axis=0))
-000063b0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-000063c0: 2072 656d 6f76 6520 6162 6e6f 726d 616c   remove abnormal
-000063d0: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
-000063e0: 2020 616d 706d 6178 203d 206e 702e 6d61    ampmax = np.ma
-000063f0: 7828 735f 636f 7272 2c20 6178 6973 3d31  x(s_corr, axis=1
-00006400: 290a 2020 2020 2020 2020 2020 2020 7469  ).            ti
-00006410: 6e64 7820 3d20 6e70 2e77 6865 7265 2828  ndx = np.where((
-00006420: 616d 706d 6178 203c 2032 3020 2a20 6e70  ampmax < 20 * np
-00006430: 2e6d 6564 6961 6e28 616d 706d 6178 2929  .median(ampmax))
-00006440: 2026 2028 616d 706d 6178 203e 2030 2929   & (ampmax > 0))
-00006450: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-00006460: 735f 636f 7272 203d 2073 5f63 6f72 725b  s_corr = s_corr[
-00006470: 7469 6e64 782c 203a 5d0a 2020 2020 2020  tindx, :].      
-00006480: 2020 2020 2020 745f 636f 7272 203d 2074        t_corr = t
-00006490: 5f63 6f72 725b 7469 6e64 785d 0a20 2020  _corr[tindx].   
-000064a0: 2020 2020 2020 2020 206e 5f63 6f72 7220           n_corr 
-000064b0: 3d20 6e5f 636f 7272 5b74 696e 6478 5d0a  = n_corr[tindx].
-000064c0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000064d0: 2020 2020 2020 2020 2020 2023 2067 6574             # get
-000064e0: 2074 696d 6520 696e 666f 726d 6174 696f   time informatio
-000064f0: 6e0a 2020 2020 2020 2020 2020 2020 5474  n.            Tt
-00006500: 6f74 616c 203d 2064 6174 6153 5f74 5b2d  otal = dataS_t[-
-00006510: 315d 202d 2064 6174 6153 5f74 5b30 5d20  1] - dataS_t[0] 
-00006520: 2023 2074 6f74 616c 2064 7572 6174 696f   # total duratio
-00006530: 6e20 6f66 2077 6861 7420 7765 2068 6176  n of what we hav
-00006540: 6520 6e6f 770a 2020 2020 2020 2020 2020  e now.          
-00006550: 2020 7473 7461 7274 203d 2064 6174 6153    tstart = dataS
-00006560: 5f74 5b30 5d0a 0a20 2020 2020 2020 2020  _t[0]..         
-00006570: 2020 206e 7374 6163 6b20 3d20 696e 7428     nstack = int(
-00006580: 6e70 2e72 6f75 6e64 2854 746f 7461 6c20  np.round(Ttotal 
-00006590: 2f20 7375 6273 7461 636b 5f6c 656e 2929  / substack_len))
-000065a0: 0a20 2020 2020 2020 2020 2020 2061 6d70  .            amp
-000065b0: 6d61 7820 3d20 6e70 2e7a 6572 6f73 286e  max = np.zeros(n
-000065c0: 7374 6163 6b2c 2064 7479 7065 3d6e 702e  stack, dtype=np.
-000065d0: 666c 6f61 7433 3229 0a20 2020 2020 2020  float32).       
-000065e0: 2020 2020 2073 5f63 6f72 7220 3d20 6e70       s_corr = np
-000065f0: 2e7a 6572 6f73 2873 6861 7065 3d28 6e73  .zeros(shape=(ns
-00006600: 7461 636b 2c20 4e66 6674 292c 2064 7479  tack, Nfft), dty
-00006610: 7065 3d6e 702e 666c 6f61 7433 3229 0a20  pe=np.float32). 
-00006620: 2020 2020 2020 2020 2020 206e 5f63 6f72             n_cor
-00006630: 7220 3d20 6e70 2e7a 6572 6f73 286e 7374  r = np.zeros(nst
-00006640: 6163 6b2c 2064 7479 7065 3d6e 702e 696e  ack, dtype=np.in
-00006650: 7429 0a20 2020 2020 2020 2020 2020 2074  t).            t
-00006660: 5f63 6f72 7220 3d20 6e70 2e7a 6572 6f73  _corr = np.zeros
-00006670: 286e 7374 6163 6b2c 2064 7479 7065 3d6e  (nstack, dtype=n
-00006680: 702e 666c 6f61 7429 0a20 2020 2020 2020  p.float).       
-00006690: 2020 2020 2063 7261 7020 3d20 6e70 2e7a       crap = np.z
-000066a0: 6572 6f73 284e 6666 742c 2064 7479 7065  eros(Nfft, dtype
-000066b0: 3d6e 702e 636f 6d70 6c65 7836 3429 0a0a  =np.complex64)..
-000066c0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000066d0: 6973 7461 636b 2069 6e20 7261 6e67 6528  istack in range(
-000066e0: 6e73 7461 636b 293a 0a20 2020 2020 2020  nstack):.       
-000066f0: 2020 2020 2020 2020 2023 2066 696e 6420           # find 
-00006700: 7468 6520 696e 6465 7865 7320 6f66 2061  the indexes of a
-00006710: 6c6c 206f 6620 7468 6520 7769 6e64 6f77  ll of the window
-00006720: 7320 7468 6174 2073 7461 7274 206f 7220  s that start or 
-00006730: 656e 6420 7769 7468 696e 0a20 2020 2020  end within.     
-00006740: 2020 2020 2020 2020 2020 2069 7469 6d65             itime
-00006750: 203d 206e 702e 7768 6572 6528 2864 6174   = np.where((dat
-00006760: 6153 5f74 203e 3d20 7473 7461 7274 2920  aS_t >= tstart) 
-00006770: 2620 2864 6174 6153 5f74 203c 2074 7374  & (dataS_t < tst
-00006780: 6172 7420 2b20 7375 6273 7461 636b 5f6c  art + substack_l
-00006790: 656e 2929 5b30 5d0a 2020 2020 2020 2020  en))[0].        
-000067a0: 2020 2020 2020 2020 6966 206c 656e 2869          if len(i
-000067b0: 7469 6d65 2920 3d3d 2030 3a0a 2020 2020  time) == 0:.    
-000067c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000067d0: 7473 7461 7274 202b 3d20 7375 6273 7461  tstart += substa
-000067e0: 636b 5f6c 656e 0a20 2020 2020 2020 2020  ck_len.         
-000067f0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00006800: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
-00006810: 2020 2020 2063 7261 705b 3a4e 6666 7432       crap[:Nfft2
-00006820: 5d20 3d20 6e70 2e6d 6561 6e28 636f 7272  ] = np.mean(corr
-00006830: 5b69 7469 6d65 2c20 3a5d 2c20 6178 6973  [itime, :], axis
-00006840: 3d30 2920 2023 206c 696e 6561 7220 6176  =0)  # linear av
-00006850: 6572 6167 6520 6f66 2074 6865 2063 6f72  erage of the cor
-00006860: 7265 6c61 7469 6f6e 0a20 2020 2020 2020  relation.       
-00006870: 2020 2020 2020 2020 2063 7261 705b 3a4e           crap[:N
-00006880: 6666 7432 5d20 3d20 6372 6170 5b3a 4e66  fft2] = crap[:Nf
-00006890: 6674 325d 202d 206e 702e 6d65 616e 2863  ft2] - np.mean(c
-000068a0: 7261 705b 3a4e 6666 7432 5d29 2020 2320  rap[:Nfft2])  # 
-000068b0: 7265 6d6f 7665 2074 6865 206d 6561 6e20  remove the mean 
-000068c0: 696e 2066 7265 7120 646f 6d61 696e 2028  in freq domain (
-000068d0: 7370 696b 6520 6174 2074 3d30 290a 2020  spike at t=0).  
-000068e0: 2020 2020 2020 2020 2020 2020 2020 6372                cr
-000068f0: 6170 5b2d 284e 6666 7432 2920 2b20 3120  ap[-(Nfft2) + 1 
-00006900: 3a5d 203d 206e 702e 666c 6970 286e 702e  :] = np.flip(np.
-00006910: 636f 6e6a 2863 7261 705b 313a 284e 6666  conj(crap[1:(Nff
-00006920: 7432 295d 292c 2061 7869 733d 3029 0a20  t2)]), axis=0). 
-00006930: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00006940: 7261 705b 305d 203d 2063 6f6d 706c 6578  rap[0] = complex
-00006950: 2830 2c20 3029 0a20 2020 2020 2020 2020  (0, 0).         
-00006960: 2020 2020 2020 2073 5f63 6f72 725b 6973         s_corr[is
-00006970: 7461 636b 2c20 3a5d 203d 206e 702e 7265  tack, :] = np.re
-00006980: 616c 286e 702e 6666 742e 6966 6674 7368  al(np.fft.ifftsh
-00006990: 6966 7428 7363 6970 792e 6666 7470 6163  ift(scipy.fftpac
-000069a0: 6b2e 6966 6674 2863 7261 702c 204e 6666  k.ifft(crap, Nff
-000069b0: 742c 2061 7869 733d 3029 2929 0a20 2020  t, axis=0))).   
-000069c0: 2020 2020 2020 2020 2020 2020 206e 5f63               n_c
-000069d0: 6f72 725b 6973 7461 636b 5d20 3d20 6c65  orr[istack] = le
-000069e0: 6e28 6974 696d 6529 2020 2320 6e75 6d62  n(itime)  # numb
-000069f0: 6572 206f 6620 7769 6e64 6f77 7320 7374  er of windows st
-00006a00: 6163 6b73 0a20 2020 2020 2020 2020 2020  acks.           
-00006a10: 2020 2020 2074 5f63 6f72 725b 6973 7461       t_corr[ista
-00006a20: 636b 5d20 3d20 7473 7461 7274 2020 2320  ck] = tstart  # 
-00006a30: 7361 7665 2074 6865 2074 696d 6520 7374  save the time st
-00006a40: 616d 7073 0a20 2020 2020 2020 2020 2020  amps.           
-00006a50: 2020 2020 2074 7374 6172 7420 2b3d 2073       tstart += s
-00006a60: 7562 7374 6163 6b5f 6c65 6e0a 2020 2020  ubstack_len.    
-00006a70: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
-00006a80: 696e 7428 2763 6f72 7265 6c61 7469 6f6e  int('correlation
-00006a90: 2064 6f6e 6520 616e 6420 7374 6163 6b65   done and stacke
-00006aa0: 6420 6174 2074 696d 6520 2573 2720 2520  d at time %s' % 
-00006ab0: 7374 7228 745f 636f 7272 5b69 7374 6163  str(t_corr[istac
-00006ac0: 6b5d 2929 0a0a 2020 2020 2020 2020 2020  k]))..          
-00006ad0: 2020 2320 7265 6d6f 7665 2061 626e 6f72    # remove abnor
-00006ae0: 6d61 6c20 6461 7461 0a20 2020 2020 2020  mal data.       
-00006af0: 2020 2020 2061 6d70 6d61 7820 3d20 6e70       ampmax = np
-00006b00: 2e6d 6178 2873 5f63 6f72 722c 2061 7869  .max(s_corr, axi
-00006b10: 733d 3129 0a20 2020 2020 2020 2020 2020  s=1).           
-00006b20: 2074 696e 6478 203d 206e 702e 7768 6572   tindx = np.wher
-00006b30: 6528 2861 6d70 6d61 7820 3c20 3230 202a  e((ampmax < 20 *
-00006b40: 206e 702e 6d65 6469 616e 2861 6d70 6d61   np.median(ampma
-00006b50: 7829 2920 2620 2861 6d70 6d61 7820 3e20  x)) & (ampmax > 
-00006b60: 3029 295b 305d 0a20 2020 2020 2020 2020  0))[0].         
-00006b70: 2020 2073 5f63 6f72 7220 3d20 735f 636f     s_corr = s_co
-00006b80: 7272 5b74 696e 6478 2c20 3a5d 0a20 2020  rr[tindx, :].   
-00006b90: 2020 2020 2020 2020 2074 5f63 6f72 7220           t_corr 
-00006ba0: 3d20 745f 636f 7272 5b74 696e 6478 5d0a  = t_corr[tindx].
-00006bb0: 2020 2020 2020 2020 2020 2020 6e5f 636f              n_co
-00006bc0: 7272 203d 206e 5f63 6f72 725b 7469 6e64  rr = n_corr[tind
-00006bd0: 785d 0a0a 2020 2020 656c 7365 3a0a 2020  x]..    else:.  
-00006be0: 2020 2020 2020 2320 6176 6572 6167 6520        # average 
-00006bf0: 6461 696c 7920 6372 6f73 7320 636f 7272  daily cross corr
-00006c00: 656c 6174 696f 6e20 6675 6e63 7469 6f6e  elation function
-00006c10: 730a 2020 2020 2020 2020 616d 706d 6178  s.        ampmax
-00006c20: 203d 206e 702e 6d61 7828 636f 7272 2c20   = np.max(corr, 
-00006c30: 6178 6973 3d31 290a 2020 2020 2020 2020  axis=1).        
-00006c40: 7469 6e64 7820 3d20 6e70 2e77 6865 7265  tindx = np.where
-00006c50: 2828 616d 706d 6178 203c 2032 3020 2a20  ((ampmax < 20 * 
-00006c60: 6e70 2e6d 6564 6961 6e28 616d 706d 6178  np.median(ampmax
-00006c70: 2929 2026 2028 616d 706d 6178 203e 2030  )) & (ampmax > 0
-00006c80: 2929 5b30 5d0a 2020 2020 2020 2020 6e5f  ))[0].        n_
-00006c90: 636f 7272 203d 206e 7769 6e0a 2020 2020  corr = nwin.    
-00006ca0: 2020 2020 735f 636f 7272 203d 206e 702e      s_corr = np.
-00006cb0: 7a65 726f 7328 4e66 6674 2c20 6474 7970  zeros(Nfft, dtyp
-00006cc0: 653d 6e70 2e66 6c6f 6174 3332 290a 2020  e=np.float32).  
-00006cd0: 2020 2020 2020 745f 636f 7272 203d 2064        t_corr = d
-00006ce0: 6174 6153 5f74 5b30 5d0a 2020 2020 2020  ataS_t[0].      
-00006cf0: 2020 6372 6170 203d 206e 702e 7a65 726f    crap = np.zero
-00006d00: 7328 4e66 6674 2c20 6474 7970 653d 6e70  s(Nfft, dtype=np
-00006d10: 2e63 6f6d 706c 6578 3634 290a 2020 2020  .complex64).    
-00006d20: 2020 2020 6372 6170 5b3a 4e66 6674 325d      crap[:Nfft2]
-00006d30: 203d 206e 702e 6d65 616e 2863 6f72 725b   = np.mean(corr[
-00006d40: 7469 6e64 785d 2c20 6178 6973 3d30 290a  tindx], axis=0).
-00006d50: 2020 2020 2020 2020 6372 6170 5b3a 4e66          crap[:Nf
-00006d60: 6674 325d 203d 2063 7261 705b 3a4e 6666  ft2] = crap[:Nff
-00006d70: 7432 5d20 2d20 6e70 2e6d 6561 6e28 6372  t2] - np.mean(cr
-00006d80: 6170 5b3a 4e66 6674 325d 2c20 6178 6973  ap[:Nfft2], axis
-00006d90: 3d30 290a 2020 2020 2020 2020 6372 6170  =0).        crap
-00006da0: 5b2d 284e 6666 7432 2920 2b20 3120 3a5d  [-(Nfft2) + 1 :]
-00006db0: 203d 206e 702e 666c 6970 286e 702e 636f   = np.flip(np.co
-00006dc0: 6e6a 2863 7261 705b 313a 284e 6666 7432  nj(crap[1:(Nfft2
-00006dd0: 295d 292c 2061 7869 733d 3029 0a20 2020  )]), axis=0).   
-00006de0: 2020 2020 2073 5f63 6f72 7220 3d20 6e70       s_corr = np
-00006df0: 2e72 6561 6c28 6e70 2e66 6674 2e69 6666  .real(np.fft.iff
-00006e00: 7473 6869 6674 2873 6369 7079 2e66 6674  tshift(scipy.fft
-00006e10: 7061 636b 2e69 6666 7428 6372 6170 2c20  pack.ifft(crap, 
-00006e20: 4e66 6674 2c20 6178 6973 3d30 2929 290a  Nfft, axis=0))).
-00006e30: 0a20 2020 2023 2074 7269 6d20 7468 6520  .    # trim the 
-00006e40: 4343 4673 2069 6e20 5b2d 6d61 786c 6167  CCFs in [-maxlag
-00006e50: 206d 6178 6c61 675d 0a20 2020 2074 203d   maxlag].    t =
-00006e60: 206e 702e 6172 616e 6765 282d 4e66 6674   np.arange(-Nfft
-00006e70: 3220 2b20 312c 204e 6666 7432 2920 2a20  2 + 1, Nfft2) * 
-00006e80: 6474 0a20 2020 2069 6e64 203d 206e 702e  dt.    ind = np.
-00006e90: 7768 6572 6528 6e70 2e61 6273 2874 2920  where(np.abs(t) 
-00006ea0: 3c3d 206d 6178 6c61 6729 5b30 5d0a 2020  <= maxlag)[0].  
-00006eb0: 2020 6966 2073 5f63 6f72 722e 6e64 696d    if s_corr.ndim
-00006ec0: 203d 3d20 313a 0a20 2020 2020 2020 2073   == 1:.        s
-00006ed0: 5f63 6f72 7220 3d20 735f 636f 7272 5b69  _corr = s_corr[i
-00006ee0: 6e64 5d0a 2020 2020 656c 6966 2073 5f63  nd].    elif s_c
-00006ef0: 6f72 722e 6e64 696d 203d 3d20 323a 0a20  orr.ndim == 2:. 
-00006f00: 2020 2020 2020 2073 5f63 6f72 7220 3d20         s_corr = 
-00006f10: 735f 636f 7272 5b3a 2c20 696e 645d 0a20  s_corr[:, ind]. 
-00006f20: 2020 2072 6574 7572 6e20 735f 636f 7272     return s_corr
-00006f30: 2c20 745f 636f 7272 2c20 6e5f 636f 7272  , t_corr, n_corr
-00006f40: 0a0a 0a64 6566 2063 6f72 7265 6c61 7465  ...def correlate
-00006f50: 5f6e 6f6e 6c69 6e65 6172 5f73 7461 636b  _nonlinear_stack
-00006f60: 2866 6674 315f 736d 6f6f 7468 6564 5f61  (fft1_smoothed_a
-00006f70: 6273 2c20 6666 7432 2c20 442c 204e 6666  bs, fft2, D, Nff
-00006f80: 742c 2064 6174 6153 5f74 293a 0a20 2020  t, dataS_t):.   
-00006f90: 2022 2222 0a20 2020 2074 6869 7320 6675   """.    this fu
-00006fa0: 6e63 7469 6f6e 2064 6f65 7320 7468 6520  nction does the 
-00006fb0: 6372 6f73 732d 636f 7272 656c 6174 696f  cross-correlatio
-00006fc0: 6e20 696e 2066 7265 7120 646f 6d61 696e  n in freq domain
-00006fd0: 2061 6e64 2068 6173 2074 6865 206f 7074   and has the opt
-00006fe0: 696f 6e20 746f 206b 6565 7020 7375 622d  ion to keep sub-
-00006ff0: 7374 6163 6b73 206f 660a 2020 2020 7468  stacks of.    th
-00007000: 6520 6372 6f73 732d 636f 7272 656c 6174  e cross-correlat
-00007010: 696f 6e20 6966 206e 6565 6465 642e 2069  ion if needed. i
-00007020: 7420 7461 6b65 7320 6164 7661 6e74 6167  t takes advantag
-00007030: 6520 6f66 2074 6865 206c 696e 6561 7220  e of the linear 
-00007040: 7265 6c61 7469 6f6e 7368 6970 206f 6620  relationship of 
-00007050: 6966 6674 2c20 736f 2074 6861 740a 2020  ifft, so that.  
-00007060: 2020 7374 6163 6b69 6e67 2069 7320 7065    stacking is pe
-00007070: 7266 6f72 6d65 6420 696e 2073 7065 6374  rformed in spect
-00007080: 7275 6d20 646f 6d61 696e 2066 6972 7374  rum domain first
-00007090: 2074 6f20 7265 6475 6365 2074 6865 2074   to reduce the t
-000070a0: 6f74 616c 206e 756d 6265 7220 6f66 2069  otal number of i
-000070b0: 6666 742e 2028 7573 6564 2069 6e20 5331  fft. (used in S1
-000070c0: 290a 2020 2020 5041 5241 4d45 5445 5253  ).    PARAMETERS
-000070d0: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
-000070e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
-000070f0: 6666 7431 5f73 6d6f 6f74 6865 645f 6162  fft1_smoothed_ab
-00007100: 733a 2073 6d6f 6f74 6865 6420 706f 7765  s: smoothed powe
-00007110: 7220 7370 6563 7472 616c 2064 656e 7369  r spectral densi
-00007120: 7479 206f 6620 7468 6520 4646 5420 666f  ty of the FFT fo
-00007130: 7220 7468 6520 736f 7572 6365 2073 7461  r the source sta
-00007140: 7469 6f6e 0a20 2020 2066 6674 323a 2072  tion.    fft2: r
-00007150: 6177 2046 4654 2073 7065 6374 7275 6d20  aw FFT spectrum 
-00007160: 6f66 2074 6865 2072 6563 6569 7665 7220  of the receiver 
-00007170: 7374 6174 696f 6e0a 2020 2020 443a 2064  station.    D: d
-00007180: 6963 7469 6f6e 6172 7920 636f 6e74 6169  ictionary contai
-00007190: 6e69 6e67 2066 6f6c 6c6f 7769 6e67 2070  ning following p
-000071a0: 6172 616d 6574 6572 733a 0a20 2020 2020  arameters:.     
-000071b0: 2020 206d 6178 6c61 673a 2020 6d61 7869     maxlag:  maxi
-000071c0: 6d75 6d20 6c61 6773 2074 6f20 6b65 6570  mum lags to keep
-000071d0: 2069 6e20 7468 6520 6372 6f73 7320 636f   in the cross co
-000071e0: 7272 656c 6174 696f 6e0a 2020 2020 2020  rrelation.      
-000071f0: 2020 6474 3a20 2020 2020 2073 616d 706c    dt:      sampl
-00007200: 696e 6720 7261 7465 2028 696e 2073 290a  ing rate (in s).
-00007210: 2020 2020 2020 2020 6e77 696e 3a20 2020          nwin:   
-00007220: 206e 756d 6265 7220 6f66 2073 6567 6d65   number of segme
-00007230: 6e74 7320 696e 2074 6865 2032 4420 6d61  nts in the 2D ma
-00007240: 7472 6978 0a20 2020 2020 2020 206d 6574  trix.        met
-00007250: 686f 643a 2020 6372 6f73 732d 636f 7272  hod:  cross-corr
-00007260: 656c 6174 696f 6e20 6d65 7468 6f64 7320  elation methods 
-00007270: 7365 6c65 6374 6564 2062 7920 7468 6520  selected by the 
-00007280: 7573 6572 0a20 2020 2020 2020 2066 7265  user.        fre
-00007290: 716d 696e 3a20 6d69 6e69 6d75 6d20 6672  qmin: minimum fr
-000072a0: 6571 7565 6e63 7920 2848 7a29 0a20 2020  equency (Hz).   
-000072b0: 2020 2020 2066 7265 716d 6178 3a20 6d61       freqmax: ma
-000072c0: 7869 6d75 6d20 6672 6571 7565 6e63 7920  ximum frequency 
-000072d0: 2848 7a29 0a20 2020 204e 6666 743a 2020  (Hz).    Nfft:  
-000072e0: 2020 6e75 6d62 6572 206f 6620 6672 6571    number of freq
-000072f0: 7565 6e63 7920 706f 696e 7473 2066 6f72  uency points for
-00007300: 2069 6666 740a 2020 2020 6461 7461 535f   ifft.    dataS_
-00007310: 743a 206d 6174 7269 7820 6f66 2064 6174  t: matrix of dat
-00007320: 6574 696d 6520 6f62 6a65 6374 2e0a 2020  etime object..  
-00007330: 2020 5245 5455 524e 533a 0a20 2020 202d    RETURNS:.    -
-00007340: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00007350: 2d2d 2d2d 0a20 2020 2073 5f63 6f72 723a  ----.    s_corr:
-00007360: 2031 4420 6f72 2032 4420 6d61 7472 6978   1D or 2D matrix
-00007370: 206f 6620 7468 6520 6176 6572 6167 6564   of the averaged
-00007380: 206f 7220 7375 622d 7374 6163 6b73 206f   or sub-stacks o
-00007390: 6620 6372 6f73 732d 636f 7272 656c 6174  f cross-correlat
-000073a0: 696f 6e20 6675 6e63 7469 6f6e 7320 696e  ion functions in
-000073b0: 2074 696d 6520 646f 6d61 696e 0a20 2020   time domain.   
-000073c0: 2074 5f63 6f72 723a 2074 696d 6573 7461   t_corr: timesta
-000073d0: 6d70 2066 6f72 2065 6163 6820 7375 622d  mp for each sub-
-000073e0: 7374 6163 6b20 6f72 2061 7665 7261 6765  stack or average
-000073f0: 6420 6675 6e63 7469 6f6e 0a20 2020 206e  d function.    n
-00007400: 5f63 6f72 723a 206e 756d 6265 7220 6f66  _corr: number of
-00007410: 2069 6e63 6c75 6465 6420 7365 676d 656e   included segmen
-00007420: 7473 2066 6f72 2065 6163 6820 7375 622d  ts for each sub-
-00007430: 7374 6163 6b20 6f72 2061 7665 7261 6765  stack or average
-00007440: 6420 6675 6e63 7469 6f6e 0a20 2020 2022  d function.    "
-00007450: 2222 0a20 2020 2023 202d 2d2d 2d6c 6f61  "".    # ----loa
-00007460: 6420 7061 7261 6d74 6572 732d 2d2d 2d0a  d paramters----.
-00007470: 2020 2020 6474 203d 2044 5b22 6474 225d      dt = D["dt"]
-00007480: 0a20 2020 206d 6178 6c61 6720 3d20 445b  .    maxlag = D[
-00007490: 226d 6178 6c61 6722 5d0a 2020 2020 6d65  "maxlag"].    me
-000074a0: 7468 6f64 203d 2044 5b22 6363 5f6d 6574  thod = D["cc_met
-000074b0: 686f 6422 5d0a 2020 2020 6363 5f6c 656e  hod"].    cc_len
-000074c0: 203d 2044 5b22 6363 5f6c 656e 225d 0a20   = D["cc_len"]. 
-000074d0: 2020 2073 7562 7374 6163 6b20 3d20 445b     substack = D[
-000074e0: 2273 7562 7374 6163 6b22 5d0a 2020 2020  "substack"].    
-000074f0: 7374 6163 6b5f 6d65 7468 6f64 203d 2044  stack_method = D
-00007500: 5b22 7374 6163 6b5f 6d65 7468 6f64 225d  ["stack_method"]
-00007510: 0a20 2020 2073 7562 7374 6163 6b5f 6c65  .    substack_le
-00007520: 6e20 3d20 445b 2273 7562 7374 6163 6b5f  n = D["substack_
-00007530: 6c65 6e22 5d0a 2020 2020 736d 6f6f 7468  len"].    smooth
-00007540: 7370 6563 745f 4e20 3d20 445b 2273 6d6f  spect_N = D["smo
-00007550: 6f74 6873 7065 6374 5f4e 225d 0a0a 2020  othspect_N"]..  
-00007560: 2020 6e77 696e 203d 2066 6674 315f 736d    nwin = fft1_sm
-00007570: 6f6f 7468 6564 5f61 6273 2e73 6861 7065  oothed_abs.shape
-00007580: 5b30 5d0a 2020 2020 4e66 6674 3220 3d20  [0].    Nfft2 = 
-00007590: 6666 7431 5f73 6d6f 6f74 6865 645f 6162  fft1_smoothed_ab
-000075a0: 732e 7368 6170 655b 315d 0a0a 2020 2020  s.shape[1]..    
-000075b0: 2320 2d2d 2d2d 2d2d 636f 6e76 6572 7420  # ------convert 
-000075c0: 616c 6c20 3244 2061 7272 6179 7320 696e  all 2D arrays in
-000075d0: 746f 2031 4420 746f 2073 7065 6564 2075  to 1D to speed u
-000075e0: 702d 2d2d 2d2d 2d2d 2d0a 2020 2020 636f  p--------.    co
-000075f0: 7272 203d 206e 702e 7a65 726f 7328 6e77  rr = np.zeros(nw
-00007600: 696e 202a 204e 6666 7432 2c20 6474 7970  in * Nfft2, dtyp
-00007610: 653d 6e70 2e63 6f6d 706c 6578 3634 290a  e=np.complex64).
-00007620: 2020 2020 636f 7272 203d 2066 6674 315f      corr = fft1_
-00007630: 736d 6f6f 7468 6564 5f61 6273 2e72 6573  smoothed_abs.res
-00007640: 6861 7065 280a 2020 2020 2020 2020 6666  hape(.        ff
-00007650: 7431 5f73 6d6f 6f74 6865 645f 6162 732e  t1_smoothed_abs.
-00007660: 7369 7a65 2c0a 2020 2020 2920 2a20 6666  size,.    ) * ff
-00007670: 7432 2e72 6573 6861 7065 280a 2020 2020  t2.reshape(.    
-00007680: 2020 2020 6666 7432 2e73 697a 652c 0a20      fft2.size,. 
-00007690: 2020 2029 0a0a 2020 2020 2320 6e6f 726d     )..    # norm
-000076a0: 616c 697a 6520 6279 2072 6563 6569 7665  alize by receive
-000076b0: 7220 7370 6563 7472 616c 2066 6f72 2063  r spectral for c
-000076c0: 6f68 6572 656e 6379 0a20 2020 2069 6620  oherency.    if 
-000076d0: 6d65 7468 6f64 203d 3d20 2263 6f68 6572  method == "coher
-000076e0: 656e 6379 223a 0a20 2020 2020 2020 2074  ency":.        t
-000076f0: 656d 7020 3d20 6d6f 7669 6e67 5f61 7665  emp = moving_ave
-00007700: 280a 2020 2020 2020 2020 2020 2020 6e70  (.            np
-00007710: 2e61 6273 280a 2020 2020 2020 2020 2020  .abs(.          
-00007720: 2020 2020 2020 6666 7432 2e72 6573 6861        fft2.resha
-00007730: 7065 280a 2020 2020 2020 2020 2020 2020  pe(.            
-00007740: 2020 2020 2020 2020 6666 7432 2e73 697a          fft2.siz
-00007750: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00007760: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00007770: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-00007780: 736d 6f6f 7468 7370 6563 745f 4e2c 0a20  smoothspect_N,. 
-00007790: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000077a0: 2063 6f72 7220 2f3d 2074 656d 700a 2020   corr /= temp.  
-000077b0: 2020 636f 7272 203d 2063 6f72 722e 7265    corr = corr.re
-000077c0: 7368 6170 6528 6e77 696e 2c20 4e66 6674  shape(nwin, Nfft
-000077d0: 3229 0a0a 2020 2020 2320 7472 616e 7366  2)..    # transf
-000077e0: 6f72 6d20 6261 636b 2074 6f20 7469 6d65  orm back to time
-000077f0: 2064 6f6d 6169 6e20 7761 7665 666f 726d   domain waveform
-00007800: 730a 2020 2020 735f 636f 7272 203d 206e  s.    s_corr = n
-00007810: 702e 7a65 726f 7328 7368 6170 653d 286e  p.zeros(shape=(n
-00007820: 7769 6e2c 204e 6666 7429 2c20 6474 7970  win, Nfft), dtyp
-00007830: 653d 6e70 2e66 6c6f 6174 3332 2920 2023  e=np.float32)  #
-00007840: 2073 7461 636b 6564 2063 6f72 7265 6c61   stacked correla
-00007850: 7469 6f6e 0a20 2020 2061 6d70 6d61 7820  tion.    ampmax 
-00007860: 3d20 6e70 2e7a 6572 6f73 286e 7769 6e2c  = np.zeros(nwin,
-00007870: 2064 7479 7065 3d6e 702e 666c 6f61 7433   dtype=np.float3
-00007880: 3229 0a20 2020 206e 5f63 6f72 7220 3d20  2).    n_corr = 
-00007890: 6e70 2e7a 6572 6f73 286e 7769 6e2c 2064  np.zeros(nwin, d
-000078a0: 7479 7065 3d6e 702e 696e 7431 3629 2020  type=np.int16)  
-000078b0: 2320 6e75 6d62 6572 206f 6620 636f 7272  # number of corr
-000078c0: 656c 6174 696f 6e73 2066 6f72 2065 6163  elations for eac
-000078d0: 6820 7375 6273 7461 636b 0a20 2020 2074  h substack.    t
-000078e0: 5f63 6f72 7220 3d20 6461 7461 535f 7420  _corr = dataS_t 
-000078f0: 2023 2074 696d 6573 7461 6d70 0a20 2020   # timestamp.   
-00007900: 2063 7261 7020 3d20 6e70 2e7a 6572 6f73   crap = np.zeros
-00007910: 284e 6666 742c 2064 7479 7065 3d6e 702e  (Nfft, dtype=np.
-00007920: 636f 6d70 6c65 7836 3429 0a20 2020 2066  complex64).    f
-00007930: 6f72 2069 2069 6e20 7261 6e67 6528 6e77  or i in range(nw
-00007940: 696e 293a 0a20 2020 2020 2020 206e 5f63  in):.        n_c
-00007950: 6f72 725b 695d 203d 2031 0a20 2020 2020  orr[i] = 1.     
-00007960: 2020 2063 7261 705b 3a4e 6666 7432 5d20     crap[:Nfft2] 
-00007970: 3d20 636f 7272 5b69 2c20 3a5d 0a20 2020  = corr[i, :].   
-00007980: 2020 2020 2063 7261 705b 3a4e 6666 7432       crap[:Nfft2
-00007990: 5d20 3d20 6372 6170 5b3a 4e66 6674 325d  ] = crap[:Nfft2]
-000079a0: 202d 206e 702e 6d65 616e 2863 7261 705b   - np.mean(crap[
-000079b0: 3a4e 6666 7432 5d29 2020 2320 7265 6d6f  :Nfft2])  # remo
-000079c0: 7665 2074 6865 206d 6561 6e20 696e 2066  ve the mean in f
-000079d0: 7265 7120 646f 6d61 696e 2028 7370 696b  req domain (spik
-000079e0: 6520 6174 2074 3d30 290a 2020 2020 2020  e at t=0).      
-000079f0: 2020 6372 6170 5b2d 284e 6666 7432 2920    crap[-(Nfft2) 
-00007a00: 2b20 3120 3a5d 203d 206e 702e 666c 6970  + 1 :] = np.flip
-00007a10: 286e 702e 636f 6e6a 2863 7261 705b 313a  (np.conj(crap[1:
-00007a20: 284e 6666 7432 295d 292c 2061 7869 733d  (Nfft2)]), axis=
-00007a30: 3029 0a20 2020 2020 2020 2063 7261 705b  0).        crap[
-00007a40: 305d 203d 2063 6f6d 706c 6578 2830 2c20  0] = complex(0, 
-00007a50: 3029 0a20 2020 2020 2020 2073 5f63 6f72  0).        s_cor
-00007a60: 725b 692c 203a 5d20 3d20 6e70 2e72 6561  r[i, :] = np.rea
-00007a70: 6c28 6e70 2e66 6674 2e69 6666 7473 6869  l(np.fft.ifftshi
-00007a80: 6674 2873 6369 7079 2e66 6674 7061 636b  ft(scipy.fftpack
-00007a90: 2e69 6666 7428 6372 6170 2c20 4e66 6674  .ifft(crap, Nfft
-00007aa0: 2c20 6178 6973 3d30 2929 290a 0a20 2020  , axis=0)))..   
-00007ab0: 206e 735f 636f 7272 203d 2073 5f63 6f72   ns_corr = s_cor
-00007ac0: 720a 2020 2020 666f 7220 6969 6920 696e  r.    for iii in
-00007ad0: 2072 616e 6765 286e 735f 636f 7272 2e73   range(ns_corr.s
-00007ae0: 6861 7065 5b30 5d29 3a0a 2020 2020 2020  hape[0]):.      
-00007af0: 2020 6e73 5f63 6f72 725b 6969 695d 202f    ns_corr[iii] /
-00007b00: 3d20 6e70 2e6d 6178 286e 702e 6162 7328  = np.max(np.abs(
-00007b10: 6e73 5f63 6f72 725b 6969 695d 2929 0a0a  ns_corr[iii]))..
-00007b20: 2020 2020 6966 2073 7562 7374 6163 6b3a      if substack:
-00007b30: 0a20 2020 2020 2020 2069 6620 7375 6273  .        if subs
-00007b40: 7461 636b 5f6c 656e 203d 3d20 6363 5f6c  tack_len == cc_l
-00007b50: 656e 3a0a 2020 2020 2020 2020 2020 2020  en:.            
-00007b60: 2320 7265 6d6f 7665 2061 626e 6f72 6d61  # remove abnorma
-00007b70: 6c20 6461 7461 0a20 2020 2020 2020 2020  l data.         
-00007b80: 2020 2061 6d70 6d61 7820 3d20 6e70 2e6d     ampmax = np.m
-00007b90: 6178 2873 5f63 6f72 722c 2061 7869 733d  ax(s_corr, axis=
-00007ba0: 3129 0a20 2020 2020 2020 2020 2020 2074  1).            t
-00007bb0: 696e 6478 203d 206e 702e 7768 6572 6528  indx = np.where(
-00007bc0: 2861 6d70 6d61 7820 3c20 3230 202a 206e  (ampmax < 20 * n
-00007bd0: 702e 6d65 6469 616e 2861 6d70 6d61 7829  p.median(ampmax)
-00007be0: 2920 2620 2861 6d70 6d61 7820 3e20 3029  ) & (ampmax > 0)
-00007bf0: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
-00007c00: 2073 5f63 6f72 7220 3d20 735f 636f 7272   s_corr = s_corr
-00007c10: 5b74 696e 6478 2c20 3a5d 0a20 2020 2020  [tindx, :].     
-00007c20: 2020 2020 2020 2074 5f63 6f72 7220 3d20         t_corr = 
-00007c30: 745f 636f 7272 5b74 696e 6478 5d0a 2020  t_corr[tindx].  
-00007c40: 2020 2020 2020 2020 2020 6e5f 636f 7272            n_corr
-00007c50: 203d 206e 5f63 6f72 725b 7469 6e64 785d   = n_corr[tindx]
-00007c60: 0a0a 2020 2020 2020 2020 656c 7365 3a0a  ..        else:.
-00007c70: 2020 2020 2020 2020 2020 2020 2320 6765              # ge
-00007c80: 7420 7469 6d65 2069 6e66 6f72 6d61 7469  t time informati
-00007c90: 6f6e 0a20 2020 2020 2020 2020 2020 2054  on.            T
-00007ca0: 746f 7461 6c20 3d20 6461 7461 535f 745b  total = dataS_t[
-00007cb0: 2d31 5d20 2d20 6461 7461 535f 745b 305d  -1] - dataS_t[0]
-00007cc0: 2020 2320 746f 7461 6c20 6475 7261 7469    # total durati
-00007cd0: 6f6e 206f 6620 7768 6174 2077 6520 6861  on of what we ha
-00007ce0: 7665 206e 6f77 0a20 2020 2020 2020 2020  ve now.         
-00007cf0: 2020 2074 7374 6172 7420 3d20 6461 7461     tstart = data
-00007d00: 535f 745b 305d 0a0a 2020 2020 2020 2020  S_t[0]..        
-00007d10: 2020 2020 6e73 7461 636b 203d 2069 6e74      nstack = int
-00007d20: 286e 702e 726f 756e 6428 5474 6f74 616c  (np.round(Ttotal
-00007d30: 202f 2073 7562 7374 6163 6b5f 6c65 6e29   / substack_len)
-00007d40: 290a 2020 2020 2020 2020 2020 2020 616d  ).            am
-00007d50: 706d 6178 203d 206e 702e 7a65 726f 7328  pmax = np.zeros(
-00007d60: 6e73 7461 636b 2c20 6474 7970 653d 6e70  nstack, dtype=np
-00007d70: 2e66 6c6f 6174 3332 290a 2020 2020 2020  .float32).      
-00007d80: 2020 2020 2020 735f 636f 7272 203d 206e        s_corr = n
-00007d90: 702e 7a65 726f 7328 7368 6170 653d 286e  p.zeros(shape=(n
-00007da0: 7374 6163 6b2c 204e 6666 7429 2c20 6474  stack, Nfft), dt
-00007db0: 7970 653d 6e70 2e66 6c6f 6174 3332 290a  ype=np.float32).
-00007dc0: 2020 2020 2020 2020 2020 2020 6e5f 636f              n_co
-00007dd0: 7272 203d 206e 702e 7a65 726f 7328 6e73  rr = np.zeros(ns
-00007de0: 7461 636b 2c20 6474 7970 653d 6e70 2e69  tack, dtype=np.i
-00007df0: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
-00007e00: 745f 636f 7272 203d 206e 702e 7a65 726f  t_corr = np.zero
-00007e10: 7328 6e73 7461 636b 2c20 6474 7970 653d  s(nstack, dtype=
-00007e20: 6e70 2e66 6c6f 6174 290a 2020 2020 2020  np.float).      
-00007e30: 2020 2020 2020 6372 6170 203d 206e 702e        crap = np.
-00007e40: 7a65 726f 7328 4e66 6674 2c20 6474 7970  zeros(Nfft, dtyp
-00007e50: 653d 6e70 2e63 6f6d 706c 6578 3634 290a  e=np.complex64).
-00007e60: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00007e70: 2069 7374 6163 6b20 696e 2072 616e 6765   istack in range
-00007e80: 286e 7374 6163 6b29 3a0a 2020 2020 2020  (nstack):.      
-00007e90: 2020 2020 2020 2020 2020 2320 6669 6e64            # find
-00007ea0: 2074 6865 2069 6e64 6578 6573 206f 6620   the indexes of 
-00007eb0: 616c 6c20 6f66 2074 6865 2077 696e 646f  all of the windo
-00007ec0: 7773 2074 6861 7420 7374 6172 7420 6f72  ws that start or
-00007ed0: 2065 6e64 2077 6974 6869 6e0a 2020 2020   end within.    
-00007ee0: 2020 2020 2020 2020 2020 2020 6974 696d              itim
-00007ef0: 6520 3d20 6e70 2e77 6865 7265 2828 6461  e = np.where((da
-00007f00: 7461 535f 7420 3e3d 2074 7374 6172 7429  taS_t >= tstart)
-00007f10: 2026 2028 6461 7461 535f 7420 3c20 7473   & (dataS_t < ts
-00007f20: 7461 7274 202b 2073 7562 7374 6163 6b5f  tart + substack_
-00007f30: 6c65 6e29 295b 305d 0a20 2020 2020 2020  len))[0].       
-00007f40: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-00007f50: 6974 696d 6529 203d 3d20 303a 0a20 2020  itime) == 0:.   
-00007f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f70: 2074 7374 6172 7420 2b3d 2073 7562 7374   tstart += subst
-00007f80: 6163 6b5f 6c65 6e0a 2020 2020 2020 2020  ack_len.        
-00007f90: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00007fa0: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
-00007fb0: 2020 2020 2020 6372 6170 5b3a 4e66 6674        crap[:Nfft
-00007fc0: 325d 203d 206e 702e 6d65 616e 2863 6f72  2] = np.mean(cor
-00007fd0: 725b 6974 696d 652c 203a 5d2c 2061 7869  r[itime, :], axi
-00007fe0: 733d 3029 2020 2320 6c69 6e65 6172 2061  s=0)  # linear a
-00007ff0: 7665 7261 6765 206f 6620 7468 6520 636f  verage of the co
-00008000: 7272 656c 6174 696f 6e0a 2020 2020 2020  rrelation.      
-00008010: 2020 2020 2020 2020 2020 6372 6170 5b3a            crap[:
-00008020: 4e66 6674 325d 203d 2063 7261 705b 3a4e  Nfft2] = crap[:N
-00008030: 6666 7432 5d20 2d20 6e70 2e6d 6561 6e28  fft2] - np.mean(
-00008040: 6372 6170 5b3a 4e66 6674 325d 2920 2023  crap[:Nfft2])  #
-00008050: 2072 656d 6f76 6520 7468 6520 6d65 616e   remove the mean
-00008060: 2069 6e20 6672 6571 2064 6f6d 6169 6e20   in freq domain 
-00008070: 2873 7069 6b65 2061 7420 743d 3029 0a20  (spike at t=0). 
-00008080: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00008090: 7261 705b 2d28 4e66 6674 3229 202b 2031  rap[-(Nfft2) + 1
-000080a0: 203a 5d20 3d20 6e70 2e66 6c69 7028 6e70   :] = np.flip(np
-000080b0: 2e63 6f6e 6a28 6372 6170 5b31 3a28 4e66  .conj(crap[1:(Nf
-000080c0: 6674 3229 5d29 2c20 6178 6973 3d30 290a  ft2)]), axis=0).
-000080d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000080e0: 6372 6170 5b30 5d20 3d20 636f 6d70 6c65  crap[0] = comple
-000080f0: 7828 302c 2030 290a 2020 2020 2020 2020  x(0, 0).        
-00008100: 2020 2020 2020 2020 735f 636f 7272 5b69          s_corr[i
-00008110: 7374 6163 6b2c 203a 5d20 3d20 6e70 2e72  stack, :] = np.r
-00008120: 6561 6c28 6e70 2e66 6674 2e69 6666 7473  eal(np.fft.iffts
-00008130: 6869 6674 2873 6369 7079 2e66 6674 7061  hift(scipy.fftpa
-00008140: 636b 2e69 6666 7428 6372 6170 2c20 4e66  ck.ifft(crap, Nf
-00008150: 6674 2c20 6178 6973 3d30 2929 290a 2020  ft, axis=0))).  
-00008160: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
-00008170: 636f 7272 5b69 7374 6163 6b5d 203d 206c  corr[istack] = l
-00008180: 656e 2869 7469 6d65 2920 2023 206e 756d  en(itime)  # num
-00008190: 6265 7220 6f66 2077 696e 646f 7773 2073  ber of windows s
-000081a0: 7461 636b 730a 2020 2020 2020 2020 2020  tacks.          
-000081b0: 2020 2020 2020 745f 636f 7272 5b69 7374        t_corr[ist
-000081c0: 6163 6b5d 203d 2074 7374 6172 7420 2023  ack] = tstart  #
-000081d0: 2073 6176 6520 7468 6520 7469 6d65 2073   save the time s
-000081e0: 7461 6d70 730a 2020 2020 2020 2020 2020  tamps.          
-000081f0: 2020 2020 2020 7473 7461 7274 202b 3d20        tstart += 
-00008200: 7375 6273 7461 636b 5f6c 656e 0a20 2020  substack_len.   
-00008210: 2020 2020 2020 2020 2020 2020 2023 2070               # p
-00008220: 7269 6e74 2827 636f 7272 656c 6174 696f  rint('correlatio
-00008230: 6e20 646f 6e65 2061 6e64 2073 7461 636b  n done and stack
-00008240: 6564 2061 7420 7469 6d65 2025 7327 2025  ed at time %s' %
-00008250: 2073 7472 2874 5f63 6f72 725b 6973 7461   str(t_corr[ista
-00008260: 636b 5d29 290a 0a20 2020 2020 2020 2020  ck]))..         
-00008270: 2020 2023 2072 656d 6f76 6520 6162 6e6f     # remove abno
-00008280: 726d 616c 2064 6174 610a 2020 2020 2020  rmal data.      
-00008290: 2020 2020 2020 616d 706d 6178 203d 206e        ampmax = n
-000082a0: 702e 6d61 7828 735f 636f 7272 2c20 6178  p.max(s_corr, ax
-000082b0: 6973 3d31 290a 2020 2020 2020 2020 2020  is=1).          
-000082c0: 2020 7469 6e64 7820 3d20 6e70 2e77 6865    tindx = np.whe
-000082d0: 7265 2828 616d 706d 6178 203c 2032 3020  re((ampmax < 20 
-000082e0: 2a20 6e70 2e6d 6564 6961 6e28 616d 706d  * np.median(ampm
-000082f0: 6178 2929 2026 2028 616d 706d 6178 203e  ax)) & (ampmax >
-00008300: 2030 2929 5b30 5d0a 2020 2020 2020 2020   0))[0].        
-00008310: 2020 2020 735f 636f 7272 203d 2073 5f63      s_corr = s_c
-00008320: 6f72 725b 7469 6e64 782c 203a 5d0a 2020  orr[tindx, :].  
-00008330: 2020 2020 2020 2020 2020 745f 636f 7272            t_corr
-00008340: 203d 2074 5f63 6f72 725b 7469 6e64 785d   = t_corr[tindx]
-00008350: 0a20 2020 2020 2020 2020 2020 206e 5f63  .            n_c
-00008360: 6f72 7220 3d20 6e5f 636f 7272 5b74 696e  orr = n_corr[tin
-00008370: 6478 5d0a 0a20 2020 2065 6c73 653a 0a20  dx]..    else:. 
-00008380: 2020 2020 2020 2023 2061 7665 7261 6765         # average
-00008390: 2064 6169 6c79 2063 726f 7373 2063 6f72   daily cross cor
-000083a0: 7265 6c61 7469 6f6e 2066 756e 6374 696f  relation functio
-000083b0: 6e73 0a20 2020 2020 2020 2069 6620 7374  ns.        if st
-000083c0: 6163 6b5f 6d65 7468 6f64 203d 3d20 226c  ack_method == "l
-000083d0: 696e 6561 7222 3a0a 2020 2020 2020 2020  inear":.        
-000083e0: 2020 2020 616d 706d 6178 203d 206e 702e      ampmax = np.
-000083f0: 6d61 7828 735f 636f 7272 2c20 6178 6973  max(s_corr, axis
-00008400: 3d31 290a 2020 2020 2020 2020 2020 2020  =1).            
-00008410: 7469 6e64 7820 3d20 6e70 2e77 6865 7265  tindx = np.where
-00008420: 2828 616d 706d 6178 203c 2032 3020 2a20  ((ampmax < 20 * 
-00008430: 6e70 2e6d 6564 6961 6e28 616d 706d 6178  np.median(ampmax
-00008440: 2929 2026 2028 616d 706d 6178 203e 2030  )) & (ampmax > 0
-00008450: 2929 5b30 5d0a 2020 2020 2020 2020 2020  ))[0].          
-00008460: 2020 735f 636f 7272 203d 206e 702e 6d65    s_corr = np.me
-00008470: 616e 2873 5f63 6f72 725b 7469 6e64 785d  an(s_corr[tindx]
-00008480: 2c20 6178 6973 3d30 290a 2020 2020 2020  , axis=0).      
-00008490: 2020 2020 2020 745f 636f 7272 203d 2064        t_corr = d
-000084a0: 6174 6153 5f74 5b30 5d0a 2020 2020 2020  ataS_t[0].      
-000084b0: 2020 2020 2020 6e5f 636f 7272 203d 206c        n_corr = l
-000084c0: 656e 2874 696e 6478 290a 2020 2020 2020  en(tindx).      
-000084d0: 2020 656c 6966 2073 7461 636b 5f6d 6574    elif stack_met
-000084e0: 686f 6420 3d3d 2022 726f 6275 7374 223a  hod == "robust":
-000084f0: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00008500: 6e74 2822 646f 2072 6f62 7573 7420 7375  nt("do robust su
-00008510: 6273 7461 636b 696e 6722 290a 2020 2020  bstacking").    
-00008520: 2020 2020 2020 2020 735f 636f 7272 203d          s_corr =
-00008530: 2072 6f62 7573 745f 7374 6163 6b28 735f   robust_stack(s_
-00008540: 636f 7272 2c20 302e 3030 3129 0a20 2020  corr, 0.001).   
-00008550: 2020 2020 2020 2020 2074 5f63 6f72 7220           t_corr 
-00008560: 3d20 6461 7461 535f 745b 305d 0a20 2020  = dataS_t[0].   
-00008570: 2020 2020 2020 2020 206e 5f63 6f72 7220           n_corr 
-00008580: 3d20 6e77 696e 0a20 2020 2023 2020 656c  = nwin.    #  el
-00008590: 6966 2073 7461 636b 5f6d 6574 686f 6420  if stack_method 
-000085a0: 3d3d 2027 7365 6c65 6374 6976 6527 3a0a  == 'selective':.
-000085b0: 2020 2020 2320 2020 2020 2070 7269 6e74      #      print
-000085c0: 2827 646f 2073 656c 6563 7469 7665 2073  ('do selective s
-000085d0: 7562 7374 6163 6b69 6e67 2729 0a20 2020  ubstacking').   
-000085e0: 2023 2020 2020 2020 735f 636f 7272 203d   #      s_corr =
-000085f0: 2073 656c 6563 7469 7665 5f73 7461 636b   selective_stack
-00008600: 2873 5f63 6f72 722c 302e 3030 3129 0a20  (s_corr,0.001). 
-00008610: 2020 2023 2020 2020 2020 745f 636f 7272     #      t_corr
-00008620: 203d 2064 6174 6153 5f74 5b30 5d0a 2020   = dataS_t[0].  
-00008630: 2020 2320 2020 2020 206e 5f63 6f72 7220    #      n_corr 
-00008640: 3d20 6e77 696e 0a0a 2020 2020 2320 7472  = nwin..    # tr
-00008650: 696d 2074 6865 2043 4346 7320 696e 205b  im the CCFs in [
-00008660: 2d6d 6178 6c61 6720 6d61 786c 6167 5d0a  -maxlag maxlag].
-00008670: 2020 2020 7420 3d20 6e70 2e61 7261 6e67      t = np.arang
-00008680: 6528 2d4e 6666 7432 202b 2031 2c20 4e66  e(-Nfft2 + 1, Nf
-00008690: 6674 3229 202a 2064 740a 2020 2020 696e  ft2) * dt.    in
-000086a0: 6420 3d20 6e70 2e77 6865 7265 286e 702e  d = np.where(np.
-000086b0: 6162 7328 7429 203c 3d20 6d61 786c 6167  abs(t) <= maxlag
-000086c0: 295b 305d 0a20 2020 2069 6620 735f 636f  )[0].    if s_co
-000086d0: 7272 2e6e 6469 6d20 3d3d 2031 3a0a 2020  rr.ndim == 1:.  
-000086e0: 2020 2020 2020 735f 636f 7272 203d 2073        s_corr = s
-000086f0: 5f63 6f72 725b 696e 645d 0a20 2020 2065  _corr[ind].    e
-00008700: 6c69 6620 735f 636f 7272 2e6e 6469 6d20  lif s_corr.ndim 
-00008710: 3d3d 2032 3a0a 2020 2020 2020 2020 735f  == 2:.        s_
-00008720: 636f 7272 203d 2073 5f63 6f72 725b 3a2c  corr = s_corr[:,
-00008730: 2069 6e64 5d0a 2020 2020 7265 7475 726e   ind].    return
-00008740: 2073 5f63 6f72 722c 2074 5f63 6f72 722c   s_corr, t_corr,
-00008750: 206e 5f63 6f72 722c 206e 735f 636f 7272   n_corr, ns_corr
-00008760: 5b3a 2c20 696e 645d 0a0a 0a64 6566 2063  [:, ind]...def c
-00008770: 635f 7061 7261 6d65 7465 7273 2863 635f  c_parameters(cc_
-00008780: 7061 7261 2c20 636f 6f72 2c20 7463 6f72  para, coor, tcor
-00008790: 722c 206e 636f 7272 2c20 636f 6d70 293a  r, ncorr, comp):
-000087a0: 0a20 2020 2022 2222 0a20 2020 2074 6869  .    """.    thi
-000087b0: 7320 6675 6e63 7469 6f6e 2061 7373 656d  s function assem
-000087c0: 626c 6573 2074 6865 2070 6172 616d 6574  bles the paramet
-000087d0: 6572 7320 666f 7220 7468 6520 6363 2066  ers for the cc f
-000087e0: 756e 6374 696f 6e2c 2077 6869 6368 2069  unction, which i
-000087f0: 7320 7573 6564 0a20 2020 2077 6865 6e20  s used.    when 
-00008800: 7772 6974 696e 6720 7468 656d 2069 6e74  writing them int
-00008810: 6f20 4153 4446 2066 696c 6573 0a20 2020  o ASDF files.   
-00008820: 2050 4152 414d 4554 4552 533a 0a20 2020   PARAMETERS:.   
-00008830: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
-00008840: 2d2d 2d2d 2d2d 0a20 2020 2063 635f 7061  ------.    cc_pa
-00008850: 7261 3a20 6469 6374 2063 6f6e 7461 696e  ra: dict contain
-00008860: 696e 6720 7061 7261 6d65 7465 7273 2075  ing parameters u
-00008870: 7365 6420 696e 2074 6865 2066 6674 5f63  sed in the fft_c
-00008880: 6320 7374 6570 0a20 2020 2063 6f6f 723a  c step.    coor:
-00008890: 2020 2020 6469 6374 2063 6f6e 7461 696e      dict contain
-000088a0: 696e 6720 636f 6f72 6469 6e61 7465 7320  ing coordinates 
-000088b0: 696e 666f 206f 6620 7468 6520 736f 7572  info of the sour
-000088c0: 6365 2061 6e64 2072 6563 6569 7665 7220  ce and receiver 
-000088d0: 7374 6174 696f 6e73 0a20 2020 2074 636f  stations.    tco
-000088e0: 7272 3a20 2020 7469 6d65 7374 616d 7020  rr:   timestamp 
-000088f0: 6d61 7472 6978 0a20 2020 206e 636f 7272  matrix.    ncorr
-00008900: 3a20 2020 6d61 7472 6978 206f 6620 6e75  :   matrix of nu
-00008910: 6d62 6572 206f 6620 676f 6f64 2073 6567  mber of good seg
-00008920: 6d65 6e74 7320 666f 7220 6561 6368 2073  ments for each s
-00008930: 7562 2d73 7461 636b 2f66 696e 616c 2073  ub-stack/final s
-00008940: 7461 636b 0a20 2020 2063 6f6d 703a 2020  tack.    comp:  
-00008950: 2020 3220 6368 6172 6163 7465 7220 7374    2 character st
-00008960: 7269 6e67 7320 666f 7220 7468 6520 6372  rings for the cr
-00008970: 6f73 7320 636f 7272 656c 6174 696f 6e20  oss correlation 
-00008980: 636f 6d70 6f6e 656e 740a 2020 2020 5245  component.    RE
-00008990: 5455 524e 533a 0a20 2020 202d 2d2d 2d2d  TURNS:.    -----
-000089a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
-000089b0: 2020 7061 7261 6d65 7465 7273 3a20 6469    parameters: di
-000089c0: 6374 2063 6f6e 7461 696e 696e 6720 6162  ct containing ab
-000089d0: 6f76 6520 696e 666f 2075 7365 6420 666f  ove info used fo
-000089e0: 7220 6c61 7465 7220 7374 6163 6b69 6e67  r later stacking
-000089f0: 2f70 6c6f 7474 696e 670a 2020 2020 2222  /plotting.    ""
-00008a00: 220a 2020 2020 6c61 7453 203d 2063 6f6f  ".    latS = coo
-00008a10: 725b 226c 6174 5322 5d0a 2020 2020 6c6f  r["latS"].    lo
-00008a20: 6e53 203d 2063 6f6f 725b 226c 6f6e 5322  nS = coor["lonS"
-00008a30: 5d0a 2020 2020 6c61 7452 203d 2063 6f6f  ].    latR = coo
-00008a40: 725b 226c 6174 5222 5d0a 2020 2020 6c6f  r["latR"].    lo
-00008a50: 6e52 203d 2063 6f6f 725b 226c 6f6e 5222  nR = coor["lonR"
-00008a60: 5d0a 2020 2020 6474 203d 2063 635f 7061  ].    dt = cc_pa
-00008a70: 7261 5b22 6474 225d 0a20 2020 206d 6178  ra["dt"].    max
-00008a80: 6c61 6720 3d20 6363 5f70 6172 615b 226d  lag = cc_para["m
-00008a90: 6178 6c61 6722 5d0a 2020 2020 7375 6273  axlag"].    subs
-00008aa0: 7461 636b 203d 2063 635f 7061 7261 5b22  tack = cc_para["
-00008ab0: 7375 6273 7461 636b 225d 0a20 2020 2063  substack"].    c
-00008ac0: 635f 6d65 7468 6f64 203d 2063 635f 7061  c_method = cc_pa
-00008ad0: 7261 5b22 6363 5f6d 6574 686f 6422 5d0a  ra["cc_method"].
-00008ae0: 0a20 2020 2064 6973 742c 2061 7a69 2c20  .    dist, azi, 
-00008af0: 6261 7a20 3d20 6f62 7370 792e 6765 6f64  baz = obspy.geod
-00008b00: 6574 6963 732e 6261 7365 2e67 7073 3264  etics.base.gps2d
-00008b10: 6973 745f 617a 696d 7574 6828 6c61 7453  ist_azimuth(latS
-00008b20: 2c20 6c6f 6e53 2c20 6c61 7452 2c20 6c6f  , lonS, latR, lo
-00008b30: 6e52 290a 2020 2020 7061 7261 6d65 7465  nR).    paramete
-00008b40: 7273 203d 207b 0a20 2020 2020 2020 2022  rs = {.        "
-00008b50: 6474 223a 2064 742c 0a20 2020 2020 2020  dt": dt,.       
-00008b60: 2022 6d61 786c 6167 223a 2069 6e74 286d   "maxlag": int(m
-00008b70: 6178 6c61 6729 2c0a 2020 2020 2020 2020  axlag),.        
-00008b80: 2264 6973 7422 3a20 6e70 2e66 6c6f 6174  "dist": np.float
-00008b90: 3332 2864 6973 7420 2f20 3130 3030 292c  32(dist / 1000),
-00008ba0: 0a20 2020 2020 2020 2022 617a 6922 3a20  .        "azi": 
-00008bb0: 6e70 2e66 6c6f 6174 3332 2861 7a69 292c  np.float32(azi),
-00008bc0: 0a20 2020 2020 2020 2022 6261 7a22 3a20  .        "baz": 
-00008bd0: 6e70 2e66 6c6f 6174 3332 2862 617a 292c  np.float32(baz),
-00008be0: 0a20 2020 2020 2020 2022 6c6f 6e53 223a  .        "lonS":
-00008bf0: 206e 702e 666c 6f61 7433 3228 6c6f 6e53   np.float32(lonS
-00008c00: 292c 0a20 2020 2020 2020 2022 6c61 7453  ),.        "latS
-00008c10: 223a 206e 702e 666c 6f61 7433 3228 6c61  ": np.float32(la
-00008c20: 7453 292c 0a20 2020 2020 2020 2022 6c6f  tS),.        "lo
-00008c30: 6e52 223a 206e 702e 666c 6f61 7433 3228  nR": np.float32(
-00008c40: 6c6f 6e52 292c 0a20 2020 2020 2020 2022  lonR),.        "
-00008c50: 6c61 7452 223a 206e 702e 666c 6f61 7433  latR": np.float3
-00008c60: 3228 6c61 7452 292c 0a20 2020 2020 2020  2(latR),.       
-00008c70: 2022 6e67 6f6f 6422 3a20 6e63 6f72 722c   "ngood": ncorr,
-00008c80: 0a20 2020 2020 2020 2022 6363 5f6d 6574  .        "cc_met
-00008c90: 686f 6422 3a20 6363 5f6d 6574 686f 642c  hod": cc_method,
-00008ca0: 0a20 2020 2020 2020 2022 7469 6d65 223a  .        "time":
-00008cb0: 2074 636f 7272 2c0a 2020 2020 2020 2020   tcorr,.        
-00008cc0: 2273 7562 7374 6163 6b22 3a20 7375 6273  "substack": subs
-00008cd0: 7461 636b 2c0a 2020 2020 2020 2020 2263  tack,.        "c
-00008ce0: 6f6d 7022 3a20 636f 6d70 2c0a 2020 2020  omp": comp,.    
-00008cf0: 7d0a 2020 2020 7265 7475 726e 2070 6172  }.    return par
-00008d00: 616d 6574 6572 730a 0a0a 6465 6620 7374  ameters...def st
-00008d10: 6163 6b69 6e67 2863 635f 6172 7261 792c  acking(cc_array,
-00008d20: 2063 635f 7469 6d65 2c20 6363 5f6e 676f   cc_time, cc_ngo
-00008d30: 6f64 2c20 7374 6163 6b5f 7061 7261 293a  od, stack_para):
-00008d40: 0a20 2020 2022 2222 0a20 2020 2074 6869  .    """.    thi
-00008d50: 7320 6675 6e63 7469 6f6e 2073 7461 636b  s function stack
-00008d60: 7320 7468 6520 6372 6f73 7320 636f 7272  s the cross corr
-00008d70: 656c 6174 696f 6e20 6461 7461 2061 6363  elation data acc
-00008d80: 6f72 6469 6e67 2074 6f20 7468 6520 7573  ording to the us
-00008d90: 6572 2d64 6566 696e 6564 2073 7562 7374  er-defined subst
-00008da0: 6163 6b5f 6c65 6e20 7061 7261 6d65 7465  ack_len paramete
-00008db0: 720a 0a20 2020 2050 4152 414d 4554 4552  r..    PARAMETER
-00008dc0: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
-00008dd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
-00008de0: 2020 6363 5f61 7272 6179 3a20 3244 206e    cc_array: 2D n
-00008df0: 756d 7079 2066 6c6f 6174 3332 206d 6174  umpy float32 mat
-00008e00: 7269 7820 636f 6e74 6169 6e69 6e67 2061  rix containing a
-00008e10: 6c6c 2073 6567 6d65 6e74 6564 2063 726f  ll segmented cro
-00008e20: 7373 2d63 6f72 7265 6c61 7469 6f6e 2064  ss-correlation d
-00008e30: 6174 610a 2020 2020 6363 5f74 696d 653a  ata.    cc_time:
-00008e40: 2020 3144 206e 756d 7079 2061 7272 6179    1D numpy array
-00008e50: 206f 6620 7469 6d65 7374 616d 7073 2066   of timestamps f
-00008e60: 6f72 2065 6163 6820 7365 676d 656e 7420  or each segment 
-00008e70: 6f66 2063 635f 6172 7261 790a 2020 2020  of cc_array.    
-00008e80: 6363 5f6e 676f 6f64 3a20 3144 206e 756d  cc_ngood: 1D num
-00008e90: 7079 2069 6e74 3136 206d 6174 7269 7820  py int16 matrix 
-00008ea0: 7368 6f77 696e 6720 7468 6520 6e75 6d62  showing the numb
-00008eb0: 6572 206f 6620 7365 676d 656e 7473 2066  er of segments f
-00008ec0: 6f72 2065 6163 6820 7375 622d 7374 6163  or each sub-stac
-00008ed0: 6b20 616e 642f 6f72 2066 756c 6c20 7374  k and/or full st
-00008ee0: 6163 6b0a 2020 2020 7374 6163 6b5f 7061  ack.    stack_pa
-00008ef0: 7261 3a20 6120 6469 6374 2063 6f6e 7461  ra: a dict conta
-00008f00: 696e 696e 6720 616c 6c20 7374 6163 6b69  ining all stacki
-00008f10: 6e67 2070 6172 616d 6574 6572 730a 0a20  ng parameters.. 
-00008f20: 2020 2052 4554 5552 4e53 3a0a 2020 2020     RETURNS:.    
-00008f30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00008f40: 2d2d 2d2d 2d2d 0a20 2020 2063 635f 6172  ------.    cc_ar
-00008f50: 7261 792c 2063 635f 6e67 6f6f 642c 2063  ray, cc_ngood, c
-00008f60: 635f 7469 6d65 3a20 7361 6d65 2074 6f20  c_time: same to 
-00008f70: 7468 6520 696e 7075 7420 7061 7261 6d65  the input parame
-00008f80: 7465 7273 2062 7574 2077 6974 6820 6162  ters but with ab
-00008f90: 6e6f 726d 616c 2063 726f 7373 2d63 6f72  normal cross-cor
-00008fa0: 7265 616c 7469 6f6e 7320 7265 6d6f 7665  realtions remove
-00008fb0: 640a 2020 2020 616c 6c73 7461 636b 7331  d.    allstacks1
-00008fc0: 3a20 3144 206d 6174 7269 7820 6f66 2073  : 1D matrix of s
-00008fd0: 7461 636b 6564 2063 726f 7373 2d63 6f72  tacked cross-cor
-00008fe0: 7265 6c61 7469 6f6e 2066 756e 6374 696f  relation functio
-00008ff0: 6e73 206f 7665 7220 616c 6c20 7468 6520  ns over all the 
-00009000: 7365 676d 656e 7473 0a20 2020 206e 7374  segments.    nst
-00009010: 6163 6b73 3a20 2020 206e 756d 6265 7220  acks:    number 
-00009020: 6f66 206f 7665 7261 6c6c 2073 6567 6d65  of overall segme
-00009030: 6e74 7320 666f 7220 7468 6520 6669 6e61  nts for the fina
-00009040: 6c20 7374 6163 6b73 0a20 2020 2022 2222  l stacks.    """
-00009050: 0a20 2020 2023 206c 6f61 6420 7573 6566  .    # load usef
-00009060: 756c 2070 6172 616d 6574 6572 7320 6672  ul parameters fr
-00009070: 6f6d 2064 6963 740a 2020 2020 7361 6d70  om dict.    samp
-00009080: 5f66 7265 7120 3d20 7374 6163 6b5f 7061  _freq = stack_pa
-00009090: 7261 5b22 7361 6d70 5f66 7265 7122 5d0a  ra["samp_freq"].
-000090a0: 2020 2020 736d 6574 686f 6420 3d20 7374      smethod = st
-000090b0: 6163 6b5f 7061 7261 5b22 7374 6163 6b5f  ack_para["stack_
-000090c0: 6d65 7468 6f64 225d 0a20 2020 206e 7074  method"].    npt
-000090d0: 7320 3d20 6363 5f61 7272 6179 2e73 6861  s = cc_array.sha
-000090e0: 7065 5b31 5d0a 0a20 2020 2023 2072 656d  pe[1]..    # rem
-000090f0: 6f76 6520 6162 6e6f 726d 616c 2064 6174  ove abnormal dat
-00009100: 610a 2020 2020 616d 706d 6178 203d 206e  a.    ampmax = n
-00009110: 702e 6d61 7828 6363 5f61 7272 6179 2c20  p.max(cc_array, 
-00009120: 6178 6973 3d31 290a 2020 2020 7469 6e64  axis=1).    tind
-00009130: 7820 3d20 6e70 2e77 6865 7265 2828 616d  x = np.where((am
-00009140: 706d 6178 203c 2032 3020 2a20 6e70 2e6d  pmax < 20 * np.m
-00009150: 6564 6961 6e28 616d 706d 6178 2929 2026  edian(ampmax)) &
-00009160: 2028 616d 706d 6178 203e 2030 2929 5b30   (ampmax > 0))[0
-00009170: 5d0a 2020 2020 6966 206e 6f74 206c 656e  ].    if not len
-00009180: 2874 696e 6478 293a 0a20 2020 2020 2020  (tindx):.       
-00009190: 2061 6c6c 7374 6163 6b73 3120 3d20 5b5d   allstacks1 = []
-000091a0: 0a20 2020 2020 2020 2061 6c6c 7374 6163  .        allstac
-000091b0: 6b73 3220 3d20 5b5d 0a20 2020 2020 2020  ks2 = [].       
-000091c0: 2061 6c6c 7374 6163 6b73 3320 3d20 5b5d   allstacks3 = []
-000091d0: 0a20 2020 2020 2020 206e 7374 6163 6b73  .        nstacks
-000091e0: 203d 2030 0a20 2020 2020 2020 2063 635f   = 0.        cc_
-000091f0: 6172 7261 7920 3d20 5b5d 0a20 2020 2020  array = [].     
-00009200: 2020 2063 635f 6e67 6f6f 6420 3d20 5b5d     cc_ngood = []
-00009210: 0a20 2020 2020 2020 2063 635f 7469 6d65  .        cc_time
-00009220: 203d 205b 5d0a 2020 2020 2020 2020 7265   = [].        re
-00009230: 7475 726e 2063 635f 6172 7261 792c 2063  turn cc_array, c
-00009240: 635f 6e67 6f6f 642c 2063 635f 7469 6d65  c_ngood, cc_time
-00009250: 2c20 616c 6c73 7461 636b 7331 2c20 616c  , allstacks1, al
-00009260: 6c73 7461 636b 7332 2c20 616c 6c73 7461  lstacks2, allsta
-00009270: 636b 7333 2c20 6e73 7461 636b 730a 2020  cks3, nstacks.  
-00009280: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00009290: 2320 7265 6d6f 7665 206f 6e65 7320 7769  # remove ones wi
-000092a0: 7468 2062 6164 2061 6d70 6c69 7475 6465  th bad amplitude
-000092b0: 0a20 2020 2020 2020 2063 635f 6172 7261  .        cc_arra
-000092c0: 7920 3d20 6363 5f61 7272 6179 5b74 696e  y = cc_array[tin
-000092d0: 6478 2c20 3a5d 0a20 2020 2020 2020 2063  dx, :].        c
-000092e0: 635f 7469 6d65 203d 2063 635f 7469 6d65  c_time = cc_time
-000092f0: 5b74 696e 6478 5d0a 2020 2020 2020 2020  [tindx].        
-00009300: 6363 5f6e 676f 6f64 203d 2063 635f 6e67  cc_ngood = cc_ng
-00009310: 6f6f 645b 7469 6e64 785d 0a0a 2020 2020  ood[tindx]..    
-00009320: 2020 2020 2320 646f 2073 7461 636b 696e      # do stackin
-00009330: 670a 2020 2020 2020 2020 616c 6c73 7461  g.        allsta
-00009340: 636b 7331 203d 206e 702e 7a65 726f 7328  cks1 = np.zeros(
-00009350: 6e70 7473 2c20 6474 7970 653d 6e70 2e66  npts, dtype=np.f
-00009360: 6c6f 6174 3332 290a 2020 2020 2020 2020  loat32).        
-00009370: 616c 6c73 7461 636b 7332 203d 206e 702e  allstacks2 = np.
-00009380: 7a65 726f 7328 6e70 7473 2c20 6474 7970  zeros(npts, dtyp
-00009390: 653d 6e70 2e66 6c6f 6174 3332 290a 2020  e=np.float32).  
-000093a0: 2020 2020 2020 616c 6c73 7461 636b 7333        allstacks3
-000093b0: 203d 206e 702e 7a65 726f 7328 6e70 7473   = np.zeros(npts
-000093c0: 2c20 6474 7970 653d 6e70 2e66 6c6f 6174  , dtype=np.float
-000093d0: 3332 290a 0a20 2020 2020 2020 2069 6620  32)..        if 
-000093e0: 736d 6574 686f 6420 3d3d 2022 6c69 6e65  smethod == "line
-000093f0: 6172 223a 0a20 2020 2020 2020 2020 2020  ar":.           
-00009400: 2061 6c6c 7374 6163 6b73 3120 3d20 6e70   allstacks1 = np
-00009410: 2e6d 6561 6e28 6363 5f61 7272 6179 2c20  .mean(cc_array, 
-00009420: 6178 6973 3d30 290a 2020 2020 2020 2020  axis=0).        
-00009430: 656c 6966 2073 6d65 7468 6f64 203d 3d20  elif smethod == 
-00009440: 2270 7773 223a 0a20 2020 2020 2020 2020  "pws":.         
-00009450: 2020 2061 6c6c 7374 6163 6b73 3120 3d20     allstacks1 = 
-00009460: 7077 7328 6363 5f61 7272 6179 2c20 7361  pws(cc_array, sa
-00009470: 6d70 5f66 7265 7129 0a20 2020 2020 2020  mp_freq).       
-00009480: 2065 6c69 6620 736d 6574 686f 6420 3d3d   elif smethod ==
-00009490: 2022 726f 6275 7374 223a 0a20 2020 2020   "robust":.     
-000094a0: 2020 2020 2020 2061 6c6c 7374 6163 6b73         allstacks
-000094b0: 312c 2077 2c20 6e73 7465 7020 3d20 726f  1, w, nstep = ro
-000094c0: 6275 7374 5f73 7461 636b 2863 635f 6172  bust_stack(cc_ar
-000094d0: 7261 792c 2030 2e30 3031 290a 2020 2020  ray, 0.001).    
-000094e0: 2020 2020 656c 6966 2073 6d65 7468 6f64      elif smethod
-000094f0: 203d 3d20 2261 7574 6f5f 636f 7661 7269   == "auto_covari
-00009500: 616e 6365 223a 0a20 2020 2020 2020 2020  ance":.         
-00009510: 2020 2061 6c6c 7374 6163 6b73 3120 3d20     allstacks1 = 
-00009520: 6164 6170 7469 7665 5f66 696c 7465 7228  adaptive_filter(
-00009530: 6363 5f61 7272 6179 2c20 3129 0a20 2020  cc_array, 1).   
-00009540: 2020 2020 2065 6c69 6620 736d 6574 686f       elif smetho
-00009550: 6420 3d3d 2022 6e72 6f6f 7422 3a0a 2020  d == "nroot":.  
-00009560: 2020 2020 2020 2020 2020 616c 6c73 7461            allsta
-00009570: 636b 7331 203d 206e 726f 6f74 5f73 7461  cks1 = nroot_sta
-00009580: 636b 2863 635f 6172 7261 792c 2032 290a  ck(cc_array, 2).
-00009590: 2020 2020 2020 2020 656c 6966 2073 6d65          elif sme
-000095a0: 7468 6f64 203d 3d20 2261 6c6c 223a 0a20  thod == "all":. 
-000095b0: 2020 2020 2020 2020 2020 2061 6c6c 7374             allst
-000095c0: 6163 6b73 3120 3d20 6e70 2e6d 6561 6e28  acks1 = np.mean(
-000095d0: 6363 5f61 7272 6179 2c20 6178 6973 3d30  cc_array, axis=0
-000095e0: 290a 2020 2020 2020 2020 2020 2020 616c  ).            al
-000095f0: 6c73 7461 636b 7332 203d 2070 7773 2863  lstacks2 = pws(c
-00009600: 635f 6172 7261 792c 2073 616d 705f 6672  c_array, samp_fr
-00009610: 6571 290a 2020 2020 2020 2020 2020 2020  eq).            
-00009620: 616c 6c73 7461 636b 7333 2c20 772c 206e  allstacks3, w, n
-00009630: 7374 6570 203d 2072 6f62 7573 745f 7374  step = robust_st
-00009640: 6163 6b28 6363 5f61 7272 6179 2c20 302e  ack(cc_array, 0.
-00009650: 3030 3129 0a20 2020 2020 2020 206e 7374  001).        nst
-00009660: 6163 6b73 203d 206e 702e 7375 6d28 6363  acks = np.sum(cc
-00009670: 5f6e 676f 6f64 290a 0a20 2020 2023 2067  _ngood)..    # g
-00009680: 6f6f 6420 746f 2072 6574 7572 6e0a 2020  ood to return.  
-00009690: 2020 7265 7475 726e 2063 635f 6172 7261    return cc_arra
-000096a0: 792c 2063 635f 6e67 6f6f 642c 2063 635f  y, cc_ngood, cc_
-000096b0: 7469 6d65 2c20 616c 6c73 7461 636b 7331  time, allstacks1
-000096c0: 2c20 616c 6c73 7461 636b 7332 2c20 616c  , allstacks2, al
-000096d0: 6c73 7461 636b 7333 2c20 6e73 7461 636b  lstacks3, nstack
-000096e0: 730a 0a0a 6465 6620 7374 6163 6b69 6e67  s...def stacking
-000096f0: 5f72 6d61 2863 635f 6172 7261 792c 2063  _rma(cc_array, c
-00009700: 635f 7469 6d65 2c20 6363 5f6e 676f 6f64  c_time, cc_ngood
-00009710: 2c20 7374 6163 6b5f 7061 7261 293a 0a20  , stack_para):. 
-00009720: 2020 2022 2222 0a20 2020 2074 6869 7320     """.    this 
-00009730: 6675 6e63 7469 6f6e 2073 7461 636b 7320  function stacks 
-00009740: 7468 6520 6372 6f73 7320 636f 7272 656c  the cross correl
-00009750: 6174 696f 6e20 6461 7461 2061 6363 6f72  ation data accor
-00009760: 6469 6e67 2074 6f20 7468 6520 7573 6572  ding to the user
-00009770: 2d64 6566 696e 6564 2073 7562 7374 6163  -defined substac
-00009780: 6b5f 6c65 6e20 7061 7261 6d65 7465 720a  k_len parameter.
-00009790: 2020 2020 5041 5241 4d45 5445 5253 3a0a      PARAMETERS:.
-000097a0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
-000097b0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063  ----------.    c
-000097c0: 635f 6172 7261 793a 2032 4420 6e75 6d70  c_array: 2D nump
-000097d0: 7920 666c 6f61 7433 3220 6d61 7472 6978  y float32 matrix
-000097e0: 2063 6f6e 7461 696e 696e 6720 616c 6c20   containing all 
-000097f0: 7365 676d 656e 7465 6420 6372 6f73 732d  segmented cross-
-00009800: 636f 7272 656c 6174 696f 6e20 6461 7461  correlation data
-00009810: 0a20 2020 2063 635f 7469 6d65 3a20 2031  .    cc_time:  1
-00009820: 4420 6e75 6d70 7920 6172 7261 7920 6f66  D numpy array of
-00009830: 2074 696d 6573 7461 6d70 7320 666f 7220   timestamps for 
-00009840: 6561 6368 2073 6567 6d65 6e74 206f 6620  each segment of 
-00009850: 6363 5f61 7272 6179 0a20 2020 2063 635f  cc_array.    cc_
-00009860: 6e67 6f6f 643a 2031 4420 6e75 6d70 7920  ngood: 1D numpy 
-00009870: 696e 7431 3620 6d61 7472 6978 2073 686f  int16 matrix sho
-00009880: 7769 6e67 2074 6865 206e 756d 6265 7220  wing the number 
-00009890: 6f66 2073 6567 6d65 6e74 7320 666f 7220  of segments for 
-000098a0: 6561 6368 2073 7562 2d73 7461 636b 2061  each sub-stack a
-000098b0: 6e64 2f6f 7220 6675 6c6c 2073 7461 636b  nd/or full stack
-000098c0: 0a20 2020 2073 7461 636b 5f70 6172 613a  .    stack_para:
-000098d0: 2061 2064 6963 7420 636f 6e74 6169 6e69   a dict containi
-000098e0: 6e67 2061 6c6c 2073 7461 636b 696e 6720  ng all stacking 
-000098f0: 7061 7261 6d65 7465 7273 0a20 2020 2052  parameters.    R
-00009900: 4554 5552 4e53 3a0a 2020 2020 2d2d 2d2d  ETURNS:.    ----
-00009910: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00009920: 2d2d 0a20 2020 2063 635f 6172 7261 792c  --.    cc_array,
-00009930: 2063 635f 6e67 6f6f 642c 2063 635f 7469   cc_ngood, cc_ti
-00009940: 6d65 3a20 7361 6d65 2074 6f20 7468 6520  me: same to the 
-00009950: 696e 7075 7420 7061 7261 6d65 7465 7273  input parameters
-00009960: 2062 7574 2077 6974 6820 6162 6e6f 726d   but with abnorm
-00009970: 616c 2063 726f 7373 2d63 6f72 7265 616c  al cross-correal
-00009980: 7469 6f6e 7320 7265 6d6f 7665 640a 2020  tions removed.  
-00009990: 2020 616c 6c73 7461 636b 7331 3a20 3144    allstacks1: 1D
-000099a0: 206d 6174 7269 7820 6f66 2073 7461 636b   matrix of stack
-000099b0: 6564 2063 726f 7373 2d63 6f72 7265 6c61  ed cross-correla
-000099c0: 7469 6f6e 2066 756e 6374 696f 6e73 206f  tion functions o
-000099d0: 7665 7220 616c 6c20 7468 6520 7365 676d  ver all the segm
-000099e0: 656e 7473 0a20 2020 206e 7374 6163 6b73  ents.    nstacks
-000099f0: 3a20 2020 206e 756d 6265 7220 6f66 206f  :    number of o
-00009a00: 7665 7261 6c6c 2073 6567 6d65 6e74 7320  verall segments 
-00009a10: 666f 7220 7468 6520 6669 6e61 6c20 7374  for the final st
-00009a20: 6163 6b73 0a20 2020 2022 2222 0a20 2020  acks.    """.   
-00009a30: 2023 206c 6f61 6420 7573 6566 756c 2070   # load useful p
-00009a40: 6172 616d 6574 6572 7320 6672 6f6d 2064  arameters from d
-00009a50: 6963 740a 2020 2020 7361 6d70 5f66 7265  ict.    samp_fre
-00009a60: 7120 3d20 7374 6163 6b5f 7061 7261 5b22  q = stack_para["
-00009a70: 7361 6d70 5f66 7265 7122 5d0a 2020 2020  samp_freq"].    
-00009a80: 736d 6574 686f 6420 3d20 7374 6163 6b5f  smethod = stack_
-00009a90: 7061 7261 5b22 7374 6163 6b5f 6d65 7468  para["stack_meth
-00009aa0: 6f64 225d 0a20 2020 2072 6d61 5f73 7562  od"].    rma_sub
-00009ab0: 7374 6163 6b20 3d20 7374 6163 6b5f 7061  stack = stack_pa
-00009ac0: 7261 5b22 726d 615f 7375 6273 7461 636b  ra["rma_substack
-00009ad0: 225d 0a20 2020 2072 6d61 5f73 7465 7020  "].    rma_step 
-00009ae0: 3d20 7374 6163 6b5f 7061 7261 5b22 726d  = stack_para["rm
-00009af0: 615f 7374 6570 225d 0a20 2020 2073 7461  a_step"].    sta
-00009b00: 7274 5f64 6174 6520 3d20 7374 6163 6b5f  rt_date = stack_
-00009b10: 7061 7261 5b22 7374 6172 745f 6461 7465  para["start_date
-00009b20: 225d 0a20 2020 2065 6e64 5f64 6174 6520  "].    end_date 
-00009b30: 3d20 7374 6163 6b5f 7061 7261 5b22 656e  = stack_para["en
-00009b40: 645f 6461 7465 225d 0a20 2020 206e 7074  d_date"].    npt
-00009b50: 7320 3d20 6363 5f61 7272 6179 2e73 6861  s = cc_array.sha
-00009b60: 7065 5b31 5d0a 0a20 2020 2023 2072 656d  pe[1]..    # rem
-00009b70: 6f76 6520 6162 6e6f 726d 616c 2064 6174  ove abnormal dat
-00009b80: 610a 2020 2020 616d 706d 6178 203d 206e  a.    ampmax = n
-00009b90: 702e 6d61 7828 6363 5f61 7272 6179 2c20  p.max(cc_array, 
-00009ba0: 6178 6973 3d31 290a 2020 2020 7469 6e64  axis=1).    tind
-00009bb0: 7820 3d20 6e70 2e77 6865 7265 2828 616d  x = np.where((am
-00009bc0: 706d 6178 203c 2032 3020 2a20 6e70 2e6d  pmax < 20 * np.m
-00009bd0: 6564 6961 6e28 616d 706d 6178 2929 2026  edian(ampmax)) &
-00009be0: 2028 616d 706d 6178 203e 2030 2929 5b30   (ampmax > 0))[0
-00009bf0: 5d0a 2020 2020 6966 206e 6f74 206c 656e  ].    if not len
-00009c00: 2874 696e 6478 293a 0a20 2020 2020 2020  (tindx):.       
-00009c10: 2061 6c6c 7374 6163 6b73 3120 3d20 5b5d   allstacks1 = []
-00009c20: 0a20 2020 2020 2020 2061 6c6c 7374 6163  .        allstac
-00009c30: 6b73 3220 3d20 5b5d 0a20 2020 2020 2020  ks2 = [].       
-00009c40: 206e 7374 6163 6b73 203d 2030 0a20 2020   nstacks = 0.   
-00009c50: 2020 2020 2063 635f 6172 7261 7920 3d20       cc_array = 
-00009c60: 5b5d 0a20 2020 2020 2020 2063 635f 6e67  [].        cc_ng
-00009c70: 6f6f 6420 3d20 5b5d 0a20 2020 2020 2020  ood = [].       
-00009c80: 2063 635f 7469 6d65 203d 205b 5d0a 2020   cc_time = [].  
-00009c90: 2020 2020 2020 7265 7475 726e 2063 635f        return cc_
-00009ca0: 6172 7261 792c 2063 635f 6e67 6f6f 642c  array, cc_ngood,
-00009cb0: 2063 635f 7469 6d65 2c20 616c 6c73 7461   cc_time, allsta
-00009cc0: 636b 7331 2c20 616c 6c73 7461 636b 7332  cks1, allstacks2
-00009cd0: 2c20 6e73 7461 636b 730a 2020 2020 656c  , nstacks.    el
-00009ce0: 7365 3a0a 2020 2020 2020 2020 2320 7265  se:.        # re
-00009cf0: 6d6f 7665 206f 6e65 7320 7769 7468 2062  move ones with b
-00009d00: 6164 2061 6d70 6c69 7475 6465 0a20 2020  ad amplitude.   
-00009d10: 2020 2020 2063 635f 6172 7261 7920 3d20       cc_array = 
-00009d20: 6363 5f61 7272 6179 5b74 696e 6478 2c20  cc_array[tindx, 
-00009d30: 3a5d 0a20 2020 2020 2020 2063 635f 7469  :].        cc_ti
-00009d40: 6d65 203d 2063 635f 7469 6d65 5b74 696e  me = cc_time[tin
-00009d50: 6478 5d0a 2020 2020 2020 2020 6363 5f6e  dx].        cc_n
-00009d60: 676f 6f64 203d 2063 635f 6e67 6f6f 645b  good = cc_ngood[
-00009d70: 7469 6e64 785d 0a0a 2020 2020 2020 2020  tindx]..        
-00009d80: 2320 646f 2073 7562 7374 6163 6b73 0a20  # do substacks. 
-00009d90: 2020 2020 2020 2069 6620 726d 615f 7375         if rma_su
-00009da0: 6273 7461 636b 3a0a 2020 2020 2020 2020  bstack:.        
-00009db0: 2020 2020 7473 7461 7274 203d 206f 6273      tstart = obs
-00009dc0: 7079 2e55 5443 4461 7465 5469 6d65 2873  py.UTCDateTime(s
-00009dd0: 7461 7274 5f64 6174 6529 202d 206f 6273  tart_date) - obs
-00009de0: 7079 2e55 5443 4461 7465 5469 6d65 2831  py.UTCDateTime(1
-00009df0: 3937 302c 2031 2c20 3129 0a20 2020 2020  970, 1, 1).     
-00009e00: 2020 2020 2020 2074 656e 6420 3d20 6f62         tend = ob
-00009e10: 7370 792e 5554 4344 6174 6554 696d 6528  spy.UTCDateTime(
-00009e20: 656e 645f 6461 7465 2920 2d20 6f62 7370  end_date) - obsp
-00009e30: 792e 5554 4344 6174 6554 696d 6528 3139  y.UTCDateTime(19
-00009e40: 3730 2c20 312c 2031 290a 2020 2020 2020  70, 1, 1).      
-00009e50: 2020 2020 2020 7474 696d 6520 3d20 7473        ttime = ts
-00009e60: 7461 7274 0a20 2020 2020 2020 2020 2020  tart.           
-00009e70: 206e 7374 6163 6b20 3d20 696e 7428 6e70   nstack = int(np
-00009e80: 2e72 6f75 6e64 2828 7465 6e64 202d 2074  .round((tend - t
-00009e90: 7374 6172 7429 202f 2028 726d 615f 7374  start) / (rma_st
-00009ea0: 6570 202a 2033 3630 3029 2929 0a20 2020  ep * 3600))).   
-00009eb0: 2020 2020 2020 2020 206e 6363 5f61 7272           ncc_arr
-00009ec0: 6179 203d 206e 702e 7a65 726f 7328 7368  ay = np.zeros(sh
-00009ed0: 6170 653d 286e 7374 6163 6b2c 206e 7074  ape=(nstack, npt
-00009ee0: 7329 2c20 6474 7970 653d 6e70 2e66 6c6f  s), dtype=np.flo
-00009ef0: 6174 3332 290a 2020 2020 2020 2020 2020  at32).          
-00009f00: 2020 6e63 635f 7469 6d65 203d 206e 702e    ncc_time = np.
-00009f10: 7a65 726f 7328 6e73 7461 636b 2c20 6474  zeros(nstack, dt
-00009f20: 7970 653d 6e70 2e66 6c6f 6174 290a 2020  ype=np.float).  
-00009f30: 2020 2020 2020 2020 2020 6e63 635f 6e67            ncc_ng
-00009f40: 6f6f 6420 3d20 6e70 2e7a 6572 6f73 286e  ood = np.zeros(n
-00009f50: 7374 6163 6b2c 2064 7479 7065 3d6e 702e  stack, dtype=np.
-00009f60: 696e 7429 0a0a 2020 2020 2020 2020 2020  int)..          
-00009f70: 2020 2320 6c6f 6f70 2074 6872 6f75 6768    # loop through
-00009f80: 2065 6163 6820 7469 6d65 0a20 2020 2020   each time.     
-00009f90: 2020 2020 2020 2066 6f72 2069 6920 696e         for ii in
-00009fa0: 2072 616e 6765 286e 7374 6163 6b29 3a0a   range(nstack):.
-00009fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009fc0: 7369 6e64 7820 3d20 6e70 2e77 6865 7265  sindx = np.where
-00009fd0: 2828 6363 5f74 696d 6520 3e3d 2074 7469  ((cc_time >= tti
-00009fe0: 6d65 2920 2620 2863 635f 7469 6d65 203c  me) & (cc_time <
-00009ff0: 2074 7469 6d65 202b 2072 6d61 5f73 7562   ttime + rma_sub
-0000a000: 7374 6163 6b20 2a20 3336 3030 2929 5b30  stack * 3600))[0
-0000a010: 5d0a 0a20 2020 2020 2020 2020 2020 2020  ]..             
-0000a020: 2020 2023 2077 6865 6e20 7468 6572 6520     # when there 
-0000a030: 6172 6520 6461 7461 2069 6e20 7468 6520  are data in the 
-0000a040: 7469 6d65 2077 696e 646f 770a 2020 2020  time window.    
-0000a050: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-0000a060: 656e 2873 696e 6478 293a 0a20 2020 2020  en(sindx):.     
-0000a070: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0000a080: 6363 5f61 7272 6179 5b69 695d 203d 206e  cc_array[ii] = n
-0000a090: 702e 6d65 616e 2863 635f 6172 7261 795b  p.mean(cc_array[
-0000a0a0: 7369 6e64 785d 2c20 6178 6973 3d30 290a  sindx], axis=0).
-0000a0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a0c0: 2020 2020 6e63 635f 7469 6d65 5b69 695d      ncc_time[ii]
-0000a0d0: 203d 2074 7469 6d65 0a20 2020 2020 2020   = ttime.       
-0000a0e0: 2020 2020 2020 2020 2020 2020 206e 6363               ncc
-0000a0f0: 5f6e 676f 6f64 5b69 695d 203d 206e 702e  _ngood[ii] = np.
-0000a100: 7375 6d28 6363 5f6e 676f 6f64 5b73 696e  sum(cc_ngood[sin
-0000a110: 6478 5d2c 2061 7869 733d 3029 0a20 2020  dx], axis=0).   
-0000a120: 2020 2020 2020 2020 2020 2020 2074 7469               tti
-0000a130: 6d65 202b 3d20 726d 615f 7374 6570 202a  me += rma_step *
-0000a140: 2033 3630 300a 0a20 2020 2020 2020 2020   3600..         
-0000a150: 2020 2023 2072 656d 6f76 6520 6261 6420     # remove bad 
-0000a160: 6f6e 6573 0a20 2020 2020 2020 2020 2020  ones.           
-0000a170: 2074 696e 6478 203d 206e 702e 7768 6572   tindx = np.wher
-0000a180: 6528 6e63 635f 6e67 6f6f 6420 3e20 3029  e(ncc_ngood > 0)
-0000a190: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-0000a1a0: 6e63 635f 6172 7261 7920 3d20 6e63 635f  ncc_array = ncc_
-0000a1b0: 6172 7261 795b 7469 6e64 785d 0a20 2020  array[tindx].   
-0000a1c0: 2020 2020 2020 2020 206e 6363 5f74 696d           ncc_tim
-0000a1d0: 6520 3d20 6e63 635f 7469 6d65 5b74 696e  e = ncc_time[tin
-0000a1e0: 6478 5d0a 2020 2020 2020 2020 2020 2020  dx].            
-0000a1f0: 6e63 635f 6e67 6f6f 6420 3d20 6e63 635f  ncc_ngood = ncc_
-0000a200: 6e67 6f6f 645b 7469 6e64 785d 0a0a 2020  ngood[tindx]..  
-0000a210: 2020 2020 2020 2320 646f 2073 7461 636b        # do stack
-0000a220: 696e 670a 2020 2020 2020 2020 616c 6c73  ing.        alls
-0000a230: 7461 636b 7331 203d 206e 702e 7a65 726f  tacks1 = np.zero
-0000a240: 7328 6e70 7473 2c20 6474 7970 653d 6e70  s(npts, dtype=np
-0000a250: 2e66 6c6f 6174 3332 290a 2020 2020 2020  .float32).      
-0000a260: 2020 616c 6c73 7461 636b 7332 203d 206e    allstacks2 = n
-0000a270: 702e 7a65 726f 7328 6e70 7473 2c20 6474  p.zeros(npts, dt
-0000a280: 7970 653d 6e70 2e66 6c6f 6174 3332 290a  ype=np.float32).
-0000a290: 2020 2020 2020 2020 616c 6c73 7461 636b          allstack
-0000a2a0: 7333 203d 206e 702e 7a65 726f 7328 6e70  s3 = np.zeros(np
-0000a2b0: 7473 2c20 6474 7970 653d 6e70 2e66 6c6f  ts, dtype=np.flo
-0000a2c0: 6174 3332 290a 2020 2020 2020 2020 616c  at32).        al
-0000a2d0: 6c73 7461 636b 7334 203d 206e 702e 7a65  lstacks4 = np.ze
-0000a2e0: 726f 7328 6e70 7473 2c20 6474 7970 653d  ros(npts, dtype=
-0000a2f0: 6e70 2e66 6c6f 6174 3332 290a 0a20 2020  np.float32)..   
-0000a300: 2020 2020 2069 6620 736d 6574 686f 6420       if smethod 
-0000a310: 3d3d 2022 6c69 6e65 6172 223a 0a20 2020  == "linear":.   
-0000a320: 2020 2020 2020 2020 2061 6c6c 7374 6163           allstac
-0000a330: 6b73 3120 3d20 6e70 2e6d 6561 6e28 6363  ks1 = np.mean(cc
-0000a340: 5f61 7272 6179 2c20 6178 6973 3d30 290a  _array, axis=0).
-0000a350: 2020 2020 2020 2020 656c 6966 2073 6d65          elif sme
-0000a360: 7468 6f64 203d 3d20 2270 7773 223a 0a20  thod == "pws":. 
-0000a370: 2020 2020 2020 2020 2020 2061 6c6c 7374             allst
-0000a380: 6163 6b73 3120 3d20 7077 7328 6363 5f61  acks1 = pws(cc_a
-0000a390: 7272 6179 2c20 7361 6d70 5f66 7265 7129  rray, samp_freq)
-0000a3a0: 0a20 2020 2020 2020 2065 6c69 6620 736d  .        elif sm
-0000a3b0: 6574 686f 6420 3d3d 2022 726f 6275 7374  ethod == "robust
-0000a3c0: 223a 0a20 2020 2020 2020 2020 2020 2028  ":.            (
-0000a3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a3e0: 2061 6c6c 7374 6163 6b73 312c 0a20 2020   allstacks1,.   
-0000a3f0: 2020 2020 2020 2020 2020 2020 2077 2c0a               w,.
-0000a400: 2020 2020 2020 2020 2020 2020 2920 3d20              ) = 
-0000a410: 726f 6275 7374 5f73 7461 636b 2863 635f  robust_stack(cc_
-0000a420: 6172 7261 792c 2030 2e30 3031 290a 2020  array, 0.001).  
-0000a430: 2020 2020 2020 656c 6966 2073 6d65 7468        elif smeth
-0000a440: 6f64 203d 3d20 2273 656c 6563 7469 7665  od == "selective
-0000a450: 223a 0a20 2020 2020 2020 2020 2020 2061  ":.            a
-0000a460: 6c6c 7374 6163 6b73 3120 3d20 7365 6c65  llstacks1 = sele
-0000a470: 6374 6976 655f 7374 6163 6b28 6363 5f61  ctive_stack(cc_a
-0000a480: 7272 6179 2c20 302e 3030 3129 0a20 2020  rray, 0.001).   
-0000a490: 2020 2020 2065 6c69 6620 736d 6574 686f       elif smetho
-0000a4a0: 6420 3d3d 2022 616c 6c22 3a0a 2020 2020  d == "all":.    
-0000a4b0: 2020 2020 2020 2020 616c 6c73 7461 636b          allstack
-0000a4c0: 7331 203d 206e 702e 6d65 616e 2863 635f  s1 = np.mean(cc_
-0000a4d0: 6172 7261 792c 2061 7869 733d 3029 0a20  array, axis=0). 
-0000a4e0: 2020 2020 2020 2020 2020 2061 6c6c 7374             allst
-0000a4f0: 6163 6b73 3220 3d20 7077 7328 6363 5f61  acks2 = pws(cc_a
-0000a500: 7272 6179 2c20 7361 6d70 5f66 7265 7129  rray, samp_freq)
-0000a510: 0a20 2020 2020 2020 2020 2020 2061 6c6c  .            all
-0000a520: 7374 6163 6b73 3320 3d20 726f 6275 7374  stacks3 = robust
-0000a530: 5f73 7461 636b 2863 635f 6172 7261 792c  _stack(cc_array,
-0000a540: 2030 2e30 3031 290a 2020 2020 2020 2020   0.001).        
-0000a550: 2020 2020 616c 6c73 7461 636b 7334 203d      allstacks4 =
-0000a560: 2073 656c 6563 7469 7665 5f73 7461 636b   selective_stack
-0000a570: 2863 635f 6172 7261 792c 2030 2e30 3031  (cc_array, 0.001
-0000a580: 290a 2020 2020 2020 2020 6e73 7461 636b  ).        nstack
-0000a590: 7320 3d20 6e70 2e73 756d 2863 635f 6e67  s = np.sum(cc_ng
-0000a5a0: 6f6f 6429 0a0a 2020 2020 2320 7265 706c  ood)..    # repl
-0000a5b0: 6163 6520 7468 6520 6172 7261 7920 666f  ace the array fo
-0000a5c0: 7220 7375 6273 7461 636b 730a 2020 2020  r substacks.    
-0000a5d0: 6966 2072 6d61 5f73 7562 7374 6163 6b3a  if rma_substack:
-0000a5e0: 0a20 2020 2020 2020 2063 635f 6172 7261  .        cc_arra
-0000a5f0: 7920 3d20 6e63 635f 6172 7261 790a 2020  y = ncc_array.  
-0000a600: 2020 2020 2020 6363 5f74 696d 6520 3d20        cc_time = 
-0000a610: 6e63 635f 7469 6d65 0a20 2020 2020 2020  ncc_time.       
-0000a620: 2063 635f 6e67 6f6f 6420 3d20 6e63 635f   cc_ngood = ncc_
-0000a630: 6e67 6f6f 640a 0a20 2020 2023 2067 6f6f  ngood..    # goo
-0000a640: 6420 746f 2072 6574 7572 6e0a 2020 2020  d to return.    
-0000a650: 7265 7475 726e 2028 0a20 2020 2020 2020  return (.       
-0000a660: 2063 635f 6172 7261 792c 0a20 2020 2020   cc_array,.     
-0000a670: 2020 2063 635f 6e67 6f6f 642c 0a20 2020     cc_ngood,.   
-0000a680: 2020 2020 2063 635f 7469 6d65 2c0a 2020       cc_time,.  
-0000a690: 2020 2020 2020 616c 6c73 7461 636b 7331        allstacks1
-0000a6a0: 2c0a 2020 2020 2020 2020 616c 6c73 7461  ,.        allsta
-0000a6b0: 636b 7332 2c0a 2020 2020 2020 2020 616c  cks2,.        al
-0000a6c0: 6c73 7461 636b 7333 2c0a 2020 2020 2020  lstacks3,.      
-0000a6d0: 2020 616c 6c73 7461 636b 7334 2c0a 2020    allstacks4,.  
-0000a6e0: 2020 2020 2020 6e73 7461 636b 732c 0a20        nstacks,. 
-0000a6f0: 2020 2029 0a0a 0a64 6566 2072 6f74 6174     )...def rotat
-0000a700: 696f 6e28 6269 6773 7461 636b 2c20 7061  ion(bigstack, pa
-0000a710: 7261 6d65 7465 7273 2c20 6c6f 6373 2c20  rameters, locs, 
-0000a720: 666c 6167 293a 0a20 2020 2022 2222 0a20  flag):.    """. 
-0000a730: 2020 2074 6869 7320 6675 6e63 7469 6f6e     this function
-0000a740: 2074 7261 6e73 6665 7273 2074 6865 2047   transfers the G
-0000a750: 7265 656e 2773 2074 656e 736f 7220 6672  reen's tensor fr
-0000a760: 6f6d 2061 2045 2d4e 2d5a 2073 7973 7465  om a E-N-Z syste
-0000a770: 6d20 696e 746f 2061 2052 2d54 2d5a 206f  m into a R-T-Z o
-0000a780: 6e65 0a0a 2020 2020 5041 5241 4d45 5445  ne..    PARAMETE
-0000a790: 5253 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  RS:.    --------
-0000a7a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
-0000a7b0: 6269 6773 7461 636b 3a20 2020 3920 636f  bigstack:   9 co
-0000a7c0: 6d70 6f6e 656e 7420 4772 6565 6e27 7320  mponent Green's 
-0000a7d0: 7465 6e73 6f72 2069 6e20 452d 4e2d 5a20  tensor in E-N-Z 
-0000a7e0: 7379 7374 656d 0a20 2020 2070 6172 616d  system.    param
-0000a7f0: 6574 6572 733a 2064 6963 7420 636f 6e74  eters: dict cont
-0000a800: 6169 6e69 6e67 2061 6c6c 2070 6172 616d  aining all param
-0000a810: 6574 6572 7320 7361 7665 6420 696e 2041  eters saved in A
-0000a820: 5344 4620 6669 6c65 0a20 2020 206c 6f63  SDF file.    loc
-0000a830: 733a 2020 2020 2020 2064 6963 7420 636f  s:       dict co
-0000a840: 6e74 6169 6e69 6e67 2073 7461 7469 6f6e  ntaining station
-0000a850: 2061 6e67 6c65 2069 6e66 6f20 666f 7220   angle info for 
-0000a860: 636f 7272 6563 7469 6f6e 2070 7572 706f  correction purpo
-0000a870: 7365 0a20 2020 2052 4554 5552 4e53 3a0a  se.    RETURNS:.
-0000a880: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
-0000a890: 2d2d 2d2d 2d2d 2d0a 2020 2020 7463 6f72  -------.    tcor
-0000a8a0: 723a 2039 2063 6f6d 706f 6e65 6e74 2047  r: 9 component G
-0000a8b0: 7265 656e 2773 2074 656e 736f 7220 696e  reen's tensor in
-0000a8c0: 2052 2d54 2d5a 2073 7973 7465 6d0a 2020   R-T-Z system.  
-0000a8d0: 2020 2222 220a 2020 2020 2320 6c6f 6164    """.    # load
-0000a8e0: 2070 6172 616d 6574 6572 2064 6963 0a20   parameter dic. 
-0000a8f0: 2020 2070 6920 3d20 6e70 2e70 690a 2020     pi = np.pi.  
-0000a900: 2020 617a 6920 3d20 7061 7261 6d65 7465    azi = paramete
-0000a910: 7273 5b22 617a 6922 5d0a 2020 2020 6261  rs["azi"].    ba
-0000a920: 7a20 3d20 7061 7261 6d65 7465 7273 5b22  z = parameters["
-0000a930: 6261 7a22 5d0a 2020 2020 6e63 6f6d 702c  baz"].    ncomp,
-0000a940: 206e 7074 7320 3d20 6269 6773 7461 636b   npts = bigstack
-0000a950: 2e73 6861 7065 0a20 2020 2069 6620 6e63  .shape.    if nc
-0000a960: 6f6d 7020 3c20 393a 0a20 2020 2020 2020  omp < 9:.       
-0000a970: 2070 7269 6e74 2822 6372 6170 2064 6964   print("crap did
-0000a980: 206e 6f74 2067 6574 2065 6e6f 7567 6820   not get enough 
-0000a990: 636f 6d70 6f6e 656e 7473 2229 0a20 2020  components").   
-0000a9a0: 2020 2020 2074 636f 7272 203d 205b 5d0a       tcorr = [].
-0000a9b0: 2020 2020 2020 2020 7265 7475 726e 2074          return t
-0000a9c0: 636f 7272 0a20 2020 2073 7461 5320 3d20  corr.    staS = 
-0000a9d0: 7061 7261 6d65 7465 7273 5b22 7374 6174  parameters["stat
-0000a9e0: 696f 6e5f 736f 7572 6365 225d 0a20 2020  ion_source"].   
-0000a9f0: 2073 7461 5220 3d20 7061 7261 6d65 7465   staR = paramete
-0000aa00: 7273 5b22 7374 6174 696f 6e5f 7265 6365  rs["station_rece
-0000aa10: 6976 6572 225d 0a0a 2020 2020 6966 206c  iver"]..    if l
-0000aa20: 656e 286c 6f63 7329 3a0a 2020 2020 2020  en(locs):.      
-0000aa30: 2020 7374 615f 6c69 7374 203d 206c 6973    sta_list = lis
-0000aa40: 7428 6c6f 6373 5b22 7374 6174 696f 6e22  t(locs["station"
-0000aa50: 5d29 0a20 2020 2020 2020 2061 6e67 6c65  ]).        angle
-0000aa60: 7320 3d20 6c69 7374 286c 6f63 735b 2261  s = list(locs["a
-0000aa70: 6e67 6c65 225d 290a 2020 2020 2020 2020  ngle"]).        
-0000aa80: 2320 6765 7420 7374 6174 696f 6e20 696e  # get station in
-0000aa90: 666f 2066 726f 6d20 7468 6520 6e61 6d65  fo from the name
-0000aaa0: 206f 6620 4153 4446 2066 696c 650a 2020   of ASDF file.  
-0000aab0: 2020 2020 2020 696e 6420 3d20 7374 615f        ind = sta_
-0000aac0: 6c69 7374 2e69 6e64 6578 2873 7461 5329  list.index(staS)
-0000aad0: 0a20 2020 2020 2020 2061 636f 7272 203d  .        acorr =
-0000aae0: 2061 6e67 6c65 735b 696e 645d 0a20 2020   angles[ind].   
-0000aaf0: 2020 2020 2069 6e64 203d 2073 7461 5f6c       ind = sta_l
-0000ab00: 6973 742e 696e 6465 7828 7374 6152 290a  ist.index(staR).
-0000ab10: 2020 2020 2020 2020 6263 6f72 7220 3d20          bcorr = 
-0000ab20: 616e 676c 6573 5b69 6e64 5d0a 0a20 2020  angles[ind]..   
-0000ab30: 2023 202d 2d2d 616e 676c 6573 2074 6f20   # ---angles to 
-0000ab40: 6265 2063 6f72 7265 6374 6564 2d2d 2d2d  be corrected----
-0000ab50: 0a20 2020 2069 6620 6c65 6e28 6c6f 6373  .    if len(locs
-0000ab60: 293a 0a20 2020 2020 2020 2063 6f73 6120  ):.        cosa 
-0000ab70: 3d20 6e70 2e63 6f73 2828 617a 6920 2b20  = np.cos((azi + 
-0000ab80: 6163 6f72 7229 202a 2070 6920 2f20 3138  acorr) * pi / 18
-0000ab90: 3029 0a20 2020 2020 2020 2073 696e 6120  0).        sina 
-0000aba0: 3d20 6e70 2e73 696e 2828 617a 6920 2b20  = np.sin((azi + 
-0000abb0: 6163 6f72 7229 202a 2070 6920 2f20 3138  acorr) * pi / 18
-0000abc0: 3029 0a20 2020 2020 2020 2063 6f73 6220  0).        cosb 
-0000abd0: 3d20 6e70 2e63 6f73 2828 6261 7a20 2b20  = np.cos((baz + 
-0000abe0: 6263 6f72 7229 202a 2070 6920 2f20 3138  bcorr) * pi / 18
-0000abf0: 3029 0a20 2020 2020 2020 2073 696e 6220  0).        sinb 
-0000ac00: 3d20 6e70 2e73 696e 2828 6261 7a20 2b20  = np.sin((baz + 
-0000ac10: 6263 6f72 7229 202a 2070 6920 2f20 3138  bcorr) * pi / 18
-0000ac20: 3029 0a20 2020 2065 6c73 653a 0a20 2020  0).    else:.   
-0000ac30: 2020 2020 2063 6f73 6120 3d20 6e70 2e63       cosa = np.c
-0000ac40: 6f73 2861 7a69 202a 2070 6920 2f20 3138  os(azi * pi / 18
-0000ac50: 3029 0a20 2020 2020 2020 2073 696e 6120  0).        sina 
-0000ac60: 3d20 6e70 2e73 696e 2861 7a69 202a 2070  = np.sin(azi * p
-0000ac70: 6920 2f20 3138 3029 0a20 2020 2020 2020  i / 180).       
-0000ac80: 2063 6f73 6220 3d20 6e70 2e63 6f73 2862   cosb = np.cos(b
-0000ac90: 617a 202a 2070 6920 2f20 3138 3029 0a20  az * pi / 180). 
-0000aca0: 2020 2020 2020 2073 696e 6220 3d20 6e70         sinb = np
-0000acb0: 2e73 696e 2862 617a 202a 2070 6920 2f20  .sin(baz * pi / 
-0000acc0: 3138 3029 0a0a 2020 2020 2320 7274 7a5f  180)..    # rtz_
-0000acd0: 636f 6d70 6f6e 656e 7473 203d 205b 275a  components = ['Z
-0000ace0: 5227 2c27 5a54 272c 275a 5a27 2c27 5252  R','ZT','ZZ','RR
-0000acf0: 272c 2752 5427 2c27 525a 272c 2754 5227  ','RT','RZ','TR'
-0000ad00: 2c27 5454 272c 2754 5a27 5d0a 2020 2020  ,'TT','TZ'].    
-0000ad10: 7463 6f72 7220 3d20 6e70 2e7a 6572 6f73  tcorr = np.zeros
-0000ad20: 2873 6861 7065 3d28 392c 206e 7074 7329  (shape=(9, npts)
-0000ad30: 2c20 6474 7970 653d 6e70 2e66 6c6f 6174  , dtype=np.float
-0000ad40: 3332 290a 2020 2020 7463 6f72 725b 305d  32).    tcorr[0]
-0000ad50: 203d 202d 636f 7362 202a 2062 6967 7374   = -cosb * bigst
-0000ad60: 6163 6b5b 375d 202d 2073 696e 6220 2a20  ack[7] - sinb * 
-0000ad70: 6269 6773 7461 636b 5b36 5d0a 2020 2020  bigstack[6].    
-0000ad80: 7463 6f72 725b 315d 203d 2073 696e 6220  tcorr[1] = sinb 
-0000ad90: 2a20 6269 6773 7461 636b 5b37 5d20 2d20  * bigstack[7] - 
-0000ada0: 636f 7362 202a 2062 6967 7374 6163 6b5b  cosb * bigstack[
-0000adb0: 365d 0a20 2020 2074 636f 7272 5b32 5d20  6].    tcorr[2] 
-0000adc0: 3d20 6269 6773 7461 636b 5b38 5d0a 2020  = bigstack[8].  
-0000add0: 2020 7463 6f72 725b 335d 203d 2028 0a20    tcorr[3] = (. 
-0000ade0: 2020 2020 2020 202d 636f 7361 202a 2063         -cosa * c
-0000adf0: 6f73 6220 2a20 6269 6773 7461 636b 5b34  osb * bigstack[4
-0000ae00: 5d20 2d20 636f 7361 202a 2073 696e 6220  ] - cosa * sinb 
-0000ae10: 2a20 6269 6773 7461 636b 5b33 5d20 2d20  * bigstack[3] - 
-0000ae20: 7369 6e61 202a 2063 6f73 6220 2a20 6269  sina * cosb * bi
-0000ae30: 6773 7461 636b 5b31 5d20 2d20 7369 6e61  gstack[1] - sina
-0000ae40: 202a 2073 696e 6220 2a20 6269 6773 7461   * sinb * bigsta
-0000ae50: 636b 5b30 5d0a 2020 2020 290a 2020 2020  ck[0].    ).    
-0000ae60: 7463 6f72 725b 345d 203d 2028 0a20 2020  tcorr[4] = (.   
-0000ae70: 2020 2020 2063 6f73 6120 2a20 7369 6e62       cosa * sinb
-0000ae80: 202a 2062 6967 7374 6163 6b5b 345d 202d   * bigstack[4] -
-0000ae90: 2063 6f73 6120 2a20 636f 7362 202a 2062   cosa * cosb * b
-0000aea0: 6967 7374 6163 6b5b 335d 202b 2073 696e  igstack[3] + sin
-0000aeb0: 6120 2a20 7369 6e62 202a 2062 6967 7374  a * sinb * bigst
-0000aec0: 6163 6b5b 315d 202d 2073 696e 6120 2a20  ack[1] - sina * 
-0000aed0: 636f 7362 202a 2062 6967 7374 6163 6b5b  cosb * bigstack[
-0000aee0: 305d 0a20 2020 2029 0a20 2020 2074 636f  0].    ).    tco
-0000aef0: 7272 5b35 5d20 3d20 636f 7361 202a 2062  rr[5] = cosa * b
-0000af00: 6967 7374 6163 6b5b 355d 202b 2073 696e  igstack[5] + sin
-0000af10: 6120 2a20 6269 6773 7461 636b 5b32 5d0a  a * bigstack[2].
-0000af20: 2020 2020 7463 6f72 725b 365d 203d 2028      tcorr[6] = (
-0000af30: 0a20 2020 2020 2020 2073 696e 6120 2a20  .        sina * 
-0000af40: 636f 7362 202a 2062 6967 7374 6163 6b5b  cosb * bigstack[
-0000af50: 345d 202b 2073 696e 6120 2a20 7369 6e62  4] + sina * sinb
-0000af60: 202a 2062 6967 7374 6163 6b5b 335d 202d   * bigstack[3] -
-0000af70: 2063 6f73 6120 2a20 636f 7362 202a 2062   cosa * cosb * b
-0000af80: 6967 7374 6163 6b5b 315d 202d 2063 6f73  igstack[1] - cos
-0000af90: 6120 2a20 7369 6e62 202a 2062 6967 7374  a * sinb * bigst
-0000afa0: 6163 6b5b 305d 0a20 2020 2029 0a20 2020  ack[0].    ).   
-0000afb0: 2074 636f 7272 5b37 5d20 3d20 280a 2020   tcorr[7] = (.  
-0000afc0: 2020 2020 2020 2d73 696e 6120 2a20 7369        -sina * si
-0000afd0: 6e62 202a 2062 6967 7374 6163 6b5b 345d  nb * bigstack[4]
-0000afe0: 202b 2073 696e 6120 2a20 636f 7362 202a   + sina * cosb *
-0000aff0: 2062 6967 7374 6163 6b5b 335d 202b 2063   bigstack[3] + c
-0000b000: 6f73 6120 2a20 7369 6e62 202a 2062 6967  osa * sinb * big
-0000b010: 7374 6163 6b5b 315d 202d 2063 6f73 6120  stack[1] - cosa 
-0000b020: 2a20 636f 7362 202a 2062 6967 7374 6163  * cosb * bigstac
-0000b030: 6b5b 305d 0a20 2020 2029 0a20 2020 2074  k[0].    ).    t
-0000b040: 636f 7272 5b38 5d20 3d20 2d73 696e 6120  corr[8] = -sina 
-0000b050: 2a20 6269 6773 7461 636b 5b35 5d20 2b20  * bigstack[5] + 
-0000b060: 636f 7361 202a 2062 6967 7374 6163 6b5b  cosa * bigstack[
-0000b070: 325d 0a0a 2020 2020 7265 7475 726e 2074  2]..    return t
-0000b080: 636f 7272 0a0a 0a23 2323 2323 2323 2323  corr...#########
-0000b090: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b0a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b0b0: 2323 2323 2323 2323 2323 230a 2323 2323  ###########.####
-0000b0c0: 2323 2323 2323 2323 2323 2055 5449 4c49  ########## UTILI
-0000b0d0: 5459 2046 554e 4354 494f 4e53 2023 2323  TY FUNCTIONS ###
-0000b0e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b0f0: 0a23 2323 2323 2323 2323 2323 2323 2323  .###############
-0000b100: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b110: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b120: 2323 2323 230a 0a0a 6465 6620 6368 6563  #####...def chec
-0000b130: 6b5f 7361 6d70 6c65 5f67 6170 7328 7374  k_sample_gaps(st
-0000b140: 7265 616d 2c20 6461 7465 5f69 6e66 6f29  ream, date_info)
-0000b150: 3a0a 2020 2020 2222 220a 2020 2020 7468  :.    """.    th
-0000b160: 6973 2066 756e 6374 696f 6e20 6368 6563  is function chec
-0000b170: 6b73 2073 616d 706c 696e 6720 7261 7465  ks sampling rate
-0000b180: 2061 6e64 2066 696e 6420 6761 7073 206f   and find gaps o
-0000b190: 6620 616c 6c20 7472 6163 6573 2069 6e20  f all traces in 
-0000b1a0: 7374 7265 616d 2e0a 2020 2020 5041 5241  stream..    PARA
-0000b1b0: 4d45 5445 5253 3a0a 2020 2020 2d2d 2d2d  METERS:.    ----
-0000b1c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
-0000b1d0: 2020 7374 7265 616d 3a20 6f62 7370 7920    stream: obspy 
-0000b1e0: 7374 7265 616d 206f 626a 6563 742e 0a20  stream object.. 
-0000b1f0: 2020 2064 6174 655f 696e 666f 3a20 6469     date_info: di
-0000b200: 6374 206f 6620 7374 6172 7469 6e67 2061  ct of starting a
-0000b210: 6e64 2065 6e64 696e 6720 7469 6d65 206f  nd ending time o
-0000b220: 6620 7468 6520 7374 7265 616d 0a0a 2020  f the stream..  
-0000b230: 2020 5245 5455 5245 4e53 3a0a 2020 2020    RETURENS:.    
-0000b240: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000b250: 2d0a 2020 2020 7374 7265 616d 3a20 4c69  -.    stream: Li
-0000b260: 7374 206f 6620 676f 6f64 2074 7261 6365  st of good trace
-0000b270: 7320 696e 2074 6865 2073 7472 6561 6d0a  s in the stream.
-0000b280: 2020 2020 2222 220a 2020 2020 2320 7265      """.    # re
-0000b290: 6d6f 7665 2065 6d70 7479 2f62 6967 2074  move empty/big t
-0000b2a0: 7261 6365 730a 2020 2020 6966 206c 656e  races.    if len
-0000b2b0: 2873 7472 6561 6d29 203d 3d20 3020 6f72  (stream) == 0 or
-0000b2c0: 206c 656e 2873 7472 6561 6d29 203e 2031   len(stream) > 1
-0000b2d0: 3030 3a0a 2020 2020 2020 2020 7374 7265  00:.        stre
-0000b2e0: 616d 203d 205b 5d0a 2020 2020 2020 2020  am = [].        
-0000b2f0: 7265 7475 726e 2073 7472 6561 6d0a 0a20  return stream.. 
-0000b300: 2020 2023 2072 656d 6f76 6520 7472 6163     # remove trac
-0000b310: 6573 2077 6974 6820 6269 6720 6761 7073  es with big gaps
-0000b320: 0a20 2020 2069 6620 706f 7274 696f 6e5f  .    if portion_
-0000b330: 6761 7073 2873 7472 6561 6d2c 2064 6174  gaps(stream, dat
-0000b340: 655f 696e 666f 2920 3e20 302e 333a 0a20  e_info) > 0.3:. 
-0000b350: 2020 2020 2020 2073 7472 6561 6d20 3d20         stream = 
-0000b360: 5b5d 0a20 2020 2020 2020 2072 6574 7572  [].        retur
-0000b370: 6e20 7374 7265 616d 0a0a 2020 2020 6672  n stream..    fr
-0000b380: 6571 7320 3d20 5b5d 0a20 2020 2066 6f72  eqs = [].    for
-0000b390: 2074 7220 696e 2073 7472 6561 6d3a 0a20   tr in stream:. 
-0000b3a0: 2020 2020 2020 2066 7265 7173 2e61 7070         freqs.app
-0000b3b0: 656e 6428 696e 7428 7472 2e73 7461 7473  end(int(tr.stats
-0000b3c0: 2e73 616d 706c 696e 675f 7261 7465 2929  .sampling_rate))
-0000b3d0: 0a20 2020 2066 7265 7120 3d20 6d61 7828  .    freq = max(
-0000b3e0: 6672 6571 7329 0a20 2020 2066 6f72 2074  freqs).    for t
-0000b3f0: 7220 696e 2073 7472 6561 6d3a 0a20 2020  r in stream:.   
-0000b400: 2020 2020 2069 6620 696e 7428 7472 2e73       if int(tr.s
-0000b410: 7461 7473 2e73 616d 706c 696e 675f 7261  tats.sampling_ra
-0000b420: 7465 2920 213d 2066 7265 713a 0a20 2020  te) != freq:.   
-0000b430: 2020 2020 2020 2020 2073 7472 6561 6d2e           stream.
-0000b440: 7265 6d6f 7665 2874 7229 0a20 2020 2020  remove(tr).     
-0000b450: 2020 2069 6620 7472 2e73 7461 7473 2e6e     if tr.stats.n
-0000b460: 7074 7320 3c20 3130 3a0a 2020 2020 2020  pts < 10:.      
-0000b470: 2020 2020 2020 7374 7265 616d 2e72 656d        stream.rem
-0000b480: 6f76 6528 7472 290a 0a20 2020 2072 6574  ove(tr)..    ret
-0000b490: 7572 6e20 7374 7265 616d 0a0a 0a64 6566  urn stream...def
+00003520: 2020 2020 280a 2020 2020 2020 2020 2020      (.          
+00003530: 2020 2020 2020 2020 2020 2020 2020 2257                "W
+00003540: 6172 6e69 6e67 2120 4d6f 7265 2074 6861  arning! More tha
+00003550: 6e20 6f6e 6520 5374 6174 696f 6e58 4d4c  n one StationXML
+00003560: 2066 696c 6520 7761 7320 666f 756e 6420   file was found 
+00003570: 666f 7220 7374 6174 696f 6e20 2573 2e22  for station %s."
+00003580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003590: 2020 2020 2020 2020 202b 2022 4b65 6570           + "Keep
+000035a0: 696e 6720 7468 6520 6669 7273 7420 6669  ing the first fi
+000035b0: 6c65 2069 6e20 6c69 7374 2e22 0a20 2020  le in list.".   
+000035c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000035d0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+000035e0: 2020 2020 2020 2025 2073 7461 7473 2e73         % stats.s
+000035f0: 7461 7469 6f6e 0a20 2020 2020 2020 2020  tation.         
+00003600: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00003610: 2020 2020 2069 6620 6f73 2e70 6174 682e       if os.path.
+00003620: 6973 6669 6c65 2873 7472 2869 6e76 6669  isfile(str(invfi
+00003630: 6c65 2929 3a0a 2020 2020 2020 2020 2020  le)):.          
+00003640: 2020 2020 2020 696e 7620 3d20 6f62 7370        inv = obsp
+00003650: 792e 7265 6164 5f69 6e76 656e 746f 7279  y.read_inventory
+00003660: 2869 6e76 6669 6c65 290a 2020 2020 2020  (invfile).      
+00003670: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00003680: 2069 6e76 0a20 2020 2020 2020 2065 6c73   inv.        els
+00003690: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+000036a0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+000036b0: 2243 6f75 6c64 206e 6f74 2066 696e 6420  "Could not find 
+000036c0: 6120 5374 6174 696f 6e58 4d4c 2066 696c  a StationXML fil
+000036d0: 6520 666f 7220 7374 6174 696f 6e3a 2025  e for station: %
+000036e0: 732e 2220 2520 7374 6174 732e 7374 6174  s." % stats.stat
+000036f0: 696f 6e29 0a0a 0a64 6566 2073 7461 7473  ion)...def stats
+00003700: 3269 6e76 5f73 6163 2873 7461 7473 293a  2inv_sac(stats):
+00003710: 0a20 2020 2069 6e76 203d 2049 6e76 656e  .    inv = Inven
+00003720: 746f 7279 286e 6574 776f 726b 733d 5b5d  tory(networks=[]
+00003730: 2c20 736f 7572 6365 3d22 686f 6d65 6772  , source="homegr
+00003740: 6f77 6e22 290a 2020 2020 6e65 7420 3d20  own").    net = 
+00003750: 4e65 7477 6f72 6b28 0a20 2020 2020 2020  Network(.       
+00003760: 2023 2054 6869 7320 6973 2074 6865 206e   # This is the n
+00003770: 6574 776f 726b 2063 6f64 6520 6163 636f  etwork code acco
+00003780: 7264 696e 6720 746f 2074 6865 2053 4545  rding to the SEE
+00003790: 4420 7374 616e 6461 7264 2e0a 2020 2020  D standard..    
+000037a0: 2020 2020 636f 6465 3d73 7461 7473 2e6e      code=stats.n
+000037b0: 6574 776f 726b 2c0a 2020 2020 2020 2020  etwork,.        
+000037c0: 7374 6174 696f 6e73 3d5b 5d2c 0a20 2020  stations=[],.   
+000037d0: 2020 2020 2064 6573 6372 6970 7469 6f6e       description
+000037e0: 3d22 6372 6561 7465 6420 6672 6f6d 2053  ="created from S
+000037f0: 4143 2061 6e64 2072 6573 7020 6669 6c65  AC and resp file
+00003800: 7322 2c0a 2020 2020 2020 2020 7374 6172  s",.        star
+00003810: 745f 6461 7465 3d73 7461 7473 2e73 7461  t_date=stats.sta
+00003820: 7274 7469 6d65 2c0a 2020 2020 290a 0a20  rttime,.    ).. 
+00003830: 2020 2073 7461 203d 2053 7461 7469 6f6e     sta = Station
+00003840: 280a 2020 2020 2020 2020 2320 5468 6973  (.        # This
+00003850: 2069 7320 7468 6520 7374 6174 696f 6e20   is the station 
+00003860: 636f 6465 2061 6363 6f72 6469 6e67 2074  code according t
+00003870: 6f20 7468 6520 5345 4544 2073 7461 6e64  o the SEED stand
+00003880: 6172 642e 0a20 2020 2020 2020 2063 6f64  ard..        cod
+00003890: 653d 7374 6174 732e 7374 6174 696f 6e2c  e=stats.station,
+000038a0: 0a20 2020 2020 2020 206c 6174 6974 7564  .        latitud
+000038b0: 653d 7374 6174 732e 7361 635b 2273 746c  e=stats.sac["stl
+000038c0: 6122 5d2c 0a20 2020 2020 2020 206c 6f6e  a"],.        lon
+000038d0: 6769 7475 6465 3d73 7461 7473 2e73 6163  gitude=stats.sac
+000038e0: 5b22 7374 6c6f 225d 2c0a 2020 2020 2020  ["stlo"],.      
+000038f0: 2020 656c 6576 6174 696f 6e3d 7374 6174    elevation=stat
+00003900: 732e 7361 635b 2273 7465 6c22 5d2c 0a20  s.sac["stel"],. 
+00003910: 2020 2020 2020 2063 7265 6174 696f 6e5f         creation_
+00003920: 6461 7465 3d73 7461 7473 2e73 7461 7274  date=stats.start
+00003930: 7469 6d65 2c0a 2020 2020 2020 2020 7369  time,.        si
+00003940: 7465 3d53 6974 6528 6e61 6d65 3d22 4669  te=Site(name="Fi
+00003950: 7273 7420 7374 6174 696f 6e22 292c 0a20  rst station"),. 
+00003960: 2020 2029 0a0a 2020 2020 6368 6120 3d20     )..    cha = 
+00003970: 4368 616e 6e65 6c28 0a20 2020 2020 2020  Channel(.       
+00003980: 2023 2054 6869 7320 6973 2074 6865 2063   # This is the c
+00003990: 6861 6e6e 656c 2063 6f64 6520 6163 636f  hannel code acco
+000039a0: 7264 696e 6720 746f 2074 6865 2053 4545  rding to the SEE
+000039b0: 4420 7374 616e 6461 7264 2e0a 2020 2020  D standard..    
+000039c0: 2020 2020 636f 6465 3d73 7461 7473 2e63      code=stats.c
+000039d0: 6861 6e6e 656c 2c0a 2020 2020 2020 2020  hannel,.        
+000039e0: 2320 5468 6973 2069 7320 7468 6520 6c6f  # This is the lo
+000039f0: 6361 7469 6f6e 2063 6f64 6520 6163 636f  cation code acco
+00003a00: 7264 696e 6720 746f 2074 6865 2053 4545  rding to the SEE
+00003a10: 4420 7374 616e 6461 7264 2e0a 2020 2020  D standard..    
+00003a20: 2020 2020 6c6f 6361 7469 6f6e 5f63 6f64      location_cod
+00003a30: 653d 7374 6174 732e 6c6f 6361 7469 6f6e  e=stats.location
+00003a40: 2c0a 2020 2020 2020 2020 2320 4e6f 7465  ,.        # Note
+00003a50: 2074 6861 7420 7468 6573 6520 636f 6f72   that these coor
+00003a60: 6469 6e61 7465 7320 6361 6e20 6469 6666  dinates can diff
+00003a70: 6572 2066 726f 6d20 7468 6520 7374 6174  er from the stat
+00003a80: 696f 6e20 636f 6f72 6469 6e61 7465 732e  ion coordinates.
+00003a90: 0a20 2020 2020 2020 206c 6174 6974 7564  .        latitud
+00003aa0: 653d 7374 6174 732e 7361 635b 2273 746c  e=stats.sac["stl
+00003ab0: 6122 5d2c 0a20 2020 2020 2020 206c 6f6e  a"],.        lon
+00003ac0: 6769 7475 6465 3d73 7461 7473 2e73 6163  gitude=stats.sac
+00003ad0: 5b22 7374 6c6f 225d 2c0a 2020 2020 2020  ["stlo"],.      
+00003ae0: 2020 656c 6576 6174 696f 6e3d 7374 6174    elevation=stat
+00003af0: 732e 7361 635b 2273 7465 6c22 5d2c 0a20  s.sac["stel"],. 
+00003b00: 2020 2020 2020 2064 6570 7468 3d2d 7374         depth=-st
+00003b10: 6174 732e 7361 635b 2273 7465 6c22 5d2c  ats.sac["stel"],
+00003b20: 0a20 2020 2020 2020 2061 7a69 6d75 7468  .        azimuth
+00003b30: 3d73 7461 7473 2e73 6163 5b22 636d 7061  =stats.sac["cmpa
+00003b40: 7a22 5d2c 0a20 2020 2020 2020 2064 6970  z"],.        dip
+00003b50: 3d73 7461 7473 2e73 6163 5b22 636d 7069  =stats.sac["cmpi
+00003b60: 6e63 225d 2c0a 2020 2020 2020 2020 7361  nc"],.        sa
+00003b70: 6d70 6c65 5f72 6174 653d 7374 6174 732e  mple_rate=stats.
+00003b80: 7361 6d70 6c69 6e67 5f72 6174 652c 0a20  sampling_rate,. 
+00003b90: 2020 2029 0a20 2020 2072 6573 706f 6e73     ).    respons
+00003ba0: 6520 3d20 6f62 7370 792e 636f 7265 2e69  e = obspy.core.i
+00003bb0: 6e76 656e 746f 7279 2e72 6573 706f 6e73  nventory.respons
+00003bc0: 652e 5265 7370 6f6e 7365 2829 0a0a 2020  e.Response()..  
+00003bd0: 2020 2320 4e6f 7720 7469 6520 6974 2061    # Now tie it a
+00003be0: 6c6c 2074 6f67 6574 6865 722e 0a20 2020  ll together..   
+00003bf0: 2063 6861 2e72 6573 706f 6e73 6520 3d20   cha.response = 
+00003c00: 7265 7370 6f6e 7365 0a20 2020 2073 7461  response.    sta
+00003c10: 2e63 6861 6e6e 656c 732e 6170 7065 6e64  .channels.append
+00003c20: 2863 6861 290a 2020 2020 6e65 742e 7374  (cha).    net.st
+00003c30: 6174 696f 6e73 2e61 7070 656e 6428 7374  ations.append(st
+00003c40: 6129 0a20 2020 2069 6e76 2e6e 6574 776f  a).    inv.netwo
+00003c50: 726b 732e 6170 7065 6e64 286e 6574 290a  rks.append(net).
+00003c60: 0a20 2020 2072 6574 7572 6e20 696e 760a  .    return inv.
+00003c70: 0a0a 6465 6620 7374 6174 7332 696e 765f  ..def stats2inv_
+00003c80: 6d73 6565 6428 7374 6174 732c 206c 6f63  mseed(stats, loc
+00003c90: 733a 2070 642e 4461 7461 4672 616d 6529  s: pd.DataFrame)
+00003ca0: 202d 3e20 496e 7665 6e74 6f72 793a 0a20   -> Inventory:. 
+00003cb0: 2020 2069 6e76 203d 2049 6e76 656e 746f     inv = Invento
+00003cc0: 7279 286e 6574 776f 726b 733d 5b5d 2c20  ry(networks=[], 
+00003cd0: 736f 7572 6365 3d22 686f 6d65 6772 6f77  source="homegrow
+00003ce0: 6e22 290a 2020 2020 6973 7461 203d 206c  n").    ista = l
+00003cf0: 6f63 735b 6c6f 6373 5b22 7374 6174 696f  ocs[locs["statio
+00003d00: 6e22 5d20 3d3d 2073 7461 7473 2e73 7461  n"] == stats.sta
+00003d10: 7469 6f6e 5d2e 696e 6465 782e 7661 6c75  tion].index.valu
+00003d20: 6573 2e61 7374 7970 6528 2269 6e74 3634  es.astype("int64
+00003d30: 2229 5b30 5d0a 0a20 2020 206e 6574 203d  ")[0]..    net =
+00003d40: 204e 6574 776f 726b 280a 2020 2020 2020   Network(.      
+00003d50: 2020 2320 5468 6973 2069 7320 7468 6520    # This is the 
+00003d60: 6e65 7477 6f72 6b20 636f 6465 2061 6363  network code acc
+00003d70: 6f72 6469 6e67 2074 6f20 7468 6520 5345  ording to the SE
+00003d80: 4544 2073 7461 6e64 6172 642e 0a20 2020  ED standard..   
+00003d90: 2020 2020 2063 6f64 653d 6c6f 6373 2e69       code=locs.i
+00003da0: 6c6f 635b 6973 7461 5d5b 226e 6574 776f  loc[ista]["netwo
+00003db0: 726b 225d 2c0a 2020 2020 2020 2020 7374  rk"],.        st
+00003dc0: 6174 696f 6e73 3d5b 5d2c 0a20 2020 2020  ations=[],.     
+00003dd0: 2020 2064 6573 6372 6970 7469 6f6e 3d22     description="
+00003de0: 6372 6561 7465 6420 6672 6f6d 2053 4143  created from SAC
+00003df0: 2061 6e64 2072 6573 7020 6669 6c65 7322   and resp files"
+00003e00: 2c0a 2020 2020 2020 2020 7374 6172 745f  ,.        start_
+00003e10: 6461 7465 3d73 7461 7473 2e73 7461 7274  date=stats.start
+00003e20: 7469 6d65 2c0a 2020 2020 290a 0a20 2020  time,.    )..   
+00003e30: 2073 7461 203d 2053 7461 7469 6f6e 280a   sta = Station(.
+00003e40: 2020 2020 2020 2020 2320 5468 6973 2069          # This i
+00003e50: 7320 7468 6520 7374 6174 696f 6e20 636f  s the station co
+00003e60: 6465 2061 6363 6f72 6469 6e67 2074 6f20  de according to 
+00003e70: 7468 6520 5345 4544 2073 7461 6e64 6172  the SEED standar
+00003e80: 642e 0a20 2020 2020 2020 2063 6f64 653d  d..        code=
+00003e90: 6c6f 6373 2e69 6c6f 635b 6973 7461 5d5b  locs.iloc[ista][
+00003ea0: 2273 7461 7469 6f6e 225d 2c0a 2020 2020  "station"],.    
+00003eb0: 2020 2020 6c61 7469 7475 6465 3d6c 6f63      latitude=loc
+00003ec0: 732e 696c 6f63 5b69 7374 615d 5b22 6c61  s.iloc[ista]["la
+00003ed0: 7469 7475 6465 225d 2c0a 2020 2020 2020  titude"],.      
+00003ee0: 2020 6c6f 6e67 6974 7564 653d 6c6f 6373    longitude=locs
+00003ef0: 2e69 6c6f 635b 6973 7461 5d5b 226c 6f6e  .iloc[ista]["lon
+00003f00: 6769 7475 6465 225d 2c0a 2020 2020 2020  gitude"],.      
+00003f10: 2020 656c 6576 6174 696f 6e3d 6c6f 6373    elevation=locs
+00003f20: 2e69 6c6f 635b 6973 7461 5d5b 2265 6c65  .iloc[ista]["ele
+00003f30: 7661 7469 6f6e 225d 2c0a 2020 2020 2020  vation"],.      
+00003f40: 2020 6372 6561 7469 6f6e 5f64 6174 653d    creation_date=
+00003f50: 7374 6174 732e 7374 6172 7474 696d 652c  stats.starttime,
+00003f60: 0a20 2020 2020 2020 2073 6974 653d 5369  .        site=Si
+00003f70: 7465 286e 616d 653d 2246 6972 7374 2073  te(name="First s
+00003f80: 7461 7469 6f6e 2229 2c0a 2020 2020 290a  tation"),.    ).
+00003f90: 0a20 2020 2063 6861 203d 2043 6861 6e6e  .    cha = Chann
+00003fa0: 656c 280a 2020 2020 2020 2020 636f 6465  el(.        code
+00003fb0: 3d73 7461 7473 2e63 6861 6e6e 656c 2c0a  =stats.channel,.
+00003fc0: 2020 2020 2020 2020 6c6f 6361 7469 6f6e          location
+00003fd0: 5f63 6f64 653d 7374 6174 732e 6c6f 6361  _code=stats.loca
+00003fe0: 7469 6f6e 2c0a 2020 2020 2020 2020 6c61  tion,.        la
+00003ff0: 7469 7475 6465 3d6c 6f63 732e 696c 6f63  titude=locs.iloc
+00004000: 5b69 7374 615d 5b22 6c61 7469 7475 6465  [ista]["latitude
+00004010: 225d 2c0a 2020 2020 2020 2020 6c6f 6e67  "],.        long
+00004020: 6974 7564 653d 6c6f 6373 2e69 6c6f 635b  itude=locs.iloc[
+00004030: 6973 7461 5d5b 226c 6f6e 6769 7475 6465  ista]["longitude
+00004040: 225d 2c0a 2020 2020 2020 2020 656c 6576  "],.        elev
+00004050: 6174 696f 6e3d 6c6f 6373 2e69 6c6f 635b  ation=locs.iloc[
+00004060: 6973 7461 5d5b 2265 6c65 7661 7469 6f6e  ista]["elevation
+00004070: 225d 2c0a 2020 2020 2020 2020 6465 7074  "],.        dept
+00004080: 683d 2d6c 6f63 732e 696c 6f63 5b69 7374  h=-locs.iloc[ist
+00004090: 615d 5b22 656c 6576 6174 696f 6e22 5d2c  a]["elevation"],
+000040a0: 0a20 2020 2020 2020 2061 7a69 6d75 7468  .        azimuth
+000040b0: 3d30 2c0a 2020 2020 2020 2020 6469 703d  =0,.        dip=
+000040c0: 302c 0a20 2020 2020 2020 2073 616d 706c  0,.        sampl
+000040d0: 655f 7261 7465 3d73 7461 7473 2e73 616d  e_rate=stats.sam
+000040e0: 706c 696e 675f 7261 7465 2c0a 2020 2020  pling_rate,.    
+000040f0: 290a 0a20 2020 2072 6573 706f 6e73 6520  )..    response 
+00004100: 3d20 6f62 7370 792e 636f 7265 2e69 6e76  = obspy.core.inv
+00004110: 656e 746f 7279 2e72 6573 706f 6e73 652e  entory.response.
+00004120: 5265 7370 6f6e 7365 2829 0a0a 2020 2020  Response()..    
+00004130: 2320 4e6f 7720 7469 6520 6974 2061 6c6c  # Now tie it all
+00004140: 2074 6f67 6574 6865 722e 0a20 2020 2063   together..    c
+00004150: 6861 2e72 6573 706f 6e73 6520 3d20 7265  ha.response = re
+00004160: 7370 6f6e 7365 0a20 2020 2073 7461 2e63  sponse.    sta.c
+00004170: 6861 6e6e 656c 732e 6170 7065 6e64 2863  hannels.append(c
+00004180: 6861 290a 2020 2020 6e65 742e 7374 6174  ha).    net.stat
+00004190: 696f 6e73 2e61 7070 656e 6428 7374 6129  ions.append(sta)
+000041a0: 0a20 2020 2069 6e76 2e6e 6574 776f 726b  .    inv.network
+000041b0: 732e 6170 7065 6e64 286e 6574 290a 0a20  s.append(net).. 
+000041c0: 2020 2072 6574 7572 6e20 696e 760a 0a0a     return inv...
+000041d0: 6465 6620 7374 615f 696e 666f 5f66 726f  def sta_info_fro
+000041e0: 6d5f 696e 7628 696e 763a 206f 6273 7079  m_inv(inv: obspy
+000041f0: 2e63 6f72 652e 696e 7665 6e74 6f72 792e  .core.inventory.
+00004200: 696e 7665 6e74 6f72 792e 496e 7665 6e74  inventory.Invent
+00004210: 6f72 7929 3a0a 2020 2020 2222 220a 2020  ory):.    """.  
+00004220: 2020 7468 6973 2066 756e 6374 696f 6e20    this function 
+00004230: 6f75 7470 7574 7320 7374 6174 696f 6e20  outputs station 
+00004240: 696e 666f 2066 726f 6d20 7468 6520 6f62  info from the ob
+00004250: 7370 7920 696e 7665 6e74 6f72 7920 6f62  spy inventory ob
+00004260: 6a65 6374 0a20 2020 2028 7573 6564 2069  ject.    (used i
+00004270: 6e20 5330 4229 0a20 2020 2050 4152 414d  n S0B).    PARAM
+00004280: 4554 4552 533a 0a20 2020 202d 2d2d 2d2d  ETERS:.    -----
+00004290: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000042a0: 2d0a 2020 2020 696e 763a 206f 6273 7079  -.    inv: obspy
+000042b0: 2069 6e76 656e 746f 7279 206f 626a 6563   inventory objec
+000042c0: 740a 2020 2020 5245 5455 524e 533a 0a20  t.    RETURNS:. 
+000042d0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
+000042e0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7374  ---------.    st
+000042f0: 613a 2073 7461 7469 6f6e 206e 616d 650a  a: station name.
+00004300: 2020 2020 6e65 743a 206e 6574 6f77 726b      net: netowrk
+00004310: 206e 616d 650a 2020 2020 6c6f 6e3a 206c   name.    lon: l
+00004320: 6f6e 6769 7475 6465 206f 6620 7468 6520  ongitude of the 
+00004330: 7374 6174 696f 6e0a 2020 2020 6c61 743a  station.    lat:
+00004340: 206c 6174 6974 7564 6520 6f66 2074 6865   latitude of the
+00004350: 2073 7461 7469 6f6e 0a20 2020 2065 6c76   station.    elv
+00004360: 3a20 656c 6576 6174 696f 6e20 6f66 2074  : elevation of t
+00004370: 6865 2073 7461 7469 6f6e 0a20 2020 206c  he station.    l
+00004380: 6f63 6174 696f 6e3a 206c 6f63 6174 696f  ocation: locatio
+00004390: 6e20 636f 6465 206f 6620 7468 6520 7374  n code of the st
+000043a0: 6174 696f 6e0a 2020 2020 2222 220a 2020  ation.    """.  
+000043b0: 2020 2320 6c6f 6164 2066 726f 6d20 7374    # load from st
+000043c0: 6174 696f 6e20 696e 7665 6e74 6f72 790a  ation inventory.
+000043d0: 2020 2020 7374 6120 3d20 696e 765b 305d      sta = inv[0]
+000043e0: 5b30 5d2e 636f 6465 0a20 2020 206e 6574  [0].code.    net
+000043f0: 203d 2069 6e76 5b30 5d2e 636f 6465 0a20   = inv[0].code. 
+00004400: 2020 206c 6f6e 203d 2069 6e76 5b30 5d5b     lon = inv[0][
+00004410: 305d 2e6c 6f6e 6769 7475 6465 0a20 2020  0].longitude.   
+00004420: 206c 6174 203d 2069 6e76 5b30 5d5b 305d   lat = inv[0][0]
+00004430: 2e6c 6174 6974 7564 650a 2020 2020 6966  .latitude.    if
+00004440: 2069 6e76 5b30 5d5b 305d 2e65 6c65 7661   inv[0][0].eleva
+00004450: 7469 6f6e 3a0a 2020 2020 2020 2020 656c  tion:.        el
+00004460: 7620 3d20 696e 765b 305d 5b30 5d2e 656c  v = inv[0][0].el
+00004470: 6576 6174 696f 6e0a 2020 2020 656c 7365  evation.    else
+00004480: 3a0a 2020 2020 2020 2020 656c 7620 3d20  :.        elv = 
+00004490: 302e 300a 0a20 2020 2069 6620 696e 765b  0.0..    if inv[
+000044a0: 305d 5b30 5d5b 305d 2e6c 6f63 6174 696f  0][0][0].locatio
+000044b0: 6e5f 636f 6465 3a0a 2020 2020 2020 2020  n_code:.        
+000044c0: 6c6f 6361 7469 6f6e 203d 2069 6e76 5b30  location = inv[0
+000044d0: 5d5b 305d 5b30 5d2e 6c6f 6361 7469 6f6e  ][0][0].location
+000044e0: 5f63 6f64 650a 2020 2020 656c 7365 3a0a  _code.    else:.
+000044f0: 2020 2020 2020 2020 6c6f 6361 7469 6f6e          location
+00004500: 203d 2022 3030 220a 0a20 2020 2072 6574   = "00"..    ret
+00004510: 7572 6e20 7374 612c 206e 6574 2c20 6c6f  urn sta, net, lo
+00004520: 6e2c 206c 6174 2c20 656c 762c 206c 6f63  n, lat, elv, loc
+00004530: 6174 696f 6e0a 0a0a 6465 6620 6375 745f  ation...def cut_
+00004540: 7472 6163 655f 6d61 6b65 5f73 7461 7428  trace_make_stat(
+00004550: 6663 5f70 6172 613a 2043 6f6e 6669 6750  fc_para: ConfigP
+00004560: 6172 616d 6574 6572 732c 2063 685f 6461  arameters, ch_da
+00004570: 7461 3a20 4368 616e 6e65 6c44 6174 6129  ta: ChannelData)
+00004580: 3a0a 2020 2020 2222 220a 2020 2020 7468  :.    """.    th
+00004590: 6973 2066 756e 6374 696f 6e20 6375 7473  is function cuts
+000045a0: 2063 6f6e 7469 6e6f 7573 206e 6f69 7365   continous noise
+000045b0: 2064 6174 6120 696e 746f 2075 7365 722d   data into user-
+000045c0: 6465 6669 6e65 6420 7365 676d 656e 7473  defined segments
+000045d0: 2c20 6573 7469 6d61 7465 2074 6865 2073  , estimate the s
+000045e0: 7461 7469 7374 6963 7320 6f66 0a20 2020  tatistics of.   
+000045f0: 2065 6163 6820 7365 676d 656e 7420 616e   each segment an
+00004600: 6420 6b65 6570 2074 696d 6573 7461 6d70  d keep timestamp
+00004610: 206f 6620 6561 6368 2073 6567 6d65 6e74   of each segment
+00004620: 2066 6f72 206c 6174 6572 2075 7365 2e20   for later use. 
+00004630: 2875 7365 6420 696e 2053 3129 0a20 2020  (used in S1).   
+00004640: 2050 4152 414d 4554 4552 533a 0a20 2020   PARAMETERS:.   
+00004650: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
+00004660: 2d2d 2d2d 2d2d 2d0a 2020 2020 6666 745f  -------.    fft_
+00004670: 7061 7261 3a20 4120 6469 6374 696f 6e61  para: A dictiona
+00004680: 7279 2063 6f6e 7461 696e 696e 6720 616c  ry containing al
+00004690: 6c20 6666 7420 616e 6420 6363 2070 6172  l fft and cc par
+000046a0: 616d 6574 6572 732e 0a20 2020 2073 6f75  ameters..    sou
+000046b0: 7263 653a 206f 6273 7079 2073 7472 6561  rce: obspy strea
+000046c0: 6d20 6f62 6a65 6374 0a20 2020 2052 4554  m object.    RET
+000046d0: 5552 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d  URNS:.    ------
+000046e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000046f0: 0a20 2020 2074 7261 6365 5f73 7464 533a  .    trace_stdS:
+00004700: 2073 7461 6e64 6172 6420 6465 7669 6174   standard deviat
+00004710: 696f 6e20 6f66 2074 6865 206e 6f69 7365  ion of the noise
+00004720: 2061 6d70 6c69 7475 6465 206f 6620 6561   amplitude of ea
+00004730: 6368 2073 6567 6d65 6e74 0a20 2020 2064  ch segment.    d
+00004740: 6174 6153 5f74 3a20 2020 2074 696d 6573  ataS_t:    times
+00004750: 7461 6d70 7320 6f66 2065 6163 6820 7365  tamps of each se
+00004760: 676d 656e 740a 2020 2020 6461 7461 533a  gment.    dataS:
+00004770: 2020 2020 2020 3244 206d 6174 7269 7820        2D matrix 
+00004780: 6f66 2074 6865 2073 6567 6d65 6e74 6564  of the segmented
+00004790: 2064 6174 610a 2020 2020 2222 220a 2020   data.    """.  
+000047a0: 2020 2320 6465 6669 6e65 2072 6574 7572    # define retur
+000047b0: 6e20 7661 7269 6162 6c65 7320 6669 7273  n variables firs
+000047c0: 740a 2020 2020 736f 7572 6365 5f70 6172  t.    source_par
+000047d0: 616d 7320 3d20 5b5d 0a20 2020 2064 6174  ams = [].    dat
+000047e0: 6153 5f74 203d 205b 5d0a 2020 2020 6461  aS_t = [].    da
+000047f0: 7461 5320 3d20 5b5d 0a0a 2020 2020 2320  taS = []..    # 
+00004800: 7573 6566 756c 2070 6172 616d 6574 6572  useful parameter
+00004810: 7320 666f 7220 7472 6163 6520 736c 6964  s for trace slid
+00004820: 696e 670a 2020 2020 6e73 6567 203d 2069  ing.    nseg = i
+00004830: 6e74 286e 702e 666c 6f6f 7228 2866 635f  nt(np.floor((fc_
+00004840: 7061 7261 2e69 6e63 5f68 6f75 7273 202f  para.inc_hours /
+00004850: 2032 3420 2a20 3836 3430 3020 2d20 6663   24 * 86400 - fc
+00004860: 5f70 6172 612e 6363 5f6c 656e 2920 2f20  _para.cc_len) / 
+00004870: 6663 5f70 6172 612e 7374 6570 2929 0a20  fc_para.step)). 
+00004880: 2020 2073 7073 203d 2069 6e74 2863 685f     sps = int(ch_
+00004890: 6461 7461 2e73 616d 706c 696e 675f 7261  data.sampling_ra
+000048a0: 7465 290a 2020 2020 7374 6172 7474 696d  te).    starttim
+000048b0: 6520 3d20 6368 5f64 6174 612e 7374 6172  e = ch_data.star
+000048c0: 745f 7469 6d65 7374 616d 700a 2020 2020  t_timestamp.    
+000048d0: 2320 636f 7079 2064 6174 6120 696e 746f  # copy data into
+000048e0: 2061 7272 6179 0a20 2020 2064 6174 6120   array.    data 
+000048f0: 3d20 6368 5f64 6174 612e 6461 7461 0a0a  = ch_data.data..
+00004900: 2020 2020 2320 6966 2074 6865 2064 6174      # if the dat
+00004910: 6120 6973 2073 686f 7274 6572 2074 6861  a is shorter tha
+00004920: 6e20 7468 6520 7469 6d20 6368 756e 636b  n the tim chunck
+00004930: 2c20 7265 7475 726e 207a 6572 6f20 7661  , return zero va
+00004940: 6c75 6573 0a20 2020 2069 6620 6461 7461  lues.    if data
+00004950: 2e73 697a 6520 3c20 7370 7320 2a20 6663  .size < sps * fc
+00004960: 5f70 6172 612e 696e 635f 686f 7572 7320  _para.inc_hours 
+00004970: 2a20 3336 3030 3a0a 2020 2020 2020 2020  * 3600:.        
+00004980: 7265 7475 726e 2073 6f75 7263 655f 7061  return source_pa
+00004990: 7261 6d73 2c20 6461 7461 535f 742c 2064  rams, dataS_t, d
+000049a0: 6174 6153 0a0a 2020 2020 2320 7374 6174  ataS..    # stat
+000049b0: 6973 7469 6320 746f 2064 6574 6563 7420  istic to detect 
+000049c0: 7365 676d 656e 7473 2074 6861 7420 6d61  segments that ma
+000049d0: 7920 6265 2061 7373 6f63 6961 7465 6420  y be associated 
+000049e0: 7769 7468 2065 6172 7468 7175 616b 6573  with earthquakes
+000049f0: 0a20 2020 2061 6c6c 5f6d 6164 5320 3d20  .    all_madS = 
+00004a00: 6d61 6428 6461 7461 2920 2023 206d 6564  mad(data)  # med
+00004a10: 6961 6e20 6162 736f 6c75 7465 2064 6576  ian absolute dev
+00004a20: 6961 7469 6f6e 206f 7665 7220 616c 6c20  iation over all 
+00004a30: 6e6f 6973 6520 7769 6e64 6f77 0a20 2020  noise window.   
+00004a40: 2061 6c6c 5f73 7464 5320 3d20 6e70 2e73   all_stdS = np.s
+00004a50: 7464 2864 6174 6129 2020 2320 7374 616e  td(data)  # stan
+00004a60: 6461 7264 2064 6576 6961 7469 6f6e 206f  dard deviation o
+00004a70: 7665 7220 616c 6c20 6e6f 6973 6520 7769  ver all noise wi
+00004a80: 6e64 6f77 0a20 2020 2069 6620 616c 6c5f  ndow.    if all_
+00004a90: 6d61 6453 203d 3d20 3020 6f72 2061 6c6c  madS == 0 or all
+00004aa0: 5f73 7464 5320 3d3d 2030 206f 7220 6e70  _stdS == 0 or np
+00004ab0: 2e69 736e 616e 2861 6c6c 5f6d 6164 5329  .isnan(all_madS)
+00004ac0: 206f 7220 6e70 2e69 736e 616e 2861 6c6c   or np.isnan(all
+00004ad0: 5f73 7464 5329 3a0a 2020 2020 2020 2020  _stdS):.        
+00004ae0: 7072 696e 7428 2263 6f6e 7469 6e75 6521  print("continue!
+00004af0: 206d 6164 5320 6f72 2073 7464 5320 6571   madS or stdS eq
+00004b00: 7561 6c73 2074 6f20 3020 666f 7220 2573  uals to 0 for %s
+00004b10: 2229 0a20 2020 2020 2020 2072 6574 7572  ").        retur
+00004b20: 6e20 736f 7572 6365 5f70 6172 616d 732c  n source_params,
+00004b30: 2064 6174 6153 5f74 2c20 6461 7461 530a   dataS_t, dataS.
+00004b40: 0a20 2020 2023 2069 6e69 7469 616c 697a  .    # initializ
+00004b50: 6520 7661 7269 6162 6c65 730a 2020 2020  e variables.    
+00004b60: 6e70 7473 203d 2069 6e74 2866 635f 7061  npts = int(fc_pa
+00004b70: 7261 2e63 635f 6c65 6e20 2a20 7370 7329  ra.cc_len * sps)
+00004b80: 0a20 2020 2023 2074 7261 6365 5f6d 6164  .    # trace_mad
+00004b90: 5320 3d20 6e70 2e7a 6572 6f73 286e 7365  S = np.zeros(nse
+00004ba0: 672c 6474 7970 653d 6e70 2e66 6c6f 6174  g,dtype=np.float
+00004bb0: 3332 290a 2020 2020 7472 6163 655f 7374  32).    trace_st
+00004bc0: 6453 203d 206e 702e 7a65 726f 7328 6e73  dS = np.zeros(ns
+00004bd0: 6567 2c20 6474 7970 653d 6e70 2e66 6c6f  eg, dtype=np.flo
+00004be0: 6174 3332 290a 2020 2020 6461 7461 5320  at32).    dataS 
+00004bf0: 3d20 6e70 2e7a 6572 6f73 2873 6861 7065  = np.zeros(shape
+00004c00: 3d28 696e 7428 6e73 6567 292c 2069 6e74  =(int(nseg), int
+00004c10: 286e 7074 7329 292c 2064 7479 7065 3d6e  (npts)), dtype=n
+00004c20: 702e 666c 6f61 7433 3229 0a20 2020 2064  p.float32).    d
+00004c30: 6174 6153 5f74 203d 206e 702e 7a65 726f  ataS_t = np.zero
+00004c40: 7328 6e73 6567 2c20 6474 7970 653d 6e70  s(nseg, dtype=np
+00004c50: 2e66 6c6f 6174 3332 290a 0a20 2020 2069  .float32)..    i
+00004c60: 6e64 7831 203d 2030 0a20 2020 2066 6f72  ndx1 = 0.    for
+00004c70: 2069 7365 6720 696e 2072 616e 6765 286e   iseg in range(n
+00004c80: 7365 6729 3a0a 2020 2020 2020 2020 696e  seg):.        in
+00004c90: 6478 3220 3d20 696e 6478 3120 2b20 6e70  dx2 = indx1 + np
+00004ca0: 7473 0a20 2020 2020 2020 2064 6174 6153  ts.        dataS
+00004cb0: 5b69 7365 675d 203d 2064 6174 615b 696e  [iseg] = data[in
+00004cc0: 6478 313a 696e 6478 325d 0a20 2020 2020  dx1:indx2].     
+00004cd0: 2020 2023 2074 7261 6365 5f6d 6164 535b     # trace_madS[
+00004ce0: 6973 6567 5d20 3d20 286e 702e 6d61 7828  iseg] = (np.max(
+00004cf0: 6e70 2e61 6273 2864 6174 6153 5b69 7365  np.abs(dataS[ise
+00004d00: 675d 2929 2f61 6c6c 5f6d 6164 5329 0a20  g]))/all_madS). 
+00004d10: 2020 2020 2020 2074 7261 6365 5f73 7464         trace_std
+00004d20: 535b 6973 6567 5d20 3d20 6e70 2e6d 6178  S[iseg] = np.max
+00004d30: 286e 702e 6162 7328 6461 7461 535b 6973  (np.abs(dataS[is
+00004d40: 6567 5d29 2920 2f20 616c 6c5f 7374 6453  eg])) / all_stdS
+00004d50: 0a20 2020 2020 2020 2064 6174 6153 5f74  .        dataS_t
+00004d60: 5b69 7365 675d 203d 2073 7461 7274 7469  [iseg] = startti
+00004d70: 6d65 202b 2066 635f 7061 7261 2e73 7465  me + fc_para.ste
+00004d80: 7020 2a20 6973 6567 0a20 2020 2020 2020  p * iseg.       
+00004d90: 2069 6e64 7831 203d 2069 6e64 7831 202b   indx1 = indx1 +
+00004da0: 2069 6e74 2866 635f 7061 7261 2e73 7465   int(fc_para.ste
+00004db0: 7029 202a 2073 7073 0a0a 2020 2020 2320  p) * sps..    # 
+00004dc0: 3244 2061 7272 6179 2070 726f 6365 7373  2D array process
+00004dd0: 696e 670a 2020 2020 6461 7461 5320 3d20  ing.    dataS = 
+00004de0: 6465 6d65 616e 2864 6174 6153 290a 2020  demean(dataS).  
+00004df0: 2020 6461 7461 5320 3d20 6465 7472 656e    dataS = detren
+00004e00: 6428 6461 7461 5329 0a20 2020 2064 6174  d(dataS).    dat
+00004e10: 6153 203d 2074 6170 6572 2864 6174 6153  aS = taper(dataS
+00004e20: 290a 0a20 2020 2072 6574 7572 6e20 7472  )..    return tr
+00004e30: 6163 655f 7374 6453 2c20 6461 7461 535f  ace_stdS, dataS_
+00004e40: 742c 2064 6174 6153 0a0a 0a64 6566 206e  t, dataS...def n
+00004e50: 6f69 7365 5f70 726f 6365 7373 696e 6728  oise_processing(
+00004e60: 6666 745f 7061 7261 2c20 6461 7461 5329  fft_para, dataS)
+00004e70: 3a0a 2020 2020 2222 220a 2020 2020 7468  :.    """.    th
+00004e80: 6973 2066 756e 6374 696f 6e20 7065 7266  is function perf
+00004e90: 6f72 6d73 2074 696d 6520 646f 6d61 696e  orms time domain
+00004ea0: 2061 6e64 2066 7265 7175 656e 6379 2064   and frequency d
+00004eb0: 6f6d 6169 6e20 6e6f 726d 616c 697a 6174  omain normalizat
+00004ec0: 696f 6e20 6966 206e 6565 6465 642e 2069  ion if needed. i
+00004ed0: 6e20 7265 616c 2063 6173 652c 2077 6520  n real case, we 
+00004ee0: 7072 6566 6572 2075 7365 2069 6e63 6c75  prefer use inclu
+00004ef0: 6465 0a20 2020 2074 6865 206e 6f72 6d61  de.    the norma
+00004f00: 6c69 7a61 7469 6f6e 2069 6e20 7468 6520  lization in the 
+00004f10: 6372 6f73 732d 636f 7272 6561 6c74 696f  cross-correaltio
+00004f20: 6e20 7374 6570 7320 6279 2073 656c 6563  n steps by selec
+00004f30: 7469 6e67 2063 6f68 6572 656e 6379 206f  ting coherency o
+00004f40: 7220 6465 636f 6e0a 2020 2020 2850 7269  r decon.    (Pri
+00004f50: 6574 6f20 6574 2061 6c2c 2032 3030 382c  eto et al, 2008,
+00004f60: 2032 3030 393b 2044 656e 6f6c 6c65 2065   2009; Denolle e
+00004f70: 7420 616c 2c20 3230 3133 290a 2020 2020  t al, 2013).    
+00004f80: 5041 524d 4145 5445 5253 3a0a 2020 2020  PARMAETERS:.    
+00004f90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00004fa0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2066 6674  --------.    fft
+00004fb0: 5f70 6172 613a 2064 6963 7469 6f6e 6172  _para: dictionar
+00004fc0: 7920 636f 6e74 6169 6e69 6e67 2061 6c6c  y containing all
+00004fd0: 2075 7365 6675 6c20 7661 7269 6162 6c65   useful variable
+00004fe0: 7320 7573 6564 2066 6f72 2066 6674 2061  s used for fft a
+00004ff0: 6e64 2063 630a 2020 2020 6461 7461 533a  nd cc.    dataS:
+00005000: 2032 4420 6d61 7472 6978 206f 6620 616c   2D matrix of al
+00005010: 6c20 7365 676d 656e 7465 6420 6e6f 6973  l segmented nois
+00005020: 6520 6461 7461 0a20 2020 2023 204f 5554  e data.    # OUT
+00005030: 5055 5420 5641 5249 4142 4c45 533a 0a20  PUT VARIABLES:. 
+00005040: 2020 2073 6f75 7263 655f 7768 6974 653a     source_white:
+00005050: 2032 4420 6d61 7472 6978 206f 6620 6461   2D matrix of da
+00005060: 7461 2073 7065 6374 7261 0a20 2020 2022  ta spectra.    "
+00005070: 2222 0a20 2020 2023 206c 6f61 6420 7061  "".    # load pa
+00005080: 7261 6d65 7465 7273 2066 6972 7374 0a20  rameters first. 
+00005090: 2020 2074 696d 655f 6e6f 726d 203d 2066     time_norm = f
+000050a0: 6674 5f70 6172 615b 2274 696d 655f 6e6f  ft_para["time_no
+000050b0: 726d 225d 0a20 2020 2066 7265 715f 6e6f  rm"].    freq_no
+000050c0: 726d 203d 2066 6674 5f70 6172 615b 2266  rm = fft_para["f
+000050d0: 7265 715f 6e6f 726d 225d 0a20 2020 2073  req_norm"].    s
+000050e0: 6d6f 6f74 685f 4e20 3d20 6666 745f 7061  mooth_N = fft_pa
+000050f0: 7261 5b22 736d 6f6f 7468 5f4e 225d 0a20  ra["smooth_N"]. 
+00005100: 2020 204e 203d 2064 6174 6153 2e73 6861     N = dataS.sha
+00005110: 7065 5b30 5d0a 0a20 2020 2023 202d 2d2d  pe[0]..    # ---
+00005120: 2d2d 2d74 6f20 6e6f 726d 616c 697a 6520  ---to normalize 
+00005130: 696e 2074 696d 6520 6f72 206e 6f74 2d2d  in time or not--
+00005140: 2d2d 2d2d 0a20 2020 2069 6620 7469 6d65  ----.    if time
+00005150: 5f6e 6f72 6d20 213d 2022 6e6f 223a 0a20  _norm != "no":. 
+00005160: 2020 2020 2020 2069 6620 7469 6d65 5f6e         if time_n
+00005170: 6f72 6d20 3d3d 2022 6f6e 655f 6269 7422  orm == "one_bit"
+00005180: 3a20 2023 2073 6967 6e20 6e6f 726d 616c  :  # sign normal
+00005190: 697a 6174 696f 6e0a 2020 2020 2020 2020  ization.        
+000051a0: 2020 2020 7768 6974 6520 3d20 6e70 2e73      white = np.s
+000051b0: 6967 6e28 6461 7461 5329 0a20 2020 2020  ign(dataS).     
+000051c0: 2020 2065 6c69 6620 7469 6d65 5f6e 6f72     elif time_nor
+000051d0: 6d20 3d3d 2022 726d 6122 3a20 2023 2072  m == "rma":  # r
+000051e0: 756e 6e69 6e67 206d 6561 6e3a 206e 6f72  unning mean: nor
+000051f0: 6d61 6c69 7a61 7469 6f6e 206f 7665 7220  malization over 
+00005200: 736d 6f6f 7468 6564 2061 6273 6f6c 7574  smoothed absolut
+00005210: 6520 6176 6572 6167 650a 2020 2020 2020  e average.      
+00005220: 2020 2020 2020 7768 6974 6520 3d20 6e70        white = np
+00005230: 2e7a 6572 6f73 2873 6861 7065 3d64 6174  .zeros(shape=dat
+00005240: 6153 2e73 6861 7065 2c20 6474 7970 653d  aS.shape, dtype=
+00005250: 6461 7461 532e 6474 7970 6529 0a20 2020  dataS.dtype).   
+00005260: 2020 2020 2020 2020 2066 6f72 206b 6b6b           for kkk
+00005270: 2069 6e20 7261 6e67 6528 4e29 3a0a 2020   in range(N):.  
+00005280: 2020 2020 2020 2020 2020 2020 2020 7768                wh
+00005290: 6974 655b 6b6b 6b2c 203a 5d20 3d20 6461  ite[kkk, :] = da
+000052a0: 7461 535b 6b6b 6b2c 203a 5d20 2f20 6d6f  taS[kkk, :] / mo
+000052b0: 7669 6e67 5f61 7665 286e 702e 6162 7328  ving_ave(np.abs(
+000052c0: 6461 7461 535b 6b6b 6b2c 203a 5d29 2c20  dataS[kkk, :]), 
+000052d0: 736d 6f6f 7468 5f4e 290a 0a20 2020 2065  smooth_N)..    e
+000052e0: 6c73 653a 2020 2320 646f 6e27 7420 6e6f  lse:  # don't no
+000052f0: 726d 616c 697a 650a 2020 2020 2020 2020  rmalize.        
+00005300: 7768 6974 6520 3d20 6461 7461 530a 0a20  white = dataS.. 
+00005310: 2020 2023 202d 2d2d 2d2d 746f 2077 6869     # -----to whi
+00005320: 7465 6e20 6f72 206e 6f74 2d2d 2d2d 2d2d  ten or not------
+00005330: 0a20 2020 2069 6620 6672 6571 5f6e 6f72  .    if freq_nor
+00005340: 6d20 213d 2022 6e6f 223a 0a20 2020 2020  m != "no":.     
+00005350: 2020 2073 6f75 7263 655f 7768 6974 6520     source_white 
+00005360: 3d20 7768 6974 656e 2877 6869 7465 2c20  = whiten(white, 
+00005370: 6666 745f 7061 7261 2920 2023 2077 6869  fft_para)  # whi
+00005380: 7465 6e20 616e 6420 7265 7475 726e 2046  ten and return F
+00005390: 4654 0a20 2020 2065 6c73 653a 0a20 2020  FT.    else:.   
+000053a0: 2020 2020 204e 6666 7420 3d20 696e 7428       Nfft = int(
+000053b0: 6e65 7874 5f66 6173 745f 6c65 6e28 696e  next_fast_len(in
+000053c0: 7428 6461 7461 532e 7368 6170 655b 315d  t(dataS.shape[1]
+000053d0: 2929 290a 2020 2020 2020 2020 736f 7572  ))).        sour
+000053e0: 6365 5f77 6869 7465 203d 2073 6369 7079  ce_white = scipy
+000053f0: 2e66 6674 7061 636b 2e66 6674 2877 6869  .fftpack.fft(whi
+00005400: 7465 2c20 4e66 6674 2c20 6178 6973 3d31  te, Nfft, axis=1
+00005410: 2920 2023 2072 6574 7572 6e20 4646 540a  )  # return FFT.
+00005420: 0a20 2020 2072 6574 7572 6e20 736f 7572  .    return sour
+00005430: 6365 5f77 6869 7465 0a0a 0a64 6566 2073  ce_white...def s
+00005440: 6d6f 6f74 685f 736f 7572 6365 5f73 7065  mooth_source_spe
+00005450: 6374 2863 635f 7061 7261 2c20 6666 7431  ct(cc_para, fft1
+00005460: 293a 0a20 2020 2022 2222 0a20 2020 2074  ):.    """.    t
+00005470: 6869 7320 6675 6e63 7469 6f6e 2073 6d6f  his function smo
+00005480: 6f74 6865 7320 616d 706c 6974 7564 6520  othes amplitude 
+00005490: 7370 6563 7472 756d 206f 6620 7468 6520  spectrum of the 
+000054a0: 3244 2073 7065 6374 7261 6c20 6d61 7472  2D spectral matr
+000054b0: 6978 2e20 2875 7365 6420 696e 2053 3129  ix. (used in S1)
+000054c0: 0a20 2020 2050 4152 414d 4554 4552 533a  .    PARAMETERS:
+000054d0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
+000054e0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063  ----------.    c
+000054f0: 635f 7061 7261 3a20 6469 6374 696f 6e61  c_para: dictiona
+00005500: 7279 2063 6f6e 7461 696e 696e 6720 7573  ry containing us
+00005510: 6566 756c 2063 6320 7061 7261 6d65 7465  eful cc paramete
+00005520: 7273 0a20 2020 2066 6674 313a 2020 2020  rs.    fft1:    
+00005530: 736f 7572 6365 2073 7065 6374 7275 6d20  source spectrum 
+00005540: 6d61 7472 6978 0a0a 2020 2020 5245 5455  matrix..    RETU
+00005550: 524e 533a 0a20 2020 202d 2d2d 2d2d 2d2d  RNS:.    -------
+00005560: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
+00005570: 2020 2073 6666 7431 3a20 636f 6d70 6c65     sfft1: comple
+00005580: 7820 6e75 6d70 7920 6172 7261 7920 7769  x numpy array wi
+00005590: 7468 206e 6f72 6d61 6c69 7a65 6420 7370  th normalized sp
+000055a0: 6563 7472 756d 0a20 2020 2022 2222 0a20  ectrum.    """. 
+000055b0: 2020 2063 635f 6d65 7468 6f64 203d 2063     cc_method = c
+000055c0: 635f 7061 7261 5b22 6363 5f6d 6574 686f  c_para["cc_metho
+000055d0: 6422 5d0a 2020 2020 736d 6f6f 7468 7370  d"].    smoothsp
+000055e0: 6563 745f 4e20 3d20 6363 5f70 6172 615b  ect_N = cc_para[
+000055f0: 2273 6d6f 6f74 6873 7065 6374 5f4e 225d  "smoothspect_N"]
+00005600: 0a0a 2020 2020 6966 2063 635f 6d65 7468  ..    if cc_meth
+00005610: 6f64 203d 3d20 2264 6563 6f6e 7622 3a0a  od == "deconv":.
+00005620: 2020 2020 2020 2020 2320 2d2d 2d2d 2d6e          # -----n
+00005630: 6f72 6d61 6c69 7a65 2073 696e 676c 652d  ormalize single-
+00005640: 7374 6174 696f 6e20 6363 2074 6f20 7a20  station cc to z 
+00005650: 636f 6d70 6f6e 656e 742d 2d2d 2d2d 0a20  component-----. 
+00005660: 2020 2020 2020 2074 656d 7020 3d20 6d6f         temp = mo
+00005670: 7669 6e67 5f61 7665 286e 702e 6162 7328  ving_ave(np.abs(
+00005680: 6666 7431 292c 2073 6d6f 6f74 6873 7065  fft1), smoothspe
+00005690: 6374 5f4e 290a 2020 2020 2020 2020 7472  ct_N).        tr
+000056a0: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
+000056b0: 6666 7431 203d 206e 702e 636f 6e6a 2866  fft1 = np.conj(f
+000056c0: 6674 3129 202f 2074 656d 702a 2a32 0a20  ft1) / temp**2. 
+000056d0: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+000056e0: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
+000056f0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00005700: 4572 726f 7228 2273 6d6f 6f74 6865 6420  Error("smoothed 
+00005710: 7370 6563 7472 756d 2068 6173 207a 6572  spectrum has zer
+00005720: 6f20 7661 6c75 6573 2229 0a0a 2020 2020  o values")..    
+00005730: 656c 6966 2063 635f 6d65 7468 6f64 203d  elif cc_method =
+00005740: 3d20 2263 6f68 6572 656e 6379 223a 0a20  = "coherency":. 
+00005750: 2020 2020 2020 2074 656d 7020 3d20 6d6f         temp = mo
+00005760: 7669 6e67 5f61 7665 286e 702e 6162 7328  ving_ave(np.abs(
+00005770: 6666 7431 292c 2073 6d6f 6f74 6873 7065  fft1), smoothspe
+00005780: 6374 5f4e 290a 2020 2020 2020 2020 7472  ct_N).        tr
+00005790: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
+000057a0: 6666 7431 203d 206e 702e 636f 6e6a 2866  fft1 = np.conj(f
+000057b0: 6674 3129 202f 2074 656d 700a 2020 2020  ft1) / temp.    
+000057c0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+000057d0: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+000057e0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+000057f0: 6f72 2822 736d 6f6f 7468 6564 2073 7065  or("smoothed spe
+00005800: 6374 7275 6d20 6861 7320 7a65 726f 2076  ctrum has zero v
+00005810: 616c 7565 7322 290a 0a20 2020 2065 6c69  alues")..    eli
+00005820: 6620 6363 5f6d 6574 686f 6420 3d3d 2022  f cc_method == "
+00005830: 7863 6f72 7222 3a0a 2020 2020 2020 2020  xcorr":.        
+00005840: 7366 6674 3120 3d20 6e70 2e63 6f6e 6a28  sfft1 = np.conj(
+00005850: 6666 7431 290a 0a20 2020 2065 6c73 653a  fft1)..    else:
+00005860: 0a20 2020 2020 2020 2072 6169 7365 2056  .        raise V
+00005870: 616c 7565 4572 726f 7228 226e 6f20 636f  alueError("no co
+00005880: 7272 6563 7469 6f6e 2063 6f72 7265 6c61  rrection correla
+00005890: 7469 6f6e 206d 6574 686f 6420 6973 2073  tion method is s
+000058a0: 656c 6563 7465 6420 6174 204c 3539 2229  elected at L59")
+000058b0: 0a0a 2020 2020 7265 7475 726e 2073 6666  ..    return sff
+000058c0: 7431 0a0a 0a64 6566 2063 6f72 7265 6c61  t1...def correla
+000058d0: 7465 2866 6674 315f 736d 6f6f 7468 6564  te(fft1_smoothed
+000058e0: 5f61 6273 2c20 6666 7432 2c20 442c 204e  _abs, fft2, D, N
+000058f0: 6666 742c 2064 6174 6153 5f74 293a 0a20  fft, dataS_t):. 
+00005900: 2020 2022 2222 0a20 2020 2074 6869 7320     """.    this 
+00005910: 6675 6e63 7469 6f6e 2064 6f65 7320 7468  function does th
+00005920: 6520 6372 6f73 732d 636f 7272 656c 6174  e cross-correlat
+00005930: 696f 6e20 696e 2066 7265 7120 646f 6d61  ion in freq doma
+00005940: 696e 2061 6e64 2068 6173 2074 6865 206f  in and has the o
+00005950: 7074 696f 6e20 746f 206b 6565 7020 7375  ption to keep su
+00005960: 622d 7374 6163 6b73 206f 660a 2020 2020  b-stacks of.    
+00005970: 7468 6520 6372 6f73 732d 636f 7272 656c  the cross-correl
+00005980: 6174 696f 6e20 6966 206e 6565 6465 642e  ation if needed.
+00005990: 2069 7420 7461 6b65 7320 6164 7661 6e74   it takes advant
+000059a0: 6167 6520 6f66 2074 6865 206c 696e 6561  age of the linea
+000059b0: 7220 7265 6c61 7469 6f6e 7368 6970 206f  r relationship o
+000059c0: 6620 6966 6674 2c20 736f 2074 6861 740a  f ifft, so that.
+000059d0: 2020 2020 7374 6163 6b69 6e67 2069 7320      stacking is 
+000059e0: 7065 7266 6f72 6d65 6420 696e 2073 7065  performed in spe
+000059f0: 6374 7275 6d20 646f 6d61 696e 2066 6972  ctrum domain fir
+00005a00: 7374 2074 6f20 7265 6475 6365 2074 6865  st to reduce the
+00005a10: 2074 6f74 616c 206e 756d 6265 7220 6f66   total number of
+00005a20: 2069 6666 742e 2028 7573 6564 2069 6e20   ifft. (used in 
+00005a30: 5331 290a 2020 2020 5041 5241 4d45 5445  S1).    PARAMETE
+00005a40: 5253 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  RS:.    --------
+00005a50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
+00005a60: 2020 6666 7431 5f73 6d6f 6f74 6865 645f    fft1_smoothed_
+00005a70: 6162 733a 2073 6d6f 6f74 6865 6420 706f  abs: smoothed po
+00005a80: 7765 7220 7370 6563 7472 616c 2064 656e  wer spectral den
+00005a90: 7369 7479 206f 6620 7468 6520 4646 5420  sity of the FFT 
+00005aa0: 666f 7220 7468 6520 736f 7572 6365 2073  for the source s
+00005ab0: 7461 7469 6f6e 0a20 2020 2066 6674 323a  tation.    fft2:
+00005ac0: 2072 6177 2046 4654 2073 7065 6374 7275   raw FFT spectru
+00005ad0: 6d20 6f66 2074 6865 2072 6563 6569 7665  m of the receive
+00005ae0: 7220 7374 6174 696f 6e0a 2020 2020 443a  r station.    D:
+00005af0: 2064 6963 7469 6f6e 6172 7920 636f 6e74   dictionary cont
+00005b00: 6169 6e69 6e67 2066 6f6c 6c6f 7769 6e67  aining following
+00005b10: 2070 6172 616d 6574 6572 733a 0a20 2020   parameters:.   
+00005b20: 2020 2020 206d 6178 6c61 673a 2020 6d61       maxlag:  ma
+00005b30: 7869 6d75 6d20 6c61 6773 2074 6f20 6b65  ximum lags to ke
+00005b40: 6570 2069 6e20 7468 6520 6372 6f73 7320  ep in the cross 
+00005b50: 636f 7272 656c 6174 696f 6e0a 2020 2020  correlation.    
+00005b60: 2020 2020 6474 3a20 2020 2020 2073 616d      dt:      sam
+00005b70: 706c 696e 6720 7261 7465 2028 696e 2073  pling rate (in s
+00005b80: 290a 2020 2020 2020 2020 6e77 696e 3a20  ).        nwin: 
+00005b90: 2020 206e 756d 6265 7220 6f66 2073 6567     number of seg
+00005ba0: 6d65 6e74 7320 696e 2074 6865 2032 4420  ments in the 2D 
+00005bb0: 6d61 7472 6978 0a20 2020 2020 2020 206d  matrix.        m
+00005bc0: 6574 686f 643a 2020 6372 6f73 732d 636f  ethod:  cross-co
+00005bd0: 7272 656c 6174 696f 6e20 6d65 7468 6f64  rrelation method
+00005be0: 7320 7365 6c65 6374 6564 2062 7920 7468  s selected by th
+00005bf0: 6520 7573 6572 0a20 2020 2020 2020 2066  e user.        f
+00005c00: 7265 716d 696e 3a20 6d69 6e69 6d75 6d20  reqmin: minimum 
+00005c10: 6672 6571 7565 6e63 7920 2848 7a29 0a20  frequency (Hz). 
+00005c20: 2020 2020 2020 2066 7265 716d 6178 3a20         freqmax: 
+00005c30: 6d61 7869 6d75 6d20 6672 6571 7565 6e63  maximum frequenc
+00005c40: 7920 2848 7a29 0a20 2020 204e 6666 743a  y (Hz).    Nfft:
+00005c50: 2020 2020 6e75 6d62 6572 206f 6620 6672      number of fr
+00005c60: 6571 7565 6e63 7920 706f 696e 7473 2066  equency points f
+00005c70: 6f72 2069 6666 740a 2020 2020 6461 7461  or ifft.    data
+00005c80: 535f 743a 206d 6174 7269 7820 6f66 2064  S_t: matrix of d
+00005c90: 6174 6574 696d 6520 6f62 6a65 6374 2e0a  atetime object..
+00005ca0: 0a20 2020 2052 4554 5552 4e53 3a0a 2020  .    RETURNS:.  
+00005cb0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
+00005cc0: 2d2d 2d2d 2d2d 2d0a 2020 2020 735f 636f  -------.    s_co
+00005cd0: 7272 3a20 3144 206f 7220 3244 206d 6174  rr: 1D or 2D mat
+00005ce0: 7269 7820 6f66 2074 6865 2061 7665 7261  rix of the avera
+00005cf0: 6765 6420 6f72 2073 7562 2d73 7461 636b  ged or sub-stack
+00005d00: 7320 6f66 2063 726f 7373 2d63 6f72 7265  s of cross-corre
+00005d10: 6c61 7469 6f6e 2066 756e 6374 696f 6e73  lation functions
+00005d20: 2069 6e20 7469 6d65 2064 6f6d 6169 6e0a   in time domain.
+00005d30: 2020 2020 745f 636f 7272 3a20 7469 6d65      t_corr: time
+00005d40: 7374 616d 7020 666f 7220 6561 6368 2073  stamp for each s
+00005d50: 7562 2d73 7461 636b 206f 7220 6176 6572  ub-stack or aver
+00005d60: 6167 6564 2066 756e 6374 696f 6e0a 2020  aged function.  
+00005d70: 2020 6e5f 636f 7272 3a20 6e75 6d62 6572    n_corr: number
+00005d80: 206f 6620 696e 636c 7564 6564 2073 6567   of included seg
+00005d90: 6d65 6e74 7320 666f 7220 6561 6368 2073  ments for each s
+00005da0: 7562 2d73 7461 636b 206f 7220 6176 6572  ub-stack or aver
+00005db0: 6167 6564 2066 756e 6374 696f 6e0a 0a20  aged function.. 
+00005dc0: 2020 204d 4f44 4946 4943 4154 494f 4e53     MODIFICATIONS
+00005dd0: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
+00005de0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
+00005df0: 6f75 7470 7574 2074 6865 206c 696e 6561  output the linea
+00005e00: 7220 7374 6163 6b20 6f66 2065 6163 6820  r stack of each 
+00005e10: 7469 6d65 2063 6875 6e6b 2065 7665 6e20  time chunk even 
+00005e20: 7768 656e 2073 7562 7374 6163 6b20 6973  when substack is
+00005e30: 2073 656c 6563 7465 6420 2862 7920 4368   selected (by Ch
+00005e40: 656e 6778 696e 2040 4175 6732 3032 3029  engxin @Aug2020)
+00005e50: 0a20 2020 2022 2222 0a20 2020 2023 202d  .    """.    # -
+00005e60: 2d2d 2d6c 6f61 6420 7061 7261 6d74 6572  ---load paramter
+00005e70: 732d 2d2d 2d0a 2020 2020 6474 203d 2044  s----.    dt = D
+00005e80: 5b22 6474 225d 0a20 2020 206d 6178 6c61  ["dt"].    maxla
+00005e90: 6720 3d20 445b 226d 6178 6c61 6722 5d0a  g = D["maxlag"].
+00005ea0: 2020 2020 6d65 7468 6f64 203d 2044 5b22      method = D["
+00005eb0: 6363 5f6d 6574 686f 6422 5d0a 2020 2020  cc_method"].    
+00005ec0: 6363 5f6c 656e 203d 2044 5b22 6363 5f6c  cc_len = D["cc_l
+00005ed0: 656e 225d 0a20 2020 2073 7562 7374 6163  en"].    substac
+00005ee0: 6b20 3d20 445b 2273 7562 7374 6163 6b22  k = D["substack"
+00005ef0: 5d0a 2020 2020 7375 6273 7461 636b 5f6c  ].    substack_l
+00005f00: 656e 203d 2044 5b22 7375 6273 7461 636b  en = D["substack
+00005f10: 5f6c 656e 225d 0a20 2020 2073 6d6f 6f74  _len"].    smoot
+00005f20: 6873 7065 6374 5f4e 203d 2044 5b22 736d  hspect_N = D["sm
+00005f30: 6f6f 7468 7370 6563 745f 4e22 5d0a 0a20  oothspect_N"].. 
+00005f40: 2020 206e 7769 6e20 3d20 6666 7431 5f73     nwin = fft1_s
+00005f50: 6d6f 6f74 6865 645f 6162 732e 7368 6170  moothed_abs.shap
+00005f60: 655b 305d 0a20 2020 204e 6666 7432 203d  e[0].    Nfft2 =
+00005f70: 2066 6674 315f 736d 6f6f 7468 6564 5f61   fft1_smoothed_a
+00005f80: 6273 2e73 6861 7065 5b31 5d0a 0a20 2020  bs.shape[1]..   
+00005f90: 2023 202d 2d2d 2d2d 2d63 6f6e 7665 7274   # ------convert
+00005fa0: 2061 6c6c 2032 4420 6172 7261 7973 2069   all 2D arrays i
+00005fb0: 6e74 6f20 3144 2074 6f20 7370 6565 6420  nto 1D to speed 
+00005fc0: 7570 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063  up--------.    c
+00005fd0: 6f72 7220 3d20 6e70 2e7a 6572 6f73 286e  orr = np.zeros(n
+00005fe0: 7769 6e20 2a20 4e66 6674 322c 2064 7479  win * Nfft2, dty
+00005ff0: 7065 3d6e 702e 636f 6d70 6c65 7836 3429  pe=np.complex64)
+00006000: 0a20 2020 2063 6f72 7220 3d20 6666 7431  .    corr = fft1
+00006010: 5f73 6d6f 6f74 6865 645f 6162 732e 7265  _smoothed_abs.re
+00006020: 7368 6170 6528 0a20 2020 2020 2020 2066  shape(.        f
+00006030: 6674 315f 736d 6f6f 7468 6564 5f61 6273  ft1_smoothed_abs
+00006040: 2e73 697a 652c 0a20 2020 2029 202a 2066  .size,.    ) * f
+00006050: 6674 322e 7265 7368 6170 6528 0a20 2020  ft2.reshape(.   
+00006060: 2020 2020 2066 6674 322e 7369 7a65 2c0a       fft2.size,.
+00006070: 2020 2020 290a 0a20 2020 2069 6620 6d65      )..    if me
+00006080: 7468 6f64 203d 3d20 2263 6f68 6572 656e  thod == "coheren
+00006090: 6379 223a 0a20 2020 2020 2020 2074 656d  cy":.        tem
+000060a0: 7020 3d20 6d6f 7669 6e67 5f61 7665 280a  p = moving_ave(.
+000060b0: 2020 2020 2020 2020 2020 2020 6e70 2e61              np.a
+000060c0: 6273 280a 2020 2020 2020 2020 2020 2020  bs(.            
+000060d0: 2020 2020 6666 7432 2e72 6573 6861 7065      fft2.reshape
+000060e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000060f0: 2020 2020 2020 6666 7432 2e73 697a 652c        fft2.size,
+00006100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006110: 2029 0a20 2020 2020 2020 2020 2020 2029   ).            )
+00006120: 2c0a 2020 2020 2020 2020 2020 2020 736d  ,.            sm
+00006130: 6f6f 7468 7370 6563 745f 4e2c 0a20 2020  oothspect_N,.   
+00006140: 2020 2020 2029 0a20 2020 2020 2020 2063       ).        c
+00006150: 6f72 7220 2f3d 2074 656d 700a 2020 2020  orr /= temp.    
+00006160: 636f 7272 203d 2063 6f72 722e 7265 7368  corr = corr.resh
+00006170: 6170 6528 6e77 696e 2c20 4e66 6674 3229  ape(nwin, Nfft2)
+00006180: 0a0a 2020 2020 6966 2073 7562 7374 6163  ..    if substac
+00006190: 6b3a 0a20 2020 2020 2020 2069 6620 7375  k:.        if su
+000061a0: 6273 7461 636b 5f6c 656e 203d 3d20 6363  bstack_len == cc
+000061b0: 5f6c 656e 3a0a 2020 2020 2020 2020 2020  _len:.          
+000061c0: 2020 2320 6368 6f6f 7365 2074 6f20 6b65    # choose to ke
+000061d0: 6570 2061 6c6c 2066 6674 2064 6174 6120  ep all fft data 
+000061e0: 666f 7220 6120 6461 790a 2020 2020 2020  for a day.      
+000061f0: 2020 2020 2020 735f 636f 7272 203d 206e        s_corr = n
+00006200: 702e 7a65 726f 7328 7368 6170 653d 286e  p.zeros(shape=(n
+00006210: 7769 6e2c 204e 6666 7429 2c20 6474 7970  win, Nfft), dtyp
+00006220: 653d 6e70 2e66 6c6f 6174 3332 2920 2023  e=np.float32)  #
+00006230: 2073 7461 636b 6564 2063 6f72 7265 6c61   stacked correla
+00006240: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
+00006250: 2061 6d70 6d61 7820 3d20 6e70 2e7a 6572   ampmax = np.zer
+00006260: 6f73 286e 7769 6e2c 2064 7479 7065 3d6e  os(nwin, dtype=n
+00006270: 702e 666c 6f61 7433 3229 0a20 2020 2020  p.float32).     
+00006280: 2020 2020 2020 206e 5f63 6f72 7220 3d20         n_corr = 
+00006290: 6e70 2e7a 6572 6f73 286e 7769 6e2c 2064  np.zeros(nwin, d
+000062a0: 7479 7065 3d6e 702e 696e 7431 3629 2020  type=np.int16)  
+000062b0: 2320 6e75 6d62 6572 206f 6620 636f 7272  # number of corr
+000062c0: 656c 6174 696f 6e73 2066 6f72 2065 6163  elations for eac
+000062d0: 6820 7375 6273 7461 636b 0a20 2020 2020  h substack.     
+000062e0: 2020 2020 2020 2074 5f63 6f72 7220 3d20         t_corr = 
+000062f0: 6461 7461 535f 7420 2023 2074 696d 6573  dataS_t  # times
+00006300: 7461 6d70 0a20 2020 2020 2020 2020 2020  tamp.           
+00006310: 2063 7261 7020 3d20 6e70 2e7a 6572 6f73   crap = np.zeros
+00006320: 284e 6666 742c 2064 7479 7065 3d6e 702e  (Nfft, dtype=np.
+00006330: 636f 6d70 6c65 7836 3429 0a20 2020 2020  complex64).     
+00006340: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+00006350: 7261 6e67 6528 6e77 696e 293a 0a20 2020  range(nwin):.   
+00006360: 2020 2020 2020 2020 2020 2020 206e 5f63               n_c
+00006370: 6f72 725b 695d 203d 2031 0a20 2020 2020  orr[i] = 1.     
+00006380: 2020 2020 2020 2020 2020 2063 7261 705b             crap[
+00006390: 3a4e 6666 7432 5d20 3d20 636f 7272 5b69  :Nfft2] = corr[i
+000063a0: 2c20 3a5d 0a20 2020 2020 2020 2020 2020  , :].           
+000063b0: 2020 2020 2063 7261 705b 3a4e 6666 7432       crap[:Nfft2
+000063c0: 5d20 3d20 6372 6170 5b3a 4e66 6674 325d  ] = crap[:Nfft2]
+000063d0: 202d 206e 702e 6d65 616e 2863 7261 705b   - np.mean(crap[
+000063e0: 3a4e 6666 7432 5d29 2020 2320 7265 6d6f  :Nfft2])  # remo
+000063f0: 7665 2074 6865 206d 6561 6e20 696e 2066  ve the mean in f
+00006400: 7265 7120 646f 6d61 696e 2028 7370 696b  req domain (spik
+00006410: 6520 6174 2074 3d30 290a 2020 2020 2020  e at t=0).      
+00006420: 2020 2020 2020 2020 2020 6372 6170 5b2d            crap[-
+00006430: 284e 6666 7432 2920 2b20 3120 3a5d 203d  (Nfft2) + 1 :] =
+00006440: 206e 702e 666c 6970 286e 702e 636f 6e6a   np.flip(np.conj
+00006450: 2863 7261 705b 313a 284e 6666 7432 295d  (crap[1:(Nfft2)]
+00006460: 292c 2061 7869 733d 3029 0a20 2020 2020  ), axis=0).     
+00006470: 2020 2020 2020 2020 2020 2063 7261 705b             crap[
+00006480: 305d 203d 2063 6f6d 706c 6578 2830 2c20  0] = complex(0, 
+00006490: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
+000064a0: 2020 2073 5f63 6f72 725b 692c 203a 5d20     s_corr[i, :] 
+000064b0: 3d20 6e70 2e72 6561 6c28 6e70 2e66 6674  = np.real(np.fft
+000064c0: 2e69 6666 7473 6869 6674 2873 6369 7079  .ifftshift(scipy
+000064d0: 2e66 6674 7061 636b 2e69 6666 7428 6372  .fftpack.ifft(cr
+000064e0: 6170 2c20 4e66 6674 2c20 6178 6973 3d30  ap, Nfft, axis=0
+000064f0: 2929 290a 0a20 2020 2020 2020 2020 2020  )))..           
+00006500: 2023 2072 656d 6f76 6520 6162 6e6f 726d   # remove abnorm
+00006510: 616c 2064 6174 610a 2020 2020 2020 2020  al data.        
+00006520: 2020 2020 616d 706d 6178 203d 206e 702e      ampmax = np.
+00006530: 6d61 7828 735f 636f 7272 2c20 6178 6973  max(s_corr, axis
+00006540: 3d31 290a 2020 2020 2020 2020 2020 2020  =1).            
+00006550: 7469 6e64 7820 3d20 6e70 2e77 6865 7265  tindx = np.where
+00006560: 2828 616d 706d 6178 203c 2032 3020 2a20  ((ampmax < 20 * 
+00006570: 6e70 2e6d 6564 6961 6e28 616d 706d 6178  np.median(ampmax
+00006580: 2929 2026 2028 616d 706d 6178 203e 2030  )) & (ampmax > 0
+00006590: 2929 5b30 5d0a 2020 2020 2020 2020 2020  ))[0].          
+000065a0: 2020 735f 636f 7272 203d 2073 5f63 6f72    s_corr = s_cor
+000065b0: 725b 7469 6e64 782c 203a 5d0a 2020 2020  r[tindx, :].    
+000065c0: 2020 2020 2020 2020 745f 636f 7272 203d          t_corr =
+000065d0: 2074 5f63 6f72 725b 7469 6e64 785d 0a20   t_corr[tindx]. 
+000065e0: 2020 2020 2020 2020 2020 206e 5f63 6f72             n_cor
+000065f0: 7220 3d20 6e5f 636f 7272 5b74 696e 6478  r = n_corr[tindx
+00006600: 5d0a 0a20 2020 2020 2020 2065 6c73 653a  ]..        else:
+00006610: 0a20 2020 2020 2020 2020 2020 2023 2067  .            # g
+00006620: 6574 2074 696d 6520 696e 666f 726d 6174  et time informat
+00006630: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+00006640: 5474 6f74 616c 203d 2064 6174 6153 5f74  Ttotal = dataS_t
+00006650: 5b2d 315d 202d 2064 6174 6153 5f74 5b30  [-1] - dataS_t[0
+00006660: 5d20 2023 2074 6f74 616c 2064 7572 6174  ]  # total durat
+00006670: 696f 6e20 6f66 2077 6861 7420 7765 2068  ion of what we h
+00006680: 6176 6520 6e6f 770a 2020 2020 2020 2020  ave now.        
+00006690: 2020 2020 7473 7461 7274 203d 2064 6174      tstart = dat
+000066a0: 6153 5f74 5b30 5d0a 0a20 2020 2020 2020  aS_t[0]..       
+000066b0: 2020 2020 206e 7374 6163 6b20 3d20 696e       nstack = in
+000066c0: 7428 6e70 2e72 6f75 6e64 2854 746f 7461  t(np.round(Ttota
+000066d0: 6c20 2f20 7375 6273 7461 636b 5f6c 656e  l / substack_len
+000066e0: 2929 0a20 2020 2020 2020 2020 2020 2061  )).            a
+000066f0: 6d70 6d61 7820 3d20 6e70 2e7a 6572 6f73  mpmax = np.zeros
+00006700: 286e 7374 6163 6b2c 2064 7479 7065 3d6e  (nstack, dtype=n
+00006710: 702e 666c 6f61 7433 3229 0a20 2020 2020  p.float32).     
+00006720: 2020 2020 2020 2073 5f63 6f72 7220 3d20         s_corr = 
+00006730: 6e70 2e7a 6572 6f73 2873 6861 7065 3d28  np.zeros(shape=(
+00006740: 6e73 7461 636b 2c20 4e66 6674 292c 2064  nstack, Nfft), d
+00006750: 7479 7065 3d6e 702e 666c 6f61 7433 3229  type=np.float32)
+00006760: 0a20 2020 2020 2020 2020 2020 206e 5f63  .            n_c
+00006770: 6f72 7220 3d20 6e70 2e7a 6572 6f73 286e  orr = np.zeros(n
+00006780: 7374 6163 6b2c 2064 7479 7065 3d6e 702e  stack, dtype=np.
+00006790: 696e 7429 0a20 2020 2020 2020 2020 2020  int).           
+000067a0: 2074 5f63 6f72 7220 3d20 6e70 2e7a 6572   t_corr = np.zer
+000067b0: 6f73 286e 7374 6163 6b2c 2064 7479 7065  os(nstack, dtype
+000067c0: 3d6e 702e 666c 6f61 7429 0a20 2020 2020  =np.float).     
+000067d0: 2020 2020 2020 2063 7261 7020 3d20 6e70         crap = np
+000067e0: 2e7a 6572 6f73 284e 6666 742c 2064 7479  .zeros(Nfft, dty
+000067f0: 7065 3d6e 702e 636f 6d70 6c65 7836 3429  pe=np.complex64)
+00006800: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+00006810: 7220 6973 7461 636b 2069 6e20 7261 6e67  r istack in rang
+00006820: 6528 6e73 7461 636b 293a 0a20 2020 2020  e(nstack):.     
+00006830: 2020 2020 2020 2020 2020 2023 2066 696e             # fin
+00006840: 6420 7468 6520 696e 6465 7865 7320 6f66  d the indexes of
+00006850: 2061 6c6c 206f 6620 7468 6520 7769 6e64   all of the wind
+00006860: 6f77 7320 7468 6174 2073 7461 7274 206f  ows that start o
+00006870: 7220 656e 6420 7769 7468 696e 0a20 2020  r end within.   
+00006880: 2020 2020 2020 2020 2020 2020 2069 7469               iti
+00006890: 6d65 203d 206e 702e 7768 6572 6528 2864  me = np.where((d
+000068a0: 6174 6153 5f74 203e 3d20 7473 7461 7274  ataS_t >= tstart
+000068b0: 2920 2620 2864 6174 6153 5f74 203c 2074  ) & (dataS_t < t
+000068c0: 7374 6172 7420 2b20 7375 6273 7461 636b  start + substack
+000068d0: 5f6c 656e 2929 5b30 5d0a 2020 2020 2020  _len))[0].      
+000068e0: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+000068f0: 2869 7469 6d65 2920 3d3d 2030 3a0a 2020  (itime) == 0:.  
+00006900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006910: 2020 7473 7461 7274 202b 3d20 7375 6273    tstart += subs
+00006920: 7461 636b 5f6c 656e 0a20 2020 2020 2020  tack_len.       
+00006930: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00006940: 7469 6e75 650a 0a20 2020 2020 2020 2020  tinue..         
+00006950: 2020 2020 2020 2063 7261 705b 3a4e 6666         crap[:Nff
+00006960: 7432 5d20 3d20 6e70 2e6d 6561 6e28 636f  t2] = np.mean(co
+00006970: 7272 5b69 7469 6d65 2c20 3a5d 2c20 6178  rr[itime, :], ax
+00006980: 6973 3d30 2920 2023 206c 696e 6561 7220  is=0)  # linear 
+00006990: 6176 6572 6167 6520 6f66 2074 6865 2063  average of the c
+000069a0: 6f72 7265 6c61 7469 6f6e 0a20 2020 2020  orrelation.     
+000069b0: 2020 2020 2020 2020 2020 2063 7261 705b             crap[
+000069c0: 3a4e 6666 7432 5d20 3d20 6372 6170 5b3a  :Nfft2] = crap[:
+000069d0: 4e66 6674 325d 202d 206e 702e 6d65 616e  Nfft2] - np.mean
+000069e0: 2863 7261 705b 3a4e 6666 7432 5d29 2020  (crap[:Nfft2])  
+000069f0: 2320 7265 6d6f 7665 2074 6865 206d 6561  # remove the mea
+00006a00: 6e20 696e 2066 7265 7120 646f 6d61 696e  n in freq domain
+00006a10: 2028 7370 696b 6520 6174 2074 3d30 290a   (spike at t=0).
+00006a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006a30: 6372 6170 5b2d 284e 6666 7432 2920 2b20  crap[-(Nfft2) + 
+00006a40: 3120 3a5d 203d 206e 702e 666c 6970 286e  1 :] = np.flip(n
+00006a50: 702e 636f 6e6a 2863 7261 705b 313a 284e  p.conj(crap[1:(N
+00006a60: 6666 7432 295d 292c 2061 7869 733d 3029  fft2)]), axis=0)
+00006a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006a80: 2063 7261 705b 305d 203d 2063 6f6d 706c   crap[0] = compl
+00006a90: 6578 2830 2c20 3029 0a20 2020 2020 2020  ex(0, 0).       
+00006aa0: 2020 2020 2020 2020 2073 5f63 6f72 725b           s_corr[
+00006ab0: 6973 7461 636b 2c20 3a5d 203d 206e 702e  istack, :] = np.
+00006ac0: 7265 616c 286e 702e 6666 742e 6966 6674  real(np.fft.ifft
+00006ad0: 7368 6966 7428 7363 6970 792e 6666 7470  shift(scipy.fftp
+00006ae0: 6163 6b2e 6966 6674 2863 7261 702c 204e  ack.ifft(crap, N
+00006af0: 6666 742c 2061 7869 733d 3029 2929 0a20  fft, axis=0))). 
+00006b00: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00006b10: 5f63 6f72 725b 6973 7461 636b 5d20 3d20  _corr[istack] = 
+00006b20: 6c65 6e28 6974 696d 6529 2020 2320 6e75  len(itime)  # nu
+00006b30: 6d62 6572 206f 6620 7769 6e64 6f77 7320  mber of windows 
+00006b40: 7374 6163 6b73 0a20 2020 2020 2020 2020  stacks.         
+00006b50: 2020 2020 2020 2074 5f63 6f72 725b 6973         t_corr[is
+00006b60: 7461 636b 5d20 3d20 7473 7461 7274 2020  tack] = tstart  
+00006b70: 2320 7361 7665 2074 6865 2074 696d 6520  # save the time 
+00006b80: 7374 616d 7073 0a20 2020 2020 2020 2020  stamps.         
+00006b90: 2020 2020 2020 2074 7374 6172 7420 2b3d         tstart +=
+00006ba0: 2073 7562 7374 6163 6b5f 6c65 6e0a 2020   substack_len.  
+00006bb0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00006bc0: 7072 696e 7428 2763 6f72 7265 6c61 7469  print('correlati
+00006bd0: 6f6e 2064 6f6e 6520 616e 6420 7374 6163  on done and stac
+00006be0: 6b65 6420 6174 2074 696d 6520 2573 2720  ked at time %s' 
+00006bf0: 2520 7374 7228 745f 636f 7272 5b69 7374  % str(t_corr[ist
+00006c00: 6163 6b5d 2929 0a0a 2020 2020 2020 2020  ack]))..        
+00006c10: 2020 2020 2320 7265 6d6f 7665 2061 626e      # remove abn
+00006c20: 6f72 6d61 6c20 6461 7461 0a20 2020 2020  ormal data.     
+00006c30: 2020 2020 2020 2061 6d70 6d61 7820 3d20         ampmax = 
+00006c40: 6e70 2e6d 6178 2873 5f63 6f72 722c 2061  np.max(s_corr, a
+00006c50: 7869 733d 3129 0a20 2020 2020 2020 2020  xis=1).         
+00006c60: 2020 2074 696e 6478 203d 206e 702e 7768     tindx = np.wh
+00006c70: 6572 6528 2861 6d70 6d61 7820 3c20 3230  ere((ampmax < 20
+00006c80: 202a 206e 702e 6d65 6469 616e 2861 6d70   * np.median(amp
+00006c90: 6d61 7829 2920 2620 2861 6d70 6d61 7820  max)) & (ampmax 
+00006ca0: 3e20 3029 295b 305d 0a20 2020 2020 2020  > 0))[0].       
+00006cb0: 2020 2020 2073 5f63 6f72 7220 3d20 735f       s_corr = s_
+00006cc0: 636f 7272 5b74 696e 6478 2c20 3a5d 0a20  corr[tindx, :]. 
+00006cd0: 2020 2020 2020 2020 2020 2074 5f63 6f72             t_cor
+00006ce0: 7220 3d20 745f 636f 7272 5b74 696e 6478  r = t_corr[tindx
+00006cf0: 5d0a 2020 2020 2020 2020 2020 2020 6e5f  ].            n_
+00006d00: 636f 7272 203d 206e 5f63 6f72 725b 7469  corr = n_corr[ti
+00006d10: 6e64 785d 0a0a 2020 2020 656c 7365 3a0a  ndx]..    else:.
+00006d20: 2020 2020 2020 2020 2320 6176 6572 6167          # averag
+00006d30: 6520 6461 696c 7920 6372 6f73 7320 636f  e daily cross co
+00006d40: 7272 656c 6174 696f 6e20 6675 6e63 7469  rrelation functi
+00006d50: 6f6e 730a 2020 2020 2020 2020 616d 706d  ons.        ampm
+00006d60: 6178 203d 206e 702e 6d61 7828 636f 7272  ax = np.max(corr
+00006d70: 2c20 6178 6973 3d31 290a 2020 2020 2020  , axis=1).      
+00006d80: 2020 7469 6e64 7820 3d20 6e70 2e77 6865    tindx = np.whe
+00006d90: 7265 2828 616d 706d 6178 203c 2032 3020  re((ampmax < 20 
+00006da0: 2a20 6e70 2e6d 6564 6961 6e28 616d 706d  * np.median(ampm
+00006db0: 6178 2929 2026 2028 616d 706d 6178 203e  ax)) & (ampmax >
+00006dc0: 2030 2929 5b30 5d0a 2020 2020 2020 2020   0))[0].        
+00006dd0: 6e5f 636f 7272 203d 206e 7769 6e0a 2020  n_corr = nwin.  
+00006de0: 2020 2020 2020 735f 636f 7272 203d 206e        s_corr = n
+00006df0: 702e 7a65 726f 7328 4e66 6674 2c20 6474  p.zeros(Nfft, dt
+00006e00: 7970 653d 6e70 2e66 6c6f 6174 3332 290a  ype=np.float32).
+00006e10: 2020 2020 2020 2020 745f 636f 7272 203d          t_corr =
+00006e20: 2064 6174 6153 5f74 5b30 5d0a 2020 2020   dataS_t[0].    
+00006e30: 2020 2020 6372 6170 203d 206e 702e 7a65      crap = np.ze
+00006e40: 726f 7328 4e66 6674 2c20 6474 7970 653d  ros(Nfft, dtype=
+00006e50: 6e70 2e63 6f6d 706c 6578 3634 290a 2020  np.complex64).  
+00006e60: 2020 2020 2020 6372 6170 5b3a 4e66 6674        crap[:Nfft
+00006e70: 325d 203d 206e 702e 6d65 616e 2863 6f72  2] = np.mean(cor
+00006e80: 725b 7469 6e64 785d 2c20 6178 6973 3d30  r[tindx], axis=0
+00006e90: 290a 2020 2020 2020 2020 6372 6170 5b3a  ).        crap[:
+00006ea0: 4e66 6674 325d 203d 2063 7261 705b 3a4e  Nfft2] = crap[:N
+00006eb0: 6666 7432 5d20 2d20 6e70 2e6d 6561 6e28  fft2] - np.mean(
+00006ec0: 6372 6170 5b3a 4e66 6674 325d 2c20 6178  crap[:Nfft2], ax
+00006ed0: 6973 3d30 290a 2020 2020 2020 2020 6372  is=0).        cr
+00006ee0: 6170 5b2d 284e 6666 7432 2920 2b20 3120  ap[-(Nfft2) + 1 
+00006ef0: 3a5d 203d 206e 702e 666c 6970 286e 702e  :] = np.flip(np.
+00006f00: 636f 6e6a 2863 7261 705b 313a 284e 6666  conj(crap[1:(Nff
+00006f10: 7432 295d 292c 2061 7869 733d 3029 0a20  t2)]), axis=0). 
+00006f20: 2020 2020 2020 2073 5f63 6f72 7220 3d20         s_corr = 
+00006f30: 6e70 2e72 6561 6c28 6e70 2e66 6674 2e69  np.real(np.fft.i
+00006f40: 6666 7473 6869 6674 2873 6369 7079 2e66  fftshift(scipy.f
+00006f50: 6674 7061 636b 2e69 6666 7428 6372 6170  ftpack.ifft(crap
+00006f60: 2c20 4e66 6674 2c20 6178 6973 3d30 2929  , Nfft, axis=0))
+00006f70: 290a 0a20 2020 2023 2074 7269 6d20 7468  )..    # trim th
+00006f80: 6520 4343 4673 2069 6e20 5b2d 6d61 786c  e CCFs in [-maxl
+00006f90: 6167 206d 6178 6c61 675d 0a20 2020 2074  ag maxlag].    t
+00006fa0: 203d 206e 702e 6172 616e 6765 282d 4e66   = np.arange(-Nf
+00006fb0: 6674 3220 2b20 312c 204e 6666 7432 2920  ft2 + 1, Nfft2) 
+00006fc0: 2a20 6474 0a20 2020 2069 6e64 203d 206e  * dt.    ind = n
+00006fd0: 702e 7768 6572 6528 6e70 2e61 6273 2874  p.where(np.abs(t
+00006fe0: 2920 3c3d 206d 6178 6c61 6729 5b30 5d0a  ) <= maxlag)[0].
+00006ff0: 2020 2020 6966 2073 5f63 6f72 722e 6e64      if s_corr.nd
+00007000: 696d 203d 3d20 313a 0a20 2020 2020 2020  im == 1:.       
+00007010: 2073 5f63 6f72 7220 3d20 735f 636f 7272   s_corr = s_corr
+00007020: 5b69 6e64 5d0a 2020 2020 656c 6966 2073  [ind].    elif s
+00007030: 5f63 6f72 722e 6e64 696d 203d 3d20 323a  _corr.ndim == 2:
+00007040: 0a20 2020 2020 2020 2073 5f63 6f72 7220  .        s_corr 
+00007050: 3d20 735f 636f 7272 5b3a 2c20 696e 645d  = s_corr[:, ind]
+00007060: 0a20 2020 2072 6574 7572 6e20 735f 636f  .    return s_co
+00007070: 7272 2c20 745f 636f 7272 2c20 6e5f 636f  rr, t_corr, n_co
+00007080: 7272 0a0a 0a64 6566 2063 6f72 7265 6c61  rr...def correla
+00007090: 7465 5f6e 6f6e 6c69 6e65 6172 5f73 7461  te_nonlinear_sta
+000070a0: 636b 2866 6674 315f 736d 6f6f 7468 6564  ck(fft1_smoothed
+000070b0: 5f61 6273 2c20 6666 7432 2c20 442c 204e  _abs, fft2, D, N
+000070c0: 6666 742c 2064 6174 6153 5f74 293a 0a20  fft, dataS_t):. 
+000070d0: 2020 2022 2222 0a20 2020 2074 6869 7320     """.    this 
+000070e0: 6675 6e63 7469 6f6e 2064 6f65 7320 7468  function does th
+000070f0: 6520 6372 6f73 732d 636f 7272 656c 6174  e cross-correlat
+00007100: 696f 6e20 696e 2066 7265 7120 646f 6d61  ion in freq doma
+00007110: 696e 2061 6e64 2068 6173 2074 6865 206f  in and has the o
+00007120: 7074 696f 6e20 746f 206b 6565 7020 7375  ption to keep su
+00007130: 622d 7374 6163 6b73 206f 660a 2020 2020  b-stacks of.    
+00007140: 7468 6520 6372 6f73 732d 636f 7272 656c  the cross-correl
+00007150: 6174 696f 6e20 6966 206e 6565 6465 642e  ation if needed.
+00007160: 2069 7420 7461 6b65 7320 6164 7661 6e74   it takes advant
+00007170: 6167 6520 6f66 2074 6865 206c 696e 6561  age of the linea
+00007180: 7220 7265 6c61 7469 6f6e 7368 6970 206f  r relationship o
+00007190: 6620 6966 6674 2c20 736f 2074 6861 740a  f ifft, so that.
+000071a0: 2020 2020 7374 6163 6b69 6e67 2069 7320      stacking is 
+000071b0: 7065 7266 6f72 6d65 6420 696e 2073 7065  performed in spe
+000071c0: 6374 7275 6d20 646f 6d61 696e 2066 6972  ctrum domain fir
+000071d0: 7374 2074 6f20 7265 6475 6365 2074 6865  st to reduce the
+000071e0: 2074 6f74 616c 206e 756d 6265 7220 6f66   total number of
+000071f0: 2069 6666 742e 2028 7573 6564 2069 6e20   ifft. (used in 
+00007200: 5331 290a 2020 2020 5041 5241 4d45 5445  S1).    PARAMETE
+00007210: 5253 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  RS:.    --------
+00007220: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
+00007230: 2020 6666 7431 5f73 6d6f 6f74 6865 645f    fft1_smoothed_
+00007240: 6162 733a 2073 6d6f 6f74 6865 6420 706f  abs: smoothed po
+00007250: 7765 7220 7370 6563 7472 616c 2064 656e  wer spectral den
+00007260: 7369 7479 206f 6620 7468 6520 4646 5420  sity of the FFT 
+00007270: 666f 7220 7468 6520 736f 7572 6365 2073  for the source s
+00007280: 7461 7469 6f6e 0a20 2020 2066 6674 323a  tation.    fft2:
+00007290: 2072 6177 2046 4654 2073 7065 6374 7275   raw FFT spectru
+000072a0: 6d20 6f66 2074 6865 2072 6563 6569 7665  m of the receive
+000072b0: 7220 7374 6174 696f 6e0a 2020 2020 443a  r station.    D:
+000072c0: 2064 6963 7469 6f6e 6172 7920 636f 6e74   dictionary cont
+000072d0: 6169 6e69 6e67 2066 6f6c 6c6f 7769 6e67  aining following
+000072e0: 2070 6172 616d 6574 6572 733a 0a20 2020   parameters:.   
+000072f0: 2020 2020 206d 6178 6c61 673a 2020 6d61       maxlag:  ma
+00007300: 7869 6d75 6d20 6c61 6773 2074 6f20 6b65  ximum lags to ke
+00007310: 6570 2069 6e20 7468 6520 6372 6f73 7320  ep in the cross 
+00007320: 636f 7272 656c 6174 696f 6e0a 2020 2020  correlation.    
+00007330: 2020 2020 6474 3a20 2020 2020 2073 616d      dt:      sam
+00007340: 706c 696e 6720 7261 7465 2028 696e 2073  pling rate (in s
+00007350: 290a 2020 2020 2020 2020 6e77 696e 3a20  ).        nwin: 
+00007360: 2020 206e 756d 6265 7220 6f66 2073 6567     number of seg
+00007370: 6d65 6e74 7320 696e 2074 6865 2032 4420  ments in the 2D 
+00007380: 6d61 7472 6978 0a20 2020 2020 2020 206d  matrix.        m
+00007390: 6574 686f 643a 2020 6372 6f73 732d 636f  ethod:  cross-co
+000073a0: 7272 656c 6174 696f 6e20 6d65 7468 6f64  rrelation method
+000073b0: 7320 7365 6c65 6374 6564 2062 7920 7468  s selected by th
+000073c0: 6520 7573 6572 0a20 2020 2020 2020 2066  e user.        f
+000073d0: 7265 716d 696e 3a20 6d69 6e69 6d75 6d20  reqmin: minimum 
+000073e0: 6672 6571 7565 6e63 7920 2848 7a29 0a20  frequency (Hz). 
+000073f0: 2020 2020 2020 2066 7265 716d 6178 3a20         freqmax: 
+00007400: 6d61 7869 6d75 6d20 6672 6571 7565 6e63  maximum frequenc
+00007410: 7920 2848 7a29 0a20 2020 204e 6666 743a  y (Hz).    Nfft:
+00007420: 2020 2020 6e75 6d62 6572 206f 6620 6672      number of fr
+00007430: 6571 7565 6e63 7920 706f 696e 7473 2066  equency points f
+00007440: 6f72 2069 6666 740a 2020 2020 6461 7461  or ifft.    data
+00007450: 535f 743a 206d 6174 7269 7820 6f66 2064  S_t: matrix of d
+00007460: 6174 6574 696d 6520 6f62 6a65 6374 2e0a  atetime object..
+00007470: 2020 2020 5245 5455 524e 533a 0a20 2020      RETURNS:.   
+00007480: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
+00007490: 2d2d 2d2d 2d2d 0a20 2020 2073 5f63 6f72  ------.    s_cor
+000074a0: 723a 2031 4420 6f72 2032 4420 6d61 7472  r: 1D or 2D matr
+000074b0: 6978 206f 6620 7468 6520 6176 6572 6167  ix of the averag
+000074c0: 6564 206f 7220 7375 622d 7374 6163 6b73  ed or sub-stacks
+000074d0: 206f 6620 6372 6f73 732d 636f 7272 656c   of cross-correl
+000074e0: 6174 696f 6e20 6675 6e63 7469 6f6e 7320  ation functions 
+000074f0: 696e 2074 696d 6520 646f 6d61 696e 0a20  in time domain. 
+00007500: 2020 2074 5f63 6f72 723a 2074 696d 6573     t_corr: times
+00007510: 7461 6d70 2066 6f72 2065 6163 6820 7375  tamp for each su
+00007520: 622d 7374 6163 6b20 6f72 2061 7665 7261  b-stack or avera
+00007530: 6765 6420 6675 6e63 7469 6f6e 0a20 2020  ged function.   
+00007540: 206e 5f63 6f72 723a 206e 756d 6265 7220   n_corr: number 
+00007550: 6f66 2069 6e63 6c75 6465 6420 7365 676d  of included segm
+00007560: 656e 7473 2066 6f72 2065 6163 6820 7375  ents for each su
+00007570: 622d 7374 6163 6b20 6f72 2061 7665 7261  b-stack or avera
+00007580: 6765 6420 6675 6e63 7469 6f6e 0a20 2020  ged function.   
+00007590: 2022 2222 0a20 2020 2023 202d 2d2d 2d6c   """.    # ----l
+000075a0: 6f61 6420 7061 7261 6d74 6572 732d 2d2d  oad paramters---
+000075b0: 2d0a 2020 2020 6474 203d 2044 5b22 6474  -.    dt = D["dt
+000075c0: 225d 0a20 2020 206d 6178 6c61 6720 3d20  "].    maxlag = 
+000075d0: 445b 226d 6178 6c61 6722 5d0a 2020 2020  D["maxlag"].    
+000075e0: 6d65 7468 6f64 203d 2044 5b22 6363 5f6d  method = D["cc_m
+000075f0: 6574 686f 6422 5d0a 2020 2020 6363 5f6c  ethod"].    cc_l
+00007600: 656e 203d 2044 5b22 6363 5f6c 656e 225d  en = D["cc_len"]
+00007610: 0a20 2020 2073 7562 7374 6163 6b20 3d20  .    substack = 
+00007620: 445b 2273 7562 7374 6163 6b22 5d0a 2020  D["substack"].  
+00007630: 2020 7374 6163 6b5f 6d65 7468 6f64 203d    stack_method =
+00007640: 2044 5b22 7374 6163 6b5f 6d65 7468 6f64   D["stack_method
+00007650: 225d 0a20 2020 2073 7562 7374 6163 6b5f  "].    substack_
+00007660: 6c65 6e20 3d20 445b 2273 7562 7374 6163  len = D["substac
+00007670: 6b5f 6c65 6e22 5d0a 2020 2020 736d 6f6f  k_len"].    smoo
+00007680: 7468 7370 6563 745f 4e20 3d20 445b 2273  thspect_N = D["s
+00007690: 6d6f 6f74 6873 7065 6374 5f4e 225d 0a0a  moothspect_N"]..
+000076a0: 2020 2020 6e77 696e 203d 2066 6674 315f      nwin = fft1_
+000076b0: 736d 6f6f 7468 6564 5f61 6273 2e73 6861  smoothed_abs.sha
+000076c0: 7065 5b30 5d0a 2020 2020 4e66 6674 3220  pe[0].    Nfft2 
+000076d0: 3d20 6666 7431 5f73 6d6f 6f74 6865 645f  = fft1_smoothed_
+000076e0: 6162 732e 7368 6170 655b 315d 0a0a 2020  abs.shape[1]..  
+000076f0: 2020 2320 2d2d 2d2d 2d2d 636f 6e76 6572    # ------conver
+00007700: 7420 616c 6c20 3244 2061 7272 6179 7320  t all 2D arrays 
+00007710: 696e 746f 2031 4420 746f 2073 7065 6564  into 1D to speed
+00007720: 2075 702d 2d2d 2d2d 2d2d 2d0a 2020 2020   up--------.    
+00007730: 636f 7272 203d 206e 702e 7a65 726f 7328  corr = np.zeros(
+00007740: 6e77 696e 202a 204e 6666 7432 2c20 6474  nwin * Nfft2, dt
+00007750: 7970 653d 6e70 2e63 6f6d 706c 6578 3634  ype=np.complex64
+00007760: 290a 2020 2020 636f 7272 203d 2066 6674  ).    corr = fft
+00007770: 315f 736d 6f6f 7468 6564 5f61 6273 2e72  1_smoothed_abs.r
+00007780: 6573 6861 7065 280a 2020 2020 2020 2020  eshape(.        
+00007790: 6666 7431 5f73 6d6f 6f74 6865 645f 6162  fft1_smoothed_ab
+000077a0: 732e 7369 7a65 2c0a 2020 2020 2920 2a20  s.size,.    ) * 
+000077b0: 6666 7432 2e72 6573 6861 7065 280a 2020  fft2.reshape(.  
+000077c0: 2020 2020 2020 6666 7432 2e73 697a 652c        fft2.size,
+000077d0: 0a20 2020 2029 0a0a 2020 2020 2320 6e6f  .    )..    # no
+000077e0: 726d 616c 697a 6520 6279 2072 6563 6569  rmalize by recei
+000077f0: 7665 7220 7370 6563 7472 616c 2066 6f72  ver spectral for
+00007800: 2063 6f68 6572 656e 6379 0a20 2020 2069   coherency.    i
+00007810: 6620 6d65 7468 6f64 203d 3d20 2263 6f68  f method == "coh
+00007820: 6572 656e 6379 223a 0a20 2020 2020 2020  erency":.       
+00007830: 2074 656d 7020 3d20 6d6f 7669 6e67 5f61   temp = moving_a
+00007840: 7665 280a 2020 2020 2020 2020 2020 2020  ve(.            
+00007850: 6e70 2e61 6273 280a 2020 2020 2020 2020  np.abs(.        
+00007860: 2020 2020 2020 2020 6666 7432 2e72 6573          fft2.res
+00007870: 6861 7065 280a 2020 2020 2020 2020 2020  hape(.          
+00007880: 2020 2020 2020 2020 2020 6666 7432 2e73            fft2.s
+00007890: 697a 652c 0a20 2020 2020 2020 2020 2020  ize,.           
+000078a0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+000078b0: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+000078c0: 2020 736d 6f6f 7468 7370 6563 745f 4e2c    smoothspect_N,
+000078d0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+000078e0: 2020 2063 6f72 7220 2f3d 2074 656d 700a     corr /= temp.
+000078f0: 2020 2020 636f 7272 203d 2063 6f72 722e      corr = corr.
+00007900: 7265 7368 6170 6528 6e77 696e 2c20 4e66  reshape(nwin, Nf
+00007910: 6674 3229 0a0a 2020 2020 2320 7472 616e  ft2)..    # tran
+00007920: 7366 6f72 6d20 6261 636b 2074 6f20 7469  sform back to ti
+00007930: 6d65 2064 6f6d 6169 6e20 7761 7665 666f  me domain wavefo
+00007940: 726d 730a 2020 2020 735f 636f 7272 203d  rms.    s_corr =
+00007950: 206e 702e 7a65 726f 7328 7368 6170 653d   np.zeros(shape=
+00007960: 286e 7769 6e2c 204e 6666 7429 2c20 6474  (nwin, Nfft), dt
+00007970: 7970 653d 6e70 2e66 6c6f 6174 3332 2920  ype=np.float32) 
+00007980: 2023 2073 7461 636b 6564 2063 6f72 7265   # stacked corre
+00007990: 6c61 7469 6f6e 0a20 2020 2061 6d70 6d61  lation.    ampma
+000079a0: 7820 3d20 6e70 2e7a 6572 6f73 286e 7769  x = np.zeros(nwi
+000079b0: 6e2c 2064 7479 7065 3d6e 702e 666c 6f61  n, dtype=np.floa
+000079c0: 7433 3229 0a20 2020 206e 5f63 6f72 7220  t32).    n_corr 
+000079d0: 3d20 6e70 2e7a 6572 6f73 286e 7769 6e2c  = np.zeros(nwin,
+000079e0: 2064 7479 7065 3d6e 702e 696e 7431 3629   dtype=np.int16)
+000079f0: 2020 2320 6e75 6d62 6572 206f 6620 636f    # number of co
+00007a00: 7272 656c 6174 696f 6e73 2066 6f72 2065  rrelations for e
+00007a10: 6163 6820 7375 6273 7461 636b 0a20 2020  ach substack.   
+00007a20: 2074 5f63 6f72 7220 3d20 6461 7461 535f   t_corr = dataS_
+00007a30: 7420 2023 2074 696d 6573 7461 6d70 0a20  t  # timestamp. 
+00007a40: 2020 2063 7261 7020 3d20 6e70 2e7a 6572     crap = np.zer
+00007a50: 6f73 284e 6666 742c 2064 7479 7065 3d6e  os(Nfft, dtype=n
+00007a60: 702e 636f 6d70 6c65 7836 3429 0a20 2020  p.complex64).   
+00007a70: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+00007a80: 6e77 696e 293a 0a20 2020 2020 2020 206e  nwin):.        n
+00007a90: 5f63 6f72 725b 695d 203d 2031 0a20 2020  _corr[i] = 1.   
+00007aa0: 2020 2020 2063 7261 705b 3a4e 6666 7432       crap[:Nfft2
+00007ab0: 5d20 3d20 636f 7272 5b69 2c20 3a5d 0a20  ] = corr[i, :]. 
+00007ac0: 2020 2020 2020 2063 7261 705b 3a4e 6666         crap[:Nff
+00007ad0: 7432 5d20 3d20 6372 6170 5b3a 4e66 6674  t2] = crap[:Nfft
+00007ae0: 325d 202d 206e 702e 6d65 616e 2863 7261  2] - np.mean(cra
+00007af0: 705b 3a4e 6666 7432 5d29 2020 2320 7265  p[:Nfft2])  # re
+00007b00: 6d6f 7665 2074 6865 206d 6561 6e20 696e  move the mean in
+00007b10: 2066 7265 7120 646f 6d61 696e 2028 7370   freq domain (sp
+00007b20: 696b 6520 6174 2074 3d30 290a 2020 2020  ike at t=0).    
+00007b30: 2020 2020 6372 6170 5b2d 284e 6666 7432      crap[-(Nfft2
+00007b40: 2920 2b20 3120 3a5d 203d 206e 702e 666c  ) + 1 :] = np.fl
+00007b50: 6970 286e 702e 636f 6e6a 2863 7261 705b  ip(np.conj(crap[
+00007b60: 313a 284e 6666 7432 295d 292c 2061 7869  1:(Nfft2)]), axi
+00007b70: 733d 3029 0a20 2020 2020 2020 2063 7261  s=0).        cra
+00007b80: 705b 305d 203d 2063 6f6d 706c 6578 2830  p[0] = complex(0
+00007b90: 2c20 3029 0a20 2020 2020 2020 2073 5f63  , 0).        s_c
+00007ba0: 6f72 725b 692c 203a 5d20 3d20 6e70 2e72  orr[i, :] = np.r
+00007bb0: 6561 6c28 6e70 2e66 6674 2e69 6666 7473  eal(np.fft.iffts
+00007bc0: 6869 6674 2873 6369 7079 2e66 6674 7061  hift(scipy.fftpa
+00007bd0: 636b 2e69 6666 7428 6372 6170 2c20 4e66  ck.ifft(crap, Nf
+00007be0: 6674 2c20 6178 6973 3d30 2929 290a 0a20  ft, axis=0))).. 
+00007bf0: 2020 206e 735f 636f 7272 203d 2073 5f63     ns_corr = s_c
+00007c00: 6f72 720a 2020 2020 666f 7220 6969 6920  orr.    for iii 
+00007c10: 696e 2072 616e 6765 286e 735f 636f 7272  in range(ns_corr
+00007c20: 2e73 6861 7065 5b30 5d29 3a0a 2020 2020  .shape[0]):.    
+00007c30: 2020 2020 6e73 5f63 6f72 725b 6969 695d      ns_corr[iii]
+00007c40: 202f 3d20 6e70 2e6d 6178 286e 702e 6162   /= np.max(np.ab
+00007c50: 7328 6e73 5f63 6f72 725b 6969 695d 2929  s(ns_corr[iii]))
+00007c60: 0a0a 2020 2020 6966 2073 7562 7374 6163  ..    if substac
+00007c70: 6b3a 0a20 2020 2020 2020 2069 6620 7375  k:.        if su
+00007c80: 6273 7461 636b 5f6c 656e 203d 3d20 6363  bstack_len == cc
+00007c90: 5f6c 656e 3a0a 2020 2020 2020 2020 2020  _len:.          
+00007ca0: 2020 2320 7265 6d6f 7665 2061 626e 6f72    # remove abnor
+00007cb0: 6d61 6c20 6461 7461 0a20 2020 2020 2020  mal data.       
+00007cc0: 2020 2020 2061 6d70 6d61 7820 3d20 6e70       ampmax = np
+00007cd0: 2e6d 6178 2873 5f63 6f72 722c 2061 7869  .max(s_corr, axi
+00007ce0: 733d 3129 0a20 2020 2020 2020 2020 2020  s=1).           
+00007cf0: 2074 696e 6478 203d 206e 702e 7768 6572   tindx = np.wher
+00007d00: 6528 2861 6d70 6d61 7820 3c20 3230 202a  e((ampmax < 20 *
+00007d10: 206e 702e 6d65 6469 616e 2861 6d70 6d61   np.median(ampma
+00007d20: 7829 2920 2620 2861 6d70 6d61 7820 3e20  x)) & (ampmax > 
+00007d30: 3029 295b 305d 0a20 2020 2020 2020 2020  0))[0].         
+00007d40: 2020 2073 5f63 6f72 7220 3d20 735f 636f     s_corr = s_co
+00007d50: 7272 5b74 696e 6478 2c20 3a5d 0a20 2020  rr[tindx, :].   
+00007d60: 2020 2020 2020 2020 2074 5f63 6f72 7220           t_corr 
+00007d70: 3d20 745f 636f 7272 5b74 696e 6478 5d0a  = t_corr[tindx].
+00007d80: 2020 2020 2020 2020 2020 2020 6e5f 636f              n_co
+00007d90: 7272 203d 206e 5f63 6f72 725b 7469 6e64  rr = n_corr[tind
+00007da0: 785d 0a0a 2020 2020 2020 2020 656c 7365  x]..        else
+00007db0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00007dc0: 6765 7420 7469 6d65 2069 6e66 6f72 6d61  get time informa
+00007dd0: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
+00007de0: 2054 746f 7461 6c20 3d20 6461 7461 535f   Ttotal = dataS_
+00007df0: 745b 2d31 5d20 2d20 6461 7461 535f 745b  t[-1] - dataS_t[
+00007e00: 305d 2020 2320 746f 7461 6c20 6475 7261  0]  # total dura
+00007e10: 7469 6f6e 206f 6620 7768 6174 2077 6520  tion of what we 
+00007e20: 6861 7665 206e 6f77 0a20 2020 2020 2020  have now.       
+00007e30: 2020 2020 2074 7374 6172 7420 3d20 6461       tstart = da
+00007e40: 7461 535f 745b 305d 0a0a 2020 2020 2020  taS_t[0]..      
+00007e50: 2020 2020 2020 6e73 7461 636b 203d 2069        nstack = i
+00007e60: 6e74 286e 702e 726f 756e 6428 5474 6f74  nt(np.round(Ttot
+00007e70: 616c 202f 2073 7562 7374 6163 6b5f 6c65  al / substack_le
+00007e80: 6e29 290a 2020 2020 2020 2020 2020 2020  n)).            
+00007e90: 616d 706d 6178 203d 206e 702e 7a65 726f  ampmax = np.zero
+00007ea0: 7328 6e73 7461 636b 2c20 6474 7970 653d  s(nstack, dtype=
+00007eb0: 6e70 2e66 6c6f 6174 3332 290a 2020 2020  np.float32).    
+00007ec0: 2020 2020 2020 2020 735f 636f 7272 203d          s_corr =
+00007ed0: 206e 702e 7a65 726f 7328 7368 6170 653d   np.zeros(shape=
+00007ee0: 286e 7374 6163 6b2c 204e 6666 7429 2c20  (nstack, Nfft), 
+00007ef0: 6474 7970 653d 6e70 2e66 6c6f 6174 3332  dtype=np.float32
+00007f00: 290a 2020 2020 2020 2020 2020 2020 6e5f  ).            n_
+00007f10: 636f 7272 203d 206e 702e 7a65 726f 7328  corr = np.zeros(
+00007f20: 6e73 7461 636b 2c20 6474 7970 653d 6e70  nstack, dtype=np
+00007f30: 2e69 6e74 290a 2020 2020 2020 2020 2020  .int).          
+00007f40: 2020 745f 636f 7272 203d 206e 702e 7a65    t_corr = np.ze
+00007f50: 726f 7328 6e73 7461 636b 2c20 6474 7970  ros(nstack, dtyp
+00007f60: 653d 6e70 2e66 6c6f 6174 290a 2020 2020  e=np.float).    
+00007f70: 2020 2020 2020 2020 6372 6170 203d 206e          crap = n
+00007f80: 702e 7a65 726f 7328 4e66 6674 2c20 6474  p.zeros(Nfft, dt
+00007f90: 7970 653d 6e70 2e63 6f6d 706c 6578 3634  ype=np.complex64
+00007fa0: 290a 0a20 2020 2020 2020 2020 2020 2066  )..            f
+00007fb0: 6f72 2069 7374 6163 6b20 696e 2072 616e  or istack in ran
+00007fc0: 6765 286e 7374 6163 6b29 3a0a 2020 2020  ge(nstack):.    
+00007fd0: 2020 2020 2020 2020 2020 2020 2320 6669              # fi
+00007fe0: 6e64 2074 6865 2069 6e64 6578 6573 206f  nd the indexes o
+00007ff0: 6620 616c 6c20 6f66 2074 6865 2077 696e  f all of the win
+00008000: 646f 7773 2074 6861 7420 7374 6172 7420  dows that start 
+00008010: 6f72 2065 6e64 2077 6974 6869 6e0a 2020  or end within.  
+00008020: 2020 2020 2020 2020 2020 2020 2020 6974                it
+00008030: 696d 6520 3d20 6e70 2e77 6865 7265 2828  ime = np.where((
+00008040: 6461 7461 535f 7420 3e3d 2074 7374 6172  dataS_t >= tstar
+00008050: 7429 2026 2028 6461 7461 535f 7420 3c20  t) & (dataS_t < 
+00008060: 7473 7461 7274 202b 2073 7562 7374 6163  tstart + substac
+00008070: 6b5f 6c65 6e29 295b 305d 0a20 2020 2020  k_len))[0].     
+00008080: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+00008090: 6e28 6974 696d 6529 203d 3d20 303a 0a20  n(itime) == 0:. 
+000080a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000080b0: 2020 2074 7374 6172 7420 2b3d 2073 7562     tstart += sub
+000080c0: 7374 6163 6b5f 6c65 6e0a 2020 2020 2020  stack_len.      
+000080d0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+000080e0: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
+000080f0: 2020 2020 2020 2020 6372 6170 5b3a 4e66          crap[:Nf
+00008100: 6674 325d 203d 206e 702e 6d65 616e 2863  ft2] = np.mean(c
+00008110: 6f72 725b 6974 696d 652c 203a 5d2c 2061  orr[itime, :], a
+00008120: 7869 733d 3029 2020 2320 6c69 6e65 6172  xis=0)  # linear
+00008130: 2061 7665 7261 6765 206f 6620 7468 6520   average of the 
+00008140: 636f 7272 656c 6174 696f 6e0a 2020 2020  correlation.    
+00008150: 2020 2020 2020 2020 2020 2020 6372 6170              crap
+00008160: 5b3a 4e66 6674 325d 203d 2063 7261 705b  [:Nfft2] = crap[
+00008170: 3a4e 6666 7432 5d20 2d20 6e70 2e6d 6561  :Nfft2] - np.mea
+00008180: 6e28 6372 6170 5b3a 4e66 6674 325d 2920  n(crap[:Nfft2]) 
+00008190: 2023 2072 656d 6f76 6520 7468 6520 6d65   # remove the me
+000081a0: 616e 2069 6e20 6672 6571 2064 6f6d 6169  an in freq domai
+000081b0: 6e20 2873 7069 6b65 2061 7420 743d 3029  n (spike at t=0)
+000081c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000081d0: 2063 7261 705b 2d28 4e66 6674 3229 202b   crap[-(Nfft2) +
+000081e0: 2031 203a 5d20 3d20 6e70 2e66 6c69 7028   1 :] = np.flip(
+000081f0: 6e70 2e63 6f6e 6a28 6372 6170 5b31 3a28  np.conj(crap[1:(
+00008200: 4e66 6674 3229 5d29 2c20 6178 6973 3d30  Nfft2)]), axis=0
+00008210: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00008220: 2020 6372 6170 5b30 5d20 3d20 636f 6d70    crap[0] = comp
+00008230: 6c65 7828 302c 2030 290a 2020 2020 2020  lex(0, 0).      
+00008240: 2020 2020 2020 2020 2020 735f 636f 7272            s_corr
+00008250: 5b69 7374 6163 6b2c 203a 5d20 3d20 6e70  [istack, :] = np
+00008260: 2e72 6561 6c28 6e70 2e66 6674 2e69 6666  .real(np.fft.iff
+00008270: 7473 6869 6674 2873 6369 7079 2e66 6674  tshift(scipy.fft
+00008280: 7061 636b 2e69 6666 7428 6372 6170 2c20  pack.ifft(crap, 
+00008290: 4e66 6674 2c20 6178 6973 3d30 2929 290a  Nfft, axis=0))).
+000082a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000082b0: 6e5f 636f 7272 5b69 7374 6163 6b5d 203d  n_corr[istack] =
+000082c0: 206c 656e 2869 7469 6d65 2920 2023 206e   len(itime)  # n
+000082d0: 756d 6265 7220 6f66 2077 696e 646f 7773  umber of windows
+000082e0: 2073 7461 636b 730a 2020 2020 2020 2020   stacks.        
+000082f0: 2020 2020 2020 2020 745f 636f 7272 5b69          t_corr[i
+00008300: 7374 6163 6b5d 203d 2074 7374 6172 7420  stack] = tstart 
+00008310: 2023 2073 6176 6520 7468 6520 7469 6d65   # save the time
+00008320: 2073 7461 6d70 730a 2020 2020 2020 2020   stamps.        
+00008330: 2020 2020 2020 2020 7473 7461 7274 202b          tstart +
+00008340: 3d20 7375 6273 7461 636b 5f6c 656e 0a20  = substack_len. 
+00008350: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00008360: 2070 7269 6e74 2827 636f 7272 656c 6174   print('correlat
+00008370: 696f 6e20 646f 6e65 2061 6e64 2073 7461  ion done and sta
+00008380: 636b 6564 2061 7420 7469 6d65 2025 7327  cked at time %s'
+00008390: 2025 2073 7472 2874 5f63 6f72 725b 6973   % str(t_corr[is
+000083a0: 7461 636b 5d29 290a 0a20 2020 2020 2020  tack]))..       
+000083b0: 2020 2020 2023 2072 656d 6f76 6520 6162       # remove ab
+000083c0: 6e6f 726d 616c 2064 6174 610a 2020 2020  normal data.    
+000083d0: 2020 2020 2020 2020 616d 706d 6178 203d          ampmax =
+000083e0: 206e 702e 6d61 7828 735f 636f 7272 2c20   np.max(s_corr, 
+000083f0: 6178 6973 3d31 290a 2020 2020 2020 2020  axis=1).        
+00008400: 2020 2020 7469 6e64 7820 3d20 6e70 2e77      tindx = np.w
+00008410: 6865 7265 2828 616d 706d 6178 203c 2032  here((ampmax < 2
+00008420: 3020 2a20 6e70 2e6d 6564 6961 6e28 616d  0 * np.median(am
+00008430: 706d 6178 2929 2026 2028 616d 706d 6178  pmax)) & (ampmax
+00008440: 203e 2030 2929 5b30 5d0a 2020 2020 2020   > 0))[0].      
+00008450: 2020 2020 2020 735f 636f 7272 203d 2073        s_corr = s
+00008460: 5f63 6f72 725b 7469 6e64 782c 203a 5d0a  _corr[tindx, :].
+00008470: 2020 2020 2020 2020 2020 2020 745f 636f              t_co
+00008480: 7272 203d 2074 5f63 6f72 725b 7469 6e64  rr = t_corr[tind
+00008490: 785d 0a20 2020 2020 2020 2020 2020 206e  x].            n
+000084a0: 5f63 6f72 7220 3d20 6e5f 636f 7272 5b74  _corr = n_corr[t
+000084b0: 696e 6478 5d0a 0a20 2020 2065 6c73 653a  indx]..    else:
+000084c0: 0a20 2020 2020 2020 2023 2061 7665 7261  .        # avera
+000084d0: 6765 2064 6169 6c79 2063 726f 7373 2063  ge daily cross c
+000084e0: 6f72 7265 6c61 7469 6f6e 2066 756e 6374  orrelation funct
+000084f0: 696f 6e73 0a20 2020 2020 2020 2069 6620  ions.        if 
+00008500: 7374 6163 6b5f 6d65 7468 6f64 203d 3d20  stack_method == 
+00008510: 226c 696e 6561 7222 3a0a 2020 2020 2020  "linear":.      
+00008520: 2020 2020 2020 616d 706d 6178 203d 206e        ampmax = n
+00008530: 702e 6d61 7828 735f 636f 7272 2c20 6178  p.max(s_corr, ax
+00008540: 6973 3d31 290a 2020 2020 2020 2020 2020  is=1).          
+00008550: 2020 7469 6e64 7820 3d20 6e70 2e77 6865    tindx = np.whe
+00008560: 7265 2828 616d 706d 6178 203c 2032 3020  re((ampmax < 20 
+00008570: 2a20 6e70 2e6d 6564 6961 6e28 616d 706d  * np.median(ampm
+00008580: 6178 2929 2026 2028 616d 706d 6178 203e  ax)) & (ampmax >
+00008590: 2030 2929 5b30 5d0a 2020 2020 2020 2020   0))[0].        
+000085a0: 2020 2020 735f 636f 7272 203d 206e 702e      s_corr = np.
+000085b0: 6d65 616e 2873 5f63 6f72 725b 7469 6e64  mean(s_corr[tind
+000085c0: 785d 2c20 6178 6973 3d30 290a 2020 2020  x], axis=0).    
+000085d0: 2020 2020 2020 2020 745f 636f 7272 203d          t_corr =
+000085e0: 2064 6174 6153 5f74 5b30 5d0a 2020 2020   dataS_t[0].    
+000085f0: 2020 2020 2020 2020 6e5f 636f 7272 203d          n_corr =
+00008600: 206c 656e 2874 696e 6478 290a 2020 2020   len(tindx).    
+00008610: 2020 2020 656c 6966 2073 7461 636b 5f6d      elif stack_m
+00008620: 6574 686f 6420 3d3d 2022 726f 6275 7374  ethod == "robust
+00008630: 223a 0a20 2020 2020 2020 2020 2020 2070  ":.            p
+00008640: 7269 6e74 2822 646f 2072 6f62 7573 7420  rint("do robust 
+00008650: 7375 6273 7461 636b 696e 6722 290a 2020  substacking").  
+00008660: 2020 2020 2020 2020 2020 735f 636f 7272            s_corr
+00008670: 203d 2072 6f62 7573 745f 7374 6163 6b28   = robust_stack(
+00008680: 735f 636f 7272 2c20 302e 3030 3129 0a20  s_corr, 0.001). 
+00008690: 2020 2020 2020 2020 2020 2074 5f63 6f72             t_cor
+000086a0: 7220 3d20 6461 7461 535f 745b 305d 0a20  r = dataS_t[0]. 
+000086b0: 2020 2020 2020 2020 2020 206e 5f63 6f72             n_cor
+000086c0: 7220 3d20 6e77 696e 0a20 2020 2023 2020  r = nwin.    #  
+000086d0: 656c 6966 2073 7461 636b 5f6d 6574 686f  elif stack_metho
+000086e0: 6420 3d3d 2027 7365 6c65 6374 6976 6527  d == 'selective'
+000086f0: 3a0a 2020 2020 2320 2020 2020 2070 7269  :.    #      pri
+00008700: 6e74 2827 646f 2073 656c 6563 7469 7665  nt('do selective
+00008710: 2073 7562 7374 6163 6b69 6e67 2729 0a20   substacking'). 
+00008720: 2020 2023 2020 2020 2020 735f 636f 7272     #      s_corr
+00008730: 203d 2073 656c 6563 7469 7665 5f73 7461   = selective_sta
+00008740: 636b 2873 5f63 6f72 722c 302e 3030 3129  ck(s_corr,0.001)
+00008750: 0a20 2020 2023 2020 2020 2020 745f 636f  .    #      t_co
+00008760: 7272 203d 2064 6174 6153 5f74 5b30 5d0a  rr = dataS_t[0].
+00008770: 2020 2020 2320 2020 2020 206e 5f63 6f72      #      n_cor
+00008780: 7220 3d20 6e77 696e 0a0a 2020 2020 2320  r = nwin..    # 
+00008790: 7472 696d 2074 6865 2043 4346 7320 696e  trim the CCFs in
+000087a0: 205b 2d6d 6178 6c61 6720 6d61 786c 6167   [-maxlag maxlag
+000087b0: 5d0a 2020 2020 7420 3d20 6e70 2e61 7261  ].    t = np.ara
+000087c0: 6e67 6528 2d4e 6666 7432 202b 2031 2c20  nge(-Nfft2 + 1, 
+000087d0: 4e66 6674 3229 202a 2064 740a 2020 2020  Nfft2) * dt.    
+000087e0: 696e 6420 3d20 6e70 2e77 6865 7265 286e  ind = np.where(n
+000087f0: 702e 6162 7328 7429 203c 3d20 6d61 786c  p.abs(t) <= maxl
+00008800: 6167 295b 305d 0a20 2020 2069 6620 735f  ag)[0].    if s_
+00008810: 636f 7272 2e6e 6469 6d20 3d3d 2031 3a0a  corr.ndim == 1:.
+00008820: 2020 2020 2020 2020 735f 636f 7272 203d          s_corr =
+00008830: 2073 5f63 6f72 725b 696e 645d 0a20 2020   s_corr[ind].   
+00008840: 2065 6c69 6620 735f 636f 7272 2e6e 6469   elif s_corr.ndi
+00008850: 6d20 3d3d 2032 3a0a 2020 2020 2020 2020  m == 2:.        
+00008860: 735f 636f 7272 203d 2073 5f63 6f72 725b  s_corr = s_corr[
+00008870: 3a2c 2069 6e64 5d0a 2020 2020 7265 7475  :, ind].    retu
+00008880: 726e 2073 5f63 6f72 722c 2074 5f63 6f72  rn s_corr, t_cor
+00008890: 722c 206e 5f63 6f72 722c 206e 735f 636f  r, n_corr, ns_co
+000088a0: 7272 5b3a 2c20 696e 645d 0a0a 0a64 6566  rr[:, ind]...def
+000088b0: 2063 635f 7061 7261 6d65 7465 7273 2863   cc_parameters(c
+000088c0: 635f 7061 7261 2c20 636f 6f72 2c20 7463  c_para, coor, tc
+000088d0: 6f72 722c 206e 636f 7272 2c20 636f 6d70  orr, ncorr, comp
+000088e0: 293a 0a20 2020 2022 2222 0a20 2020 2074  ):.    """.    t
+000088f0: 6869 7320 6675 6e63 7469 6f6e 2061 7373  his function ass
+00008900: 656d 626c 6573 2074 6865 2070 6172 616d  embles the param
+00008910: 6574 6572 7320 666f 7220 7468 6520 6363  eters for the cc
+00008920: 2066 756e 6374 696f 6e2c 2077 6869 6368   function, which
+00008930: 2069 7320 7573 6564 0a20 2020 2077 6865   is used.    whe
+00008940: 6e20 7772 6974 696e 6720 7468 656d 2069  n writing them i
+00008950: 6e74 6f20 4153 4446 2066 696c 6573 0a20  nto ASDF files. 
+00008960: 2020 2050 4152 414d 4554 4552 533a 0a20     PARAMETERS:. 
+00008970: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
+00008980: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 635f  --------.    cc_
+00008990: 7061 7261 3a20 6469 6374 2063 6f6e 7461  para: dict conta
+000089a0: 696e 696e 6720 7061 7261 6d65 7465 7273  ining parameters
+000089b0: 2075 7365 6420 696e 2074 6865 2066 6674   used in the fft
+000089c0: 5f63 6320 7374 6570 0a20 2020 2063 6f6f  _cc step.    coo
+000089d0: 723a 2020 2020 6469 6374 2063 6f6e 7461  r:    dict conta
+000089e0: 696e 696e 6720 636f 6f72 6469 6e61 7465  ining coordinate
+000089f0: 7320 696e 666f 206f 6620 7468 6520 736f  s info of the so
+00008a00: 7572 6365 2061 6e64 2072 6563 6569 7665  urce and receive
+00008a10: 7220 7374 6174 696f 6e73 0a20 2020 2074  r stations.    t
+00008a20: 636f 7272 3a20 2020 7469 6d65 7374 616d  corr:   timestam
+00008a30: 7020 6d61 7472 6978 0a20 2020 206e 636f  p matrix.    nco
+00008a40: 7272 3a20 2020 6d61 7472 6978 206f 6620  rr:   matrix of 
+00008a50: 6e75 6d62 6572 206f 6620 676f 6f64 2073  number of good s
+00008a60: 6567 6d65 6e74 7320 666f 7220 6561 6368  egments for each
+00008a70: 2073 7562 2d73 7461 636b 2f66 696e 616c   sub-stack/final
+00008a80: 2073 7461 636b 0a20 2020 2063 6f6d 703a   stack.    comp:
+00008a90: 2020 2020 3220 6368 6172 6163 7465 7220      2 character 
+00008aa0: 7374 7269 6e67 7320 666f 7220 7468 6520  strings for the 
+00008ab0: 6372 6f73 7320 636f 7272 656c 6174 696f  cross correlatio
+00008ac0: 6e20 636f 6d70 6f6e 656e 740a 2020 2020  n component.    
+00008ad0: 5245 5455 524e 533a 0a20 2020 202d 2d2d  RETURNS:.    ---
+00008ae0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
+00008af0: 2020 2020 7061 7261 6d65 7465 7273 3a20      parameters: 
+00008b00: 6469 6374 2063 6f6e 7461 696e 696e 6720  dict containing 
+00008b10: 6162 6f76 6520 696e 666f 2075 7365 6420  above info used 
+00008b20: 666f 7220 6c61 7465 7220 7374 6163 6b69  for later stacki
+00008b30: 6e67 2f70 6c6f 7474 696e 670a 2020 2020  ng/plotting.    
+00008b40: 2222 220a 2020 2020 6c61 7453 203d 2063  """.    latS = c
+00008b50: 6f6f 725b 226c 6174 5322 5d0a 2020 2020  oor["latS"].    
+00008b60: 6c6f 6e53 203d 2063 6f6f 725b 226c 6f6e  lonS = coor["lon
+00008b70: 5322 5d0a 2020 2020 6c61 7452 203d 2063  S"].    latR = c
+00008b80: 6f6f 725b 226c 6174 5222 5d0a 2020 2020  oor["latR"].    
+00008b90: 6c6f 6e52 203d 2063 6f6f 725b 226c 6f6e  lonR = coor["lon
+00008ba0: 5222 5d0a 2020 2020 6474 203d 2063 635f  R"].    dt = cc_
+00008bb0: 7061 7261 5b22 6474 225d 0a20 2020 206d  para["dt"].    m
+00008bc0: 6178 6c61 6720 3d20 6363 5f70 6172 615b  axlag = cc_para[
+00008bd0: 226d 6178 6c61 6722 5d0a 2020 2020 7375  "maxlag"].    su
+00008be0: 6273 7461 636b 203d 2063 635f 7061 7261  bstack = cc_para
+00008bf0: 5b22 7375 6273 7461 636b 225d 0a20 2020  ["substack"].   
+00008c00: 2063 635f 6d65 7468 6f64 203d 2063 635f   cc_method = cc_
+00008c10: 7061 7261 5b22 6363 5f6d 6574 686f 6422  para["cc_method"
+00008c20: 5d0a 0a20 2020 2064 6973 742c 2061 7a69  ]..    dist, azi
+00008c30: 2c20 6261 7a20 3d20 6f62 7370 792e 6765  , baz = obspy.ge
+00008c40: 6f64 6574 6963 732e 6261 7365 2e67 7073  odetics.base.gps
+00008c50: 3264 6973 745f 617a 696d 7574 6828 6c61  2dist_azimuth(la
+00008c60: 7453 2c20 6c6f 6e53 2c20 6c61 7452 2c20  tS, lonS, latR, 
+00008c70: 6c6f 6e52 290a 2020 2020 7061 7261 6d65  lonR).    parame
+00008c80: 7465 7273 203d 207b 0a20 2020 2020 2020  ters = {.       
+00008c90: 2022 6474 223a 2064 742c 0a20 2020 2020   "dt": dt,.     
+00008ca0: 2020 2022 6d61 786c 6167 223a 2069 6e74     "maxlag": int
+00008cb0: 286d 6178 6c61 6729 2c0a 2020 2020 2020  (maxlag),.      
+00008cc0: 2020 2264 6973 7422 3a20 6e70 2e66 6c6f    "dist": np.flo
+00008cd0: 6174 3332 2864 6973 7420 2f20 3130 3030  at32(dist / 1000
+00008ce0: 292c 0a20 2020 2020 2020 2022 617a 6922  ),.        "azi"
+00008cf0: 3a20 6e70 2e66 6c6f 6174 3332 2861 7a69  : np.float32(azi
+00008d00: 292c 0a20 2020 2020 2020 2022 6261 7a22  ),.        "baz"
+00008d10: 3a20 6e70 2e66 6c6f 6174 3332 2862 617a  : np.float32(baz
+00008d20: 292c 0a20 2020 2020 2020 2022 6c6f 6e53  ),.        "lonS
+00008d30: 223a 206e 702e 666c 6f61 7433 3228 6c6f  ": np.float32(lo
+00008d40: 6e53 292c 0a20 2020 2020 2020 2022 6c61  nS),.        "la
+00008d50: 7453 223a 206e 702e 666c 6f61 7433 3228  tS": np.float32(
+00008d60: 6c61 7453 292c 0a20 2020 2020 2020 2022  latS),.        "
+00008d70: 6c6f 6e52 223a 206e 702e 666c 6f61 7433  lonR": np.float3
+00008d80: 3228 6c6f 6e52 292c 0a20 2020 2020 2020  2(lonR),.       
+00008d90: 2022 6c61 7452 223a 206e 702e 666c 6f61   "latR": np.floa
+00008da0: 7433 3228 6c61 7452 292c 0a20 2020 2020  t32(latR),.     
+00008db0: 2020 2022 6e67 6f6f 6422 3a20 6e63 6f72     "ngood": ncor
+00008dc0: 722c 0a20 2020 2020 2020 2022 6363 5f6d  r,.        "cc_m
+00008dd0: 6574 686f 6422 3a20 6363 5f6d 6574 686f  ethod": cc_metho
+00008de0: 642c 0a20 2020 2020 2020 2022 7469 6d65  d,.        "time
+00008df0: 223a 2074 636f 7272 2c0a 2020 2020 2020  ": tcorr,.      
+00008e00: 2020 2273 7562 7374 6163 6b22 3a20 7375    "substack": su
+00008e10: 6273 7461 636b 2c0a 2020 2020 2020 2020  bstack,.        
+00008e20: 2263 6f6d 7022 3a20 636f 6d70 2c0a 2020  "comp": comp,.  
+00008e30: 2020 7d0a 2020 2020 7265 7475 726e 2070    }.    return p
+00008e40: 6172 616d 6574 6572 730a 0a0a 6465 6620  arameters...def 
+00008e50: 7374 6163 6b69 6e67 2863 635f 6172 7261  stacking(cc_arra
+00008e60: 792c 2063 635f 7469 6d65 2c20 6363 5f6e  y, cc_time, cc_n
+00008e70: 676f 6f64 2c20 7374 6163 6b5f 7061 7261  good, stack_para
+00008e80: 293a 0a20 2020 2022 2222 0a20 2020 2074  ):.    """.    t
+00008e90: 6869 7320 6675 6e63 7469 6f6e 2073 7461  his function sta
+00008ea0: 636b 7320 7468 6520 6372 6f73 7320 636f  cks the cross co
+00008eb0: 7272 656c 6174 696f 6e20 6461 7461 2061  rrelation data a
+00008ec0: 6363 6f72 6469 6e67 2074 6f20 7468 6520  ccording to the 
+00008ed0: 7573 6572 2d64 6566 696e 6564 2073 7562  user-defined sub
+00008ee0: 7374 6163 6b5f 6c65 6e20 7061 7261 6d65  stack_len parame
+00008ef0: 7465 720a 0a20 2020 2050 4152 414d 4554  ter..    PARAMET
+00008f00: 4552 533a 0a20 2020 202d 2d2d 2d2d 2d2d  ERS:.    -------
+00008f10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
+00008f20: 2020 2020 6363 5f61 7272 6179 3a20 3244      cc_array: 2D
+00008f30: 206e 756d 7079 2066 6c6f 6174 3332 206d   numpy float32 m
+00008f40: 6174 7269 7820 636f 6e74 6169 6e69 6e67  atrix containing
+00008f50: 2061 6c6c 2073 6567 6d65 6e74 6564 2063   all segmented c
+00008f60: 726f 7373 2d63 6f72 7265 6c61 7469 6f6e  ross-correlation
+00008f70: 2064 6174 610a 2020 2020 6363 5f74 696d   data.    cc_tim
+00008f80: 653a 2020 3144 206e 756d 7079 2061 7272  e:  1D numpy arr
+00008f90: 6179 206f 6620 7469 6d65 7374 616d 7073  ay of timestamps
+00008fa0: 2066 6f72 2065 6163 6820 7365 676d 656e   for each segmen
+00008fb0: 7420 6f66 2063 635f 6172 7261 790a 2020  t of cc_array.  
+00008fc0: 2020 6363 5f6e 676f 6f64 3a20 3144 206e    cc_ngood: 1D n
+00008fd0: 756d 7079 2069 6e74 3136 206d 6174 7269  umpy int16 matri
+00008fe0: 7820 7368 6f77 696e 6720 7468 6520 6e75  x showing the nu
+00008ff0: 6d62 6572 206f 6620 7365 676d 656e 7473  mber of segments
+00009000: 2066 6f72 2065 6163 6820 7375 622d 7374   for each sub-st
+00009010: 6163 6b20 616e 642f 6f72 2066 756c 6c20  ack and/or full 
+00009020: 7374 6163 6b0a 2020 2020 7374 6163 6b5f  stack.    stack_
+00009030: 7061 7261 3a20 6120 6469 6374 2063 6f6e  para: a dict con
+00009040: 7461 696e 696e 6720 616c 6c20 7374 6163  taining all stac
+00009050: 6b69 6e67 2070 6172 616d 6574 6572 730a  king parameters.
+00009060: 0a20 2020 2052 4554 5552 4e53 3a0a 2020  .    RETURNS:.  
+00009070: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
+00009080: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 635f  --------.    cc_
+00009090: 6172 7261 792c 2063 635f 6e67 6f6f 642c  array, cc_ngood,
+000090a0: 2063 635f 7469 6d65 3a20 7361 6d65 2074   cc_time: same t
+000090b0: 6f20 7468 6520 696e 7075 7420 7061 7261  o the input para
+000090c0: 6d65 7465 7273 2062 7574 2077 6974 6820  meters but with 
+000090d0: 6162 6e6f 726d 616c 2063 726f 7373 2d63  abnormal cross-c
+000090e0: 6f72 7265 616c 7469 6f6e 7320 7265 6d6f  orrealtions remo
+000090f0: 7665 640a 2020 2020 616c 6c73 7461 636b  ved.    allstack
+00009100: 7331 3a20 3144 206d 6174 7269 7820 6f66  s1: 1D matrix of
+00009110: 2073 7461 636b 6564 2063 726f 7373 2d63   stacked cross-c
+00009120: 6f72 7265 6c61 7469 6f6e 2066 756e 6374  orrelation funct
+00009130: 696f 6e73 206f 7665 7220 616c 6c20 7468  ions over all th
+00009140: 6520 7365 676d 656e 7473 0a20 2020 206e  e segments.    n
+00009150: 7374 6163 6b73 3a20 2020 206e 756d 6265  stacks:    numbe
+00009160: 7220 6f66 206f 7665 7261 6c6c 2073 6567  r of overall seg
+00009170: 6d65 6e74 7320 666f 7220 7468 6520 6669  ments for the fi
+00009180: 6e61 6c20 7374 6163 6b73 0a20 2020 2022  nal stacks.    "
+00009190: 2222 0a20 2020 2023 206c 6f61 6420 7573  "".    # load us
+000091a0: 6566 756c 2070 6172 616d 6574 6572 7320  eful parameters 
+000091b0: 6672 6f6d 2064 6963 740a 2020 2020 7361  from dict.    sa
+000091c0: 6d70 5f66 7265 7120 3d20 7374 6163 6b5f  mp_freq = stack_
+000091d0: 7061 7261 5b22 7361 6d70 5f66 7265 7122  para["samp_freq"
+000091e0: 5d0a 2020 2020 736d 6574 686f 6420 3d20  ].    smethod = 
+000091f0: 7374 6163 6b5f 7061 7261 5b22 7374 6163  stack_para["stac
+00009200: 6b5f 6d65 7468 6f64 225d 0a20 2020 206e  k_method"].    n
+00009210: 7074 7320 3d20 6363 5f61 7272 6179 2e73  pts = cc_array.s
+00009220: 6861 7065 5b31 5d0a 0a20 2020 2023 2072  hape[1]..    # r
+00009230: 656d 6f76 6520 6162 6e6f 726d 616c 2064  emove abnormal d
+00009240: 6174 610a 2020 2020 616d 706d 6178 203d  ata.    ampmax =
+00009250: 206e 702e 6d61 7828 6363 5f61 7272 6179   np.max(cc_array
+00009260: 2c20 6178 6973 3d31 290a 2020 2020 7469  , axis=1).    ti
+00009270: 6e64 7820 3d20 6e70 2e77 6865 7265 2828  ndx = np.where((
+00009280: 616d 706d 6178 203c 2032 3020 2a20 6e70  ampmax < 20 * np
+00009290: 2e6d 6564 6961 6e28 616d 706d 6178 2929  .median(ampmax))
+000092a0: 2026 2028 616d 706d 6178 203e 2030 2929   & (ampmax > 0))
+000092b0: 5b30 5d0a 2020 2020 6966 206e 6f74 206c  [0].    if not l
+000092c0: 656e 2874 696e 6478 293a 0a20 2020 2020  en(tindx):.     
+000092d0: 2020 2061 6c6c 7374 6163 6b73 3120 3d20     allstacks1 = 
+000092e0: 5b5d 0a20 2020 2020 2020 2061 6c6c 7374  [].        allst
+000092f0: 6163 6b73 3220 3d20 5b5d 0a20 2020 2020  acks2 = [].     
+00009300: 2020 2061 6c6c 7374 6163 6b73 3320 3d20     allstacks3 = 
+00009310: 5b5d 0a20 2020 2020 2020 206e 7374 6163  [].        nstac
+00009320: 6b73 203d 2030 0a20 2020 2020 2020 2063  ks = 0.        c
+00009330: 635f 6172 7261 7920 3d20 5b5d 0a20 2020  c_array = [].   
+00009340: 2020 2020 2063 635f 6e67 6f6f 6420 3d20       cc_ngood = 
+00009350: 5b5d 0a20 2020 2020 2020 2063 635f 7469  [].        cc_ti
+00009360: 6d65 203d 205b 5d0a 2020 2020 2020 2020  me = [].        
+00009370: 7265 7475 726e 2063 635f 6172 7261 792c  return cc_array,
+00009380: 2063 635f 6e67 6f6f 642c 2063 635f 7469   cc_ngood, cc_ti
+00009390: 6d65 2c20 616c 6c73 7461 636b 7331 2c20  me, allstacks1, 
+000093a0: 616c 6c73 7461 636b 7332 2c20 616c 6c73  allstacks2, alls
+000093b0: 7461 636b 7333 2c20 6e73 7461 636b 730a  tacks3, nstacks.
+000093c0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000093d0: 2020 2320 7265 6d6f 7665 206f 6e65 7320    # remove ones 
+000093e0: 7769 7468 2062 6164 2061 6d70 6c69 7475  with bad amplitu
+000093f0: 6465 0a20 2020 2020 2020 2063 635f 6172  de.        cc_ar
+00009400: 7261 7920 3d20 6363 5f61 7272 6179 5b74  ray = cc_array[t
+00009410: 696e 6478 2c20 3a5d 0a20 2020 2020 2020  indx, :].       
+00009420: 2063 635f 7469 6d65 203d 2063 635f 7469   cc_time = cc_ti
+00009430: 6d65 5b74 696e 6478 5d0a 2020 2020 2020  me[tindx].      
+00009440: 2020 6363 5f6e 676f 6f64 203d 2063 635f    cc_ngood = cc_
+00009450: 6e67 6f6f 645b 7469 6e64 785d 0a0a 2020  ngood[tindx]..  
+00009460: 2020 2020 2020 2320 646f 2073 7461 636b        # do stack
+00009470: 696e 670a 2020 2020 2020 2020 616c 6c73  ing.        alls
+00009480: 7461 636b 7331 203d 206e 702e 7a65 726f  tacks1 = np.zero
+00009490: 7328 6e70 7473 2c20 6474 7970 653d 6e70  s(npts, dtype=np
+000094a0: 2e66 6c6f 6174 3332 290a 2020 2020 2020  .float32).      
+000094b0: 2020 616c 6c73 7461 636b 7332 203d 206e    allstacks2 = n
+000094c0: 702e 7a65 726f 7328 6e70 7473 2c20 6474  p.zeros(npts, dt
+000094d0: 7970 653d 6e70 2e66 6c6f 6174 3332 290a  ype=np.float32).
+000094e0: 2020 2020 2020 2020 616c 6c73 7461 636b          allstack
+000094f0: 7333 203d 206e 702e 7a65 726f 7328 6e70  s3 = np.zeros(np
+00009500: 7473 2c20 6474 7970 653d 6e70 2e66 6c6f  ts, dtype=np.flo
+00009510: 6174 3332 290a 0a20 2020 2020 2020 2069  at32)..        i
+00009520: 6620 736d 6574 686f 6420 3d3d 2022 6c69  f smethod == "li
+00009530: 6e65 6172 223a 0a20 2020 2020 2020 2020  near":.         
+00009540: 2020 2061 6c6c 7374 6163 6b73 3120 3d20     allstacks1 = 
+00009550: 6e70 2e6d 6561 6e28 6363 5f61 7272 6179  np.mean(cc_array
+00009560: 2c20 6178 6973 3d30 290a 2020 2020 2020  , axis=0).      
+00009570: 2020 656c 6966 2073 6d65 7468 6f64 203d    elif smethod =
+00009580: 3d20 2270 7773 223a 0a20 2020 2020 2020  = "pws":.       
+00009590: 2020 2020 2061 6c6c 7374 6163 6b73 3120       allstacks1 
+000095a0: 3d20 7077 7328 6363 5f61 7272 6179 2c20  = pws(cc_array, 
+000095b0: 7361 6d70 5f66 7265 7129 0a20 2020 2020  samp_freq).     
+000095c0: 2020 2065 6c69 6620 736d 6574 686f 6420     elif smethod 
+000095d0: 3d3d 2022 726f 6275 7374 223a 0a20 2020  == "robust":.   
+000095e0: 2020 2020 2020 2020 2061 6c6c 7374 6163           allstac
+000095f0: 6b73 312c 2077 2c20 6e73 7465 7020 3d20  ks1, w, nstep = 
+00009600: 726f 6275 7374 5f73 7461 636b 2863 635f  robust_stack(cc_
+00009610: 6172 7261 792c 2030 2e30 3031 290a 2020  array, 0.001).  
+00009620: 2020 2020 2020 656c 6966 2073 6d65 7468        elif smeth
+00009630: 6f64 203d 3d20 2261 7574 6f5f 636f 7661  od == "auto_cova
+00009640: 7269 616e 6365 223a 0a20 2020 2020 2020  riance":.       
+00009650: 2020 2020 2061 6c6c 7374 6163 6b73 3120       allstacks1 
+00009660: 3d20 6164 6170 7469 7665 5f66 696c 7465  = adaptive_filte
+00009670: 7228 6363 5f61 7272 6179 2c20 3129 0a20  r(cc_array, 1). 
+00009680: 2020 2020 2020 2065 6c69 6620 736d 6574         elif smet
+00009690: 686f 6420 3d3d 2022 6e72 6f6f 7422 3a0a  hod == "nroot":.
+000096a0: 2020 2020 2020 2020 2020 2020 616c 6c73              alls
+000096b0: 7461 636b 7331 203d 206e 726f 6f74 5f73  tacks1 = nroot_s
+000096c0: 7461 636b 2863 635f 6172 7261 792c 2032  tack(cc_array, 2
+000096d0: 290a 2020 2020 2020 2020 656c 6966 2073  ).        elif s
+000096e0: 6d65 7468 6f64 203d 3d20 2261 6c6c 223a  method == "all":
+000096f0: 0a20 2020 2020 2020 2020 2020 2061 6c6c  .            all
+00009700: 7374 6163 6b73 3120 3d20 6e70 2e6d 6561  stacks1 = np.mea
+00009710: 6e28 6363 5f61 7272 6179 2c20 6178 6973  n(cc_array, axis
+00009720: 3d30 290a 2020 2020 2020 2020 2020 2020  =0).            
+00009730: 616c 6c73 7461 636b 7332 203d 2070 7773  allstacks2 = pws
+00009740: 2863 635f 6172 7261 792c 2073 616d 705f  (cc_array, samp_
+00009750: 6672 6571 290a 2020 2020 2020 2020 2020  freq).          
+00009760: 2020 616c 6c73 7461 636b 7333 2c20 772c    allstacks3, w,
+00009770: 206e 7374 6570 203d 2072 6f62 7573 745f   nstep = robust_
+00009780: 7374 6163 6b28 6363 5f61 7272 6179 2c20  stack(cc_array, 
+00009790: 302e 3030 3129 0a20 2020 2020 2020 206e  0.001).        n
+000097a0: 7374 6163 6b73 203d 206e 702e 7375 6d28  stacks = np.sum(
+000097b0: 6363 5f6e 676f 6f64 290a 0a20 2020 2023  cc_ngood)..    #
+000097c0: 2067 6f6f 6420 746f 2072 6574 7572 6e0a   good to return.
+000097d0: 2020 2020 7265 7475 726e 2063 635f 6172      return cc_ar
+000097e0: 7261 792c 2063 635f 6e67 6f6f 642c 2063  ray, cc_ngood, c
+000097f0: 635f 7469 6d65 2c20 616c 6c73 7461 636b  c_time, allstack
+00009800: 7331 2c20 616c 6c73 7461 636b 7332 2c20  s1, allstacks2, 
+00009810: 616c 6c73 7461 636b 7333 2c20 6e73 7461  allstacks3, nsta
+00009820: 636b 730a 0a0a 6465 6620 7374 6163 6b69  cks...def stacki
+00009830: 6e67 5f72 6d61 2863 635f 6172 7261 792c  ng_rma(cc_array,
+00009840: 2063 635f 7469 6d65 2c20 6363 5f6e 676f   cc_time, cc_ngo
+00009850: 6f64 2c20 7374 6163 6b5f 7061 7261 293a  od, stack_para):
+00009860: 0a20 2020 2022 2222 0a20 2020 2074 6869  .    """.    thi
+00009870: 7320 6675 6e63 7469 6f6e 2073 7461 636b  s function stack
+00009880: 7320 7468 6520 6372 6f73 7320 636f 7272  s the cross corr
+00009890: 656c 6174 696f 6e20 6461 7461 2061 6363  elation data acc
+000098a0: 6f72 6469 6e67 2074 6f20 7468 6520 7573  ording to the us
+000098b0: 6572 2d64 6566 696e 6564 2073 7562 7374  er-defined subst
+000098c0: 6163 6b5f 6c65 6e20 7061 7261 6d65 7465  ack_len paramete
+000098d0: 720a 2020 2020 5041 5241 4d45 5445 5253  r.    PARAMETERS
+000098e0: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
+000098f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
+00009900: 2063 635f 6172 7261 793a 2032 4420 6e75   cc_array: 2D nu
+00009910: 6d70 7920 666c 6f61 7433 3220 6d61 7472  mpy float32 matr
+00009920: 6978 2063 6f6e 7461 696e 696e 6720 616c  ix containing al
+00009930: 6c20 7365 676d 656e 7465 6420 6372 6f73  l segmented cros
+00009940: 732d 636f 7272 656c 6174 696f 6e20 6461  s-correlation da
+00009950: 7461 0a20 2020 2063 635f 7469 6d65 3a20  ta.    cc_time: 
+00009960: 2031 4420 6e75 6d70 7920 6172 7261 7920   1D numpy array 
+00009970: 6f66 2074 696d 6573 7461 6d70 7320 666f  of timestamps fo
+00009980: 7220 6561 6368 2073 6567 6d65 6e74 206f  r each segment o
+00009990: 6620 6363 5f61 7272 6179 0a20 2020 2063  f cc_array.    c
+000099a0: 635f 6e67 6f6f 643a 2031 4420 6e75 6d70  c_ngood: 1D nump
+000099b0: 7920 696e 7431 3620 6d61 7472 6978 2073  y int16 matrix s
+000099c0: 686f 7769 6e67 2074 6865 206e 756d 6265  howing the numbe
+000099d0: 7220 6f66 2073 6567 6d65 6e74 7320 666f  r of segments fo
+000099e0: 7220 6561 6368 2073 7562 2d73 7461 636b  r each sub-stack
+000099f0: 2061 6e64 2f6f 7220 6675 6c6c 2073 7461   and/or full sta
+00009a00: 636b 0a20 2020 2073 7461 636b 5f70 6172  ck.    stack_par
+00009a10: 613a 2061 2064 6963 7420 636f 6e74 6169  a: a dict contai
+00009a20: 6e69 6e67 2061 6c6c 2073 7461 636b 696e  ning all stackin
+00009a30: 6720 7061 7261 6d65 7465 7273 0a20 2020  g parameters.   
+00009a40: 2052 4554 5552 4e53 3a0a 2020 2020 2d2d   RETURNS:.    --
+00009a50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009a60: 2d2d 2d2d 0a20 2020 2063 635f 6172 7261  ----.    cc_arra
+00009a70: 792c 2063 635f 6e67 6f6f 642c 2063 635f  y, cc_ngood, cc_
+00009a80: 7469 6d65 3a20 7361 6d65 2074 6f20 7468  time: same to th
+00009a90: 6520 696e 7075 7420 7061 7261 6d65 7465  e input paramete
+00009aa0: 7273 2062 7574 2077 6974 6820 6162 6e6f  rs but with abno
+00009ab0: 726d 616c 2063 726f 7373 2d63 6f72 7265  rmal cross-corre
+00009ac0: 616c 7469 6f6e 7320 7265 6d6f 7665 640a  altions removed.
+00009ad0: 2020 2020 616c 6c73 7461 636b 7331 3a20      allstacks1: 
+00009ae0: 3144 206d 6174 7269 7820 6f66 2073 7461  1D matrix of sta
+00009af0: 636b 6564 2063 726f 7373 2d63 6f72 7265  cked cross-corre
+00009b00: 6c61 7469 6f6e 2066 756e 6374 696f 6e73  lation functions
+00009b10: 206f 7665 7220 616c 6c20 7468 6520 7365   over all the se
+00009b20: 676d 656e 7473 0a20 2020 206e 7374 6163  gments.    nstac
+00009b30: 6b73 3a20 2020 206e 756d 6265 7220 6f66  ks:    number of
+00009b40: 206f 7665 7261 6c6c 2073 6567 6d65 6e74   overall segment
+00009b50: 7320 666f 7220 7468 6520 6669 6e61 6c20  s for the final 
+00009b60: 7374 6163 6b73 0a20 2020 2022 2222 0a20  stacks.    """. 
+00009b70: 2020 2023 206c 6f61 6420 7573 6566 756c     # load useful
+00009b80: 2070 6172 616d 6574 6572 7320 6672 6f6d   parameters from
+00009b90: 2064 6963 740a 2020 2020 7361 6d70 5f66   dict.    samp_f
+00009ba0: 7265 7120 3d20 7374 6163 6b5f 7061 7261  req = stack_para
+00009bb0: 5b22 7361 6d70 5f66 7265 7122 5d0a 2020  ["samp_freq"].  
+00009bc0: 2020 736d 6574 686f 6420 3d20 7374 6163    smethod = stac
+00009bd0: 6b5f 7061 7261 5b22 7374 6163 6b5f 6d65  k_para["stack_me
+00009be0: 7468 6f64 225d 0a20 2020 2072 6d61 5f73  thod"].    rma_s
+00009bf0: 7562 7374 6163 6b20 3d20 7374 6163 6b5f  ubstack = stack_
+00009c00: 7061 7261 5b22 726d 615f 7375 6273 7461  para["rma_substa
+00009c10: 636b 225d 0a20 2020 2072 6d61 5f73 7465  ck"].    rma_ste
+00009c20: 7020 3d20 7374 6163 6b5f 7061 7261 5b22  p = stack_para["
+00009c30: 726d 615f 7374 6570 225d 0a20 2020 2073  rma_step"].    s
+00009c40: 7461 7274 5f64 6174 6520 3d20 7374 6163  tart_date = stac
+00009c50: 6b5f 7061 7261 5b22 7374 6172 745f 6461  k_para["start_da
+00009c60: 7465 225d 0a20 2020 2065 6e64 5f64 6174  te"].    end_dat
+00009c70: 6520 3d20 7374 6163 6b5f 7061 7261 5b22  e = stack_para["
+00009c80: 656e 645f 6461 7465 225d 0a20 2020 206e  end_date"].    n
+00009c90: 7074 7320 3d20 6363 5f61 7272 6179 2e73  pts = cc_array.s
+00009ca0: 6861 7065 5b31 5d0a 0a20 2020 2023 2072  hape[1]..    # r
+00009cb0: 656d 6f76 6520 6162 6e6f 726d 616c 2064  emove abnormal d
+00009cc0: 6174 610a 2020 2020 616d 706d 6178 203d  ata.    ampmax =
+00009cd0: 206e 702e 6d61 7828 6363 5f61 7272 6179   np.max(cc_array
+00009ce0: 2c20 6178 6973 3d31 290a 2020 2020 7469  , axis=1).    ti
+00009cf0: 6e64 7820 3d20 6e70 2e77 6865 7265 2828  ndx = np.where((
+00009d00: 616d 706d 6178 203c 2032 3020 2a20 6e70  ampmax < 20 * np
+00009d10: 2e6d 6564 6961 6e28 616d 706d 6178 2929  .median(ampmax))
+00009d20: 2026 2028 616d 706d 6178 203e 2030 2929   & (ampmax > 0))
+00009d30: 5b30 5d0a 2020 2020 6966 206e 6f74 206c  [0].    if not l
+00009d40: 656e 2874 696e 6478 293a 0a20 2020 2020  en(tindx):.     
+00009d50: 2020 2061 6c6c 7374 6163 6b73 3120 3d20     allstacks1 = 
+00009d60: 5b5d 0a20 2020 2020 2020 2061 6c6c 7374  [].        allst
+00009d70: 6163 6b73 3220 3d20 5b5d 0a20 2020 2020  acks2 = [].     
+00009d80: 2020 206e 7374 6163 6b73 203d 2030 0a20     nstacks = 0. 
+00009d90: 2020 2020 2020 2063 635f 6172 7261 7920         cc_array 
+00009da0: 3d20 5b5d 0a20 2020 2020 2020 2063 635f  = [].        cc_
+00009db0: 6e67 6f6f 6420 3d20 5b5d 0a20 2020 2020  ngood = [].     
+00009dc0: 2020 2063 635f 7469 6d65 203d 205b 5d0a     cc_time = [].
+00009dd0: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+00009de0: 635f 6172 7261 792c 2063 635f 6e67 6f6f  c_array, cc_ngoo
+00009df0: 642c 2063 635f 7469 6d65 2c20 616c 6c73  d, cc_time, alls
+00009e00: 7461 636b 7331 2c20 616c 6c73 7461 636b  tacks1, allstack
+00009e10: 7332 2c20 6e73 7461 636b 730a 2020 2020  s2, nstacks.    
+00009e20: 656c 7365 3a0a 2020 2020 2020 2020 2320  else:.        # 
+00009e30: 7265 6d6f 7665 206f 6e65 7320 7769 7468  remove ones with
+00009e40: 2062 6164 2061 6d70 6c69 7475 6465 0a20   bad amplitude. 
+00009e50: 2020 2020 2020 2063 635f 6172 7261 7920         cc_array 
+00009e60: 3d20 6363 5f61 7272 6179 5b74 696e 6478  = cc_array[tindx
+00009e70: 2c20 3a5d 0a20 2020 2020 2020 2063 635f  , :].        cc_
+00009e80: 7469 6d65 203d 2063 635f 7469 6d65 5b74  time = cc_time[t
+00009e90: 696e 6478 5d0a 2020 2020 2020 2020 6363  indx].        cc
+00009ea0: 5f6e 676f 6f64 203d 2063 635f 6e67 6f6f  _ngood = cc_ngoo
+00009eb0: 645b 7469 6e64 785d 0a0a 2020 2020 2020  d[tindx]..      
+00009ec0: 2020 2320 646f 2073 7562 7374 6163 6b73    # do substacks
+00009ed0: 0a20 2020 2020 2020 2069 6620 726d 615f  .        if rma_
+00009ee0: 7375 6273 7461 636b 3a0a 2020 2020 2020  substack:.      
+00009ef0: 2020 2020 2020 7473 7461 7274 203d 206f        tstart = o
+00009f00: 6273 7079 2e55 5443 4461 7465 5469 6d65  bspy.UTCDateTime
+00009f10: 2873 7461 7274 5f64 6174 6529 202d 206f  (start_date) - o
+00009f20: 6273 7079 2e55 5443 4461 7465 5469 6d65  bspy.UTCDateTime
+00009f30: 2831 3937 302c 2031 2c20 3129 0a20 2020  (1970, 1, 1).   
+00009f40: 2020 2020 2020 2020 2074 656e 6420 3d20           tend = 
+00009f50: 6f62 7370 792e 5554 4344 6174 6554 696d  obspy.UTCDateTim
+00009f60: 6528 656e 645f 6461 7465 2920 2d20 6f62  e(end_date) - ob
+00009f70: 7370 792e 5554 4344 6174 6554 696d 6528  spy.UTCDateTime(
+00009f80: 3139 3730 2c20 312c 2031 290a 2020 2020  1970, 1, 1).    
+00009f90: 2020 2020 2020 2020 7474 696d 6520 3d20          ttime = 
+00009fa0: 7473 7461 7274 0a20 2020 2020 2020 2020  tstart.         
+00009fb0: 2020 206e 7374 6163 6b20 3d20 696e 7428     nstack = int(
+00009fc0: 6e70 2e72 6f75 6e64 2828 7465 6e64 202d  np.round((tend -
+00009fd0: 2074 7374 6172 7429 202f 2028 726d 615f   tstart) / (rma_
+00009fe0: 7374 6570 202a 2033 3630 3029 2929 0a20  step * 3600))). 
+00009ff0: 2020 2020 2020 2020 2020 206e 6363 5f61             ncc_a
+0000a000: 7272 6179 203d 206e 702e 7a65 726f 7328  rray = np.zeros(
+0000a010: 7368 6170 653d 286e 7374 6163 6b2c 206e  shape=(nstack, n
+0000a020: 7074 7329 2c20 6474 7970 653d 6e70 2e66  pts), dtype=np.f
+0000a030: 6c6f 6174 3332 290a 2020 2020 2020 2020  loat32).        
+0000a040: 2020 2020 6e63 635f 7469 6d65 203d 206e      ncc_time = n
+0000a050: 702e 7a65 726f 7328 6e73 7461 636b 2c20  p.zeros(nstack, 
+0000a060: 6474 7970 653d 6e70 2e66 6c6f 6174 290a  dtype=np.float).
+0000a070: 2020 2020 2020 2020 2020 2020 6e63 635f              ncc_
+0000a080: 6e67 6f6f 6420 3d20 6e70 2e7a 6572 6f73  ngood = np.zeros
+0000a090: 286e 7374 6163 6b2c 2064 7479 7065 3d6e  (nstack, dtype=n
+0000a0a0: 702e 696e 7429 0a0a 2020 2020 2020 2020  p.int)..        
+0000a0b0: 2020 2020 2320 6c6f 6f70 2074 6872 6f75      # loop throu
+0000a0c0: 6768 2065 6163 6820 7469 6d65 0a20 2020  gh each time.   
+0000a0d0: 2020 2020 2020 2020 2066 6f72 2069 6920           for ii 
+0000a0e0: 696e 2072 616e 6765 286e 7374 6163 6b29  in range(nstack)
+0000a0f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a100: 2020 7369 6e64 7820 3d20 6e70 2e77 6865    sindx = np.whe
+0000a110: 7265 2828 6363 5f74 696d 6520 3e3d 2074  re((cc_time >= t
+0000a120: 7469 6d65 2920 2620 2863 635f 7469 6d65  time) & (cc_time
+0000a130: 203c 2074 7469 6d65 202b 2072 6d61 5f73   < ttime + rma_s
+0000a140: 7562 7374 6163 6b20 2a20 3336 3030 2929  ubstack * 3600))
+0000a150: 5b30 5d0a 0a20 2020 2020 2020 2020 2020  [0]..           
+0000a160: 2020 2020 2023 2077 6865 6e20 7468 6572       # when ther
+0000a170: 6520 6172 6520 6461 7461 2069 6e20 7468  e are data in th
+0000a180: 6520 7469 6d65 2077 696e 646f 770a 2020  e time window.  
+0000a190: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000a1a0: 206c 656e 2873 696e 6478 293a 0a20 2020   len(sindx):.   
+0000a1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a1c0: 206e 6363 5f61 7272 6179 5b69 695d 203d   ncc_array[ii] =
+0000a1d0: 206e 702e 6d65 616e 2863 635f 6172 7261   np.mean(cc_arra
+0000a1e0: 795b 7369 6e64 785d 2c20 6178 6973 3d30  y[sindx], axis=0
+0000a1f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000a200: 2020 2020 2020 6e63 635f 7469 6d65 5b69        ncc_time[i
+0000a210: 695d 203d 2074 7469 6d65 0a20 2020 2020  i] = ttime.     
+0000a220: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0000a230: 6363 5f6e 676f 6f64 5b69 695d 203d 206e  cc_ngood[ii] = n
+0000a240: 702e 7375 6d28 6363 5f6e 676f 6f64 5b73  p.sum(cc_ngood[s
+0000a250: 696e 6478 5d2c 2061 7869 733d 3029 0a20  indx], axis=0). 
+0000a260: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000a270: 7469 6d65 202b 3d20 726d 615f 7374 6570  time += rma_step
+0000a280: 202a 2033 3630 300a 0a20 2020 2020 2020   * 3600..       
+0000a290: 2020 2020 2023 2072 656d 6f76 6520 6261       # remove ba
+0000a2a0: 6420 6f6e 6573 0a20 2020 2020 2020 2020  d ones.         
+0000a2b0: 2020 2074 696e 6478 203d 206e 702e 7768     tindx = np.wh
+0000a2c0: 6572 6528 6e63 635f 6e67 6f6f 6420 3e20  ere(ncc_ngood > 
+0000a2d0: 3029 5b30 5d0a 2020 2020 2020 2020 2020  0)[0].          
+0000a2e0: 2020 6e63 635f 6172 7261 7920 3d20 6e63    ncc_array = nc
+0000a2f0: 635f 6172 7261 795b 7469 6e64 785d 0a20  c_array[tindx]. 
+0000a300: 2020 2020 2020 2020 2020 206e 6363 5f74             ncc_t
+0000a310: 696d 6520 3d20 6e63 635f 7469 6d65 5b74  ime = ncc_time[t
+0000a320: 696e 6478 5d0a 2020 2020 2020 2020 2020  indx].          
+0000a330: 2020 6e63 635f 6e67 6f6f 6420 3d20 6e63    ncc_ngood = nc
+0000a340: 635f 6e67 6f6f 645b 7469 6e64 785d 0a0a  c_ngood[tindx]..
+0000a350: 2020 2020 2020 2020 2320 646f 2073 7461          # do sta
+0000a360: 636b 696e 670a 2020 2020 2020 2020 616c  cking.        al
+0000a370: 6c73 7461 636b 7331 203d 206e 702e 7a65  lstacks1 = np.ze
+0000a380: 726f 7328 6e70 7473 2c20 6474 7970 653d  ros(npts, dtype=
+0000a390: 6e70 2e66 6c6f 6174 3332 290a 2020 2020  np.float32).    
+0000a3a0: 2020 2020 616c 6c73 7461 636b 7332 203d      allstacks2 =
+0000a3b0: 206e 702e 7a65 726f 7328 6e70 7473 2c20   np.zeros(npts, 
+0000a3c0: 6474 7970 653d 6e70 2e66 6c6f 6174 3332  dtype=np.float32
+0000a3d0: 290a 2020 2020 2020 2020 616c 6c73 7461  ).        allsta
+0000a3e0: 636b 7333 203d 206e 702e 7a65 726f 7328  cks3 = np.zeros(
+0000a3f0: 6e70 7473 2c20 6474 7970 653d 6e70 2e66  npts, dtype=np.f
+0000a400: 6c6f 6174 3332 290a 2020 2020 2020 2020  loat32).        
+0000a410: 616c 6c73 7461 636b 7334 203d 206e 702e  allstacks4 = np.
+0000a420: 7a65 726f 7328 6e70 7473 2c20 6474 7970  zeros(npts, dtyp
+0000a430: 653d 6e70 2e66 6c6f 6174 3332 290a 0a20  e=np.float32).. 
+0000a440: 2020 2020 2020 2069 6620 736d 6574 686f         if smetho
+0000a450: 6420 3d3d 2022 6c69 6e65 6172 223a 0a20  d == "linear":. 
+0000a460: 2020 2020 2020 2020 2020 2061 6c6c 7374             allst
+0000a470: 6163 6b73 3120 3d20 6e70 2e6d 6561 6e28  acks1 = np.mean(
+0000a480: 6363 5f61 7272 6179 2c20 6178 6973 3d30  cc_array, axis=0
+0000a490: 290a 2020 2020 2020 2020 656c 6966 2073  ).        elif s
+0000a4a0: 6d65 7468 6f64 203d 3d20 2270 7773 223a  method == "pws":
+0000a4b0: 0a20 2020 2020 2020 2020 2020 2061 6c6c  .            all
+0000a4c0: 7374 6163 6b73 3120 3d20 7077 7328 6363  stacks1 = pws(cc
+0000a4d0: 5f61 7272 6179 2c20 7361 6d70 5f66 7265  _array, samp_fre
+0000a4e0: 7129 0a20 2020 2020 2020 2065 6c69 6620  q).        elif 
+0000a4f0: 736d 6574 686f 6420 3d3d 2022 726f 6275  smethod == "robu
+0000a500: 7374 223a 0a20 2020 2020 2020 2020 2020  st":.           
+0000a510: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+0000a520: 2020 2061 6c6c 7374 6163 6b73 312c 0a20     allstacks1,. 
+0000a530: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0000a540: 2c0a 2020 2020 2020 2020 2020 2020 2920  ,.            ) 
+0000a550: 3d20 726f 6275 7374 5f73 7461 636b 2863  = robust_stack(c
+0000a560: 635f 6172 7261 792c 2030 2e30 3031 290a  c_array, 0.001).
+0000a570: 2020 2020 2020 2020 656c 6966 2073 6d65          elif sme
+0000a580: 7468 6f64 203d 3d20 2273 656c 6563 7469  thod == "selecti
+0000a590: 7665 223a 0a20 2020 2020 2020 2020 2020  ve":.           
+0000a5a0: 2061 6c6c 7374 6163 6b73 3120 3d20 7365   allstacks1 = se
+0000a5b0: 6c65 6374 6976 655f 7374 6163 6b28 6363  lective_stack(cc
+0000a5c0: 5f61 7272 6179 2c20 302e 3030 3129 0a20  _array, 0.001). 
+0000a5d0: 2020 2020 2020 2065 6c69 6620 736d 6574         elif smet
+0000a5e0: 686f 6420 3d3d 2022 616c 6c22 3a0a 2020  hod == "all":.  
+0000a5f0: 2020 2020 2020 2020 2020 616c 6c73 7461            allsta
+0000a600: 636b 7331 203d 206e 702e 6d65 616e 2863  cks1 = np.mean(c
+0000a610: 635f 6172 7261 792c 2061 7869 733d 3029  c_array, axis=0)
+0000a620: 0a20 2020 2020 2020 2020 2020 2061 6c6c  .            all
+0000a630: 7374 6163 6b73 3220 3d20 7077 7328 6363  stacks2 = pws(cc
+0000a640: 5f61 7272 6179 2c20 7361 6d70 5f66 7265  _array, samp_fre
+0000a650: 7129 0a20 2020 2020 2020 2020 2020 2061  q).            a
+0000a660: 6c6c 7374 6163 6b73 3320 3d20 726f 6275  llstacks3 = robu
+0000a670: 7374 5f73 7461 636b 2863 635f 6172 7261  st_stack(cc_arra
+0000a680: 792c 2030 2e30 3031 290a 2020 2020 2020  y, 0.001).      
+0000a690: 2020 2020 2020 616c 6c73 7461 636b 7334        allstacks4
+0000a6a0: 203d 2073 656c 6563 7469 7665 5f73 7461   = selective_sta
+0000a6b0: 636b 2863 635f 6172 7261 792c 2030 2e30  ck(cc_array, 0.0
+0000a6c0: 3031 290a 2020 2020 2020 2020 6e73 7461  01).        nsta
+0000a6d0: 636b 7320 3d20 6e70 2e73 756d 2863 635f  cks = np.sum(cc_
+0000a6e0: 6e67 6f6f 6429 0a0a 2020 2020 2320 7265  ngood)..    # re
+0000a6f0: 706c 6163 6520 7468 6520 6172 7261 7920  place the array 
+0000a700: 666f 7220 7375 6273 7461 636b 730a 2020  for substacks.  
+0000a710: 2020 6966 2072 6d61 5f73 7562 7374 6163    if rma_substac
+0000a720: 6b3a 0a20 2020 2020 2020 2063 635f 6172  k:.        cc_ar
+0000a730: 7261 7920 3d20 6e63 635f 6172 7261 790a  ray = ncc_array.
+0000a740: 2020 2020 2020 2020 6363 5f74 696d 6520          cc_time 
+0000a750: 3d20 6e63 635f 7469 6d65 0a20 2020 2020  = ncc_time.     
+0000a760: 2020 2063 635f 6e67 6f6f 6420 3d20 6e63     cc_ngood = nc
+0000a770: 635f 6e67 6f6f 640a 0a20 2020 2023 2067  c_ngood..    # g
+0000a780: 6f6f 6420 746f 2072 6574 7572 6e0a 2020  ood to return.  
+0000a790: 2020 7265 7475 726e 2028 0a20 2020 2020    return (.     
+0000a7a0: 2020 2063 635f 6172 7261 792c 0a20 2020     cc_array,.   
+0000a7b0: 2020 2020 2063 635f 6e67 6f6f 642c 0a20       cc_ngood,. 
+0000a7c0: 2020 2020 2020 2063 635f 7469 6d65 2c0a         cc_time,.
+0000a7d0: 2020 2020 2020 2020 616c 6c73 7461 636b          allstack
+0000a7e0: 7331 2c0a 2020 2020 2020 2020 616c 6c73  s1,.        alls
+0000a7f0: 7461 636b 7332 2c0a 2020 2020 2020 2020  tacks2,.        
+0000a800: 616c 6c73 7461 636b 7333 2c0a 2020 2020  allstacks3,.    
+0000a810: 2020 2020 616c 6c73 7461 636b 7334 2c0a      allstacks4,.
+0000a820: 2020 2020 2020 2020 6e73 7461 636b 732c          nstacks,
+0000a830: 0a20 2020 2029 0a0a 0a64 6566 2072 6f74  .    )...def rot
+0000a840: 6174 696f 6e28 6269 6773 7461 636b 2c20  ation(bigstack, 
+0000a850: 7061 7261 6d65 7465 7273 2c20 6c6f 6373  parameters, locs
+0000a860: 293a 0a20 2020 2022 2222 0a20 2020 2074  ):.    """.    t
+0000a870: 6869 7320 6675 6e63 7469 6f6e 2074 7261  his function tra
+0000a880: 6e73 6665 7273 2074 6865 2047 7265 656e  nsfers the Green
+0000a890: 2773 2074 656e 736f 7220 6672 6f6d 2061  's tensor from a
+0000a8a0: 2045 2d4e 2d5a 2073 7973 7465 6d20 696e   E-N-Z system in
+0000a8b0: 746f 2061 2052 2d54 2d5a 206f 6e65 0a0a  to a R-T-Z one..
+0000a8c0: 2020 2020 5041 5241 4d45 5445 5253 3a0a      PARAMETERS:.
+0000a8d0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
+0000a8e0: 2d2d 2d2d 2d2d 2d0a 2020 2020 6269 6773  -------.    bigs
+0000a8f0: 7461 636b 3a20 2020 3920 636f 6d70 6f6e  tack:   9 compon
+0000a900: 656e 7420 4772 6565 6e27 7320 7465 6e73  ent Green's tens
+0000a910: 6f72 2069 6e20 452d 4e2d 5a20 7379 7374  or in E-N-Z syst
+0000a920: 656d 0a20 2020 2070 6172 616d 6574 6572  em.    parameter
+0000a930: 733a 2064 6963 7420 636f 6e74 6169 6e69  s: dict containi
+0000a940: 6e67 2061 6c6c 2070 6172 616d 6574 6572  ng all parameter
+0000a950: 7320 7361 7665 6420 696e 2041 5344 4620  s saved in ASDF 
+0000a960: 6669 6c65 0a20 2020 206c 6f63 733a 2020  file.    locs:  
+0000a970: 2020 2020 2064 6963 7420 636f 6e74 6169       dict contai
+0000a980: 6e69 6e67 2073 7461 7469 6f6e 2061 6e67  ning station ang
+0000a990: 6c65 2069 6e66 6f20 666f 7220 636f 7272  le info for corr
+0000a9a0: 6563 7469 6f6e 2070 7572 706f 7365 0a20  ection purpose. 
+0000a9b0: 2020 2052 4554 5552 4e53 3a0a 2020 2020     RETURNS:.    
+0000a9c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000a9d0: 2d2d 2d0a 2020 2020 7463 6f72 723a 2039  ---.    tcorr: 9
+0000a9e0: 2063 6f6d 706f 6e65 6e74 2047 7265 656e   component Green
+0000a9f0: 2773 2074 656e 736f 7220 696e 2052 2d54  's tensor in R-T
+0000aa00: 2d5a 2073 7973 7465 6d0a 2020 2020 2222  -Z system.    ""
+0000aa10: 220a 2020 2020 2320 6c6f 6164 2070 6172  ".    # load par
+0000aa20: 616d 6574 6572 2064 6963 0a20 2020 2070  ameter dic.    p
+0000aa30: 6920 3d20 6e70 2e70 690a 2020 2020 617a  i = np.pi.    az
+0000aa40: 6920 3d20 7061 7261 6d65 7465 7273 5b22  i = parameters["
+0000aa50: 617a 6922 5d0a 2020 2020 6261 7a20 3d20  azi"].    baz = 
+0000aa60: 7061 7261 6d65 7465 7273 5b22 6261 7a22  parameters["baz"
+0000aa70: 5d0a 2020 2020 6e63 6f6d 702c 206e 7074  ].    ncomp, npt
+0000aa80: 7320 3d20 6269 6773 7461 636b 2e73 6861  s = bigstack.sha
+0000aa90: 7065 0a20 2020 2069 6620 6e63 6f6d 7020  pe.    if ncomp 
+0000aaa0: 3c20 393a 0a20 2020 2020 2020 2070 7269  < 9:.        pri
+0000aab0: 6e74 2822 6372 6170 2064 6964 206e 6f74  nt("crap did not
+0000aac0: 2067 6574 2065 6e6f 7567 6820 636f 6d70   get enough comp
+0000aad0: 6f6e 656e 7473 2229 0a20 2020 2020 2020  onents").       
+0000aae0: 2074 636f 7272 203d 205b 5d0a 2020 2020   tcorr = [].    
+0000aaf0: 2020 2020 7265 7475 726e 2074 636f 7272      return tcorr
+0000ab00: 0a20 2020 2073 7461 5320 3d20 7061 7261  .    staS = para
+0000ab10: 6d65 7465 7273 5b22 7374 6174 696f 6e5f  meters["station_
+0000ab20: 736f 7572 6365 225d 0a20 2020 2073 7461  source"].    sta
+0000ab30: 5220 3d20 7061 7261 6d65 7465 7273 5b22  R = parameters["
+0000ab40: 7374 6174 696f 6e5f 7265 6365 6976 6572  station_receiver
+0000ab50: 225d 0a0a 2020 2020 6966 206c 656e 286c  "]..    if len(l
+0000ab60: 6f63 7329 3a0a 2020 2020 2020 2020 7374  ocs):.        st
+0000ab70: 615f 6c69 7374 203d 206c 6973 7428 6c6f  a_list = list(lo
+0000ab80: 6373 5b22 7374 6174 696f 6e22 5d29 0a20  cs["station"]). 
+0000ab90: 2020 2020 2020 2061 6e67 6c65 7320 3d20         angles = 
+0000aba0: 6c69 7374 286c 6f63 735b 2261 6e67 6c65  list(locs["angle
+0000abb0: 225d 290a 2020 2020 2020 2020 2320 6765  "]).        # ge
+0000abc0: 7420 7374 6174 696f 6e20 696e 666f 2066  t station info f
+0000abd0: 726f 6d20 7468 6520 6e61 6d65 206f 6620  rom the name of 
+0000abe0: 4153 4446 2066 696c 650a 2020 2020 2020  ASDF file.      
+0000abf0: 2020 696e 6420 3d20 7374 615f 6c69 7374    ind = sta_list
+0000ac00: 2e69 6e64 6578 2873 7461 5329 0a20 2020  .index(staS).   
+0000ac10: 2020 2020 2061 636f 7272 203d 2061 6e67       acorr = ang
+0000ac20: 6c65 735b 696e 645d 0a20 2020 2020 2020  les[ind].       
+0000ac30: 2069 6e64 203d 2073 7461 5f6c 6973 742e   ind = sta_list.
+0000ac40: 696e 6465 7828 7374 6152 290a 2020 2020  index(staR).    
+0000ac50: 2020 2020 6263 6f72 7220 3d20 616e 676c      bcorr = angl
+0000ac60: 6573 5b69 6e64 5d0a 0a20 2020 2023 202d  es[ind]..    # -
+0000ac70: 2d2d 616e 676c 6573 2074 6f20 6265 2063  --angles to be c
+0000ac80: 6f72 7265 6374 6564 2d2d 2d2d 0a20 2020  orrected----.   
+0000ac90: 2069 6620 6c65 6e28 6c6f 6373 293a 0a20   if len(locs):. 
+0000aca0: 2020 2020 2020 2063 6f73 6120 3d20 6e70         cosa = np
+0000acb0: 2e63 6f73 2828 617a 6920 2b20 6163 6f72  .cos((azi + acor
+0000acc0: 7229 202a 2070 6920 2f20 3138 3029 0a20  r) * pi / 180). 
+0000acd0: 2020 2020 2020 2073 696e 6120 3d20 6e70         sina = np
+0000ace0: 2e73 696e 2828 617a 6920 2b20 6163 6f72  .sin((azi + acor
+0000acf0: 7229 202a 2070 6920 2f20 3138 3029 0a20  r) * pi / 180). 
+0000ad00: 2020 2020 2020 2063 6f73 6220 3d20 6e70         cosb = np
+0000ad10: 2e63 6f73 2828 6261 7a20 2b20 6263 6f72  .cos((baz + bcor
+0000ad20: 7229 202a 2070 6920 2f20 3138 3029 0a20  r) * pi / 180). 
+0000ad30: 2020 2020 2020 2073 696e 6220 3d20 6e70         sinb = np
+0000ad40: 2e73 696e 2828 6261 7a20 2b20 6263 6f72  .sin((baz + bcor
+0000ad50: 7229 202a 2070 6920 2f20 3138 3029 0a20  r) * pi / 180). 
+0000ad60: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000ad70: 2063 6f73 6120 3d20 6e70 2e63 6f73 2861   cosa = np.cos(a
+0000ad80: 7a69 202a 2070 6920 2f20 3138 3029 0a20  zi * pi / 180). 
+0000ad90: 2020 2020 2020 2073 696e 6120 3d20 6e70         sina = np
+0000ada0: 2e73 696e 2861 7a69 202a 2070 6920 2f20  .sin(azi * pi / 
+0000adb0: 3138 3029 0a20 2020 2020 2020 2063 6f73  180).        cos
+0000adc0: 6220 3d20 6e70 2e63 6f73 2862 617a 202a  b = np.cos(baz *
+0000add0: 2070 6920 2f20 3138 3029 0a20 2020 2020   pi / 180).     
+0000ade0: 2020 2073 696e 6220 3d20 6e70 2e73 696e     sinb = np.sin
+0000adf0: 2862 617a 202a 2070 6920 2f20 3138 3029  (baz * pi / 180)
+0000ae00: 0a0a 2020 2020 2320 7274 7a5f 636f 6d70  ..    # rtz_comp
+0000ae10: 6f6e 656e 7473 203d 205b 275a 5227 2c27  onents = ['ZR','
+0000ae20: 5a54 272c 275a 5a27 2c27 5252 272c 2752  ZT','ZZ','RR','R
+0000ae30: 5427 2c27 525a 272c 2754 5227 2c27 5454  T','RZ','TR','TT
+0000ae40: 272c 2754 5a27 5d0a 2020 2020 7463 6f72  ','TZ'].    tcor
+0000ae50: 7220 3d20 6e70 2e7a 6572 6f73 2873 6861  r = np.zeros(sha
+0000ae60: 7065 3d28 392c 206e 7074 7329 2c20 6474  pe=(9, npts), dt
+0000ae70: 7970 653d 6e70 2e66 6c6f 6174 3332 290a  ype=np.float32).
+0000ae80: 2020 2020 7463 6f72 725b 305d 203d 202d      tcorr[0] = -
+0000ae90: 636f 7362 202a 2062 6967 7374 6163 6b5b  cosb * bigstack[
+0000aea0: 375d 202d 2073 696e 6220 2a20 6269 6773  7] - sinb * bigs
+0000aeb0: 7461 636b 5b36 5d0a 2020 2020 7463 6f72  tack[6].    tcor
+0000aec0: 725b 315d 203d 2073 696e 6220 2a20 6269  r[1] = sinb * bi
+0000aed0: 6773 7461 636b 5b37 5d20 2d20 636f 7362  gstack[7] - cosb
+0000aee0: 202a 2062 6967 7374 6163 6b5b 365d 0a20   * bigstack[6]. 
+0000aef0: 2020 2074 636f 7272 5b32 5d20 3d20 6269     tcorr[2] = bi
+0000af00: 6773 7461 636b 5b38 5d0a 2020 2020 7463  gstack[8].    tc
+0000af10: 6f72 725b 335d 203d 2028 0a20 2020 2020  orr[3] = (.     
+0000af20: 2020 202d 636f 7361 202a 2063 6f73 6220     -cosa * cosb 
+0000af30: 2a20 6269 6773 7461 636b 5b34 5d20 2d20  * bigstack[4] - 
+0000af40: 636f 7361 202a 2073 696e 6220 2a20 6269  cosa * sinb * bi
+0000af50: 6773 7461 636b 5b33 5d20 2d20 7369 6e61  gstack[3] - sina
+0000af60: 202a 2063 6f73 6220 2a20 6269 6773 7461   * cosb * bigsta
+0000af70: 636b 5b31 5d20 2d20 7369 6e61 202a 2073  ck[1] - sina * s
+0000af80: 696e 6220 2a20 6269 6773 7461 636b 5b30  inb * bigstack[0
+0000af90: 5d0a 2020 2020 290a 2020 2020 7463 6f72  ].    ).    tcor
+0000afa0: 725b 345d 203d 2028 0a20 2020 2020 2020  r[4] = (.       
+0000afb0: 2063 6f73 6120 2a20 7369 6e62 202a 2062   cosa * sinb * b
+0000afc0: 6967 7374 6163 6b5b 345d 202d 2063 6f73  igstack[4] - cos
+0000afd0: 6120 2a20 636f 7362 202a 2062 6967 7374  a * cosb * bigst
+0000afe0: 6163 6b5b 335d 202b 2073 696e 6120 2a20  ack[3] + sina * 
+0000aff0: 7369 6e62 202a 2062 6967 7374 6163 6b5b  sinb * bigstack[
+0000b000: 315d 202d 2073 696e 6120 2a20 636f 7362  1] - sina * cosb
+0000b010: 202a 2062 6967 7374 6163 6b5b 305d 0a20   * bigstack[0]. 
+0000b020: 2020 2029 0a20 2020 2074 636f 7272 5b35     ).    tcorr[5
+0000b030: 5d20 3d20 636f 7361 202a 2062 6967 7374  ] = cosa * bigst
+0000b040: 6163 6b5b 355d 202b 2073 696e 6120 2a20  ack[5] + sina * 
+0000b050: 6269 6773 7461 636b 5b32 5d0a 2020 2020  bigstack[2].    
+0000b060: 7463 6f72 725b 365d 203d 2028 0a20 2020  tcorr[6] = (.   
+0000b070: 2020 2020 2073 696e 6120 2a20 636f 7362       sina * cosb
+0000b080: 202a 2062 6967 7374 6163 6b5b 345d 202b   * bigstack[4] +
+0000b090: 2073 696e 6120 2a20 7369 6e62 202a 2062   sina * sinb * b
+0000b0a0: 6967 7374 6163 6b5b 335d 202d 2063 6f73  igstack[3] - cos
+0000b0b0: 6120 2a20 636f 7362 202a 2062 6967 7374  a * cosb * bigst
+0000b0c0: 6163 6b5b 315d 202d 2063 6f73 6120 2a20  ack[1] - cosa * 
+0000b0d0: 7369 6e62 202a 2062 6967 7374 6163 6b5b  sinb * bigstack[
+0000b0e0: 305d 0a20 2020 2029 0a20 2020 2074 636f  0].    ).    tco
+0000b0f0: 7272 5b37 5d20 3d20 280a 2020 2020 2020  rr[7] = (.      
+0000b100: 2020 2d73 696e 6120 2a20 7369 6e62 202a    -sina * sinb *
+0000b110: 2062 6967 7374 6163 6b5b 345d 202b 2073   bigstack[4] + s
+0000b120: 696e 6120 2a20 636f 7362 202a 2062 6967  ina * cosb * big
+0000b130: 7374 6163 6b5b 335d 202b 2063 6f73 6120  stack[3] + cosa 
+0000b140: 2a20 7369 6e62 202a 2062 6967 7374 6163  * sinb * bigstac
+0000b150: 6b5b 315d 202d 2063 6f73 6120 2a20 636f  k[1] - cosa * co
+0000b160: 7362 202a 2062 6967 7374 6163 6b5b 305d  sb * bigstack[0]
+0000b170: 0a20 2020 2029 0a20 2020 2074 636f 7272  .    ).    tcorr
+0000b180: 5b38 5d20 3d20 2d73 696e 6120 2a20 6269  [8] = -sina * bi
+0000b190: 6773 7461 636b 5b35 5d20 2b20 636f 7361  gstack[5] + cosa
+0000b1a0: 202a 2062 6967 7374 6163 6b5b 325d 0a0a   * bigstack[2]..
+0000b1b0: 2020 2020 7265 7475 726e 2074 636f 7272      return tcorr
+0000b1c0: 0a0a 0a23 2323 2323 2323 2323 2323 2323  ...#############
+0000b1d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000b1e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000b1f0: 2323 2323 2323 230a 2323 2323 2323 2323  #######.########
+0000b200: 2323 2323 2323 2055 5449 4c49 5459 2046  ###### UTILITY F
+0000b210: 554e 4354 494f 4e53 2023 2323 2323 2323  UNCTIONS #######
+0000b220: 2323 2323 2323 2323 2323 2323 0a23 2323  ############.###
+0000b230: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000b240: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000b250: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000b260: 230a 0a0a 6465 6620 6368 6563 6b5f 7361  #...def check_sa
+0000b270: 6d70 6c65 5f67 6170 7328 7374 7265 616d  mple_gaps(stream
+0000b280: 3a20 6f62 7370 792e 5374 7265 616d 2c20  : obspy.Stream, 
+0000b290: 7374 6172 7474 696d 653a 206f 6273 7079  starttime: obspy
+0000b2a0: 2e55 5443 4461 7465 5469 6d65 2c20 656e  .UTCDateTime, en
+0000b2b0: 6474 696d 653a 206f 6273 7079 2e55 5443  dtime: obspy.UTC
+0000b2c0: 4461 7465 5469 6d65 293a 0a20 2020 2022  DateTime):.    "
+0000b2d0: 2222 0a20 2020 2074 6869 7320 6675 6e63  "".    this func
+0000b2e0: 7469 6f6e 2063 6865 636b 7320 7361 6d70  tion checks samp
+0000b2f0: 6c69 6e67 2072 6174 6520 616e 6420 6669  ling rate and fi
+0000b300: 6e64 2067 6170 7320 6f66 2061 6c6c 2074  nd gaps of all t
+0000b310: 7261 6365 7320 696e 2073 7472 6561 6d2e  races in stream.
+0000b320: 0a20 2020 2050 4152 414d 4554 4552 533a  .    PARAMETERS:
+0000b330: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
+0000b340: 2d2d 2d2d 2d2d 0a20 2020 2073 7472 6561  ------.    strea
+0000b350: 6d3a 206f 6273 7079 2073 7472 6561 6d20  m: obspy stream 
+0000b360: 6f62 6a65 6374 2e0a 2020 2020 6461 7465  object..    date
+0000b370: 5f69 6e66 6f3a 2064 6963 7420 6f66 2073  _info: dict of s
+0000b380: 7461 7274 696e 6720 616e 6420 656e 6469  tarting and endi
+0000b390: 6e67 2074 696d 6520 6f66 2074 6865 2073  ng time of the s
+0000b3a0: 7472 6561 6d0a 0a20 2020 2052 4554 5552  tream..    RETUR
+0000b3b0: 454e 533a 0a20 2020 202d 2d2d 2d2d 2d2d  ENS:.    -------
+0000b3c0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2073  ----------.    s
+0000b3d0: 7472 6561 6d3a 204c 6973 7420 6f66 2067  tream: List of g
+0000b3e0: 6f6f 6420 7472 6163 6573 2069 6e20 7468  ood traces in th
+0000b3f0: 6520 7374 7265 616d 0a20 2020 2022 2222  e stream.    """
+0000b400: 0a20 2020 2023 2072 656d 6f76 6520 656d  .    # remove em
+0000b410: 7074 792f 6269 6720 7472 6163 6573 0a20  pty/big traces. 
+0000b420: 2020 2069 6620 6c65 6e28 7374 7265 616d     if len(stream
+0000b430: 2920 3d3d 2030 206f 7220 6c65 6e28 7374  ) == 0 or len(st
+0000b440: 7265 616d 2920 3e20 3130 303a 0a20 2020  ream) > 100:.   
+0000b450: 2020 2020 2073 7472 6561 6d20 3d20 5b5d       stream = []
+0000b460: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000b470: 7374 7265 616d 0a0a 2020 2020 2320 7265  stream..    # re
+0000b480: 6d6f 7665 2074 7261 6365 7320 7769 7468  move traces with
+0000b490: 2062 6967 2067 6170 730a 2020 2020 6966   big gaps.    if
 0000b4a0: 2070 6f72 7469 6f6e 5f67 6170 7328 7374   portion_gaps(st
-0000b4b0: 7265 616d 2c20 6461 7465 5f69 6e66 6f29  ream, date_info)
-0000b4c0: 3a0a 2020 2020 2222 220a 2020 2020 7468  :.    """.    th
-0000b4d0: 6973 2066 756e 6374 696f 6e20 7472 6163  is function trac
-0000b4e0: 6b73 2074 6865 2067 6170 7320 286e 7074  ks the gaps (npt
-0000b4f0: 7329 2066 726f 6d20 7468 6520 6163 6375  s) from the accu
-0000b500: 6d75 6c61 7465 6420 6469 6666 6572 656e  mulated differen
-0000b510: 6365 2062 6574 7765 656e 2073 7461 7274  ce between start
-0000b520: 7469 6d65 2061 6e64 2065 6e64 7469 6d65  time and endtime
-0000b530: 0a20 2020 206f 6620 6561 6368 2073 7472  .    of each str
-0000b540: 6561 6d20 7472 6163 652e 2069 7420 7265  eam trace. it re
-0000b550: 6d6f 7665 7320 7472 6163 6520 7769 7468  moves trace with
-0000b560: 2067 6170 206c 656e 6774 6820 3e20 3330   gap length > 30
-0000b570: 2520 6f66 2074 7261 6365 2073 697a 652e  % of trace size.
-0000b580: 0a20 2020 2050 4152 414d 4554 4552 533a  .    PARAMETERS:
-0000b590: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
-0000b5a0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2073 7472  --------.    str
-0000b5b0: 6561 6d3a 206f 6273 7079 2073 7472 6561  eam: obspy strea
-0000b5c0: 6d20 6f62 6a65 6374 0a20 2020 2064 6174  m object.    dat
-0000b5d0: 655f 696e 666f 3a20 6469 6374 206f 6620  e_info: dict of 
-0000b5e0: 7374 6172 7469 6e67 2061 6e64 2065 6e64  starting and end
-0000b5f0: 696e 6720 7469 6d65 206f 6620 7468 6520  ing time of the 
-0000b600: 7374 7265 616d 0a0a 2020 2020 5245 5455  stream..    RETU
-0000b610: 524e 533a 0a20 2020 202d 2d2d 2d2d 2d2d  RNS:.    -------
-0000b620: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2070  ----------.    p
-0000b630: 6761 7073 3a20 7072 6f70 6f72 7469 6f6e  gaps: proportion
-0000b640: 206f 6620 6761 7073 2f61 6c6c 5f70 7473   of gaps/all_pts
-0000b650: 2069 6e20 7374 7265 616d 0a20 2020 2022   in stream.    "
-0000b660: 2222 0a20 2020 2023 2069 6465 616c 2064  "".    # ideal d
-0000b670: 7572 6174 696f 6e20 6f66 2064 6174 610a  uration of data.
-0000b680: 2020 2020 7374 6172 7474 696d 6520 3d20      starttime = 
-0000b690: 6461 7465 5f69 6e66 6f5b 2273 7461 7274  date_info["start
-0000b6a0: 7469 6d65 225d 0a20 2020 2065 6e64 7469  time"].    endti
-0000b6b0: 6d65 203d 2064 6174 655f 696e 666f 5b22  me = date_info["
-0000b6c0: 656e 6474 696d 6522 5d0a 2020 2020 6e70  endtime"].    np
-0000b6d0: 7473 203d 2028 656e 6474 696d 6520 2d20  ts = (endtime - 
-0000b6e0: 7374 6172 7474 696d 6529 202a 2073 7472  starttime) * str
-0000b6f0: 6561 6d5b 305d 2e73 7461 7473 2e73 616d  eam[0].stats.sam
-0000b700: 706c 696e 675f 7261 7465 0a0a 2020 2020  pling_rate..    
-0000b710: 7067 6170 7320 3d20 300a 2020 2020 2320  pgaps = 0.    # 
-0000b720: 6c6f 6f70 2074 6872 6f75 6768 2061 6c6c  loop through all
-0000b730: 2074 7261 6365 2074 6f20 6163 6375 6d75   trace to accumu
-0000b740: 6c61 7465 2067 6170 730a 2020 2020 666f  late gaps.    fo
-0000b750: 7220 6969 2069 6e20 7261 6e67 6528 6c65  r ii in range(le
-0000b760: 6e28 7374 7265 616d 2920 2d20 3129 3a0a  n(stream) - 1):.
-0000b770: 2020 2020 2020 2020 7067 6170 7320 2b3d          pgaps +=
-0000b780: 2028 7374 7265 616d 5b69 6920 2b20 315d   (stream[ii + 1]
-0000b790: 2e73 7461 7473 2e73 7461 7274 7469 6d65  .stats.starttime
-0000b7a0: 202d 2073 7472 6561 6d5b 6969 5d2e 7374   - stream[ii].st
-0000b7b0: 6174 732e 656e 6474 696d 6529 202a 2073  ats.endtime) * s
-0000b7c0: 7472 6561 6d5b 6969 5d2e 7374 6174 732e  tream[ii].stats.
-0000b7d0: 7361 6d70 6c69 6e67 5f72 6174 650a 2020  sampling_rate.  
-0000b7e0: 2020 6966 206e 7074 7320 213d 2030 3a0a    if npts != 0:.
-0000b7f0: 2020 2020 2020 2020 7067 6170 7320 3d20          pgaps = 
-0000b800: 7067 6170 7320 2f20 6e70 7473 0a20 2020  pgaps / npts.   
-0000b810: 2069 6620 6e70 7473 203d 3d20 303a 0a20   if npts == 0:. 
-0000b820: 2020 2020 2020 2070 6761 7073 203d 2031         pgaps = 1
-0000b830: 0a20 2020 2072 6574 7572 6e20 7067 6170  .    return pgap
-0000b840: 730a 0a0a 406a 6974 2822 666c 6f61 7433  s...@jit("float3
-0000b850: 325b 3a5d 2866 6c6f 6174 3332 5b3a 5d2c  2[:](float32[:],
-0000b860: 666c 6f61 7433 3229 2229 0a64 6566 2073  float32)").def s
-0000b870: 6567 6d65 6e74 5f69 6e74 6572 706f 6c61  egment_interpola
-0000b880: 7465 2873 6967 312c 206e 6672 6963 293a  te(sig1, nfric):
-0000b890: 0a20 2020 2022 2222 0a20 2020 2074 6869  .    """.    thi
-0000b8a0: 7320 6675 6e63 7469 6f6e 2069 6e74 6572  s function inter
-0000b8b0: 706f 6c61 7465 7320 7468 6520 6461 7461  polates the data
-0000b8c0: 2074 6f20 656e 7375 7265 2061 6c6c 2070   to ensure all p
-0000b8d0: 6f69 6e74 7320 6c6f 6361 7465 6420 6f6e  oints located on
-0000b8e0: 2069 6e74 6572 6765 7220 7469 6d65 7320   interger times 
-0000b8f0: 6f66 2074 6865 0a20 2020 2073 616d 706c  of the.    sampl
-0000b900: 696e 6720 7261 7465 2028 652e 672e 2c20  ing rate (e.g., 
-0000b910: 7374 6172 7474 696d 6520 3d20 3030 3a30  starttime = 00:0
-0000b920: 303a 3030 2e30 3135 2c20 6465 6c74 6120  0:00.015, delta 
-0000b930: 3d20 302e 3035 2e29 0a20 2020 2050 4152  = 0.05.).    PAR
-0000b940: 414d 4554 4552 533a 0a20 2020 202d 2d2d  AMETERS:.    ---
-0000b950: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000b960: 2d2d 2d0a 2020 2020 7369 6731 3a20 2073  ---.    sig1:  s
-0000b970: 6569 736d 6963 2072 6563 6f72 6469 6e67  eismic recording
-0000b980: 7320 696e 2061 2031 4420 6172 7261 790a  s in a 1D array.
-0000b990: 2020 2020 6e66 7269 633a 2074 6865 2061      nfric: the a
-0000b9a0: 6d6f 756e 7420 6f66 2074 696d 6520 6469  mount of time di
-0000b9b0: 6666 6572 656e 6365 2062 6574 7765 656e  fference between
-0000b9c0: 2074 6865 2070 6f69 6e74 2061 6e64 2074   the point and t
-0000b9d0: 6865 2061 646a 6163 656e 7420 6173 7375  he adjacent assu
-0000b9e0: 6d65 6420 7361 6d70 6c65 730a 2020 2020  med samples.    
-0000b9f0: 5245 5455 524e 533a 0a20 2020 202d 2d2d  RETURNS:.    ---
-0000ba00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000ba10: 2d2d 2d0a 2020 2020 7369 6732 3a20 2069  ---.    sig2:  i
-0000ba20: 6e74 6572 706f 6c61 7465 6420 7365 6973  nterpolated seis
-0000ba30: 6d69 6320 7265 636f 7264 696e 6773 206f  mic recordings o
-0000ba40: 6e20 7468 6520 7361 6d70 6c69 6e67 2070  n the sampling p
-0000ba50: 6f69 6e74 730a 2020 2020 2222 220a 2020  oints.    """.  
-0000ba60: 2020 6e70 7473 203d 206c 656e 2873 6967    npts = len(sig
-0000ba70: 3129 0a20 2020 2073 6967 3220 3d20 6e70  1).    sig2 = np
-0000ba80: 2e7a 6572 6f73 286e 7074 732c 2064 7479  .zeros(npts, dty
-0000ba90: 7065 3d6e 702e 666c 6f61 7433 3229 0a0a  pe=np.float32)..
-0000baa0: 2020 2020 2320 2d2d 2d2d 696e 7374 6561      # ----instea
-0000bab0: 6420 6f66 2073 6869 6674 696e 672c 2064  d of shifting, d
-0000bac0: 6f20 6120 696e 7465 7270 6f6c 6174 696f  o a interpolatio
-0000bad0: 6e2d 2d2d 2d2d 2d0a 2020 2020 666f 7220  n------.    for 
-0000bae0: 6969 2069 6e20 7261 6e67 6528 6e70 7473  ii in range(npts
-0000baf0: 293a 0a20 2020 2020 2020 2023 202d 2d2d  ):.        # ---
-0000bb00: 2d64 6561 6c20 7769 7468 2065 6467 6573  -deal with edges
-0000bb10: 2d2d 2d2d 2d0a 2020 2020 2020 2020 6966  -----.        if
-0000bb20: 2069 6920 3d3d 2030 206f 7220 6969 203d   ii == 0 or ii =
-0000bb30: 3d20 6e70 7473 202d 2031 3a0a 2020 2020  = npts - 1:.    
-0000bb40: 2020 2020 2020 2020 7369 6732 5b69 695d          sig2[ii]
-0000bb50: 203d 2073 6967 315b 6969 5d0a 2020 2020   = sig1[ii].    
-0000bb60: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000bb70: 2020 2020 2020 2320 2d2d 2d2d 2d2d 696e        # ------in
-0000bb80: 7465 7270 6f6c 6174 6520 7573 696e 6720  terpolate using 
-0000bb90: 6120 6861 7420 6675 6e63 7469 6f6e 2d2d  a hat function--
-0000bba0: 2d2d 2d2d 0a20 2020 2020 2020 2020 2020  ----.           
-0000bbb0: 2073 6967 325b 6969 5d20 3d20 2831 202d   sig2[ii] = (1 -
-0000bbc0: 206e 6672 6963 2920 2a20 7369 6731 5b69   nfric) * sig1[i
-0000bbd0: 6920 2b20 315d 202b 206e 6672 6963 202a  i + 1] + nfric *
-0000bbe0: 2073 6967 315b 6969 5d0a 0a20 2020 2072   sig1[ii]..    r
-0000bbf0: 6574 7572 6e20 7369 6732 0a0a 0a64 6566  eturn sig2...def
-0000bc00: 2072 6573 705f 7370 6563 7472 756d 2873   resp_spectrum(s
-0000bc10: 6f75 7263 652c 2072 6573 705f 6669 6c65  ource, resp_file
-0000bc20: 2c20 646f 776e 7361 6d70 5f66 7265 712c  , downsamp_freq,
-0000bc30: 2070 7265 5f66 696c 743d 4e6f 6e65 293a   pre_filt=None):
-0000bc40: 0a20 2020 2022 2222 0a20 2020 2074 6869  .    """.    thi
-0000bc50: 7320 6675 6e63 7469 6f6e 2072 656d 6f76  s function remov
-0000bc60: 6573 2074 6865 2069 6e73 7472 756d 656e  es the instrumen
-0000bc70: 7420 7265 7370 6f6e 7365 2075 7369 6e67  t response using
-0000bc80: 2072 6573 706f 6e73 6520 7370 6563 7472   response spectr
-0000bc90: 756d 2066 726f 6d20 6576 616c 7265 7370  um from evalresp
-0000bca0: 2e0a 2020 2020 7468 6520 7265 7370 6f6e  ..    the respon
-0000bcb0: 7365 2073 7065 6374 7275 6d20 6973 2065  se spectrum is e
-0000bcc0: 7661 6c75 6174 6564 2062 6173 6564 206f  valuated based o
-0000bcd0: 6e20 5245 5350 2f50 5a20 6669 6c65 7320  n RESP/PZ files 
-0000bce0: 6265 666f 7265 2069 6e76 6572 7465 6420  before inverted 
-0000bcf0: 7573 696e 6720 7468 6520 6f62 7370 790a  using the obspy.
-0000bd00: 2020 2020 6675 6e63 7469 6f6e 206f 6620      function of 
-0000bd10: 696e 7665 7274 5f73 7065 6374 7275 6d2e  invert_spectrum.
-0000bd20: 2061 206d 6f64 756c 6520 6f66 2063 7265   a module of cre
-0000bd30: 6174 655f 7265 7370 2e70 7920 6973 2070  ate_resp.py is p
-0000bd40: 726f 7669 6465 6420 696e 2064 6972 6563  rovided in direc
-0000bd50: 746f 7279 206f 6620 2761 6464 6974 696f  tory of 'additio
-0000bd60: 6e61 6c5f 6d6f 6475 6c65 7327 0a20 2020  nal_modules'.   
-0000bd70: 2074 6f20 6372 6561 7465 2074 6865 2072   to create the r
-0000bd80: 6573 706f 6e73 6520 7370 6563 7472 756d  esponse spectrum
-0000bd90: 0a20 2020 2050 4152 414d 4554 4552 533a  .    PARAMETERS:
-0000bda0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
-0000bdb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
-0000bdc0: 736f 7572 6365 3a20 6f62 7370 7920 7374  source: obspy st
-0000bdd0: 7265 616d 206f 626a 6563 7420 6f66 2074  ream object of t
-0000bde0: 6172 6765 7465 6420 6e6f 6973 6520 6461  argeted noise da
-0000bdf0: 7461 0a20 2020 2072 6573 705f 6669 6c65  ta.    resp_file
-0000be00: 3a20 6e75 6d70 7920 6461 7461 2066 696c  : numpy data fil
-0000be10: 6520 6f66 2072 6573 706f 6e73 6520 7370  e of response sp
-0000be20: 6563 7472 756d 0a20 2020 2064 6f77 6e73  ectrum.    downs
-0000be30: 616d 705f 6672 6571 3a20 7361 6d70 6c69  amp_freq: sampli
-0000be40: 6e67 2072 6174 6520 6f66 2074 6865 2073  ng rate of the s
-0000be50: 6f75 7263 6520 6461 7461 0a20 2020 2070  ource data.    p
-0000be60: 7265 5f66 696c 743a 2070 7265 2d64 6566  re_filt: pre-def
-0000be70: 696e 6564 2066 696c 7465 7220 7061 7261  ined filter para
-0000be80: 6d65 7465 7273 0a20 2020 2052 4554 5552  meters.    RETUR
-0000be90: 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  NS:.    --------
-0000bea0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
-0000beb0: 2020 2073 6f75 7263 653a 206f 6273 7079     source: obspy
-0000bec0: 2073 7472 6561 6d20 6f62 6a65 6374 206f   stream object o
-0000bed0: 6620 6e6f 6973 6520 6461 7461 2077 6974  f noise data wit
-0000bee0: 6820 696e 7374 7275 6d65 6e74 2072 6573  h instrument res
-0000bef0: 706f 6e73 6520 7265 6d6f 7665 640a 2020  ponse removed.  
-0000bf00: 2020 2222 220a 2020 2020 2320 2d2d 2d2d    """.    # ----
-0000bf10: 2d2d 2d2d 7265 7370 5f66 696c 6520 6973  ----resp_file is
-0000bf20: 2074 6865 2069 6e76 6572 7465 6420 7370   the inverted sp
-0000bf30: 6563 7472 756d 2072 6573 706f 6e73 652d  ectrum response-
-0000bf40: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2072 6573  --------.    res
-0000bf50: 707a 203d 206e 702e 6c6f 6164 2872 6573  pz = np.load(res
-0000bf60: 705f 6669 6c65 290a 2020 2020 6e72 6573  p_file).    nres
-0000bf70: 707a 203d 2072 6573 707a 5b31 5d5b 3a5d  pz = respz[1][:]
-0000bf80: 0a20 2020 2073 7065 635f 6672 6571 203d  .    spec_freq =
-0000bf90: 206d 6178 2872 6573 707a 5b30 5d29 0a0a   max(respz[0])..
-0000bfa0: 2020 2020 2320 2d2d 2d2d 2d2d 2d6f 6e20      # -------on 
-0000bfb0: 6375 7272 656e 7420 7472 6163 652d 2d2d  current trace---
-0000bfc0: 2d2d 2d2d 2d2d 2d0a 2020 2020 6e66 6674  -------.    nfft
-0000bfd0: 203d 205f 6e70 7473 326e 6666 7428 736f   = _npts2nfft(so
-0000bfe0: 7572 6365 5b30 5d2e 7374 6174 732e 6e70  urce[0].stats.np
-0000bff0: 7473 290a 2020 2020 7370 7320 3d20 696e  ts).    sps = in
-0000c000: 7428 736f 7572 6365 5b30 5d2e 7374 6174  t(source[0].stat
-0000c010: 732e 7361 6d70 6c69 6e67 5f72 6174 6529  s.sampling_rate)
-0000c020: 0a0a 2020 2020 2320 2d2d 2d2d 2d2d 2d2d  ..    # --------
-0000c030: 2d64 6f20 7468 6520 696e 7465 7270 6f6c  -do the interpol
-0000c040: 6174 696f 6e20 6966 206e 6565 6465 642d  ation if needed-
-0000c050: 2d2d 2d2d 2d2d 2d0a 2020 2020 6966 2073  -------.    if s
-0000c060: 7065 635f 6672 6571 203c 2030 2e35 202a  pec_freq < 0.5 *
-0000c070: 2073 7073 3a0a 2020 2020 2020 2020 7261   sps:.        ra
-0000c080: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
-0000c090: 7370 6563 7472 756d 2066 696c 6520 6861  spectrum file ha
-0000c0a0: 7320 7065 616b 2066 7265 7120 736d 616c  s peak freq smal
-0000c0b0: 6c65 7220 7468 616e 2074 6865 2064 6174  ler than the dat
-0000c0c0: 612c 2061 626f 7274 2122 290a 2020 2020  a, abort!").    
-0000c0d0: 656c 7365 3a0a 2020 2020 2020 2020 696e  else:.        in
-0000c0e0: 6478 203d 206e 702e 7768 6572 6528 7265  dx = np.where(re
-0000c0f0: 7370 7a5b 305d 203c 3d20 302e 3520 2a20  spz[0] <= 0.5 * 
-0000c100: 7370 7329 0a20 2020 2020 2020 206e 6672  sps).        nfr
-0000c110: 6571 203d 206e 702e 6c69 6e73 7061 6365  eq = np.linspace
-0000c120: 2830 2c20 302e 3520 2a20 7370 732c 206e  (0, 0.5 * sps, n
-0000c130: 6666 7420 2f2f 2032 202b 2031 290a 2020  fft // 2 + 1).  
-0000c140: 2020 2020 2020 6e72 6573 707a 203d 206e        nrespz = n
-0000c150: 702e 696e 7465 7270 286e 6672 6571 2c20  p.interp(nfreq, 
-0000c160: 6e70 2e72 6561 6c28 7265 7370 7a5b 305d  np.real(respz[0]
-0000c170: 5b69 6e64 785d 292c 2072 6573 707a 5b31  [indx]), respz[1
-0000c180: 5d5b 696e 6478 5d29 0a0a 2020 2020 2320  ][indx])..    # 
-0000c190: 2d2d 2d2d 646f 2069 6e74 6572 706f 6c61  ----do interpola
-0000c1a0: 7469 6f6e 2069 6620 6e65 6365 7373 6172  tion if necessar
-0000c1b0: 792d 2d2d 2d2d 0a20 2020 2073 6f75 7263  y-----.    sourc
-0000c1c0: 655f 7370 6563 7420 3d20 6e70 2e66 6674  e_spect = np.fft
-0000c1d0: 2e72 6666 7428 736f 7572 6365 5b30 5d2e  .rfft(source[0].
-0000c1e0: 6461 7461 2c20 6e3d 6e66 6674 290a 0a20  data, n=nfft).. 
-0000c1f0: 2020 2023 202d 2d2d 2d2d 6e72 6573 707a     # -----nrespz
-0000c200: 2069 7320 696e 7665 7273 6564 2028 7761   is inversed (wa
-0000c210: 7465 722d 6c65 7665 6c65 6429 2073 7065  ter-leveled) spe
-0000c220: 6374 7275 6d2d 2d2d 2d2d 0a20 2020 2073  ctrum-----.    s
-0000c230: 6f75 7263 655f 7370 6563 7420 2a3d 206e  ource_spect *= n
-0000c240: 7265 7370 7a0a 2020 2020 736f 7572 6365  respz.    source
-0000c250: 5b30 5d2e 6461 7461 203d 206e 702e 6666  [0].data = np.ff
-0000c260: 742e 6972 6666 7428 736f 7572 6365 5f73  t.irfft(source_s
-0000c270: 7065 6374 295b 3020 3a20 736f 7572 6365  pect)[0 : source
-0000c280: 5b30 5d2e 7374 6174 732e 6e70 7473 5d0a  [0].stats.npts].
-0000c290: 0a20 2020 2069 6620 7072 655f 6669 6c74  .    if pre_filt
-0000c2a0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0000c2b0: 2020 2020 2020 736f 7572 6365 5b30 5d2e        source[0].
-0000c2c0: 6461 7461 203d 206e 702e 666c 6f61 7433  data = np.float3
-0000c2d0: 3228 0a20 2020 2020 2020 2020 2020 2062  2(.            b
-0000c2e0: 616e 6470 6173 7328 0a20 2020 2020 2020  andpass(.       
-0000c2f0: 2020 2020 2020 2020 2073 6f75 7263 655b           source[
-0000c300: 305d 2e64 6174 612c 0a20 2020 2020 2020  0].data,.       
-0000c310: 2020 2020 2020 2020 2070 7265 5f66 696c           pre_fil
-0000c320: 745b 305d 2c0a 2020 2020 2020 2020 2020  t[0],.          
-0000c330: 2020 2020 2020 7072 655f 6669 6c74 5b2d        pre_filt[-
-0000c340: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
-0000c350: 2020 2020 6466 3d73 7073 2c0a 2020 2020      df=sps,.    
-0000c360: 2020 2020 2020 2020 2020 2020 636f 726e              corn
-0000c370: 6572 733d 342c 0a20 2020 2020 2020 2020  ers=4,.         
-0000c380: 2020 2020 2020 207a 6572 6f70 6861 7365         zerophase
-0000c390: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
-0000c3a0: 2020 2029 0a20 2020 2020 2020 2029 0a0a     ).        )..
-0000c3b0: 2020 2020 7265 7475 726e 2073 6f75 7263      return sourc
-0000c3c0: 650a 0a0a 6465 6620 6d61 6428 6172 7229  e...def mad(arr)
-0000c3d0: 3a0a 2020 2020 2222 220a 2020 2020 4d65  :.    """.    Me
-0000c3e0: 6469 616e 2041 6273 6f6c 7574 6520 4465  dian Absolute De
-0000c3f0: 7669 6174 696f 6e3a 204d 4144 203d 206d  viation: MAD = m
-0000c400: 6564 6961 6e28 7c58 692d 206d 6564 6961  edian(|Xi- media
-0000c410: 6e28 5829 7c29 0a20 2020 2050 4152 414d  n(X)|).    PARAM
-0000c420: 4554 4552 533a 0a20 2020 202d 2d2d 2d2d  ETERS:.    -----
-0000c430: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
-0000c440: 2020 2061 7272 3a20 6e75 6d70 792e 6e64     arr: numpy.nd
-0000c450: 6172 7261 792c 2073 6569 736d 6963 2074  array, seismic t
-0000c460: 7261 6365 2064 6174 6120 6172 7261 790a  race data array.
-0000c470: 2020 2020 5245 5455 524e 533a 0a20 2020      RETURNS:.   
-0000c480: 2064 6174 613a 204d 6564 6961 6e20 4162   data: Median Ab
-0000c490: 736f 6c75 7465 2044 6576 6961 7469 6f6e  solute Deviation
-0000c4a0: 206f 6620 6461 7461 0a20 2020 2022 2222   of data.    """
-0000c4b0: 0a20 2020 2069 6620 6e6f 7420 6e70 2e6d  .    if not np.m
-0000c4c0: 612e 6973 5f6d 6173 6b65 6428 6172 7229  a.is_masked(arr)
-0000c4d0: 3a0a 2020 2020 2020 2020 6d65 6420 3d20  :.        med = 
-0000c4e0: 6e70 2e6d 6564 6961 6e28 6172 7229 0a20  np.median(arr). 
-0000c4f0: 2020 2020 2020 2064 6174 6120 3d20 6e70         data = np
-0000c500: 2e6d 6564 6961 6e28 6e70 2e61 6273 2861  .median(np.abs(a
-0000c510: 7272 202d 206d 6564 2929 0a20 2020 2065  rr - med)).    e
-0000c520: 6c73 653a 0a20 2020 2020 2020 206d 6564  lse:.        med
-0000c530: 203d 206e 702e 6d61 2e6d 6564 6961 6e28   = np.ma.median(
-0000c540: 6172 7229 0a20 2020 2020 2020 2064 6174  arr).        dat
-0000c550: 6120 3d20 6e70 2e6d 612e 6d65 6469 616e  a = np.ma.median
-0000c560: 286e 702e 6d61 2e61 6273 2861 7272 202d  (np.ma.abs(arr -
-0000c570: 206d 6564 2929 0a20 2020 2072 6574 7572   med)).    retur
-0000c580: 6e20 6461 7461 0a0a 0a64 6566 2064 6574  n data...def det
-0000c590: 7265 6e64 2864 6174 6129 3a0a 2020 2020  rend(data):.    
-0000c5a0: 2222 220a 2020 2020 7468 6973 2066 756e  """.    this fun
-0000c5b0: 6374 696f 6e20 7265 6d6f 7665 7320 7468  ction removes th
-0000c5c0: 6520 7369 676e 616c 2074 7265 6e64 2062  e signal trend b
-0000c5d0: 6173 6564 206f 6e20 5152 2064 6563 6f6d  ased on QR decom
-0000c5e0: 706f 7369 6f6e 0a20 2020 204e 4f54 453a  posion.    NOTE:
-0000c5f0: 2051 5220 6973 2061 206c 6f74 2066 6173   QR is a lot fas
-0000c600: 7465 7220 7468 616e 2074 6865 206c 6561  ter than the lea
-0000c610: 7374 2073 7175 6172 6520 696e 7665 7273  st square invers
-0000c620: 696f 6e20 7573 6564 2062 790a 2020 2020  ion used by.    
-0000c630: 7363 6970 7920 2861 6c73 6f20 696e 206f  scipy (also in o
-0000c640: 6273 7079 292e 0a20 2020 2050 4152 414d  bspy)..    PARAM
-0000c650: 4554 4552 533a 0a20 2020 202d 2d2d 2d2d  ETERS:.    -----
-0000c660: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000c670: 0a20 2020 2064 6174 613a 2069 6e70 7574  .    data: input
-0000c680: 2064 6174 6120 6d61 7472 6978 0a20 2020   data matrix.   
-0000c690: 2052 4554 5552 4e53 3a0a 2020 2020 2d2d   RETURNS:.    --
-0000c6a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000c6b0: 2d2d 2d0a 2020 2020 6461 7461 3a20 6461  ---.    data: da
-0000c6c0: 7461 206d 6174 7269 7820 7769 7468 2074  ta matrix with t
-0000c6d0: 7265 6e64 2072 656d 6f76 6564 0a20 2020  rend removed.   
-0000c6e0: 2022 2222 0a20 2020 2023 206e 6461 7461   """.    # ndata
-0000c6f0: 203d 206e 702e 7a65 726f 7328 7368 6170   = np.zeros(shap
-0000c700: 653d 6461 7461 2e73 6861 7065 2c64 7479  e=data.shape,dty
-0000c710: 7065 3d64 6174 612e 6474 7970 6529 0a20  pe=data.dtype). 
-0000c720: 2020 2069 6620 6461 7461 2e6e 6469 6d20     if data.ndim 
-0000c730: 3d3d 2031 3a0a 2020 2020 2020 2020 6e70  == 1:.        np
-0000c740: 7473 203d 2064 6174 612e 7368 6170 655b  ts = data.shape[
-0000c750: 305d 0a20 2020 2020 2020 2058 203d 206e  0].        X = n
-0000c760: 702e 6f6e 6573 2828 6e70 7473 2c20 3229  p.ones((npts, 2)
-0000c770: 290a 2020 2020 2020 2020 585b 3a2c 2030  ).        X[:, 0
-0000c780: 5d20 3d20 6e70 2e61 7261 6e67 6528 302c  ] = np.arange(0,
-0000c790: 206e 7074 7329 202f 206e 7074 730a 2020   npts) / npts.  
-0000c7a0: 2020 2020 2020 512c 2052 203d 206e 702e        Q, R = np.
-0000c7b0: 6c69 6e61 6c67 2e71 7228 5829 0a20 2020  linalg.qr(X).   
-0000c7c0: 2020 2020 2072 7120 3d20 6e70 2e64 6f74       rq = np.dot
-0000c7d0: 286e 702e 6c69 6e61 6c67 2e69 6e76 2852  (np.linalg.inv(R
-0000c7e0: 292c 2051 2e74 7261 6e73 706f 7365 2829  ), Q.transpose()
-0000c7f0: 290a 2020 2020 2020 2020 636f 6566 6620  ).        coeff 
-0000c800: 3d20 6e70 2e64 6f74 2872 712c 2064 6174  = np.dot(rq, dat
-0000c810: 6129 0a20 2020 2020 2020 2064 6174 6120  a).        data 
-0000c820: 3d20 6461 7461 202d 206e 702e 646f 7428  = data - np.dot(
-0000c830: 582c 2063 6f65 6666 290a 2020 2020 656c  X, coeff).    el
-0000c840: 6966 2064 6174 612e 6e64 696d 203d 3d20  if data.ndim == 
-0000c850: 323a 0a20 2020 2020 2020 206e 7074 7320  2:.        npts 
-0000c860: 3d20 6461 7461 2e73 6861 7065 5b31 5d0a  = data.shape[1].
-0000c870: 2020 2020 2020 2020 5820 3d20 6e70 2e6f          X = np.o
-0000c880: 6e65 7328 286e 7074 732c 2032 2929 0a20  nes((npts, 2)). 
-0000c890: 2020 2020 2020 2058 5b3a 2c20 305d 203d         X[:, 0] =
-0000c8a0: 206e 702e 6172 616e 6765 2830 2c20 6e70   np.arange(0, np
-0000c8b0: 7473 2920 2f20 6e70 7473 0a20 2020 2020  ts) / npts.     
-0000c8c0: 2020 2051 2c20 5220 3d20 6e70 2e6c 696e     Q, R = np.lin
-0000c8d0: 616c 672e 7172 2858 290a 2020 2020 2020  alg.qr(X).      
-0000c8e0: 2020 7271 203d 206e 702e 646f 7428 6e70    rq = np.dot(np
-0000c8f0: 2e6c 696e 616c 672e 696e 7628 5229 2c20  .linalg.inv(R), 
-0000c900: 512e 7472 616e 7370 6f73 6528 2929 0a20  Q.transpose()). 
-0000c910: 2020 2020 2020 2066 6f72 2069 6920 696e         for ii in
-0000c920: 2072 616e 6765 2864 6174 612e 7368 6170   range(data.shap
-0000c930: 655b 305d 293a 0a20 2020 2020 2020 2020  e[0]):.         
-0000c940: 2020 2063 6f65 6666 203d 206e 702e 646f     coeff = np.do
-0000c950: 7428 7271 2c20 6461 7461 5b69 695d 290a  t(rq, data[ii]).
-0000c960: 2020 2020 2020 2020 2020 2020 6461 7461              data
-0000c970: 5b69 695d 203d 2064 6174 615b 6969 5d20  [ii] = data[ii] 
-0000c980: 2d20 6e70 2e64 6f74 2858 2c20 636f 6566  - np.dot(X, coef
-0000c990: 6629 0a20 2020 2072 6574 7572 6e20 6461  f).    return da
-0000c9a0: 7461 0a0a 0a64 6566 2064 656d 6561 6e28  ta...def demean(
-0000c9b0: 6461 7461 293a 0a20 2020 2022 2222 0a20  data):.    """. 
-0000c9c0: 2020 2074 6869 7320 6675 6e63 7469 6f6e     this function
-0000c9d0: 2072 656d 6f76 6520 7468 6520 6d65 616e   remove the mean
-0000c9e0: 206f 6620 7468 6520 7369 676e 616c 0a20   of the signal. 
-0000c9f0: 2020 2050 4152 414d 4554 4552 533a 0a20     PARAMETERS:. 
-0000ca00: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
-0000ca10: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2064 6174  --------.    dat
-0000ca20: 613a 2069 6e70 7574 2064 6174 6120 6d61  a: input data ma
-0000ca30: 7472 6978 0a20 2020 2052 4554 5552 4e53  trix.    RETURNS
-0000ca40: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
-0000ca50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
-0000ca60: 6461 7461 3a20 6461 7461 206d 6174 7269  data: data matri
-0000ca70: 7820 7769 7468 206d 6561 6e20 7265 6d6f  x with mean remo
-0000ca80: 7665 640a 2020 2020 2222 220a 2020 2020  ved.    """.    
-0000ca90: 2320 6e64 6174 6120 3d20 6e70 2e7a 6572  # ndata = np.zer
-0000caa0: 6f73 2873 6861 7065 3d64 6174 612e 7368  os(shape=data.sh
-0000cab0: 6170 652c 6474 7970 653d 6461 7461 2e64  ape,dtype=data.d
-0000cac0: 7479 7065 290a 2020 2020 6966 2064 6174  type).    if dat
-0000cad0: 612e 6e64 696d 203d 3d20 313a 0a20 2020  a.ndim == 1:.   
-0000cae0: 2020 2020 2064 6174 6120 3d20 6461 7461       data = data
-0000caf0: 202d 206e 702e 6d65 616e 2864 6174 6129   - np.mean(data)
-0000cb00: 0a20 2020 2065 6c69 6620 6461 7461 2e6e  .    elif data.n
-0000cb10: 6469 6d20 3d3d 2032 3a0a 2020 2020 2020  dim == 2:.      
-0000cb20: 2020 666f 7220 6969 2069 6e20 7261 6e67    for ii in rang
-0000cb30: 6528 6461 7461 2e73 6861 7065 5b30 5d29  e(data.shape[0])
-0000cb40: 3a0a 2020 2020 2020 2020 2020 2020 6461  :.            da
-0000cb50: 7461 5b69 695d 203d 2064 6174 615b 6969  ta[ii] = data[ii
-0000cb60: 5d20 2d20 6e70 2e6d 6561 6e28 6461 7461  ] - np.mean(data
-0000cb70: 5b69 695d 290a 2020 2020 7265 7475 726e  [ii]).    return
-0000cb80: 2064 6174 610a 0a0a 6465 6620 7461 7065   data...def tape
-0000cb90: 7228 6461 7461 293a 0a20 2020 2022 2222  r(data):.    """
-0000cba0: 0a20 2020 2074 6869 7320 6675 6e63 7469  .    this functi
-0000cbb0: 6f6e 2061 7070 6c69 6573 2061 2063 6f73  on applies a cos
-0000cbc0: 696e 6520 7461 7065 7220 7573 696e 6720  ine taper using 
-0000cbd0: 6f62 7370 7920 6675 6e63 7469 6f6e 730a  obspy functions.
-0000cbe0: 2020 2020 5041 5241 4d45 5445 5253 3a0a      PARAMETERS:.
-0000cbf0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
-0000cc00: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6461  ---------.    da
-0000cc10: 7461 3a20 696e 7075 7420 6461 7461 206d  ta: input data m
-0000cc20: 6174 7269 780a 2020 2020 5245 5455 524e  atrix.    RETURN
-0000cc30: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
-0000cc40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
-0000cc50: 2064 6174 613a 2064 6174 6120 6d61 7472   data: data matr
-0000cc60: 6978 2077 6974 6820 7461 7065 7220 6170  ix with taper ap
-0000cc70: 706c 6965 640a 2020 2020 2222 220a 2020  plied.    """.  
-0000cc80: 2020 2320 6e64 6174 6120 3d20 6e70 2e7a    # ndata = np.z
-0000cc90: 6572 6f73 2873 6861 7065 3d64 6174 612e  eros(shape=data.
-0000cca0: 7368 6170 652c 6474 7970 653d 6461 7461  shape,dtype=data
-0000ccb0: 2e64 7479 7065 290a 2020 2020 6966 2064  .dtype).    if d
-0000ccc0: 6174 612e 6e64 696d 203d 3d20 313a 0a20  ata.ndim == 1:. 
-0000ccd0: 2020 2020 2020 206e 7074 7320 3d20 6461         npts = da
-0000cce0: 7461 2e73 6861 7065 5b30 5d0a 2020 2020  ta.shape[0].    
-0000ccf0: 2020 2020 2320 7769 6e64 6f77 206c 656e      # window len
-0000cd00: 6774 680a 2020 2020 2020 2020 6966 206e  gth.        if n
-0000cd10: 7074 7320 2a20 302e 3035 203e 2032 303a  pts * 0.05 > 20:
-0000cd20: 0a20 2020 2020 2020 2020 2020 2077 6c65  .            wle
-0000cd30: 6e20 3d20 3230 0a20 2020 2020 2020 2065  n = 20.        e
-0000cd40: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000cd50: 2077 6c65 6e20 3d20 6e70 7473 202a 2030   wlen = npts * 0
-0000cd60: 2e30 350a 2020 2020 2020 2020 2320 7461  .05.        # ta
-0000cd70: 7065 7220 7661 6c75 6573 0a20 2020 2020  per values.     
-0000cd80: 2020 2066 756e 6320 3d20 5f67 6574 5f66     func = _get_f
-0000cd90: 756e 6374 696f 6e5f 6672 6f6d 5f65 6e74  unction_from_ent
-0000cda0: 7279 5f70 6f69 6e74 2822 7461 7065 7222  ry_point("taper"
-0000cdb0: 2c20 2268 616e 6e22 290a 2020 2020 2020  , "hann").      
-0000cdc0: 2020 6966 2032 202a 2077 6c65 6e20 3d3d    if 2 * wlen ==
-0000cdd0: 206e 7074 733a 0a20 2020 2020 2020 2020   npts:.         
-0000cde0: 2020 2074 6170 6572 5f73 6964 6573 203d     taper_sides =
-0000cdf0: 2066 756e 6328 3220 2a20 776c 656e 290a   func(2 * wlen).
-0000ce00: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000ce10: 2020 2020 2020 2020 2020 7461 7065 725f            taper_
-0000ce20: 7369 6465 7320 3d20 6675 6e63 2832 202a  sides = func(2 *
-0000ce30: 2077 6c65 6e20 2b20 3129 0a20 2020 2020   wlen + 1).     
-0000ce40: 2020 2023 2074 6170 6572 2077 696e 646f     # taper windo
-0000ce50: 770a 2020 2020 2020 2020 7769 6e20 3d20  w.        win = 
-0000ce60: 6e70 2e68 7374 6163 6b28 0a20 2020 2020  np.hstack(.     
-0000ce70: 2020 2020 2020 2028 0a20 2020 2020 2020         (.       
-0000ce80: 2020 2020 2020 2020 2074 6170 6572 5f73           taper_s
-0000ce90: 6964 6573 5b3a 776c 656e 5d2c 0a20 2020  ides[:wlen],.   
-0000cea0: 2020 2020 2020 2020 2020 2020 206e 702e               np.
-0000ceb0: 6f6e 6573 286e 7074 7320 2d20 3220 2a20  ones(npts - 2 * 
-0000cec0: 776c 656e 292c 0a20 2020 2020 2020 2020  wlen),.         
-0000ced0: 2020 2020 2020 2074 6170 6572 5f73 6964         taper_sid
-0000cee0: 6573 5b6c 656e 2874 6170 6572 5f73 6964  es[len(taper_sid
-0000cef0: 6573 2920 2d20 776c 656e 203a 5d2c 0a20  es) - wlen :],. 
-0000cf00: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0000cf10: 2020 2020 2029 0a20 2020 2020 2020 2064       ).        d
-0000cf20: 6174 6120 2a3d 2077 696e 0a20 2020 2065  ata *= win.    e
-0000cf30: 6c69 6620 6461 7461 2e6e 6469 6d20 3d3d  lif data.ndim ==
-0000cf40: 2032 3a0a 2020 2020 2020 2020 6e70 7473   2:.        npts
-0000cf50: 203d 2064 6174 612e 7368 6170 655b 315d   = data.shape[1]
-0000cf60: 0a20 2020 2020 2020 2023 2077 696e 646f  .        # windo
-0000cf70: 7720 6c65 6e67 7468 0a20 2020 2020 2020  w length.       
-0000cf80: 2069 6620 6e70 7473 202a 2030 2e30 3520   if npts * 0.05 
-0000cf90: 3e20 3230 3a0a 2020 2020 2020 2020 2020  > 20:.          
-0000cfa0: 2020 776c 656e 203d 2032 300a 2020 2020    wlen = 20.    
-0000cfb0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000cfc0: 2020 2020 2020 776c 656e 203d 206e 7074        wlen = npt
-0000cfd0: 7320 2a20 302e 3035 0a20 2020 2020 2020  s * 0.05.       
-0000cfe0: 2023 2074 6170 6572 2076 616c 7565 730a   # taper values.
-0000cff0: 2020 2020 2020 2020 6675 6e63 203d 205f          func = _
-0000d000: 6765 745f 6675 6e63 7469 6f6e 5f66 726f  get_function_fro
-0000d010: 6d5f 656e 7472 795f 706f 696e 7428 2274  m_entry_point("t
-0000d020: 6170 6572 222c 2022 6861 6e6e 2229 0a20  aper", "hann"). 
-0000d030: 2020 2020 2020 2069 6620 3220 2a20 776c         if 2 * wl
-0000d040: 656e 203d 3d20 6e70 7473 3a0a 2020 2020  en == npts:.    
-0000d050: 2020 2020 2020 2020 7461 7065 725f 7369          taper_si
-0000d060: 6465 7320 3d20 6675 6e63 2832 202a 2077  des = func(2 * w
-0000d070: 6c65 6e29 0a20 2020 2020 2020 2065 6c73  len).        els
-0000d080: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
-0000d090: 6170 6572 5f73 6964 6573 203d 2066 756e  aper_sides = fun
-0000d0a0: 6328 3220 2a20 776c 656e 202b 2031 290a  c(2 * wlen + 1).
-0000d0b0: 2020 2020 2020 2020 2320 7461 7065 7220          # taper 
-0000d0c0: 7769 6e64 6f77 0a20 2020 2020 2020 2077  window.        w
-0000d0d0: 696e 203d 206e 702e 6873 7461 636b 280a  in = np.hstack(.
-0000d0e0: 2020 2020 2020 2020 2020 2020 280a 2020              (.  
-0000d0f0: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-0000d100: 7065 725f 7369 6465 735b 3a77 6c65 6e5d  per_sides[:wlen]
-0000d110: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000d120: 2020 6e70 2e6f 6e65 7328 6e70 7473 202d    np.ones(npts -
-0000d130: 2032 202a 2077 6c65 6e29 2c0a 2020 2020   2 * wlen),.    
-0000d140: 2020 2020 2020 2020 2020 2020 7461 7065              tape
-0000d150: 725f 7369 6465 735b 6c65 6e28 7461 7065  r_sides[len(tape
-0000d160: 725f 7369 6465 7329 202d 2077 6c65 6e20  r_sides) - wlen 
-0000d170: 3a5d 2c0a 2020 2020 2020 2020 2020 2020  :],.            
-0000d180: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-0000d190: 2020 2020 666f 7220 6969 2069 6e20 7261      for ii in ra
-0000d1a0: 6e67 6528 6461 7461 2e73 6861 7065 5b30  nge(data.shape[0
-0000d1b0: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
-0000d1c0: 6461 7461 5b69 695d 202a 3d20 7769 6e0a  data[ii] *= win.
-0000d1d0: 2020 2020 7265 7475 726e 2064 6174 610a      return data.
-0000d1e0: 0a0a 2320 406a 6974 286e 6f70 7974 686f  ..# @jit(nopytho
-0000d1f0: 6e20 3d20 5472 7565 290a 0a0a 2320 6368  n = True)...# ch
-0000d200: 616e 6765 2074 6865 206d 6f76 696e 6720  ange the moving 
-0000d210: 6176 6572 6167 6520 6361 6c63 756c 6174  average calculat
-0000d220: 696f 6e20 746f 2074 616b 6520 6173 2069  ion to take as i
-0000d230: 6e70 7574 204e 2074 6865 2066 756c 6c20  nput N the full 
-0000d240: 7769 6e64 6f77 206c 656e 6774 6820 746f  window length to
-0000d250: 2073 6d6f 6f74 680a 6465 6620 6d6f 7669   smooth.def movi
-0000d260: 6e67 5f61 7665 2841 2c20 4e29 3a0a 2020  ng_ave(A, N):.  
-0000d270: 2020 2222 220a 2020 2020 416c 7465 726e    """.    Altern
-0000d280: 6174 6976 6520 6675 6e63 7469 6f6e 2066  ative function f
-0000d290: 6f72 206d 6f76 696e 6720 6176 6572 6167  or moving averag
-0000d2a0: 6520 666f 7220 616e 2061 7272 6179 2e0a  e for an array..
-0000d2b0: 2020 2020 5041 5241 4d45 5445 5253 3a0a      PARAMETERS:.
-0000d2c0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
-0000d2d0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 413a  ---------.    A:
-0000d2e0: 2031 2d44 2061 7272 6179 206f 6620 6461   1-D array of da
-0000d2f0: 7461 2074 6f20 6265 2073 6d6f 6f74 6865  ta to be smoothe
-0000d300: 640a 2020 2020 4e3a 2069 6e74 6567 6572  d.    N: integer
-0000d310: 2c20 6974 2064 6566 696e 6573 2074 6865  , it defines the
-0000d320: 2066 756c 6c21 2120 7769 6e64 6f77 206c   full!! window l
-0000d330: 656e 6774 6820 746f 2073 6d6f 6f74 680a  ength to smooth.
-0000d340: 2020 2020 5245 5455 524e 533a 0a20 2020      RETURNS:.   
-0000d350: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
-0000d360: 2d2d 2d2d 2d2d 0a20 2020 2042 3a20 312d  ------.    B: 1-
-0000d370: 4420 6172 7261 7920 7769 7468 2073 6d6f  D array with smo
-0000d380: 6f74 6865 6420 6461 7461 0a20 2020 2022  othed data.    "
-0000d390: 2222 0a20 2020 2023 2064 6566 696e 6573  "".    # defines
-0000d3a0: 2061 6e20 6172 7261 7920 7769 7468 204e   an array with N
-0000d3b0: 2065 7874 7261 2073 616d 706c 6573 2061   extra samples a
-0000d3c0: 7420 6569 7468 6572 2073 6964 650a 2020  t either side.  
-0000d3d0: 2020 7465 6d70 203d 206e 702e 7a65 726f    temp = np.zero
-0000d3e0: 7328 6c65 6e28 4129 202b 2032 202a 204e  s(len(A) + 2 * N
-0000d3f0: 290a 2020 2020 2320 7365 7420 7468 6520  ).    # set the 
-0000d400: 6365 6e74 7261 6c20 706f 7274 696f 6e20  central portion 
-0000d410: 6f66 2074 6865 2061 7272 6179 2074 6f20  of the array to 
-0000d420: 410a 2020 2020 7465 6d70 5b4e 3a2d 4e5d  A.    temp[N:-N]
-0000d430: 203d 2041 0a20 2020 2023 206c 6561 6469   = A.    # leadi
-0000d440: 6e67 2073 616d 706c 6573 3a20 6571 7561  ng samples: equa
-0000d450: 6c20 746f 2066 6972 7374 2073 616d 706c  l to first sampl
-0000d460: 6520 6f66 2061 6374 7561 6c20 6172 7261  e of actual arra
-0000d470: 790a 2020 2020 7465 6d70 5b30 3a4e 5d20  y.    temp[0:N] 
-0000d480: 3d20 7465 6d70 5b4e 5d0a 2020 2020 2320  = temp[N].    # 
-0000d490: 7472 6169 6c69 6e67 2073 616d 706c 6573  trailing samples
-0000d4a0: 3a20 4571 7561 6c20 746f 206c 6173 7420  : Equal to last 
-0000d4b0: 7361 6d70 6c65 206f 6620 6163 7475 616c  sample of actual
-0000d4c0: 2061 7272 6179 0a20 2020 2074 656d 705b   array.    temp[
-0000d4d0: 2d4e 3a5d 203d 2074 656d 705b 2d4e 202d  -N:] = temp[-N -
-0000d4e0: 2031 5d0a 2020 2020 2320 636f 6e76 6f6c   1].    # convol
-0000d4f0: 7665 2077 6974 6820 6120 626f 7863 6172  ve with a boxcar
-0000d500: 2061 6e64 206e 6f72 6d61 6c69 7a65 2c20   and normalize, 
-0000d510: 616e 6420 7573 6520 6f6e 6c79 2063 656e  and use only cen
-0000d520: 7472 616c 2070 6f72 7469 6f6e 206f 6620  tral portion of 
-0000d530: 7468 6520 7265 7375 6c74 0a20 2020 2023  the result.    #
-0000d540: 2077 6974 6820 6c65 6e67 7468 2065 7175   with length equ
-0000d550: 616c 2074 6f20 7468 6520 6f72 6967 696e  al to the origin
-0000d560: 616c 2061 7272 6179 2c20 6469 7363 6172  al array, discar
-0000d570: 6469 6e67 2074 6865 2061 6464 6564 206c  ding the added l
-0000d580: 6561 6469 6e67 2061 6e64 2074 7261 696c  eading and trail
-0000d590: 696e 6720 7361 6d70 6c65 730a 2020 2020  ing samples.    
-0000d5a0: 4220 3d20 6e70 2e63 6f6e 766f 6c76 6528  B = np.convolve(
-0000d5b0: 7465 6d70 2c20 6e70 2e6f 6e65 7328 4e29  temp, np.ones(N)
-0000d5c0: 202f 204e 2c20 6d6f 6465 3d22 7361 6d65   / N, mode="same
-0000d5d0: 2229 5b4e 3a2d 4e5d 0a20 2020 2072 6574  ")[N:-N].    ret
-0000d5e0: 7572 6e20 420a 0a0a 2320 6368 616e 6765  urn B...# change
-0000d5f0: 2074 6865 206d 6f76 696e 6720 6176 6572   the moving aver
-0000d600: 6167 6520 6361 6c63 756c 6174 696f 6e20  age calculation 
-0000d610: 746f 2074 616b 6520 6173 2069 6e70 7574  to take as input
-0000d620: 204e 2074 6865 2066 756c 6c20 7769 6e64   N the full wind
-0000d630: 6f77 206c 656e 6774 6820 746f 2073 6d6f  ow length to smo
-0000d640: 6f74 680a 6465 6620 6d6f 7669 6e67 5f61  oth.def moving_a
-0000d650: 7665 5f32 4428 412c 204e 293a 0a20 2020  ve_2D(A, N):.   
-0000d660: 2022 2222 0a20 2020 2041 6c74 6572 6e61   """.    Alterna
-0000d670: 7469 7665 2066 756e 6374 696f 6e20 666f  tive function fo
-0000d680: 7220 6d6f 7669 6e67 2061 7665 7261 6765  r moving average
-0000d690: 2066 6f72 2061 6e20 6172 7261 792e 0a20   for an array.. 
-0000d6a0: 2020 2050 4152 414d 4554 4552 533a 0a20     PARAMETERS:. 
-0000d6b0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
-0000d6c0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2041 3a20  --------.    A: 
-0000d6d0: 322d 4420 6172 7261 7920 6f66 2064 6174  2-D array of dat
-0000d6e0: 6120 746f 2062 6520 736d 6f6f 7468 6564  a to be smoothed
-0000d6f0: 0a20 2020 204e 3a20 696e 7465 6765 722c  .    N: integer,
-0000d700: 2069 7420 6465 6669 6e65 7320 7468 6520   it defines the 
-0000d710: 6675 6c6c 2121 2077 696e 646f 7720 6c65  full!! window le
-0000d720: 6e67 7468 2074 6f20 736d 6f6f 7468 0a20  ngth to smooth. 
-0000d730: 2020 2052 4554 5552 4e53 3a0a 2020 2020     RETURNS:.    
-0000d740: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000d750: 2d2d 2d2d 2d0a 2020 2020 423a 2032 2d44  -----.    B: 2-D
-0000d760: 2061 7272 6179 2077 6974 6820 736d 6f6f   array with smoo
-0000d770: 7468 6564 2064 6174 610a 2020 2020 2222  thed data.    ""
-0000d780: 220a 2020 2020 6e74 632c 206e 7370 7420  ".    ntc, nspt 
-0000d790: 3d20 412e 7368 6170 650a 2020 2020 2320  = A.shape.    # 
-0000d7a0: 6465 6669 6e65 7320 616e 2061 7272 6179  defines an array
-0000d7b0: 2077 6974 6820 4e20 6578 7472 6120 7361   with N extra sa
-0000d7c0: 6d70 6c65 7320 6174 2065 6974 6865 7220  mples at either 
-0000d7d0: 7369 6465 0a20 2020 2074 656d 7020 3d20  side.    temp = 
-0000d7e0: 6e70 2e7a 6572 6f73 285b 6e74 632c 206e  np.zeros([ntc, n
-0000d7f0: 7370 7420 2b20 3220 2a20 4e5d 290a 2020  spt + 2 * N]).  
-0000d800: 2020 2320 7365 7420 7468 6520 6365 6e74    # set the cent
-0000d810: 7261 6c20 706f 7274 696f 6e20 6f66 2074  ral portion of t
-0000d820: 6865 2061 7272 6179 2074 6f20 410a 2020  he array to A.  
-0000d830: 2020 7465 6d70 5b3a 2c20 4e3a 2d4e 5d20    temp[:, N:-N] 
-0000d840: 3d20 410a 2020 2020 2320 6c65 6164 696e  = A.    # leadin
-0000d850: 6720 7361 6d70 6c65 733a 2065 7175 616c  g samples: equal
-0000d860: 2074 6f20 6669 7273 7420 7361 6d70 6c65   to first sample
-0000d870: 206f 6620 6163 7475 616c 2061 7272 6179   of actual array
-0000d880: 0a20 2020 2074 656d 705b 3a2c 2030 3a4e  .    temp[:, 0:N
-0000d890: 5d20 3d20 6e70 2e72 6570 6561 7428 6e70  ] = np.repeat(np
-0000d8a0: 2e65 7870 616e 645f 6469 6d73 2874 656d  .expand_dims(tem
-0000d8b0: 705b 3a2c 204e 5d2c 2061 7869 733d 2d31  p[:, N], axis=-1
-0000d8c0: 292c 204e 2c20 6178 6973 3d2d 3129 0a20  ), N, axis=-1). 
-0000d8d0: 2020 2023 2074 7261 696c 696e 6720 7361     # trailing sa
-0000d8e0: 6d70 6c65 733a 2045 7175 616c 2074 6f20  mples: Equal to 
-0000d8f0: 6c61 7374 2073 616d 706c 6520 6f66 2061  last sample of a
-0000d900: 6374 7561 6c20 6172 7261 790a 2020 2020  ctual array.    
-0000d910: 7465 6d70 5b3a 2c20 2d4e 3a5d 203d 206e  temp[:, -N:] = n
-0000d920: 702e 7265 7065 6174 286e 702e 6578 7061  p.repeat(np.expa
-0000d930: 6e64 5f64 696d 7328 7465 6d70 5b3a 2c20  nd_dims(temp[:, 
-0000d940: 2d4e 202d 2031 5d2c 2061 7869 733d 2d31  -N - 1], axis=-1
-0000d950: 292c 204e 2c20 6178 6973 3d2d 3129 0a20  ), N, axis=-1). 
-0000d960: 2020 2023 2063 6f6e 766f 6c76 6520 7769     # convolve wi
-0000d970: 7468 2061 2062 6f78 6361 7220 616e 6420  th a boxcar and 
-0000d980: 6e6f 726d 616c 697a 652c 2061 6e64 2075  normalize, and u
-0000d990: 7365 206f 6e6c 7920 6365 6e74 7261 6c20  se only central 
-0000d9a0: 706f 7274 696f 6e20 6f66 2074 6865 2072  portion of the r
-0000d9b0: 6573 756c 740a 2020 2020 2320 7769 7468  esult.    # with
-0000d9c0: 206c 656e 6774 6820 6571 7561 6c20 746f   length equal to
-0000d9d0: 2074 6865 206f 7269 6769 6e61 6c20 6172   the original ar
-0000d9e0: 7261 792c 2064 6973 6361 7264 696e 6720  ray, discarding 
-0000d9f0: 7468 6520 6164 6465 6420 6c65 6164 696e  the added leadin
-0000da00: 6720 616e 6420 7472 6169 6c69 6e67 2073  g and trailing s
-0000da10: 616d 706c 6573 0a20 2020 2042 203d 2073  amples.    B = s
-0000da20: 6369 7079 2e73 6967 6e61 6c2e 636f 6e76  cipy.signal.conv
-0000da30: 6f6c 7665 3264 2874 656d 702c 206e 702e  olve2d(temp, np.
-0000da40: 6578 7061 6e64 5f64 696d 7328 6e70 2e6f  expand_dims(np.o
-0000da50: 6e65 7328 4e29 202f 204e 2c20 6178 6973  nes(N) / N, axis
-0000da60: 3d30 292c 206d 6f64 653d 2273 616d 6522  =0), mode="same"
-0000da70: 295b 3a2c 204e 3a2d 4e5d 0a20 2020 2072  )[:, N:-N].    r
-0000da80: 6574 7572 6e20 420a 0a0a 6465 6620 726f  eturn B...def ro
-0000da90: 6275 7374 5f73 7461 636b 2863 635f 6172  bust_stack(cc_ar
-0000daa0: 7261 792c 2065 7073 696c 6f6e 293a 0a20  ray, epsilon):. 
-0000dab0: 2020 2022 2222 0a20 2020 2074 6869 7320     """.    this 
-0000dac0: 6973 2061 2072 6f62 7573 7420 7374 6163  is a robust stac
-0000dad0: 6b69 6e67 2061 6c67 6f72 6974 686d 2064  king algorithm d
-0000dae0: 6573 6372 6962 6564 2069 6e20 5061 6c76  escribed in Palv
-0000daf0: 6973 2061 6e64 2056 6572 6e6f 6e20 3230  is and Vernon 20
-0000db00: 3130 0a0a 2020 2020 5041 5241 4d45 5445  10..    PARAMETE
-0000db10: 5253 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  RS:.    --------
-0000db20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
-0000db30: 2020 2063 635f 6172 7261 793a 206e 756d     cc_array: num
-0000db40: 7079 2e6e 6461 7272 6179 2063 6f6e 7461  py.ndarray conta
-0000db50: 696e 7320 7468 6520 3244 2063 726f 7373  ins the 2D cross
-0000db60: 2063 6f72 7265 6c61 7469 6f6e 206d 6174   correlation mat
-0000db70: 7269 780a 2020 2020 6570 7369 6c6f 6e3a  rix.    epsilon:
-0000db80: 2072 6573 6964 7561 6c20 7468 7265 686f   residual threho
-0000db90: 6c64 2074 6f20 7175 6974 2074 6865 2069  ld to quit the i
-0000dba0: 7465 7261 7469 6f6e 0a20 2020 2052 4554  teration.    RET
-0000dbb0: 5552 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d  URNS:.    ------
-0000dbc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000dbd0: 0a20 2020 206e 6577 7374 6163 6b3a 206e  .    newstack: n
-0000dbe0: 756d 7079 2076 6563 746f 7220 636f 6e74  umpy vector cont
-0000dbf0: 6169 6e73 2074 6865 2073 7461 636b 6564  ains the stacked
-0000dc00: 2063 726f 7373 2063 6f72 7265 6c61 7469   cross correlati
-0000dc10: 6f6e 0a0a 2020 2020 5772 6974 7465 6e20  on..    Written 
-0000dc20: 6279 204d 6172 696e 6520 4465 6e6f 6c6c  by Marine Denoll
-0000dc30: 650a 2020 2020 2222 220a 2020 2020 7265  e.    """.    re
-0000dc40: 7320 3d20 3965 3920 2023 2072 6573 6964  s = 9e9  # resid
-0000dc50: 7561 6c73 0a20 2020 2077 203d 206e 702e  uals.    w = np.
-0000dc60: 6f6e 6573 2863 635f 6172 7261 792e 7368  ones(cc_array.sh
-0000dc70: 6170 655b 305d 290a 2020 2020 6e73 7465  ape[0]).    nste
-0000dc80: 7020 3d20 300a 2020 2020 6e65 7773 7461  p = 0.    newsta
-0000dc90: 636b 203d 206e 702e 6d65 6469 616e 2863  ck = np.median(c
-0000dca0: 635f 6172 7261 792c 2061 7869 733d 3029  c_array, axis=0)
-0000dcb0: 0a20 2020 2077 6869 6c65 2072 6573 203e  .    while res >
-0000dcc0: 2065 7073 696c 6f6e 3a0a 2020 2020 2020   epsilon:.      
-0000dcd0: 2020 7374 6163 6b20 3d20 6e65 7773 7461    stack = newsta
-0000dce0: 636b 0a20 2020 2020 2020 2066 6f72 2069  ck.        for i
-0000dcf0: 2069 6e20 7261 6e67 6528 6363 5f61 7272   in range(cc_arr
-0000dd00: 6179 2e73 6861 7065 5b30 5d29 3a0a 2020  ay.shape[0]):.  
-0000dd10: 2020 2020 2020 2020 2020 6372 6170 203d            crap =
-0000dd20: 206e 702e 6d75 6c74 6970 6c79 2873 7461   np.multiply(sta
-0000dd30: 636b 2c20 6363 5f61 7272 6179 5b69 2c20  ck, cc_array[i, 
-0000dd40: 3a5d 2e54 290a 2020 2020 2020 2020 2020  :].T).          
-0000dd50: 2020 6372 6170 5f64 6f74 203d 206e 702e    crap_dot = np.
-0000dd60: 7375 6d28 6372 6170 290a 2020 2020 2020  sum(crap).      
-0000dd70: 2020 2020 2020 6469 5f6e 6f72 6d20 3d20        di_norm = 
-0000dd80: 6e70 2e6c 696e 616c 672e 6e6f 726d 2863  np.linalg.norm(c
-0000dd90: 635f 6172 7261 795b 692c 203a 5d29 0a20  c_array[i, :]). 
-0000dda0: 2020 2020 2020 2020 2020 2072 6920 3d20             ri = 
-0000ddb0: 6363 5f61 7272 6179 5b69 2c20 3a5d 202d  cc_array[i, :] -
-0000ddc0: 2063 7261 705f 646f 7420 2a20 7374 6163   crap_dot * stac
-0000ddd0: 6b0a 2020 2020 2020 2020 2020 2020 7269  k.            ri
-0000dde0: 5f6e 6f72 6d20 3d20 6e70 2e6c 696e 616c  _norm = np.linal
-0000ddf0: 672e 6e6f 726d 2872 6929 0a20 2020 2020  g.norm(ri).     
-0000de00: 2020 2020 2020 2077 5b69 5d20 3d20 6e70         w[i] = np
-0000de10: 2e61 6273 2863 7261 705f 646f 7429 202f  .abs(crap_dot) /
-0000de20: 2064 695f 6e6f 726d 202f 2072 695f 6e6f   di_norm / ri_no
-0000de30: 726d 2020 2320 2f6c 656e 2863 635f 6172  rm  # /len(cc_ar
-0000de40: 7261 795b 3a2c 315d 290a 2020 2020 2020  ray[:,1]).      
-0000de50: 2020 2320 7072 696e 7428 7729 0a20 2020    # print(w).   
-0000de60: 2020 2020 2077 203d 2077 202f 206e 702e       w = w / np.
-0000de70: 7375 6d28 7729 0a20 2020 2020 2020 206e  sum(w).        n
-0000de80: 6577 7374 6163 6b20 3d20 6e70 2e73 756d  ewstack = np.sum
-0000de90: 2828 7720 2a20 6363 5f61 7272 6179 2e54  ((w * cc_array.T
-0000dea0: 292e 542c 2061 7869 733d 3029 2020 2320  ).T, axis=0)  # 
-0000deb0: 2f6c 656e 2863 635f 6172 7261 795b 3a2c  /len(cc_array[:,
-0000dec0: 315d 290a 2020 2020 2020 2020 7265 7320  1]).        res 
-0000ded0: 3d20 6e70 2e6c 696e 616c 672e 6e6f 726d  = np.linalg.norm
-0000dee0: 286e 6577 7374 6163 6b20 2d20 7374 6163  (newstack - stac
-0000def0: 6b2c 206f 7264 3d31 2920 2f20 6e70 2e6c  k, ord=1) / np.l
-0000df00: 696e 616c 672e 6e6f 726d 286e 6577 7374  inalg.norm(newst
-0000df10: 6163 6b29 202f 206c 656e 2863 635f 6172  ack) / len(cc_ar
-0000df20: 7261 795b 3a2c 2031 5d29 0a20 2020 2020  ray[:, 1]).     
-0000df30: 2020 206e 7374 6570 202b 3d20 310a 2020     nstep += 1.  
-0000df40: 2020 2020 2020 6966 206e 7374 6570 203e        if nstep >
-0000df50: 2031 303a 0a20 2020 2020 2020 2020 2020   10:.           
-0000df60: 2072 6574 7572 6e20 6e65 7773 7461 636b   return newstack
-0000df70: 2c20 772c 206e 7374 6570 0a20 2020 2072  , w, nstep.    r
-0000df80: 6574 7572 6e20 6e65 7773 7461 636b 2c20  eturn newstack, 
-0000df90: 772c 206e 7374 6570 0a0a 0a64 6566 2073  w, nstep...def s
-0000dfa0: 656c 6563 7469 7665 5f73 7461 636b 2863  elective_stack(c
-0000dfb0: 635f 6172 7261 792c 2065 7073 696c 6f6e  c_array, epsilon
-0000dfc0: 293a 0a20 2020 2022 2222 0a20 2020 2074  ):.    """.    t
-0000dfd0: 6869 7320 6973 2061 2073 656c 6563 7469  his is a selecti
-0000dfe0: 7665 2073 7461 636b 696e 6720 616c 676f  ve stacking algo
-0000dff0: 7269 7468 6d20 6465 7665 6c6f 7065 6420  rithm developed 
-0000e000: 6279 204a 6172 6564 2042 7279 616e 2e0a  by Jared Bryan..
-0000e010: 0a20 2020 2050 4152 414d 4554 4552 533a  .    PARAMETERS:
-0000e020: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
-0000e030: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
-0000e040: 6363 5f61 7272 6179 3a20 6e75 6d70 792e  cc_array: numpy.
-0000e050: 6e64 6172 7261 7920 636f 6e74 6169 6e73  ndarray contains
-0000e060: 2074 6865 2032 4420 6372 6f73 7320 636f   the 2D cross co
-0000e070: 7272 656c 6174 696f 6e20 6d61 7472 6978  rrelation matrix
-0000e080: 0a20 2020 2065 7073 696c 6f6e 3a20 7265  .    epsilon: re
-0000e090: 7369 6475 616c 2074 6872 6568 6f6c 6420  sidual threhold 
-0000e0a0: 746f 2071 7569 7420 7468 6520 6974 6572  to quit the iter
-0000e0b0: 6174 696f 6e0a 2020 2020 5245 5455 524e  ation.    RETURN
-0000e0c0: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
-0000e0d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
-0000e0e0: 2020 6e65 7773 7461 636b 3a20 6e75 6d70    newstack: nump
-0000e0f0: 7920 7665 6374 6f72 2063 6f6e 7461 696e  y vector contain
-0000e100: 7320 7468 6520 7374 6163 6b65 6420 6372  s the stacked cr
-0000e110: 6f73 7320 636f 7272 656c 6174 696f 6e0a  oss correlation.
-0000e120: 0a20 2020 2057 7269 7474 656e 2062 7920  .    Written by 
-0000e130: 4d61 7269 6e65 2044 656e 6f6c 6c65 0a20  Marine Denolle. 
-0000e140: 2020 2022 2222 0a20 2020 2063 6320 3d20     """.    cc = 
-0000e150: 6e70 2e6f 6e65 7328 6363 5f61 7272 6179  np.ones(cc_array
-0000e160: 2e73 6861 7065 5b30 5d29 0a20 2020 206e  .shape[0]).    n
-0000e170: 6577 7374 6163 6b20 3d20 6e70 2e6d 6561  ewstack = np.mea
-0000e180: 6e28 6363 5f61 7272 6179 2c20 6178 6973  n(cc_array, axis
-0000e190: 3d30 290a 2020 2020 666f 7220 6920 696e  =0).    for i in
-0000e1a0: 2072 616e 6765 2863 635f 6172 7261 792e   range(cc_array.
-0000e1b0: 7368 6170 655b 305d 293a 0a20 2020 2020  shape[0]):.     
-0000e1c0: 2020 2063 635b 695d 203d 206e 702e 7375     cc[i] = np.su
-0000e1d0: 6d28 6e70 2e6d 756c 7469 706c 7928 6e65  m(np.multiply(ne
-0000e1e0: 7773 7461 636b 2c20 6363 5f61 7272 6179  wstack, cc_array
-0000e1f0: 5b69 2c20 3a5d 2e54 2929 0a20 2020 2069  [i, :].T)).    i
-0000e200: 6b20 3d20 6e70 2e77 6865 7265 2863 6320  k = np.where(cc 
-0000e210: 3e3d 2065 7073 696c 6f6e 295b 305d 0a20  >= epsilon)[0]. 
-0000e220: 2020 206e 6577 7374 6163 6b20 3d20 6e70     newstack = np
-0000e230: 2e6d 6561 6e28 6363 5f61 7272 6179 5b69  .mean(cc_array[i
-0000e240: 6b2c 203a 5d2c 2061 7869 733d 3029 0a0a  k, :], axis=0)..
-0000e250: 2020 2020 7265 7475 726e 206e 6577 7374      return newst
-0000e260: 6163 6b2c 2063 630a 0a0a 6465 6620 7768  ack, cc...def wh
-0000e270: 6974 656e 5f31 4428 7469 6d65 7365 7269  iten_1D(timeseri
-0000e280: 6573 2c20 6666 745f 7061 7261 2c20 6e5f  es, fft_para, n_
-0000e290: 7461 7065 7229 3a0a 2020 2020 2222 220a  taper):.    """.
-0000e2a0: 2020 2020 5468 6973 2066 756e 6374 696f      This functio
-0000e2b0: 6e20 7461 6b65 7320 6120 312d 6469 6d65  n takes a 1-dime
-0000e2c0: 6e73 696f 6e61 6c20 7469 6d65 7365 7269  nsional timeseri
-0000e2d0: 6573 2061 7272 6179 2c20 7472 616e 7366  es array, transf
-0000e2e0: 6f72 6d73 2074 6f20 6672 6571 7565 6e63  orms to frequenc
-0000e2f0: 7920 646f 6d61 696e 2075 7369 6e67 2066  y domain using f
-0000e300: 6674 2c0a 2020 2020 7768 6974 656e 7320  ft,.    whitens 
-0000e310: 7468 6520 616d 706c 6974 7564 6520 6f66  the amplitude of
-0000e320: 2074 6865 2073 7065 6374 7275 6d20 696e   the spectrum in
-0000e330: 2066 7265 7175 656e 6379 2064 6f6d 6169   frequency domai
-0000e340: 6e20 6265 7477 6565 6e20 2a66 7265 716d  n between *freqm
-0000e350: 696e 2a20 616e 6420 2a66 7265 716d 6178  in* and *freqmax
-0000e360: 2a0a 2020 2020 616e 6420 7265 7475 726e  *.    and return
-0000e370: 7320 7468 6520 7768 6974 656e 6564 2066  s the whitened f
-0000e380: 6674 2e0a 2020 2020 5041 5241 4d45 5445  ft..    PARAMETE
-0000e390: 5253 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  RS:.    --------
-0000e3a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
-0000e3b0: 2020 2064 6174 613a 206e 756d 7079 2e6e     data: numpy.n
-0000e3c0: 6461 7272 6179 2063 6f6e 7461 696e 7320  darray contains 
-0000e3d0: 7468 6520 3144 2074 696d 6520 7365 7269  the 1D time seri
-0000e3e0: 6573 2074 6f20 7768 6974 656e 0a20 2020  es to whiten.   
-0000e3f0: 2066 6674 5f70 6172 613a 2064 6963 7420   fft_para: dict 
-0000e400: 636f 6e74 6169 6e69 6e67 2061 6c6c 2066  containing all f
-0000e410: 6674 5f63 6320 7061 7261 6d65 7465 7273  ft_cc parameters
-0000e420: 2073 7563 6820 6173 0a20 2020 2020 2020   such as.       
-0000e430: 2064 743a 2054 6865 2073 616d 706c 696e   dt: The samplin
-0000e440: 6720 7370 6163 6520 6f66 2074 6865 2060  g space of the `
-0000e450: 6461 7461 600a 2020 2020 2020 2020 6672  data`.        fr
-0000e460: 6571 6d69 6e3a 2054 6865 206c 6f77 6572  eqmin: The lower
-0000e470: 2066 7265 7175 656e 6379 2062 6f75 6e64   frequency bound
-0000e480: 0a20 2020 2020 2020 2066 7265 716d 6178  .        freqmax
-0000e490: 3a20 5468 6520 7570 7065 7220 6672 6571  : The upper freq
-0000e4a0: 7565 6e63 7920 626f 756e 640a 2020 2020  uency bound.    
-0000e4b0: 2020 2020 736d 6f6f 7468 5f4e 3a20 696e      smooth_N: in
-0000e4c0: 7465 6765 722c 2069 7420 6465 6669 6e65  teger, it define
-0000e4d0: 7320 7468 6520 6861 6c66 2077 696e 646f  s the half windo
-0000e4e0: 7720 6c65 6e67 7468 2074 6f20 736d 6f6f  w length to smoo
-0000e4f0: 7468 0a20 2020 2020 2020 206e 5f74 6170  th.        n_tap
-0000e500: 6572 2c20 6f70 7469 6f6e 616c 3a20 696e  er, optional: in
-0000e510: 7465 6765 722c 2064 6566 696e 6520 7468  teger, define th
-0000e520: 6520 7769 6474 6820 6f66 2074 6865 2074  e width of the t
-0000e530: 6170 6572 2069 6e20 7361 6d70 6c65 730a  aper in samples.
-0000e540: 2020 2020 5245 5455 524e 533a 0a20 2020      RETURNS:.   
-0000e550: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
-0000e560: 2d2d 2d2d 2d2d 2d0a 2020 2020 4646 5452  -------.    FFTR
-0000e570: 6177 5369 676e 3a20 6e75 6d70 792e 6e64  awSign: numpy.nd
-0000e580: 6172 7261 7920 636f 6e74 6169 6e73 2074  array contains t
-0000e590: 6865 2046 4654 206f 6620 7468 6520 7768  he FFT of the wh
-0000e5a0: 6974 656e 6564 2069 6e70 7574 2074 7261  itened input tra
-0000e5b0: 6365 2062 6574 7765 656e 2074 6865 2066  ce between the f
-0000e5c0: 7265 7175 656e 6379 2062 6f75 6e64 730a  requency bounds.
-0000e5d0: 2020 2020 2222 220a 2020 2020 2320 6c6f      """.    # lo
-0000e5e0: 6164 2070 6172 616d 6574 6572 730a 2020  ad parameters.  
-0000e5f0: 2020 6465 6c74 6120 3d20 6666 745f 7061    delta = fft_pa
-0000e600: 7261 5b22 6474 225d 0a20 2020 2066 7265  ra["dt"].    fre
-0000e610: 716d 696e 203d 2066 6674 5f70 6172 615b  qmin = fft_para[
-0000e620: 2266 7265 716d 696e 225d 0a20 2020 2066  "freqmin"].    f
-0000e630: 7265 716d 6178 203d 2066 6674 5f70 6172  reqmax = fft_par
-0000e640: 615b 2266 7265 716d 6178 225d 0a20 2020  a["freqmax"].   
-0000e650: 2073 6d6f 6f74 685f 4e20 3d20 6666 745f   smooth_N = fft_
-0000e660: 7061 7261 5b22 736d 6f6f 7468 5f4e 225d  para["smooth_N"]
-0000e670: 0a0a 2020 2020 6e66 6674 203d 206e 6578  ..    nfft = nex
-0000e680: 745f 6661 7374 5f6c 656e 286c 656e 2874  t_fast_len(len(t
-0000e690: 696d 6573 6572 6965 7329 290a 2020 2020  imeseries)).    
-0000e6a0: 7370 6563 203d 206e 702e 6666 742e 6666  spec = np.fft.ff
-0000e6b0: 7428 7469 6d65 7365 7269 6573 2c20 6e66  t(timeseries, nf
-0000e6c0: 6674 290a 2020 2020 6672 6571 203d 206e  ft).    freq = n
-0000e6d0: 702e 6666 742e 6666 7466 7265 7128 6e66  p.fft.fftfreq(nf
-0000e6e0: 6674 2c20 643d 6465 6c74 6129 0a0a 2020  ft, d=delta)..  
-0000e6f0: 2020 6978 3020 3d20 6e70 2e61 7267 6d69    ix0 = np.argmi
-0000e700: 6e28 6e70 2e61 6273 2866 7265 7120 2d20  n(np.abs(freq - 
-0000e710: 6672 6571 6d69 6e29 290a 2020 2020 6978  freqmin)).    ix
-0000e720: 3120 3d20 6e70 2e61 7267 6d69 6e28 6e70  1 = np.argmin(np
-0000e730: 2e61 6273 2866 7265 7120 2d20 6672 6571  .abs(freq - freq
-0000e740: 6d61 7829 290a 0a20 2020 2069 6620 6978  max))..    if ix
-0000e750: 3120 2b20 6e5f 7461 7065 7220 3e20 6e66  1 + n_taper > nf
-0000e760: 6674 3a0a 2020 2020 2020 2020 6978 3131  ft:.        ix11
-0000e770: 203d 206e 6666 740a 2020 2020 656c 7365   = nfft.    else
-0000e780: 3a0a 2020 2020 2020 2020 6978 3131 203d  :.        ix11 =
-0000e790: 2069 7831 202b 206e 5f74 6170 6572 0a0a   ix1 + n_taper..
-0000e7a0: 2020 2020 6966 2069 7830 202d 206e 5f74      if ix0 - n_t
-0000e7b0: 6170 6572 203c 2030 3a0a 2020 2020 2020  aper < 0:.      
-0000e7c0: 2020 6978 3030 203d 2030 0a20 2020 2065    ix00 = 0.    e
-0000e7d0: 6c73 653a 0a20 2020 2020 2020 2069 7830  lse:.        ix0
-0000e7e0: 3020 3d20 6978 3020 2d20 6e5f 7461 7065  0 = ix0 - n_tape
-0000e7f0: 720a 0a20 2020 2073 7065 635f 6f75 7420  r..    spec_out 
-0000e800: 3d20 7370 6563 2e63 6f70 7928 290a 2020  = spec.copy().  
-0000e810: 2020 7370 6563 5f6f 7574 5b30 3a69 7830    spec_out[0:ix0
-0000e820: 305d 203d 2030 2e30 202b 2030 2e30 6a0a  0] = 0.0 + 0.0j.
-0000e830: 2020 2020 7370 6563 5f6f 7574 5b69 7831      spec_out[ix1
-0000e840: 313a 5d20 3d20 302e 3020 2b20 302e 306a  1:] = 0.0 + 0.0j
-0000e850: 0a0a 2020 2020 6966 2073 6d6f 6f74 685f  ..    if smooth_
-0000e860: 4e20 3c3d 2031 3a0a 2020 2020 2020 2020  N <= 1:.        
-0000e870: 7370 6563 5f6f 7574 5b69 7830 303a 6978  spec_out[ix00:ix
-0000e880: 3131 5d20 3d20 6e70 2e65 7870 2831 2e30  11] = np.exp(1.0
-0000e890: 6a20 2a20 6e70 2e61 6e67 6c65 2873 7065  j * np.angle(spe
-0000e8a0: 635f 6f75 745b 6978 3030 3a69 7831 315d  c_out[ix00:ix11]
-0000e8b0: 2929 0a20 2020 2065 6c73 653a 0a20 2020  )).    else:.   
-0000e8c0: 2020 2020 2073 7065 635f 6f75 745b 6978       spec_out[ix
-0000e8d0: 3030 3a69 7831 315d 202f 3d20 6d6f 7669  00:ix11] /= movi
-0000e8e0: 6e67 5f61 7665 286e 702e 6162 7328 7370  ng_ave(np.abs(sp
-0000e8f0: 6563 5f6f 7574 5b69 7830 303a 6978 3131  ec_out[ix00:ix11
-0000e900: 5d29 2c20 736d 6f6f 7468 5f4e 290a 0a20  ]), smooth_N).. 
-0000e910: 2020 2078 203d 206e 702e 6c69 6e73 7061     x = np.linspa
-0000e920: 6365 286e 702e 7069 202f 2032 2e30 2c20  ce(np.pi / 2.0, 
-0000e930: 6e70 2e70 692c 2069 7830 202d 2069 7830  np.pi, ix0 - ix0
-0000e940: 3029 0a20 2020 2073 7065 635f 6f75 745b  0).    spec_out[
-0000e950: 6978 3030 3a69 7830 5d20 2a3d 206e 702e  ix00:ix0] *= np.
-0000e960: 636f 7328 7829 202a 2a20 320a 0a20 2020  cos(x) ** 2..   
-0000e970: 2078 203d 206e 702e 6c69 6e73 7061 6365   x = np.linspace
-0000e980: 2830 2e30 2c20 6e70 2e70 6920 2f20 322e  (0.0, np.pi / 2.
-0000e990: 302c 2069 7831 3120 2d20 6978 3129 0a20  0, ix11 - ix1). 
-0000e9a0: 2020 2073 7065 635f 6f75 745b 6978 313a     spec_out[ix1:
-0000e9b0: 6978 3131 5d20 2a3d 206e 702e 636f 7328  ix11] *= np.cos(
-0000e9c0: 7829 202a 2a20 320a 0a20 2020 2072 6574  x) ** 2..    ret
-0000e9d0: 7572 6e20 7370 6563 5f6f 7574 0a0a 0a64  urn spec_out...d
-0000e9e0: 6566 2077 6869 7465 6e5f 3244 2874 696d  ef whiten_2D(tim
-0000e9f0: 6573 6572 6965 732c 2066 6674 5f70 6172  eseries, fft_par
-0000ea00: 612c 206e 5f74 6170 6572 293a 0a20 2020  a, n_taper):.   
-0000ea10: 2022 2222 0a20 2020 2054 6869 7320 6675   """.    This fu
-0000ea20: 6e63 7469 6f6e 2074 616b 6573 2061 2032  nction takes a 2
-0000ea30: 2d64 696d 656e 7369 6f6e 616c 2074 696d  -dimensional tim
-0000ea40: 6573 6572 6965 7320 6172 7261 792c 2074  eseries array, t
-0000ea50: 7261 6e73 666f 726d 7320 746f 2066 7265  ransforms to fre
-0000ea60: 7175 656e 6379 2064 6f6d 6169 6e20 7573  quency domain us
-0000ea70: 696e 6720 6666 742c 0a20 2020 2077 6869  ing fft,.    whi
-0000ea80: 7465 6e73 2074 6865 2061 6d70 6c69 7475  tens the amplitu
-0000ea90: 6465 206f 6620 7468 6520 7370 6563 7472  de of the spectr
-0000eaa0: 756d 2069 6e20 6672 6571 7565 6e63 7920  um in frequency 
-0000eab0: 646f 6d61 696e 2062 6574 7765 656e 202a  domain between *
-0000eac0: 6672 6571 6d69 6e2a 2061 6e64 202a 6672  freqmin* and *fr
-0000ead0: 6571 6d61 782a 0a20 2020 2061 6e64 2072  eqmax*.    and r
-0000eae0: 6574 7572 6e73 2074 6865 2077 6869 7465  eturns the white
-0000eaf0: 6e65 6420 6666 742e 0a20 2020 2050 4152  ned fft..    PAR
-0000eb00: 414d 4554 4552 533a 0a20 2020 202d 2d2d  AMETERS:.    ---
-0000eb10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000eb20: 2d2d 2d0a 2020 2020 6461 7461 3a20 6e75  ---.    data: nu
-0000eb30: 6d70 792e 6e64 6172 7261 7920 636f 6e74  mpy.ndarray cont
-0000eb40: 6169 6e73 2074 6865 2031 4420 7469 6d65  ains the 1D time
-0000eb50: 2073 6572 6965 7320 746f 2077 6869 7465   series to white
-0000eb60: 6e0a 2020 2020 6666 745f 7061 7261 3a20  n.    fft_para: 
-0000eb70: 6469 6374 2063 6f6e 7461 696e 696e 6720  dict containing 
-0000eb80: 616c 6c20 6666 745f 6363 2070 6172 616d  all fft_cc param
-0000eb90: 6574 6572 7320 7375 6368 2061 730a 2020  eters such as.  
-0000eba0: 2020 2020 2020 6474 3a20 5468 6520 7361        dt: The sa
-0000ebb0: 6d70 6c69 6e67 2073 7061 6365 206f 6620  mpling space of 
-0000ebc0: 7468 6520 6064 6174 6160 0a20 2020 2020  the `data`.     
-0000ebd0: 2020 2066 7265 716d 696e 3a20 5468 6520     freqmin: The 
-0000ebe0: 6c6f 7765 7220 6672 6571 7565 6e63 7920  lower frequency 
-0000ebf0: 626f 756e 640a 2020 2020 2020 2020 6672  bound.        fr
-0000ec00: 6571 6d61 783a 2054 6865 2075 7070 6572  eqmax: The upper
-0000ec10: 2066 7265 7175 656e 6379 2062 6f75 6e64   frequency bound
-0000ec20: 0a20 2020 2020 2020 2073 6d6f 6f74 685f  .        smooth_
-0000ec30: 4e3a 2069 6e74 6567 6572 2c20 6974 2064  N: integer, it d
-0000ec40: 6566 696e 6573 2074 6865 2068 616c 6620  efines the half 
-0000ec50: 7769 6e64 6f77 206c 656e 6774 6820 746f  window length to
-0000ec60: 2073 6d6f 6f74 680a 2020 2020 2020 2020   smooth.        
-0000ec70: 6e5f 7461 7065 722c 206f 7074 696f 6e61  n_taper, optiona
-0000ec80: 6c3a 2069 6e74 6567 6572 2c20 6465 6669  l: integer, defi
-0000ec90: 6e65 2074 6865 2077 6964 7468 206f 6620  ne the width of 
-0000eca0: 7468 6520 7461 7065 7220 696e 2073 616d  the taper in sam
-0000ecb0: 706c 6573 0a20 2020 2052 4554 5552 4e53  ples.    RETURNS
-0000ecc0: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
-0000ecd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
-0000ece0: 2046 4654 5261 7753 6967 6e3a 206e 756d   FFTRawSign: num
-0000ecf0: 7079 2e6e 6461 7272 6179 2063 6f6e 7461  py.ndarray conta
-0000ed00: 696e 7320 7468 6520 4646 5420 6f66 2074  ins the FFT of t
-0000ed10: 6865 2077 6869 7465 6e65 6420 696e 7075  he whitened inpu
-0000ed20: 7420 7472 6163 6520 6265 7477 6565 6e20  t trace between 
-0000ed30: 7468 6520 6672 6571 7565 6e63 7920 626f  the frequency bo
-0000ed40: 756e 6473 0a20 2020 2022 2222 0a20 2020  unds.    """.   
-0000ed50: 2023 206c 6f61 6420 7061 7261 6d65 7465   # load paramete
-0000ed60: 7273 0a20 2020 2064 656c 7461 203d 2066  rs.    delta = f
-0000ed70: 6674 5f70 6172 615b 2264 7422 5d0a 2020  ft_para["dt"].  
-0000ed80: 2020 6672 6571 6d69 6e20 3d20 6666 745f    freqmin = fft_
-0000ed90: 7061 7261 5b22 6672 6571 6d69 6e22 5d0a  para["freqmin"].
-0000eda0: 2020 2020 6672 6571 6d61 7820 3d20 6666      freqmax = ff
-0000edb0: 745f 7061 7261 5b22 6672 6571 6d61 7822  t_para["freqmax"
-0000edc0: 5d0a 2020 2020 736d 6f6f 7468 5f4e 203d  ].    smooth_N =
-0000edd0: 2066 6674 5f70 6172 615b 2273 6d6f 6f74   fft_para["smoot
-0000ede0: 685f 4e22 5d0a 0a20 2020 206e 6666 7420  h_N"]..    nfft 
-0000edf0: 3d20 6e65 7874 5f66 6173 745f 6c65 6e28  = next_fast_len(
-0000ee00: 7469 6d65 7365 7269 6573 2e73 6861 7065  timeseries.shape
-0000ee10: 5b31 5d29 0a20 2020 2073 7065 6320 3d20  [1]).    spec = 
-0000ee20: 6e70 2e66 6674 2e66 6674 6e28 7469 6d65  np.fft.fftn(time
-0000ee30: 7365 7269 6573 2c20 733d 5b6e 6666 745d  series, s=[nfft]
-0000ee40: 290a 2020 2020 6672 6571 203d 206e 702e  ).    freq = np.
-0000ee50: 6666 742e 6666 7466 7265 7128 6e66 6674  fft.fftfreq(nfft
-0000ee60: 2c20 643d 6465 6c74 6129 0a0a 2020 2020  , d=delta)..    
-0000ee70: 6978 3020 3d20 6e70 2e61 7267 6d69 6e28  ix0 = np.argmin(
-0000ee80: 6e70 2e61 6273 2866 7265 7120 2d20 6672  np.abs(freq - fr
-0000ee90: 6571 6d69 6e29 290a 2020 2020 6978 3120  eqmin)).    ix1 
-0000eea0: 3d20 6e70 2e61 7267 6d69 6e28 6e70 2e61  = np.argmin(np.a
-0000eeb0: 6273 2866 7265 7120 2d20 6672 6571 6d61  bs(freq - freqma
-0000eec0: 7829 290a 0a20 2020 2069 6620 6978 3120  x))..    if ix1 
-0000eed0: 2b20 6e5f 7461 7065 7220 3e20 6e66 6674  + n_taper > nfft
-0000eee0: 3a0a 2020 2020 2020 2020 6978 3131 203d  :.        ix11 =
-0000eef0: 206e 6666 740a 2020 2020 656c 7365 3a0a   nfft.    else:.
-0000ef00: 2020 2020 2020 2020 6978 3131 203d 2069          ix11 = i
-0000ef10: 7831 202b 206e 5f74 6170 6572 0a0a 2020  x1 + n_taper..  
-0000ef20: 2020 6966 2069 7830 202d 206e 5f74 6170    if ix0 - n_tap
-0000ef30: 6572 203c 2030 3a0a 2020 2020 2020 2020  er < 0:.        
-0000ef40: 6978 3030 203d 2030 0a20 2020 2065 6c73  ix00 = 0.    els
-0000ef50: 653a 0a20 2020 2020 2020 2069 7830 3020  e:.        ix00 
-0000ef60: 3d20 6978 3020 2d20 6e5f 7461 7065 720a  = ix0 - n_taper.
-0000ef70: 0a20 2020 2073 7065 635f 6f75 7420 3d20  .    spec_out = 
-0000ef80: 7370 6563 2e63 6f70 7928 2920 2023 206d  spec.copy()  # m
-0000ef90: 6179 2062 6520 696e 636f 6e76 656e 6965  ay be inconvenie
-0000efa0: 6e74 2064 7565 2074 6f20 6869 6768 6572  nt due to higher
-0000efb0: 206d 656d 6f72 7920 7573 6167 650a 2020   memory usage.  
-0000efc0: 2020 7370 6563 5f6f 7574 5b3a 2c20 303a    spec_out[:, 0:
-0000efd0: 6978 3030 5d20 3d20 302e 3020 2b20 302e  ix00] = 0.0 + 0.
-0000efe0: 306a 0a20 2020 2073 7065 635f 6f75 745b  0j.    spec_out[
-0000eff0: 3a2c 2069 7831 313a 5d20 3d20 302e 3020  :, ix11:] = 0.0 
-0000f000: 2b20 302e 306a 0a0a 2020 2020 6966 2073  + 0.0j..    if s
-0000f010: 6d6f 6f74 685f 4e20 3c3d 2031 3a0a 2020  mooth_N <= 1:.  
-0000f020: 2020 2020 2020 7370 6563 5f6f 7574 5b3a        spec_out[:
-0000f030: 2c20 6978 3030 3a69 7831 315d 203d 206e  , ix00:ix11] = n
-0000f040: 702e 6578 7028 312e 306a 202a 206e 702e  p.exp(1.0j * np.
-0000f050: 616e 676c 6528 7370 6563 5f6f 7574 5b3a  angle(spec_out[:
-0000f060: 2c20 6978 3030 3a69 7831 315d 2929 0a20  , ix00:ix11])). 
-0000f070: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000f080: 2073 7065 635f 6f75 745b 3a2c 2069 7830   spec_out[:, ix0
-0000f090: 303a 6978 3131 5d20 2f3d 206d 6f76 696e  0:ix11] /= movin
-0000f0a0: 675f 6176 655f 3244 286e 702e 6162 7328  g_ave_2D(np.abs(
-0000f0b0: 7370 6563 5f6f 7574 5b3a 2c20 6978 3030  spec_out[:, ix00
-0000f0c0: 3a69 7831 315d 292c 2073 6d6f 6f74 685f  :ix11]), smooth_
-0000f0d0: 4e29 0a0a 2020 2020 7820 3d20 6e70 2e6c  N)..    x = np.l
-0000f0e0: 696e 7370 6163 6528 6e70 2e70 6920 2f20  inspace(np.pi / 
-0000f0f0: 322e 302c 206e 702e 7069 2c20 6978 3020  2.0, np.pi, ix0 
-0000f100: 2d20 6978 3030 290a 2020 2020 7370 6563  - ix00).    spec
-0000f110: 5f6f 7574 5b3a 2c20 6978 3030 3a69 7830  _out[:, ix00:ix0
-0000f120: 5d20 2a3d 206e 702e 636f 7328 7829 202a  ] *= np.cos(x) *
-0000f130: 2a20 320a 0a20 2020 2078 203d 206e 702e  * 2..    x = np.
-0000f140: 6c69 6e73 7061 6365 2830 2e30 2c20 6e70  linspace(0.0, np
-0000f150: 2e70 6920 2f20 322e 302c 2069 7831 3120  .pi / 2.0, ix11 
-0000f160: 2d20 6978 3129 0a20 2020 2073 7065 635f  - ix1).    spec_
-0000f170: 6f75 745b 3a2c 2069 7831 3a69 7831 315d  out[:, ix1:ix11]
-0000f180: 202a 3d20 6e70 2e63 6f73 2878 2920 2a2a   *= np.cos(x) **
-0000f190: 2032 0a0a 2020 2020 7265 7475 726e 2073   2..    return s
-0000f1a0: 7065 635f 6f75 740a 0a0a 6465 6620 7768  pec_out...def wh
-0000f1b0: 6974 656e 2864 6174 612c 2066 6674 5f70  iten(data, fft_p
-0000f1c0: 6172 612c 206e 5f74 6170 6572 3d31 3030  ara, n_taper=100
-0000f1d0: 293a 0a20 2020 2022 2222 0a20 2020 2054  ):.    """.    T
-0000f1e0: 6869 7320 6675 6e63 7469 6f6e 2074 616b  his function tak
-0000f1f0: 6573 2061 2074 696d 6573 6572 6965 7320  es a timeseries 
-0000f200: 6172 7261 792c 2074 7261 6e73 666f 726d  array, transform
-0000f210: 7320 746f 2066 7265 7175 656e 6379 2064  s to frequency d
-0000f220: 6f6d 6169 6e20 7573 696e 6720 6666 742c  omain using fft,
-0000f230: 0a20 2020 2077 6869 7465 6e73 2074 6865  .    whitens the
-0000f240: 2061 6d70 6c69 7475 6465 206f 6620 7468   amplitude of th
-0000f250: 6520 7370 6563 7472 756d 2069 6e20 6672  e spectrum in fr
-0000f260: 6571 7565 6e63 7920 646f 6d61 696e 2062  equency domain b
-0000f270: 6574 7765 656e 202a 6672 6571 6d69 6e2a  etween *freqmin*
-0000f280: 2061 6e64 202a 6672 6571 6d61 782a 0a20   and *freqmax*. 
-0000f290: 2020 2061 6e64 2072 6574 7572 6e73 2074     and returns t
-0000f2a0: 6865 2077 6869 7465 6e65 6420 6666 742e  he whitened fft.
-0000f2b0: 0a20 2020 2050 4152 414d 4554 4552 533a  .    PARAMETERS:
-0000f2c0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
-0000f2d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
-0000f2e0: 6461 7461 3a20 6e75 6d70 792e 6e64 6172  data: numpy.ndar
-0000f2f0: 7261 7920 636f 6e74 6169 6e73 2074 6865  ray contains the
-0000f300: 2031 4420 7469 6d65 2073 6572 6965 7320   1D time series 
-0000f310: 746f 2077 6869 7465 6e0a 2020 2020 6666  to whiten.    ff
-0000f320: 745f 7061 7261 3a20 6469 6374 2063 6f6e  t_para: dict con
-0000f330: 7461 696e 696e 6720 616c 6c20 6666 745f  taining all fft_
-0000f340: 6363 2070 6172 616d 6574 6572 7320 7375  cc parameters su
-0000f350: 6368 2061 730a 2020 2020 2020 2020 6474  ch as.        dt
-0000f360: 3a20 5468 6520 7361 6d70 6c69 6e67 2073  : The sampling s
-0000f370: 7061 6365 206f 6620 7468 6520 6064 6174  pace of the `dat
-0000f380: 6160 0a20 2020 2020 2020 2066 7265 716d  a`.        freqm
-0000f390: 696e 3a20 5468 6520 6c6f 7765 7220 6672  in: The lower fr
-0000f3a0: 6571 7565 6e63 7920 626f 756e 640a 2020  equency bound.  
-0000f3b0: 2020 2020 2020 6672 6571 6d61 783a 2054        freqmax: T
-0000f3c0: 6865 2075 7070 6572 2066 7265 7175 656e  he upper frequen
-0000f3d0: 6379 2062 6f75 6e64 0a20 2020 2020 2020  cy bound.       
-0000f3e0: 2073 6d6f 6f74 685f 4e3a 2069 6e74 6567   smooth_N: integ
-0000f3f0: 6572 2c20 6974 2064 6566 696e 6573 2074  er, it defines t
-0000f400: 6865 2068 616c 6620 7769 6e64 6f77 206c  he half window l
-0000f410: 656e 6774 6820 746f 2073 6d6f 6f74 680a  ength to smooth.
-0000f420: 2020 2020 2020 2020 6672 6571 5f6e 6f72          freq_nor
-0000f430: 6d3a 2077 6869 7465 6e69 6e67 206d 6574  m: whitening met
-0000f440: 686f 6420 6265 7477 6565 6e20 276f 6e65  hod between 'one
-0000f450: 2d62 6974 2720 616e 6420 2752 4d41 270a  -bit' and 'RMA'.
-0000f460: 2020 2020 5245 5455 524e 533a 0a20 2020      RETURNS:.   
-0000f470: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
-0000f480: 2d2d 2d2d 2d2d 2d0a 2020 2020 4646 5452  -------.    FFTR
-0000f490: 6177 5369 676e 3a20 6e75 6d70 792e 6e64  awSign: numpy.nd
-0000f4a0: 6172 7261 7920 636f 6e74 6169 6e73 2074  array contains t
-0000f4b0: 6865 2046 4654 206f 6620 7468 6520 7768  he FFT of the wh
-0000f4c0: 6974 656e 6564 2069 6e70 7574 2074 7261  itened input tra
-0000f4d0: 6365 2062 6574 7765 656e 2074 6865 2066  ce between the f
-0000f4e0: 7265 7175 656e 6379 2062 6f75 6e64 730a  requency bounds.
-0000f4f0: 2020 2020 2222 220a 0a20 2020 2023 2053      """..    # S
-0000f500: 7065 6564 2075 7020 4646 5420 6279 2070  peed up FFT by p
-0000f510: 6164 6469 6e67 2074 6f20 6f70 7469 6d61  adding to optima
-0000f520: 6c20 7369 7a65 2066 6f72 2046 4654 5041  l size for FFTPA
-0000f530: 434b 0a20 2020 2069 6620 6461 7461 2e6e  CK.    if data.n
-0000f540: 6469 6d20 3d3d 2031 3a0a 2020 2020 2020  dim == 1:.      
-0000f550: 2020 4646 5452 6177 5369 676e 203d 2077    FFTRawSign = w
-0000f560: 6869 7465 6e5f 3144 2864 6174 612c 2066  hiten_1D(data, f
-0000f570: 6674 5f70 6172 612c 206e 5f74 6170 6572  ft_para, n_taper
-0000f580: 290a 2020 2020 2020 2020 2320 4152 525f  ).        # ARR_
-0000f590: 4f55 543a 204f 6e6c 7920 666f 7220 636f  OUT: Only for co
-0000f5a0: 6e73 6973 7465 6e63 7920 7769 7468 206e  nsistency with n
-0000f5b0: 6f69 7365 7079 2061 7070 726f 6163 6820  oisepy approach 
-0000f5c0: 6f66 2068 6f6c 6469 6e67 2074 6865 2066  of holding the f
-0000f5d0: 756c 6c0a 2020 2020 2020 2020 2320 7370  ull.        # sp
-0000f5e0: 6563 7472 756d 2028 6e6f 7420 6a75 7374  ectrum (not just
-0000f5f0: 2030 2061 6e64 2070 6f73 6974 6976 6520   0 and positive 
-0000f600: 6672 6571 2e20 7061 7274 290a 2020 2020  freq. part).    
-0000f610: 2020 2020 6172 725f 6f75 7420 3d20 6e70      arr_out = np
-0000f620: 2e7a 6572 6f73 2828 4646 5452 6177 5369  .zeros((FFTRawSi
-0000f630: 676e 2e73 6861 7065 5b30 5d20 2d20 3129  gn.shape[0] - 1)
-0000f640: 202a 2032 202b 2031 2c20 6474 7970 653d   * 2 + 1, dtype=
-0000f650: 636f 6d70 6c65 7829 0a20 2020 2020 2020  complex).       
-0000f660: 2061 7272 5f6f 7574 5b30 203a 2046 4654   arr_out[0 : FFT
-0000f670: 5261 7753 6967 6e2e 7368 6170 655b 305d  RawSign.shape[0]
-0000f680: 5d20 3d20 4646 5452 6177 5369 676e 0a20  ] = FFTRawSign. 
-0000f690: 2020 2020 2020 2061 7272 5f6f 7574 5b46         arr_out[F
-0000f6a0: 4654 5261 7753 6967 6e2e 7368 6170 655b  FTRawSign.shape[
-0000f6b0: 305d 203a 5d20 3d20 4646 5452 6177 5369  0] :] = FFTRawSi
-0000f6c0: 676e 5b31 3a5d 2e63 6f6e 6a75 6761 7465  gn[1:].conjugate
-0000f6d0: 2829 5b3a 3a2d 315d 0a0a 2020 2020 656c  ()[::-1]..    el
-0000f6e0: 6966 2064 6174 612e 6e64 696d 203d 3d20  if data.ndim == 
-0000f6f0: 323a 0a20 2020 2020 2020 2046 4654 5261  2:.        FFTRa
-0000f700: 7753 6967 6e20 3d20 7768 6974 656e 5f32  wSign = whiten_2
-0000f710: 4428 6461 7461 2c20 6666 745f 7061 7261  D(data, fft_para
-0000f720: 2c20 6e5f 7461 7065 7229 0a20 2020 2020  , n_taper).     
-0000f730: 2020 2061 7272 5f6f 7574 203d 206e 702e     arr_out = np.
-0000f740: 7a65 726f 7328 2846 4654 5261 7753 6967  zeros((FFTRawSig
-0000f750: 6e2e 7368 6170 655b 305d 2c20 2846 4654  n.shape[0], (FFT
-0000f760: 5261 7753 6967 6e2e 7368 6170 655b 315d  RawSign.shape[1]
-0000f770: 202d 2031 2920 2a20 3220 2b20 3129 2c20   - 1) * 2 + 1), 
-0000f780: 6474 7970 653d 636f 6d70 6c65 7829 0a20  dtype=complex). 
-0000f790: 2020 2020 2020 2061 7272 5f6f 7574 5b3a         arr_out[:
-0000f7a0: 2c20 4646 5452 6177 5369 676e 2e73 6861  , FFTRawSign.sha
-0000f7b0: 7065 5b31 5d20 3a5d 203d 2046 4654 5261  pe[1] :] = FFTRa
-0000f7c0: 7753 6967 6e5b 3a2c 2031 3a5d 2e63 6f6e  wSign[:, 1:].con
-0000f7d0: 6a75 6761 7465 2829 5b3a 3a2d 315d 0a20  jugate()[::-1]. 
-0000f7e0: 2020 2072 6574 7572 6e20 4646 5452 6177     return FFTRaw
-0000f7f0: 5369 676e 0a0a 0a64 6566 2061 6461 7074  Sign...def adapt
-0000f800: 6976 655f 6669 6c74 6572 2861 7272 2c20  ive_filter(arr, 
-0000f810: 6729 3a0a 2020 2020 2222 220a 2020 2020  g):.    """.    
-0000f820: 7468 6520 6164 6170 7469 7665 2063 6f76  the adaptive cov
-0000f830: 6172 6961 6e63 6520 6669 6c74 6572 2074  ariance filter t
-0000f840: 6f20 656e 6861 6e63 6520 636f 6865 7265  o enhance cohere
-0000f850: 6e74 2073 6967 6e61 6c73 2e20 4665 6c6c  nt signals. Fell
-0000f860: 6f77 7320 7468 6520 6d65 7468 6f64 206f  ows the method o
-0000f870: 660a 2020 2020 4e61 6b61 7461 2065 7420  f.    Nakata et 
-0000f880: 616c 2e2c 2032 3031 3520 2841 7070 656e  al., 2015 (Appen
-0000f890: 6469 7820 4229 0a0a 2020 2020 7468 6520  dix B)..    the 
-0000f8a0: 6669 6c74 6572 6564 2073 6967 6e61 6c20  filtered signal 
-0000f8b0: 5b78 315d 2069 7320 6769 7665 6e20 6279  [x1] is given by
-0000f8c0: 2078 3120 3d20 6966 6674 2850 2a78 3128   x1 = ifft(P*x1(
-0000f8d0: 7729 2920 7768 6572 6520 7831 2069 7320  w)) where x1 is 
-0000f8e0: 7468 6520 6666 7465 6420 7370 6563 7472  the ffted spectr
-0000f8f0: 610a 2020 2020 616e 6420 5020 6973 2074  a.    and P is t
-0000f900: 6865 2066 696c 7465 722e 2050 2069 7320  he filter. P is 
-0000f910: 636f 6e73 7472 7563 7465 6420 6279 2075  constructed by u
-0000f920: 7369 6e67 2074 6865 2074 656d 706f 7261  sing the tempora
-0000f930: 6c20 636f 7661 7269 616e 6365 206d 6174  l covariance mat
-0000f940: 7269 782e 0a0a 2020 2020 5041 5241 4d45  rix...    PARAME
-0000f950: 5445 5253 3a0a 2020 2020 2d2d 2d2d 2d2d  TERS:.    ------
-0000f960: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000f970: 0a20 2020 2061 7272 3a20 6e75 6d70 792e  .    arr: numpy.
-0000f980: 6e64 6172 7261 7920 636f 6e74 6169 6e73  ndarray contains
-0000f990: 2074 6865 2032 4420 7472 6163 6573 206f   the 2D traces o
-0000f9a0: 6620 6461 696c 792f 686f 7572 6c79 2063  f daily/hourly c
-0000f9b0: 726f 7373 2d63 6f72 7265 6c61 7469 6f6e  ross-correlation
-0000f9c0: 2066 756e 6374 696f 6e73 0a20 2020 2067   functions.    g
-0000f9d0: 3a20 6120 706f 7369 7469 7665 206e 756d  : a positive num
-0000f9e0: 6265 7220 746f 2061 646a 7573 7420 7468  ber to adjust th
-0000f9f0: 6520 6669 6c74 6572 2068 6172 7368 6e65  e filter harshne
-0000fa00: 7373 0a20 2020 2052 4554 5552 4e53 3a0a  ss.    RETURNS:.
-0000fa10: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
-0000fa20: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 206e  ----------.    n
-0000fa30: 6172 723a 206e 756d 7079 2076 6563 746f  arr: numpy vecto
-0000fa40: 7220 636f 6e74 6169 6e73 2074 6865 2073  r contains the s
-0000fa50: 7461 636b 6564 2063 726f 7373 2063 6f72  tacked cross cor
-0000fa60: 7265 6c61 7469 6f6e 2066 756e 6374 696f  relation functio
-0000fa70: 6e0a 2020 2020 2222 220a 2020 2020 6966  n.    """.    if
-0000fa80: 2061 7272 2e6e 6469 6d20 3d3d 2031 3a0a   arr.ndim == 1:.
-0000fa90: 2020 2020 2020 2020 7265 7475 726e 2061          return a
-0000faa0: 7272 0a20 2020 204e 2c20 4d20 3d20 6172  rr.    N, M = ar
-0000fab0: 722e 7368 6170 650a 2020 2020 4e66 6674  r.shape.    Nfft
-0000fac0: 203d 206e 6578 745f 6661 7374 5f6c 656e   = next_fast_len
-0000fad0: 284d 290a 0a20 2020 2023 2066 6674 2074  (M)..    # fft t
-0000fae0: 6865 2032 4420 6172 7261 790a 2020 2020  he 2D array.    
-0000faf0: 7370 6563 203d 2073 6369 7079 2e66 6674  spec = scipy.fft
-0000fb00: 7061 636b 2e66 6674 2861 7272 2c20 6178  pack.fft(arr, ax
-0000fb10: 6973 3d31 2c20 6e3d 4e66 6674 295b 3a2c  is=1, n=Nfft)[:,
-0000fb20: 203a 4d5d 0a0a 2020 2020 2320 6d61 6b65   :M]..    # make
-0000fb30: 2063 726f 7373 2d73 7065 6374 726d 206d   cross-spectrm m
-0000fb40: 6174 7269 780a 2020 2020 6373 7065 6320  atrix.    cspec 
-0000fb50: 3d20 6e70 2e7a 6572 6f73 2873 6861 7065  = np.zeros(shape
-0000fb60: 3d28 4e20 2a20 4e2c 204d 292c 2064 7479  =(N * N, M), dty
-0000fb70: 7065 3d6e 702e 636f 6d70 6c65 7836 3429  pe=np.complex64)
-0000fb80: 0a20 2020 2066 6f72 2069 6920 696e 2072  .    for ii in r
-0000fb90: 616e 6765 284e 293a 0a20 2020 2020 2020  ange(N):.       
-0000fba0: 2066 6f72 206a 6a20 696e 2072 616e 6765   for jj in range
-0000fbb0: 284e 293a 0a20 2020 2020 2020 2020 2020  (N):.           
-0000fbc0: 206b 6b20 3d20 6969 202a 204e 202b 206a   kk = ii * N + j
-0000fbd0: 6a0a 2020 2020 2020 2020 2020 2020 6373  j.            cs
-0000fbe0: 7065 635b 6b6b 5d20 3d20 7370 6563 5b69  pec[kk] = spec[i
-0000fbf0: 695d 202a 206e 702e 636f 6e6a 7567 6174  i] * np.conjugat
-0000fc00: 6528 7370 6563 5b6a 6a5d 290a 0a20 2020  e(spec[jj])..   
-0000fc10: 2053 3120 3d20 6e70 2e7a 6572 6f73 284d   S1 = np.zeros(M
-0000fc20: 2c20 6474 7970 653d 6e70 2e63 6f6d 706c  , dtype=np.compl
-0000fc30: 6578 3634 290a 2020 2020 5332 203d 206e  ex64).    S2 = n
-0000fc40: 702e 7a65 726f 7328 4d2c 2064 7479 7065  p.zeros(M, dtype
-0000fc50: 3d6e 702e 636f 6d70 6c65 7836 3429 0a20  =np.complex64). 
-0000fc60: 2020 2023 2063 6f6e 7374 7275 6374 2074     # construct t
-0000fc70: 6865 2066 696c 7465 7220 500a 2020 2020  he filter P.    
-0000fc80: 666f 7220 6969 2069 6e20 7261 6e67 6528  for ii in range(
-0000fc90: 4e29 3a0a 2020 2020 2020 2020 6d6d 203d  N):.        mm =
-0000fca0: 2069 6920 2a20 4e20 2b20 6969 0a20 2020   ii * N + ii.   
-0000fcb0: 2020 2020 2053 3220 2b3d 2063 7370 6563       S2 += cspec
-0000fcc0: 5b6d 6d5d 0a20 2020 2020 2020 2066 6f72  [mm].        for
-0000fcd0: 206a 6a20 696e 2072 616e 6765 284e 293a   jj in range(N):
-0000fce0: 0a20 2020 2020 2020 2020 2020 206b 6b20  .            kk 
-0000fcf0: 3d20 6969 202a 204e 202b 206a 6a0a 2020  = ii * N + jj.  
-0000fd00: 2020 2020 2020 2020 2020 5331 202b 3d20            S1 += 
-0000fd10: 6373 7065 635b 6b6b 5d0a 0a20 2020 2070  cspec[kk]..    p
-0000fd20: 203d 206e 702e 706f 7765 7228 2853 3120   = np.power((S1 
-0000fd30: 2d20 5332 2920 2f20 2853 3220 2a20 284e  - S2) / (S2 * (N
-0000fd40: 202d 2031 2929 2c20 6729 0a0a 2020 2020   - 1)), g)..    
-0000fd50: 2320 6d61 6b65 2069 6666 740a 2020 2020  # make ifft.    
-0000fd60: 6e61 7272 203d 206e 702e 7265 616c 2873  narr = np.real(s
-0000fd70: 6369 7079 2e66 6674 7061 636b 2e69 6666  cipy.fftpack.iff
-0000fd80: 7428 6e70 2e6d 756c 7469 706c 7928 702c  t(np.multiply(p,
-0000fd90: 2073 7065 6329 2c20 4e66 6674 2c20 6178   spec), Nfft, ax
-0000fda0: 6973 3d31 295b 3a2c 203a 4d5d 290a 2020  is=1)[:, :M]).  
-0000fdb0: 2020 7265 7475 726e 206e 702e 6d65 616e    return np.mean
-0000fdc0: 286e 6172 722c 2061 7869 733d 3029 0a0a  (narr, axis=0)..
-0000fdd0: 0a64 6566 2070 7773 2861 7272 2c20 7361  .def pws(arr, sa
-0000fde0: 6d70 6c69 6e67 5f72 6174 652c 2070 6f77  mpling_rate, pow
-0000fdf0: 6572 3d32 2c20 7077 735f 7469 6d65 6761  er=2, pws_timega
-0000fe00: 7465 3d35 2e30 293a 0a20 2020 2022 2222  te=5.0):.    """
-0000fe10: 0a20 2020 2050 6572 666f 726d 7320 7068  .    Performs ph
-0000fe20: 6173 652d 7765 6967 6874 6564 2073 7461  ase-weighted sta
-0000fe30: 636b 206f 6e20 6172 7261 7920 6f66 2074  ck on array of t
-0000fe40: 696d 6520 7365 7269 6573 2e20 4d6f 6469  ime series. Modi
-0000fe50: 6669 6564 206f 6e20 7468 6520 6e6f 6973  fied on the nois
-0000fe60: 6520 6675 6e63 7469 6f6e 2062 7920 5469  e function by Ti
-0000fe70: 6d20 436c 696d 656e 7473 2e0a 2020 2020  m Climents..    
-0000fe80: 466f 6c6c 6f77 7320 6d65 7468 6f64 7320  Follows methods 
-0000fe90: 6f66 2053 6368 696d 6d65 6c20 616e 6420  of Schimmel and 
-0000fea0: 5061 756c 7373 656e 2c20 3139 3937 2e0a  Paulssen, 1997..
-0000feb0: 2020 2020 4966 2073 2874 2920 6973 2074      If s(t) is t
-0000fec0: 696d 6520 7365 7269 6573 2064 6174 6120  ime series data 
-0000fed0: 2873 6569 736d 6f67 7261 6d2c 206f 7220  (seismogram, or 
-0000fee0: 6372 6f73 732d 636f 7272 656c 6174 696f  cross-correlatio
-0000fef0: 6e29 2c0a 2020 2020 5328 7429 203d 2073  n),.    S(t) = s
-0000ff00: 2874 2920 2b20 692a 4828 7328 7429 292c  (t) + i*H(s(t)),
-0000ff10: 2077 6865 7265 2048 2873 2874 2929 2069   where H(s(t)) i
-0000ff20: 7320 4869 6c62 6572 7420 7472 616e 7366  s Hilbert transf
-0000ff30: 6f72 6d20 6f66 2073 2874 290a 2020 2020  orm of s(t).    
-0000ff40: 5328 7429 203d 2073 2874 2920 2b20 692a  S(t) = s(t) + i*
-0000ff50: 4828 7328 7429 2920 3d20 4128 7429 2a65  H(s(t)) = A(t)*e
-0000ff60: 7870 2869 2a70 6869 2874 2929 2c20 7768  xp(i*phi(t)), wh
-0000ff70: 6572 650a 2020 2020 4128 7429 2069 7320  ere.    A(t) is 
-0000ff80: 656e 7665 6c6f 7065 206f 6620 7328 7429  envelope of s(t)
-0000ff90: 2061 6e64 2070 6869 2874 2920 6973 2070   and phi(t) is p
-0000ffa0: 6861 7365 206f 6620 7328 7429 0a20 2020  hase of s(t).   
-0000ffb0: 2050 6861 7365 2d77 6569 6768 7465 6420   Phase-weighted 
-0000ffc0: 7374 6163 6b2c 2067 2874 292c 2069 7320  stack, g(t), is 
-0000ffd0: 7468 656e 3a0a 2020 2020 6728 7429 203d  then:.    g(t) =
-0000ffe0: 2031 2f4e 2073 756d 206a 203d 2031 3a4e   1/N sum j = 1:N
-0000fff0: 2073 5f6a 2874 2920 2a20 7c20 312f 4e20   s_j(t) * | 1/N 
-00010000: 7375 6d20 6b20 3d20 313a 4e20 6578 705b  sum k = 1:N exp[
-00010010: 6920 2a20 7068 695f 6b28 7429 5d7c 5e76  i * phi_k(t)]|^v
-00010020: 0a20 2020 2077 6865 7265 204e 2069 7320  .    where N is 
-00010030: 6e75 6d62 6572 206f 6620 7472 6163 6573  number of traces
-00010040: 2075 7365 642c 2076 2069 7320 7368 6172   used, v is shar
-00010050: 706e 6573 7320 6f66 2070 6861 7365 2d77  pness of phase-w
-00010060: 6569 6768 7465 6420 7374 6163 6b0a 0a20  eighted stack.. 
-00010070: 2020 2050 4152 414d 4554 4552 533a 0a20     PARAMETERS:. 
-00010080: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
-00010090: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2061 7272  --------.    arr
-000100a0: 3a20 4e20 6c65 6e67 7468 2061 7272 6179  : N length array
-000100b0: 206f 6620 7469 6d65 2073 6572 6965 7320   of time series 
-000100c0: 6461 7461 2028 6e75 6d70 792e 6e64 6172  data (numpy.ndar
-000100d0: 7261 7929 0a20 2020 2073 616d 706c 696e  ray).    samplin
-000100e0: 675f 7261 7465 3a20 7361 6d70 6c69 6e67  g_rate: sampling
-000100f0: 2072 6174 6520 6f66 2074 696d 6520 7365   rate of time se
-00010100: 7269 6573 2061 7272 2028 696e 7429 0a20  ries arr (int). 
-00010110: 2020 2070 6f77 6572 3a20 6578 706f 6e65     power: expone
-00010120: 6e74 2066 6f72 2070 6861 7365 2073 7461  nt for phase sta
-00010130: 636b 2028 696e 7429 0a20 2020 2070 7773  ck (int).    pws
-00010140: 5f74 696d 6567 6174 653a 206e 756d 6265  _timegate: numbe
-00010150: 7220 6f66 2073 6563 6f6e 6473 2074 6f20  r of seconds to 
-00010160: 736d 6f6f 7468 2070 6861 7365 2073 7461  smooth phase sta
-00010170: 636b 2028 666c 6f61 7429 0a0a 2020 2020  ck (float)..    
-00010180: 5245 5455 524e 533a 0a20 2020 202d 2d2d  RETURNS:.    ---
-00010190: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000101a0: 2d2d 0a20 2020 2077 6569 6768 7465 643a  --.    weighted:
-000101b0: 2050 6861 7365 2077 6569 6768 7465 6420   Phase weighted 
-000101c0: 7374 6163 6b20 6f66 2074 696d 6520 7365  stack of time se
-000101d0: 7269 6573 2064 6174 6120 286e 756d 7079  ries data (numpy
-000101e0: 2e6e 6461 7272 6179 290a 2020 2020 2222  .ndarray).    ""
-000101f0: 220a 0a20 2020 2069 6620 6172 722e 6e64  "..    if arr.nd
-00010200: 696d 203d 3d20 313a 0a20 2020 2020 2020  im == 1:.       
-00010210: 2072 6574 7572 6e20 6172 720a 2020 2020   return arr.    
-00010220: 4e2c 204d 203d 2061 7272 2e73 6861 7065  N, M = arr.shape
-00010230: 0a20 2020 2061 6e61 6c79 7469 6320 3d20  .    analytic = 
-00010240: 6869 6c62 6572 7428 6172 722c 2061 7869  hilbert(arr, axi
-00010250: 733d 312c 204e 3d6e 6578 745f 6661 7374  s=1, N=next_fast
-00010260: 5f6c 656e 284d 2929 5b3a 2c20 3a4d 5d0a  _len(M))[:, :M].
-00010270: 2020 2020 7068 6173 6520 3d20 6e70 2e61      phase = np.a
-00010280: 6e67 6c65 2861 6e61 6c79 7469 6329 0a20  ngle(analytic). 
-00010290: 2020 2070 6861 7365 5f73 7461 636b 203d     phase_stack =
-000102a0: 206e 702e 6d65 616e 286e 702e 6578 7028   np.mean(np.exp(
-000102b0: 316a 202a 2070 6861 7365 292c 2061 7869  1j * phase), axi
-000102c0: 733d 3029 0a20 2020 2070 6861 7365 5f73  s=0).    phase_s
-000102d0: 7461 636b 203d 206e 702e 6162 7328 7068  tack = np.abs(ph
-000102e0: 6173 655f 7374 6163 6b29 202a 2a20 2870  ase_stack) ** (p
-000102f0: 6f77 6572 290a 0a20 2020 2023 2073 6d6f  ower)..    # smo
-00010300: 6f74 6869 6e67 0a20 2020 2023 2074 696d  othing.    # tim
-00010310: 6567 6174 655f 7361 6d70 6c65 7320 3d20  egate_samples = 
-00010320: 696e 7428 7077 735f 7469 6d65 6761 7465  int(pws_timegate
-00010330: 202a 2073 616d 706c 696e 675f 7261 7465   * sampling_rate
-00010340: 290a 2020 2020 2320 7068 6173 655f 7374  ).    # phase_st
-00010350: 6163 6b20 3d20 6d6f 7669 6e67 5f61 7665  ack = moving_ave
-00010360: 2870 6861 7365 5f73 7461 636b 2c74 696d  (phase_stack,tim
-00010370: 6567 6174 655f 7361 6d70 6c65 7329 0a20  egate_samples). 
-00010380: 2020 2077 6569 6768 7465 6420 3d20 6e70     weighted = np
-00010390: 2e6d 756c 7469 706c 7928 6172 722c 2070  .multiply(arr, p
-000103a0: 6861 7365 5f73 7461 636b 290a 2020 2020  hase_stack).    
-000103b0: 7265 7475 726e 206e 702e 6d65 616e 2877  return np.mean(w
-000103c0: 6569 6768 7465 642c 2061 7869 733d 3029  eighted, axis=0)
-000103d0: 0a0a 0a64 6566 206e 726f 6f74 5f73 7461  ...def nroot_sta
-000103e0: 636b 2863 635f 6172 7261 792c 2070 6f77  ck(cc_array, pow
-000103f0: 6572 293a 0a20 2020 2022 2222 0a20 2020  er):.    """.   
-00010400: 2074 6869 7320 6973 206e 7468 2d72 6f6f   this is nth-roo
-00010410: 7420 7374 6163 6b69 6e67 2061 6c67 6f72  t stacking algor
-00010420: 6974 686d 2074 7261 6e73 6c61 7465 6420  ithm translated 
-00010430: 6261 7365 6420 6f6e 2074 6865 206d 6174  based on the mat
-00010440: 6c61 6220 6675 6e63 7469 6f6e 0a20 2020  lab function.   
-00010450: 2066 726f 6d20 6874 7470 733a 2f2f 6769   from https://gi
-00010460: 7468 7562 2e63 6f6d 2f78 7479 616e 6770  thub.com/xtyangp
-00010470: 7370 2f53 6569 7353 7461 636b 2028 6279  sp/SeisStack (by
-00010480: 2058 6961 6f74 616f 2059 616e 673b 2066   Xiaotao Yang; f
-00010490: 6f6c 6c6f 7773 2074 6865 0a20 2020 2072  ollows the.    r
-000104a0: 6566 6572 656e 6365 206f 6620 4d69 6c6c  eference of Mill
-000104b0: 6574 2c20 4620 6574 2061 6c2e 2c20 3230  et, F et al., 20
-000104c0: 3139 204a 4752 290a 0a20 2020 2050 6172  19 JGR)..    Par
-000104d0: 616d 6574 6572 733a 0a20 2020 202d 2d2d  ameters:.    ---
-000104e0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6363  ---------.    cc
-000104f0: 5f61 7272 6179 3a20 6e75 6d70 792e 6e64  _array: numpy.nd
-00010500: 6172 7261 7920 636f 6e74 6169 6e73 2074  array contains t
-00010510: 6865 2032 4420 6372 6f73 7320 636f 7272  he 2D cross corr
-00010520: 656c 6174 696f 6e20 6d61 7472 6978 0a20  elation matrix. 
-00010530: 2020 2070 6f77 6572 3a20 6e70 2e69 6e74     power: np.int
-00010540: 2c20 6e74 6820 726f 6f74 2066 6f72 2074  , nth root for t
-00010550: 6865 2073 7461 636b 696e 670a 0a20 2020  he stacking..   
-00010560: 2052 6574 7572 6e73 3a0a 2020 2020 2d2d   Returns:.    --
-00010570: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 206e  ----------.    n
-00010580: 7374 6163 6b3a 206e 702e 6e64 6172 7261  stack: np.ndarra
-00010590: 792c 2066 696e 616c 2073 7461 636b 6564  y, final stacked
-000105a0: 2077 6176 6566 6f72 6d73 0a0a 2020 2020   waveforms..    
-000105b0: 5772 6974 7465 6e20 6279 2043 6865 6e67  Written by Cheng
-000105c0: 7869 6e20 4a69 616e 6720 4041 4e55 2028  xin Jiang @ANU (
-000105d0: 4d61 7932 3032 3029 0a20 2020 2022 2222  May2020).    """
-000105e0: 0a20 2020 2069 6620 6363 5f61 7272 6179  .    if cc_array
-000105f0: 2e6e 6469 6d20 3d3d 2031 3a0a 2020 2020  .ndim == 1:.    
-00010600: 2020 2020 7072 696e 7428 2232 4420 6d61      print("2D ma
-00010610: 7472 6978 2069 7320 6e65 6564 6564 2066  trix is needed f
-00010620: 6f72 206e 726f 6f74 5f73 7461 636b 2229  or nroot_stack")
-00010630: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00010640: 6363 5f61 7272 6179 0a20 2020 204e 2c20  cc_array.    N, 
-00010650: 4d20 3d20 6363 5f61 7272 6179 2e73 6861  M = cc_array.sha
-00010660: 7065 0a20 2020 2064 6f75 7420 3d20 6e70  pe.    dout = np
-00010670: 2e7a 6572 6f73 284d 2c20 6474 7970 653d  .zeros(M, dtype=
-00010680: 6e70 2e66 6c6f 6174 3332 290a 0a20 2020  np.float32)..   
-00010690: 2023 2063 6f6e 7374 7275 6374 2079 0a20   # construct y. 
-000106a0: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
-000106b0: 6765 284e 293a 0a20 2020 2020 2020 2064  ge(N):.        d
-000106c0: 6174 203d 2063 635f 6172 7261 795b 6969  at = cc_array[ii
-000106d0: 2c20 3a5d 0a20 2020 2020 2020 2064 6f75  , :].        dou
-000106e0: 7420 2b3d 206e 702e 7369 676e 2864 6174  t += np.sign(dat
-000106f0: 2920 2a20 6e70 2e61 6273 2864 6174 2920  ) * np.abs(dat) 
-00010700: 2a2a 2028 3120 2f20 706f 7765 7229 0a20  ** (1 / power). 
-00010710: 2020 2064 6f75 7420 2f3d 204e 0a0a 2020     dout /= N..  
-00010720: 2020 2320 7468 6520 6669 6e61 6c20 7374    # the final st
-00010730: 6163 6b65 6420 7761 7665 666f 726d 0a20  acked waveform. 
-00010740: 2020 206e 7374 6163 6b20 3d20 646f 7574     nstack = dout
-00010750: 202a 206e 702e 6162 7328 646f 7574 2920   * np.abs(dout) 
-00010760: 2a2a 2028 706f 7765 7220 2d20 3129 0a0a  ** (power - 1)..
-00010770: 2020 2020 7265 7475 726e 206e 7374 6163      return nstac
-00010780: 6b0a 0a0a 6465 6620 7365 6c65 6374 6976  k...def selectiv
-00010790: 655f 7374 6163 6b28 6363 5f61 7272 6179  e_stack(cc_array
-000107a0: 2c20 6570 7369 6c6f 6e2c 2063 635f 7468  , epsilon, cc_th
-000107b0: 293a 2020 2320 6e6f 7161 3a20 4638 3131  ):  # noqa: F811
-000107c0: 0a20 2020 2022 2222 0a20 2020 2074 6869  .    """.    thi
-000107d0: 7320 6973 2061 2073 656c 6563 7469 7665  s is a selective
-000107e0: 2073 7461 636b 696e 6720 616c 676f 7269   stacking algori
-000107f0: 7468 6d20 6465 7665 6c6f 7065 6420 6279  thm developed by
-00010800: 204a 6172 6564 2042 7279 616e 2f4b 7572   Jared Bryan/Kur
-00010810: 616d 6120 4f6b 7562 6f2e 0a0a 2020 2020  ama Okubo...    
-00010820: 5041 5241 4d45 5445 5253 3a0a 2020 2020  PARAMETERS:.    
-00010830: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00010840: 2d2d 2d2d 2d2d 0a20 2020 2063 635f 6172  ------.    cc_ar
-00010850: 7261 793a 206e 756d 7079 2e6e 6461 7272  ray: numpy.ndarr
-00010860: 6179 2063 6f6e 7461 696e 7320 7468 6520  ay contains the 
-00010870: 3244 2063 726f 7373 2063 6f72 7265 6c61  2D cross correla
-00010880: 7469 6f6e 206d 6174 7269 780a 2020 2020  tion matrix.    
-00010890: 6570 7369 6c6f 6e3a 2072 6573 6964 7561  epsilon: residua
-000108a0: 6c20 7468 7265 686f 6c64 2074 6f20 7175  l threhold to qu
-000108b0: 6974 2074 6865 2069 7465 7261 7469 6f6e  it the iteration
-000108c0: 0a20 2020 2063 635f 7468 3a20 6e75 6d70  .    cc_th: nump
-000108d0: 792e 666c 6f61 742c 2074 6872 6573 686f  y.float, thresho
-000108e0: 6c64 206f 6620 636f 7272 656c 6174 696f  ld of correlatio
-000108f0: 6e20 636f 6566 6669 6369 656e 7420 746f  n coefficient to
-00010900: 2062 6520 7365 6c65 6374 6564 0a0a 2020   be selected..  
-00010910: 2020 5245 5455 524e 533a 0a20 2020 202d    RETURNS:.    -
-00010920: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00010930: 2d2d 2d2d 2d0a 2020 2020 6e65 7773 7461  -----.    newsta
-00010940: 636b 3a20 6e75 6d70 7920 7665 6374 6f72  ck: numpy vector
-00010950: 2063 6f6e 7461 696e 7320 7468 6520 7374   contains the st
-00010960: 6163 6b65 6420 6372 6f73 7320 636f 7272  acked cross corr
-00010970: 656c 6174 696f 6e0a 2020 2020 6e73 7465  elation.    nste
-00010980: 703a 206e 702e 696e 742c 2074 6f74 616c  p: np.int, total
-00010990: 206e 756d 6265 7220 6f66 2069 7465 7261   number of itera
-000109a0: 7469 6f6e 7320 666f 7220 7468 6520 7374  tions for the st
-000109b0: 6163 6b69 6e67 0a0a 2020 2020 4f72 6967  acking..    Orig
-000109c0: 696e 616c 6c79 2072 6974 7465 6e20 6279  inally ritten by
-000109d0: 204d 6172 696e 6520 4465 6e6f 6c6c 650a   Marine Denolle.
-000109e0: 2020 2020 4d6f 6469 6669 6564 2062 7920      Modified by 
-000109f0: 4368 656e 6778 696e 204a 6961 6e67 2040  Chengxin Jiang @
-00010a00: 4861 7276 6172 6420 284f 6374 3230 3230  Harvard (Oct2020
-00010a10: 290a 2020 2020 2222 220a 2020 2020 6966  ).    """.    if
-00010a20: 2063 635f 6172 7261 792e 6e64 696d 203d   cc_array.ndim =
-00010a30: 3d20 313a 0a20 2020 2020 2020 2070 7269  = 1:.        pri
-00010a40: 6e74 2822 3244 206d 6174 7269 7820 6973  nt("2D matrix is
-00010a50: 206e 6565 6465 6420 666f 7220 6e72 6f6f   needed for nroo
-00010a60: 745f 7374 6163 6b22 290a 2020 2020 2020  t_stack").      
-00010a70: 2020 7265 7475 726e 2063 635f 6172 7261    return cc_arra
-00010a80: 790a 2020 2020 4e2c 204d 203d 2063 635f  y.    N, M = cc_
-00010a90: 6172 7261 792e 7368 6170 650a 0a20 2020  array.shape..   
-00010aa0: 2072 6573 203d 2039 6539 2020 2320 7265   res = 9e9  # re
-00010ab0: 7369 6475 616c 730a 2020 2020 636f 6620  siduals.    cof 
-00010ac0: 3d20 6e70 2e7a 6572 6f73 284e 2c20 6474  = np.zeros(N, dt
-00010ad0: 7970 653d 6e70 2e66 6c6f 6174 3332 290a  ype=np.float32).
-00010ae0: 2020 2020 6e65 7773 7461 636b 203d 206e      newstack = n
-00010af0: 702e 6d65 616e 2863 635f 6172 7261 792c  p.mean(cc_array,
-00010b00: 2061 7869 733d 3029 0a0a 2020 2020 6e73   axis=0)..    ns
-00010b10: 7465 7020 3d20 300a 2020 2020 2320 7374  tep = 0.    # st
-00010b20: 6172 7420 6974 6572 6174 696f 6e0a 2020  art iteration.  
-00010b30: 2020 7768 696c 6520 7265 7320 3e20 6570    while res > ep
-00010b40: 7369 6c6f 6e3a 0a20 2020 2020 2020 2066  silon:.        f
-00010b50: 6f72 2069 6920 696e 2072 616e 6765 284e  or ii in range(N
-00010b60: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-00010b70: 6f66 5b69 695d 203d 206e 702e 636f 7272  of[ii] = np.corr
-00010b80: 636f 6566 286e 6577 7374 6163 6b2c 2063  coef(newstack, c
-00010b90: 635f 6172 7261 795b 6969 2c20 3a5d 295b  c_array[ii, :])[
-00010ba0: 302c 2031 5d0a 0a20 2020 2020 2020 2023  0, 1]..        #
-00010bb0: 2066 696e 6420 676f 6f64 2077 6176 6566   find good wavef
-00010bc0: 6f72 6d73 0a20 2020 2020 2020 2069 6e64  orms.        ind
-00010bd0: 7820 3d20 6e70 2e77 6865 7265 2863 6f66  x = np.where(cof
-00010be0: 203e 3d20 6363 5f74 6829 5b30 5d0a 2020   >= cc_th)[0].  
-00010bf0: 2020 2020 2020 6966 206e 6f74 206c 656e        if not len
-00010c00: 2869 6e64 7829 3a0a 2020 2020 2020 2020  (indx):.        
-00010c10: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-00010c20: 7272 6f72 2822 6361 6e6e 6f74 2066 696e  rror("cannot fin
-00010c30: 6420 676f 6f64 2077 6176 6566 6f72 6d73  d good waveforms
-00010c40: 2069 6e73 6964 6520 7365 6c65 6374 6976   inside selectiv
-00010c50: 6520 7374 6163 6b69 6e67 2229 0a20 2020  e stacking").   
-00010c60: 2020 2020 206f 6c64 7374 6163 6b20 3d20       oldstack = 
-00010c70: 6e65 7773 7461 636b 0a20 2020 2020 2020  newstack.       
-00010c80: 206e 6577 7374 6163 6b20 3d20 6e70 2e6d   newstack = np.m
-00010c90: 6561 6e28 6363 5f61 7272 6179 5b69 6e64  ean(cc_array[ind
-00010ca0: 785d 2c20 6178 6973 3d30 290a 2020 2020  x], axis=0).    
-00010cb0: 2020 2020 7265 7320 3d20 6e70 2e6c 696e      res = np.lin
-00010cc0: 616c 672e 6e6f 726d 286e 6577 7374 6163  alg.norm(newstac
-00010cd0: 6b20 2d20 6f6c 6473 7461 636b 2920 2f20  k - oldstack) / 
-00010ce0: 286e 702e 6c69 6e61 6c67 2e6e 6f72 6d28  (np.linalg.norm(
-00010cf0: 6e65 7773 7461 636b 2920 2a20 4d29 0a20  newstack) * M). 
-00010d00: 2020 2020 2020 206e 7374 6570 202b 3d20         nstep += 
-00010d10: 310a 0a20 2020 2072 6574 7572 6e20 6e65  1..    return ne
-00010d20: 7773 7461 636b 2c20 6e73 7465 700a 0a0a  wstack, nstep...
-00010d30: 6465 6620 6765 745f 6363 2873 312c 2073  def get_cc(s1, s
-00010d40: 5f72 6566 293a 0a20 2020 2023 2072 6574  _ref):.    # ret
-00010d50: 7572 6e73 2074 6865 2063 6f72 7265 6c61  urns the correla
-00010d60: 7469 6f6e 2063 6f65 6666 6963 6965 6e74  tion coefficient
-00010d70: 2062 6574 7765 656e 2077 6176 6566 6f72   between wavefor
-00010d80: 6d73 2069 6e20 7331 2061 6761 696e 7374  ms in s1 against
-00010d90: 2072 6566 6572 656e 6365 0a20 2020 2023   reference.    #
-00010da0: 2077 6176 6566 6f72 6d20 735f 7265 662e   waveform s_ref.
-00010db0: 0a20 2020 2023 0a20 2020 2063 6320 3d20  .    #.    cc = 
-00010dc0: 6e70 2e7a 6572 6f73 2873 312e 7368 6170  np.zeros(s1.shap
-00010dd0: 655b 305d 290a 2020 2020 735f 7265 665f  e[0]).    s_ref_
-00010de0: 6e6f 726d 203d 206e 702e 6c69 6e61 6c67  norm = np.linalg
-00010df0: 2e6e 6f72 6d28 735f 7265 6629 0a20 2020  .norm(s_ref).   
-00010e00: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-00010e10: 7331 2e73 6861 7065 5b30 5d29 3a0a 2020  s1.shape[0]):.  
-00010e20: 2020 2020 2020 6363 5b69 5d20 3d20 6e70        cc[i] = np
-00010e30: 2e73 756d 286e 702e 6d75 6c74 6970 6c79  .sum(np.multiply
-00010e40: 2873 315b 692c 203a 5d2c 2073 5f72 6566  (s1[i, :], s_ref
-00010e50: 2929 202f 206e 702e 6c69 6e61 6c67 2e6e  )) / np.linalg.n
-00010e60: 6f72 6d28 7331 5b69 2c20 3a5d 2920 2f20  orm(s1[i, :]) / 
-00010e70: 735f 7265 665f 6e6f 726d 0a20 2020 2072  s_ref_norm.    r
-00010e80: 6574 7572 6e20 6363 0a0a 0a23 2323 2323  eturn cc...#####
-00010e90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00010ea0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00010eb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00010ec0: 2323 230a 2323 2323 2323 2323 2323 2323  ###.############
-00010ed0: 2323 2323 204d 4f4e 4954 4f52 494e 4720  #### MONITORING 
-00010ee0: 4655 4e43 5449 4f4e 5320 2323 2323 2323  FUNCTIONS ######
-00010ef0: 2323 2323 2323 2323 2323 2323 0a23 2323  ############.###
-00010f00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00010f10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00010f20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00010f30: 2323 2323 230a 0a22 2222 0a61 2063 6f6d  #####..""".a com
-00010f40: 7069 6c61 7469 6f6e 206f 6620 616c 6c20  pilation of all 
-00010f50: 6176 6169 6c61 626c 6520 636f 7265 2066  available core f
-00010f60: 756e 6374 696f 6e73 2066 6f72 2063 6f6d  unctions for com
-00010f70: 7075 7469 6e67 2070 6861 7365 2064 656c  puting phase del
-00010f80: 6179 7320 6261 7365 6420 6f6e 2061 6d62  ays based on amb
-00010f90: 6965 6e74 206e 6f69 7365 2069 6e74 6572  ient noise inter
-00010fa0: 6665 726f 6d65 7472 790a 0a71 7569 636b  ferometry..quick
-00010fb0: 2069 6e64 6578 206f 6620 6476 2f76 206d   index of dv/v m
-00010fc0: 6574 686f 6473 3a0a 3129 2073 7472 6574  ethods:.1) stret
-00010fd0: 6368 696e 6720 2874 696d 6520 7374 7265  ching (time stre
-00010fe0: 7463 6869 6e67 3b20 5765 6176 6572 2065  tching; Weaver e
-00010ff0: 7420 616c 2028 3230 3131 2929 0a32 2920  t al (2011)).2) 
-00011000: 6474 775f 6476 7620 2844 796e 616d 6963  dtw_dvv (Dynamic
-00011010: 2054 696d 6520 5761 7270 696e 673b 204d   Time Warping; M
-00011020: 696b 6573 656c 6c20 6574 2061 6c2e 2032  ikesell et al. 2
-00011030: 3031 3529 0a33 2920 6d77 6373 5f64 7676  015).3) mwcs_dvv
-00011040: 2028 4d6f 7669 6e67 2057 696e 646f 7720   (Moving Window 
-00011050: 4372 6f73 7320 5370 6563 7472 756d 3b20  Cross Spectrum; 
-00011060: 436c 6172 6b20 6574 2061 6c2e 2c20 3230  Clark et al., 20
-00011070: 3131 290a 3429 206d 7763 635f 6476 7620  11).4) mwcc_dvv 
-00011080: 284d 6f76 696e 6720 5769 6e64 6f77 2043  (Moving Window C
-00011090: 726f 7373 2043 6f72 7265 6c61 7469 6f6e  ross Correlation
-000110a0: 3b20 536e 6965 6465 7220 6574 2061 6c2e  ; Snieder et al.
-000110b0: 2c20 3230 3132 290a 3529 2077 7473 5f64  , 2012).5) wts_d
-000110c0: 7676 2028 5761 7665 6c65 7420 5374 7265  vv (Wavelet Stre
-000110d0: 6368 696e 673b 2059 7561 6e20 6574 2061  ching; Yuan et a
-000110e0: 6c2e 2c20 696e 2070 7265 7029 0a36 2920  l., in prep).6) 
-000110f0: 7778 735f 6476 7620 2857 6176 656c 6574  wxs_dvv (Wavelet
-00011100: 2058 726f 7373 2053 7065 6374 7275 6d3b   Xross Spectrum;
-00011110: 204d 616f 2065 7420 616c 2e2c 2032 3031   Mao et al., 201
-00011120: 3929 0a37 2920 7764 775f 6476 7620 2857  9).7) wdw_dvv (W
-00011130: 6176 656c 6574 2044 796e 616d 6963 2057  avelet Dynamic W
-00011140: 6172 7069 6e67 3b20 5975 616e 2065 7420  arping; Yuan et 
-00011150: 616c 2e2c 2069 6e20 7072 6570 290a 2222  al., in prep).""
-00011160: 220a 0a0a 6465 6620 7374 7265 7463 6869  "...def stretchi
-00011170: 6e67 2872 6566 2c20 6375 722c 2064 765f  ng(ref, cur, dv_
-00011180: 7261 6e67 652c 206e 6274 7269 616c 2c20  range, nbtrial, 
-00011190: 7061 7261 293a 0a20 2020 2022 2222 0a20  para):.    """. 
-000111a0: 2020 2054 6869 7320 6675 6e63 7469 6f6e     This function
-000111b0: 2063 6f6d 7061 7265 7320 7468 6520 5265   compares the Re
-000111c0: 6665 7265 6e63 6520 7761 7665 666f 726d  ference waveform
-000111d0: 2074 6f20 7374 7265 7463 6865 642f 636f   to stretched/co
-000111e0: 6d70 7265 7373 6564 2063 7572 7265 6e74  mpressed current
-000111f0: 2077 6176 6566 6f72 6d73 2074 6f20 6765   waveforms to ge
-00011200: 7420 7468 650a 2020 2020 7265 6c61 7469  t the.    relati
-00011210: 7665 2073 6569 736d 6963 2076 656c 6f63  ve seismic veloc
-00011220: 6974 7920 7661 7269 6174 696f 6e20 2861  ity variation (a
-00011230: 6e64 2061 7373 6f63 6961 7465 6420 6572  nd associated er
-00011240: 726f 7229 2e0a 2020 2020 4974 2061 6c73  ror)..    It als
-00011250: 6f20 636f 6d70 7574 6573 2074 6865 2063  o computes the c
-00011260: 6f72 7265 6c61 7469 6f6e 2063 6f65 6666  orrelation coeff
-00011270: 6963 6965 6e74 2062 6574 7765 656e 2074  icient between t
-00011280: 6865 2052 6566 6572 656e 6365 2077 6176  he Reference wav
-00011290: 6566 6f72 6d20 616e 6420 7468 6520 6375  eform and the cu
-000112a0: 7272 656e 7420 7761 7665 666f 726d 2e0a  rrent waveform..
-000112b0: 0a20 2020 2050 4152 414d 4554 4552 533a  .    PARAMETERS:
-000112c0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
-000112d0: 2d2d 2d2d 2d0a 2020 2020 7265 663a 2052  -----.    ref: R
-000112e0: 6566 6572 656e 6365 2077 6176 6566 6f72  eference wavefor
-000112f0: 6d20 286e 702e 6e64 6172 7261 792c 2073  m (np.ndarray, s
-00011300: 697a 6520 4e29 0a20 2020 2063 7572 3a20  ize N).    cur: 
-00011310: 4375 7272 656e 7420 7761 7665 666f 726d  Current waveform
-00011320: 2028 6e70 2e6e 6461 7272 6179 2c20 7369   (np.ndarray, si
-00011330: 7a65 204e 290a 2020 2020 6476 5f72 616e  ze N).    dv_ran
-00011340: 6765 3a20 6162 736f 6c75 7465 2062 6f75  ge: absolute bou
-00011350: 6e64 2066 6f72 2074 6865 2076 656c 6f63  nd for the veloc
-00011360: 6974 7920 7661 7269 6174 696f 6e3b 2065  ity variation; e
-00011370: 7861 6d70 6c65 3a20 6476 3d30 2e30 3320  xample: dv=0.03 
-00011380: 666f 7220 5b2d 332c 335d 250a 2020 2020  for [-3,3]%.    
-00011390: 6f66 2072 656c 6174 6976 6520 7665 6c6f  of relative velo
-000113a0: 6369 7479 2063 6861 6e67 6520 2827 666c  city change ('fl
-000113b0: 6f61 7427 290a 2020 2020 6e62 7472 6961  oat').    nbtria
-000113c0: 6c3a 206e 756d 6265 7220 6f66 2073 7472  l: number of str
-000113d0: 6574 6368 696e 6720 636f 6566 6669 6369  etching coeffici
-000113e0: 656e 7420 6265 7477 6565 6e20 6476 6d69  ent between dvmi
-000113f0: 6e20 616e 6420 6476 6d61 782c 206e 6f20  n and dvmax, no 
-00011400: 6e65 6564 2074 6f20 6265 2068 6967 6865  need to be highe
-00011410: 7220 7468 616e 2031 3030 2020 2827 666c  r than 100  ('fl
-00011420: 6f61 7427 290a 2020 2020 7061 7261 3a20  oat').    para: 
-00011430: 7665 6374 6f72 206f 6620 7468 6520 696e  vector of the in
-00011440: 6469 6365 7320 6f66 2074 6865 2063 7572  dices of the cur
-00011450: 2061 6e64 2072 6566 2077 696e 646f 7773   and ref windows
-00011460: 206f 6e20 7769 6368 2079 6f75 2077 616e   on wich you wan
-00011470: 7420 746f 2064 6f20 7468 6520 6d65 6173  t to do the meas
-00011480: 7572 656d 656e 7473 0a20 2020 2028 6e70  urements.    (np
-00011490: 2e6e 6461 7272 6179 2c20 7369 7a65 2074  .ndarray, size t
-000114a0: 6d69 6e2a 6465 6c74 613a 746d 6178 2a64  min*delta:tmax*d
-000114b0: 656c 7461 290a 2020 2020 466f 7220 6572  elta).    For er
-000114c0: 726f 7220 636f 6d70 7574 6174 696f 6e2c  ror computation,
-000114d0: 2077 6520 6e65 6564 2070 6172 616d 6574   we need paramet
-000114e0: 6572 733a 0a20 2020 2020 2020 2066 6d69  ers:.        fmi
-000114f0: 6e3a 206d 696e 696d 756d 2066 7265 7175  n: minimum frequ
-00011500: 656e 6379 206f 6620 7468 6520 6461 7461  ency of the data
-00011510: 0a20 2020 2020 2020 2066 6d61 783a 206d  .        fmax: m
-00011520: 6178 696d 756d 2066 7265 7175 656e 6379  aximum frequency
-00011530: 206f 6620 7468 6520 6461 7461 0a20 2020   of the data.   
-00011540: 2020 2020 2074 6d69 6e3a 206d 696e 696d       tmin: minim
-00011550: 756d 2074 696d 6520 7769 6e64 6f77 2077  um time window w
-00011560: 6865 7265 2074 6865 2064 762f 7620 6973  here the dv/v is
-00011570: 2063 6f6d 7075 7465 640a 2020 2020 2020   computed.      
-00011580: 2020 746d 6178 3a20 6d61 7869 6d75 6d20    tmax: maximum 
-00011590: 7469 6d65 2077 696e 646f 7720 7768 6572  time window wher
-000115a0: 6520 7468 6520 6476 2f76 2069 7320 636f  e the dv/v is co
-000115b0: 6d70 7574 6564 0a20 2020 2052 4554 5552  mputed.    RETUR
-000115c0: 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  NS:.    --------
-000115d0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2064 763a  --------.    dv:
-000115e0: 2052 656c 6174 6976 6520 7665 6c6f 6369   Relative veloci
-000115f0: 7479 2063 6861 6e67 6520 6476 2f76 2028  ty change dv/v (
-00011600: 696e 2025 290a 2020 2020 6363 3a20 636f  in %).    cc: co
-00011610: 7272 656c 6174 696f 6e20 636f 6566 6669  rrelation coeffi
-00011620: 6369 656e 7420 6265 7477 6565 6e20 7468  cient between th
-00011630: 6520 7265 6665 7265 6e63 6520 7761 7665  e reference wave
-00011640: 666f 726d 2061 6e64 2074 6865 2062 6573  form and the bes
-00011650: 7420 7374 7265 7463 6865 642f 636f 6d70  t stretched/comp
-00011660: 7265 7373 6564 2063 7572 7265 6e74 2077  ressed current w
-00011670: 6176 6566 6f72 6d0a 2020 2020 6364 703a  aveform.    cdp:
-00011680: 2063 6f72 7265 6c61 7469 6f6e 2063 6f65   correlation coe
-00011690: 6666 6963 6965 6e74 2062 6574 7765 656e  fficient between
-000116a0: 2074 6865 2072 6566 6572 656e 6365 2077   the reference w
-000116b0: 6176 6566 6f72 6d20 616e 6420 7468 6520  aveform and the 
-000116c0: 696e 6974 6961 6c20 6375 7272 656e 7420  initial current 
-000116d0: 7761 7665 666f 726d 0a20 2020 2065 7272  waveform.    err
-000116e0: 6f72 3a20 4572 726f 7273 2069 6e20 7468  or: Errors in th
-000116f0: 6520 6476 2f76 206d 6561 7375 7265 6d65  e dv/v measureme
-00011700: 6e74 7320 6261 7365 6420 6f6e 2057 6561  nts based on Wea
-00011710: 7665 7220 6574 2061 6c20 2832 3031 3129  ver et al (2011)
-00011720: 2c0a 2020 2020 4f6e 2074 6865 2070 7265  ,.    On the pre
-00011730: 6369 7369 6f6e 206f 6620 6e6f 6973 652d  cision of noise-
-00011740: 636f 7272 656c 6174 696f 6e20 696e 7465  correlation inte
-00011750: 7266 6572 6f6d 6574 7279 2c20 4765 6f70  rferometry, Geop
-00011760: 6879 732e 204a 2e20 496e 742e 2c20 3138  hys. J. Int., 18
-00011770: 3528 3329 0a0a 2020 2020 4e6f 7465 3a20  5(3)..    Note: 
-00011780: 5468 6520 636f 6465 2066 6972 7374 2066  The code first f
-00011790: 696e 6473 2074 6865 2062 6573 7420 636f  inds the best co
-000117a0: 7272 656c 6174 696f 6e20 636f 6566 6669  rrelation coeffi
-000117b0: 6369 656e 7420 6265 7477 6565 6e20 7468  cient between th
-000117c0: 6520 5265 6665 7265 6e63 6520 7761 7665  e Reference wave
-000117d0: 666f 726d 2061 6e64 0a20 2020 2074 6865  form and.    the
-000117e0: 2073 7472 6574 6368 6564 2f63 6f6d 7072   stretched/compr
-000117f0: 6573 7365 6420 6375 7272 656e 7420 7761  essed current wa
-00011800: 7665 666f 726d 2061 6d6f 6e67 2074 6865  veform among the
-00011810: 2022 6e62 7472 6961 6c22 2076 616c 7565   "nbtrial" value
-00011820: 732e 0a20 2020 2041 2072 6566 696e 6564  s..    A refined
-00011830: 2061 6e61 6c79 7369 7320 6973 2074 6865   analysis is the
-00011840: 6e20 7065 7266 6f72 6d65 6420 6172 6f75  n performed arou
-00011850: 6e64 2074 6869 7320 7661 6c75 6520 746f  nd this value to
-00011860: 206f 6274 6169 6e20 6120 6d6f 7265 2070   obtain a more p
-00011870: 7265 6369 7365 2064 762f 7620 6d65 6173  recise dv/v meas
-00011880: 7572 656d 656e 7420 2e0a 0a20 2020 204f  urement ...    O
-00011890: 7269 6769 6e61 6c6c 7920 6279 204c 2e20  riginally by L. 
-000118a0: 5669 656e 7320 3034 2f32 362f 3230 3138  Viens 04/26/2018
-000118b0: 2028 5669 656e 7320 6574 2061 6c2e 2c20   (Viens et al., 
-000118c0: 3230 3138 204a 4752 290a 2020 2020 6d6f  2018 JGR).    mo
-000118d0: 6469 6669 6564 2062 7920 4368 656e 6778  dified by Chengx
-000118e0: 696e 204a 6961 6e67 0a20 2020 2022 2222  in Jiang.    """
-000118f0: 0a20 2020 2023 206c 6f61 6420 636f 6d6d  .    # load comm
-00011900: 6f6e 2076 6172 6961 626c 6573 2066 726f  on variables fro
-00011910: 6d20 6469 6374 696f 6e61 7279 0a20 2020  m dictionary.   
-00011920: 2074 7769 6e20 3d20 7061 7261 5b22 7477   twin = para["tw
-00011930: 696e 225d 0a20 2020 2066 7265 7120 3d20  in"].    freq = 
-00011940: 7061 7261 5b22 6672 6571 225d 0a20 2020  para["freq"].   
-00011950: 2064 7420 3d20 7061 7261 5b22 6474 225d   dt = para["dt"]
-00011960: 0a20 2020 2074 6d69 6e20 3d20 6e70 2e6d  .    tmin = np.m
-00011970: 696e 2874 7769 6e29 0a20 2020 2074 6d61  in(twin).    tma
-00011980: 7820 3d20 6e70 2e6d 6178 2874 7769 6e29  x = np.max(twin)
-00011990: 0a20 2020 2066 6d69 6e20 3d20 6e70 2e6d  .    fmin = np.m
-000119a0: 696e 2866 7265 7129 0a20 2020 2066 6d61  in(freq).    fma
-000119b0: 7820 3d20 6e70 2e6d 6178 2866 7265 7129  x = np.max(freq)
-000119c0: 0a20 2020 2074 7665 6320 3d20 6e70 2e61  .    tvec = np.a
-000119d0: 7261 6e67 6528 746d 696e 2c20 746d 6178  range(tmin, tmax
-000119e0: 2c20 6474 290a 0a20 2020 2023 206d 616b  , dt)..    # mak
-000119f0: 6520 7573 6566 756c 206f 6e65 2066 6f72  e useful one for
-00011a00: 206d 6561 7375 7265 6d65 6e74 730a 2020   measurements.  
-00011a10: 2020 6476 6d69 6e20 3d20 2d6e 702e 6162    dvmin = -np.ab
-00011a20: 7328 6476 5f72 616e 6765 290a 2020 2020  s(dv_range).    
-00011a30: 6476 6d61 7820 3d20 6e70 2e61 6273 2864  dvmax = np.abs(d
-00011a40: 765f 7261 6e67 6529 0a20 2020 2045 7073  v_range).    Eps
-00011a50: 203d 2031 202b 2028 6e70 2e6c 696e 7370   = 1 + (np.linsp
-00011a60: 6163 6528 6476 6d69 6e2c 2064 766d 6178  ace(dvmin, dvmax
-00011a70: 2c20 6e62 7472 6961 6c29 290a 2020 2020  , nbtrial)).    
-00011a80: 636f 6620 3d20 6e70 2e7a 6572 6f73 2845  cof = np.zeros(E
-00011a90: 7073 2e73 6861 7065 2c20 6474 7970 653d  ps.shape, dtype=
-00011aa0: 6e70 2e66 6c6f 6174 3332 290a 0a20 2020  np.float32)..   
-00011ab0: 2023 2053 6574 206f 6620 7374 7265 7463   # Set of stretc
-00011ac0: 6865 642f 636f 6d70 7265 7373 6564 2063  hed/compressed c
-00011ad0: 7572 7265 6e74 2077 6176 6566 6f72 6d73  urrent waveforms
-00011ae0: 0a20 2020 2066 6f72 2069 6920 696e 2072  .    for ii in r
-00011af0: 616e 6765 286c 656e 2845 7073 2929 3a0a  ange(len(Eps)):.
-00011b00: 2020 2020 2020 2020 6e74 203d 2074 7665          nt = tve
-00011b10: 6320 2a20 4570 735b 6969 5d0a 2020 2020  c * Eps[ii].    
-00011b20: 2020 2020 7320 3d20 6e70 2e69 6e74 6572      s = np.inter
-00011b30: 7028 783d 7476 6563 2c20 7870 3d6e 742c  p(x=tvec, xp=nt,
-00011b40: 2066 703d 6375 7229 0a20 2020 2020 2020   fp=cur).       
-00011b50: 2077 6176 6566 6f72 6d5f 7265 6620 3d20   waveform_ref = 
-00011b60: 7265 660a 2020 2020 2020 2020 7761 7665  ref.        wave
-00011b70: 666f 726d 5f63 7572 203d 2073 0a20 2020  form_cur = s.   
-00011b80: 2020 2020 2063 6f66 5b69 695d 203d 206e       cof[ii] = n
-00011b90: 702e 636f 7272 636f 6566 2877 6176 6566  p.corrcoef(wavef
-00011ba0: 6f72 6d5f 7265 662c 2077 6176 6566 6f72  orm_ref, wavefor
-00011bb0: 6d5f 6375 7229 5b30 2c20 315d 0a0a 2020  m_cur)[0, 1]..  
-00011bc0: 2020 6364 7020 3d20 6e70 2e63 6f72 7263    cdp = np.corrc
-00011bd0: 6f65 6628 6375 722c 2072 6566 295b 302c  oef(cur, ref)[0,
-00011be0: 2031 5d20 2023 2063 6f72 7265 6c61 7469   1]  # correlati
-00011bf0: 6f6e 2063 6f65 6666 6963 6965 6e74 2062  on coefficient b
-00011c00: 6574 7765 656e 2074 6865 2072 6566 6572  etween the refer
-00011c10: 656e 6365 2061 6e64 2069 6e69 7469 616c  ence and initial
-00011c20: 2063 7572 7265 6e74 2077 6176 6566 6f72   current wavefor
-00011c30: 6d73 0a0a 2020 2020 2320 6669 6e64 2074  ms..    # find t
-00011c40: 6865 206d 6178 696d 756d 2063 6f72 7265  he maximum corre
-00011c50: 6c61 7469 6f6e 2063 6f65 6666 6963 6965  lation coefficie
-00011c60: 6e74 0a20 2020 2069 6d61 7820 3d20 6e70  nt.    imax = np
-00011c70: 2e6e 616e 6172 676d 6178 2863 6f66 290a  .nanargmax(cof).
-00011c80: 2020 2020 6966 2069 6d61 7820 3e3d 206c      if imax >= l
-00011c90: 656e 2845 7073 2920 2d20 323a 0a20 2020  en(Eps) - 2:.   
-00011ca0: 2020 2020 2069 6d61 7820 3d20 696d 6178       imax = imax
-00011cb0: 202d 2032 0a20 2020 2069 6620 696d 6178   - 2.    if imax
-00011cc0: 203c 3d20 323a 0a20 2020 2020 2020 2069   <= 2:.        i
-00011cd0: 6d61 7820 3d20 696d 6178 202b 2032 0a0a  max = imax + 2..
-00011ce0: 2020 2020 2320 5072 6f63 6565 6420 746f      # Proceed to
-00011cf0: 2074 6865 2073 6563 6f6e 6420 7374 6570   the second step
-00011d00: 2074 6f20 6765 7420 6120 6d6f 7265 2070   to get a more p
-00011d10: 7265 6369 7365 2064 762f 7620 6d65 6173  recise dv/v meas
-00011d20: 7572 656d 656e 740a 2020 2020 6474 6669  urement.    dtfi
-00011d30: 6e65 7220 3d20 6e70 2e6c 696e 7370 6163  ner = np.linspac
-00011d40: 6528 4570 735b 696d 6178 202d 2032 5d2c  e(Eps[imax - 2],
-00011d50: 2045 7073 5b69 6d61 7820 2b20 325d 2c20   Eps[imax + 2], 
-00011d60: 3130 3029 0a20 2020 206e 636f 6620 3d20  100).    ncof = 
-00011d70: 6e70 2e7a 6572 6f73 2864 7466 696e 6572  np.zeros(dtfiner
-00011d80: 2e73 6861 7065 2c20 6474 7970 653d 6e70  .shape, dtype=np
-00011d90: 2e66 6c6f 6174 3332 290a 2020 2020 666f  .float32).    fo
-00011da0: 7220 6969 2069 6e20 7261 6e67 6528 6c65  r ii in range(le
-00011db0: 6e28 6474 6669 6e65 7229 293a 0a20 2020  n(dtfiner)):.   
-00011dc0: 2020 2020 206e 7420 3d20 7476 6563 202a       nt = tvec *
-00011dd0: 2064 7466 696e 6572 5b69 695d 0a20 2020   dtfiner[ii].   
-00011de0: 2020 2020 2073 203d 206e 702e 696e 7465       s = np.inte
-00011df0: 7270 2878 3d74 7665 632c 2078 703d 6e74  rp(x=tvec, xp=nt
-00011e00: 2c20 6670 3d63 7572 290a 2020 2020 2020  , fp=cur).      
-00011e10: 2020 7761 7665 666f 726d 5f72 6566 203d    waveform_ref =
-00011e20: 2072 6566 0a20 2020 2020 2020 2077 6176   ref.        wav
-00011e30: 6566 6f72 6d5f 6375 7220 3d20 730a 2020  eform_cur = s.  
-00011e40: 2020 2020 2020 6e63 6f66 5b69 695d 203d        ncof[ii] =
-00011e50: 206e 702e 636f 7272 636f 6566 2877 6176   np.corrcoef(wav
-00011e60: 6566 6f72 6d5f 7265 662c 2077 6176 6566  eform_ref, wavef
-00011e70: 6f72 6d5f 6375 7229 5b30 2c20 315d 0a0a  orm_cur)[0, 1]..
-00011e80: 2020 2020 6363 203d 206e 702e 6d61 7828      cc = np.max(
-00011e90: 6e63 6f66 2920 2023 2046 696e 6420 6d61  ncof)  # Find ma
-00011ea0: 7869 6d75 6d20 636f 7272 656c 6174 696f  ximum correlatio
-00011eb0: 6e20 636f 6566 6669 6369 656e 7420 6f66  n coefficient of
-00011ec0: 2074 6865 2072 6566 696e 6564 2020 616e   the refined  an
-00011ed0: 616c 7973 6973 0a20 2020 2064 7620 3d20  alysis.    dv = 
-00011ee0: 3130 302e 3020 2a20 6474 6669 6e65 725b  100.0 * dtfiner[
-00011ef0: 6e70 2e61 7267 6d61 7828 6e63 6f66 295d  np.argmax(ncof)]
-00011f00: 202d 2031 3030 2020 2320 4d75 6c74 6970   - 100  # Multip
-00011f10: 6c79 2062 7920 3130 3020 746f 2063 6f6e  ly by 100 to con
-00011f20: 7665 7274 2074 6f20 7065 7263 656e 7461  vert to percenta
-00011f30: 6765 2028 4570 7369 6c6f 6e20 3d20 2d64  ge (Epsilon = -d
-00011f40: 742f 7420 3d20 6476 2f76 290a 0a20 2020  t/t = dv/v)..   
-00011f50: 2023 2045 7272 6f72 2063 6f6d 7075 7461   # Error computa
-00011f60: 7469 6f6e 2062 6173 6564 206f 6e20 5765  tion based on We
-00011f70: 6176 6572 2065 7420 616c 2028 3230 3131  aver et al (2011
-00011f80: 292c 204f 6e20 7468 6520 7072 6563 6973  ), On the precis
-00011f90: 696f 6e20 6f66 206e 6f69 7365 2d63 6f72  ion of noise-cor
-00011fa0: 7265 6c61 7469 6f6e 0a20 2020 2023 2069  relation.    # i
-00011fb0: 6e74 6572 6665 726f 6d65 7472 792c 2047  nterferometry, G
-00011fc0: 656f 7068 7973 2e20 4a2e 2049 6e74 2e2c  eophys. J. Int.,
-00011fd0: 2031 3835 2833 290a 2020 2020 5420 3d20   185(3).    T = 
-00011fe0: 3120 2f20 2866 6d61 7820 2d20 666d 696e  1 / (fmax - fmin
-00011ff0: 290a 2020 2020 5820 3d20 6363 0a20 2020  ).    X = cc.   
-00012000: 2077 6320 3d20 6e70 2e70 6920 2a20 2866   wc = np.pi * (f
-00012010: 6d69 6e20 2b20 666d 6178 290a 2020 2020  min + fmax).    
-00012020: 7431 203d 206e 702e 6d69 6e28 5b74 6d69  t1 = np.min([tmi
-00012030: 6e2c 2074 6d61 785d 290a 2020 2020 7432  n, tmax]).    t2
-00012040: 203d 206e 702e 6d61 7828 5b74 6d69 6e2c   = np.max([tmin,
-00012050: 2074 6d61 785d 290a 2020 2020 6572 726f   tmax]).    erro
-00012060: 7220 3d20 3130 3020 2a20 280a 2020 2020  r = 100 * (.    
-00012070: 2020 2020 6e70 2e73 7172 7428 3120 2d20      np.sqrt(1 - 
-00012080: 582a 2a32 2920 2f20 2832 202a 2058 2920  X**2) / (2 * X) 
-00012090: 2a20 6e70 2e73 7172 7428 2836 202a 206e  * np.sqrt((6 * n
-000120a0: 702e 7371 7274 286e 702e 7069 202f 2032  p.sqrt(np.pi / 2
-000120b0: 2920 2a20 5429 202f 2028 7763 2a2a 3220  ) * T) / (wc**2 
-000120c0: 2a20 2874 322a 2a33 202d 2074 312a 2a33  * (t2**3 - t1**3
-000120d0: 2929 290a 2020 2020 290a 0a20 2020 2072  ))).    )..    r
-000120e0: 6574 7572 6e20 6476 2c20 6572 726f 722c  eturn dv, error,
-000120f0: 2063 632c 2063 6470 0a0a 0a64 6566 2073   cc, cdp...def s
-00012100: 7472 6574 6368 696e 675f 7665 6374 2872  tretching_vect(r
-00012110: 6566 2c20 6375 722c 2064 765f 7261 6e67  ef, cur, dv_rang
-00012120: 652c 206e 6274 7269 616c 2c20 7061 7261  e, nbtrial, para
-00012130: 293a 0a20 2020 2022 2222 0a20 2020 2054  ):.    """.    T
-00012140: 6869 7320 6675 6e63 7469 6f6e 2063 6f6d  his function com
-00012150: 7061 7265 7320 7468 6520 5265 6665 7265  pares the Refere
-00012160: 6e63 6520 7761 7665 666f 726d 2074 6f20  nce waveform to 
-00012170: 7374 7265 7463 6865 642f 636f 6d70 7265  stretched/compre
-00012180: 7373 6564 2063 7572 7265 6e74 2077 6176  ssed current wav
-00012190: 6566 6f72 6d73 0a20 2020 2074 6f20 6765  eforms.    to ge
-000121a0: 7420 7468 6520 7265 6c61 7469 7665 2073  t the relative s
-000121b0: 6569 736d 6963 2076 656c 6f63 6974 7920  eismic velocity 
-000121c0: 7661 7269 6174 696f 6e20 2861 6e64 2061  variation (and a
-000121d0: 7373 6f63 6961 7465 6420 6572 726f 7229  ssociated error)
-000121e0: 2e0a 2020 2020 4974 2061 6c73 6f20 636f  ..    It also co
-000121f0: 6d70 7574 6573 2074 6865 2063 6f72 7265  mputes the corre
-00012200: 6c61 7469 6f6e 2063 6f65 6666 6963 6965  lation coefficie
-00012210: 6e74 2062 6574 7765 656e 2074 6865 2052  nt between the R
-00012220: 6566 6572 656e 6365 2077 6176 6566 6f72  eference wavefor
-00012230: 6d20 616e 6420 7468 6520 6375 7272 656e  m and the curren
-00012240: 7420 7761 7665 666f 726d 2e0a 0a20 2020  t waveform...   
-00012250: 2050 4152 414d 4554 4552 533a 0a20 2020   PARAMETERS:.   
-00012260: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
-00012270: 2d0a 2020 2020 7265 663a 2052 6566 6572  -.    ref: Refer
-00012280: 656e 6365 2077 6176 6566 6f72 6d20 286e  ence waveform (n
-00012290: 702e 6e64 6172 7261 792c 2073 697a 6520  p.ndarray, size 
-000122a0: 4e29 0a20 2020 2063 7572 3a20 4375 7272  N).    cur: Curr
-000122b0: 656e 7420 7761 7665 666f 726d 2028 6e70  ent waveform (np
-000122c0: 2e6e 6461 7272 6179 2c20 7369 7a65 204e  .ndarray, size N
-000122d0: 290a 2020 2020 6476 5f72 616e 6765 3a20  ).    dv_range: 
-000122e0: 6162 736f 6c75 7465 2062 6f75 6e64 2066  absolute bound f
-000122f0: 6f72 2074 6865 2076 656c 6f63 6974 7920  or the velocity 
-00012300: 7661 7269 6174 696f 6e3b 2065 7861 6d70  variation; examp
-00012310: 6c65 3a20 6476 3d30 2e30 3320 666f 7220  le: dv=0.03 for 
-00012320: 5b2d 332c 335d 250a 2020 2020 6f66 2072  [-3,3]%.    of r
-00012330: 656c 6174 6976 6520 7665 6c6f 6369 7479  elative velocity
-00012340: 2063 6861 6e67 6520 2827 666c 6f61 7427   change ('float'
-00012350: 290a 2020 2020 6e62 7472 6961 6c3a 206e  ).    nbtrial: n
-00012360: 756d 6265 7220 6f66 2073 7472 6574 6368  umber of stretch
-00012370: 696e 6720 636f 6566 6669 6369 656e 7420  ing coefficient 
-00012380: 6265 7477 6565 6e20 6476 6d69 6e20 616e  between dvmin an
-00012390: 6420 6476 6d61 782c 206e 6f20 6e65 6564  d dvmax, no need
-000123a0: 2074 6f20 6265 2068 6967 6865 7220 7468   to be higher th
-000123b0: 616e 2031 3030 2020 2827 666c 6f61 7427  an 100  ('float'
-000123c0: 290a 2020 2020 7061 7261 3a20 7665 6374  ).    para: vect
-000123d0: 6f72 206f 6620 7468 6520 696e 6469 6365  or of the indice
-000123e0: 7320 6f66 2074 6865 2063 7572 2061 6e64  s of the cur and
-000123f0: 2072 6566 2077 696e 646f 7773 206f 6e20   ref windows on 
-00012400: 7769 6368 2079 6f75 2077 616e 7420 746f  wich you want to
-00012410: 2064 6f20 7468 650a 2020 2020 6d65 6173   do the.    meas
-00012420: 7572 656d 656e 7473 2028 6e70 2e6e 6461  urements (np.nda
-00012430: 7272 6179 2c20 7369 7a65 2074 6d69 6e2a  rray, size tmin*
-00012440: 6465 6c74 613a 746d 6178 2a64 656c 7461  delta:tmax*delta
-00012450: 290a 2020 2020 466f 7220 6572 726f 7220  ).    For error 
-00012460: 636f 6d70 7574 6174 696f 6e2c 2077 6520  computation, we 
-00012470: 6e65 6564 2070 6172 616d 6574 6572 733a  need parameters:
-00012480: 0a20 2020 2020 2020 2066 6d69 6e3a 206d  .        fmin: m
-00012490: 696e 696d 756d 2066 7265 7175 656e 6379  inimum frequency
-000124a0: 206f 6620 7468 6520 6461 7461 0a20 2020   of the data.   
-000124b0: 2020 2020 2066 6d61 783a 206d 6178 696d       fmax: maxim
-000124c0: 756d 2066 7265 7175 656e 6379 206f 6620  um frequency of 
-000124d0: 7468 6520 6461 7461 0a20 2020 2020 2020  the data.       
-000124e0: 2074 6d69 6e3a 206d 696e 696d 756d 2074   tmin: minimum t
-000124f0: 696d 6520 7769 6e64 6f77 2077 6865 7265  ime window where
-00012500: 2074 6865 2064 762f 7620 6973 2063 6f6d   the dv/v is com
-00012510: 7075 7465 640a 2020 2020 2020 2020 746d  puted.        tm
-00012520: 6178 3a20 6d61 7869 6d75 6d20 7469 6d65  ax: maximum time
-00012530: 2077 696e 646f 7720 7768 6572 6520 7468   window where th
-00012540: 6520 6476 2f76 2069 7320 636f 6d70 7574  e dv/v is comput
-00012550: 6564 0a20 2020 2052 4554 5552 4e53 3a0a  ed.    RETURNS:.
-00012560: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
-00012570: 2d2d 2d2d 0a20 2020 2064 763a 2052 656c  ----.    dv: Rel
-00012580: 6174 6976 6520 7665 6c6f 6369 7479 2063  ative velocity c
-00012590: 6861 6e67 6520 6476 2f76 2028 696e 2025  hange dv/v (in %
-000125a0: 290a 2020 2020 6363 3a20 636f 7272 656c  ).    cc: correl
-000125b0: 6174 696f 6e20 636f 6566 6669 6369 656e  ation coefficien
-000125c0: 7420 6265 7477 6565 6e20 7468 6520 7265  t between the re
-000125d0: 6665 7265 6e63 6520 7761 7665 666f 726d  ference waveform
-000125e0: 2061 6e64 2074 6865 2062 6573 7420 7374   and the best st
-000125f0: 7265 7463 6865 642f 636f 6d70 7265 7373  retched/compress
-00012600: 6564 2063 7572 7265 6e74 2077 6176 6566  ed current wavef
-00012610: 6f72 6d0a 2020 2020 6364 703a 2063 6f72  orm.    cdp: cor
-00012620: 7265 6c61 7469 6f6e 2063 6f65 6666 6963  relation coeffic
-00012630: 6965 6e74 2062 6574 7765 656e 2074 6865  ient between the
-00012640: 2072 6566 6572 656e 6365 2077 6176 6566   reference wavef
-00012650: 6f72 6d20 616e 6420 7468 6520 696e 6974  orm and the init
-00012660: 6961 6c20 6375 7272 656e 7420 7761 7665  ial current wave
-00012670: 666f 726d 0a20 2020 2065 7272 6f72 3a20  form.    error: 
-00012680: 4572 726f 7273 2069 6e20 7468 6520 6476  Errors in the dv
-00012690: 2f76 206d 6561 7375 7265 6d65 6e74 7320  /v measurements 
-000126a0: 6261 7365 6420 6f6e 2057 6561 7665 7220  based on Weaver 
-000126b0: 6574 2061 6c20 2832 3031 3129 2c20 4f6e  et al (2011), On
-000126c0: 2074 6865 2070 7265 6369 7369 6f6e 0a20   the precision. 
-000126d0: 2020 206f 6620 6e6f 6973 652d 636f 7272     of noise-corr
-000126e0: 656c 6174 696f 6e20 696e 7465 7266 6572  elation interfer
-000126f0: 6f6d 6574 7279 2c20 4765 6f70 6879 732e  ometry, Geophys.
-00012700: 204a 2e20 496e 742e 2c20 3138 3528 3329   J. Int., 185(3)
-00012710: 0a0a 2020 2020 4e6f 7465 3a20 5468 6520  ..    Note: The 
-00012720: 636f 6465 2066 6972 7374 2066 696e 6473  code first finds
-00012730: 2074 6865 2062 6573 7420 636f 7272 656c   the best correl
-00012740: 6174 696f 6e20 636f 6566 6669 6369 656e  ation coefficien
-00012750: 7420 6265 7477 6565 6e20 7468 6520 5265  t between the Re
-00012760: 6665 7265 6e63 6520 7761 7665 666f 726d  ference waveform
-00012770: 2061 6e64 0a20 2020 2074 6865 2073 7472   and.    the str
-00012780: 6574 6368 6564 2f63 6f6d 7072 6573 7365  etched/compresse
-00012790: 6420 6375 7272 656e 7420 7761 7665 666f  d current wavefo
-000127a0: 726d 2061 6d6f 6e67 2074 6865 2022 6e62  rm among the "nb
-000127b0: 7472 6961 6c22 2076 616c 7565 732e 0a20  trial" values.. 
-000127c0: 2020 2041 2072 6566 696e 6564 2061 6e61     A refined ana
-000127d0: 6c79 7369 7320 6973 2074 6865 6e20 7065  lysis is then pe
-000127e0: 7266 6f72 6d65 6420 6172 6f75 6e64 2074  rformed around t
-000127f0: 6869 7320 7661 6c75 6520 746f 206f 6274  his value to obt
-00012800: 6169 6e20 6120 6d6f 7265 2070 7265 6369  ain a more preci
-00012810: 7365 2064 762f 7620 6d65 6173 7572 656d  se dv/v measurem
-00012820: 656e 7420 2e0a 0a20 2020 204f 7269 6769  ent ...    Origi
-00012830: 6e61 6c6c 7920 6279 204c 2e20 5669 656e  nally by L. Vien
-00012840: 7320 3034 2f32 362f 3230 3138 2028 5669  s 04/26/2018 (Vi
-00012850: 656e 7320 6574 2061 6c2e 2c20 3230 3138  ens et al., 2018
-00012860: 204a 4752 290a 2020 2020 6d6f 6469 6669   JGR).    modifi
-00012870: 6564 2062 7920 4368 656e 6778 696e 204a  ed by Chengxin J
-00012880: 6961 6e67 0a20 2020 206d 6f64 6966 6965  iang.    modifie
-00012890: 6420 6279 204c 6175 7261 2045 726d 6572  d by Laura Ermer
-000128a0: 743a 2076 6563 746f 7269 7a65 6420 7665  t: vectorized ve
-000128b0: 7273 696f 6e0a 2020 2020 2222 220a 2020  rsion.    """.  
-000128c0: 2020 2320 6c6f 6164 2063 6f6d 6d6f 6e20    # load common 
-000128d0: 7661 7269 6162 6c65 7320 6672 6f6d 2064  variables from d
-000128e0: 6963 7469 6f6e 6172 790a 2020 2020 7477  ictionary.    tw
-000128f0: 696e 203d 2070 6172 615b 2274 7769 6e22  in = para["twin"
-00012900: 5d0a 2020 2020 6672 6571 203d 2070 6172  ].    freq = par
-00012910: 615b 2266 7265 7122 5d0a 2020 2020 6474  a["freq"].    dt
-00012920: 203d 2070 6172 615b 2264 7422 5d0a 2020   = para["dt"].  
-00012930: 2020 746d 696e 203d 206e 702e 6d69 6e28    tmin = np.min(
-00012940: 7477 696e 290a 2020 2020 746d 6178 203d  twin).    tmax =
-00012950: 206e 702e 6d61 7828 7477 696e 290a 2020   np.max(twin).  
-00012960: 2020 666d 696e 203d 206e 702e 6d69 6e28    fmin = np.min(
-00012970: 6672 6571 290a 2020 2020 666d 6178 203d  freq).    fmax =
-00012980: 206e 702e 6d61 7828 6672 6571 290a 2020   np.max(freq).  
-00012990: 2020 7476 6563 203d 206e 702e 6172 616e    tvec = np.aran
-000129a0: 6765 2874 6d69 6e2c 2074 6d61 782c 2064  ge(tmin, tmax, d
-000129b0: 7429 0a0a 2020 2020 2320 6d61 6b65 2075  t)..    # make u
-000129c0: 7365 6675 6c20 6f6e 6520 666f 7220 6d65  seful one for me
-000129d0: 6173 7572 656d 656e 7473 0a20 2020 2064  asurements.    d
-000129e0: 766d 696e 203d 202d 6e70 2e61 6273 2864  vmin = -np.abs(d
-000129f0: 765f 7261 6e67 6529 0a20 2020 2064 766d  v_range).    dvm
-00012a00: 6178 203d 206e 702e 6162 7328 6476 5f72  ax = np.abs(dv_r
-00012a10: 616e 6765 290a 2020 2020 4570 7320 3d20  ange).    Eps = 
-00012a20: 3120 2b20 286e 702e 6c69 6e73 7061 6365  1 + (np.linspace
-00012a30: 2864 766d 696e 2c20 6476 6d61 782c 206e  (dvmin, dvmax, n
-00012a40: 6274 7269 616c 2929 0a20 2020 2063 6470  btrial)).    cdp
-00012a50: 203d 206e 702e 636f 7272 636f 6566 2863   = np.corrcoef(c
-00012a60: 7572 2c20 7265 6629 5b30 2c20 315d 2020  ur, ref)[0, 1]  
-00012a70: 2320 636f 7272 656c 6174 696f 6e20 636f  # correlation co
-00012a80: 6566 6669 6369 656e 7420 6265 7477 6565  efficient betwee
-00012a90: 6e20 7468 6520 7265 6665 7265 6e63 6520  n the reference 
-00012aa0: 616e 6420 696e 6974 6961 6c20 6375 7272  and initial curr
-00012ab0: 656e 7420 7761 7665 666f 726d 730a 2020  ent waveforms.  
-00012ac0: 2020 7761 7665 666f 726d 7320 3d20 6e70    waveforms = np
-00012ad0: 2e7a 6572 6f73 2828 6e62 7472 6961 6c20  .zeros((nbtrial 
-00012ae0: 2b20 312c 206c 656e 2872 6566 2929 290a  + 1, len(ref))).
-00012af0: 2020 2020 7761 7665 666f 726d 735b 302c      waveforms[0,
-00012b00: 203a 5d20 3d20 7265 660a 0a20 2020 2023   :] = ref..    #
-00012b10: 2053 6574 206f 6620 7374 7265 7463 6865   Set of stretche
-00012b20: 642f 636f 6d70 7265 7373 6564 2063 7572  d/compressed cur
-00012b30: 7265 6e74 2077 6176 6566 6f72 6d73 0a20  rent waveforms. 
-00012b40: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
-00012b50: 6765 286e 6274 7269 616c 293a 0a20 2020  ge(nbtrial):.   
-00012b60: 2020 2020 206e 7420 3d20 7476 6563 202a       nt = tvec *
-00012b70: 2045 7073 5b69 695d 0a20 2020 2020 2020   Eps[ii].       
-00012b80: 2073 203d 206e 702e 696e 7465 7270 2878   s = np.interp(x
-00012b90: 3d74 7665 632c 2078 703d 6e74 2c20 6670  =tvec, xp=nt, fp
-00012ba0: 3d63 7572 290a 2020 2020 2020 2020 7761  =cur).        wa
-00012bb0: 7665 666f 726d 735b 6969 202b 2031 2c20  veforms[ii + 1, 
-00012bc0: 3a5d 203d 2073 0a20 2020 2063 6f66 203d  :] = s.    cof =
-00012bd0: 206e 702e 636f 7272 636f 6566 2877 6176   np.corrcoef(wav
-00012be0: 6566 6f72 6d73 295b 305d 5b31 3a5d 0a0a  eforms)[0][1:]..
-00012bf0: 2020 2020 2320 6669 6e64 2074 6865 206d      # find the m
-00012c00: 6178 696d 756d 2063 6f72 7265 6c61 7469  aximum correlati
-00012c10: 6f6e 2063 6f65 6666 6963 6965 6e74 0a20  on coefficient. 
-00012c20: 2020 2069 6d61 7820 3d20 6e70 2e6e 616e     imax = np.nan
-00012c30: 6172 676d 6178 2863 6f66 290a 2020 2020  argmax(cof).    
-00012c40: 6966 2069 6d61 7820 3e3d 206c 656e 2845  if imax >= len(E
-00012c50: 7073 2920 2d20 323a 0a20 2020 2020 2020  ps) - 2:.       
-00012c60: 2069 6d61 7820 3d20 696d 6178 202d 2032   imax = imax - 2
-00012c70: 0a20 2020 2069 6620 696d 6178 203c 2032  .    if imax < 2
-00012c80: 3a0a 2020 2020 2020 2020 696d 6178 203d  :.        imax =
-00012c90: 2069 6d61 7820 2b20 320a 0a20 2020 2023   imax + 2..    #
-00012ca0: 2050 726f 6365 6564 2074 6f20 7468 6520   Proceed to the 
-00012cb0: 7365 636f 6e64 2073 7465 7020 746f 2067  second step to g
-00012cc0: 6574 2061 206d 6f72 6520 7072 6563 6973  et a more precis
-00012cd0: 6520 6476 2f76 206d 6561 7375 7265 6d65  e dv/v measureme
-00012ce0: 6e74 0a20 2020 2064 7466 696e 6572 203d  nt.    dtfiner =
-00012cf0: 206e 702e 6c69 6e73 7061 6365 2845 7073   np.linspace(Eps
-00012d00: 5b69 6d61 7820 2d20 325d 2c20 4570 735b  [imax - 2], Eps[
-00012d10: 696d 6178 202b 2032 5d2c 206e 6274 7269  imax + 2], nbtri
-00012d20: 616c 290a 2020 2020 2320 6e63 6f66 2020  al).    # ncof  
-00012d30: 2020 3d20 6e70 2e7a 6572 6f73 2864 7466    = np.zeros(dtf
-00012d40: 696e 6572 2e73 6861 7065 2c64 7479 7065  iner.shape,dtype
-00012d50: 3d6e 702e 666c 6f61 7433 3229 0a20 2020  =np.float32).   
-00012d60: 2077 6176 6566 6f72 6d73 203d 206e 702e   waveforms = np.
-00012d70: 7a65 726f 7328 286e 6274 7269 616c 202b  zeros((nbtrial +
-00012d80: 2031 2c20 6c65 6e28 7265 6629 2929 0a20   1, len(ref))). 
-00012d90: 2020 2077 6176 6566 6f72 6d73 5b30 2c20     waveforms[0, 
-00012da0: 3a5d 203d 2072 6566 0a20 2020 2066 6f72  :] = ref.    for
-00012db0: 2069 6920 696e 2072 616e 6765 286c 656e   ii in range(len
-00012dc0: 2864 7466 696e 6572 2929 3a0a 2020 2020  (dtfiner)):.    
-00012dd0: 2020 2020 6e74 203d 2074 7665 6320 2a20      nt = tvec * 
-00012de0: 6474 6669 6e65 725b 6969 5d0a 2020 2020  dtfiner[ii].    
-00012df0: 2020 2020 7320 3d20 6e70 2e69 6e74 6572      s = np.inter
-00012e00: 7028 783d 7476 6563 2c20 7870 3d6e 742c  p(x=tvec, xp=nt,
-00012e10: 2066 703d 6375 7229 0a20 2020 2020 2020   fp=cur).       
-00012e20: 2077 6176 6566 6f72 6d73 5b69 6920 2b20   waveforms[ii + 
-00012e30: 312c 203a 5d20 3d20 730a 2020 2020 6e63  1, :] = s.    nc
-00012e40: 6f66 203d 206e 702e 636f 7272 636f 6566  of = np.corrcoef
-00012e50: 2877 6176 6566 6f72 6d73 295b 305d 5b31  (waveforms)[0][1
-00012e60: 3a5d 0a20 2020 2063 6320 3d20 6e70 2e6d  :].    cc = np.m
-00012e70: 6178 286e 636f 6629 2020 2320 4669 6e64  ax(ncof)  # Find
-00012e80: 206d 6178 696d 756d 2063 6f72 7265 6c61   maximum correla
-00012e90: 7469 6f6e 2063 6f65 6666 6963 6965 6e74  tion coefficient
-00012ea0: 206f 6620 7468 6520 7265 6669 6e65 6420   of the refined 
-00012eb0: 2061 6e61 6c79 7369 730a 2020 2020 6476   analysis.    dv
-00012ec0: 203d 2031 3030 2e30 202a 2064 7466 696e   = 100.0 * dtfin
-00012ed0: 6572 5b6e 702e 6172 676d 6178 286e 636f  er[np.argmax(nco
-00012ee0: 6629 5d20 2d20 3130 3020 2023 204d 756c  f)] - 100  # Mul
-00012ef0: 7469 706c 7920 6279 2031 3030 2074 6f20  tiply by 100 to 
-00012f00: 636f 6e76 6572 7420 746f 2070 6572 6365  convert to perce
-00012f10: 6e74 6167 6520 2845 7073 696c 6f6e 203d  ntage (Epsilon =
-00012f20: 202d 6474 2f74 203d 2064 762f 7629 0a0a   -dt/t = dv/v)..
-00012f30: 2020 2020 2320 4572 726f 7220 636f 6d70      # Error comp
-00012f40: 7574 6174 696f 6e20 6261 7365 6420 6f6e  utation based on
-00012f50: 2057 6561 7665 7220 6574 2061 6c20 2832   Weaver et al (2
-00012f60: 3031 3129 2c20 4f6e 2074 6865 2070 7265  011), On the pre
-00012f70: 6369 7369 6f6e 206f 6620 6e6f 6973 652d  cision of noise-
-00012f80: 636f 7272 656c 6174 696f 6e20 696e 7465  correlation inte
-00012f90: 7266 6572 6f6d 6574 7279 2c0a 2020 2020  rferometry,.    
-00012fa0: 2320 4765 6f70 6879 732e 204a 2e20 496e  # Geophys. J. In
-00012fb0: 742e 2c20 3138 3528 3329 0a20 2020 2054  t., 185(3).    T
-00012fc0: 203d 2031 202f 2028 666d 6178 202d 2066   = 1 / (fmax - f
-00012fd0: 6d69 6e29 0a20 2020 2058 203d 2063 630a  min).    X = cc.
-00012fe0: 2020 2020 7763 203d 206e 702e 7069 202a      wc = np.pi *
-00012ff0: 2028 666d 696e 202b 2066 6d61 7829 0a20   (fmin + fmax). 
-00013000: 2020 2074 3120 3d20 6e70 2e6d 696e 285b     t1 = np.min([
-00013010: 746d 696e 2c20 746d 6178 5d29 0a20 2020  tmin, tmax]).   
-00013020: 2074 3220 3d20 6e70 2e6d 6178 285b 746d   t2 = np.max([tm
-00013030: 696e 2c20 746d 6178 5d29 0a20 2020 2065  in, tmax]).    e
-00013040: 7272 6f72 203d 2031 3030 202a 2028 0a20  rror = 100 * (. 
-00013050: 2020 2020 2020 206e 702e 7371 7274 2831         np.sqrt(1
-00013060: 202d 2058 2a2a 3229 202f 2028 3220 2a20   - X**2) / (2 * 
-00013070: 5829 202a 206e 702e 7371 7274 2828 3620  X) * np.sqrt((6 
-00013080: 2a20 6e70 2e73 7172 7428 6e70 2e70 6920  * np.sqrt(np.pi 
-00013090: 2f20 3229 202a 2054 2920 2f20 2877 632a  / 2) * T) / (wc*
-000130a0: 2a32 202a 2028 7432 2a2a 3320 2d20 7431  *2 * (t2**3 - t1
-000130b0: 2a2a 3329 2929 0a20 2020 2029 0a0a 2020  **3))).    )..  
-000130c0: 2020 7265 7475 726e 2064 762c 2065 7272    return dv, err
-000130d0: 6f72 2c20 6363 2c20 6364 700a 0a0a 6465  or, cc, cdp...de
-000130e0: 6620 6474 775f 6476 7628 7265 662c 2063  f dtw_dvv(ref, c
-000130f0: 7572 2c20 7061 7261 2c20 6d61 784c 6167  ur, para, maxLag
-00013100: 2c20 622c 2064 6972 6563 7469 6f6e 293a  , b, direction):
-00013110: 0a20 2020 2022 2222 0a20 2020 2044 796e  .    """.    Dyn
-00013120: 616d 6963 2074 696d 6520 7761 7270 696e  amic time warpin
-00013130: 6720 666f 7220 6476 2f76 2065 7374 696d  g for dv/v estim
-00013140: 6174 696f 6e2e 0a0a 2020 2020 5041 5241  ation...    PARA
-00013150: 4d45 5445 5253 3a0a 2020 2020 2d2d 2d2d  METERS:.    ----
-00013160: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
-00013170: 2072 6566 203a 2072 6566 6572 656e 6365   ref : reference
-00013180: 2073 6967 6e61 6c20 286e 702e 6172 7261   signal (np.arra
-00013190: 792c 2073 697a 6520 4e29 0a20 2020 2063  y, size N).    c
-000131a0: 7572 203a 2063 7572 7265 6e74 2073 6967  ur : current sig
-000131b0: 6e61 6c20 286e 702e 6172 7261 792c 2073  nal (np.array, s
-000131c0: 697a 6520 4e29 0a20 2020 2070 6172 613a  ize N).    para:
-000131d0: 2064 6963 7420 636f 6e74 6169 6e69 6e67   dict containing
-000131e0: 2075 7365 6675 6c20 7061 7261 6d65 7465   useful paramete
-000131f0: 7273 2061 626f 7574 2074 6865 2064 6174  rs about the dat
-00013200: 6120 7769 6e64 6f77 2061 6e64 2074 6172  a window and tar
-00013210: 6765 7465 6420 6672 6571 7565 6e63 790a  geted frequency.
-00013220: 2020 2020 6d61 784c 6167 203a 206d 6178      maxLag : max
-00013230: 206e 756d 6265 7220 6f66 2070 6f69 6e74   number of point
-00013240: 7320 746f 2073 6561 7263 6820 666f 7277  s to search forw
-00013250: 6172 6420 616e 6420 6261 636b 7761 7264  ard and backward
-00013260: 2e0a 2020 2020 2020 2020 2020 2020 5375  ..            Su
-00013270: 6767 6573 7420 7365 7474 696e 6720 6974  ggest setting it
-00013280: 206c 6172 6765 7220 6966 2077 696e 646f   larger if windo
-00013290: 7720 6973 2073 6574 206c 6172 6765 722e  w is set larger.
-000132a0: 0a20 2020 2062 203a 2062 2d76 616c 7565  .    b : b-value
-000132b0: 2074 6f20 6c69 6d69 7420 7374 7261 696e   to limit strain
-000132c0: 2c20 7768 6963 6820 6973 2074 6f20 6c69  , which is to li
-000132d0: 6d69 7420 7468 6520 6d61 7869 6d75 6d20  mit the maximum 
-000132e0: 7665 6c6f 6369 7479 2070 6572 7475 7262  velocity perturb
-000132f0: 6174 696f 6e2e 0a20 2020 2020 2020 2020  ation..         
-00013300: 2020 2053 6565 2065 7175 6174 696f 6e20     See equation 
-00013310: 3131 2069 6e20 284d 696b 6573 656c 6c20  11 in (Mikesell 
-00013320: 6574 2061 6c2e 2032 3031 3529 0a20 2020  et al. 2015).   
-00013330: 2064 6972 6563 7469 6f6e 3a20 6469 7265   direction: dire
-00013340: 6374 696f 6e20 746f 2061 6363 756d 756c  ction to accumul
-00013350: 6174 6520 6572 726f 7273 2028 313d 666f  ate errors (1=fo
-00013360: 7277 6172 642c 202d 313d 6261 636b 7761  rward, -1=backwa
-00013370: 7264 290a 2020 2020 5245 5455 524e 533a  rd).    RETURNS:
-00013380: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
-00013390: 2d2d 2d2d 2d2d 2d0a 2020 2020 2d6d 3020  -------.    -m0 
-000133a0: 3a20 6573 7469 6d61 7465 6420 6476 2f76  : estimated dv/v
-000133b0: 0a20 2020 2065 6d30 203a 2065 7272 6f72  .    em0 : error
-000133c0: 206f 6620 6476 2f76 2065 7374 696d 6174   of dv/v estimat
-000133d0: 696f 6e0a 0a20 2020 204f 7269 6769 6e61  ion..    Origina
-000133e0: 6c20 6279 2044 6920 5961 6e67 0a20 2020  l by Di Yang.   
-000133f0: 204c 6173 7420 6d6f 6469 6669 6564 2062   Last modified b
-00013400: 7920 4479 6c61 6e20 4d69 6b65 7365 6c6c  y Dylan Mikesell
-00013410: 2028 3235 2046 6562 2e20 3230 3135 290a   (25 Feb. 2015).
-00013420: 2020 2020 5472 616e 736c 6174 6564 2074      Translated t
-00013430: 6f20 7079 7468 6f6e 2062 7920 5469 6d20  o python by Tim 
-00013440: 436c 656d 656e 7473 2028 3137 2041 7567  Clements (17 Aug
-00013450: 2e20 3230 3138 290a 2020 2020 2222 220a  . 2018).    """.
-00013460: 2020 2020 7477 696e 203d 2070 6172 615b      twin = para[
-00013470: 2274 7769 6e22 5d0a 2020 2020 6474 203d  "twin"].    dt =
-00013480: 2070 6172 615b 2264 7422 5d0a 2020 2020   para["dt"].    
-00013490: 746d 696e 203d 206e 702e 6d69 6e28 7477  tmin = np.min(tw
-000134a0: 696e 290a 2020 2020 746d 6178 203d 206e  in).    tmax = n
-000134b0: 702e 6d61 7828 7477 696e 290a 2020 2020  p.max(twin).    
-000134c0: 7476 6563 7420 3d20 6e70 2e61 7261 6e67  tvect = np.arang
-000134d0: 6528 746d 696e 2c20 746d 6178 2c20 6474  e(tmin, tmax, dt
-000134e0: 290a 0a20 2020 2023 2073 6574 7570 206f  )..    # setup o
-000134f0: 7468 6572 2070 6172 616d 6574 6572 730a  ther parameters.
-00013500: 2020 2020 6e70 7473 203d 206c 656e 2872      npts = len(r
-00013510: 6566 2920 2023 206e 756d 6265 7220 6f66  ef)  # number of
-00013520: 2074 696d 6520 7361 6d70 6c65 730a 0a20   time samples.. 
-00013530: 2020 2023 2063 6f6d 7075 7465 2065 7272     # compute err
-00013540: 6f72 2066 756e 6374 696f 6e20 6f76 6572  or function over
-00013550: 206c 6167 732c 2077 6869 6368 2069 7320   lags, which is 
-00013560: 696e 6465 7065 6e64 656e 7420 6f66 2073  independent of s
-00013570: 7472 6169 6e20 6c69 6d69 7420 2762 272e  train limit 'b'.
-00013580: 0a20 2020 2065 7272 203d 2063 6f6d 7075  .    err = compu
-00013590: 7465 4572 726f 7246 756e 6374 696f 6e28  teErrorFunction(
-000135a0: 6375 722c 2072 6566 2c20 6e70 7473 2c20  cur, ref, npts, 
-000135b0: 6d61 784c 6167 290a 0a20 2020 2023 2064  maxLag)..    # d
-000135c0: 6972 6563 7469 6f6e 2074 6f20 6163 6375  irection to accu
-000135d0: 6d75 6c61 7465 2065 7272 6f72 7320 2831  mulate errors (1
-000135e0: 3d66 6f72 7761 7264 2c20 2d31 3d62 6163  =forward, -1=bac
-000135f0: 6b77 6172 6429 0a20 2020 2064 6973 7420  kward).    dist 
-00013600: 3d20 6163 6375 6d75 6c61 7465 4572 726f  = accumulateErro
-00013610: 7246 756e 6374 696f 6e28 6469 7265 6374  rFunction(direct
-00013620: 696f 6e2c 2065 7272 2c20 6e70 7473 2c20  ion, err, npts, 
-00013630: 6d61 784c 6167 2c20 6229 0a20 2020 2073  maxLag, b).    s
-00013640: 7462 6172 203d 2062 6163 6b74 7261 636b  tbar = backtrack
-00013650: 4469 7374 616e 6365 4675 6e63 7469 6f6e  DistanceFunction
-00013660: 282d 3120 2a20 6469 7265 6374 696f 6e2c  (-1 * direction,
-00013670: 2064 6973 742c 2065 7272 2c20 2d6d 6178   dist, err, -max
-00013680: 4c61 672c 2062 290a 2020 2020 7374 6261  Lag, b).    stba
-00013690: 7254 696d 6520 3d20 7374 6261 7220 2a20  rTime = stbar * 
-000136a0: 6474 2020 2320 636f 6e76 6572 7420 6672  dt  # convert fr
-000136b0: 6f6d 2073 616d 706c 6573 2074 6f20 7469  om samples to ti
-000136c0: 6d65 0a0a 2020 2020 2320 6375 7420 7468  me..    # cut th
-000136d0: 6520 6669 7273 7420 616e 6420 6c61 7374  e first and last
-000136e0: 2035 2520 666f 7220 6265 7474 6572 2072   5% for better r
-000136f0: 6567 7265 7373 696f 6e0a 2020 2020 696e  egression.    in
-00013700: 6478 203d 206e 702e 7768 6572 6528 2874  dx = np.where((t
-00013710: 7665 6374 203e 3d20 302e 3035 202a 206e  vect >= 0.05 * n
-00013720: 7074 7320 2a20 6474 2920 2620 2874 7665  pts * dt) & (tve
-00013730: 6374 203c 3d20 302e 3935 202a 206e 7074  ct <= 0.95 * npt
-00013740: 7320 2a20 6474 2929 5b30 5d0a 0a20 2020  s * dt))[0]..   
-00013750: 2023 206c 696e 6561 7220 7265 6772 6573   # linear regres
-00013760: 7369 6f6e 2074 6f20 6765 7420 6476 2f76  sion to get dv/v
-00013770: 0a20 2020 2069 6620 6e70 7473 203e 2032  .    if npts > 2
-00013780: 3a0a 2020 2020 2020 2020 2320 7765 6967  :.        # weig
-00013790: 6874 730a 2020 2020 2020 2020 7720 3d20  hts.        w = 
-000137a0: 6e70 2e6f 6e65 7328 6e70 7473 290a 2020  np.ones(npts).  
-000137b0: 2020 2020 2020 2320 6d2c 2061 2c20 656d        # m, a, em
-000137c0: 2c20 6561 203d 206c 696e 6561 725f 7265  , ea = linear_re
-000137d0: 6772 6573 7369 6f6e 2874 696d 655f 6178  gression(time_ax
-000137e0: 6973 5b69 6e64 785d 2c20 6465 6c74 615f  is[indx], delta_
-000137f0: 745b 696e 6478 5d2c 2077 2c20 696e 7465  t[indx], w, inte
-00013800: 7263 6570 745f 6f72 6967 696e 3d46 616c  rcept_origin=Fal
-00013810: 7365 290a 2020 2020 2020 2020 6d30 2c20  se).        m0, 
-00013820: 656d 3020 3d20 6c69 6e65 6172 5f72 6567  em0 = linear_reg
-00013830: 7265 7373 696f 6e28 0a20 2020 2020 2020  ression(.       
-00013840: 2020 2020 2074 7665 6374 2e66 6c61 7474       tvect.flatt
-00013850: 656e 2829 5b69 6e64 785d 2c0a 2020 2020  en()[indx],.    
-00013860: 2020 2020 2020 2020 7374 6261 7254 696d          stbarTim
-00013870: 652e 666c 6174 7465 6e28 295b 696e 6478  e.flatten()[indx
-00013880: 5d2c 0a20 2020 2020 2020 2020 2020 2077  ],.            w
-00013890: 2e66 6c61 7474 656e 2829 5b69 6e64 785d  .flatten()[indx]
-000138a0: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
-000138b0: 7465 7263 6570 745f 6f72 6967 696e 3d54  tercept_origin=T
-000138c0: 7275 652c 0a20 2020 2020 2020 2029 0a0a  rue,.        )..
-000138d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000138e0: 2020 7072 696e 7428 226e 6f74 2065 6e6f    print("not eno
-000138f0: 7567 6820 706f 696e 7473 2074 6f20 6573  ugh points to es
-00013900: 7469 6d61 7465 2064 762f 7620 666f 7220  timate dv/v for 
-00013910: 6474 7722 290a 2020 2020 2020 2020 6d30  dtw").        m0
-00013920: 203d 2030 0a20 2020 2020 2020 2065 6d30   = 0.        em0
-00013930: 203d 2030 0a0a 2020 2020 7265 7475 726e   = 0..    return
-00013940: 206d 3020 2a20 3130 302c 2065 6d30 202a   m0 * 100, em0 *
-00013950: 2031 3030 2c20 6469 7374 0a0a 0a64 6566   100, dist...def
-00013960: 206d 7763 735f 6476 7628 7265 662c 2063   mwcs_dvv(ref, c
-00013970: 7572 2c20 6d6f 7669 6e67 5f77 696e 646f  ur, moving_windo
-00013980: 775f 6c65 6e67 7468 2c20 736c 6964 655f  w_length, slide_
-00013990: 7374 6570 2c20 7061 7261 2c20 736d 6f6f  step, para, smoo
-000139a0: 7468 696e 675f 6861 6c66 5f77 696e 3d35  thing_half_win=5
-000139b0: 293a 0a20 2020 2022 2222 0a20 2020 204d  ):.    """.    M
-000139c0: 6f76 696e 6720 5769 6e64 6f77 2043 726f  oving Window Cro
-000139d0: 7373 2053 7065 6374 7275 6d20 6d65 7468  ss Spectrum meth
-000139e0: 6f64 2074 6f20 6d65 6173 7572 6520 6476  od to measure dv
-000139f0: 2f76 2028 7265 6c79 696e 6720 6f6e 2070  /v (relying on p
-00013a00: 6869 3d32 2a70 692a 662a 7420 696e 2066  hi=2*pi*f*t in f
-00013a10: 7265 7120 646f 6d61 696e 290a 0a20 2020  req domain)..   
-00013a20: 2050 4152 414d 4554 4552 533a 0a20 2020   PARAMETERS:.   
-00013a30: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
-00013a40: 2d0a 2020 2020 7265 663a 2052 6566 6572  -.    ref: Refer
-00013a50: 656e 6365 2077 6176 6566 6f72 6d20 286e  ence waveform (n
-00013a60: 702e 6e64 6172 7261 792c 2073 697a 6520  p.ndarray, size 
-00013a70: 4e29 0a20 2020 2063 7572 3a20 4375 7272  N).    cur: Curr
-00013a80: 656e 7420 7761 7665 666f 726d 2028 6e70  ent waveform (np
-00013a90: 2e6e 6461 7272 6179 2c20 7369 7a65 204e  .ndarray, size N
-00013aa0: 290a 2020 2020 6d6f 7669 6e67 5f77 696e  ).    moving_win
-00013ab0: 646f 775f 6c65 6e67 7468 3a20 6d6f 7669  dow_length: movi
-00013ac0: 6e67 2077 696e 646f 7720 6c65 6e67 7468  ng window length
-00013ad0: 2074 6f20 6361 6c63 756c 6174 6520 6372   to calculate cr
-00013ae0: 6f73 732d 7370 6563 7472 756d 2028 6e70  oss-spectrum (np
-00013af0: 2e66 6c6f 6174 2c20 696e 2073 6563 290a  .float, in sec).
-00013b00: 2020 2020 736c 6964 655f 7374 6570 3a20      slide_step: 
-00013b10: 7374 6570 7320 696e 2074 696d 6520 746f  steps in time to
-00013b20: 2073 6869 6674 2074 6865 206d 6f76 696e   shift the movin
-00013b30: 6720 7769 6e64 6f77 2028 6e70 2e66 6c6f  g window (np.flo
-00013b40: 6174 2c20 696e 2073 6563 6f6e 6473 290a  at, in seconds).
-00013b50: 2020 2020 7061 7261 3a20 6120 6469 6374      para: a dict
-00013b60: 2063 6f6e 7461 696e 696e 6720 7061 7261   containing para
-00013b70: 6d65 7465 7273 2061 626f 7574 2069 6e70  meters about inp
-00013b80: 7574 2064 6174 6120 7769 6e64 6f77 2061  ut data window a
-00013b90: 6e64 2066 7265 7175 656e 6379 2069 6e66  nd frequency inf
-00013ba0: 6f2c 2069 6e63 6c75 6469 6e67 0a20 2020  o, including.   
-00013bb0: 2020 2020 2064 656c 7461 2d3e 5468 6520       delta->The 
-00013bc0: 7361 6d70 6c69 6e67 2072 6174 6520 6f66  sampling rate of
-00013bd0: 2074 6865 2069 6e70 7574 2074 696d 6573   the input times
-00013be0: 6572 6965 7320 2869 6e20 487a 290a 2020  eries (in Hz).  
-00013bf0: 2020 2020 2020 7769 6e64 6f77 2d3e 2054        window-> T
-00013c00: 6865 2074 6172 6765 7420 7769 6e64 6f77  he target window
-00013c10: 2066 6f72 206d 6561 7375 7269 6e67 2064   for measuring d
-00013c20: 742f 740a 2020 2020 2020 2020 6672 6571  t/t.        freq
-00013c30: 2d3e 2054 6865 2066 7265 7175 656e 6379  -> The frequency
-00013c40: 2062 6f75 6e64 2074 6f20 636f 6d70 7574   bound to comput
-00013c50: 6520 7468 6520 6465 7068 6173 696e 6720  e the dephasing 
-00013c60: 2869 6e20 487a 290a 2020 2020 2020 2020  (in Hz).        
-00013c70: 746d 696e 3a20 5468 6520 6c65 6674 6d6f  tmin: The leftmo
-00013c80: 7374 2074 696d 6520 6c61 6720 2875 7365  st time lag (use
-00013c90: 6420 746f 2063 6f6d 7075 7465 2074 6865  d to compute the
-00013ca0: 2022 7469 6d65 206c 6167 7320 6172 7261   "time lags arra
-00013cb0: 7922 290a 2020 2020 736d 6f6f 7468 696e  y").    smoothin
-00013cc0: 675f 6861 6c66 5f77 696e 3a20 4966 2064  g_half_win: If d
-00013cd0: 6966 6665 7265 6e74 2066 726f 6d20 302c  ifferent from 0,
-00013ce0: 2064 6566 696e 6573 2074 6865 2068 616c   defines the hal
-00013cf0: 6620 6c65 6e67 7468 206f 6620 7468 6520  f length of the 
-00013d00: 736d 6f6f 7468 696e 6720 6861 6e6e 696e  smoothing hannin
-00013d10: 6720 7769 6e64 6f77 2e0a 0a20 2020 2052  g window...    R
-00013d20: 4554 5552 4e53 3a0a 2020 2020 2d2d 2d2d  ETURNS:.    ----
-00013d30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
-00013d40: 2020 2074 696d 655f 6178 6973 3a20 7468     time_axis: th
-00013d50: 6520 6365 6e74 7261 6c20 7469 6d65 7320  e central times 
-00013d60: 6f66 2074 6865 2077 696e 646f 7773 2e0a  of the windows..
-00013d70: 2020 2020 6465 6c74 615f 743a 2064 740a      delta_t: dt.
-00013d80: 2020 2020 6465 6c74 615f 6572 723a 6572      delta_err:er
-00013d90: 726f 720a 2020 2020 6465 6c74 615f 6d63  ror.    delta_mc
-00013da0: 6f68 3a20 6d65 616e 2063 6f68 6572 656e  oh: mean coheren
-00013db0: 6365 0a0a 2020 2020 436f 7069 6564 2066  ce..    Copied f
-00013dc0: 726f 6d20 4d53 4e6f 6973 6520 2868 7474  rom MSNoise (htt
-00013dd0: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
-00013de0: 524f 4265 6c67 6975 6d2f 4d53 4e6f 6973  ROBelgium/MSNois
-00013df0: 652f 7472 6565 2f6d 6173 7465 722f 6d73  e/tree/master/ms
-00013e00: 6e6f 6973 6529 0a20 2020 204d 6f64 6966  noise).    Modif
-00013e10: 6965 6420 6279 2043 6865 6e67 7869 6e20  ied by Chengxin 
-00013e20: 4a69 616e 670a 2020 2020 2222 220a 2020  Jiang.    """.  
-00013e30: 2020 2320 636f 6d6d 6f6e 2076 6172 6961    # common varia
-00013e40: 626c 6573 0a20 2020 2074 7769 6e20 3d20  bles.    twin = 
-00013e50: 7061 7261 5b22 7477 696e 225d 0a20 2020  para["twin"].   
-00013e60: 2066 7265 7120 3d20 7061 7261 5b22 6672   freq = para["fr
-00013e70: 6571 225d 0a20 2020 2064 7420 3d20 7061  eq"].    dt = pa
-00013e80: 7261 5b22 6474 225d 0a20 2020 2074 6d69  ra["dt"].    tmi
-00013e90: 6e20 3d20 6e70 2e6d 696e 2874 7769 6e29  n = np.min(twin)
-00013ea0: 0a20 2020 2066 6d69 6e20 3d20 6e70 2e6d  .    fmin = np.m
-00013eb0: 696e 2866 7265 7129 0a20 2020 2066 6d61  in(freq).    fma
-00013ec0: 7820 3d20 6e70 2e6d 6178 2866 7265 7129  x = np.max(freq)
-00013ed0: 0a0a 2020 2020 2320 7061 7261 6d65 7465  ..    # paramete
-00013ee0: 7220 696e 6974 6961 6c69 7a65 0a20 2020  r initialize.   
-00013ef0: 2064 656c 7461 5f74 203d 205b 5d0a 2020   delta_t = [].  
-00013f00: 2020 6465 6c74 615f 6572 7220 3d20 5b5d    delta_err = []
-00013f10: 0a20 2020 2064 656c 7461 5f6d 636f 6820  .    delta_mcoh 
-00013f20: 3d20 5b5d 0a20 2020 2074 696d 655f 6178  = [].    time_ax
-00013f30: 6973 203d 205b 5d0a 0a20 2020 2023 2069  is = []..    # i
-00013f40: 6e66 6f20 6f6e 2074 6865 206d 6f76 696e  nfo on the movin
-00013f50: 6720 7769 6e64 6f77 0a20 2020 2077 696e  g window.    win
-00013f60: 646f 775f 6c65 6e67 7468 5f73 616d 706c  dow_length_sampl
-00013f70: 6573 203d 206e 702e 696e 7428 6d6f 7669  es = np.int(movi
-00013f80: 6e67 5f77 696e 646f 775f 6c65 6e67 7468  ng_window_length
-00013f90: 202f 2064 7429 0a20 2020 2070 6164 6420   / dt).    padd 
-00013fa0: 3d20 696e 7428 3220 2a2a 2028 6e65 7874  = int(2 ** (next
-00013fb0: 706f 7732 2877 696e 646f 775f 6c65 6e67  pow2(window_leng
-00013fc0: 7468 5f73 616d 706c 6573 2920 2b20 3229  th_samples) + 2)
-00013fd0: 290a 2020 2020 636f 756e 7420 3d20 300a  ).    count = 0.
-00013fe0: 2020 2020 7470 203d 2063 6f73 696e 655f      tp = cosine_
-00013ff0: 7461 7065 7228 7769 6e64 6f77 5f6c 656e  taper(window_len
-00014000: 6774 685f 7361 6d70 6c65 732c 2030 2e31  gth_samples, 0.1
-00014010: 3529 0a0a 2020 2020 6d69 6e69 6e64 203d  5)..    minind =
-00014020: 2030 0a20 2020 206d 6178 696e 6420 3d20   0.    maxind = 
-00014030: 7769 6e64 6f77 5f6c 656e 6774 685f 7361  window_length_sa
-00014040: 6d70 6c65 730a 0a20 2020 2023 206c 6f6f  mples..    # loo
-00014050: 7020 7468 726f 7567 6820 616c 6c20 7375  p through all su
-00014060: 622d 7769 6e64 6f77 730a 2020 2020 7768  b-windows.    wh
-00014070: 696c 6520 6d61 7869 6e64 203c 3d20 6c65  ile maxind <= le
-00014080: 6e28 7265 6629 3a0a 2020 2020 2020 2020  n(ref):.        
-00014090: 6363 6920 3d20 6375 725b 6d69 6e69 6e64  cci = cur[minind
-000140a0: 3a6d 6178 696e 645d 0a20 2020 2020 2020  :maxind].       
-000140b0: 2063 6369 203d 2073 6369 7079 2e73 6967   cci = scipy.sig
-000140c0: 6e61 6c2e 6465 7472 656e 6428 6363 692c  nal.detrend(cci,
-000140d0: 2074 7970 653d 226c 696e 6561 7222 290a   type="linear").
-000140e0: 2020 2020 2020 2020 6363 6920 2a3d 2074          cci *= t
-000140f0: 700a 0a20 2020 2020 2020 2063 7269 203d  p..        cri =
-00014100: 2072 6566 5b6d 696e 696e 643a 6d61 7869   ref[minind:maxi
-00014110: 6e64 5d0a 2020 2020 2020 2020 6372 6920  nd].        cri 
-00014120: 3d20 7363 6970 792e 7369 676e 616c 2e64  = scipy.signal.d
-00014130: 6574 7265 6e64 2863 7269 2c20 7479 7065  etrend(cri, type
-00014140: 3d22 6c69 6e65 6172 2229 0a20 2020 2020  ="linear").     
-00014150: 2020 2063 7269 202a 3d20 7470 0a0a 2020     cri *= tp..  
-00014160: 2020 2020 2020 6d69 6e69 6e64 202b 3d20        minind += 
-00014170: 696e 7428 736c 6964 655f 7374 6570 202f  int(slide_step /
-00014180: 2064 7429 0a20 2020 2020 2020 206d 6178   dt).        max
-00014190: 696e 6420 2b3d 2069 6e74 2873 6c69 6465  ind += int(slide
-000141a0: 5f73 7465 7020 2f20 6474 290a 0a20 2020  _step / dt)..   
-000141b0: 2020 2020 2023 2064 6f20 6666 740a 2020       # do fft.  
-000141c0: 2020 2020 2020 6663 7572 203d 2073 6369        fcur = sci
-000141d0: 7079 2e66 6674 7061 636b 2e66 6674 2863  py.fftpack.fft(c
-000141e0: 6369 2c20 6e3d 7061 6464 295b 3a20 7061  ci, n=padd)[: pa
-000141f0: 6464 202f 2f20 325d 0a20 2020 2020 2020  dd // 2].       
-00014200: 2066 7265 6620 3d20 7363 6970 792e 6666   fref = scipy.ff
-00014210: 7470 6163 6b2e 6666 7428 6372 692c 206e  tpack.fft(cri, n
-00014220: 3d70 6164 6429 5b3a 2070 6164 6420 2f2f  =padd)[: padd //
-00014230: 2032 5d0a 0a20 2020 2020 2020 2066 6375   2]..        fcu
-00014240: 7232 203d 206e 702e 7265 616c 2866 6375  r2 = np.real(fcu
-00014250: 7229 202a 2a20 3220 2b20 6e70 2e69 6d61  r) ** 2 + np.ima
-00014260: 6728 6663 7572 2920 2a2a 2032 0a20 2020  g(fcur) ** 2.   
-00014270: 2020 2020 2066 7265 6632 203d 206e 702e       fref2 = np.
-00014280: 7265 616c 2866 7265 6629 202a 2a20 3220  real(fref) ** 2 
-00014290: 2b20 6e70 2e69 6d61 6728 6672 6566 2920  + np.imag(fref) 
-000142a0: 2a2a 2032 0a0a 2020 2020 2020 2020 2320  ** 2..        # 
-000142b0: 6765 7420 6372 6f73 732d 7370 6563 7472  get cross-spectr
-000142c0: 756d 2026 2064 6f20 6669 6c74 6572 696e  um & do filterin
-000142d0: 670a 2020 2020 2020 2020 5820 3d20 6672  g.        X = fr
-000142e0: 6566 202a 2028 6663 7572 2e63 6f6e 6a28  ef * (fcur.conj(
-000142f0: 2929 0a20 2020 2020 2020 2069 6620 736d  )).        if sm
-00014300: 6f6f 7468 696e 675f 6861 6c66 5f77 696e  oothing_half_win
-00014310: 2021 3d20 303a 0a20 2020 2020 2020 2020   != 0:.         
-00014320: 2020 2064 6375 7220 3d20 6e70 2e73 7172     dcur = np.sqr
-00014330: 7428 736d 6f6f 7468 2866 6375 7232 2c20  t(smooth(fcur2, 
-00014340: 7769 6e64 6f77 3d22 6861 6e6e 696e 6722  window="hanning"
-00014350: 2c20 6861 6c66 5f77 696e 3d73 6d6f 6f74  , half_win=smoot
-00014360: 6869 6e67 5f68 616c 665f 7769 6e29 290a  hing_half_win)).
-00014370: 2020 2020 2020 2020 2020 2020 6472 6566              dref
-00014380: 203d 206e 702e 7371 7274 2873 6d6f 6f74   = np.sqrt(smoot
-00014390: 6828 6672 6566 322c 2077 696e 646f 773d  h(fref2, window=
-000143a0: 2268 616e 6e69 6e67 222c 2068 616c 665f  "hanning", half_
-000143b0: 7769 6e3d 736d 6f6f 7468 696e 675f 6861  win=smoothing_ha
-000143c0: 6c66 5f77 696e 2929 0a20 2020 2020 2020  lf_win)).       
-000143d0: 2020 2020 2058 203d 2073 6d6f 6f74 6828       X = smooth(
-000143e0: 582c 2077 696e 646f 773d 2268 616e 6e69  X, window="hanni
-000143f0: 6e67 222c 2068 616c 665f 7769 6e3d 736d  ng", half_win=sm
-00014400: 6f6f 7468 696e 675f 6861 6c66 5f77 696e  oothing_half_win
-00014410: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00014420: 2020 2020 2020 2020 2020 2020 6463 7572              dcur
-00014430: 203d 206e 702e 7371 7274 2866 6375 7232   = np.sqrt(fcur2
-00014440: 290a 2020 2020 2020 2020 2020 2020 6472  ).            dr
-00014450: 6566 203d 206e 702e 7371 7274 2866 7265  ef = np.sqrt(fre
-00014460: 6632 290a 0a20 2020 2020 2020 2064 6373  f2)..        dcs
-00014470: 203d 206e 702e 6162 7328 5829 0a0a 2020   = np.abs(X)..  
-00014480: 2020 2020 2020 2320 4669 6e64 2074 6865        # Find the
-00014490: 2076 616c 7565 7320 7468 6520 6672 6571   values the freq
-000144a0: 7565 6e63 7920 7261 6e67 6520 6f66 2069  uency range of i
-000144b0: 6e74 6572 6573 740a 2020 2020 2020 2020  nterest.        
-000144c0: 6672 6571 5f76 6563 203d 2073 6369 7079  freq_vec = scipy
-000144d0: 2e66 6674 7061 636b 2e66 6674 6672 6571  .fftpack.fftfreq
-000144e0: 286c 656e 2858 2920 2a20 322c 2064 7429  (len(X) * 2, dt)
-000144f0: 5b3a 2070 6164 6420 2f2f 2032 5d0a 2020  [: padd // 2].  
-00014500: 2020 2020 2020 696e 6465 785f 7261 6e67        index_rang
-00014510: 6520 3d20 6e70 2e61 7267 7768 6572 6528  e = np.argwhere(
-00014520: 6e70 2e6c 6f67 6963 616c 5f61 6e64 2866  np.logical_and(f
-00014530: 7265 715f 7665 6320 3e3d 2066 6d69 6e2c  req_vec >= fmin,
-00014540: 2066 7265 715f 7665 6320 3c3d 2066 6d61   freq_vec <= fma
-00014550: 7829 290a 0a20 2020 2020 2020 2023 2047  x))..        # G
-00014560: 6574 2043 6f68 6572 656e 6365 2061 6e64  et Coherence and
-00014570: 2069 7473 206d 6561 6e20 7661 6c75 650a   its mean value.
-00014580: 2020 2020 2020 2020 636f 6820 3d20 6765          coh = ge
-00014590: 7443 6f68 6572 656e 6365 2864 6373 2c20  tCoherence(dcs, 
-000145a0: 6472 6566 2c20 6463 7572 290a 2020 2020  dref, dcur).    
-000145b0: 2020 2020 6d63 6f68 203d 206e 702e 6d65      mcoh = np.me
-000145c0: 616e 2863 6f68 5b69 6e64 6578 5f72 616e  an(coh[index_ran
-000145d0: 6765 5d29 0a0a 2020 2020 2020 2020 2320  ge])..        # 
-000145e0: 4765 7420 5765 6967 6874 730a 2020 2020  Get Weights.    
-000145f0: 2020 2020 7720 3d20 312e 3020 2f20 2831      w = 1.0 / (1
-00014600: 2e30 202f 2028 636f 685b 696e 6465 785f  .0 / (coh[index_
-00014610: 7261 6e67 655d 202a 2a20 3229 202d 2031  range] ** 2) - 1
-00014620: 2e30 290a 2020 2020 2020 2020 775b 636f  .0).        w[co
-00014630: 685b 696e 6465 785f 7261 6e67 655d 203e  h[index_range] >
-00014640: 3d20 302e 3939 5d20 3d20 312e 3020 2f20  = 0.99] = 1.0 / 
-00014650: 2831 2e30 202f 2030 2e39 3830 3120 2d20  (1.0 / 0.9801 - 
-00014660: 312e 3029 0a20 2020 2020 2020 2077 203d  1.0).        w =
-00014670: 206e 702e 7371 7274 2877 202a 206e 702e   np.sqrt(w * np.
-00014680: 7371 7274 2864 6373 5b69 6e64 6578 5f72  sqrt(dcs[index_r
-00014690: 616e 6765 5d29 290a 2020 2020 2020 2020  ange])).        
-000146a0: 7720 3d20 6e70 2e72 6561 6c28 7729 0a0a  w = np.real(w)..
-000146b0: 2020 2020 2020 2020 2320 4672 6571 7565          # Freque
-000146c0: 6e63 7920 6172 7261 793a 0a20 2020 2020  ncy array:.     
-000146d0: 2020 2076 203d 206e 702e 7265 616c 2866     v = np.real(f
-000146e0: 7265 715f 7665 635b 696e 6465 785f 7261  req_vec[index_ra
-000146f0: 6e67 655d 2920 2a20 3220 2a20 6e70 2e70  nge]) * 2 * np.p
-00014700: 690a 0a20 2020 2020 2020 2023 2050 6861  i..        # Pha
-00014710: 7365 3a0a 2020 2020 2020 2020 7068 6920  se:.        phi 
-00014720: 3d20 6e70 2e61 6e67 6c65 2858 290a 2020  = np.angle(X).  
-00014730: 2020 2020 2020 7068 695b 305d 203d 2030        phi[0] = 0
-00014740: 2e30 0a20 2020 2020 2020 2070 6869 203d  .0.        phi =
-00014750: 206e 702e 756e 7772 6170 2870 6869 290a   np.unwrap(phi).
-00014760: 2020 2020 2020 2020 7068 6920 3d20 7068          phi = ph
-00014770: 695b 696e 6465 785f 7261 6e67 655d 0a0a  i[index_range]..
-00014780: 2020 2020 2020 2020 2320 4361 6c63 756c          # Calcul
-00014790: 6174 6520 7468 6520 736c 6f70 6520 7769  ate the slope wi
-000147a0: 7468 2061 2077 6569 6768 7465 6420 6c65  th a weighted le
-000147b0: 6173 7420 7371 7561 7265 206c 696e 6561  ast square linea
-000147c0: 7220 7265 6772 6573 7369 6f6e 0a20 2020  r regression.   
-000147d0: 2020 2020 2023 2066 6f72 6365 6420 7468       # forced th
-000147e0: 726f 7567 6820 7468 6520 6f72 6967 696e  rough the origin
-000147f0: 3b20 7765 6967 6874 7320 666f 7220 7468  ; weights for th
-00014800: 6520 574c 5320 6d75 7374 2062 6520 7468  e WLS must be th
-00014810: 6520 7661 7269 616e 6365 2021 0a20 2020  e variance !.   
-00014820: 2020 2020 206d 2c20 656d 203d 206c 696e       m, em = lin
-00014830: 6561 725f 7265 6772 6573 7369 6f6e 2876  ear_regression(v
-00014840: 2e66 6c61 7474 656e 2829 2c20 7068 692e  .flatten(), phi.
-00014850: 666c 6174 7465 6e28 292c 2077 2e66 6c61  flatten(), w.fla
-00014860: 7474 656e 2829 290a 2020 2020 2020 2020  tten()).        
-00014870: 6465 6c74 615f 742e 6170 7065 6e64 286d  delta_t.append(m
-00014880: 290a 0a20 2020 2020 2020 2023 2070 7269  )..        # pri
-00014890: 6e74 2070 6869 2e73 6861 7065 2c20 762e  nt phi.shape, v.
-000148a0: 7368 6170 652c 2077 2e73 6861 7065 0a20  shape, w.shape. 
-000148b0: 2020 2020 2020 2065 203d 206e 702e 7375         e = np.su
-000148c0: 6d28 2870 6869 202d 206d 202a 2076 2920  m((phi - m * v) 
-000148d0: 2a2a 2032 2920 2f20 286e 702e 7369 7a65  ** 2) / (np.size
-000148e0: 2876 2920 2d20 3129 0a20 2020 2020 2020  (v) - 1).       
-000148f0: 2073 3278 3220 3d20 6e70 2e73 756d 2876   s2x2 = np.sum(v
-00014900: 2a2a 3220 2a20 772a 2a32 290a 2020 2020  **2 * w**2).    
-00014910: 2020 2020 7378 3220 3d20 6e70 2e73 756d      sx2 = np.sum
-00014920: 2877 202a 2076 2a2a 3229 0a20 2020 2020  (w * v**2).     
-00014930: 2020 2065 203d 206e 702e 7371 7274 2865     e = np.sqrt(e
-00014940: 202a 2073 3278 3220 2f20 7378 322a 2a32   * s2x2 / sx2**2
-00014950: 290a 0a20 2020 2020 2020 2064 656c 7461  )..        delta
-00014960: 5f65 7272 2e61 7070 656e 6428 6529 0a20  _err.append(e). 
-00014970: 2020 2020 2020 2064 656c 7461 5f6d 636f         delta_mco
-00014980: 682e 6170 7065 6e64 286e 702e 7265 616c  h.append(np.real
-00014990: 286d 636f 6829 290a 2020 2020 2020 2020  (mcoh)).        
-000149a0: 7469 6d65 5f61 7869 732e 6170 7065 6e64  time_axis.append
-000149b0: 2874 6d69 6e20 2b20 6d6f 7669 6e67 5f77  (tmin + moving_w
-000149c0: 696e 646f 775f 6c65 6e67 7468 202f 2032  indow_length / 2
-000149d0: 2e30 202b 2063 6f75 6e74 202a 2073 6c69  .0 + count * sli
-000149e0: 6465 5f73 7465 7029 0a20 2020 2020 2020  de_step).       
-000149f0: 2063 6f75 6e74 202b 3d20 310a 0a20 2020   count += 1..   
-00014a00: 2020 2020 2064 656c 2066 6375 722c 2066       del fcur, f
-00014a10: 7265 660a 2020 2020 2020 2020 6465 6c20  ref.        del 
-00014a20: 580a 2020 2020 2020 2020 6465 6c20 6672  X.        del fr
-00014a30: 6571 5f76 6563 0a20 2020 2020 2020 2064  eq_vec.        d
-00014a40: 656c 2069 6e64 6578 5f72 616e 6765 0a20  el index_range. 
-00014a50: 2020 2020 2020 2064 656c 2077 2c20 762c         del w, v,
-00014a60: 2065 2c20 7332 7832 2c20 7378 322c 206d   e, s2x2, sx2, m
-00014a70: 2c20 656d 0a0a 2020 2020 6966 206d 6178  , em..    if max
-00014a80: 696e 6420 3e20 6c65 6e28 6375 7229 202b  ind > len(cur) +
-00014a90: 2069 6e74 2873 6c69 6465 5f73 7465 7020   int(slide_step 
-00014aa0: 2f20 6474 293a 0a20 2020 2020 2020 2070  / dt):.        p
-00014ab0: 7269 6e74 2822 5468 6520 6c61 7374 2077  rint("The last w
-00014ac0: 696e 646f 7720 7761 7320 746f 6f20 736d  indow was too sm
-00014ad0: 616c 6c2c 2062 7574 2077 6173 2063 6f6d  all, but was com
-00014ae0: 7075 7465 6422 290a 0a20 2020 2023 2065  puted")..    # e
-00014af0: 6e73 7572 6520 616c 6c20 6d61 7472 6978  nsure all matrix
-00014b00: 2061 7265 206e 7020 6172 7261 790a 2020   are np array.  
-00014b10: 2020 6465 6c74 615f 7420 3d20 6e70 2e61    delta_t = np.a
-00014b20: 7272 6179 2864 656c 7461 5f74 290a 2020  rray(delta_t).  
-00014b30: 2020 6465 6c74 615f 6572 7220 3d20 6e70    delta_err = np
-00014b40: 2e61 7272 6179 2864 656c 7461 5f65 7272  .array(delta_err
-00014b50: 290a 2020 2020 6465 6c74 615f 6d63 6f68  ).    delta_mcoh
-00014b60: 203d 206e 702e 6172 7261 7928 6465 6c74   = np.array(delt
-00014b70: 615f 6d63 6f68 290a 2020 2020 7469 6d65  a_mcoh).    time
-00014b80: 5f61 7869 7320 3d20 6e70 2e61 7272 6179  _axis = np.array
-00014b90: 2874 696d 655f 6178 6973 290a 0a20 2020  (time_axis)..   
-00014ba0: 2023 2072 6561 6479 2066 6f72 206c 696e   # ready for lin
-00014bb0: 6561 7220 7265 6772 6573 7369 6f6e 0a20  ear regression. 
-00014bc0: 2020 2064 656c 7461 5f6d 696e 6368 6f20     delta_mincho 
-00014bd0: 3d20 302e 3635 0a20 2020 2064 656c 7461  = 0.65.    delta
-00014be0: 5f6d 6178 6572 7220 3d20 302e 310a 2020  _maxerr = 0.1.  
-00014bf0: 2020 6465 6c74 615f 6d61 7864 7420 3d20    delta_maxdt = 
-00014c00: 302e 310a 2020 2020 696e 6478 3120 3d20  0.1.    indx1 = 
-00014c10: 6e70 2e77 6865 7265 2864 656c 7461 5f6d  np.where(delta_m
-00014c20: 636f 6820 3e20 6465 6c74 615f 6d69 6e63  coh > delta_minc
-00014c30: 686f 290a 2020 2020 696e 6478 3220 3d20  ho).    indx2 = 
-00014c40: 6e70 2e77 6865 7265 2864 656c 7461 5f65  np.where(delta_e
-00014c50: 7272 203c 2064 656c 7461 5f6d 6178 6572  rr < delta_maxer
-00014c60: 7229 0a20 2020 2069 6e64 7833 203d 206e  r).    indx3 = n
-00014c70: 702e 7768 6572 6528 6465 6c74 615f 7420  p.where(delta_t 
-00014c80: 3c20 6465 6c74 615f 6d61 7864 7429 0a0a  < delta_maxdt)..
-00014c90: 2020 2020 2320 2d2d 2d2d 2d66 696e 6420      # -----find 
-00014ca0: 676f 6f64 2064 7420 6d65 6173 7572 656d  good dt measurem
-00014cb0: 656e 7473 2d2d 2d2d 2d0a 2020 2020 696e  ents-----.    in
-00014cc0: 6478 203d 206e 702e 696e 7465 7273 6563  dx = np.intersec
-00014cd0: 7431 6428 696e 6478 312c 2069 6e64 7832  t1d(indx1, indx2
-00014ce0: 290a 2020 2020 696e 6478 203d 206e 702e  ).    indx = np.
-00014cf0: 696e 7465 7273 6563 7431 6428 696e 6478  intersect1d(indx
-00014d00: 2c20 696e 6478 3329 0a0a 2020 2020 6966  , indx3)..    if
-00014d10: 206c 656e 2869 6e64 7829 203e 2032 3a0a   len(indx) > 2:.
-00014d20: 2020 2020 2020 2020 2320 2d2d 2d2d 6573          # ----es
-00014d30: 7469 6d61 7465 2077 6569 6768 7420 666f  timate weight fo
-00014d40: 7220 7265 6772 6573 7369 6f6e 2d2d 2d2d  r regression----
-00014d50: 0a20 2020 2020 2020 2077 203d 2031 202f  .        w = 1 /
-00014d60: 2064 656c 7461 5f65 7272 5b69 6e64 785d   delta_err[indx]
-00014d70: 0a20 2020 2020 2020 2077 5b7e 6e70 2e69  .        w[~np.i
-00014d80: 7366 696e 6974 6528 7729 5d20 3d20 312e  sfinite(w)] = 1.
-00014d90: 300a 0a20 2020 2020 2020 2023 202d 2d2d  0..        # ---
-00014da0: 2d2d 2d2d 2d2d 646f 206c 696e 6561 7220  ------do linear 
-00014db0: 7265 6772 6573 7369 6f6e 2d2d 2d2d 2d2d  regression------
-00014dc0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 2320  -----.        # 
-00014dd0: 6d2c 2061 2c20 656d 2c20 6561 203d 206c  m, a, em, ea = l
-00014de0: 696e 6561 725f 7265 6772 6573 7369 6f6e  inear_regression
-00014df0: 2874 696d 655f 6178 6973 5b69 6e64 785d  (time_axis[indx]
-00014e00: 2c20 6465 6c74 615f 745b 696e 6478 5d2c  , delta_t[indx],
-00014e10: 2077 2c20 696e 7465 7263 6570 745f 6f72   w, intercept_or
-00014e20: 6967 696e 3d46 616c 7365 290a 2020 2020  igin=False).    
-00014e30: 2020 2020 6d30 2c20 656d 3020 3d20 6c69      m0, em0 = li
-00014e40: 6e65 6172 5f72 6567 7265 7373 696f 6e28  near_regression(
-00014e50: 7469 6d65 5f61 7869 735b 696e 6478 5d2c  time_axis[indx],
-00014e60: 2064 656c 7461 5f74 5b69 6e64 785d 2c20   delta_t[indx], 
-00014e70: 772c 2069 6e74 6572 6365 7074 5f6f 7269  w, intercept_ori
-00014e80: 6769 6e3d 5472 7565 290a 0a20 2020 2065  gin=True)..    e
-00014e90: 6c73 653a 0a20 2020 2020 2020 2070 7269  lse:.        pri
-00014ea0: 6e74 2822 6e6f 7420 656e 6f75 6768 2070  nt("not enough p
-00014eb0: 6f69 6e74 7320 746f 2065 7374 696d 6174  oints to estimat
-00014ec0: 6520 6476 2f76 2066 6f72 206d 7763 7322  e dv/v for mwcs"
-00014ed0: 290a 2020 2020 2020 2020 6d30 203d 2030  ).        m0 = 0
-00014ee0: 0a20 2020 2020 2020 2065 6d30 203d 2030  .        em0 = 0
-00014ef0: 0a0a 2020 2020 7265 7475 726e 202d 6d30  ..    return -m0
-00014f00: 202a 2031 3030 2c20 656d 3020 2a20 3130   * 100, em0 * 10
-00014f10: 300a 0a0a 6465 6620 5743 435f 6476 7628  0...def WCC_dvv(
-00014f20: 7265 662c 2063 7572 2c20 6d6f 7669 6e67  ref, cur, moving
-00014f30: 5f77 696e 646f 775f 6c65 6e67 7468 2c20  _window_length, 
-00014f40: 736c 6964 655f 7374 6570 2c20 7061 7261  slide_step, para
-00014f50: 293a 0a20 2020 2022 2222 0a20 2020 2057  ):.    """.    W
-00014f60: 696e 646f 7765 6420 6372 6f73 7320 636f  indowed cross co
-00014f70: 7272 656c 6174 696f 6e20 2857 4343 2920  rrelation (WCC) 
-00014f80: 666f 7220 6474 206f 7220 6476 2f76 206d  for dt or dv/v m
-00014f90: 6573 7572 656d 656e 7420 2853 6e69 6564  esurement (Snied
-00014fa0: 6572 2065 7420 616c 2e20 3230 3132 290a  er et al. 2012).
-00014fb0: 0a20 2020 2050 6172 616d 6574 6572 733a  .    Parameters:
-00014fc0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
-00014fd0: 0a20 2020 2072 6566 3a20 5468 6520 2252  .    ref: The "R
-00014fe0: 6566 6572 656e 6365 2220 7469 6d65 7365  eference" timese
-00014ff0: 7269 6573 0a20 2020 2063 7572 3a20 5468  ries.    cur: Th
-00015000: 6520 2243 7572 7265 6e74 2220 7469 6d65  e "Current" time
-00015010: 7365 7269 6573 0a20 2020 206d 6f76 696e  series.    movin
-00015020: 675f 7769 6e64 6f77 5f6c 656e 6774 683a  g_window_length:
-00015030: 2054 6865 206d 6f76 696e 6720 7769 6e64   The moving wind
-00015040: 6f77 206c 656e 6774 6820 2869 6e20 7365  ow length (in se
-00015050: 636f 6e64 7329 0a20 2020 2073 6c69 6465  conds).    slide
-00015060: 5f73 7465 703a 2054 6865 2073 7465 7020  _step: The step 
-00015070: 746f 206a 756d 7020 666f 7220 7468 6520  to jump for the 
-00015080: 6d6f 7669 6e67 2077 696e 646f 7720 2869  moving window (i
-00015090: 6e20 7365 636f 6e64 7329 0a20 2020 2070  n seconds).    p
-000150a0: 6172 613a 2061 2064 6963 7420 636f 6e74  ara: a dict cont
-000150b0: 6169 6e69 6e67 2066 7265 712f 7469 6d65  aining freq/time
-000150c0: 2069 6e66 6f20 6f66 2074 6865 2064 6174   info of the dat
-000150d0: 6120 6d61 7472 6978 0a0a 2020 2020 5265  a matrix..    Re
-000150e0: 7475 726e 733a 0a20 2020 202d 2d2d 2d2d  turns:.    -----
-000150f0: 2d2d 2d2d 2d2d 2d0a 2020 2020 7469 6d65  -------.    time
-00015100: 5f61 7869 733a 2063 656e 7472 616c 2074  _axis: central t
-00015110: 696d 6573 206f 6620 7468 6520 6d6f 7669  imes of the movi
-00015120: 6e67 2077 696e 646f 770a 2020 2020 6465  ng window.    de
-00015130: 6c74 615f 743a 2064 740a 2020 2020 6465  lta_t: dt.    de
-00015140: 6c74 615f 6572 723a 2065 7272 6f72 0a20  lta_err: error. 
-00015150: 2020 2064 656c 7461 5f6d 636f 683a 206d     delta_mcoh: m
-00015160: 6561 6e20 636f 6865 7265 6e63 6520 666f  ean coherence fo
-00015170: 7220 6561 6368 2077 696e 646f 770a 0a20  r each window.. 
-00015180: 2020 2057 7269 7474 656e 2062 7920 436f     Written by Co
-00015190: 6e67 636f 6e67 2059 7561 6e20 2831 204a  ngcong Yuan (1 J
-000151a0: 756c 792c 2032 3031 3929 0a20 2020 2022  uly, 2019).    "
-000151b0: 2222 0a20 2020 2023 2063 6f6d 6d6f 6e20  "".    # common 
-000151c0: 7661 7269 6162 6c65 730a 2020 2020 7477  variables.    tw
-000151d0: 696e 203d 2070 6172 615b 2274 7769 6e22  in = para["twin"
-000151e0: 5d0a 2020 2020 6474 203d 2070 6172 615b  ].    dt = para[
-000151f0: 2264 7422 5d0a 2020 2020 746d 696e 203d  "dt"].    tmin =
-00015200: 206e 702e 6d69 6e28 7477 696e 290a 0a20   np.min(twin).. 
-00015210: 2020 2023 2070 6172 616d 6574 6572 2069     # parameter i
-00015220: 6e69 7469 616c 697a 650a 2020 2020 6465  nitialize.    de
-00015230: 6c74 615f 7420 3d20 5b5d 0a20 2020 2064  lta_t = [].    d
-00015240: 656c 7461 5f74 5f63 6f65 6620 3d20 5b5d  elta_t_coef = []
-00015250: 0a20 2020 2074 696d 655f 6178 6973 203d  .    time_axis =
-00015260: 205b 5d0a 0a20 2020 2023 2069 6e66 6f20   []..    # info 
-00015270: 6f6e 2074 6865 206d 6f76 696e 6720 7769  on the moving wi
-00015280: 6e64 6f77 0a20 2020 2077 696e 646f 775f  ndow.    window_
-00015290: 6c65 6e67 7468 5f73 616d 706c 6573 203d  length_samples =
-000152a0: 206e 702e 696e 7428 6d6f 7669 6e67 5f77   np.int(moving_w
-000152b0: 696e 646f 775f 6c65 6e67 7468 202f 2064  indow_length / d
-000152c0: 7429 0a20 2020 2063 6f75 6e74 203d 2030  t).    count = 0
-000152d0: 0a20 2020 2074 7020 3d20 636f 7369 6e65  .    tp = cosine
-000152e0: 5f74 6170 6572 2877 696e 646f 775f 6c65  _taper(window_le
-000152f0: 6e67 7468 5f73 616d 706c 6573 2c20 302e  ngth_samples, 0.
-00015300: 3135 290a 0a20 2020 206d 696e 696e 6420  15)..    minind 
-00015310: 3d20 300a 2020 2020 6d61 7869 6e64 203d  = 0.    maxind =
-00015320: 2077 696e 646f 775f 6c65 6e67 7468 5f73   window_length_s
-00015330: 616d 706c 6573 0a0a 2020 2020 2320 6c6f  amples..    # lo
-00015340: 6f70 2074 6872 6f75 6768 2061 6c6c 2073  op through all s
-00015350: 7562 2d77 696e 646f 7773 0a20 2020 2077  ub-windows.    w
-00015360: 6869 6c65 206d 6178 696e 6420 3c3d 206c  hile maxind <= l
-00015370: 656e 2872 6566 293a 0a20 2020 2020 2020  en(ref):.       
-00015380: 2063 6369 203d 2063 7572 5b6d 696e 696e   cci = cur[minin
-00015390: 643a 6d61 7869 6e64 5d0a 2020 2020 2020  d:maxind].      
-000153a0: 2020 6363 6920 3d20 7363 6970 792e 7369    cci = scipy.si
-000153b0: 676e 616c 2e64 6574 7265 6e64 2863 6369  gnal.detrend(cci
-000153c0: 2c20 7479 7065 3d22 6c69 6e65 6172 2229  , type="linear")
-000153d0: 0a20 2020 2020 2020 2063 6369 202a 3d20  .        cci *= 
-000153e0: 7470 0a0a 2020 2020 2020 2020 6372 6920  tp..        cri 
-000153f0: 3d20 7265 665b 6d69 6e69 6e64 3a6d 6178  = ref[minind:max
-00015400: 696e 645d 0a20 2020 2020 2020 2063 7269  ind].        cri
-00015410: 203d 2073 6369 7079 2e73 6967 6e61 6c2e   = scipy.signal.
-00015420: 6465 7472 656e 6428 6372 692c 2074 7970  detrend(cri, typ
-00015430: 653d 226c 696e 6561 7222 290a 2020 2020  e="linear").    
-00015440: 2020 2020 6372 6920 2a3d 2074 700a 0a20      cri *= tp.. 
-00015450: 2020 2020 2020 206d 696e 696e 6420 2b3d         minind +=
-00015460: 2069 6e74 2873 6c69 6465 5f73 7465 7020   int(slide_step 
-00015470: 2f20 6474 290a 2020 2020 2020 2020 6d61  / dt).        ma
-00015480: 7869 6e64 202b 3d20 696e 7428 736c 6964  xind += int(slid
-00015490: 655f 7374 6570 202f 2064 7429 0a0a 2020  e_step / dt)..  
-000154a0: 2020 2020 2020 2320 6e6f 726d 616c 697a        # normaliz
-000154b0: 6520 7369 676e 616c 7320 6265 666f 7265  e signals before
-000154c0: 2063 726f 7373 2063 6f72 7265 6c61 7469   cross correlati
-000154d0: 6f6e 0a20 2020 2020 2020 2063 6369 203d  on.        cci =
-000154e0: 2028 6363 6920 2d20 6363 692e 6d65 616e   (cci - cci.mean
-000154f0: 2829 2920 2f20 6363 692e 7374 6428 290a  ()) / cci.std().
-00015500: 2020 2020 2020 2020 6372 6920 3d20 2863          cri = (c
-00015510: 7269 202d 2063 7269 2e6d 6561 6e28 2929  ri - cri.mean())
-00015520: 202f 2063 7269 2e73 7464 2829 0a0a 2020   / cri.std()..  
-00015530: 2020 2020 2020 2320 6765 7420 6d61 7869        # get maxi
-00015540: 6d75 6d20 636f 7272 656c 6174 696f 6e20  mum correlation 
-00015550: 636f 6566 6669 6369 656e 7420 616e 6420  coefficient and 
-00015560: 6974 7320 696e 6465 780a 2020 2020 2020  its index.      
-00015570: 2020 6363 3220 3d20 6e70 2e63 6f72 7265    cc2 = np.corre
-00015580: 6c61 7465 2863 6369 2c20 6372 692c 206d  late(cci, cri, m
-00015590: 6f64 653d 2273 616d 6522 290a 2020 2020  ode="same").    
-000155a0: 2020 2020 6363 3220 3d20 6363 3220 2f20      cc2 = cc2 / 
-000155b0: 6e70 2e73 7172 7428 2863 6369 2a2a 3229  np.sqrt((cci**2)
-000155c0: 2e73 756d 2829 202a 2028 6372 692a 2a32  .sum() * (cri**2
-000155d0: 292e 7375 6d28 2929 0a0a 2020 2020 2020  ).sum())..      
-000155e0: 2020 696d 6178 6363 3220 3d20 6e70 2e77    imaxcc2 = np.w
-000155f0: 6865 7265 2863 6332 203d 3d20 6e70 2e6d  here(cc2 == np.m
-00015600: 6178 2863 6332 2929 5b30 5d0a 2020 2020  ax(cc2))[0].    
-00015610: 2020 2020 6d61 7863 6332 203d 206e 702e      maxcc2 = np.
-00015620: 6d61 7828 6363 3229 0a0a 2020 2020 2020  max(cc2)..      
-00015630: 2020 2320 6765 7420 7468 6520 7469 6d65    # get the time
-00015640: 2073 6869 6674 0a20 2020 2020 2020 206d   shift.        m
-00015650: 203d 2028 696d 6178 6363 3220 2d20 2828   = (imaxcc2 - ((
-00015660: 6d61 7869 6e64 202d 206d 696e 696e 6429  maxind - minind)
-00015670: 202f 2f20 3229 2920 2a20 6474 0a20 2020   // 2)) * dt.   
-00015680: 2020 2020 2064 656c 7461 5f74 2e61 7070       delta_t.app
-00015690: 656e 6428 6d29 0a20 2020 2020 2020 2064  end(m).        d
-000156a0: 656c 7461 5f74 5f63 6f65 662e 6170 7065  elta_t_coef.appe
-000156b0: 6e64 286d 6178 6363 3229 0a0a 2020 2020  nd(maxcc2)..    
-000156c0: 2020 2020 7469 6d65 5f61 7869 732e 6170      time_axis.ap
-000156d0: 7065 6e64 2874 6d69 6e20 2b20 6d6f 7669  pend(tmin + movi
-000156e0: 6e67 5f77 696e 646f 775f 6c65 6e67 7468  ng_window_length
-000156f0: 202f 2032 2e30 202b 2063 6f75 6e74 202a   / 2.0 + count *
-00015700: 2073 6c69 6465 5f73 7465 7029 0a20 2020   slide_step).   
-00015710: 2020 2020 2063 6f75 6e74 202b 3d20 310a       count += 1.
-00015720: 0a20 2020 2064 656c 2063 6369 2c20 6372  .    del cci, cr
-00015730: 692c 2063 6332 2c20 696d 6178 6363 322c  i, cc2, imaxcc2,
-00015740: 206d 6178 6363 320a 2020 2020 6465 6c20   maxcc2.    del 
-00015750: 6d0a 0a20 2020 2069 6620 6d61 7869 6e64  m..    if maxind
-00015760: 203e 206c 656e 2863 7572 2920 2b20 696e   > len(cur) + in
-00015770: 7428 736c 6964 655f 7374 6570 202f 2064  t(slide_step / d
-00015780: 7429 3a0a 2020 2020 2020 2020 7072 696e  t):.        prin
-00015790: 7428 2254 6865 206c 6173 7420 7769 6e64  t("The last wind
-000157a0: 6f77 2077 6173 2074 6f6f 2073 6d61 6c6c  ow was too small
-000157b0: 2c20 6275 7420 7761 7320 636f 6d70 7574  , but was comput
-000157c0: 6564 2229 0a0a 2020 2020 6465 6c74 615f  ed")..    delta_
-000157d0: 7420 3d20 6e70 2e61 7272 6179 2864 656c  t = np.array(del
-000157e0: 7461 5f74 290a 2020 2020 6465 6c74 615f  ta_t).    delta_
-000157f0: 745f 636f 6566 203d 206e 702e 6172 7261  t_coef = np.arra
-00015800: 7928 6465 6c74 615f 745f 636f 6566 290a  y(delta_t_coef).
-00015810: 2020 2020 7469 6d65 5f61 7869 7320 3d20      time_axis = 
-00015820: 6e70 2e61 7272 6179 2874 696d 655f 6178  np.array(time_ax
-00015830: 6973 290a 0a20 2020 2023 206c 696e 6561  is)..    # linea
-00015840: 7220 7265 6772 6573 7369 6f6e 2074 6f20  r regression to 
-00015850: 6765 7420 6476 2f76 0a20 2020 2069 6620  get dv/v.    if 
-00015860: 636f 756e 7420 3e20 323a 0a20 2020 2020  count > 2:.     
-00015870: 2020 2023 2073 696d 706c 6520 7765 6967     # simple weig
-00015880: 6874 0a20 2020 2020 2020 2077 203d 206e  ht.        w = n
-00015890: 702e 6f6e 6573 2863 6f75 6e74 290a 2020  p.ones(count).  
-000158a0: 2020 2020 2020 2320 6d2c 2061 2c20 656d        # m, a, em
-000158b0: 2c20 6561 203d 206c 696e 6561 725f 7265  , ea = linear_re
-000158c0: 6772 6573 7369 6f6e 2874 696d 655f 6178  gression(time_ax
-000158d0: 6973 5b69 6e64 785d 2c20 6465 6c74 615f  is[indx], delta_
-000158e0: 745b 696e 6478 5d2c 2077 2c20 696e 7465  t[indx], w, inte
-000158f0: 7263 6570 745f 6f72 6967 696e 3d46 616c  rcept_origin=Fal
-00015900: 7365 290a 2020 2020 2020 2020 6d30 2c20  se).        m0, 
-00015910: 656d 3020 3d20 6c69 6e65 6172 5f72 6567  em0 = linear_reg
-00015920: 7265 7373 696f 6e28 7469 6d65 5f61 7869  ression(time_axi
-00015930: 732e 666c 6174 7465 6e28 292c 2064 656c  s.flatten(), del
-00015940: 7461 5f74 2e66 6c61 7474 656e 2829 2c20  ta_t.flatten(), 
-00015950: 772e 666c 6174 7465 6e28 292c 2069 6e74  w.flatten(), int
-00015960: 6572 6365 7074 5f6f 7269 6769 6e3d 5472  ercept_origin=Tr
-00015970: 7565 290a 0a20 2020 2065 6c73 653a 0a20  ue)..    else:. 
-00015980: 2020 2020 2020 2070 7269 6e74 2822 6e6f         print("no
-00015990: 7420 656e 6f75 6768 2070 6f69 6e74 7320  t enough points 
-000159a0: 746f 2065 7374 696d 6174 6520 6476 2f76  to estimate dv/v
-000159b0: 2066 6f72 2077 6363 2229 0a20 2020 2020   for wcc").     
-000159c0: 2020 206d 3020 3d20 300a 2020 2020 2020     m0 = 0.      
-000159d0: 2020 656d 3020 3d20 300a 0a20 2020 2072    em0 = 0..    r
-000159e0: 6574 7572 6e20 2d6d 3020 2a20 3130 302c  eturn -m0 * 100,
-000159f0: 2065 6d30 202a 2031 3030 0a0a 0a64 6566   em0 * 100...def
-00015a00: 2077 7873 5f64 7676 280a 2020 2020 7265   wxs_dvv(.    re
-00015a10: 662c 0a20 2020 2063 7572 2c0a 2020 2020  f,.    cur,.    
-00015a20: 616c 6c66 7265 712c 0a20 2020 2070 6172  allfreq,.    par
-00015a30: 612c 0a20 2020 2064 6a3d 3120 2f20 3132  a,.    dj=1 / 12
-00015a40: 2c0a 2020 2020 7330 3d2d 312c 0a20 2020  ,.    s0=-1,.   
-00015a50: 204a 3d2d 312c 0a20 2020 2073 6967 3d46   J=-1,.    sig=F
-00015a60: 616c 7365 2c0a 2020 2020 7776 6e3d 226d  alse,.    wvn="m
-00015a70: 6f72 6c65 7422 2c0a 2020 2020 756e 7772  orlet",.    unwr
-00015a80: 6170 666c 6167 3d46 616c 7365 2c0a 293a  apflag=False,.):
-00015a90: 0a20 2020 2022 2222 0a20 2020 2043 6f6d  .    """.    Com
-00015aa0: 7075 7465 2064 7420 6f72 2064 762f 7620  pute dt or dv/v 
-00015ab0: 696e 2074 696d 6520 616e 6420 6672 6571  in time and freq
-00015ac0: 7565 6e63 7920 646f 6d61 696e 2066 726f  uency domain fro
-00015ad0: 6d20 7761 7665 6c65 7420 6372 6f73 7320  m wavelet cross 
-00015ae0: 7370 6563 7472 756d 2028 7778 7329 2e0a  spectrum (wxs)..
-00015af0: 2020 2020 666f 7220 616c 6c20 6672 6571      for all freq
-00015b00: 7565 6369 6573 2069 6e20 616e 2069 6e74  uecies in an int
-00015b10: 6572 6573 7420 7261 6e67 650a 0a20 2020  erest range..   
-00015b20: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-00015b30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
-00015b40: 2020 2072 6566 3a20 5468 6520 2252 6566     ref: The "Ref
-00015b50: 6572 656e 6365 2220 7469 6d65 7365 7269  erence" timeseri
-00015b60: 6573 2028 6e75 6d70 792e 6e64 6172 7261  es (numpy.ndarra
-00015b70: 7929 0a20 2020 2063 7572 3a20 5468 6520  y).    cur: The 
-00015b80: 2243 7572 7265 6e74 2220 7469 6d65 7365  "Current" timese
-00015b90: 7269 6573 2028 6e75 6d70 792e 6e64 6172  ries (numpy.ndar
-00015ba0: 7261 7929 0a20 2020 2061 6c6c 6672 6571  ray).    allfreq
-00015bb0: 3a20 6120 626f 6f6c 656e 2076 6172 6961  : a boolen varia
-00015bc0: 626c 6520 746f 206d 616b 6520 6d65 6173  ble to make meas
-00015bd0: 7572 656d 656e 7473 206f 6e20 616c 6c20  urements on all 
-00015be0: 6672 6571 7565 6e63 7920 7261 6e67 6520  frequency range 
-00015bf0: 6f72 206e 6f74 0a20 2020 2070 6172 613a  or not.    para:
-00015c00: 2061 2064 6963 7420 636f 6e74 6169 6e69   a dict containi
-00015c10: 6e67 2066 7265 712f 7469 6d65 2069 6e66  ng freq/time inf
-00015c20: 6f20 6f66 2074 6865 2064 6174 6120 6d61  o of the data ma
-00015c30: 7472 6978 0a20 2020 2064 6a2c 2073 302c  trix.    dj, s0,
-00015c40: 204a 2c20 7369 672c 2077 766e 3a20 636f   J, sig, wvn: co
-00015c50: 6d6d 6f6e 2070 6172 616d 6574 6572 7320  mmon parameters 
-00015c60: 7573 6564 2069 6e20 2777 6176 656c 6574  used in 'wavelet
-00015c70: 2e77 6374 270a 2020 2020 756e 7772 6170  .wct'.    unwrap
-00015c80: 666c 6167 3a20 5472 7565 202d 2075 6e77  flag: True - unw
-00015c90: 7261 7020 7068 6173 6520 6465 6c61 7973  rap phase delays
-00015ca0: 2e20 4465 6661 756c 7420 6973 2046 616c  . Default is Fal
-00015cb0: 7365 0a0a 2020 2020 5245 5455 524e 533a  se..    RETURNS:
-00015cc0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
-00015cd0: 2d2d 2d2d 2d2d 2d0a 2020 2020 6476 762a  -------.    dvv*
-00015ce0: 3130 3020 3a20 6573 7469 6d61 7465 6420  100 : estimated 
-00015cf0: 6476 2f76 2069 6e20 250a 2020 2020 6572  dv/v in %.    er
-00015d00: 722a 3130 3020 3a20 6572 726f 7220 6f66  r*100 : error of
-00015d10: 2064 762f 7620 6573 7469 6d61 7469 6f6e   dv/v estimation
-00015d20: 2069 6e20 250a 0a20 2020 204f 7269 6769   in %..    Origi
-00015d30: 6e61 6c6c 7920 7772 6974 7465 6e20 6279  nally written by
-00015d40: 2054 696d 2043 6c65 6d65 6e74 7320 2831   Tim Clements (1
-00015d50: 204d 6172 6368 2c20 3230 3139 290a 2020   March, 2019).  
-00015d60: 2020 4d6f 6469 6669 6564 2062 7920 436f    Modified by Co
-00015d70: 6e67 636f 6e67 2059 7561 6e20 2833 3020  ngcong Yuan (30 
-00015d80: 4a75 6e65 2c20 3230 3139 2920 6261 7365  June, 2019) base
-00015d90: 6420 6f6e 2028 4d61 6f20 6574 2061 6c2e  d on (Mao et al.
-00015da0: 2032 3031 3929 2e0a 2020 2020 5570 6461   2019)..    Upda
-00015db0: 7465 6420 6279 2043 6865 6e67 7869 6e20  ted by Chengxin 
-00015dc0: 4a69 616e 6720 2831 3020 4f63 742c 2032  Jiang (10 Oct, 2
-00015dd0: 3031 3929 2074 6f20 6d65 7267 6520 7468  019) to merge th
-00015de0: 6520 6675 6e63 7469 6f6e 616c 6974 7920  e functionality 
-00015df0: 666f 7220 6d65 7375 7265 6d65 6e74 730a  for mesurements.
-00015e00: 2020 2020 6163 726f 7373 2061 6c6c 2066      across all f
-00015e10: 7265 7175 656e 6379 2061 6e64 206f 6e65  requency and one
-00015e20: 2066 7265 7120 7261 6e67 650a 2020 2020   freq range.    
-00015e30: 2222 220a 2020 2020 2320 636f 6d6d 6f6e  """.    # common
-00015e40: 2076 6172 6961 626c 6573 0a20 2020 2074   variables.    t
-00015e50: 7769 6e20 3d20 7061 7261 5b22 7477 696e  win = para["twin
-00015e60: 225d 0a20 2020 2066 7265 7120 3d20 7061  "].    freq = pa
-00015e70: 7261 5b22 6672 6571 225d 0a20 2020 2064  ra["freq"].    d
-00015e80: 7420 3d20 7061 7261 5b22 6474 225d 0a20  t = para["dt"]. 
-00015e90: 2020 2074 6d69 6e20 3d20 6e70 2e6d 696e     tmin = np.min
-00015ea0: 2874 7769 6e29 0a20 2020 2074 6d61 7820  (twin).    tmax 
-00015eb0: 3d20 6e70 2e6d 6178 2874 7769 6e29 0a20  = np.max(twin). 
-00015ec0: 2020 2066 6d69 6e20 3d20 6e70 2e6d 696e     fmin = np.min
-00015ed0: 2866 7265 7129 0a20 2020 2066 6d61 7820  (freq).    fmax 
-00015ee0: 3d20 6e70 2e6d 6178 2866 7265 7129 0a20  = np.max(freq). 
-00015ef0: 2020 2074 7665 6320 3d20 6e70 2e61 7261     tvec = np.ara
-00015f00: 6e67 6528 746d 696e 2c20 746d 6178 2c20  nge(tmin, tmax, 
-00015f10: 6474 290a 2020 2020 6e70 7473 203d 206c  dt).    npts = l
-00015f20: 656e 2874 7665 6329 0a0a 2020 2020 2320  en(tvec)..    # 
-00015f30: 7065 7266 6f72 6d20 6372 6f73 7320 636f  perform cross co
-00015f40: 6865 7265 6e74 2061 6e61 6c79 7369 732c  herent analysis,
-00015f50: 206d 6f64 6966 6965 6420 6672 6f6d 2066   modified from f
-00015f60: 756e 6374 696f 6e20 2777 6176 656c 6574  unction 'wavelet
-00015f70: 2e63 7774 270a 2020 2020 5743 542c 2061  .cwt'.    WCT, a
-00015f80: 5743 542c 2063 6f69 2c20 6672 6571 2c20  WCT, coi, freq, 
-00015f90: 7369 6720 3d20 7763 745f 6d6f 6469 6669  sig = wct_modifi
-00015fa0: 6564 2872 6566 2c20 6375 722c 2064 742c  ed(ref, cur, dt,
-00015fb0: 2064 6a3d 646a 2c20 7330 3d73 302c 204a   dj=dj, s0=s0, J
-00015fc0: 3d4a 2c20 7369 673d 7369 672c 2077 6176  =J, sig=sig, wav
-00015fd0: 656c 6574 3d77 766e 2c20 6e6f 726d 616c  elet=wvn, normal
-00015fe0: 697a 653d 5472 7565 290a 0a20 2020 2069  ize=True)..    i
-00015ff0: 6620 756e 7772 6170 666c 6167 3a0a 2020  f unwrapflag:.  
-00016000: 2020 2020 2020 7068 6173 6520 3d20 6e70        phase = np
-00016010: 2e75 6e77 7261 7028 6157 4354 2c20 6178  .unwrap(aWCT, ax
-00016020: 6973 3d2d 3129 2020 2320 6178 6973 3d30  is=-1)  # axis=0
-00016030: 2c20 7570 7772 6170 2061 6c6f 6e67 2074  , upwrap along t
-00016040: 696d 653b 2061 7869 733d 2d31 2c20 756e  ime; axis=-1, un
-00016050: 7772 6170 2061 6c6f 6e67 2066 7265 7175  wrap along frequ
-00016060: 656e 6379 0a20 2020 2065 6c73 653a 0a20  ency.    else:. 
-00016070: 2020 2020 2020 2070 6861 7365 203d 2061         phase = a
-00016080: 5743 540a 0a20 2020 2023 207a 6572 6f20  WCT..    # zero 
-00016090: 6f75 7420 6461 7461 206f 7574 7369 6465  out data outside
-000160a0: 2066 7265 7175 656e 6379 2062 616e 640a   frequency band.
-000160b0: 2020 2020 6966 2028 666d 6178 203e 206e      if (fmax > n
-000160c0: 702e 6d61 7828 6672 6571 2929 207c 2028  p.max(freq)) | (
-000160d0: 666d 6178 203c 3d20 666d 696e 293a 0a20  fmax <= fmin):. 
-000160e0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-000160f0: 7565 4572 726f 7228 2241 626f 7274 3a20  ueError("Abort: 
-00016100: 696e 7075 7420 6672 6571 7565 6e63 7920  input frequency 
-00016110: 6f75 7420 6f66 206c 696d 6974 7321 2229  out of limits!")
-00016120: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00016130: 2020 2066 7265 715f 696e 6469 6e20 3d20     freq_indin = 
-00016140: 6e70 2e77 6865 7265 2828 6672 6571 203e  np.where((freq >
-00016150: 3d20 666d 696e 2920 2620 2866 7265 7120  = fmin) & (freq 
-00016160: 3c3d 2066 6d61 7829 295b 305d 0a0a 2020  <= fmax))[0]..  
-00016170: 2020 2320 666f 6c6c 6f77 204d 5743 5320    # follow MWCS 
-00016180: 746f 2064 6f20 7477 6f20 7374 6570 7320  to do two steps 
-00016190: 6f66 206c 696e 6561 7220 7265 6772 6573  of linear regres
-000161a0: 7369 6f6e 0a20 2020 2069 6620 6e6f 7420  sion.    if not 
-000161b0: 616c 6c66 7265 713a 0a20 2020 2020 2020  allfreq:.       
-000161c0: 2064 656c 7461 5f74 5f6d 2c20 6465 6c74   delta_t_m, delt
-000161d0: 615f 745f 756e 6320 3d20 6e70 2e7a 6572  a_t_unc = np.zer
-000161e0: 6f73 286e 7074 732c 2064 7479 7065 3d6e  os(npts, dtype=n
-000161f0: 702e 666c 6f61 7433 3229 2c20 6e70 2e7a  p.float32), np.z
-00016200: 6572 6f73 286e 7074 732c 2064 7479 7065  eros(npts, dtype
-00016210: 3d6e 702e 666c 6f61 7433 3229 0a20 2020  =np.float32).   
-00016220: 2020 2020 2023 2061 7373 756d 6520 7468       # assume th
-00016230: 6520 7476 6563 2069 7320 7468 6520 7469  e tvec is the ti
-00016240: 6d65 2077 696e 646f 7720 746f 206d 6561  me window to mea
-00016250: 7375 7265 2064 740a 2020 2020 2020 2020  sure dt.        
-00016260: 666f 7220 6974 2069 6e20 7261 6e67 6528  for it in range(
-00016270: 6e70 7473 293a 0a20 2020 2020 2020 2020  npts):.         
-00016280: 2020 2077 203d 2031 202f 2057 4354 5b66     w = 1 / WCT[f
-00016290: 7265 715f 696e 6469 6e2c 2069 745d 0a20  req_indin, it]. 
-000162a0: 2020 2020 2020 2020 2020 2077 5b7e 6e70             w[~np
-000162b0: 2e69 7366 696e 6974 6528 7729 5d20 3d20  .isfinite(w)] = 
-000162c0: 312e 300a 2020 2020 2020 2020 2020 2020  1.0.            
-000162d0: 6465 6c74 615f 745f 6d5b 6974 5d2c 2064  delta_t_m[it], d
-000162e0: 656c 7461 5f74 5f75 6e63 5b69 745d 203d  elta_t_unc[it] =
-000162f0: 206c 696e 6561 725f 7265 6772 6573 7369   linear_regressi
-00016300: 6f6e 2866 7265 715b 6672 6571 5f69 6e64  on(freq[freq_ind
-00016310: 696e 5d20 2a20 3220 2a20 6e70 2e70 692c  in] * 2 * np.pi,
-00016320: 2070 6861 7365 5b66 7265 715f 696e 6469   phase[freq_indi
-00016330: 6e2c 2069 745d 2c20 7729 0a0a 2020 2020  n, it], w)..    
-00016340: 2020 2020 2320 6e65 7720 7765 6967 6874      # new weight
-00016350: 7320 666f 7220 7265 6772 6573 7369 6f6e  s for regression
-00016360: 0a20 2020 2020 2020 2077 3220 3d20 3120  .        w2 = 1 
-00016370: 2f20 6e70 2e6d 6561 6e28 5743 545b 6672  / np.mean(WCT[fr
-00016380: 6571 5f69 6e64 696e 2c20 3a5d 2c20 6178  eq_indin, :], ax
-00016390: 6973 3d30 290a 2020 2020 2020 2020 7732  is=0).        w2
-000163a0: 5b7e 6e70 2e69 7366 696e 6974 6528 7732  [~np.isfinite(w2
-000163b0: 295d 203d 2031 2e30 0a0a 2020 2020 2020  )] = 1.0..      
-000163c0: 2020 2320 6e6f 7720 7573 6520 6474 2061    # now use dt a
-000163d0: 6e64 2074 2074 6f20 6765 7420 6476 2f76  nd t to get dv/v
-000163e0: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-000163f0: 7732 2920 3e20 323a 0a20 2020 2020 2020  w2) > 2:.       
-00016400: 2020 2020 2069 6620 6e6f 7420 6e70 2e61       if not np.a
-00016410: 6e79 2864 656c 7461 5f74 5f6d 293a 0a20  ny(delta_t_m):. 
-00016420: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00016430: 7676 2c20 6572 7220 3d20 6e70 2e6e 616e  vv, err = np.nan
-00016440: 2c20 6e70 2e6e 616e 0a20 2020 2020 2020  , np.nan.       
-00016450: 2020 2020 206d 2c20 656d 203d 206c 696e       m, em = lin
-00016460: 6561 725f 7265 6772 6573 7369 6f6e 2874  ear_regression(t
-00016470: 7665 632c 2064 656c 7461 5f74 5f6d 2c20  vec, delta_t_m, 
-00016480: 7732 2c20 696e 7465 7263 6570 745f 6f72  w2, intercept_or
-00016490: 6967 696e 3d54 7275 6529 0a20 2020 2020  igin=True).     
-000164a0: 2020 2020 2020 2064 7676 2c20 6572 7220         dvv, err 
-000164b0: 3d20 2d6d 2c20 656d 0a20 2020 2020 2020  = -m, em.       
-000164c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000164d0: 2020 2070 7269 6e74 2822 6e6f 7420 656e     print("not en
-000164e0: 6f75 6768 2070 6f69 6e74 7320 746f 2065  ough points to e
-000164f0: 7374 696d 6174 6520 6476 2f76 2066 6f72  stimate dv/v for
-00016500: 2077 7473 2229 0a20 2020 2020 2020 2020   wts").         
-00016510: 2020 2064 7676 2c20 6572 7220 3d20 6e70     dvv, err = np
-00016520: 2e6e 616e 2c20 6e70 2e6e 616e 0a0a 2020  .nan, np.nan..  
-00016530: 2020 2020 2020 7265 7475 726e 2064 7676        return dvv
-00016540: 202a 2031 3030 2c20 6572 7220 2a20 3130   * 100, err * 10
-00016550: 300a 0a20 2020 2023 2063 6f6e 7665 7274  0..    # convert
-00016560: 2070 6861 7365 2064 6972 6563 746c 7920   phase directly 
-00016570: 746f 2064 656c 7461 5f74 2066 6f72 2061  to delta_t for a
-00016580: 6c6c 2066 7265 7175 656e 6369 6573 0a20  ll frequencies. 
-00016590: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000165a0: 2023 2063 6f6e 7665 7274 2070 6861 7365   # convert phase
-000165b0: 2064 656c 6179 2074 6f20 7469 6d65 2064   delay to time d
-000165c0: 656c 6179 0a20 2020 2020 2020 2064 656c  elay.        del
-000165d0: 7461 5f74 203d 2070 6861 7365 202f 2028  ta_t = phase / (
-000165e0: 3220 2a20 6e70 2e70 6920 2a20 6672 6571  2 * np.pi * freq
-000165f0: 5b3a 2c20 4e6f 6e65 5d29 2020 2320 6e6f  [:, None])  # no
-00016600: 726d 616c 697a 6520 7068 6173 6520 6279  rmalize phase by
-00016610: 2028 322a 7069 2a66 7265 7175 656e 6379   (2*pi*frequency
-00016620: 290a 2020 2020 2020 2020 6476 762c 2065  ).        dvv, e
-00016630: 7272 203d 206e 702e 7a65 726f 7328 6672  rr = np.zeros(fr
-00016640: 6571 5f69 6e64 696e 2e73 6861 7065 292c  eq_indin.shape),
-00016650: 206e 702e 7a65 726f 7328 6672 6571 5f69   np.zeros(freq_i
-00016660: 6e64 696e 2e73 6861 7065 290a 0a20 2020  ndin.shape)..   
-00016670: 2020 2020 2023 206c 6f6f 7020 7468 726f       # loop thro
-00016680: 7567 6820 6672 6571 2066 6f72 206c 696e  ugh freq for lin
-00016690: 6561 7220 7265 6772 6573 7369 6f6e 0a20  ear regression. 
-000166a0: 2020 2020 2020 2066 6f72 2069 692c 2069         for ii, i
-000166b0: 6672 6571 2069 6e20 656e 756d 6572 6174  freq in enumerat
-000166c0: 6528 6672 6571 5f69 6e64 696e 293a 0a20  e(freq_indin):. 
-000166d0: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-000166e0: 6e28 7476 6563 2920 3e20 323a 0a20 2020  n(tvec) > 2:.   
-000166f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00016700: 6e6f 7420 6e70 2e61 6e79 2864 656c 7461  not np.any(delta
-00016710: 5f74 5b69 6672 6571 5d29 3a0a 2020 2020  _t[ifreq]):.    
-00016720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016730: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
-00016740: 2020 2020 2020 2020 2020 2320 686f 7720            # how 
-00016750: 746f 2062 6574 7465 7220 6170 7072 6f61  to better approa
-00016760: 6368 2074 6865 2075 6e63 6572 7461 696e  ch the uncertain
-00016770: 7479 206f 6620 6465 6c74 615f 740a 2020  ty of delta_t.  
-00016780: 2020 2020 2020 2020 2020 2020 2020 7720                w 
-00016790: 3d20 3120 2f20 5743 545b 6966 7265 715d  = 1 / WCT[ifreq]
-000167a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000167b0: 2077 5b7e 6e70 2e69 7366 696e 6974 6528   w[~np.isfinite(
-000167c0: 7729 5d20 3d20 312e 300a 0a20 2020 2020  w)] = 1.0..     
-000167d0: 2020 2020 2020 2020 2020 2023 206d 2c20             # m, 
-000167e0: 612c 2065 6d2c 2065 6120 3d20 6c69 6e65  a, em, ea = line
-000167f0: 6172 5f72 6567 7265 7373 696f 6e28 7469  ar_regression(ti
-00016800: 6d65 5f61 7869 735b 696e 6478 5d2c 2064  me_axis[indx], d
-00016810: 656c 7461 5f74 5b69 6e64 785d 2c20 772c  elta_t[indx], w,
-00016820: 2069 6e74 6572 6365 7074 5f6f 7269 6769   intercept_origi
-00016830: 6e3d 4661 6c73 6529 0a20 2020 2020 2020  n=False).       
-00016840: 2020 2020 2020 2020 206d 2c20 656d 203d           m, em =
-00016850: 206c 696e 6561 725f 7265 6772 6573 7369   linear_regressi
-00016860: 6f6e 2874 7665 632c 2064 656c 7461 5f74  on(tvec, delta_t
-00016870: 5b69 6672 6571 5d2c 2077 2c20 696e 7465  [ifreq], w, inte
-00016880: 7263 6570 745f 6f72 6967 696e 3d54 7275  rcept_origin=Tru
-00016890: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-000168a0: 2020 2064 7676 5b69 695d 2c20 6572 725b     dvv[ii], err[
-000168b0: 6969 5d20 3d20 2d6d 2c20 656d 0a20 2020  ii] = -m, em.   
-000168c0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000168d0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000168e0: 7269 6e74 2822 6e6f 7420 656e 6f75 6768  rint("not enough
-000168f0: 2070 6f69 6e74 7320 746f 2065 7374 696d   points to estim
-00016900: 6174 6520 6476 2f76 2066 6f72 2077 7473  ate dv/v for wts
-00016910: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00016920: 2020 2064 7676 5b69 695d 2c20 6572 725b     dvv[ii], err[
-00016930: 6969 5d20 3d20 6e70 2e6e 616e 2c20 6e70  ii] = np.nan, np
-00016940: 2e6e 616e 0a0a 2020 2020 2020 2020 7265  .nan..        re
-00016950: 7475 726e 2066 7265 715b 6672 6571 5f69  turn freq[freq_i
-00016960: 6e64 696e 5d2c 2064 7676 202a 2031 3030  ndin], dvv * 100
-00016970: 2c20 6572 7220 2a20 3130 300a 0a0a 6465  , err * 100...de
-00016980: 6620 7774 735f 6476 7628 0a20 2020 2072  f wts_dvv(.    r
-00016990: 6566 2c0a 2020 2020 6375 722c 0a20 2020  ef,.    cur,.   
-000169a0: 2061 6c6c 6672 6571 2c0a 2020 2020 7061   allfreq,.    pa
-000169b0: 7261 2c0a 2020 2020 6476 5f72 616e 6765  ra,.    dv_range
-000169c0: 2c0a 2020 2020 6e62 7472 6961 6c2c 0a20  ,.    nbtrial,. 
-000169d0: 2020 2064 6a3d 3120 2f20 3132 2c0a 2020     dj=1 / 12,.  
-000169e0: 2020 7330 3d2d 312c 0a20 2020 204a 3d2d    s0=-1,.    J=-
-000169f0: 312c 0a20 2020 2077 766e 3d22 6d6f 726c  1,.    wvn="morl
-00016a00: 6574 222c 0a20 2020 206e 6f72 6d61 6c69  et",.    normali
-00016a10: 7a65 3d54 7275 652c 0a29 3a0a 2020 2020  ze=True,.):.    
-00016a20: 2222 220a 2020 2020 4170 706c 7920 7374  """.    Apply st
-00016a30: 7265 7463 6869 6e67 206d 6574 686f 6420  retching method 
-00016a40: 746f 2063 6f6e 7469 6e75 6f75 7320 7761  to continuous wa
-00016a50: 7665 6c65 7420 7472 616e 7366 6f72 6d61  velet transforma
-00016a60: 7469 6f6e 2028 4357 5429 206f 6620 7369  tion (CWT) of si
-00016a70: 676e 616c 730a 2020 2020 666f 7220 616c  gnals.    for al
-00016a80: 6c20 6672 6571 7565 6369 6573 2069 6e20  l frequecies in 
-00016a90: 616e 2069 6e74 6572 6573 7420 7261 6e67  an interest rang
-00016aa0: 650a 0a20 2020 2050 6172 616d 6574 6572  e..    Parameter
-00016ab0: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
-00016ac0: 2d2d 2d2d 0a20 2020 2072 6566 3a20 5468  ----.    ref: Th
-00016ad0: 6520 2252 6566 6572 656e 6365 2220 7469  e "Reference" ti
-00016ae0: 6d65 7365 7269 6573 2028 6e75 6d70 792e  meseries (numpy.
-00016af0: 6e64 6172 7261 7929 0a20 2020 2063 7572  ndarray).    cur
-00016b00: 3a20 5468 6520 2243 7572 7265 6e74 2220  : The "Current" 
-00016b10: 7469 6d65 7365 7269 6573 2028 6e75 6d70  timeseries (nump
-00016b20: 792e 6e64 6172 7261 7929 0a20 2020 2061  y.ndarray).    a
-00016b30: 6c6c 6672 6571 3a20 6120 626f 6f6c 656e  llfreq: a boolen
-00016b40: 2076 6172 6961 626c 6520 746f 206d 616b   variable to mak
-00016b50: 6520 6d65 6173 7572 656d 656e 7473 206f  e measurements o
-00016b60: 6e20 616c 6c20 6672 6571 7565 6e63 7920  n all frequency 
-00016b70: 7261 6e67 6520 6f72 206e 6f74 0a20 2020  range or not.   
-00016b80: 2070 6172 613a 2061 2064 6963 7420 636f   para: a dict co
-00016b90: 6e74 6169 6e69 6e67 2066 7265 712f 7469  ntaining freq/ti
-00016ba0: 6d65 2069 6e66 6f20 6f66 2074 6865 2064  me info of the d
-00016bb0: 6174 6120 6d61 7472 6978 0a20 2020 2064  ata matrix.    d
-00016bc0: 765f 7261 6e67 653a 2061 6273 6f6c 7574  v_range: absolut
-00016bd0: 6520 626f 756e 6420 666f 7220 7468 6520  e bound for the 
-00016be0: 7665 6c6f 6369 7479 2076 6172 6961 7469  velocity variati
-00016bf0: 6f6e 3b20 6578 616d 706c 653a 2064 763d  on; example: dv=
-00016c00: 302e 3033 2066 6f72 205b 2d33 2c33 5d25  0.03 for [-3,3]%
-00016c10: 0a20 2020 206f 6620 7265 6c61 7469 7665  .    of relative
-00016c20: 2076 656c 6f63 6974 7920 6368 616e 6765   velocity change
-00016c30: 2028 666c 6f61 7429 0a20 2020 206e 6274   (float).    nbt
-00016c40: 7269 616c 3a20 6e75 6d62 6572 206f 6620  rial: number of 
-00016c50: 7374 7265 7463 6869 6e67 2063 6f65 6666  stretching coeff
-00016c60: 6963 6965 6e74 2062 6574 7765 656e 2064  icient between d
-00016c70: 766d 696e 2061 6e64 2064 766d 6178 2c20  vmin and dvmax, 
-00016c80: 6e6f 206e 6565 6420 746f 2062 6520 6869  no need to be hi
-00016c90: 6768 6572 2074 6861 6e20 3130 3020 2028  gher than 100  (
-00016ca0: 666c 6f61 7429 0a20 2020 2064 6a2c 2073  float).    dj, s
-00016cb0: 302c 204a 2c20 7369 672c 2077 766e 3a20  0, J, sig, wvn: 
-00016cc0: 636f 6d6d 6f6e 2070 6172 616d 6574 6572  common parameter
-00016cd0: 7320 7573 6564 2069 6e20 2777 6176 656c  s used in 'wavel
-00016ce0: 6574 2e77 6374 270a 2020 2020 6e6f 726d  et.wct'.    norm
-00016cf0: 616c 697a 653a 206e 6f72 6d61 6c69 7a65  alize: normalize
-00016d00: 2074 6865 2077 6176 656c 6574 2073 7065   the wavelet spe
-00016d10: 6374 7275 6d20 6f72 206e 6f74 2e20 4465  ctrum or not. De
-00016d20: 6661 756c 7420 6973 2054 7275 650a 0a20  fault is True.. 
-00016d30: 2020 2052 4554 5552 4e53 3a0a 2020 2020     RETURNS:.    
-00016d40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00016d50: 2d2d 0a20 2020 2064 7676 3a20 6573 7469  --.    dvv: esti
-00016d60: 6d61 7465 6420 6476 2f76 0a20 2020 2065  mated dv/v.    e
-00016d70: 7272 3a20 6572 726f 7220 6f66 2064 762f  rr: error of dv/
-00016d80: 7620 6573 7469 6d61 7469 6f6e 0a0a 2020  v estimation..  
-00016d90: 2020 5772 6974 7465 6e20 6279 2043 6f6e    Written by Con
-00016da0: 6763 6f6e 6720 5975 616e 2028 3330 204a  gcong Yuan (30 J
-00016db0: 756e 2c20 3230 3139 290a 2020 2020 2222  un, 2019).    ""
-00016dc0: 220a 2020 2020 2320 636f 6d6d 6f6e 2076  ".    # common v
-00016dd0: 6172 6961 626c 6573 0a20 2020 2066 7265  ariables.    fre
-00016de0: 7120 3d20 7061 7261 5b22 6672 6571 225d  q = para["freq"]
-00016df0: 0a20 2020 2064 7420 3d20 7061 7261 5b22  .    dt = para["
-00016e00: 6474 225d 0a20 2020 2066 6d69 6e20 3d20  dt"].    fmin = 
-00016e10: 6e70 2e6d 696e 2866 7265 7129 0a20 2020  np.min(freq).   
-00016e20: 2066 6d61 7820 3d20 6e70 2e6d 6178 2866   fmax = np.max(f
-00016e30: 7265 7129 0a0a 2020 2020 2320 6170 706c  req)..    # appl
-00016e40: 7920 6377 7420 6f6e 2074 776f 2074 7261  y cwt on two tra
-00016e50: 6365 730a 2020 2020 6377 7431 2c20 736a  ces.    cwt1, sj
-00016e60: 2c20 6672 6571 2c20 636f 692c 205f 2c20  , freq, coi, _, 
-00016e70: 5f20 3d20 7079 6377 742e 6377 7428 6375  _ = pycwt.cwt(cu
-00016e80: 722c 2064 742c 2064 6a2c 2073 302c 204a  r, dt, dj, s0, J
-00016e90: 2c20 7776 6e29 0a20 2020 2063 7774 322c  , wvn).    cwt2,
-00016ea0: 2073 6a2c 2066 7265 712c 2063 6f69 2c20   sj, freq, coi, 
-00016eb0: 5f2c 205f 203d 2070 7963 7774 2e63 7774  _, _ = pycwt.cwt
-00016ec0: 2872 6566 2c20 6474 2c20 646a 2c20 7330  (ref, dt, dj, s0
-00016ed0: 2c20 4a2c 2077 766e 290a 0a20 2020 2023  , J, wvn)..    #
-00016ee0: 2065 7874 7261 6374 2072 6561 6c20 7661   extract real va
-00016ef0: 6c75 6573 206f 6620 6377 740a 2020 2020  lues of cwt.    
-00016f00: 7263 7774 312c 2072 6377 7432 203d 206e  rcwt1, rcwt2 = n
-00016f10: 702e 7265 616c 2863 7774 3129 2c20 6e70  p.real(cwt1), np
-00016f20: 2e72 6561 6c28 6377 7432 290a 0a20 2020  .real(cwt2)..   
-00016f30: 2023 207a 6572 6f20 6f75 7420 6461 7461   # zero out data
-00016f40: 206f 7574 7369 6465 2066 7265 7175 656e   outside frequen
-00016f50: 6379 2062 616e 640a 2020 2020 6966 2028  cy band.    if (
-00016f60: 666d 6178 203e 206e 702e 6d61 7828 6672  fmax > np.max(fr
-00016f70: 6571 2929 207c 2028 666d 6178 203c 3d20  eq)) | (fmax <= 
-00016f80: 666d 696e 293a 0a20 2020 2020 2020 2072  fmin):.        r
-00016f90: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00016fa0: 2241 626f 7274 3a20 696e 7075 7420 6672  "Abort: input fr
-00016fb0: 6571 7565 6e63 7920 6f75 7420 6f66 206c  equency out of l
-00016fc0: 696d 6974 7321 2229 0a20 2020 2065 6c73  imits!").    els
-00016fd0: 653a 0a20 2020 2020 2020 2066 7265 715f  e:.        freq_
-00016fe0: 696e 6469 6e20 3d20 6e70 2e77 6865 7265  indin = np.where
-00016ff0: 2828 6672 6571 203e 3d20 666d 696e 2920  ((freq >= fmin) 
-00017000: 2620 2866 7265 7120 3c3d 2066 6d61 7829  & (freq <= fmax)
-00017010: 295b 305d 0a0a 2020 2020 2320 636f 6e76  )[0]..    # conv
-00017020: 6572 7420 7761 7665 6c65 7420 646f 6d61  ert wavelet doma
-00017030: 696e 2062 6163 6b20 746f 2074 696d 6520  in back to time 
-00017040: 646f 6d61 696e 2028 7e66 696c 7465 7269  domain (~filteri
-00017050: 6e67 290a 2020 2020 6966 206e 6f74 2061  ng).    if not a
-00017060: 6c6c 6672 6571 3a0a 2020 2020 2020 2020  llfreq:.        
-00017070: 2320 696e 7665 7273 6520 6377 7420 746f  # inverse cwt to
-00017080: 2074 696d 6520 646f 6d61 696e 0a20 2020   time domain.   
-00017090: 2020 2020 2069 6377 7431 203d 2070 7963       icwt1 = pyc
-000170a0: 7774 2e69 6377 7428 6377 7431 5b66 7265  wt.icwt(cwt1[fre
-000170b0: 715f 696e 6469 6e5d 2c20 736a 5b66 7265  q_indin], sj[fre
-000170c0: 715f 696e 6469 6e5d 2c20 6474 2c20 646a  q_indin], dt, dj
-000170d0: 2c20 7776 6e29 0a20 2020 2020 2020 2069  , wvn).        i
-000170e0: 6377 7432 203d 2070 7963 7774 2e69 6377  cwt2 = pycwt.icw
-000170f0: 7428 6377 7432 5b66 7265 715f 696e 6469  t(cwt2[freq_indi
-00017100: 6e5d 2c20 736a 5b66 7265 715f 696e 6469  n], sj[freq_indi
-00017110: 6e5d 2c20 6474 2c20 646a 2c20 7776 6e29  n], dt, dj, wvn)
-00017120: 0a0a 2020 2020 2020 2020 2320 6173 7375  ..        # assu
-00017130: 6d65 2061 6c6c 2074 696d 6520 7769 6e64  me all time wind
-00017140: 6f77 2069 7320 7573 6564 0a20 2020 2020  ow is used.     
-00017150: 2020 2077 6377 7431 2c20 7763 7774 3220     wcwt1, wcwt2 
-00017160: 3d20 6e70 2e72 6561 6c28 6963 7774 3129  = np.real(icwt1)
-00017170: 2c20 6e70 2e72 6561 6c28 6963 7774 3229  , np.real(icwt2)
-00017180: 0a0a 2020 2020 2020 2020 2320 4e6f 726d  ..        # Norm
-00017190: 616c 697a 6573 2062 6f74 6820 7369 676e  alizes both sign
-000171a0: 616c 732c 2069 6620 6170 7072 6f70 7269  als, if appropri
-000171b0: 6174 652e 0a20 2020 2020 2020 2069 6620  ate..        if 
-000171c0: 6e6f 726d 616c 697a 653a 0a20 2020 2020  normalize:.     
-000171d0: 2020 2020 2020 206e 6377 7431 203d 2028         ncwt1 = (
-000171e0: 7763 7774 3120 2d20 7763 7774 312e 6d65  wcwt1 - wcwt1.me
-000171f0: 616e 2829 2920 2f20 7763 7774 312e 7374  an()) / wcwt1.st
-00017200: 6428 290a 2020 2020 2020 2020 2020 2020  d().            
-00017210: 6e63 7774 3220 3d20 2877 6377 7432 202d  ncwt2 = (wcwt2 -
-00017220: 2077 6377 7432 2e6d 6561 6e28 2929 202f   wcwt2.mean()) /
-00017230: 2077 6377 7432 2e73 7464 2829 0a20 2020   wcwt2.std().   
-00017240: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00017250: 2020 2020 2020 206e 6377 7431 203d 2077         ncwt1 = w
-00017260: 6377 7431 0a20 2020 2020 2020 2020 2020  cwt1.           
-00017270: 206e 6377 7432 203d 2077 6377 7432 0a0a   ncwt2 = wcwt2..
-00017280: 2020 2020 2020 2020 2320 7275 6e20 7374          # run st
-00017290: 7265 7463 6869 6e67 0a20 2020 2020 2020  retching.       
-000172a0: 2064 7676 2c20 6572 722c 2063 632c 2063   dvv, err, cc, c
-000172b0: 6470 203d 2073 7472 6574 6368 696e 6728  dp = stretching(
-000172c0: 6e63 7774 322c 206e 6377 7431 2c20 6476  ncwt2, ncwt1, dv
-000172d0: 5f72 616e 6765 2c20 6e62 7472 6961 6c2c  _range, nbtrial,
-000172e0: 2070 6172 6129 0a20 2020 2020 2020 2072   para).        r
-000172f0: 6574 7572 6e20 6476 762c 2065 7272 0a0a  eturn dvv, err..
-00017300: 2020 2020 2320 6469 7265 6374 6c79 2074      # directly t
-00017310: 616b 6520 6164 7661 6e74 6167 6520 6f66  ake advantage of
-00017320: 2074 6865 0a20 2020 2065 6c73 653a 0a20   the.    else:. 
-00017330: 2020 2020 2020 2023 2069 6e69 7469 616c         # initial
-00017340: 697a 6520 7661 7269 6162 6c65 0a20 2020  ize variable.   
-00017350: 2020 2020 206e 6672 6571 203d 206c 656e       nfreq = len
-00017360: 2866 7265 715f 696e 6469 6e29 0a20 2020  (freq_indin).   
-00017370: 2020 2020 2064 7676 2c20 6363 2c20 6364       dvv, cc, cd
-00017380: 702c 2065 7272 203d 2028 0a20 2020 2020  p, err = (.     
-00017390: 2020 2020 2020 206e 702e 7a65 726f 7328         np.zeros(
-000173a0: 6e66 7265 712c 2064 7479 7065 3d6e 702e  nfreq, dtype=np.
-000173b0: 666c 6f61 7433 3229 2c0a 2020 2020 2020  float32),.      
-000173c0: 2020 2020 2020 6e70 2e7a 6572 6f73 286e        np.zeros(n
-000173d0: 6672 6571 2c20 6474 7970 653d 6e70 2e66  freq, dtype=np.f
-000173e0: 6c6f 6174 3332 292c 0a20 2020 2020 2020  loat32),.       
-000173f0: 2020 2020 206e 702e 7a65 726f 7328 6e66       np.zeros(nf
-00017400: 7265 712c 2064 7479 7065 3d6e 702e 666c  req, dtype=np.fl
-00017410: 6f61 7433 3229 2c0a 2020 2020 2020 2020  oat32),.        
-00017420: 2020 2020 6e70 2e7a 6572 6f73 286e 6672      np.zeros(nfr
-00017430: 6571 2c20 6474 7970 653d 6e70 2e66 6c6f  eq, dtype=np.flo
-00017440: 6174 3332 292c 0a20 2020 2020 2020 2029  at32),.        )
-00017450: 0a0a 2020 2020 2020 2020 2320 6c6f 6f70  ..        # loop
-00017460: 2074 6872 6f75 6768 2065 6163 6820 6672   through each fr
-00017470: 6571 0a20 2020 2020 2020 2066 6f72 2069  eq.        for i
-00017480: 692c 2069 6672 6571 2069 6e20 656e 756d  i, ifreq in enum
-00017490: 6572 6174 6528 6672 6571 5f69 6e64 696e  erate(freq_indin
-000174a0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
-000174b0: 2070 7265 7061 7265 2077 696e 646f 7765   prepare windowe
-000174c0: 6420 6461 7461 0a20 2020 2020 2020 2020  d data.         
-000174d0: 2020 2077 6377 7431 2c20 7763 7774 3220     wcwt1, wcwt2 
-000174e0: 3d20 7263 7774 315b 6966 7265 715d 2c20  = rcwt1[ifreq], 
-000174f0: 7263 7774 325b 6966 7265 715d 0a0a 2020  rcwt2[ifreq]..  
-00017500: 2020 2020 2020 2020 2020 2320 4e6f 726d            # Norm
-00017510: 616c 697a 6573 2062 6f74 6820 7369 676e  alizes both sign
-00017520: 616c 732c 2069 6620 6170 7072 6f70 7269  als, if appropri
-00017530: 6174 652e 0a20 2020 2020 2020 2020 2020  ate..           
-00017540: 2069 6620 6e6f 726d 616c 697a 653a 0a20   if normalize:. 
-00017550: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00017560: 6377 7431 203d 2028 7763 7774 3120 2d20  cwt1 = (wcwt1 - 
-00017570: 7763 7774 312e 6d65 616e 2829 2920 2f20  wcwt1.mean()) / 
-00017580: 7763 7774 312e 7374 6428 290a 2020 2020  wcwt1.std().    
-00017590: 2020 2020 2020 2020 2020 2020 6e63 7774              ncwt
-000175a0: 3220 3d20 2877 6377 7432 202d 2077 6377  2 = (wcwt2 - wcw
-000175b0: 7432 2e6d 6561 6e28 2929 202f 2077 6377  t2.mean()) / wcw
-000175c0: 7432 2e73 7464 2829 0a20 2020 2020 2020  t2.std().       
-000175d0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000175e0: 2020 2020 2020 2020 2020 206e 6377 7431             ncwt1
-000175f0: 203d 2077 6377 7431 0a20 2020 2020 2020   = wcwt1.       
-00017600: 2020 2020 2020 2020 206e 6377 7432 203d           ncwt2 =
-00017610: 2077 6377 7432 0a0a 2020 2020 2020 2020   wcwt2..        
-00017620: 2020 2020 2320 7275 6e20 7374 7265 7463      # run stretc
-00017630: 6869 6e67 0a20 2020 2020 2020 2020 2020  hing.           
-00017640: 2064 762c 2065 7272 6f72 2c20 6331 2c20   dv, error, c1, 
-00017650: 6332 203d 2073 7472 6574 6368 696e 6728  c2 = stretching(
-00017660: 6e63 7774 322c 206e 6377 7431 2c20 6476  ncwt2, ncwt1, dv
-00017670: 5f72 616e 6765 2c20 6e62 7472 6961 6c2c  _range, nbtrial,
-00017680: 2070 6172 6129 0a20 2020 2020 2020 2020   para).         
-00017690: 2020 2064 7676 5b69 695d 2c20 6363 5b69     dvv[ii], cc[i
-000176a0: 695d 2c20 6364 705b 6969 5d2c 2065 7272  i], cdp[ii], err
-000176b0: 5b69 695d 203d 2064 762c 2063 312c 2063  [ii] = dv, c1, c
-000176c0: 322c 2065 7272 6f72 0a0a 2020 2020 2020  2, error..      
-000176d0: 2020 7265 7475 726e 2066 7265 715b 6672    return freq[fr
-000176e0: 6571 5f69 6e64 696e 5d2c 2064 7676 2c20  eq_indin], dvv, 
-000176f0: 6572 720a 0a0a 6465 6620 7774 6474 775f  err...def wtdtw_
-00017700: 616c 6c66 7265 7128 0a20 2020 2072 6566  allfreq(.    ref
-00017710: 2c0a 2020 2020 6375 722c 0a20 2020 2061  ,.    cur,.    a
-00017720: 6c6c 6672 6571 2c0a 2020 2020 7061 7261  llfreq,.    para
-00017730: 2c0a 2020 2020 6d61 784c 6167 2c0a 2020  ,.    maxLag,.  
-00017740: 2020 622c 0a20 2020 2064 6972 6563 7469    b,.    directi
-00017750: 6f6e 2c0a 2020 2020 646a 3d31 202f 2031  on,.    dj=1 / 1
-00017760: 322c 0a20 2020 2073 303d 2d31 2c0a 2020  2,.    s0=-1,.  
-00017770: 2020 4a3d 2d31 2c0a 2020 2020 7776 6e3d    J=-1,.    wvn=
-00017780: 226d 6f72 6c65 7422 2c0a 2020 2020 6e6f  "morlet",.    no
-00017790: 726d 616c 697a 653d 5472 7565 2c0a 293a  rmalize=True,.):
-000177a0: 0a20 2020 2022 2222 0a20 2020 2041 7070  .    """.    App
-000177b0: 6c79 2064 796e 616d 6963 2074 696d 6520  ly dynamic time 
-000177c0: 7761 7270 696e 6720 6d65 7468 6f64 2074  warping method t
-000177d0: 6f20 636f 6e74 696e 756f 7573 2077 6176  o continuous wav
-000177e0: 656c 6574 2074 7261 6e73 666f 726d 6174  elet transformat
-000177f0: 696f 6e20 2843 5754 2920 6f66 2073 6967  ion (CWT) of sig
-00017800: 6e61 6c73 0a20 2020 2066 6f72 2061 6c6c  nals.    for all
-00017810: 2066 7265 7175 6563 6965 7320 696e 2061   frequecies in a
-00017820: 6e20 696e 7465 7265 7374 2072 616e 6765  n interest range
-00017830: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
-00017840: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
-00017850: 2d2d 2d0a 2020 2020 7265 663a 2054 6865  ---.    ref: The
-00017860: 2022 5265 6665 7265 6e63 6522 2074 696d   "Reference" tim
-00017870: 6573 6572 6965 7320 286e 756d 7079 2e6e  eseries (numpy.n
-00017880: 6461 7272 6179 290a 2020 2020 6375 723a  darray).    cur:
-00017890: 2054 6865 2022 4375 7272 656e 7422 2074   The "Current" t
-000178a0: 696d 6573 6572 6965 7320 286e 756d 7079  imeseries (numpy
-000178b0: 2e6e 6461 7272 6179 290a 2020 2020 616c  .ndarray).    al
-000178c0: 6c66 7265 713a 2061 2062 6f6f 6c65 6e20  lfreq: a boolen 
-000178d0: 7661 7269 6162 6c65 2074 6f20 6d61 6b65  variable to make
-000178e0: 206d 6561 7375 7265 6d65 6e74 7320 6f6e   measurements on
-000178f0: 2061 6c6c 2066 7265 7175 656e 6379 2072   all frequency r
-00017900: 616e 6765 206f 7220 6e6f 740a 2020 2020  ange or not.    
-00017910: 6d61 784c 6167 3a20 6d61 7820 6e75 6d62  maxLag: max numb
-00017920: 6572 206f 6620 706f 696e 7473 2074 6f20  er of points to 
-00017930: 7365 6172 6368 2066 6f72 7761 7264 2061  search forward a
-00017940: 6e64 2062 6163 6b77 6172 642e 0a20 2020  nd backward..   
-00017950: 2062 3a20 622d 7661 6c75 6520 746f 206c   b: b-value to l
-00017960: 696d 6974 2073 7472 6169 6e2c 2077 6869  imit strain, whi
-00017970: 6368 2069 7320 746f 206c 696d 6974 2074  ch is to limit t
-00017980: 6865 206d 6178 696d 756d 2076 656c 6f63  he maximum veloc
-00017990: 6974 7920 7065 7274 7572 6261 7469 6f6e  ity perturbation
-000179a0: 2e0a 2020 2020 5365 6520 6571 7561 7469  ..    See equati
-000179b0: 6f6e 2031 3120 696e 2028 4d69 6b65 7365  on 11 in (Mikese
-000179c0: 6c6c 2065 7420 616c 2e20 3230 3135 290a  ll et al. 2015).
-000179d0: 2020 2020 6469 7265 6374 696f 6e3a 2064      direction: d
-000179e0: 6972 6563 7469 6f6e 2074 6f20 6163 6375  irection to accu
-000179f0: 6d75 6c61 7465 2065 7272 6f72 7320 2831  mulate errors (1
-00017a00: 3d66 6f72 7761 7264 2c20 2d31 3d62 6163  =forward, -1=bac
-00017a10: 6b77 6172 6429 0a20 2020 2064 6a2c 2073  kward).    dj, s
-00017a20: 302c 204a 2c20 7369 672c 2077 766e 3a20  0, J, sig, wvn: 
-00017a30: 636f 6d6d 6f6e 2070 6172 616d 6574 6572  common parameter
-00017a40: 7320 7573 6564 2069 6e20 2777 6176 656c  s used in 'wavel
-00017a50: 6574 2e77 6374 270a 2020 2020 6e6f 726d  et.wct'.    norm
-00017a60: 616c 697a 653a 206e 6f72 6d61 6c69 7a65  alize: normalize
-00017a70: 2074 6865 2077 6176 656c 6574 2073 7065   the wavelet spe
-00017a80: 6374 7275 6d20 6f72 206e 6f74 2e20 4465  ctrum or not. De
-00017a90: 6661 756c 7420 6973 2054 7275 650a 0a20  fault is True.. 
-00017aa0: 2020 2052 4554 5552 4e53 3a0a 2020 2020     RETURNS:.    
-00017ab0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00017ac0: 2d2d 0a20 2020 2064 7676 3a20 6573 7469  --.    dvv: esti
-00017ad0: 6d61 7465 6420 6476 2f76 0a20 2020 2065  mated dv/v.    e
-00017ae0: 7272 3a20 6572 726f 7220 6f66 2064 762f  rr: error of dv/
-00017af0: 7620 6573 7469 6d61 7469 6f6e 0a0a 2020  v estimation..  
-00017b00: 2020 5772 6974 7465 6e20 6279 2043 6f6e    Written by Con
-00017b10: 6763 6f6e 6720 5975 616e 2028 3330 204a  gcong Yuan (30 J
-00017b20: 756e 2c20 3230 3139 290a 2020 2020 2222  un, 2019).    ""
-00017b30: 220a 2020 2020 2320 636f 6d6d 6f6e 2076  ".    # common v
-00017b40: 6172 6961 626c 6573 0a20 2020 2066 7265  ariables.    fre
-00017b50: 7120 3d20 7061 7261 5b22 6672 6571 225d  q = para["freq"]
-00017b60: 0a20 2020 2064 7420 3d20 7061 7261 5b22  .    dt = para["
-00017b70: 6474 225d 0a20 2020 2066 6d69 6e20 3d20  dt"].    fmin = 
-00017b80: 6e70 2e6d 696e 2866 7265 7129 0a20 2020  np.min(freq).   
-00017b90: 2066 6d61 7820 3d20 6e70 2e6d 6178 2866   fmax = np.max(f
-00017ba0: 7265 7129 0a0a 2020 2020 2320 6170 706c  req)..    # appl
-00017bb0: 7920 6377 7420 6f6e 2074 776f 2074 7261  y cwt on two tra
-00017bc0: 6365 730a 2020 2020 6377 7431 2c20 736a  ces.    cwt1, sj
-00017bd0: 2c20 6672 6571 2c20 636f 692c 205f 2c20  , freq, coi, _, 
-00017be0: 5f20 3d20 7079 6377 742e 6377 7428 6375  _ = pycwt.cwt(cu
-00017bf0: 722c 2064 742c 2064 6a2c 2073 302c 204a  r, dt, dj, s0, J
-00017c00: 2c20 7776 6e29 0a20 2020 2063 7774 322c  , wvn).    cwt2,
-00017c10: 2073 6a2c 2066 7265 712c 2063 6f69 2c20   sj, freq, coi, 
-00017c20: 5f2c 205f 203d 2070 7963 7774 2e63 7774  _, _ = pycwt.cwt
-00017c30: 2872 6566 2c20 6474 2c20 646a 2c20 7330  (ref, dt, dj, s0
-00017c40: 2c20 4a2c 2077 766e 290a 0a20 2020 2023  , J, wvn)..    #
-00017c50: 2065 7874 7261 6374 2072 6561 6c20 7661   extract real va
-00017c60: 6c75 6573 206f 6620 6377 740a 2020 2020  lues of cwt.    
-00017c70: 7263 7774 312c 2072 6377 7432 203d 206e  rcwt1, rcwt2 = n
-00017c80: 702e 7265 616c 2863 7774 3129 2c20 6e70  p.real(cwt1), np
-00017c90: 2e72 6561 6c28 6377 7432 290a 0a20 2020  .real(cwt2)..   
-00017ca0: 2023 207a 6572 6f20 6f75 7420 636f 6e65   # zero out cone
-00017cb0: 206f 6620 696e 666c 7565 6e63 6520 616e   of influence an
-00017cc0: 6420 6461 7461 206f 7574 7369 6465 2066  d data outside f
-00017cd0: 7265 7175 656e 6379 2062 616e 640a 2020  requency band.  
-00017ce0: 2020 6966 2028 666d 6178 203e 206e 702e    if (fmax > np.
-00017cf0: 6d61 7828 6672 6571 2929 207c 2028 666d  max(freq)) | (fm
-00017d00: 6178 203c 3d20 666d 696e 293a 0a20 2020  ax <= fmin):.   
-00017d10: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00017d20: 4572 726f 7228 2241 626f 7274 3a20 696e  Error("Abort: in
-00017d30: 7075 7420 6672 6571 7565 6e63 7920 6f75  put frequency ou
-00017d40: 7420 6f66 206c 696d 6974 7321 2229 0a20  t of limits!"). 
-00017d50: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00017d60: 2066 7265 715f 696e 6469 6e20 3d20 6e70   freq_indin = np
-00017d70: 2e77 6865 7265 2828 6672 6571 203e 3d20  .where((freq >= 
-00017d80: 666d 696e 2920 2620 2866 7265 7120 3c3d  fmin) & (freq <=
-00017d90: 2066 6d61 7829 295b 305d 0a0a 2020 2020   fmax))[0]..    
-00017da0: 2020 2020 2320 5573 6520 4454 5720 6d65      # Use DTW me
-00017db0: 7468 6f64 2074 6f20 6578 7472 6163 7420  thod to extract 
-00017dc0: 6476 760a 2020 2020 2020 2020 6e66 7265  dvv.        nfre
-00017dd0: 7120 3d20 6c65 6e28 6672 6571 5f69 6e64  q = len(freq_ind
-00017de0: 696e 290a 2020 2020 2020 2020 6476 762c  in).        dvv,
-00017df0: 2065 7272 203d 206e 702e 7a65 726f 7328   err = np.zeros(
-00017e00: 6e66 7265 712c 2064 7479 7065 3d6e 702e  nfreq, dtype=np.
-00017e10: 666c 6f61 7433 3229 2c20 6e70 2e7a 6572  float32), np.zer
-00017e20: 6f73 286e 6672 6571 2c20 6474 7970 653d  os(nfreq, dtype=
-00017e30: 6e70 2e66 6c6f 6174 3332 290a 0a20 2020  np.float32)..   
-00017e40: 2020 2020 2066 6f72 2069 692c 2069 6672       for ii, ifr
-00017e50: 6571 2069 6e20 656e 756d 6572 6174 6528  eq in enumerate(
-00017e60: 6672 6571 5f69 6e64 696e 293a 0a20 2020  freq_indin):.   
-00017e70: 2020 2020 2020 2020 2023 2070 7265 7061           # prepa
-00017e80: 7265 2077 696e 646f 7765 6420 6461 7461  re windowed data
-00017e90: 0a20 2020 2020 2020 2020 2020 2077 6377  .            wcw
-00017ea0: 7431 2c20 7763 7774 3220 3d20 7263 7774  t1, wcwt2 = rcwt
-00017eb0: 315b 6966 7265 715d 2c20 7263 7774 325b  1[ifreq], rcwt2[
-00017ec0: 6966 7265 715d 0a20 2020 2020 2020 2020  ifreq].         
-00017ed0: 2020 2023 204e 6f72 6d61 6c69 7a65 7320     # Normalizes 
-00017ee0: 626f 7468 2073 6967 6e61 6c73 2c20 6966  both signals, if
-00017ef0: 2061 7070 726f 7072 6961 7465 2e0a 2020   appropriate..  
-00017f00: 2020 2020 2020 2020 2020 6966 206e 6f72            if nor
-00017f10: 6d61 6c69 7a65 3a0a 2020 2020 2020 2020  malize:.        
-00017f20: 2020 2020 2020 2020 6e63 7774 3120 3d20          ncwt1 = 
-00017f30: 2877 6377 7431 202d 2077 6377 7431 2e6d  (wcwt1 - wcwt1.m
-00017f40: 6561 6e28 2929 202f 2077 6377 7431 2e73  ean()) / wcwt1.s
-00017f50: 7464 2829 0a20 2020 2020 2020 2020 2020  td().           
-00017f60: 2020 2020 206e 6377 7432 203d 2028 7763       ncwt2 = (wc
-00017f70: 7774 3220 2d20 7763 7774 322e 6d65 616e  wt2 - wcwt2.mean
-00017f80: 2829 2920 2f20 7763 7774 322e 7374 6428  ()) / wcwt2.std(
-00017f90: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00017fa0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00017fb0: 2020 2020 6e63 7774 3120 3d20 7763 7774      ncwt1 = wcwt
-00017fc0: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-00017fd0: 2020 6e63 7774 3220 3d20 7763 7774 320a    ncwt2 = wcwt2.
-00017fe0: 0a20 2020 2020 2020 2020 2020 2023 2072  .            # r
-00017ff0: 756e 2064 7477 0a20 2020 2020 2020 2020  un dtw.         
-00018000: 2020 2064 762c 2065 7272 6f72 2c20 6469     dv, error, di
-00018010: 7374 203d 2064 7477 5f64 7676 286e 6377  st = dtw_dvv(ncw
-00018020: 7432 2c20 6e63 7774 312c 2070 6172 612c  t2, ncwt1, para,
-00018030: 206d 6178 4c61 672c 2062 2c20 6469 7265   maxLag, b, dire
-00018040: 6374 696f 6e29 0a20 2020 2020 2020 2020  ction).         
-00018050: 2020 2064 7676 5b69 695d 2c20 6572 725b     dvv[ii], err[
-00018060: 6969 5d20 3d20 6476 2c20 6572 726f 720a  ii] = dv, error.
-00018070: 0a20 2020 2064 656c 2063 7774 312c 2063  .    del cwt1, c
-00018080: 7774 322c 2072 6377 7431 2c20 7263 7774  wt2, rcwt1, rcwt
-00018090: 322c 206e 6377 7431 2c20 6e63 7774 322c  2, ncwt1, ncwt2,
-000180a0: 2077 6377 7431 2c20 7763 7774 322c 2063   wcwt1, wcwt2, c
-000180b0: 6f69 2c20 736a 2c20 6469 7374 0a0a 2020  oi, sj, dist..  
-000180c0: 2020 6966 206e 6f74 2061 6c6c 6672 6571    if not allfreq
-000180d0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-000180e0: 206e 702e 6d65 616e 2864 7676 292c 206e   np.mean(dvv), n
-000180f0: 702e 6d65 616e 2865 7272 290a 2020 2020  p.mean(err).    
-00018100: 656c 7365 3a0a 2020 2020 2020 2020 7265  else:.        re
-00018110: 7475 726e 2066 7265 715b 6672 6571 5f69  turn freq[freq_i
-00018120: 6e64 696e 5d2c 2064 7676 2c20 6572 720a  ndin], dvv, err.
-00018130: 0a0a 2323 2323 2323 2323 2323 2323 2323  ..##############
-00018140: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00018150: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00018160: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00018170: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00018180: 204d 4f4e 4954 4f52 494e 4720 5554 494c   MONITORING UTIL
-00018190: 4954 5920 4655 4e43 5449 4f4e 5320 2323  ITY FUNCTIONS ##
-000181a0: 2323 2323 2323 2323 2323 2323 230a 2323  #############.##
-000181b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000181c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000181d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000181e0: 2323 2323 2323 2323 2323 230a 0a22 2222  ###########.."""
-000181f0: 0a62 656c 6f77 2061 7265 2061 7373 656d  .below are assem
-00018200: 626c 7920 6f66 2074 6865 206d 6f6e 6974  bly of the monit
-00018210: 6f72 696e 6720 7574 696c 6974 7920 6675  oring utility fu
-00018220: 6e63 7469 6f6e 7320 6361 6c6c 6564 2062  nctions called b
-00018230: 7920 6d6f 6e69 746f 7269 6e67 2066 756e  y monitoring fun
-00018240: 6374 696f 6e73 0a22 2222 0a0a 0a64 6566  ctions."""...def
-00018250: 2073 6d6f 6f74 6828 782c 2077 696e 646f   smooth(x, windo
-00018260: 773d 2262 6f78 6361 7222 2c20 6861 6c66  w="boxcar", half
-00018270: 5f77 696e 3d33 293a 0a20 2020 2022 2222  _win=3):.    """
-00018280: 0a20 2020 2070 6572 666f 726d 7320 736d  .    performs sm
-00018290: 6f6f 7468 696e 6720 696e 2069 6e74 6572  oothing in inter
-000182a0: 6573 7465 6420 7469 6d65 2077 696e 646f  ested time windo
-000182b0: 770a 0a20 2020 2050 6172 616d 6574 6572  w..    Parameter
-000182c0: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
-000182d0: 2d2d 2d2d 0a20 2020 2078 3a20 7469 6d65  ----.    x: time
-000182e0: 7365 7269 7320 6461 7461 0a20 2020 2077  seris data.    w
-000182f0: 696e 646f 773a 2074 7970 6573 206f 6620  indow: types of 
-00018300: 7769 6e64 6f77 2074 6f20 646f 2073 6d6f  window to do smo
-00018310: 6f74 6869 6e67 0a20 2020 2068 616c 665f  othing.    half_
-00018320: 7769 6e3a 2068 616c 6620 7769 6e64 6f77  win: half window
-00018330: 206c 656e 6774 680a 0a20 2020 2052 4554   length..    RET
-00018340: 5552 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d  URNS:.    ------
-00018350: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
-00018360: 2079 3a20 736d 6f6f 7468 6564 2074 696d   y: smoothed tim
-00018370: 6520 7769 6e64 6f77 0a20 2020 2022 2222  e window.    """
-00018380: 0a20 2020 2023 2054 4f44 4f3a 2064 6f63  .    # TODO: doc
-00018390: 7374 696e 670a 2020 2020 7769 6e64 6f77  sting.    window
-000183a0: 5f6c 656e 203d 2032 202a 2068 616c 665f  _len = 2 * half_
-000183b0: 7769 6e20 2b20 310a 2020 2020 2320 6578  win + 1.    # ex
-000183c0: 7465 6e64 696e 6720 7468 6520 6461 7461  tending the data
-000183d0: 2061 7420 6265 6769 6e6e 696e 6720 616e   at beginning an
-000183e0: 6420 6174 2074 6865 2065 6e64 0a20 2020  d at the end.   
-000183f0: 2023 2074 6f20 6170 706c 7920 7468 6520   # to apply the 
-00018400: 7769 6e64 6f77 2061 7420 7468 6520 626f  window at the bo
-00018410: 7264 6572 730a 2020 2020 7320 3d20 6e70  rders.    s = np
-00018420: 2e72 5f5b 785b 7769 6e64 6f77 5f6c 656e  .r_[x[window_len
-00018430: 202d 2031 203a 2030 203a 202d 315d 2c20   - 1 : 0 : -1], 
-00018440: 782c 2078 5b2d 313a 2d77 696e 646f 775f  x, x[-1:-window_
-00018450: 6c65 6e3a 2d31 5d5d 0a20 2020 2069 6620  len:-1]].    if 
-00018460: 7769 6e64 6f77 203d 3d20 2262 6f78 6361  window == "boxca
-00018470: 7222 3a0a 2020 2020 2020 2020 7720 3d20  r":.        w = 
-00018480: 7363 6970 792e 7369 676e 616c 2e62 6f78  scipy.signal.box
-00018490: 6361 7228 7769 6e64 6f77 5f6c 656e 292e  car(window_len).
-000184a0: 6173 7479 7065 2822 636f 6d70 6c65 7822  astype("complex"
-000184b0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
-000184c0: 2020 2020 7720 3d20 7363 6970 792e 7369      w = scipy.si
-000184d0: 676e 616c 2e68 616e 6e69 6e67 2877 696e  gnal.hanning(win
-000184e0: 646f 775f 6c65 6e29 2e61 7374 7970 6528  dow_len).astype(
-000184f0: 2263 6f6d 706c 6578 2229 0a20 2020 2079  "complex").    y
-00018500: 203d 206e 702e 636f 6e76 6f6c 7665 2877   = np.convolve(w
-00018510: 202f 2077 2e73 756d 2829 2c20 732c 206d   / w.sum(), s, m
-00018520: 6f64 653d 2276 616c 6964 2229 0a20 2020  ode="valid").   
-00018530: 2072 6574 7572 6e20 795b 6861 6c66 5f77   return y[half_w
-00018540: 696e 203a 206c 656e 2879 2920 2d20 6861  in : len(y) - ha
-00018550: 6c66 5f77 696e 5d0a 0a0a 6465 6620 6e65  lf_win]...def ne
-00018560: 7874 706f 7732 2878 293a 0a20 2020 2022  xtpow2(x):.    "
-00018570: 2222 0a20 2020 2052 6574 7572 6e73 2074  "".    Returns t
-00018580: 6865 206e 6578 7420 706f 7765 7220 6f66  he next power of
-00018590: 2032 206f 6620 782e 0a20 2020 2022 2222   2 of x..    """
-000185a0: 0a20 2020 2072 6574 7572 6e20 696e 7428  .    return int(
-000185b0: 6e70 2e63 6569 6c28 6e70 2e6c 6f67 3228  np.ceil(np.log2(
-000185c0: 6e70 2e61 6273 2878 2929 2929 0a0a 0a64  np.abs(x))))...d
-000185d0: 6566 2067 6574 436f 6865 7265 6e63 6528  ef getCoherence(
-000185e0: 6463 732c 2064 7331 2c20 6473 3229 3a0a  dcs, ds1, ds2):.
-000185f0: 2020 2020 2222 220a 2020 2020 6765 7420      """.    get 
-00018600: 6372 6f73 7320 636f 6865 7265 6e63 6520  cross coherence 
-00018610: 6265 7477 6565 6e20 7265 6665 7265 6e63  between referenc
-00018620: 6520 616e 6420 6375 7272 656e 7420 7761  e and current wa
-00018630: 7665 666f 726d 7320 666f 6c6c 6f77 696e  veforms followin
-00018640: 6720 6571 7561 7469 6f6e 206f 6620 4133  g equation of A3
-00018650: 2069 6e20 436c 6172 6b20 6574 2061 6c2e   in Clark et al.
-00018660: 2c20 3230 3131 0a0a 2020 2020 5061 7261  , 2011..    Para
-00018670: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-00018680: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6463  ---------.    dc
-00018690: 733a 2061 6d70 6c69 7475 6465 206f 6620  s: amplitude of 
-000186a0: 7468 6520 6372 6f73 7320 7370 6563 7472  the cross spectr
-000186b0: 756d 0a20 2020 2064 7331 3a20 616d 706c  um.    ds1: ampl
-000186c0: 6974 7564 6520 6f66 2074 6865 2073 7065  itude of the spe
-000186d0: 6374 7275 6d20 6f66 2063 7572 7265 6e74  ctrum of current
-000186e0: 2077 6176 6566 6f72 6d0a 2020 2020 6473   waveform.    ds
-000186f0: 323a 2061 6d70 6c69 7475 6465 206f 6620  2: amplitude of 
-00018700: 7468 6520 7370 6563 7472 756d 206f 6620  the spectrum of 
-00018710: 7265 6665 7265 6e63 6520 7761 7665 666f  reference wavefo
-00018720: 726d 0a0a 2020 2020 5245 5455 524e 533a  rm..    RETURNS:
-00018730: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
-00018740: 2d2d 2d2d 2d2d 2d0a 2020 2020 636f 683a  -------.    coh:
-00018750: 2063 6f68 7265 7265 6e63 7920 6d61 7472   cohrerency matr
-00018760: 6978 2075 7365 6420 666f 7220 6573 7469  ix used for esti
-00018770: 6d61 7465 2074 6865 2072 6f62 7573 746e  mate the robustn
-00018780: 6573 7320 6f66 2074 6865 2063 726f 7373  ess of the cross
-00018790: 2073 7065 6374 7275 6d0a 2020 2020 2222   spectrum.    ""
-000187a0: 220a 2020 2020 6e20 3d20 6c65 6e28 6463  ".    n = len(dc
-000187b0: 7329 0a20 2020 2063 6f68 203d 206e 702e  s).    coh = np.
-000187c0: 7a65 726f 7328 6e29 2e61 7374 7970 6528  zeros(n).astype(
-000187d0: 2263 6f6d 706c 6578 2229 0a20 2020 2076  "complex").    v
-000187e0: 616c 6964 7320 3d20 6e70 2e61 7267 7768  alids = np.argwh
-000187f0: 6572 6528 6e70 2e6c 6f67 6963 616c 5f61  ere(np.logical_a
-00018800: 6e64 286e 702e 6162 7328 6473 3129 203e  nd(np.abs(ds1) >
-00018810: 2030 2c20 6e70 2e61 6273 2864 7332 2920   0, np.abs(ds2) 
-00018820: 3e20 3029 290a 2020 2020 636f 685b 7661  > 0)).    coh[va
-00018830: 6c69 6473 5d20 3d20 6463 735b 7661 6c69  lids] = dcs[vali
-00018840: 6473 5d20 2f20 2864 7331 5b76 616c 6964  ds] / (ds1[valid
-00018850: 735d 202a 2064 7332 5b76 616c 6964 735d  s] * ds2[valids]
-00018860: 290a 2020 2020 636f 685b 636f 6820 3e20  ).    coh[coh > 
-00018870: 2831 2e30 202b 2030 6a29 5d20 3d20 312e  (1.0 + 0j)] = 1.
-00018880: 3020 2b20 306a 0a20 2020 2072 6574 7572  0 + 0j.    retur
-00018890: 6e20 636f 680a 0a0a 6465 6620 636f 6d70  n coh...def comp
-000188a0: 7574 6545 7272 6f72 4675 6e63 7469 6f6e  uteErrorFunction
-000188b0: 2875 312c 2075 302c 206e 5361 6d70 6c65  (u1, u0, nSample
-000188c0: 2c20 6c61 672c 206e 6f72 6d3d 224c 3222  , lag, norm="L2"
-000188d0: 293a 0a20 2020 2022 2222 0a20 2020 2063  ):.    """.    c
-000188e0: 6f6d 7075 7465 2045 7272 6f72 2046 756e  ompute Error Fun
-000188f0: 6374 696f 6e20 7573 6564 2069 6e20 4454  ction used in DT
-00018900: 572e 2054 6865 2065 7272 6f72 2066 756e  W. The error fun
-00018910: 6374 696f 6e20 6973 2065 7175 6174 696f  ction is equatio
-00018920: 6e20 3120 696e 2048 616c 652c 2032 3031  n 1 in Hale, 201
-00018930: 332e 2059 6f75 2063 6f75 6c64 2075 6e63  3. You could unc
-00018940: 6f6d 6d65 6e74 2074 6865 0a20 2020 204c  omment the.    L
-00018950: 3120 6e6f 726d 2061 6e64 2063 6f6d 6d65  1 norm and comme
-00018960: 6e74 2074 6865 204c 3220 6e6f 726d 2069  nt the L2 norm i
-00018970: 6620 796f 7520 7761 6e74 206f 6e20 4c69  f you want on Li
-00018980: 6e65 2032 390a 0a20 2020 2050 6172 616d  ne 29..    Param
-00018990: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
-000189a0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2075 313a  --------.    u1:
-000189b0: 2020 7472 6163 6520 7468 6174 2077 6520    trace that we 
-000189c0: 7761 6e74 2074 6f20 7761 7270 3b20 7369  want to warp; si
-000189d0: 7a65 203d 2028 6e73 616d 702c 3129 0a20  ze = (nsamp,1). 
-000189e0: 2020 2075 303a 2020 7265 6665 7265 6e63     u0:  referenc
-000189f0: 6520 7472 6163 6520 746f 2063 6f6d 7061  e trace to compa
-00018a00: 7265 2077 6974 683a 2073 697a 6520 3d20  re with: size = 
-00018a10: 286e 7361 6d70 2c31 290a 2020 2020 6e53  (nsamp,1).    nS
-00018a20: 616d 706c 653a 206e 756d 6572 206f 6620  ample: numer of 
-00018a30: 706f 696e 7473 2074 6f20 636f 6d70 6172  points to compar
-00018a40: 6520 696e 2074 6865 2074 7261 6365 730a  e in the traces.
-00018a50: 2020 2020 6c61 673a 206d 6178 696d 756d      lag: maximum
-00018a60: 206c 6167 2069 6e20 7361 6d70 6c65 206e   lag in sample n
-00018a70: 756d 6265 7220 746f 2073 6561 7263 680a  umber to search.
-00018a80: 2020 2020 6e6f 726d 3a20 274c 3227 206f      norm: 'L2' o
-00018a90: 7220 274c 3127 2028 6465 6661 756c 7420  r 'L1' (default 
-00018aa0: 6973 2027 4c32 2729 0a0a 2020 2020 5245  is 'L2')..    RE
-00018ab0: 5455 524e 533a 0a20 2020 202d 2d2d 2d2d  TURNS:.    -----
-00018ac0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
-00018ad0: 2020 6572 723a 2074 6865 2032 4420 6572    err: the 2D er
-00018ae0: 726f 7220 6675 6e63 7469 6f6e 3b20 7369  ror function; si
-00018af0: 7a65 203d 2028 6e73 616d 702c 322a 6c61  ze = (nsamp,2*la
-00018b00: 672b 3129 0a0a 2020 2020 4f72 6967 696e  g+1)..    Origin
-00018b10: 616c 2062 7920 4469 2059 616e 670a 2020  al by Di Yang.  
-00018b20: 2020 4c61 7374 206d 6f64 6966 6965 6420    Last modified 
-00018b30: 6279 2044 796c 616e 204d 696b 6573 656c  by Dylan Mikesel
-00018b40: 6c20 2832 3520 4665 622e 2032 3031 3529  l (25 Feb. 2015)
-00018b50: 0a20 2020 2054 7261 6e73 6c61 7465 6420  .    Translated 
-00018b60: 746f 2070 7974 686f 6e20 6279 2054 696d  to python by Tim
-00018b70: 2043 6c65 6d65 6e74 7320 2831 3720 4175   Clements (17 Au
-00018b80: 672e 2032 3031 3829 0a0a 2020 2020 2222  g. 2018)..    ""
-00018b90: 220a 0a20 2020 2069 6620 6c61 6720 3e3d  "..    if lag >=
-00018ba0: 206e 5361 6d70 6c65 3a0a 2020 2020 2020   nSample:.      
-00018bb0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-00018bc0: 6f72 2822 636f 6d70 7574 6545 7272 6f72  or("computeError
-00018bd0: 4675 6e63 7469 6f6e 3a6c 6167 5072 6f62  Function:lagProb
-00018be0: 6c65 6d22 2c20 226c 6167 206d 7573 7420  lem", "lag must 
-00018bf0: 6265 2073 6d61 6c6c 6572 2074 6861 6e20  be smaller than 
-00018c00: 6e53 616d 706c 6522 290a 0a20 2020 2023  nSample")..    #
-00018c10: 2041 6c6c 6f63 6174 6520 6572 726f 7220   Allocate error 
-00018c20: 6675 6e63 7469 6f6e 2076 6172 6961 626c  function variabl
-00018c30: 650a 2020 2020 6572 7220 3d20 6e70 2e7a  e.    err = np.z
-00018c40: 6572 6f73 285b 6e53 616d 706c 652c 2032  eros([nSample, 2
-00018c50: 202a 206c 6167 202b 2031 5d29 0a0a 2020   * lag + 1])..  
-00018c60: 2020 2320 696e 6974 6961 6c20 6572 726f    # initial erro
-00018c70: 7220 6361 6c63 756c 6174 696f 6e0a 2020  r calculation.  
-00018c80: 2020 2320 6c6f 6f70 206f 7665 7220 6c61    # loop over la
-00018c90: 6773 0a20 2020 2066 6f72 206c 6c20 696e  gs.    for ll in
-00018ca0: 206e 702e 6172 616e 6765 282d 6c61 672c   np.arange(-lag,
-00018cb0: 206c 6167 202b 2031 293a 0a20 2020 2020   lag + 1):.     
-00018cc0: 2020 2074 6869 734c 6167 203d 206c 6c20     thisLag = ll 
-00018cd0: 2b20 6c61 670a 0a20 2020 2020 2020 2023  + lag..        #
-00018ce0: 206c 6f6f 7020 6f76 6572 2073 616d 706c   loop over sampl
-00018cf0: 6573 0a20 2020 2020 2020 2066 6f72 2069  es.        for i
-00018d00: 6920 696e 2072 616e 6765 286e 5361 6d70  i in range(nSamp
-00018d10: 6c65 293a 0a20 2020 2020 2020 2020 2020  le):.           
-00018d20: 2023 2073 6b69 7020 636f 726e 6572 7320   # skip corners 
-00018d30: 666f 7220 6e6f 772c 2077 6520 7769 6c6c  for now, we will
-00018d40: 2063 6f6d 6520 6261 636b 2074 6f20 7468   come back to th
-00018d50: 6573 650a 2020 2020 2020 2020 2020 2020  ese.            
-00018d60: 6966 2028 6969 202b 206c 6c20 3e3d 2030  if (ii + ll >= 0
-00018d70: 2920 2620 2869 6920 2b20 6c6c 203c 206e  ) & (ii + ll < n
-00018d80: 5361 6d70 6c65 293a 0a20 2020 2020 2020  Sample):.       
-00018d90: 2020 2020 2020 2020 2065 7272 5b69 692c           err[ii,
-00018da0: 2074 6869 734c 6167 5d20 3d20 7531 5b69   thisLag] = u1[i
-00018db0: 695d 202d 2075 305b 6969 202b 206c 6c5d  i] - u0[ii + ll]
-00018dc0: 0a0a 2020 2020 6966 206e 6f72 6d20 3d3d  ..    if norm ==
-00018dd0: 2022 4c32 223a 0a20 2020 2020 2020 2065   "L2":.        e
-00018de0: 7272 203d 2065 7272 2a2a 320a 2020 2020  rr = err**2.    
-00018df0: 656c 6966 206e 6f72 6d20 3d3d 2022 4c31  elif norm == "L1
-00018e00: 223a 0a20 2020 2020 2020 2065 7272 203d  ":.        err =
-00018e10: 206e 702e 6162 7328 6572 7229 0a0a 2020   np.abs(err)..  
-00018e20: 2020 2320 4e6f 7720 6669 7820 636f 726e    # Now fix corn
-00018e30: 6572 7320 7769 7468 2063 6f6e 7374 616e  ers with constan
-00018e40: 7420 6578 7472 6170 6f6c 6174 696f 6e0a  t extrapolation.
-00018e50: 2020 2020 666f 7220 6c6c 2069 6e20 6e70      for ll in np
-00018e60: 2e61 7261 6e67 6528 2d6c 6167 2c20 6c61  .arange(-lag, la
-00018e70: 6720 2b20 3129 3a0a 2020 2020 2020 2020  g + 1):.        
-00018e80: 7468 6973 4c61 6720 3d20 6c6c 202b 206c  thisLag = ll + l
-00018e90: 6167 0a0a 2020 2020 2020 2020 666f 7220  ag..        for 
-00018ea0: 6969 2069 6e20 7261 6e67 6528 6e53 616d  ii in range(nSam
-00018eb0: 706c 6529 3a0a 2020 2020 2020 2020 2020  ple):.          
-00018ec0: 2020 6966 2069 6920 2b20 6c6c 203c 2030    if ii + ll < 0
-00018ed0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018ee0: 2020 6572 725b 6969 2c20 7468 6973 4c61    err[ii, thisLa
-00018ef0: 675d 203d 2065 7272 5b2d 6c6c 2c20 7468  g] = err[-ll, th
-00018f00: 6973 4c61 675d 0a0a 2020 2020 2020 2020  isLag]..        
-00018f10: 2020 2020 656c 6966 2069 6920 2b20 6c6c      elif ii + ll
-00018f20: 203e 206e 5361 6d70 6c65 202d 2031 3a0a   > nSample - 1:.
-00018f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f40: 6572 725b 6969 2c20 7468 6973 4c61 675d  err[ii, thisLag]
-00018f50: 203d 2065 7272 5b6e 5361 6d70 6c65 202d   = err[nSample -
-00018f60: 206c 6c20 2d20 312c 2074 6869 734c 6167   ll - 1, thisLag
-00018f70: 5d0a 0a20 2020 2072 6574 7572 6e20 6572  ]..    return er
-00018f80: 720a 0a0a 6465 6620 6163 6375 6d75 6c61  r...def accumula
-00018f90: 7465 4572 726f 7246 756e 6374 696f 6e28  teErrorFunction(
-00018fa0: 6469 722c 2065 7272 2c20 6e53 616d 706c  dir, err, nSampl
-00018fb0: 652c 206c 6167 2c20 6229 3a0a 2020 2020  e, lag, b):.    
-00018fc0: 2222 220a 2020 2020 6163 6375 6d75 6c61  """.    accumula
-00018fd0: 7469 6f6e 206f 6620 7468 6520 6572 726f  tion of the erro
-00018fe0: 722c 2077 6869 6368 2066 6f6c 6c6f 7773  r, which follows
-00018ff0: 2074 6865 2065 7175 6174 696f 6e20 3620   the equation 6 
-00019000: 696e 2048 616c 652c 2032 3031 332e 0a0a  in Hale, 2013...
-00019010: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-00019020: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
-00019030: 2d0a 2020 2020 6469 723a 2061 6363 756d  -.    dir: accum
-00019040: 756c 6174 696f 6e20 6469 7265 6374 696f  ulation directio
-00019050: 6e20 2820 6469 7220 3e20 3020 3d20 666f  n ( dir > 0 = fo
-00019060: 7277 6172 6420 696e 2074 696d 652c 2064  rward in time, d
-00019070: 6972 203c 3d20 3020 3d20 6261 636b 7761  ir <= 0 = backwa
-00019080: 7264 2069 6e20 7469 6d65 290a 2020 2020  rd in time).    
-00019090: 6572 723a 2074 6865 2032 4420 6572 726f  err: the 2D erro
-000190a0: 7220 6675 6e63 7469 6f6e 3b20 7369 7a65  r function; size
-000190b0: 203d 2028 6e73 616d 702c 322a 6c61 672b   = (nsamp,2*lag+
-000190c0: 3129 0a20 2020 206e 5361 6d70 6c65 3a20  1).    nSample: 
-000190d0: 6e75 6d65 7220 6f66 2070 6f69 6e74 7320  numer of points 
-000190e0: 746f 2063 6f6d 7061 7265 2069 6e20 7468  to compare in th
-000190f0: 6520 7472 6163 6573 0a20 2020 206c 6167  e traces.    lag
-00019100: 3a20 6d61 7869 6d75 6d20 6c61 6720 696e  : maximum lag in
-00019110: 2073 616d 706c 6520 6e75 6d62 6572 2074   sample number t
-00019120: 6f20 7365 6172 6368 0a20 2020 2062 3a20  o search.    b: 
-00019130: 7374 7261 696e 206c 696d 6974 2028 696e  strain limit (in
-00019140: 7465 6765 7220 7661 6c75 6520 3e3d 2031  teger value >= 1
-00019150: 290a 0a20 2020 2052 4554 5552 4e53 3a0a  )..    RETURNS:.
-00019160: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
-00019170: 2d2d 2d2d 2d2d 0a20 2020 2064 3a20 7468  ------.    d: th
-00019180: 6520 3244 2064 6973 7461 6e63 6520 6675  e 2D distance fu
-00019190: 6e63 7469 6f6e 3b20 7369 7a65 203d 2028  nction; size = (
-000191a0: 6e73 616d 702c 322a 6c61 672b 3129 0a0a  nsamp,2*lag+1)..
-000191b0: 2020 2020 4f72 6967 696e 616c 2062 7920      Original by 
-000191c0: 4469 2059 616e 670a 2020 2020 4c61 7374  Di Yang.    Last
-000191d0: 206d 6f64 6966 6965 6420 6279 2044 796c   modified by Dyl
-000191e0: 616e 204d 696b 6573 656c 6c20 2832 3520  an Mikesell (25 
-000191f0: 4665 622e 2032 3031 3529 0a20 2020 2054  Feb. 2015).    T
-00019200: 7261 6e73 6c61 7465 6420 746f 2070 7974  ranslated to pyt
-00019210: 686f 6e20 6279 2054 696d 2043 6c65 6d65  hon by Tim Cleme
-00019220: 6e74 7320 2831 3720 4175 672e 2032 3031  nts (17 Aug. 201
-00019230: 3829 0a0a 2020 2020 2222 220a 0a20 2020  8)..    """..   
-00019240: 2023 206e 756d 6265 7220 6f66 206c 6167   # number of lag
-00019250: 7320 6672 6f6d 205b 202d 6c61 6720 3a20  s from [ -lag : 
-00019260: 2b6c 6167 205d 0a20 2020 206e 4c61 6720  +lag ].    nLag 
-00019270: 3d20 2832 202a 206c 6167 2920 2b20 310a  = (2 * lag) + 1.
-00019280: 0a20 2020 2023 2061 6c6c 6f63 6174 6520  .    # allocate 
-00019290: 6469 7374 616e 6365 206d 6174 7269 780a  distance matrix.
-000192a0: 2020 2020 6420 3d20 6e70 2e7a 6572 6f73      d = np.zeros
-000192b0: 285b 6e53 616d 706c 652c 206e 4c61 675d  ([nSample, nLag]
-000192c0: 290a 0a20 2020 2023 2053 6574 7570 2069  )..    # Setup i
-000192d0: 6e64 6963 6573 2062 6173 6564 206f 6e20  ndices based on 
-000192e0: 666f 7277 6172 6420 6f72 2062 6163 6b77  forward or backw
-000192f0: 6172 6420 6163 6375 6d75 6c61 7469 6f6e  ard accumulation
-00019300: 2064 6972 6563 7469 6f6e 0a20 2020 2069   direction.    i
-00019310: 6620 6469 7220 3e20 303a 2020 2320 464f  f dir > 0:  # FO
-00019320: 5257 4152 440a 2020 2020 2020 2020 6942  RWARD.        iB
-00019330: 6567 696e 2c20 6945 6e64 2c20 6949 6e63  egin, iEnd, iInc
-00019340: 203d 2030 2c20 6e53 616d 706c 6520 2d20   = 0, nSample - 
-00019350: 312c 2031 0a20 2020 2065 6c73 653a 2020  1, 1.    else:  
-00019360: 2320 4241 434b 5741 5244 0a20 2020 2020  # BACKWARD.     
-00019370: 2020 2069 4265 6769 6e2c 2069 456e 642c     iBegin, iEnd,
-00019380: 2069 496e 6320 3d20 6e53 616d 706c 6520   iInc = nSample 
-00019390: 2d20 312c 2030 2c20 2d31 0a0a 2020 2020  - 1, 0, -1..    
-000193a0: 2320 4c6f 6f70 2074 6872 6f75 6768 2061  # Loop through a
-000193b0: 6c6c 2074 696d 6573 2069 6920 696e 2066  ll times ii in f
-000193c0: 6f72 7761 7264 206f 7220 6261 636b 7761  orward or backwa
-000193d0: 7264 2064 6972 6563 7469 6f6e 0a20 2020  rd direction.   
-000193e0: 2066 6f72 2069 6920 696e 2072 616e 6765   for ii in range
-000193f0: 2869 4265 6769 6e2c 2069 456e 6420 2b20  (iBegin, iEnd + 
-00019400: 6949 6e63 2c20 6949 6e63 293a 0a20 2020  iInc, iInc):.   
-00019410: 2020 2020 2023 206d 696e 2f6d 6178 2074       # min/max t
-00019420: 6f20 6163 636f 756e 7420 666f 7220 7468  o account for th
-00019430: 6520 6564 6765 732f 626f 756e 6461 7269  e edges/boundari
-00019440: 6573 0a20 2020 2020 2020 206a 6920 3d20  es.        ji = 
-00019450: 6d61 7828 5b30 2c20 6d69 6e28 5b6e 5361  max([0, min([nSa
-00019460: 6d70 6c65 202d 2031 2c20 6969 202d 2069  mple - 1, ii - i
-00019470: 496e 635d 295d 290a 2020 2020 2020 2020  Inc])]).        
-00019480: 6a62 203d 206d 6178 285b 302c 206d 696e  jb = max([0, min
-00019490: 285b 6e53 616d 706c 6520 2d20 312c 2069  ([nSample - 1, i
-000194a0: 6920 2d20 6949 6e63 202a 2062 5d29 5d29  i - iInc * b])])
-000194b0: 0a0a 2020 2020 2020 2020 2320 6c6f 6f70  ..        # loop
-000194c0: 2074 6872 6f75 6768 2061 6c6c 206c 6167   through all lag
-000194d0: 0a20 2020 2020 2020 2066 6f72 206c 6c20  .        for ll 
-000194e0: 696e 2072 616e 6765 286e 4c61 6729 3a0a  in range(nLag):.
-000194f0: 2020 2020 2020 2020 2020 2020 2320 6368              # ch
-00019500: 6563 6b20 6c69 6d69 7473 206f 6e20 6c61  eck limits on la
-00019510: 6720 696e 6469 6365 730a 2020 2020 2020  g indices.      
-00019520: 2020 2020 2020 6c4d 696e 7573 3120 3d20        lMinus1 = 
-00019530: 6c6c 202d 2031 0a0a 2020 2020 2020 2020  ll - 1..        
-00019540: 2020 2020 2320 6368 6563 6b20 6c61 6720      # check lag 
-00019550: 696e 6465 7820 6973 2067 7265 6174 6572  index is greater
-00019560: 2074 6861 6e20 300a 2020 2020 2020 2020   than 0.        
-00019570: 2020 2020 6966 206c 4d69 6e75 7331 203c      if lMinus1 <
-00019580: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00019590: 2020 2020 6c4d 696e 7573 3120 3d20 3020      lMinus1 = 0 
-000195a0: 2023 206d 616b 6520 6c61 6720 3d20 6669   # make lag = fi
-000195b0: 7273 7420 6c61 670a 0a20 2020 2020 2020  rst lag..       
-000195c0: 2020 2020 206c 506c 7573 3120 3d20 6c6c       lPlus1 = ll
-000195d0: 202b 2031 2020 2320 6c61 6720 6174 206c   + 1  # lag at l
-000195e0: 2b31 0a0a 2020 2020 2020 2020 2020 2020  +1..            
-000195f0: 2320 6368 6563 6b20 6c61 6720 696e 6465  # check lag inde
-00019600: 7820 6c65 7373 2074 6861 6e20 6d61 7820  x less than max 
-00019610: 6c61 670a 2020 2020 2020 2020 2020 2020  lag.            
-00019620: 6966 206c 506c 7573 3120 3e20 6e4c 6167  if lPlus1 > nLag
-00019630: 202d 2031 3a0a 2020 2020 2020 2020 2020   - 1:.          
-00019640: 2020 2020 2020 6c50 6c75 7331 203d 206e        lPlus1 = n
-00019650: 4c61 6720 2d20 310a 0a20 2020 2020 2020  Lag - 1..       
-00019660: 2020 2020 2023 2067 6574 2064 6973 7461       # get dista
-00019670: 6e63 6520 6174 206c 6167 7320 286c 6c2d  nce at lags (ll-
-00019680: 312c 206c 6c2c 206c 6c2b 3129 0a20 2020  1, ll, ll+1).   
-00019690: 2020 2020 2020 2020 2064 6973 744c 6d69           distLmi
-000196a0: 6e75 7331 203d 2064 5b6a 622c 206c 4d69  nus1 = d[jb, lMi
-000196b0: 6e75 7331 5d20 2023 206d 696e 7573 3a20  nus1]  # minus: 
-000196c0: 2064 5b69 2d62 2c20 6a2d 315d 0a20 2020   d[i-b, j-1].   
-000196d0: 2020 2020 2020 2020 2064 6973 744c 203d           distL =
-000196e0: 2064 5b6a 692c 206c 6c5d 2020 2320 6163   d[ji, ll]  # ac
-000196f0: 7475 616c 2064 5b69 2d31 2c20 6a5d 0a20  tual d[i-1, j]. 
-00019700: 2020 2020 2020 2020 2020 2064 6973 744c             distL
-00019710: 706c 7573 3120 3d20 645b 6a62 2c20 6c50  plus1 = d[jb, lP
-00019720: 6c75 7331 5d20 2023 2070 6c75 7320 645b  lus1]  # plus d[
-00019730: 692d 622c 206a 2b31 5d0a 0a20 2020 2020  i-b, j+1]..     
-00019740: 2020 2020 2020 2069 6620 6a69 2021 3d20         if ji != 
-00019750: 6a62 3a20 2023 2065 7175 6174 696f 6e20  jb:  # equation 
-00019760: 3130 2069 6e20 4861 6c65 2c20 3230 3133  10 in Hale, 2013
-00019770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019780: 2066 6f72 206b 6220 696e 2072 616e 6765   for kb in range
-00019790: 286a 692c 206a 6220 2b20 6949 6e63 202d  (ji, jb + iInc -
-000197a0: 2031 2c20 2d69 496e 6329 3a0a 2020 2020   1, -iInc):.    
-000197b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000197c0: 6469 7374 4c6d 696e 7573 3120 3d20 6469  distLminus1 = di
-000197d0: 7374 4c6d 696e 7573 3120 2b20 6572 725b  stLminus1 + err[
-000197e0: 6b62 2c20 6c4d 696e 7573 315d 0a20 2020  kb, lMinus1].   
-000197f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019800: 2064 6973 744c 706c 7573 3120 3d20 6469   distLplus1 = di
-00019810: 7374 4c70 6c75 7331 202b 2065 7272 5b6b  stLplus1 + err[k
-00019820: 622c 206c 506c 7573 315d 0a0a 2020 2020  b, lPlus1]..    
-00019830: 2020 2020 2020 2020 2320 6571 7561 7469          # equati
-00019840: 6f6e 2036 2028 6966 2062 3d31 2920 6f72  on 6 (if b=1) or
-00019850: 2031 3020 2869 6620 623e 3129 2069 6e20   10 (if b>1) in 
-00019860: 4861 6c65 2028 3230 3133 2920 6166 7465  Hale (2013) afte
-00019870: 7220 7472 6561 7469 6e67 2062 6f75 6e64  r treating bound
-00019880: 6172 6965 730a 2020 2020 2020 2020 2020  aries.          
-00019890: 2020 645b 6969 2c20 6c6c 5d20 3d20 6572    d[ii, ll] = er
-000198a0: 725b 6969 2c20 6c6c 5d20 2b20 6d69 6e28  r[ii, ll] + min(
-000198b0: 5b64 6973 744c 6d69 6e75 7331 2c20 6469  [distLminus1, di
-000198c0: 7374 4c2c 2064 6973 744c 706c 7573 315d  stL, distLplus1]
-000198d0: 290a 0a20 2020 2072 6574 7572 6e20 640a  )..    return d.
-000198e0: 0a0a 6465 6620 6261 636b 7472 6163 6b44  ..def backtrackD
-000198f0: 6973 7461 6e63 6546 756e 6374 696f 6e28  istanceFunction(
-00019900: 6469 722c 2064 2c20 6572 722c 206c 6d69  dir, d, err, lmi
-00019910: 6e2c 2062 293a 0a20 2020 2022 2222 0a20  n, b):.    """. 
-00019920: 2020 2054 6865 2066 756e 6374 696f 6e20     The function 
-00019930: 6973 2065 7175 6174 696f 6e20 3220 696e  is equation 2 in
-00019940: 2048 616c 652c 2032 3031 332e 0a0a 2020   Hale, 2013...  
-00019950: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-00019960: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a   --------------.
-00019970: 2020 2020 6469 723a 2073 6964 6520 746f      dir: side to
-00019980: 2073 7461 7274 206d 696e 696d 697a 6174   start minimizat
-00019990: 696f 6e20 2820 6469 7220 3e20 3020 3d20  ion ( dir > 0 = 
-000199a0: 6672 6f6e 742c 2064 6972 203c 3d20 3020  front, dir <= 0 
-000199b0: 3d20 2062 6163 6b29 0a20 2020 2064 203a  =  back).    d :
-000199c0: 2074 6865 2032 4420 6469 7374 616e 6365   the 2D distance
-000199d0: 2066 756e 6374 696f 6e3b 2073 697a 6520   function; size 
-000199e0: 3d20 286e 7361 6d70 2c32 2a6c 6167 2b31  = (nsamp,2*lag+1
-000199f0: 290a 2020 2020 6572 723a 2074 6865 2032  ).    err: the 2
-00019a00: 4420 6572 726f 7220 6675 6e63 7469 6f6e  D error function
-00019a10: 3b20 7369 7a65 203d 2028 6e73 616d 702c  ; size = (nsamp,
-00019a20: 322a 6c61 672b 3129 0a20 2020 206c 6d69  2*lag+1).    lmi
-00019a30: 6e3a 206d 696e 696d 756d 206c 6167 2074  n: minimum lag t
-00019a40: 6f20 7365 6172 6368 206f 7665 720a 2020  o search over.  
-00019a50: 2020 6220 3a20 7374 7261 696e 206c 696d    b : strain lim
-00019a60: 6974 2028 696e 7465 6765 7220 7661 6c75  it (integer valu
-00019a70: 6520 3e3d 2031 290a 0a20 2020 2052 4554  e >= 1)..    RET
-00019a80: 5552 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d  URNS:.    ------
-00019a90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
-00019aa0: 2073 7462 6172 3a20 7665 6374 6f72 206f   stbar: vector o
-00019ab0: 6620 696e 7465 6765 7220 7368 6966 7473  f integer shifts
-00019ac0: 2073 7562 6a65 6374 2074 6f20 7c75 2869   subject to |u(i
-00019ad0: 292d 7528 692d 3129 7c20 3c3d 2031 2f62  )-u(i-1)| <= 1/b
-00019ae0: 0a0a 2020 2020 4f72 6967 696e 616c 2062  ..    Original b
-00019af0: 7920 4469 2059 616e 670a 2020 2020 4c61  y Di Yang.    La
-00019b00: 7374 206d 6f64 6966 6965 6420 6279 2044  st modified by D
-00019b10: 796c 616e 204d 696b 6573 656c 6c20 2831  ylan Mikesell (1
-00019b20: 3920 4465 632e 2032 3031 3429 0a0a 2020  9 Dec. 2014)..  
-00019b30: 2020 5472 616e 736c 6174 6564 2074 6f20    Translated to 
-00019b40: 7079 7468 6f6e 2062 7920 5469 6d20 436c  python by Tim Cl
-00019b50: 656d 656e 7473 2028 3137 2041 7567 2e20  ements (17 Aug. 
-00019b60: 3230 3138 290a 0a20 2020 2022 2222 0a0a  2018)..    """..
-00019b70: 2020 2020 6e53 616d 706c 652c 206e 4c61      nSample, nLa
-00019b80: 6720 3d20 642e 7368 6170 650a 2020 2020  g = d.shape.    
-00019b90: 7374 6261 7220 3d20 6e70 2e7a 6572 6f73  stbar = np.zeros
-00019ba0: 286e 5361 6d70 6c65 290a 0a20 2020 2023  (nSample)..    #
-00019bb0: 2053 6574 7570 2069 6e64 6963 6573 2062   Setup indices b
-00019bc0: 6173 6564 206f 6e20 666f 7277 6172 6420  ased on forward 
-00019bd0: 6f72 2062 6163 6b77 6172 6420 6163 6375  or backward accu
-00019be0: 6d75 6c61 7469 6f6e 2064 6972 6563 7469  mulation directi
-00019bf0: 6f6e 0a20 2020 2069 6620 6469 7220 3e20  on.    if dir > 
-00019c00: 303a 2020 2320 464f 5257 4152 440a 2020  0:  # FORWARD.  
-00019c10: 2020 2020 2020 6942 6567 696e 2c20 6945        iBegin, iE
-00019c20: 6e64 2c20 6949 6e63 203d 2030 2c20 6e53  nd, iInc = 0, nS
-00019c30: 616d 706c 6520 2d20 312c 2031 0a20 2020  ample - 1, 1.   
-00019c40: 2065 6c73 653a 2020 2320 4241 434b 5741   else:  # BACKWA
-00019c50: 5244 0a20 2020 2020 2020 2069 4265 6769  RD.        iBegi
-00019c60: 6e2c 2069 456e 642c 2069 496e 6320 3d20  n, iEnd, iInc = 
-00019c70: 6e53 616d 706c 6520 2d20 312c 2030 2c20  nSample - 1, 0, 
-00019c80: 2d31 0a0a 2020 2020 2320 7374 6172 7420  -1..    # start 
-00019c90: 6672 6f6d 2074 6865 2065 6e64 2028 6672  from the end (fr
-00019ca0: 6f6e 7420 6f72 2062 6163 6b29 0a20 2020  ont or back).   
-00019cb0: 206c 6c20 3d20 6e70 2e61 7267 6d69 6e28   ll = np.argmin(
-00019cc0: 645b 6942 6567 696e 2c20 3a5d 2920 2023  d[iBegin, :])  #
-00019cd0: 2066 696e 6420 6d69 6e69 6d75 6d20 6163   find minimum ac
-00019ce0: 6375 6d75 6c61 7465 6420 6469 7374 616e  cumulated distan
-00019cf0: 6365 2061 7420 6672 6f6e 7420 6f72 2062  ce at front or b
-00019d00: 6163 6b20 6465 7065 6e64 696e 6720 6f6e  ack depending on
-00019d10: 2027 6469 7227 0a20 2020 2073 7462 6172   'dir'.    stbar
-00019d20: 5b69 4265 6769 6e5d 203d 206c 6c20 2b20  [iBegin] = ll + 
-00019d30: 6c6d 696e 2020 2320 6162 736f 6c75 7465  lmin  # absolute
-00019d40: 2076 616c 7565 206f 6620 696e 7465 6765   value of intege
-00019d50: 7220 7368 6966 740a 0a20 2020 2023 206d  r shift..    # m
-00019d60: 6f76 6520 7468 726f 7567 6820 616c 6c20  ove through all 
-00019d70: 7469 6d65 2073 616d 706c 6573 2069 6e20  time samples in 
-00019d80: 666f 7277 6172 6420 6f72 2062 6163 6b77  forward or backw
-00019d90: 6172 6420 6469 7265 6374 696f 6e0a 2020  ard direction.  
-00019da0: 2020 6969 203d 2069 4265 6769 6e0a 0a20    ii = iBegin.. 
-00019db0: 2020 2077 6869 6c65 2069 6920 213d 2069     while ii != i
-00019dc0: 456e 643a 0a20 2020 2020 2020 2023 206d  End:.        # m
-00019dd0: 696e 2f6d 6178 2066 6f72 2065 6467 6573  in/max for edges
-00019de0: 2f62 6f75 6e64 6172 6965 730a 2020 2020  /boundaries.    
-00019df0: 2020 2020 6a69 203d 206e 702e 6d61 7828      ji = np.max(
-00019e00: 5b30 2c20 6e70 2e6d 696e 285b 6e53 616d  [0, np.min([nSam
-00019e10: 706c 6520 2d20 312c 2069 6920 2b20 6949  ple - 1, ii + iI
-00019e20: 6e63 5d29 5d29 0a20 2020 2020 2020 206a  nc])]).        j
-00019e30: 6220 3d20 6e70 2e6d 6178 285b 302c 206e  b = np.max([0, n
-00019e40: 702e 6d69 6e28 5b6e 5361 6d70 6c65 202d  p.min([nSample -
-00019e50: 2031 2c20 6969 202b 2069 496e 6320 2a20   1, ii + iInc * 
-00019e60: 625d 295d 290a 0a20 2020 2020 2020 2023  b])])..        #
-00019e70: 2063 6865 636b 206c 696d 6974 7320 6f6e   check limits on
-00019e80: 206c 6167 2069 6e64 6963 6573 0a20 2020   lag indices.   
-00019e90: 2020 2020 206c 4d69 6e75 7331 203d 206c       lMinus1 = l
-00019ea0: 6c20 2d20 310a 0a20 2020 2020 2020 2069  l - 1..        i
-00019eb0: 6620 6c4d 696e 7573 3120 3c20 303a 2020  f lMinus1 < 0:  
-00019ec0: 2320 6368 6563 6b20 6c61 6720 696e 6465  # check lag inde
-00019ed0: 7820 6973 2067 7265 6174 6572 2074 6861  x is greater tha
-00019ee0: 6e20 310a 2020 2020 2020 2020 2020 2020  n 1.            
-00019ef0: 6c4d 696e 7573 3120 3d20 3020 2023 206d  lMinus1 = 0  # m
-00019f00: 616b 6520 6c61 6720 3d20 6669 7273 7420  ake lag = first 
-00019f10: 6c61 670a 0a20 2020 2020 2020 206c 506c  lag..        lPl
-00019f20: 7573 3120 3d20 6c6c 202b 2031 0a0a 2020  us1 = ll + 1..  
-00019f30: 2020 2020 2020 6966 206c 506c 7573 3120        if lPlus1 
-00019f40: 3e20 6e4c 6167 202d 2031 3a20 2023 2063  > nLag - 1:  # c
-00019f50: 6865 636b 206c 6167 2069 6e64 6578 206c  heck lag index l
-00019f60: 6573 7320 7468 616e 206d 6178 206c 6167  ess than max lag
-00019f70: 0a20 2020 2020 2020 2020 2020 206c 506c  .            lPl
-00019f80: 7573 3120 3d20 6e4c 6167 202d 2031 0a0a  us1 = nLag - 1..
-00019f90: 2020 2020 2020 2020 2320 6765 7420 6469          # get di
-00019fa0: 7374 616e 6365 2061 7420 6c61 6773 2028  stance at lags (
-00019fb0: 6c6c 2d31 2c20 6c6c 2c20 6c6c 2b31 290a  ll-1, ll, ll+1).
-00019fc0: 2020 2020 2020 2020 6469 7374 4c6d 696e          distLmin
-00019fd0: 7573 3120 3d20 645b 6a62 2c20 6c4d 696e  us1 = d[jb, lMin
-00019fe0: 7573 315d 2020 2320 6d69 6e75 733a 2020  us1]  # minus:  
-00019ff0: 645b 692d 622c 206a 2d31 5d0a 2020 2020  d[i-b, j-1].    
-0001a000: 2020 2020 6469 7374 4c20 3d20 645b 6a69      distL = d[ji
-0001a010: 2c20 6c6c 5d20 2023 2061 6374 7561 6c20  , ll]  # actual 
-0001a020: 645b 692d 312c 206a 5d0a 2020 2020 2020  d[i-1, j].      
-0001a030: 2020 6469 7374 4c70 6c75 7331 203d 2064    distLplus1 = d
-0001a040: 5b6a 622c 206c 506c 7573 315d 2020 2320  [jb, lPlus1]  # 
-0001a050: 706c 7573 2064 5b69 2d62 2c20 6a2b 315d  plus d[i-b, j+1]
-0001a060: 0a0a 2020 2020 2020 2020 2320 6571 7561  ..        # equa
-0001a070: 7469 6f6e 2031 3020 696e 2048 616c 6520  tion 10 in Hale 
-0001a080: 2832 3031 3329 0a20 2020 2020 2020 2023  (2013).        #
-0001a090: 2073 756d 2065 7272 6f72 7320 6f76 6572   sum errors over
-0001a0a0: 2069 2d31 3a69 2d62 2b31 0a20 2020 2020   i-1:i-b+1.     
-0001a0b0: 2020 2069 6620 6a69 2021 3d20 6a62 3a0a     if ji != jb:.
-0001a0c0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0001a0d0: 6b62 2069 6e20 7261 6e67 6528 6a69 2c20  kb in range(ji, 
-0001a0e0: 6a62 202d 2069 496e 6320 2d20 312c 2069  jb - iInc - 1, i
-0001a0f0: 496e 6329 3a0a 2020 2020 2020 2020 2020  Inc):.          
-0001a100: 2020 2020 2020 6469 7374 4c6d 696e 7573        distLminus
-0001a110: 3120 3d20 6469 7374 4c6d 696e 7573 3120  1 = distLminus1 
-0001a120: 2b20 6572 725b 6b62 2c20 6c4d 696e 7573  + err[kb, lMinus
-0001a130: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
-0001a140: 2020 2064 6973 744c 706c 7573 3120 3d20     distLplus1 = 
-0001a150: 6469 7374 4c70 6c75 7331 202b 2065 7272  distLplus1 + err
-0001a160: 5b6b 622c 206c 506c 7573 315d 0a0a 2020  [kb, lPlus1]..  
-0001a170: 2020 2020 2020 2320 7570 6461 7465 206d        # update m
-0001a180: 696e 696d 756d 2064 6973 7461 6e63 6520  inimum distance 
-0001a190: 746f 2070 7265 7669 6f75 7320 7361 6d70  to previous samp
-0001a1a0: 6c65 0a20 2020 2020 2020 2064 6c20 3d20  le.        dl = 
-0001a1b0: 6e70 2e6d 696e 285b 6469 7374 4c6d 696e  np.min([distLmin
-0001a1c0: 7573 312c 2064 6973 744c 2c20 6469 7374  us1, distL, dist
-0001a1d0: 4c70 6c75 7331 5d29 0a0a 2020 2020 2020  Lplus1])..      
-0001a1e0: 2020 6966 2064 6c20 213d 2064 6973 744c    if dl != distL
-0001a1f0: 3a20 2023 2074 6865 6e20 6c6c 207e 3d20  :  # then ll ~= 
-0001a200: 6c6c 2061 6e64 2077 6520 6368 6563 6b20  ll and we check 
-0001a210: 666f 7277 6172 6420 616e 6420 6261 636b  forward and back
-0001a220: 7761 7264 0a20 2020 2020 2020 2020 2020  ward.           
-0001a230: 2069 6620 646c 203d 3d20 6469 7374 4c6d   if dl == distLm
-0001a240: 696e 7573 313a 0a20 2020 2020 2020 2020  inus1:.         
-0001a250: 2020 2020 2020 206c 6c20 3d20 6c4d 696e         ll = lMin
-0001a260: 7573 310a 2020 2020 2020 2020 2020 2020  us1.            
-0001a270: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001a280: 2020 2020 2020 6c6c 203d 206c 506c 7573        ll = lPlus
-0001a290: 310a 0a20 2020 2020 2020 2023 2061 7373  1..        # ass
-0001a2a0: 756d 6520 6969 203d 2069 6920 2d20 310a  ume ii = ii - 1.
-0001a2b0: 2020 2020 2020 2020 6969 202b 3d20 6949          ii += iI
-0001a2c0: 6e63 0a0a 2020 2020 2020 2020 2320 6162  nc..        # ab
-0001a2d0: 736f 6c75 7465 2069 6e74 6567 6572 206f  solute integer o
-0001a2e0: 6620 6c61 670a 2020 2020 2020 2020 7374  f lag.        st
-0001a2f0: 6261 725b 6969 5d20 3d20 6c6c 202b 206c  bar[ii] = ll + l
-0001a300: 6d69 6e0a 0a20 2020 2020 2020 2023 206e  min..        # n
-0001a310: 6f77 206d 6f76 6520 746f 2063 6f72 7265  ow move to corre
-0001a320: 6374 2074 696d 6520 696e 6465 782c 2069  ct time index, i
-0001a330: 6620 736d 6f6f 7468 696e 6720 6469 6666  f smoothing diff
-0001a340: 6572 656e 6365 206f 7665 7220 6d61 6e79  erence over many
-0001a350: 0a20 2020 2020 2020 2023 2074 696d 6520  .        # time 
-0001a360: 7361 6d70 6c65 7320 7573 696e 6720 2762  samples using 'b
-0001a370: 270a 2020 2020 2020 2020 6966 2028 6c6c  '.        if (ll
-0001a380: 203d 3d20 6c4d 696e 7573 3129 207c 2028   == lMinus1) | (
-0001a390: 6c6c 203d 3d20 6c50 6c75 7331 293a 2020  ll == lPlus1):  
-0001a3a0: 2320 6368 6563 6b20 6564 6765 7320 746f  # check edges to
-0001a3b0: 2073 6565 2061 626f 7574 2062 2076 616c   see about b val
-0001a3c0: 7565 730a 2020 2020 2020 2020 2020 2020  ues.            
-0001a3d0: 6966 206a 6920 213d 206a 623a 2020 2320  if ji != jb:  # 
-0001a3e0: 6966 2062 3e31 2074 6865 6e20 6e65 6564  if b>1 then need
-0001a3f0: 2074 6f20 6d6f 7665 206d 6f72 6520 7374   to move more st
-0001a400: 6570 730a 2020 2020 2020 2020 2020 2020  eps.            
-0001a410: 2020 2020 666f 7220 6b62 2069 6e20 7261      for kb in ra
-0001a420: 6e67 6528 6a69 2c20 6a62 202d 2069 496e  nge(ji, jb - iIn
-0001a430: 6320 2d20 312c 2069 496e 6329 3a0a 2020  c - 1, iInc):.  
-0001a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a450: 2020 6969 203d 2069 6920 2b20 6949 6e63    ii = ii + iInc
-0001a460: 2020 2320 6d6f 7665 2066 726f 6d20 692d    # move from i-
-0001a470: 313a 692d 622d 310a 2020 2020 2020 2020  1:i-b-1.        
-0001a480: 2020 2020 2020 2020 2020 2020 7374 6261              stba
-0001a490: 725b 6969 5d20 3d20 6c6c 202b 206c 6d69  r[ii] = ll + lmi
-0001a4a0: 6e20 2023 2063 6f6e 7374 616e 7420 6c61  n  # constant la
-0001a4b0: 6720 6f76 6572 2074 6861 7420 7469 6d65  g over that time
-0001a4c0: 0a0a 2020 2020 7265 7475 726e 2073 7462  ..    return stb
-0001a4d0: 6172 0a0a 0a64 6566 2077 6374 5f6d 6f64  ar...def wct_mod
-0001a4e0: 6966 6965 6428 0a20 2020 2079 312c 2079  ified(.    y1, y
-0001a4f0: 322c 2064 742c 2064 6a3d 3120 2f20 3132  2, dt, dj=1 / 12
-0001a500: 2c20 7330 3d2d 312c 204a 3d2d 312c 2073  , s0=-1, J=-1, s
-0001a510: 6967 3d54 7275 652c 2073 6967 6e69 6669  ig=True, signifi
-0001a520: 6361 6e63 655f 6c65 7665 6c3d 302e 3935  cance_level=0.95
-0001a530: 2c20 7761 7665 6c65 743d 226d 6f72 6c65  , wavelet="morle
-0001a540: 7422 2c20 6e6f 726d 616c 697a 653d 5472  t", normalize=Tr
-0001a550: 7565 2c20 2a2a 6b77 6172 6773 0a29 3a0a  ue, **kwargs.):.
-0001a560: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0001a570: 5761 7665 6c65 7420 636f 6865 7265 6e63  Wavelet coherenc
-0001a580: 6520 7472 616e 7366 6f72 6d20 2857 4354  e transform (WCT
-0001a590: 292e 0a20 2020 20e2 808b 0a20 2020 2020  )..    ....     
-0001a5a0: 2020 2054 6865 2057 4354 2066 696e 6473     The WCT finds
-0001a5b0: 2072 6567 696f 6e73 2069 6e20 7469 6d65   regions in time
-0001a5c0: 2066 7265 7175 656e 6379 2073 7061 6365   frequency space
-0001a5d0: 2077 6865 7265 2074 6865 2074 776f 2074   where the two t
-0001a5e0: 696d 650a 2020 2020 2020 2020 7365 7269  ime.        seri
-0001a5f0: 6573 2063 6f2d 7661 7279 2c20 6275 7420  es co-vary, but 
-0001a600: 646f 206e 6f74 206e 6563 6573 7361 7269  do not necessari
-0001a610: 6c79 2068 6176 6520 6869 6768 2070 6f77  ly have high pow
-0001a620: 6572 2e0a 2020 2020 e280 8b0a 2020 2020  er..    ....    
-0001a630: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-0001a640: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d2d         ---------
-0001a650: 2d0a 2020 2020 2020 2020 7931 2c20 7932  -.        y1, y2
-0001a660: 203a 206e 756d 7079 2e6e 6461 7272 6179   : numpy.ndarray
-0001a670: 2c20 6c69 7374 0a20 2020 2020 2020 2020  , list.         
-0001a680: 2020 2049 6e70 7574 2073 6967 6e61 6c73     Input signals
-0001a690: 2e0a 2020 2020 2020 2020 6474 203a 2066  ..        dt : f
-0001a6a0: 6c6f 6174 0a20 2020 2020 2020 2020 2020  loat.           
-0001a6b0: 2053 616d 706c 6520 7370 6163 696e 672e   Sample spacing.
-0001a6c0: 0a20 2020 2020 2020 2064 6a20 3a20 666c  .        dj : fl
-0001a6d0: 6f61 742c 206f 7074 696f 6e61 6c0a 2020  oat, optional.  
-0001a6e0: 2020 2020 2020 2020 2020 5370 6163 696e            Spacin
-0001a6f0: 6720 6265 7477 6565 6e20 6469 7363 7265  g between discre
-0001a700: 7465 2073 6361 6c65 732e 2044 6566 6175  te scales. Defau
-0001a710: 6c74 2076 616c 7565 2069 7320 312f 3132  lt value is 1/12
-0001a720: 2e0a 2020 2020 2020 2020 2020 2020 536d  ..            Sm
-0001a730: 616c 6c65 7220 7661 6c75 6573 2077 696c  aller values wil
-0001a740: 6c20 7265 7375 6c74 2069 6e20 6265 7474  l result in bett
-0001a750: 6572 2073 6361 6c65 2072 6573 6f6c 7574  er scale resolut
-0001a760: 696f 6e2c 2062 7574 0a20 2020 2020 2020  ion, but.       
-0001a770: 2020 2020 2073 6c6f 7765 7220 6361 6c63       slower calc
-0001a780: 756c 6174 696f 6e20 616e 6420 706c 6f74  ulation and plot
-0001a790: 2e0a 2020 2020 2020 2020 7330 203a 2066  ..        s0 : f
-0001a7a0: 6c6f 6174 2c20 6f70 7469 6f6e 616c 0a20  loat, optional. 
-0001a7b0: 2020 2020 2020 2020 2020 2053 6d61 6c6c             Small
-0001a7c0: 6573 7420 7363 616c 6520 6f66 2074 6865  est scale of the
-0001a7d0: 2077 6176 656c 6574 2e20 4465 6661 756c   wavelet. Defaul
-0001a7e0: 7420 7661 6c75 6520 6973 2032 2a64 742e  t value is 2*dt.
-0001a7f0: 0a20 2020 2020 2020 204a 203a 2066 6c6f  .        J : flo
-0001a800: 6174 2c20 6f70 7469 6f6e 616c 0a20 2020  at, optional.   
-0001a810: 2020 2020 2020 2020 204e 756d 6265 7220           Number 
-0001a820: 6f66 2073 6361 6c65 7320 6c65 7373 206f  of scales less o
-0001a830: 6e65 2e20 5363 616c 6573 2072 616e 6765  ne. Scales range
-0001a840: 2066 726f 6d20 7330 2075 7020 746f 0a20   from s0 up to. 
-0001a850: 2020 2020 2020 2020 2020 2073 3020 2a20             s0 * 
-0001a860: 322a 2a28 4a20 2a20 646a 292c 2077 6869  2**(J * dj), whi
-0001a870: 6368 2067 6976 6573 2061 2074 6f74 616c  ch gives a total
-0001a880: 206f 6620 284a 202b 2031 2920 7363 616c   of (J + 1) scal
-0001a890: 6573 2e0a 2020 2020 2020 2020 2020 2020  es..            
-0001a8a0: 4465 6661 756c 7420 6973 204a 203d 2028  Default is J = (
-0001a8b0: 6c6f 6732 284e 2a64 742f 736f 2929 2f64  log2(N*dt/so))/d
-0001a8c0: 6a2e 0a20 2020 2020 2020 2073 6967 6e69  j..        signi
-0001a8d0: 6669 6361 6e63 655f 6c65 7665 6c20 2866  ficance_level (f
-0001a8e0: 6c6f 6174 2c20 6f70 7469 6f6e 616c 2920  loat, optional) 
-0001a8f0: 3a0a 2020 2020 2020 2020 2020 2020 5369  :.            Si
-0001a900: 676e 6966 6963 616e 6365 206c 6576 656c  gnificance level
-0001a910: 2074 6f20 7573 652e 2044 6566 6175 6c74   to use. Default
-0001a920: 2069 7320 302e 3935 2e0a 2020 2020 2020   is 0.95..      
-0001a930: 2020 6e6f 726d 616c 697a 6520 2862 6f6f    normalize (boo
-0001a940: 6c65 616e 2c20 6f70 7469 6f6e 616c 2920  lean, optional) 
-0001a950: 3a0a 2020 2020 2020 2020 2020 2020 4966  :.            If
-0001a960: 2073 6574 2074 6f20 7472 7565 2c20 6e6f   set to true, no
-0001a970: 726d 616c 697a 6573 2043 5754 2062 7920  rmalizes CWT by 
-0001a980: 7468 6520 7374 616e 6461 7264 2064 6576  the standard dev
-0001a990: 6961 7469 6f6e 206f 660a 2020 2020 2020  iation of.      
-0001a9a0: 2020 2020 2020 7468 6520 7369 676e 616c        the signal
-0001a9b0: 732e 0a20 2020 20e2 808b 0a20 2020 2020  s..    ....     
-0001a9c0: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
-0001a9d0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
-0001a9e0: 2020 2054 4f44 4f3a 2053 6f6d 6574 6869     TODO: Somethi
-0001a9f0: 6e67 2054 4241 2061 6e64 2054 4243 0a20  ng TBA and TBC. 
-0001aa00: 2020 20e2 808b 0a20 2020 2020 2020 2053     ....        S
-0001aa10: 6565 2061 6c73 6f0a 2020 2020 2020 2020  ee also.        
-0001aa20: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
-0001aa30: 2063 7774 2c20 7877 740a 2020 2020 e280   cwt, xwt.    ..
-0001aa40: 8b0a 2020 2020 2222 220a 0a20 2020 2077  ..    """..    w
-0001aa50: 6176 656c 6574 203d 2070 7963 7774 2e77  avelet = pycwt.w
-0001aa60: 6176 656c 6574 2e5f 6368 6563 6b5f 7061  avelet._check_pa
-0001aa70: 7261 6d65 7465 725f 7761 7665 6c65 7428  rameter_wavelet(
-0001aa80: 7761 7665 6c65 7429 0a20 2020 2023 2043  wavelet).    # C
-0001aa90: 6865 636b 696e 6720 736f 6d65 2069 6e70  hecking some inp
-0001aaa0: 7574 2070 6172 616d 6574 6572 730a 2020  ut parameters.  
-0001aab0: 2020 6966 2073 3020 3d3d 202d 313a 0a20    if s0 == -1:. 
-0001aac0: 2020 2020 2020 2023 204e 756d 6265 7220         # Number 
-0001aad0: 6f66 2073 6361 6c65 730a 2020 2020 2020  of scales.      
-0001aae0: 2020 7330 203d 2032 202a 2064 7420 2f20    s0 = 2 * dt / 
-0001aaf0: 7761 7665 6c65 742e 666c 616d 6264 6128  wavelet.flambda(
-0001ab00: 290a 2020 2020 6966 204a 203d 3d20 2d31  ).    if J == -1
-0001ab10: 3a0a 2020 2020 2020 2020 2320 4e75 6d62  :.        # Numb
-0001ab20: 6572 206f 6620 7363 616c 6573 0a20 2020  er of scales.   
-0001ab30: 2020 2020 204a 203d 206e 702e 696e 7428       J = np.int(
-0001ab40: 6e70 2e72 6f75 6e64 286e 702e 6c6f 6732  np.round(np.log2
-0001ab50: 2879 312e 7369 7a65 202a 2064 7420 2f20  (y1.size * dt / 
-0001ab60: 7330 2920 2f20 646a 2929 0a0a 2020 2020  s0) / dj))..    
-0001ab70: 2320 4d61 6b65 7320 7375 7265 2069 6e70  # Makes sure inp
-0001ab80: 7574 2073 6967 6e61 6c73 2061 7265 206e  ut signals are n
-0001ab90: 756d 7079 2061 7272 6179 732e 0a20 2020  umpy arrays..   
-0001aba0: 2079 3120 3d20 6e70 2e61 7361 7272 6179   y1 = np.asarray
-0001abb0: 2879 3129 0a20 2020 2079 3220 3d20 6e70  (y1).    y2 = np
-0001abc0: 2e61 7361 7272 6179 2879 3229 0a20 2020  .asarray(y2).   
-0001abd0: 2023 2043 616c 6375 6c61 7465 7320 7468   # Calculates th
-0001abe0: 6520 7374 616e 6461 7264 2064 6576 6961  e standard devia
-0001abf0: 7469 6f6e 206f 6620 626f 7468 2069 6e70  tion of both inp
-0001ac00: 7574 2073 6967 6e61 6c73 2e0a 2020 2020  ut signals..    
-0001ac10: 7374 6431 203d 2079 312e 7374 6428 290a  std1 = y1.std().
-0001ac20: 2020 2020 7374 6432 203d 2079 322e 7374      std2 = y2.st
-0001ac30: 6428 290a 2020 2020 2320 4e6f 726d 616c  d().    # Normal
-0001ac40: 697a 6573 2062 6f74 6820 7369 676e 616c  izes both signal
-0001ac50: 732c 2069 6620 6170 7072 6f70 7269 6174  s, if appropriat
-0001ac60: 652e 0a20 2020 2069 6620 6e6f 726d 616c  e..    if normal
-0001ac70: 697a 653a 0a20 2020 2020 2020 2079 315f  ize:.        y1_
-0001ac80: 6e6f 726d 616c 203d 2028 7931 202d 2079  normal = (y1 - y
-0001ac90: 312e 6d65 616e 2829 2920 2f20 7374 6431  1.mean()) / std1
-0001aca0: 0a20 2020 2020 2020 2079 325f 6e6f 726d  .        y2_norm
-0001acb0: 616c 203d 2028 7932 202d 2079 322e 6d65  al = (y2 - y2.me
-0001acc0: 616e 2829 2920 2f20 7374 6432 0a20 2020  an()) / std2.   
-0001acd0: 2065 6c73 653a 0a20 2020 2020 2020 2079   else:.        y
-0001ace0: 315f 6e6f 726d 616c 203d 2079 310a 2020  1_normal = y1.  
-0001acf0: 2020 2020 2020 7932 5f6e 6f72 6d61 6c20        y2_normal 
-0001ad00: 3d20 7932 0a0a 2020 2020 2320 4361 6c63  = y2..    # Calc
-0001ad10: 756c 6174 6573 2074 6865 2043 5754 206f  ulates the CWT o
-0001ad20: 6620 7468 6520 7469 6d65 2d73 6572 6965  f the time-serie
-0001ad30: 7320 6d61 6b69 6e67 2073 7572 6520 7468  s making sure th
-0001ad40: 6520 7361 6d65 2070 6172 616d 6574 6572  e same parameter
-0001ad50: 730a 2020 2020 2320 6172 6520 7573 6564  s.    # are used
-0001ad60: 2069 6e20 626f 7468 2063 616c 6375 6c61   in both calcula
-0001ad70: 7469 6f6e 732e 0a20 2020 205f 6b77 6172  tions..    _kwar
-0001ad80: 6773 203d 2064 6963 7428 646a 3d64 6a2c  gs = dict(dj=dj,
-0001ad90: 2073 303d 7330 2c20 4a3d 4a2c 2077 6176   s0=s0, J=J, wav
-0001ada0: 656c 6574 3d77 6176 656c 6574 290a 2020  elet=wavelet).  
-0001adb0: 2020 5731 2c20 736a 2c20 6672 6571 2c20    W1, sj, freq, 
-0001adc0: 636f 692c 205f 2c20 5f20 3d20 7079 6377  coi, _, _ = pycw
-0001add0: 742e 6377 7428 7931 5f6e 6f72 6d61 6c2c  t.cwt(y1_normal,
-0001ade0: 2064 742c 202a 2a5f 6b77 6172 6773 290a   dt, **_kwargs).
-0001adf0: 2020 2020 5732 2c20 736a 2c20 6672 6571      W2, sj, freq
-0001ae00: 2c20 636f 692c 205f 2c20 5f20 3d20 7079  , coi, _, _ = py
-0001ae10: 6377 742e 6377 7428 7932 5f6e 6f72 6d61  cwt.cwt(y2_norma
-0001ae20: 6c2c 2064 742c 202a 2a5f 6b77 6172 6773  l, dt, **_kwargs
-0001ae30: 290a 0a20 2020 2073 6361 6c65 7331 203d  )..    scales1 =
-0001ae40: 206e 702e 6f6e 6573 285b 312c 2079 312e   np.ones([1, y1.
-0001ae50: 7369 7a65 5d29 202a 2073 6a5b 3a2c 204e  size]) * sj[:, N
-0001ae60: 6f6e 655d 0a20 2020 2073 6361 6c65 7332  one].    scales2
-0001ae70: 203d 206e 702e 6f6e 6573 285b 312c 2079   = np.ones([1, y
-0001ae80: 322e 7369 7a65 5d29 202a 2073 6a5b 3a2c  2.size]) * sj[:,
-0001ae90: 204e 6f6e 655d 0a0a 2020 2020 2320 536d   None]..    # Sm
-0001aea0: 6f6f 7468 2074 6865 2077 6176 656c 6574  ooth the wavelet
-0001aeb0: 2073 7065 6374 7261 2062 6566 6f72 6520   spectra before 
-0001aec0: 7472 756e 6361 7469 6e67 2e0a 2020 2020  truncating..    
-0001aed0: 5331 203d 2077 6176 656c 6574 2e73 6d6f  S1 = wavelet.smo
-0001aee0: 6f74 6828 6e70 2e61 6273 2857 3129 202a  oth(np.abs(W1) *
-0001aef0: 2a20 3220 2f20 7363 616c 6573 312c 2064  * 2 / scales1, d
-0001af00: 742c 2064 6a2c 2073 6a29 0a20 2020 2053  t, dj, sj).    S
-0001af10: 3220 3d20 7761 7665 6c65 742e 736d 6f6f  2 = wavelet.smoo
-0001af20: 7468 286e 702e 6162 7328 5732 2920 2a2a  th(np.abs(W2) **
-0001af30: 2032 202f 2073 6361 6c65 7332 2c20 6474   2 / scales2, dt
-0001af40: 2c20 646a 2c20 736a 290a 0a20 2020 2023  , dj, sj)..    #
-0001af50: 204e 6f77 2074 6865 2077 6176 656c 6574   Now the wavelet
-0001af60: 2074 7261 6e73 666f 726d 2063 6f68 6572   transform coher
-0001af70: 656e 6365 0a20 2020 2057 3132 203d 2057  ence.    W12 = W
-0001af80: 3120 2a20 5732 2e63 6f6e 6a28 290a 2020  1 * W2.conj().  
-0001af90: 2020 7363 616c 6573 203d 206e 702e 6f6e    scales = np.on
-0001afa0: 6573 285b 312c 2079 312e 7369 7a65 5d29  es([1, y1.size])
-0001afb0: 202a 2073 6a5b 3a2c 204e 6f6e 655d 0a20   * sj[:, None]. 
-0001afc0: 2020 2053 3132 203d 2077 6176 656c 6574     S12 = wavelet
-0001afd0: 2e73 6d6f 6f74 6828 5731 3220 2f20 7363  .smooth(W12 / sc
-0001afe0: 616c 6573 2c20 6474 2c20 646a 2c20 736a  ales, dt, dj, sj
-0001aff0: 290a 2020 2020 5743 5420 3d20 6e70 2e61  ).    WCT = np.a
-0001b000: 6273 2853 3132 2920 2a2a 2032 202f 2028  bs(S12) ** 2 / (
-0001b010: 5331 202a 2053 3229 0a20 2020 2061 5743  S1 * S2).    aWC
-0001b020: 5420 3d20 6e70 2e61 6e67 6c65 2857 3132  T = np.angle(W12
-0001b030: 290a 0a20 2020 2023 2043 616c 6375 6c61  )..    # Calcula
-0001b040: 7465 7320 7468 6520 7369 676e 6966 6963  tes the signific
-0001b050: 616e 6365 2075 7369 6e67 204d 6f6e 7465  ance using Monte
-0001b060: 2043 6172 6c6f 2073 696d 756c 6174 696f   Carlo simulatio
-0001b070: 6e73 2077 6974 6820 3935 250a 2020 2020  ns with 95%.    
-0001b080: 2320 636f 6e66 6964 656e 6365 2061 7320  # confidence as 
-0001b090: 6120 6675 6e63 7469 6f6e 206f 6620 7363  a function of sc
-0001b0a0: 616c 652e 0a0a 2020 2020 6966 2073 6967  ale...    if sig
-0001b0b0: 3a0a 2020 2020 2020 2020 6131 2c20 6231  :.        a1, b1
-0001b0c0: 2c20 6331 203d 2070 7963 7774 2e61 7231  , c1 = pycwt.ar1
-0001b0d0: 2879 3129 0a20 2020 2020 2020 2061 322c  (y1).        a2,
-0001b0e0: 2062 322c 2063 3220 3d20 7079 6377 742e   b2, c2 = pycwt.
-0001b0f0: 6172 3128 7932 290a 2020 2020 2020 2020  ar1(y2).        
-0001b100: 7369 6720 3d20 7079 6377 742e 7763 745f  sig = pycwt.wct_
-0001b110: 7369 676e 6966 6963 616e 6365 280a 2020  significance(.  
-0001b120: 2020 2020 2020 2020 2020 6131 2c20 6132            a1, a2
-0001b130: 2c20 6474 3d64 742c 2064 6a3d 646a 2c20  , dt=dt, dj=dj, 
-0001b140: 7330 3d73 302c 204a 3d4a 2c20 7369 676e  s0=s0, J=J, sign
-0001b150: 6966 6963 616e 6365 5f6c 6576 656c 3d73  ificance_level=s
-0001b160: 6967 6e69 6669 6361 6e63 655f 6c65 7665  ignificance_leve
-0001b170: 6c2c 2077 6176 656c 6574 3d77 6176 656c  l, wavelet=wavel
-0001b180: 6574 2c20 2a2a 6b77 6172 6773 0a20 2020  et, **kwargs.   
-0001b190: 2020 2020 2029 0a20 2020 2065 6c73 653a       ).    else:
-0001b1a0: 0a20 2020 2020 2020 2073 6967 203d 206e  .        sig = n
-0001b1b0: 702e 6173 6172 7261 7928 5b30 5d29 0a0a  p.asarray([0])..
-0001b1c0: 2020 2020 7265 7475 726e 2057 4354 2c20      return WCT, 
-0001b1d0: 6157 4354 2c20 636f 692c 2066 7265 712c  aWCT, coi, freq,
-0001b1e0: 2073 6967 0a0a 0a23 2323 2323 2323 2323   sig...#########
-0001b1f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b200: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b210: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b220: 2323 2323 2323 230a 2323 2323 2323 2323  #######.########
-0001b230: 2323 2323 2323 2323 2044 4953 5045 5253  ######## DISPERS
-0001b240: 494f 4e20 4558 5452 4143 5449 4f4e 2046  ION EXTRACTION F
-0001b250: 554e 4354 494f 4e53 2023 2323 2323 2323  UNCTIONS #######
-0001b260: 2323 2323 2323 2323 0a23 2323 2323 2323  ########.#######
-0001b270: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b280: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b290: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b2a0: 2323 2323 2323 2323 230a 0a0a 2320 6675  #########...# fu
-0001b2b0: 6e63 7469 6f6e 2074 6f20 6578 7472 6163  nction to extrac
-0001b2c0: 7420 7468 6520 6469 7370 6572 7369 6f6e  t the dispersion
-0001b2d0: 2066 726f 6d20 7468 6520 696d 6167 650a   from the image.
-0001b2e0: 6465 6620 6578 7472 6163 745f 6469 7370  def extract_disp
-0001b2f0: 6572 7369 6f6e 2861 6d70 2c20 7065 722c  ersion(amp, per,
-0001b300: 2076 656c 293a 0a20 2020 2022 2222 0a20   vel):.    """. 
-0001b310: 2020 2074 6869 7320 6675 6e63 7469 6f6e     this function
-0001b320: 2074 616b 6573 2074 6865 2064 6973 7065   takes the dispe
-0001b330: 7273 696f 6e20 696d 6167 6520 6672 6f6d  rsion image from
-0001b340: 2043 5754 2061 7320 696e 7075 742c 2074   CWT as input, t
-0001b350: 7261 636b 7320 7468 6520 676c 6f62 616c  racks the global
-0001b360: 206d 6178 696e 756d 206f 6e0a 2020 2020   maxinum on.    
-0001b370: 7468 6520 7761 7665 6c65 7420 7370 6563  the wavelet spec
-0001b380: 7472 756d 2061 6d70 6c69 7475 6465 2061  trum amplitude a
-0001b390: 6e64 2065 7874 7261 6374 2074 6865 2073  nd extract the s
-0001b3a0: 6563 7469 6f6e 7320 7769 7468 2063 6f6e  ections with con
-0001b3b0: 7469 6e6f 7573 2061 6e64 2068 6967 6820  tinous and high 
-0001b3c0: 7175 616c 6974 7920 6461 7461 0a0a 2020  quality data..  
-0001b3d0: 2020 5041 5241 4d45 5445 5253 3a0a 2020    PARAMETERS:.  
-0001b3e0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
-0001b3f0: 2d2d 0a20 2020 2061 6d70 3a20 3244 2061  --.    amp: 2D a
-0001b400: 6d70 6c69 7475 6465 206d 6174 7269 7820  mplitude matrix 
-0001b410: 6f66 2074 6865 2077 6176 656c 6574 2073  of the wavelet s
-0001b420: 7065 6374 7275 6d0a 2020 2020 7068 6173  pectrum.    phas
-0001b430: 653a 2032 4420 7068 6173 6520 6d61 7472  e: 2D phase matr
-0001b440: 6978 206f 6620 7468 6520 7761 7665 6c65  ix of the wavele
-0001b450: 7420 7370 6563 7472 756d 0a20 2020 2070  t spectrum.    p
-0001b460: 6572 3a20 2070 6572 696f 6420 7665 6374  er:  period vect
-0001b470: 6f72 2066 6f72 2074 6865 2032 4420 6d61  or for the 2D ma
-0001b480: 7472 6978 0a20 2020 2076 656c 3a20 2076  trix.    vel:  v
-0001b490: 656c 2076 6563 746f 7220 6f66 2074 6865  el vector of the
-0001b4a0: 2032 4420 6d61 7472 6978 0a20 2020 2052   2D matrix.    R
-0001b4b0: 4554 5552 4e53 3a0a 2020 2020 2d2d 2d2d  ETURNS:.    ----
-0001b4c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
-0001b4d0: 2070 6572 3a20 2063 656e 7472 616c 2066   per:  central f
-0001b4e0: 7265 7175 656e 6379 206f 6620 6561 6368  requency of each
-0001b4f0: 2077 6176 656c 6574 2073 6361 6c65 2077   wavelet scale w
-0001b500: 6974 6820 676f 6f64 2064 6174 610a 2020  ith good data.  
-0001b510: 2020 6776 3a20 2020 6772 6f75 7020 7665    gv:   group ve
-0001b520: 6c6f 6369 7479 2076 6563 746f 7220 6174  locity vector at
-0001b530: 2065 6163 6820 6672 6571 7565 6e63 790a   each frequency.
-0001b540: 2020 2020 2222 220a 2020 2020 6d61 7867      """.    maxg
-0001b550: 6170 203d 2035 0a20 2020 206e 7065 7220  ap = 5.    nper 
-0001b560: 3d20 616d 702e 7368 6170 655b 305d 0a20  = amp.shape[0]. 
-0001b570: 2020 2067 7620 3d20 6e70 2e7a 6572 6f73     gv = np.zeros
-0001b580: 286e 7065 722c 2064 7479 7065 3d6e 702e  (nper, dtype=np.
-0001b590: 666c 6f61 7433 3229 0a20 2020 2064 7665  float32).    dve
-0001b5a0: 6c20 3d20 7665 6c5b 315d 202d 2076 656c  l = vel[1] - vel
-0001b5b0: 5b30 5d0a 0a20 2020 2023 2066 696e 6420  [0]..    # find 
-0001b5c0: 676c 6f62 616c 206d 6178 696d 756d 0a20  global maximum. 
-0001b5d0: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
-0001b5e0: 6765 286e 7065 7229 3a0a 2020 2020 2020  ge(nper):.      
-0001b5f0: 2020 6d61 7876 616c 7565 203d 206e 702e    maxvalue = np.
-0001b600: 6d61 7828 616d 705b 6969 5d2c 2061 7869  max(amp[ii], axi
-0001b610: 733d 3029 0a20 2020 2020 2020 2069 6e64  s=0).        ind
-0001b620: 7820 3d20 6c69 7374 2861 6d70 5b69 695d  x = list(amp[ii]
-0001b630: 292e 696e 6465 7828 6d61 7876 616c 7565  ).index(maxvalue
-0001b640: 290a 2020 2020 2020 2020 6776 5b69 695d  ).        gv[ii]
-0001b650: 203d 2076 656c 5b69 6e64 785d 0a0a 2020   = vel[indx]..  
-0001b660: 2020 2320 6368 6563 6b20 7468 6520 636f    # check the co
-0001b670: 6e74 696e 756f 7573 206f 6620 7468 6520  ntinuous of the 
-0001b680: 6469 7370 6572 7369 6f6e 0a20 2020 2066  dispersion.    f
-0001b690: 6f72 2069 6920 696e 2072 616e 6765 2831  or ii in range(1
-0001b6a0: 2c20 6e70 6572 202d 2031 3529 3a0a 2020  , nper - 15):.  
-0001b6b0: 2020 2020 2020 2320 3135 2069 7320 7468        # 15 is th
-0001b6c0: 6520 6d69 6e75 6d75 6d20 6c65 6e67 7468  e minumum length
-0001b6d0: 206e 6565 6465 6420 666f 7220 6f75 7470   needed for outp
-0001b6e0: 7574 0a20 2020 2020 2020 2066 6f72 206a  ut.        for j
-0001b6f0: 6a20 696e 2072 616e 6765 2831 3529 3a0a  j in range(15):.
-0001b700: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0001b710: 702e 6162 7328 6776 5b69 6920 2b20 6a6a  p.abs(gv[ii + jj
-0001b720: 5d20 2d20 6776 5b69 6920 2b20 3120 2b20  ] - gv[ii + 1 + 
-0001b730: 6a6a 5d29 203e 206d 6178 6761 7020 2a20  jj]) > maxgap * 
-0001b740: 6476 656c 3a0a 2020 2020 2020 2020 2020  dvel:.          
-0001b750: 2020 2020 2020 6776 5b69 695d 203d 2030        gv[ii] = 0
-0001b760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b770: 2062 7265 616b 0a0a 2020 2020 2320 7265   break..    # re
-0001b780: 6d6f 7665 2074 6865 2062 6164 206f 6e65  move the bad one
-0001b790: 730a 2020 2020 696e 6478 203d 206e 702e  s.    indx = np.
-0001b7a0: 7768 6572 6528 6776 203e 2030 295b 305d  where(gv > 0)[0]
-0001b7b0: 0a0a 2020 2020 7265 7475 726e 2070 6572  ..    return per
-0001b7c0: 5b69 6e64 785d 2c20 6776 5b69 6e64 785d  [indx], gv[indx]
-0001b7d0: 0a                                       .
+0000b4b0: 7265 616d 2c20 7374 6172 7474 696d 652c  ream, starttime,
+0000b4c0: 2065 6e64 7469 6d65 2920 3e20 302e 333a   endtime) > 0.3:
+0000b4d0: 0a20 2020 2020 2020 2073 7472 6561 6d20  .        stream 
+0000b4e0: 3d20 5b5d 0a20 2020 2020 2020 2072 6574  = [].        ret
+0000b4f0: 7572 6e20 7374 7265 616d 0a0a 2020 2020  urn stream..    
+0000b500: 6672 6571 7320 3d20 5b5d 0a20 2020 2066  freqs = [].    f
+0000b510: 6f72 2074 7220 696e 2073 7472 6561 6d3a  or tr in stream:
+0000b520: 0a20 2020 2020 2020 2066 7265 7173 2e61  .        freqs.a
+0000b530: 7070 656e 6428 696e 7428 7472 2e73 7461  ppend(int(tr.sta
+0000b540: 7473 2e73 616d 706c 696e 675f 7261 7465  ts.sampling_rate
+0000b550: 2929 0a20 2020 2066 7265 7120 3d20 6d61  )).    freq = ma
+0000b560: 7828 6672 6571 7329 0a20 2020 2066 6f72  x(freqs).    for
+0000b570: 2074 7220 696e 2073 7472 6561 6d3a 0a20   tr in stream:. 
+0000b580: 2020 2020 2020 2069 6620 696e 7428 7472         if int(tr
+0000b590: 2e73 7461 7473 2e73 616d 706c 696e 675f  .stats.sampling_
+0000b5a0: 7261 7465 2920 213d 2066 7265 713a 0a20  rate) != freq:. 
+0000b5b0: 2020 2020 2020 2020 2020 2073 7472 6561             strea
+0000b5c0: 6d2e 7265 6d6f 7665 2874 7229 0a20 2020  m.remove(tr).   
+0000b5d0: 2020 2020 2069 6620 7472 2e73 7461 7473       if tr.stats
+0000b5e0: 2e6e 7074 7320 3c20 3130 3a0a 2020 2020  .npts < 10:.    
+0000b5f0: 2020 2020 2020 2020 7374 7265 616d 2e72          stream.r
+0000b600: 656d 6f76 6528 7472 290a 0a20 2020 2072  emove(tr)..    r
+0000b610: 6574 7572 6e20 7374 7265 616d 0a0a 0a64  eturn stream...d
+0000b620: 6566 2070 6f72 7469 6f6e 5f67 6170 7328  ef portion_gaps(
+0000b630: 7374 7265 616d 2c20 7374 6172 7474 696d  stream, starttim
+0000b640: 653a 206f 6273 7079 2e55 5443 4461 7465  e: obspy.UTCDate
+0000b650: 5469 6d65 2c20 656e 6474 696d 653a 206f  Time, endtime: o
+0000b660: 6273 7079 2e55 5443 4461 7465 5469 6d65  bspy.UTCDateTime
+0000b670: 293a 0a20 2020 2022 2222 0a20 2020 2074  ):.    """.    t
+0000b680: 6869 7320 6675 6e63 7469 6f6e 2074 7261  his function tra
+0000b690: 636b 7320 7468 6520 6761 7073 2028 6e70  cks the gaps (np
+0000b6a0: 7473 2920 6672 6f6d 2074 6865 2061 6363  ts) from the acc
+0000b6b0: 756d 756c 6174 6564 2064 6966 6665 7265  umulated differe
+0000b6c0: 6e63 6520 6265 7477 6565 6e20 7374 6172  nce between star
+0000b6d0: 7474 696d 6520 616e 6420 656e 6474 696d  ttime and endtim
+0000b6e0: 650a 2020 2020 6f66 2065 6163 6820 7374  e.    of each st
+0000b6f0: 7265 616d 2074 7261 6365 2e20 6974 2072  ream trace. it r
+0000b700: 656d 6f76 6573 2074 7261 6365 2077 6974  emoves trace wit
+0000b710: 6820 6761 7020 6c65 6e67 7468 203e 2033  h gap length > 3
+0000b720: 3025 206f 6620 7472 6163 6520 7369 7a65  0% of trace size
+0000b730: 2e0a 2020 2020 5041 5241 4d45 5445 5253  ..    PARAMETERS
+0000b740: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
+0000b750: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7374  ---------.    st
+0000b760: 7265 616d 3a20 6f62 7370 7920 7374 7265  ream: obspy stre
+0000b770: 616d 206f 626a 6563 740a 2020 2020 6461  am object.    da
+0000b780: 7465 5f69 6e66 6f3a 2064 6963 7420 6f66  te_info: dict of
+0000b790: 2073 7461 7274 696e 6720 616e 6420 656e   starting and en
+0000b7a0: 6469 6e67 2074 696d 6520 6f66 2074 6865  ding time of the
+0000b7b0: 2073 7472 6561 6d0a 0a20 2020 2052 4554   stream..    RET
+0000b7c0: 5552 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d  URNS:.    ------
+0000b7d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
+0000b7e0: 7067 6170 733a 2070 726f 706f 7274 696f  pgaps: proportio
+0000b7f0: 6e20 6f66 2067 6170 732f 616c 6c5f 7074  n of gaps/all_pt
+0000b800: 7320 696e 2073 7472 6561 6d0a 2020 2020  s in stream.    
+0000b810: 2222 220a 2020 2020 2320 6964 6561 6c20  """.    # ideal 
+0000b820: 6475 7261 7469 6f6e 206f 6620 6461 7461  duration of data
+0000b830: 0a20 2020 206e 7074 7320 3d20 2865 6e64  .    npts = (end
+0000b840: 7469 6d65 202d 2073 7461 7274 7469 6d65  time - starttime
+0000b850: 2920 2a20 7374 7265 616d 5b30 5d2e 7374  ) * stream[0].st
+0000b860: 6174 732e 7361 6d70 6c69 6e67 5f72 6174  ats.sampling_rat
+0000b870: 650a 0a20 2020 2070 6761 7073 203d 2030  e..    pgaps = 0
+0000b880: 0a20 2020 2023 206c 6f6f 7020 7468 726f  .    # loop thro
+0000b890: 7567 6820 616c 6c20 7472 6163 6520 746f  ugh all trace to
+0000b8a0: 2061 6363 756d 756c 6174 6520 6761 7073   accumulate gaps
+0000b8b0: 0a20 2020 2066 6f72 2069 6920 696e 2072  .    for ii in r
+0000b8c0: 616e 6765 286c 656e 2873 7472 6561 6d29  ange(len(stream)
+0000b8d0: 202d 2031 293a 0a20 2020 2020 2020 2070   - 1):.        p
+0000b8e0: 6761 7073 202b 3d20 2873 7472 6561 6d5b  gaps += (stream[
+0000b8f0: 6969 202b 2031 5d2e 7374 6174 732e 7374  ii + 1].stats.st
+0000b900: 6172 7474 696d 6520 2d20 7374 7265 616d  arttime - stream
+0000b910: 5b69 695d 2e73 7461 7473 2e65 6e64 7469  [ii].stats.endti
+0000b920: 6d65 2920 2a20 7374 7265 616d 5b69 695d  me) * stream[ii]
+0000b930: 2e73 7461 7473 2e73 616d 706c 696e 675f  .stats.sampling_
+0000b940: 7261 7465 0a20 2020 2069 6620 6e70 7473  rate.    if npts
+0000b950: 2021 3d20 303a 0a20 2020 2020 2020 2070   != 0:.        p
+0000b960: 6761 7073 203d 2070 6761 7073 202f 206e  gaps = pgaps / n
+0000b970: 7074 730a 2020 2020 6966 206e 7074 7320  pts.    if npts 
+0000b980: 3d3d 2030 3a0a 2020 2020 2020 2020 7067  == 0:.        pg
+0000b990: 6170 7320 3d20 310a 2020 2020 7265 7475  aps = 1.    retu
+0000b9a0: 726e 2070 6761 7073 0a0a 0a40 6a69 7428  rn pgaps...@jit(
+0000b9b0: 2266 6c6f 6174 3332 5b3a 5d28 666c 6f61  "float32[:](floa
+0000b9c0: 7433 325b 3a5d 2c66 6c6f 6174 3332 2922  t32[:],float32)"
+0000b9d0: 290a 6465 6620 7365 676d 656e 745f 696e  ).def segment_in
+0000b9e0: 7465 7270 6f6c 6174 6528 7369 6731 2c20  terpolate(sig1, 
+0000b9f0: 6e66 7269 6329 3a0a 2020 2020 2222 220a  nfric):.    """.
+0000ba00: 2020 2020 7468 6973 2066 756e 6374 696f      this functio
+0000ba10: 6e20 696e 7465 7270 6f6c 6174 6573 2074  n interpolates t
+0000ba20: 6865 2064 6174 6120 746f 2065 6e73 7572  he data to ensur
+0000ba30: 6520 616c 6c20 706f 696e 7473 206c 6f63  e all points loc
+0000ba40: 6174 6564 206f 6e20 696e 7465 7267 6572  ated on interger
+0000ba50: 2074 696d 6573 206f 6620 7468 650a 2020   times of the.  
+0000ba60: 2020 7361 6d70 6c69 6e67 2072 6174 6520    sampling rate 
+0000ba70: 2865 2e67 2e2c 2073 7461 7274 7469 6d65  (e.g., starttime
+0000ba80: 203d 2030 303a 3030 3a30 302e 3031 352c   = 00:00:00.015,
+0000ba90: 2064 656c 7461 203d 2030 2e30 352e 290a   delta = 0.05.).
+0000baa0: 2020 2020 5041 5241 4d45 5445 5253 3a0a      PARAMETERS:.
+0000bab0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
+0000bac0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2073  ----------.    s
+0000bad0: 6967 313a 2020 7365 6973 6d69 6320 7265  ig1:  seismic re
+0000bae0: 636f 7264 696e 6773 2069 6e20 6120 3144  cordings in a 1D
+0000baf0: 2061 7272 6179 0a20 2020 206e 6672 6963   array.    nfric
+0000bb00: 3a20 7468 6520 616d 6f75 6e74 206f 6620  : the amount of 
+0000bb10: 7469 6d65 2064 6966 6665 7265 6e63 6520  time difference 
+0000bb20: 6265 7477 6565 6e20 7468 6520 706f 696e  between the poin
+0000bb30: 7420 616e 6420 7468 6520 6164 6a61 6365  t and the adjace
+0000bb40: 6e74 2061 7373 756d 6564 2073 616d 706c  nt assumed sampl
+0000bb50: 6573 0a20 2020 2052 4554 5552 4e53 3a0a  es.    RETURNS:.
+0000bb60: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
+0000bb70: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2073  ----------.    s
+0000bb80: 6967 323a 2020 696e 7465 7270 6f6c 6174  ig2:  interpolat
+0000bb90: 6564 2073 6569 736d 6963 2072 6563 6f72  ed seismic recor
+0000bba0: 6469 6e67 7320 6f6e 2074 6865 2073 616d  dings on the sam
+0000bbb0: 706c 696e 6720 706f 696e 7473 0a20 2020  pling points.   
+0000bbc0: 2022 2222 0a20 2020 206e 7074 7320 3d20   """.    npts = 
+0000bbd0: 6c65 6e28 7369 6731 290a 2020 2020 7369  len(sig1).    si
+0000bbe0: 6732 203d 206e 702e 7a65 726f 7328 6e70  g2 = np.zeros(np
+0000bbf0: 7473 2c20 6474 7970 653d 6e70 2e66 6c6f  ts, dtype=np.flo
+0000bc00: 6174 3332 290a 0a20 2020 2023 202d 2d2d  at32)..    # ---
+0000bc10: 2d69 6e73 7465 6164 206f 6620 7368 6966  -instead of shif
+0000bc20: 7469 6e67 2c20 646f 2061 2069 6e74 6572  ting, do a inter
+0000bc30: 706f 6c61 7469 6f6e 2d2d 2d2d 2d2d 0a20  polation------. 
+0000bc40: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
+0000bc50: 6765 286e 7074 7329 3a0a 2020 2020 2020  ge(npts):.      
+0000bc60: 2020 2320 2d2d 2d2d 6465 616c 2077 6974    # ----deal wit
+0000bc70: 6820 6564 6765 732d 2d2d 2d2d 0a20 2020  h edges-----.   
+0000bc80: 2020 2020 2069 6620 6969 203d 3d20 3020       if ii == 0 
+0000bc90: 6f72 2069 6920 3d3d 206e 7074 7320 2d20  or ii == npts - 
+0000bca0: 313a 0a20 2020 2020 2020 2020 2020 2073  1:.            s
+0000bcb0: 6967 325b 6969 5d20 3d20 7369 6731 5b69  ig2[ii] = sig1[i
+0000bcc0: 695d 0a20 2020 2020 2020 2065 6c73 653a  i].        else:
+0000bcd0: 0a20 2020 2020 2020 2020 2020 2023 202d  .            # -
+0000bce0: 2d2d 2d2d 2d69 6e74 6572 706f 6c61 7465  -----interpolate
+0000bcf0: 2075 7369 6e67 2061 2068 6174 2066 756e   using a hat fun
+0000bd00: 6374 696f 6e2d 2d2d 2d2d 2d0a 2020 2020  ction------.    
+0000bd10: 2020 2020 2020 2020 7369 6732 5b69 695d          sig2[ii]
+0000bd20: 203d 2028 3120 2d20 6e66 7269 6329 202a   = (1 - nfric) *
+0000bd30: 2073 6967 315b 6969 202b 2031 5d20 2b20   sig1[ii + 1] + 
+0000bd40: 6e66 7269 6320 2a20 7369 6731 5b69 695d  nfric * sig1[ii]
+0000bd50: 0a0a 2020 2020 7265 7475 726e 2073 6967  ..    return sig
+0000bd60: 320a 0a0a 6465 6620 7265 7370 5f73 7065  2...def resp_spe
+0000bd70: 6374 7275 6d28 736f 7572 6365 2c20 7265  ctrum(source, re
+0000bd80: 7370 5f66 696c 652c 2064 6f77 6e73 616d  sp_file, downsam
+0000bd90: 705f 6672 6571 2c20 7072 655f 6669 6c74  p_freq, pre_filt
+0000bda0: 3d4e 6f6e 6529 3a0a 2020 2020 2222 220a  =None):.    """.
+0000bdb0: 2020 2020 7468 6973 2066 756e 6374 696f      this functio
+0000bdc0: 6e20 7265 6d6f 7665 7320 7468 6520 696e  n removes the in
+0000bdd0: 7374 7275 6d65 6e74 2072 6573 706f 6e73  strument respons
+0000bde0: 6520 7573 696e 6720 7265 7370 6f6e 7365  e using response
+0000bdf0: 2073 7065 6374 7275 6d20 6672 6f6d 2065   spectrum from e
+0000be00: 7661 6c72 6573 702e 0a20 2020 2074 6865  valresp..    the
+0000be10: 2072 6573 706f 6e73 6520 7370 6563 7472   response spectr
+0000be20: 756d 2069 7320 6576 616c 7561 7465 6420  um is evaluated 
+0000be30: 6261 7365 6420 6f6e 2052 4553 502f 505a  based on RESP/PZ
+0000be40: 2066 696c 6573 2062 6566 6f72 6520 696e   files before in
+0000be50: 7665 7274 6564 2075 7369 6e67 2074 6865  verted using the
+0000be60: 206f 6273 7079 0a20 2020 2066 756e 6374   obspy.    funct
+0000be70: 696f 6e20 6f66 2069 6e76 6572 745f 7370  ion of invert_sp
+0000be80: 6563 7472 756d 2e20 6120 6d6f 6475 6c65  ectrum. a module
+0000be90: 206f 6620 6372 6561 7465 5f72 6573 702e   of create_resp.
+0000bea0: 7079 2069 7320 7072 6f76 6964 6564 2069  py is provided i
+0000beb0: 6e20 6469 7265 6374 6f72 7920 6f66 2027  n directory of '
+0000bec0: 6164 6469 7469 6f6e 616c 5f6d 6f64 756c  additional_modul
+0000bed0: 6573 270a 2020 2020 746f 2063 7265 6174  es'.    to creat
+0000bee0: 6520 7468 6520 7265 7370 6f6e 7365 2073  e the response s
+0000bef0: 7065 6374 7275 6d0a 2020 2020 5041 5241  pectrum.    PARA
+0000bf00: 4d45 5445 5253 3a0a 2020 2020 2d2d 2d2d  METERS:.    ----
+0000bf10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000bf20: 2d2d 0a20 2020 2073 6f75 7263 653a 206f  --.    source: o
+0000bf30: 6273 7079 2073 7472 6561 6d20 6f62 6a65  bspy stream obje
+0000bf40: 6374 206f 6620 7461 7267 6574 6564 206e  ct of targeted n
+0000bf50: 6f69 7365 2064 6174 610a 2020 2020 7265  oise data.    re
+0000bf60: 7370 5f66 696c 653a 206e 756d 7079 2064  sp_file: numpy d
+0000bf70: 6174 6120 6669 6c65 206f 6620 7265 7370  ata file of resp
+0000bf80: 6f6e 7365 2073 7065 6374 7275 6d0a 2020  onse spectrum.  
+0000bf90: 2020 646f 776e 7361 6d70 5f66 7265 713a    downsamp_freq:
+0000bfa0: 2073 616d 706c 696e 6720 7261 7465 206f   sampling rate o
+0000bfb0: 6620 7468 6520 736f 7572 6365 2064 6174  f the source dat
+0000bfc0: 610a 2020 2020 7072 655f 6669 6c74 3a20  a.    pre_filt: 
+0000bfd0: 7072 652d 6465 6669 6e65 6420 6669 6c74  pre-defined filt
+0000bfe0: 6572 2070 6172 616d 6574 6572 730a 2020  er parameters.  
+0000bff0: 2020 5245 5455 524e 533a 0a20 2020 202d    RETURNS:.    -
+0000c000: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000c010: 2d2d 2d2d 2d0a 2020 2020 736f 7572 6365  -----.    source
+0000c020: 3a20 6f62 7370 7920 7374 7265 616d 206f  : obspy stream o
+0000c030: 626a 6563 7420 6f66 206e 6f69 7365 2064  bject of noise d
+0000c040: 6174 6120 7769 7468 2069 6e73 7472 756d  ata with instrum
+0000c050: 656e 7420 7265 7370 6f6e 7365 2072 656d  ent response rem
+0000c060: 6f76 6564 0a20 2020 2022 2222 0a20 2020  oved.    """.   
+0000c070: 2023 202d 2d2d 2d2d 2d2d 2d72 6573 705f   # --------resp_
+0000c080: 6669 6c65 2069 7320 7468 6520 696e 7665  file is the inve
+0000c090: 7274 6564 2073 7065 6374 7275 6d20 7265  rted spectrum re
+0000c0a0: 7370 6f6e 7365 2d2d 2d2d 2d2d 2d2d 2d0a  sponse---------.
+0000c0b0: 2020 2020 7265 7370 7a20 3d20 6e70 2e6c      respz = np.l
+0000c0c0: 6f61 6428 7265 7370 5f66 696c 6529 0a20  oad(resp_file). 
+0000c0d0: 2020 206e 7265 7370 7a20 3d20 7265 7370     nrespz = resp
+0000c0e0: 7a5b 315d 5b3a 5d0a 2020 2020 7370 6563  z[1][:].    spec
+0000c0f0: 5f66 7265 7120 3d20 6d61 7828 7265 7370  _freq = max(resp
+0000c100: 7a5b 305d 290a 0a20 2020 2023 202d 2d2d  z[0])..    # ---
+0000c110: 2d2d 2d2d 6f6e 2063 7572 7265 6e74 2074  ----on current t
+0000c120: 7261 6365 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  race----------. 
+0000c130: 2020 206e 6666 7420 3d20 5f6e 7074 7332     nfft = _npts2
+0000c140: 6e66 6674 2873 6f75 7263 655b 305d 2e73  nfft(source[0].s
+0000c150: 7461 7473 2e6e 7074 7329 0a20 2020 2073  tats.npts).    s
+0000c160: 7073 203d 2069 6e74 2873 6f75 7263 655b  ps = int(source[
+0000c170: 305d 2e73 7461 7473 2e73 616d 706c 696e  0].stats.samplin
+0000c180: 675f 7261 7465 290a 0a20 2020 2023 202d  g_rate)..    # -
+0000c190: 2d2d 2d2d 2d2d 2d2d 646f 2074 6865 2069  --------do the i
+0000c1a0: 6e74 6572 706f 6c61 7469 6f6e 2069 6620  nterpolation if 
+0000c1b0: 6e65 6564 6564 2d2d 2d2d 2d2d 2d2d 0a20  needed--------. 
+0000c1c0: 2020 2069 6620 7370 6563 5f66 7265 7120     if spec_freq 
+0000c1d0: 3c20 302e 3520 2a20 7370 733a 0a20 2020  < 0.5 * sps:.   
+0000c1e0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+0000c1f0: 4572 726f 7228 2273 7065 6374 7275 6d20  Error("spectrum 
+0000c200: 6669 6c65 2068 6173 2070 6561 6b20 6672  file has peak fr
+0000c210: 6571 2073 6d61 6c6c 6572 2074 6861 6e20  eq smaller than 
+0000c220: 7468 6520 6461 7461 2c20 6162 6f72 7421  the data, abort!
+0000c230: 2229 0a20 2020 2065 6c73 653a 0a20 2020  ").    else:.   
+0000c240: 2020 2020 2069 6e64 7820 3d20 6e70 2e77       indx = np.w
+0000c250: 6865 7265 2872 6573 707a 5b30 5d20 3c3d  here(respz[0] <=
+0000c260: 2030 2e35 202a 2073 7073 290a 2020 2020   0.5 * sps).    
+0000c270: 2020 2020 6e66 7265 7120 3d20 6e70 2e6c      nfreq = np.l
+0000c280: 696e 7370 6163 6528 302c 2030 2e35 202a  inspace(0, 0.5 *
+0000c290: 2073 7073 2c20 6e66 6674 202f 2f20 3220   sps, nfft // 2 
+0000c2a0: 2b20 3129 0a20 2020 2020 2020 206e 7265  + 1).        nre
+0000c2b0: 7370 7a20 3d20 6e70 2e69 6e74 6572 7028  spz = np.interp(
+0000c2c0: 6e66 7265 712c 206e 702e 7265 616c 2872  nfreq, np.real(r
+0000c2d0: 6573 707a 5b30 5d5b 696e 6478 5d29 2c20  espz[0][indx]), 
+0000c2e0: 7265 7370 7a5b 315d 5b69 6e64 785d 290a  respz[1][indx]).
+0000c2f0: 0a20 2020 2023 202d 2d2d 2d64 6f20 696e  .    # ----do in
+0000c300: 7465 7270 6f6c 6174 696f 6e20 6966 206e  terpolation if n
+0000c310: 6563 6573 7361 7279 2d2d 2d2d 2d0a 2020  ecessary-----.  
+0000c320: 2020 736f 7572 6365 5f73 7065 6374 203d    source_spect =
+0000c330: 206e 702e 6666 742e 7266 6674 2873 6f75   np.fft.rfft(sou
+0000c340: 7263 655b 305d 2e64 6174 612c 206e 3d6e  rce[0].data, n=n
+0000c350: 6666 7429 0a0a 2020 2020 2320 2d2d 2d2d  fft)..    # ----
+0000c360: 2d6e 7265 7370 7a20 6973 2069 6e76 6572  -nrespz is inver
+0000c370: 7365 6420 2877 6174 6572 2d6c 6576 656c  sed (water-level
+0000c380: 6564 2920 7370 6563 7472 756d 2d2d 2d2d  ed) spectrum----
+0000c390: 2d0a 2020 2020 736f 7572 6365 5f73 7065  -.    source_spe
+0000c3a0: 6374 202a 3d20 6e72 6573 707a 0a20 2020  ct *= nrespz.   
+0000c3b0: 2073 6f75 7263 655b 305d 2e64 6174 6120   source[0].data 
+0000c3c0: 3d20 6e70 2e66 6674 2e69 7266 6674 2873  = np.fft.irfft(s
+0000c3d0: 6f75 7263 655f 7370 6563 7429 5b30 203a  ource_spect)[0 :
+0000c3e0: 2073 6f75 7263 655b 305d 2e73 7461 7473   source[0].stats
+0000c3f0: 2e6e 7074 735d 0a0a 2020 2020 6966 2070  .npts]..    if p
+0000c400: 7265 5f66 696c 7420 6973 206e 6f74 204e  re_filt is not N
+0000c410: 6f6e 653a 0a20 2020 2020 2020 2073 6f75  one:.        sou
+0000c420: 7263 655b 305d 2e64 6174 6120 3d20 6e70  rce[0].data = np
+0000c430: 2e66 6c6f 6174 3332 280a 2020 2020 2020  .float32(.      
+0000c440: 2020 2020 2020 6261 6e64 7061 7373 280a        bandpass(.
+0000c450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c460: 736f 7572 6365 5b30 5d2e 6461 7461 2c0a  source[0].data,.
+0000c470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c480: 7072 655f 6669 6c74 5b30 5d2c 0a20 2020  pre_filt[0],.   
+0000c490: 2020 2020 2020 2020 2020 2020 2070 7265               pre
+0000c4a0: 5f66 696c 745b 2d31 5d2c 0a20 2020 2020  _filt[-1],.     
+0000c4b0: 2020 2020 2020 2020 2020 2064 663d 7370             df=sp
+0000c4c0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0000c4d0: 2020 2063 6f72 6e65 7273 3d34 2c0a 2020     corners=4,.  
+0000c4e0: 2020 2020 2020 2020 2020 2020 2020 7a65                ze
+0000c4f0: 726f 7068 6173 653d 5472 7565 2c0a 2020  rophase=True,.  
+0000c500: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000c510: 2020 2020 290a 0a20 2020 2072 6574 7572      )..    retur
+0000c520: 6e20 736f 7572 6365 0a0a 0a64 6566 206d  n source...def m
+0000c530: 6164 2861 7272 293a 0a20 2020 2022 2222  ad(arr):.    """
+0000c540: 0a20 2020 204d 6564 6961 6e20 4162 736f  .    Median Abso
+0000c550: 6c75 7465 2044 6576 6961 7469 6f6e 3a20  lute Deviation: 
+0000c560: 4d41 4420 3d20 6d65 6469 616e 287c 5869  MAD = median(|Xi
+0000c570: 2d20 6d65 6469 616e 2858 297c 290a 2020  - median(X)|).  
+0000c580: 2020 5041 5241 4d45 5445 5253 3a0a 2020    PARAMETERS:.  
+0000c590: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
+0000c5a0: 2d2d 2d2d 2d0a 2020 2020 6172 723a 206e  -----.    arr: n
+0000c5b0: 756d 7079 2e6e 6461 7272 6179 2c20 7365  umpy.ndarray, se
+0000c5c0: 6973 6d69 6320 7472 6163 6520 6461 7461  ismic trace data
+0000c5d0: 2061 7272 6179 0a20 2020 2052 4554 5552   array.    RETUR
+0000c5e0: 4e53 3a0a 2020 2020 6461 7461 3a20 4d65  NS:.    data: Me
+0000c5f0: 6469 616e 2041 6273 6f6c 7574 6520 4465  dian Absolute De
+0000c600: 7669 6174 696f 6e20 6f66 2064 6174 610a  viation of data.
+0000c610: 2020 2020 2222 220a 2020 2020 6966 206e      """.    if n
+0000c620: 6f74 206e 702e 6d61 2e69 735f 6d61 736b  ot np.ma.is_mask
+0000c630: 6564 2861 7272 293a 0a20 2020 2020 2020  ed(arr):.       
+0000c640: 206d 6564 203d 206e 702e 6d65 6469 616e   med = np.median
+0000c650: 2861 7272 290a 2020 2020 2020 2020 6461  (arr).        da
+0000c660: 7461 203d 206e 702e 6d65 6469 616e 286e  ta = np.median(n
+0000c670: 702e 6162 7328 6172 7220 2d20 6d65 6429  p.abs(arr - med)
+0000c680: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+0000c690: 2020 2020 6d65 6420 3d20 6e70 2e6d 612e      med = np.ma.
+0000c6a0: 6d65 6469 616e 2861 7272 290a 2020 2020  median(arr).    
+0000c6b0: 2020 2020 6461 7461 203d 206e 702e 6d61      data = np.ma
+0000c6c0: 2e6d 6564 6961 6e28 6e70 2e6d 612e 6162  .median(np.ma.ab
+0000c6d0: 7328 6172 7220 2d20 6d65 6429 290a 2020  s(arr - med)).  
+0000c6e0: 2020 7265 7475 726e 2064 6174 610a 0a0a    return data...
+0000c6f0: 6465 6620 6465 7472 656e 6428 6461 7461  def detrend(data
+0000c700: 293a 0a20 2020 2022 2222 0a20 2020 2074  ):.    """.    t
+0000c710: 6869 7320 6675 6e63 7469 6f6e 2072 656d  his function rem
+0000c720: 6f76 6573 2074 6865 2073 6967 6e61 6c20  oves the signal 
+0000c730: 7472 656e 6420 6261 7365 6420 6f6e 2051  trend based on Q
+0000c740: 5220 6465 636f 6d70 6f73 696f 6e0a 2020  R decomposion.  
+0000c750: 2020 4e4f 5445 3a20 5152 2069 7320 6120    NOTE: QR is a 
+0000c760: 6c6f 7420 6661 7374 6572 2074 6861 6e20  lot faster than 
+0000c770: 7468 6520 6c65 6173 7420 7371 7561 7265  the least square
+0000c780: 2069 6e76 6572 7369 6f6e 2075 7365 6420   inversion used 
+0000c790: 6279 0a20 2020 2073 6369 7079 2028 616c  by.    scipy (al
+0000c7a0: 736f 2069 6e20 6f62 7370 7929 2e0a 2020  so in obspy)..  
+0000c7b0: 2020 5041 5241 4d45 5445 5253 3a0a 2020    PARAMETERS:.  
+0000c7c0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
+0000c7d0: 2d2d 2d2d 2d2d 2d0a 2020 2020 6461 7461  -------.    data
+0000c7e0: 3a20 696e 7075 7420 6461 7461 206d 6174  : input data mat
+0000c7f0: 7269 780a 2020 2020 5245 5455 524e 533a  rix.    RETURNS:
+0000c800: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
+0000c810: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2064  ----------.    d
+0000c820: 6174 613a 2064 6174 6120 6d61 7472 6978  ata: data matrix
+0000c830: 2077 6974 6820 7472 656e 6420 7265 6d6f   with trend remo
+0000c840: 7665 640a 2020 2020 2222 220a 2020 2020  ved.    """.    
+0000c850: 2320 6e64 6174 6120 3d20 6e70 2e7a 6572  # ndata = np.zer
+0000c860: 6f73 2873 6861 7065 3d64 6174 612e 7368  os(shape=data.sh
+0000c870: 6170 652c 6474 7970 653d 6461 7461 2e64  ape,dtype=data.d
+0000c880: 7479 7065 290a 2020 2020 6966 2064 6174  type).    if dat
+0000c890: 612e 6e64 696d 203d 3d20 313a 0a20 2020  a.ndim == 1:.   
+0000c8a0: 2020 2020 206e 7074 7320 3d20 6461 7461       npts = data
+0000c8b0: 2e73 6861 7065 5b30 5d0a 2020 2020 2020  .shape[0].      
+0000c8c0: 2020 5820 3d20 6e70 2e6f 6e65 7328 286e    X = np.ones((n
+0000c8d0: 7074 732c 2032 2929 0a20 2020 2020 2020  pts, 2)).       
+0000c8e0: 2058 5b3a 2c20 305d 203d 206e 702e 6172   X[:, 0] = np.ar
+0000c8f0: 616e 6765 2830 2c20 6e70 7473 2920 2f20  ange(0, npts) / 
+0000c900: 6e70 7473 0a20 2020 2020 2020 2051 2c20  npts.        Q, 
+0000c910: 5220 3d20 6e70 2e6c 696e 616c 672e 7172  R = np.linalg.qr
+0000c920: 2858 290a 2020 2020 2020 2020 7271 203d  (X).        rq =
+0000c930: 206e 702e 646f 7428 6e70 2e6c 696e 616c   np.dot(np.linal
+0000c940: 672e 696e 7628 5229 2c20 512e 7472 616e  g.inv(R), Q.tran
+0000c950: 7370 6f73 6528 2929 0a20 2020 2020 2020  spose()).       
+0000c960: 2063 6f65 6666 203d 206e 702e 646f 7428   coeff = np.dot(
+0000c970: 7271 2c20 6461 7461 290a 2020 2020 2020  rq, data).      
+0000c980: 2020 6461 7461 203d 2064 6174 6120 2d20    data = data - 
+0000c990: 6e70 2e64 6f74 2858 2c20 636f 6566 6629  np.dot(X, coeff)
+0000c9a0: 0a20 2020 2065 6c69 6620 6461 7461 2e6e  .    elif data.n
+0000c9b0: 6469 6d20 3d3d 2032 3a0a 2020 2020 2020  dim == 2:.      
+0000c9c0: 2020 6e70 7473 203d 2064 6174 612e 7368    npts = data.sh
+0000c9d0: 6170 655b 315d 0a20 2020 2020 2020 2058  ape[1].        X
+0000c9e0: 203d 206e 702e 6f6e 6573 2828 6e70 7473   = np.ones((npts
+0000c9f0: 2c20 3229 290a 2020 2020 2020 2020 585b  , 2)).        X[
+0000ca00: 3a2c 2030 5d20 3d20 6e70 2e61 7261 6e67  :, 0] = np.arang
+0000ca10: 6528 302c 206e 7074 7329 202f 206e 7074  e(0, npts) / npt
+0000ca20: 730a 2020 2020 2020 2020 512c 2052 203d  s.        Q, R =
+0000ca30: 206e 702e 6c69 6e61 6c67 2e71 7228 5829   np.linalg.qr(X)
+0000ca40: 0a20 2020 2020 2020 2072 7120 3d20 6e70  .        rq = np
+0000ca50: 2e64 6f74 286e 702e 6c69 6e61 6c67 2e69  .dot(np.linalg.i
+0000ca60: 6e76 2852 292c 2051 2e74 7261 6e73 706f  nv(R), Q.transpo
+0000ca70: 7365 2829 290a 2020 2020 2020 2020 666f  se()).        fo
+0000ca80: 7220 6969 2069 6e20 7261 6e67 6528 6461  r ii in range(da
+0000ca90: 7461 2e73 6861 7065 5b30 5d29 3a0a 2020  ta.shape[0]):.  
+0000caa0: 2020 2020 2020 2020 2020 636f 6566 6620            coeff 
+0000cab0: 3d20 6e70 2e64 6f74 2872 712c 2064 6174  = np.dot(rq, dat
+0000cac0: 615b 6969 5d29 0a20 2020 2020 2020 2020  a[ii]).         
+0000cad0: 2020 2064 6174 615b 6969 5d20 3d20 6461     data[ii] = da
+0000cae0: 7461 5b69 695d 202d 206e 702e 646f 7428  ta[ii] - np.dot(
+0000caf0: 582c 2063 6f65 6666 290a 2020 2020 7265  X, coeff).    re
+0000cb00: 7475 726e 2064 6174 610a 0a0a 6465 6620  turn data...def 
+0000cb10: 6465 6d65 616e 2864 6174 6129 3a0a 2020  demean(data):.  
+0000cb20: 2020 2222 220a 2020 2020 7468 6973 2066    """.    this f
+0000cb30: 756e 6374 696f 6e20 7265 6d6f 7665 2074  unction remove t
+0000cb40: 6865 206d 6561 6e20 6f66 2074 6865 2073  he mean of the s
+0000cb50: 6967 6e61 6c0a 2020 2020 5041 5241 4d45  ignal.    PARAME
+0000cb60: 5445 5253 3a0a 2020 2020 2d2d 2d2d 2d2d  TERS:.    ------
+0000cb70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
+0000cb80: 2020 2020 6461 7461 3a20 696e 7075 7420      data: input 
+0000cb90: 6461 7461 206d 6174 7269 780a 2020 2020  data matrix.    
+0000cba0: 5245 5455 524e 533a 0a20 2020 202d 2d2d  RETURNS:.    ---
+0000cbb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000cbc0: 2d2d 0a20 2020 2064 6174 613a 2064 6174  --.    data: dat
+0000cbd0: 6120 6d61 7472 6978 2077 6974 6820 6d65  a matrix with me
+0000cbe0: 616e 2072 656d 6f76 6564 0a20 2020 2022  an removed.    "
+0000cbf0: 2222 0a20 2020 2023 206e 6461 7461 203d  "".    # ndata =
+0000cc00: 206e 702e 7a65 726f 7328 7368 6170 653d   np.zeros(shape=
+0000cc10: 6461 7461 2e73 6861 7065 2c64 7479 7065  data.shape,dtype
+0000cc20: 3d64 6174 612e 6474 7970 6529 0a20 2020  =data.dtype).   
+0000cc30: 2069 6620 6461 7461 2e6e 6469 6d20 3d3d   if data.ndim ==
+0000cc40: 2031 3a0a 2020 2020 2020 2020 6461 7461   1:.        data
+0000cc50: 203d 2064 6174 6120 2d20 6e70 2e6d 6561   = data - np.mea
+0000cc60: 6e28 6461 7461 290a 2020 2020 656c 6966  n(data).    elif
+0000cc70: 2064 6174 612e 6e64 696d 203d 3d20 323a   data.ndim == 2:
+0000cc80: 0a20 2020 2020 2020 2066 6f72 2069 6920  .        for ii 
+0000cc90: 696e 2072 616e 6765 2864 6174 612e 7368  in range(data.sh
+0000cca0: 6170 655b 305d 293a 0a20 2020 2020 2020  ape[0]):.       
+0000ccb0: 2020 2020 2064 6174 615b 6969 5d20 3d20       data[ii] = 
+0000ccc0: 6461 7461 5b69 695d 202d 206e 702e 6d65  data[ii] - np.me
+0000ccd0: 616e 2864 6174 615b 6969 5d29 0a20 2020  an(data[ii]).   
+0000cce0: 2072 6574 7572 6e20 6461 7461 0a0a 0a64   return data...d
+0000ccf0: 6566 2074 6170 6572 2864 6174 6129 3a0a  ef taper(data):.
+0000cd00: 2020 2020 2222 220a 2020 2020 7468 6973      """.    this
+0000cd10: 2066 756e 6374 696f 6e20 6170 706c 6965   function applie
+0000cd20: 7320 6120 636f 7369 6e65 2074 6170 6572  s a cosine taper
+0000cd30: 2075 7369 6e67 206f 6273 7079 2066 756e   using obspy fun
+0000cd40: 6374 696f 6e73 0a20 2020 2050 4152 414d  ctions.    PARAM
+0000cd50: 4554 4552 533a 0a20 2020 202d 2d2d 2d2d  ETERS:.    -----
+0000cd60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000cd70: 0a20 2020 2064 6174 613a 2069 6e70 7574  .    data: input
+0000cd80: 2064 6174 6120 6d61 7472 6978 0a20 2020   data matrix.   
+0000cd90: 2052 4554 5552 4e53 3a0a 2020 2020 2d2d   RETURNS:.    --
+0000cda0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000cdb0: 2d2d 2d0a 2020 2020 6461 7461 3a20 6461  ---.    data: da
+0000cdc0: 7461 206d 6174 7269 7820 7769 7468 2074  ta matrix with t
+0000cdd0: 6170 6572 2061 7070 6c69 6564 0a20 2020  aper applied.   
+0000cde0: 2022 2222 0a20 2020 2023 206e 6461 7461   """.    # ndata
+0000cdf0: 203d 206e 702e 7a65 726f 7328 7368 6170   = np.zeros(shap
+0000ce00: 653d 6461 7461 2e73 6861 7065 2c64 7479  e=data.shape,dty
+0000ce10: 7065 3d64 6174 612e 6474 7970 6529 0a20  pe=data.dtype). 
+0000ce20: 2020 2069 6620 6461 7461 2e6e 6469 6d20     if data.ndim 
+0000ce30: 3d3d 2031 3a0a 2020 2020 2020 2020 6e70  == 1:.        np
+0000ce40: 7473 203d 2064 6174 612e 7368 6170 655b  ts = data.shape[
+0000ce50: 305d 0a20 2020 2020 2020 2023 2077 696e  0].        # win
+0000ce60: 646f 7720 6c65 6e67 7468 0a20 2020 2020  dow length.     
+0000ce70: 2020 2069 6620 6e70 7473 202a 2030 2e30     if npts * 0.0
+0000ce80: 3520 3e20 3230 3a0a 2020 2020 2020 2020  5 > 20:.        
+0000ce90: 2020 2020 776c 656e 203d 2032 300a 2020      wlen = 20.  
+0000cea0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000ceb0: 2020 2020 2020 2020 776c 656e 203d 206e          wlen = n
+0000cec0: 7074 7320 2a20 302e 3035 0a20 2020 2020  pts * 0.05.     
+0000ced0: 2020 2023 2074 6170 6572 2076 616c 7565     # taper value
+0000cee0: 730a 2020 2020 2020 2020 6675 6e63 203d  s.        func =
+0000cef0: 205f 6765 745f 6675 6e63 7469 6f6e 5f66   _get_function_f
+0000cf00: 726f 6d5f 656e 7472 795f 706f 696e 7428  rom_entry_point(
+0000cf10: 2274 6170 6572 222c 2022 6861 6e6e 2229  "taper", "hann")
+0000cf20: 0a20 2020 2020 2020 2069 6620 3220 2a20  .        if 2 * 
+0000cf30: 776c 656e 203d 3d20 6e70 7473 3a0a 2020  wlen == npts:.  
+0000cf40: 2020 2020 2020 2020 2020 7461 7065 725f            taper_
+0000cf50: 7369 6465 7320 3d20 6675 6e63 2832 202a  sides = func(2 *
+0000cf60: 2077 6c65 6e29 0a20 2020 2020 2020 2065   wlen).        e
+0000cf70: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000cf80: 2074 6170 6572 5f73 6964 6573 203d 2066   taper_sides = f
+0000cf90: 756e 6328 3220 2a20 776c 656e 202b 2031  unc(2 * wlen + 1
+0000cfa0: 290a 2020 2020 2020 2020 2320 7461 7065  ).        # tape
+0000cfb0: 7220 7769 6e64 6f77 0a20 2020 2020 2020  r window.       
+0000cfc0: 2077 696e 203d 206e 702e 6873 7461 636b   win = np.hstack
+0000cfd0: 280a 2020 2020 2020 2020 2020 2020 280a  (.            (.
+0000cfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cff0: 7461 7065 725f 7369 6465 735b 3a77 6c65  taper_sides[:wle
+0000d000: 6e5d 2c0a 2020 2020 2020 2020 2020 2020  n],.            
+0000d010: 2020 2020 6e70 2e6f 6e65 7328 6e70 7473      np.ones(npts
+0000d020: 202d 2032 202a 2077 6c65 6e29 2c0a 2020   - 2 * wlen),.  
+0000d030: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+0000d040: 7065 725f 7369 6465 735b 6c65 6e28 7461  per_sides[len(ta
+0000d050: 7065 725f 7369 6465 7329 202d 2077 6c65  per_sides) - wle
+0000d060: 6e20 3a5d 2c0a 2020 2020 2020 2020 2020  n :],.          
+0000d070: 2020 290a 2020 2020 2020 2020 290a 2020    ).        ).  
+0000d080: 2020 2020 2020 6461 7461 202a 3d20 7769        data *= wi
+0000d090: 6e0a 2020 2020 656c 6966 2064 6174 612e  n.    elif data.
+0000d0a0: 6e64 696d 203d 3d20 323a 0a20 2020 2020  ndim == 2:.     
+0000d0b0: 2020 206e 7074 7320 3d20 6461 7461 2e73     npts = data.s
+0000d0c0: 6861 7065 5b31 5d0a 2020 2020 2020 2020  hape[1].        
+0000d0d0: 2320 7769 6e64 6f77 206c 656e 6774 680a  # window length.
+0000d0e0: 2020 2020 2020 2020 6966 206e 7074 7320          if npts 
+0000d0f0: 2a20 302e 3035 203e 2032 303a 0a20 2020  * 0.05 > 20:.   
+0000d100: 2020 2020 2020 2020 2077 6c65 6e20 3d20           wlen = 
+0000d110: 3230 0a20 2020 2020 2020 2065 6c73 653a  20.        else:
+0000d120: 0a20 2020 2020 2020 2020 2020 2077 6c65  .            wle
+0000d130: 6e20 3d20 6e70 7473 202a 2030 2e30 350a  n = npts * 0.05.
+0000d140: 2020 2020 2020 2020 2320 7461 7065 7220          # taper 
+0000d150: 7661 6c75 6573 0a20 2020 2020 2020 2066  values.        f
+0000d160: 756e 6320 3d20 5f67 6574 5f66 756e 6374  unc = _get_funct
+0000d170: 696f 6e5f 6672 6f6d 5f65 6e74 7279 5f70  ion_from_entry_p
+0000d180: 6f69 6e74 2822 7461 7065 7222 2c20 2268  oint("taper", "h
+0000d190: 616e 6e22 290a 2020 2020 2020 2020 6966  ann").        if
+0000d1a0: 2032 202a 2077 6c65 6e20 3d3d 206e 7074   2 * wlen == npt
+0000d1b0: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
+0000d1c0: 6170 6572 5f73 6964 6573 203d 2066 756e  aper_sides = fun
+0000d1d0: 6328 3220 2a20 776c 656e 290a 2020 2020  c(2 * wlen).    
+0000d1e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000d1f0: 2020 2020 2020 7461 7065 725f 7369 6465        taper_side
+0000d200: 7320 3d20 6675 6e63 2832 202a 2077 6c65  s = func(2 * wle
+0000d210: 6e20 2b20 3129 0a20 2020 2020 2020 2023  n + 1).        #
+0000d220: 2074 6170 6572 2077 696e 646f 770a 2020   taper window.  
+0000d230: 2020 2020 2020 7769 6e20 3d20 6e70 2e68        win = np.h
+0000d240: 7374 6163 6b28 0a20 2020 2020 2020 2020  stack(.         
+0000d250: 2020 2028 0a20 2020 2020 2020 2020 2020     (.           
+0000d260: 2020 2020 2074 6170 6572 5f73 6964 6573       taper_sides
+0000d270: 5b3a 776c 656e 5d2c 0a20 2020 2020 2020  [:wlen],.       
+0000d280: 2020 2020 2020 2020 206e 702e 6f6e 6573           np.ones
+0000d290: 286e 7074 7320 2d20 3220 2a20 776c 656e  (npts - 2 * wlen
+0000d2a0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0000d2b0: 2020 2074 6170 6572 5f73 6964 6573 5b6c     taper_sides[l
+0000d2c0: 656e 2874 6170 6572 5f73 6964 6573 2920  en(taper_sides) 
+0000d2d0: 2d20 776c 656e 203a 5d2c 0a20 2020 2020  - wlen :],.     
+0000d2e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000d2f0: 2029 0a20 2020 2020 2020 2066 6f72 2069   ).        for i
+0000d300: 6920 696e 2072 616e 6765 2864 6174 612e  i in range(data.
+0000d310: 7368 6170 655b 305d 293a 0a20 2020 2020  shape[0]):.     
+0000d320: 2020 2020 2020 2064 6174 615b 6969 5d20         data[ii] 
+0000d330: 2a3d 2077 696e 0a20 2020 2072 6574 7572  *= win.    retur
+0000d340: 6e20 6461 7461 0a0a 0a23 2040 6a69 7428  n data...# @jit(
+0000d350: 6e6f 7079 7468 6f6e 203d 2054 7275 6529  nopython = True)
+0000d360: 0a0a 0a23 2063 6861 6e67 6520 7468 6520  ...# change the 
+0000d370: 6d6f 7669 6e67 2061 7665 7261 6765 2063  moving average c
+0000d380: 616c 6375 6c61 7469 6f6e 2074 6f20 7461  alculation to ta
+0000d390: 6b65 2061 7320 696e 7075 7420 4e20 7468  ke as input N th
+0000d3a0: 6520 6675 6c6c 2077 696e 646f 7720 6c65  e full window le
+0000d3b0: 6e67 7468 2074 6f20 736d 6f6f 7468 0a64  ngth to smooth.d
+0000d3c0: 6566 206d 6f76 696e 675f 6176 6528 412c  ef moving_ave(A,
+0000d3d0: 204e 293a 0a20 2020 2022 2222 0a20 2020   N):.    """.   
+0000d3e0: 2041 6c74 6572 6e61 7469 7665 2066 756e   Alternative fun
+0000d3f0: 6374 696f 6e20 666f 7220 6d6f 7669 6e67  ction for moving
+0000d400: 2061 7665 7261 6765 2066 6f72 2061 6e20   average for an 
+0000d410: 6172 7261 792e 0a20 2020 2050 4152 414d  array..    PARAM
+0000d420: 4554 4552 533a 0a20 2020 202d 2d2d 2d2d  ETERS:.    -----
+0000d430: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000d440: 0a20 2020 2041 3a20 312d 4420 6172 7261  .    A: 1-D arra
+0000d450: 7920 6f66 2064 6174 6120 746f 2062 6520  y of data to be 
+0000d460: 736d 6f6f 7468 6564 0a20 2020 204e 3a20  smoothed.    N: 
+0000d470: 696e 7465 6765 722c 2069 7420 6465 6669  integer, it defi
+0000d480: 6e65 7320 7468 6520 6675 6c6c 2121 2077  nes the full!! w
+0000d490: 696e 646f 7720 6c65 6e67 7468 2074 6f20  indow length to 
+0000d4a0: 736d 6f6f 7468 0a20 2020 2052 4554 5552  smooth.    RETUR
+0000d4b0: 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  NS:.    --------
+0000d4c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
+0000d4d0: 2020 423a 2031 2d44 2061 7272 6179 2077    B: 1-D array w
+0000d4e0: 6974 6820 736d 6f6f 7468 6564 2064 6174  ith smoothed dat
+0000d4f0: 610a 2020 2020 2222 220a 2020 2020 2320  a.    """.    # 
+0000d500: 6465 6669 6e65 7320 616e 2061 7272 6179  defines an array
+0000d510: 2077 6974 6820 4e20 6578 7472 6120 7361   with N extra sa
+0000d520: 6d70 6c65 7320 6174 2065 6974 6865 7220  mples at either 
+0000d530: 7369 6465 0a20 2020 2074 656d 7020 3d20  side.    temp = 
+0000d540: 6e70 2e7a 6572 6f73 286c 656e 2841 2920  np.zeros(len(A) 
+0000d550: 2b20 3220 2a20 4e29 0a20 2020 2023 2073  + 2 * N).    # s
+0000d560: 6574 2074 6865 2063 656e 7472 616c 2070  et the central p
+0000d570: 6f72 7469 6f6e 206f 6620 7468 6520 6172  ortion of the ar
+0000d580: 7261 7920 746f 2041 0a20 2020 2074 656d  ray to A.    tem
+0000d590: 705b 4e3a 2d4e 5d20 3d20 410a 2020 2020  p[N:-N] = A.    
+0000d5a0: 2320 6c65 6164 696e 6720 7361 6d70 6c65  # leading sample
+0000d5b0: 733a 2065 7175 616c 2074 6f20 6669 7273  s: equal to firs
+0000d5c0: 7420 7361 6d70 6c65 206f 6620 6163 7475  t sample of actu
+0000d5d0: 616c 2061 7272 6179 0a20 2020 2074 656d  al array.    tem
+0000d5e0: 705b 303a 4e5d 203d 2074 656d 705b 4e5d  p[0:N] = temp[N]
+0000d5f0: 0a20 2020 2023 2074 7261 696c 696e 6720  .    # trailing 
+0000d600: 7361 6d70 6c65 733a 2045 7175 616c 2074  samples: Equal t
+0000d610: 6f20 6c61 7374 2073 616d 706c 6520 6f66  o last sample of
+0000d620: 2061 6374 7561 6c20 6172 7261 790a 2020   actual array.  
+0000d630: 2020 7465 6d70 5b2d 4e3a 5d20 3d20 7465    temp[-N:] = te
+0000d640: 6d70 5b2d 4e20 2d20 315d 0a20 2020 2023  mp[-N - 1].    #
+0000d650: 2063 6f6e 766f 6c76 6520 7769 7468 2061   convolve with a
+0000d660: 2062 6f78 6361 7220 616e 6420 6e6f 726d   boxcar and norm
+0000d670: 616c 697a 652c 2061 6e64 2075 7365 206f  alize, and use o
+0000d680: 6e6c 7920 6365 6e74 7261 6c20 706f 7274  nly central port
+0000d690: 696f 6e20 6f66 2074 6865 2072 6573 756c  ion of the resul
+0000d6a0: 740a 2020 2020 2320 7769 7468 206c 656e  t.    # with len
+0000d6b0: 6774 6820 6571 7561 6c20 746f 2074 6865  gth equal to the
+0000d6c0: 206f 7269 6769 6e61 6c20 6172 7261 792c   original array,
+0000d6d0: 2064 6973 6361 7264 696e 6720 7468 6520   discarding the 
+0000d6e0: 6164 6465 6420 6c65 6164 696e 6720 616e  added leading an
+0000d6f0: 6420 7472 6169 6c69 6e67 2073 616d 706c  d trailing sampl
+0000d700: 6573 0a20 2020 2042 203d 206e 702e 636f  es.    B = np.co
+0000d710: 6e76 6f6c 7665 2874 656d 702c 206e 702e  nvolve(temp, np.
+0000d720: 6f6e 6573 284e 2920 2f20 4e2c 206d 6f64  ones(N) / N, mod
+0000d730: 653d 2273 616d 6522 295b 4e3a 2d4e 5d0a  e="same")[N:-N].
+0000d740: 2020 2020 7265 7475 726e 2042 0a0a 0a23      return B...#
+0000d750: 2063 6861 6e67 6520 7468 6520 6d6f 7669   change the movi
+0000d760: 6e67 2061 7665 7261 6765 2063 616c 6375  ng average calcu
+0000d770: 6c61 7469 6f6e 2074 6f20 7461 6b65 2061  lation to take a
+0000d780: 7320 696e 7075 7420 4e20 7468 6520 6675  s input N the fu
+0000d790: 6c6c 2077 696e 646f 7720 6c65 6e67 7468  ll window length
+0000d7a0: 2074 6f20 736d 6f6f 7468 0a64 6566 206d   to smooth.def m
+0000d7b0: 6f76 696e 675f 6176 655f 3244 2841 2c20  oving_ave_2D(A, 
+0000d7c0: 4e29 3a0a 2020 2020 2222 220a 2020 2020  N):.    """.    
+0000d7d0: 416c 7465 726e 6174 6976 6520 6675 6e63  Alternative func
+0000d7e0: 7469 6f6e 2066 6f72 206d 6f76 696e 6720  tion for moving 
+0000d7f0: 6176 6572 6167 6520 666f 7220 616e 2061  average for an a
+0000d800: 7272 6179 2e0a 2020 2020 5041 5241 4d45  rray..    PARAME
+0000d810: 5445 5253 3a0a 2020 2020 2d2d 2d2d 2d2d  TERS:.    ------
+0000d820: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
+0000d830: 2020 2020 413a 2032 2d44 2061 7272 6179      A: 2-D array
+0000d840: 206f 6620 6461 7461 2074 6f20 6265 2073   of data to be s
+0000d850: 6d6f 6f74 6865 640a 2020 2020 4e3a 2069  moothed.    N: i
+0000d860: 6e74 6567 6572 2c20 6974 2064 6566 696e  nteger, it defin
+0000d870: 6573 2074 6865 2066 756c 6c21 2120 7769  es the full!! wi
+0000d880: 6e64 6f77 206c 656e 6774 6820 746f 2073  ndow length to s
+0000d890: 6d6f 6f74 680a 2020 2020 5245 5455 524e  mooth.    RETURN
+0000d8a0: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
+0000d8b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
+0000d8c0: 2042 3a20 322d 4420 6172 7261 7920 7769   B: 2-D array wi
+0000d8d0: 7468 2073 6d6f 6f74 6865 6420 6461 7461  th smoothed data
+0000d8e0: 0a20 2020 2022 2222 0a20 2020 206e 7463  .    """.    ntc
+0000d8f0: 2c20 6e73 7074 203d 2041 2e73 6861 7065  , nspt = A.shape
+0000d900: 0a20 2020 2023 2064 6566 696e 6573 2061  .    # defines a
+0000d910: 6e20 6172 7261 7920 7769 7468 204e 2065  n array with N e
+0000d920: 7874 7261 2073 616d 706c 6573 2061 7420  xtra samples at 
+0000d930: 6569 7468 6572 2073 6964 650a 2020 2020  either side.    
+0000d940: 7465 6d70 203d 206e 702e 7a65 726f 7328  temp = np.zeros(
+0000d950: 5b6e 7463 2c20 6e73 7074 202b 2032 202a  [ntc, nspt + 2 *
+0000d960: 204e 5d29 0a20 2020 2023 2073 6574 2074   N]).    # set t
+0000d970: 6865 2063 656e 7472 616c 2070 6f72 7469  he central porti
+0000d980: 6f6e 206f 6620 7468 6520 6172 7261 7920  on of the array 
+0000d990: 746f 2041 0a20 2020 2074 656d 705b 3a2c  to A.    temp[:,
+0000d9a0: 204e 3a2d 4e5d 203d 2041 0a20 2020 2023   N:-N] = A.    #
+0000d9b0: 206c 6561 6469 6e67 2073 616d 706c 6573   leading samples
+0000d9c0: 3a20 6571 7561 6c20 746f 2066 6972 7374  : equal to first
+0000d9d0: 2073 616d 706c 6520 6f66 2061 6374 7561   sample of actua
+0000d9e0: 6c20 6172 7261 790a 2020 2020 7465 6d70  l array.    temp
+0000d9f0: 5b3a 2c20 303a 4e5d 203d 206e 702e 7265  [:, 0:N] = np.re
+0000da00: 7065 6174 286e 702e 6578 7061 6e64 5f64  peat(np.expand_d
+0000da10: 696d 7328 7465 6d70 5b3a 2c20 4e5d 2c20  ims(temp[:, N], 
+0000da20: 6178 6973 3d2d 3129 2c20 4e2c 2061 7869  axis=-1), N, axi
+0000da30: 733d 2d31 290a 2020 2020 2320 7472 6169  s=-1).    # trai
+0000da40: 6c69 6e67 2073 616d 706c 6573 3a20 4571  ling samples: Eq
+0000da50: 7561 6c20 746f 206c 6173 7420 7361 6d70  ual to last samp
+0000da60: 6c65 206f 6620 6163 7475 616c 2061 7272  le of actual arr
+0000da70: 6179 0a20 2020 2074 656d 705b 3a2c 202d  ay.    temp[:, -
+0000da80: 4e3a 5d20 3d20 6e70 2e72 6570 6561 7428  N:] = np.repeat(
+0000da90: 6e70 2e65 7870 616e 645f 6469 6d73 2874  np.expand_dims(t
+0000daa0: 656d 705b 3a2c 202d 4e20 2d20 315d 2c20  emp[:, -N - 1], 
+0000dab0: 6178 6973 3d2d 3129 2c20 4e2c 2061 7869  axis=-1), N, axi
+0000dac0: 733d 2d31 290a 2020 2020 2320 636f 6e76  s=-1).    # conv
+0000dad0: 6f6c 7665 2077 6974 6820 6120 626f 7863  olve with a boxc
+0000dae0: 6172 2061 6e64 206e 6f72 6d61 6c69 7a65  ar and normalize
+0000daf0: 2c20 616e 6420 7573 6520 6f6e 6c79 2063  , and use only c
+0000db00: 656e 7472 616c 2070 6f72 7469 6f6e 206f  entral portion o
+0000db10: 6620 7468 6520 7265 7375 6c74 0a20 2020  f the result.   
+0000db20: 2023 2077 6974 6820 6c65 6e67 7468 2065   # with length e
+0000db30: 7175 616c 2074 6f20 7468 6520 6f72 6967  qual to the orig
+0000db40: 696e 616c 2061 7272 6179 2c20 6469 7363  inal array, disc
+0000db50: 6172 6469 6e67 2074 6865 2061 6464 6564  arding the added
+0000db60: 206c 6561 6469 6e67 2061 6e64 2074 7261   leading and tra
+0000db70: 696c 696e 6720 7361 6d70 6c65 730a 2020  iling samples.  
+0000db80: 2020 4220 3d20 7363 6970 792e 7369 676e    B = scipy.sign
+0000db90: 616c 2e63 6f6e 766f 6c76 6532 6428 7465  al.convolve2d(te
+0000dba0: 6d70 2c20 6e70 2e65 7870 616e 645f 6469  mp, np.expand_di
+0000dbb0: 6d73 286e 702e 6f6e 6573 284e 2920 2f20  ms(np.ones(N) / 
+0000dbc0: 4e2c 2061 7869 733d 3029 2c20 6d6f 6465  N, axis=0), mode
+0000dbd0: 3d22 7361 6d65 2229 5b3a 2c20 4e3a 2d4e  ="same")[:, N:-N
+0000dbe0: 5d0a 2020 2020 7265 7475 726e 2042 0a0a  ].    return B..
+0000dbf0: 0a64 6566 2072 6f62 7573 745f 7374 6163  .def robust_stac
+0000dc00: 6b28 6363 5f61 7272 6179 2c20 6570 7369  k(cc_array, epsi
+0000dc10: 6c6f 6e29 3a0a 2020 2020 2222 220a 2020  lon):.    """.  
+0000dc20: 2020 7468 6973 2069 7320 6120 726f 6275    this is a robu
+0000dc30: 7374 2073 7461 636b 696e 6720 616c 676f  st stacking algo
+0000dc40: 7269 7468 6d20 6465 7363 7269 6265 6420  rithm described 
+0000dc50: 696e 2050 616c 7669 7320 616e 6420 5665  in Palvis and Ve
+0000dc60: 726e 6f6e 2032 3031 300a 0a20 2020 2050  rnon 2010..    P
+0000dc70: 4152 414d 4554 4552 533a 0a20 2020 202d  ARAMETERS:.    -
+0000dc80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000dc90: 2d2d 2d2d 2d0a 2020 2020 6363 5f61 7272  -----.    cc_arr
+0000dca0: 6179 3a20 6e75 6d70 792e 6e64 6172 7261  ay: numpy.ndarra
+0000dcb0: 7920 636f 6e74 6169 6e73 2074 6865 2032  y contains the 2
+0000dcc0: 4420 6372 6f73 7320 636f 7272 656c 6174  D cross correlat
+0000dcd0: 696f 6e20 6d61 7472 6978 0a20 2020 2065  ion matrix.    e
+0000dce0: 7073 696c 6f6e 3a20 7265 7369 6475 616c  psilon: residual
+0000dcf0: 2074 6872 6568 6f6c 6420 746f 2071 7569   threhold to qui
+0000dd00: 7420 7468 6520 6974 6572 6174 696f 6e0a  t the iteration.
+0000dd10: 2020 2020 5245 5455 524e 533a 0a20 2020      RETURNS:.   
+0000dd20: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
+0000dd30: 2d2d 2d2d 2d2d 2d0a 2020 2020 6e65 7773  -------.    news
+0000dd40: 7461 636b 3a20 6e75 6d70 7920 7665 6374  tack: numpy vect
+0000dd50: 6f72 2063 6f6e 7461 696e 7320 7468 6520  or contains the 
+0000dd60: 7374 6163 6b65 6420 6372 6f73 7320 636f  stacked cross co
+0000dd70: 7272 656c 6174 696f 6e0a 0a20 2020 2057  rrelation..    W
+0000dd80: 7269 7474 656e 2062 7920 4d61 7269 6e65  ritten by Marine
+0000dd90: 2044 656e 6f6c 6c65 0a20 2020 2022 2222   Denolle.    """
+0000dda0: 0a20 2020 2072 6573 203d 2039 6539 2020  .    res = 9e9  
+0000ddb0: 2320 7265 7369 6475 616c 730a 2020 2020  # residuals.    
+0000ddc0: 7720 3d20 6e70 2e6f 6e65 7328 6363 5f61  w = np.ones(cc_a
+0000ddd0: 7272 6179 2e73 6861 7065 5b30 5d29 0a20  rray.shape[0]). 
+0000dde0: 2020 206e 7374 6570 203d 2030 0a20 2020     nstep = 0.   
+0000ddf0: 206e 6577 7374 6163 6b20 3d20 6e70 2e6d   newstack = np.m
+0000de00: 6564 6961 6e28 6363 5f61 7272 6179 2c20  edian(cc_array, 
+0000de10: 6178 6973 3d30 290a 2020 2020 7768 696c  axis=0).    whil
+0000de20: 6520 7265 7320 3e20 6570 7369 6c6f 6e3a  e res > epsilon:
+0000de30: 0a20 2020 2020 2020 2073 7461 636b 203d  .        stack =
+0000de40: 206e 6577 7374 6163 6b0a 2020 2020 2020   newstack.      
+0000de50: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+0000de60: 2863 635f 6172 7261 792e 7368 6170 655b  (cc_array.shape[
+0000de70: 305d 293a 0a20 2020 2020 2020 2020 2020  0]):.           
+0000de80: 2063 7261 7020 3d20 6e70 2e6d 756c 7469   crap = np.multi
+0000de90: 706c 7928 7374 6163 6b2c 2063 635f 6172  ply(stack, cc_ar
+0000dea0: 7261 795b 692c 203a 5d2e 5429 0a20 2020  ray[i, :].T).   
+0000deb0: 2020 2020 2020 2020 2063 7261 705f 646f           crap_do
+0000dec0: 7420 3d20 6e70 2e73 756d 2863 7261 7029  t = np.sum(crap)
+0000ded0: 0a20 2020 2020 2020 2020 2020 2064 695f  .            di_
+0000dee0: 6e6f 726d 203d 206e 702e 6c69 6e61 6c67  norm = np.linalg
+0000def0: 2e6e 6f72 6d28 6363 5f61 7272 6179 5b69  .norm(cc_array[i
+0000df00: 2c20 3a5d 290a 2020 2020 2020 2020 2020  , :]).          
+0000df10: 2020 7269 203d 2063 635f 6172 7261 795b    ri = cc_array[
+0000df20: 692c 203a 5d20 2d20 6372 6170 5f64 6f74  i, :] - crap_dot
+0000df30: 202a 2073 7461 636b 0a20 2020 2020 2020   * stack.       
+0000df40: 2020 2020 2072 695f 6e6f 726d 203d 206e       ri_norm = n
+0000df50: 702e 6c69 6e61 6c67 2e6e 6f72 6d28 7269  p.linalg.norm(ri
+0000df60: 290a 2020 2020 2020 2020 2020 2020 775b  ).            w[
+0000df70: 695d 203d 206e 702e 6162 7328 6372 6170  i] = np.abs(crap
+0000df80: 5f64 6f74 2920 2f20 6469 5f6e 6f72 6d20  _dot) / di_norm 
+0000df90: 2f20 7269 5f6e 6f72 6d20 2023 202f 6c65  / ri_norm  # /le
+0000dfa0: 6e28 6363 5f61 7272 6179 5b3a 2c31 5d29  n(cc_array[:,1])
+0000dfb0: 0a20 2020 2020 2020 2023 2070 7269 6e74  .        # print
+0000dfc0: 2877 290a 2020 2020 2020 2020 7720 3d20  (w).        w = 
+0000dfd0: 7720 2f20 6e70 2e73 756d 2877 290a 2020  w / np.sum(w).  
+0000dfe0: 2020 2020 2020 6e65 7773 7461 636b 203d        newstack =
+0000dff0: 206e 702e 7375 6d28 2877 202a 2063 635f   np.sum((w * cc_
+0000e000: 6172 7261 792e 5429 2e54 2c20 6178 6973  array.T).T, axis
+0000e010: 3d30 2920 2023 202f 6c65 6e28 6363 5f61  =0)  # /len(cc_a
+0000e020: 7272 6179 5b3a 2c31 5d29 0a20 2020 2020  rray[:,1]).     
+0000e030: 2020 2072 6573 203d 206e 702e 6c69 6e61     res = np.lina
+0000e040: 6c67 2e6e 6f72 6d28 6e65 7773 7461 636b  lg.norm(newstack
+0000e050: 202d 2073 7461 636b 2c20 6f72 643d 3129   - stack, ord=1)
+0000e060: 202f 206e 702e 6c69 6e61 6c67 2e6e 6f72   / np.linalg.nor
+0000e070: 6d28 6e65 7773 7461 636b 2920 2f20 6c65  m(newstack) / le
+0000e080: 6e28 6363 5f61 7272 6179 5b3a 2c20 315d  n(cc_array[:, 1]
+0000e090: 290a 2020 2020 2020 2020 6e73 7465 7020  ).        nstep 
+0000e0a0: 2b3d 2031 0a20 2020 2020 2020 2069 6620  += 1.        if 
+0000e0b0: 6e73 7465 7020 3e20 3130 3a0a 2020 2020  nstep > 10:.    
+0000e0c0: 2020 2020 2020 2020 7265 7475 726e 206e          return n
+0000e0d0: 6577 7374 6163 6b2c 2077 2c20 6e73 7465  ewstack, w, nste
+0000e0e0: 700a 2020 2020 7265 7475 726e 206e 6577  p.    return new
+0000e0f0: 7374 6163 6b2c 2077 2c20 6e73 7465 700a  stack, w, nstep.
+0000e100: 0a0a 6465 6620 7365 6c65 6374 6976 655f  ..def selective_
+0000e110: 7374 6163 6b28 6363 5f61 7272 6179 2c20  stack(cc_array, 
+0000e120: 6570 7369 6c6f 6e29 3a0a 2020 2020 2222  epsilon):.    ""
+0000e130: 220a 2020 2020 7468 6973 2069 7320 6120  ".    this is a 
+0000e140: 7365 6c65 6374 6976 6520 7374 6163 6b69  selective stacki
+0000e150: 6e67 2061 6c67 6f72 6974 686d 2064 6576  ng algorithm dev
+0000e160: 656c 6f70 6564 2062 7920 4a61 7265 6420  eloped by Jared 
+0000e170: 4272 7961 6e2e 0a0a 2020 2020 5041 5241  Bryan...    PARA
+0000e180: 4d45 5445 5253 3a0a 2020 2020 2d2d 2d2d  METERS:.    ----
+0000e190: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000e1a0: 2d2d 0a20 2020 2063 635f 6172 7261 793a  --.    cc_array:
+0000e1b0: 206e 756d 7079 2e6e 6461 7272 6179 2063   numpy.ndarray c
+0000e1c0: 6f6e 7461 696e 7320 7468 6520 3244 2063  ontains the 2D c
+0000e1d0: 726f 7373 2063 6f72 7265 6c61 7469 6f6e  ross correlation
+0000e1e0: 206d 6174 7269 780a 2020 2020 6570 7369   matrix.    epsi
+0000e1f0: 6c6f 6e3a 2072 6573 6964 7561 6c20 7468  lon: residual th
+0000e200: 7265 686f 6c64 2074 6f20 7175 6974 2074  rehold to quit t
+0000e210: 6865 2069 7465 7261 7469 6f6e 0a20 2020  he iteration.   
+0000e220: 2052 4554 5552 4e53 3a0a 2020 2020 2d2d   RETURNS:.    --
+0000e230: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000e240: 2d2d 2d2d 0a20 2020 206e 6577 7374 6163  ----.    newstac
+0000e250: 6b3a 206e 756d 7079 2076 6563 746f 7220  k: numpy vector 
+0000e260: 636f 6e74 6169 6e73 2074 6865 2073 7461  contains the sta
+0000e270: 636b 6564 2063 726f 7373 2063 6f72 7265  cked cross corre
+0000e280: 6c61 7469 6f6e 0a0a 2020 2020 5772 6974  lation..    Writ
+0000e290: 7465 6e20 6279 204d 6172 696e 6520 4465  ten by Marine De
+0000e2a0: 6e6f 6c6c 650a 2020 2020 2222 220a 2020  nolle.    """.  
+0000e2b0: 2020 6363 203d 206e 702e 6f6e 6573 2863    cc = np.ones(c
+0000e2c0: 635f 6172 7261 792e 7368 6170 655b 305d  c_array.shape[0]
+0000e2d0: 290a 2020 2020 6e65 7773 7461 636b 203d  ).    newstack =
+0000e2e0: 206e 702e 6d65 616e 2863 635f 6172 7261   np.mean(cc_arra
+0000e2f0: 792c 2061 7869 733d 3029 0a20 2020 2066  y, axis=0).    f
+0000e300: 6f72 2069 2069 6e20 7261 6e67 6528 6363  or i in range(cc
+0000e310: 5f61 7272 6179 2e73 6861 7065 5b30 5d29  _array.shape[0])
+0000e320: 3a0a 2020 2020 2020 2020 6363 5b69 5d20  :.        cc[i] 
+0000e330: 3d20 6e70 2e73 756d 286e 702e 6d75 6c74  = np.sum(np.mult
+0000e340: 6970 6c79 286e 6577 7374 6163 6b2c 2063  iply(newstack, c
+0000e350: 635f 6172 7261 795b 692c 203a 5d2e 5429  c_array[i, :].T)
+0000e360: 290a 2020 2020 696b 203d 206e 702e 7768  ).    ik = np.wh
+0000e370: 6572 6528 6363 203e 3d20 6570 7369 6c6f  ere(cc >= epsilo
+0000e380: 6e29 5b30 5d0a 2020 2020 6e65 7773 7461  n)[0].    newsta
+0000e390: 636b 203d 206e 702e 6d65 616e 2863 635f  ck = np.mean(cc_
+0000e3a0: 6172 7261 795b 696b 2c20 3a5d 2c20 6178  array[ik, :], ax
+0000e3b0: 6973 3d30 290a 0a20 2020 2072 6574 7572  is=0)..    retur
+0000e3c0: 6e20 6e65 7773 7461 636b 2c20 6363 0a0a  n newstack, cc..
+0000e3d0: 0a64 6566 2077 6869 7465 6e5f 3144 2874  .def whiten_1D(t
+0000e3e0: 696d 6573 6572 6965 732c 2066 6674 5f70  imeseries, fft_p
+0000e3f0: 6172 612c 206e 5f74 6170 6572 293a 0a20  ara, n_taper):. 
+0000e400: 2020 2022 2222 0a20 2020 2054 6869 7320     """.    This 
+0000e410: 6675 6e63 7469 6f6e 2074 616b 6573 2061  function takes a
+0000e420: 2031 2d64 696d 656e 7369 6f6e 616c 2074   1-dimensional t
+0000e430: 696d 6573 6572 6965 7320 6172 7261 792c  imeseries array,
+0000e440: 2074 7261 6e73 666f 726d 7320 746f 2066   transforms to f
+0000e450: 7265 7175 656e 6379 2064 6f6d 6169 6e20  requency domain 
+0000e460: 7573 696e 6720 6666 742c 0a20 2020 2077  using fft,.    w
+0000e470: 6869 7465 6e73 2074 6865 2061 6d70 6c69  hitens the ampli
+0000e480: 7475 6465 206f 6620 7468 6520 7370 6563  tude of the spec
+0000e490: 7472 756d 2069 6e20 6672 6571 7565 6e63  trum in frequenc
+0000e4a0: 7920 646f 6d61 696e 2062 6574 7765 656e  y domain between
+0000e4b0: 202a 6672 6571 6d69 6e2a 2061 6e64 202a   *freqmin* and *
+0000e4c0: 6672 6571 6d61 782a 0a20 2020 2061 6e64  freqmax*.    and
+0000e4d0: 2072 6574 7572 6e73 2074 6865 2077 6869   returns the whi
+0000e4e0: 7465 6e65 6420 6666 742e 0a20 2020 2050  tened fft..    P
+0000e4f0: 4152 414d 4554 4552 533a 0a20 2020 202d  ARAMETERS:.    -
+0000e500: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000e510: 2d2d 2d2d 2d0a 2020 2020 6461 7461 3a20  -----.    data: 
+0000e520: 6e75 6d70 792e 6e64 6172 7261 7920 636f  numpy.ndarray co
+0000e530: 6e74 6169 6e73 2074 6865 2031 4420 7469  ntains the 1D ti
+0000e540: 6d65 2073 6572 6965 7320 746f 2077 6869  me series to whi
+0000e550: 7465 6e0a 2020 2020 6666 745f 7061 7261  ten.    fft_para
+0000e560: 3a20 6469 6374 2063 6f6e 7461 696e 696e  : dict containin
+0000e570: 6720 616c 6c20 6666 745f 6363 2070 6172  g all fft_cc par
+0000e580: 616d 6574 6572 7320 7375 6368 2061 730a  ameters such as.
+0000e590: 2020 2020 2020 2020 6474 3a20 5468 6520          dt: The 
+0000e5a0: 7361 6d70 6c69 6e67 2073 7061 6365 206f  sampling space o
+0000e5b0: 6620 7468 6520 6064 6174 6160 0a20 2020  f the `data`.   
+0000e5c0: 2020 2020 2066 7265 716d 696e 3a20 5468       freqmin: Th
+0000e5d0: 6520 6c6f 7765 7220 6672 6571 7565 6e63  e lower frequenc
+0000e5e0: 7920 626f 756e 640a 2020 2020 2020 2020  y bound.        
+0000e5f0: 6672 6571 6d61 783a 2054 6865 2075 7070  freqmax: The upp
+0000e600: 6572 2066 7265 7175 656e 6379 2062 6f75  er frequency bou
+0000e610: 6e64 0a20 2020 2020 2020 2073 6d6f 6f74  nd.        smoot
+0000e620: 685f 4e3a 2069 6e74 6567 6572 2c20 6974  h_N: integer, it
+0000e630: 2064 6566 696e 6573 2074 6865 2068 616c   defines the hal
+0000e640: 6620 7769 6e64 6f77 206c 656e 6774 6820  f window length 
+0000e650: 746f 2073 6d6f 6f74 680a 2020 2020 2020  to smooth.      
+0000e660: 2020 6e5f 7461 7065 722c 206f 7074 696f    n_taper, optio
+0000e670: 6e61 6c3a 2069 6e74 6567 6572 2c20 6465  nal: integer, de
+0000e680: 6669 6e65 2074 6865 2077 6964 7468 206f  fine the width o
+0000e690: 6620 7468 6520 7461 7065 7220 696e 2073  f the taper in s
+0000e6a0: 616d 706c 6573 0a20 2020 2052 4554 5552  amples.    RETUR
+0000e6b0: 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  NS:.    --------
+0000e6c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
+0000e6d0: 2020 2046 4654 5261 7753 6967 6e3a 206e     FFTRawSign: n
+0000e6e0: 756d 7079 2e6e 6461 7272 6179 2063 6f6e  umpy.ndarray con
+0000e6f0: 7461 696e 7320 7468 6520 4646 5420 6f66  tains the FFT of
+0000e700: 2074 6865 2077 6869 7465 6e65 6420 696e   the whitened in
+0000e710: 7075 7420 7472 6163 6520 6265 7477 6565  put trace betwee
+0000e720: 6e20 7468 6520 6672 6571 7565 6e63 7920  n the frequency 
+0000e730: 626f 756e 6473 0a20 2020 2022 2222 0a20  bounds.    """. 
+0000e740: 2020 2023 206c 6f61 6420 7061 7261 6d65     # load parame
+0000e750: 7465 7273 0a20 2020 2064 656c 7461 203d  ters.    delta =
+0000e760: 2066 6674 5f70 6172 615b 2264 7422 5d0a   fft_para["dt"].
+0000e770: 2020 2020 6672 6571 6d69 6e20 3d20 6666      freqmin = ff
+0000e780: 745f 7061 7261 5b22 6672 6571 6d69 6e22  t_para["freqmin"
+0000e790: 5d0a 2020 2020 6672 6571 6d61 7820 3d20  ].    freqmax = 
+0000e7a0: 6666 745f 7061 7261 5b22 6672 6571 6d61  fft_para["freqma
+0000e7b0: 7822 5d0a 2020 2020 736d 6f6f 7468 5f4e  x"].    smooth_N
+0000e7c0: 203d 2066 6674 5f70 6172 615b 2273 6d6f   = fft_para["smo
+0000e7d0: 6f74 685f 4e22 5d0a 0a20 2020 206e 6666  oth_N"]..    nff
+0000e7e0: 7420 3d20 6e65 7874 5f66 6173 745f 6c65  t = next_fast_le
+0000e7f0: 6e28 6c65 6e28 7469 6d65 7365 7269 6573  n(len(timeseries
+0000e800: 2929 0a20 2020 2073 7065 6320 3d20 6e70  )).    spec = np
+0000e810: 2e66 6674 2e66 6674 2874 696d 6573 6572  .fft.fft(timeser
+0000e820: 6965 732c 206e 6666 7429 0a20 2020 2066  ies, nfft).    f
+0000e830: 7265 7120 3d20 6e70 2e66 6674 2e66 6674  req = np.fft.fft
+0000e840: 6672 6571 286e 6666 742c 2064 3d64 656c  freq(nfft, d=del
+0000e850: 7461 290a 0a20 2020 2069 7830 203d 206e  ta)..    ix0 = n
+0000e860: 702e 6172 676d 696e 286e 702e 6162 7328  p.argmin(np.abs(
+0000e870: 6672 6571 202d 2066 7265 716d 696e 2929  freq - freqmin))
+0000e880: 0a20 2020 2069 7831 203d 206e 702e 6172  .    ix1 = np.ar
+0000e890: 676d 696e 286e 702e 6162 7328 6672 6571  gmin(np.abs(freq
+0000e8a0: 202d 2066 7265 716d 6178 2929 0a0a 2020   - freqmax))..  
+0000e8b0: 2020 6966 2069 7831 202b 206e 5f74 6170    if ix1 + n_tap
+0000e8c0: 6572 203e 206e 6666 743a 0a20 2020 2020  er > nfft:.     
+0000e8d0: 2020 2069 7831 3120 3d20 6e66 6674 0a20     ix11 = nfft. 
+0000e8e0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000e8f0: 2069 7831 3120 3d20 6978 3120 2b20 6e5f   ix11 = ix1 + n_
+0000e900: 7461 7065 720a 0a20 2020 2069 6620 6978  taper..    if ix
+0000e910: 3020 2d20 6e5f 7461 7065 7220 3c20 303a  0 - n_taper < 0:
+0000e920: 0a20 2020 2020 2020 2069 7830 3020 3d20  .        ix00 = 
+0000e930: 300a 2020 2020 656c 7365 3a0a 2020 2020  0.    else:.    
+0000e940: 2020 2020 6978 3030 203d 2069 7830 202d      ix00 = ix0 -
+0000e950: 206e 5f74 6170 6572 0a0a 2020 2020 7370   n_taper..    sp
+0000e960: 6563 5f6f 7574 203d 2073 7065 632e 636f  ec_out = spec.co
+0000e970: 7079 2829 0a20 2020 2073 7065 635f 6f75  py().    spec_ou
+0000e980: 745b 303a 6978 3030 5d20 3d20 302e 3020  t[0:ix00] = 0.0 
+0000e990: 2b20 302e 306a 0a20 2020 2073 7065 635f  + 0.0j.    spec_
+0000e9a0: 6f75 745b 6978 3131 3a5d 203d 2030 2e30  out[ix11:] = 0.0
+0000e9b0: 202b 2030 2e30 6a0a 0a20 2020 2069 6620   + 0.0j..    if 
+0000e9c0: 736d 6f6f 7468 5f4e 203c 3d20 313a 0a20  smooth_N <= 1:. 
+0000e9d0: 2020 2020 2020 2073 7065 635f 6f75 745b         spec_out[
+0000e9e0: 6978 3030 3a69 7831 315d 203d 206e 702e  ix00:ix11] = np.
+0000e9f0: 6578 7028 312e 306a 202a 206e 702e 616e  exp(1.0j * np.an
+0000ea00: 676c 6528 7370 6563 5f6f 7574 5b69 7830  gle(spec_out[ix0
+0000ea10: 303a 6978 3131 5d29 290a 2020 2020 656c  0:ix11])).    el
+0000ea20: 7365 3a0a 2020 2020 2020 2020 7370 6563  se:.        spec
+0000ea30: 5f6f 7574 5b69 7830 303a 6978 3131 5d20  _out[ix00:ix11] 
+0000ea40: 2f3d 206d 6f76 696e 675f 6176 6528 6e70  /= moving_ave(np
+0000ea50: 2e61 6273 2873 7065 635f 6f75 745b 6978  .abs(spec_out[ix
+0000ea60: 3030 3a69 7831 315d 292c 2073 6d6f 6f74  00:ix11]), smoot
+0000ea70: 685f 4e29 0a0a 2020 2020 7820 3d20 6e70  h_N)..    x = np
+0000ea80: 2e6c 696e 7370 6163 6528 6e70 2e70 6920  .linspace(np.pi 
+0000ea90: 2f20 322e 302c 206e 702e 7069 2c20 6978  / 2.0, np.pi, ix
+0000eaa0: 3020 2d20 6978 3030 290a 2020 2020 7370  0 - ix00).    sp
+0000eab0: 6563 5f6f 7574 5b69 7830 303a 6978 305d  ec_out[ix00:ix0]
+0000eac0: 202a 3d20 6e70 2e63 6f73 2878 2920 2a2a   *= np.cos(x) **
+0000ead0: 2032 0a0a 2020 2020 7820 3d20 6e70 2e6c   2..    x = np.l
+0000eae0: 696e 7370 6163 6528 302e 302c 206e 702e  inspace(0.0, np.
+0000eaf0: 7069 202f 2032 2e30 2c20 6978 3131 202d  pi / 2.0, ix11 -
+0000eb00: 2069 7831 290a 2020 2020 7370 6563 5f6f   ix1).    spec_o
+0000eb10: 7574 5b69 7831 3a69 7831 315d 202a 3d20  ut[ix1:ix11] *= 
+0000eb20: 6e70 2e63 6f73 2878 2920 2a2a 2032 0a0a  np.cos(x) ** 2..
+0000eb30: 2020 2020 7265 7475 726e 2073 7065 635f      return spec_
+0000eb40: 6f75 740a 0a0a 6465 6620 7768 6974 656e  out...def whiten
+0000eb50: 5f32 4428 7469 6d65 7365 7269 6573 2c20  _2D(timeseries, 
+0000eb60: 6666 745f 7061 7261 2c20 6e5f 7461 7065  fft_para, n_tape
+0000eb70: 7229 3a0a 2020 2020 2222 220a 2020 2020  r):.    """.    
+0000eb80: 5468 6973 2066 756e 6374 696f 6e20 7461  This function ta
+0000eb90: 6b65 7320 6120 322d 6469 6d65 6e73 696f  kes a 2-dimensio
+0000eba0: 6e61 6c20 7469 6d65 7365 7269 6573 2061  nal timeseries a
+0000ebb0: 7272 6179 2c20 7472 616e 7366 6f72 6d73  rray, transforms
+0000ebc0: 2074 6f20 6672 6571 7565 6e63 7920 646f   to frequency do
+0000ebd0: 6d61 696e 2075 7369 6e67 2066 6674 2c0a  main using fft,.
+0000ebe0: 2020 2020 7768 6974 656e 7320 7468 6520      whitens the 
+0000ebf0: 616d 706c 6974 7564 6520 6f66 2074 6865  amplitude of the
+0000ec00: 2073 7065 6374 7275 6d20 696e 2066 7265   spectrum in fre
+0000ec10: 7175 656e 6379 2064 6f6d 6169 6e20 6265  quency domain be
+0000ec20: 7477 6565 6e20 2a66 7265 716d 696e 2a20  tween *freqmin* 
+0000ec30: 616e 6420 2a66 7265 716d 6178 2a0a 2020  and *freqmax*.  
+0000ec40: 2020 616e 6420 7265 7475 726e 7320 7468    and returns th
+0000ec50: 6520 7768 6974 656e 6564 2066 6674 2e0a  e whitened fft..
+0000ec60: 2020 2020 5041 5241 4d45 5445 5253 3a0a      PARAMETERS:.
+0000ec70: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
+0000ec80: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2064  ----------.    d
+0000ec90: 6174 613a 206e 756d 7079 2e6e 6461 7272  ata: numpy.ndarr
+0000eca0: 6179 2063 6f6e 7461 696e 7320 7468 6520  ay contains the 
+0000ecb0: 3144 2074 696d 6520 7365 7269 6573 2074  1D time series t
+0000ecc0: 6f20 7768 6974 656e 0a20 2020 2066 6674  o whiten.    fft
+0000ecd0: 5f70 6172 613a 2064 6963 7420 636f 6e74  _para: dict cont
+0000ece0: 6169 6e69 6e67 2061 6c6c 2066 6674 5f63  aining all fft_c
+0000ecf0: 6320 7061 7261 6d65 7465 7273 2073 7563  c parameters suc
+0000ed00: 6820 6173 0a20 2020 2020 2020 2064 743a  h as.        dt:
+0000ed10: 2054 6865 2073 616d 706c 696e 6720 7370   The sampling sp
+0000ed20: 6163 6520 6f66 2074 6865 2060 6461 7461  ace of the `data
+0000ed30: 600a 2020 2020 2020 2020 6672 6571 6d69  `.        freqmi
+0000ed40: 6e3a 2054 6865 206c 6f77 6572 2066 7265  n: The lower fre
+0000ed50: 7175 656e 6379 2062 6f75 6e64 0a20 2020  quency bound.   
+0000ed60: 2020 2020 2066 7265 716d 6178 3a20 5468       freqmax: Th
+0000ed70: 6520 7570 7065 7220 6672 6571 7565 6e63  e upper frequenc
+0000ed80: 7920 626f 756e 640a 2020 2020 2020 2020  y bound.        
+0000ed90: 736d 6f6f 7468 5f4e 3a20 696e 7465 6765  smooth_N: intege
+0000eda0: 722c 2069 7420 6465 6669 6e65 7320 7468  r, it defines th
+0000edb0: 6520 6861 6c66 2077 696e 646f 7720 6c65  e half window le
+0000edc0: 6e67 7468 2074 6f20 736d 6f6f 7468 0a20  ngth to smooth. 
+0000edd0: 2020 2020 2020 206e 5f74 6170 6572 2c20         n_taper, 
+0000ede0: 6f70 7469 6f6e 616c 3a20 696e 7465 6765  optional: intege
+0000edf0: 722c 2064 6566 696e 6520 7468 6520 7769  r, define the wi
+0000ee00: 6474 6820 6f66 2074 6865 2074 6170 6572  dth of the taper
+0000ee10: 2069 6e20 7361 6d70 6c65 730a 2020 2020   in samples.    
+0000ee20: 5245 5455 524e 533a 0a20 2020 202d 2d2d  RETURNS:.    ---
+0000ee30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000ee40: 2d2d 2d0a 2020 2020 4646 5452 6177 5369  ---.    FFTRawSi
+0000ee50: 676e 3a20 6e75 6d70 792e 6e64 6172 7261  gn: numpy.ndarra
+0000ee60: 7920 636f 6e74 6169 6e73 2074 6865 2046  y contains the F
+0000ee70: 4654 206f 6620 7468 6520 7768 6974 656e  FT of the whiten
+0000ee80: 6564 2069 6e70 7574 2074 7261 6365 2062  ed input trace b
+0000ee90: 6574 7765 656e 2074 6865 2066 7265 7175  etween the frequ
+0000eea0: 656e 6379 2062 6f75 6e64 730a 2020 2020  ency bounds.    
+0000eeb0: 2222 220a 2020 2020 2320 6c6f 6164 2070  """.    # load p
+0000eec0: 6172 616d 6574 6572 730a 2020 2020 6465  arameters.    de
+0000eed0: 6c74 6120 3d20 6666 745f 7061 7261 5b22  lta = fft_para["
+0000eee0: 6474 225d 0a20 2020 2066 7265 716d 696e  dt"].    freqmin
+0000eef0: 203d 2066 6674 5f70 6172 615b 2266 7265   = fft_para["fre
+0000ef00: 716d 696e 225d 0a20 2020 2066 7265 716d  qmin"].    freqm
+0000ef10: 6178 203d 2066 6674 5f70 6172 615b 2266  ax = fft_para["f
+0000ef20: 7265 716d 6178 225d 0a20 2020 2073 6d6f  reqmax"].    smo
+0000ef30: 6f74 685f 4e20 3d20 6666 745f 7061 7261  oth_N = fft_para
+0000ef40: 5b22 736d 6f6f 7468 5f4e 225d 0a0a 2020  ["smooth_N"]..  
+0000ef50: 2020 6e66 6674 203d 206e 6578 745f 6661    nfft = next_fa
+0000ef60: 7374 5f6c 656e 2874 696d 6573 6572 6965  st_len(timeserie
+0000ef70: 732e 7368 6170 655b 315d 290a 2020 2020  s.shape[1]).    
+0000ef80: 7370 6563 203d 206e 702e 6666 742e 6666  spec = np.fft.ff
+0000ef90: 746e 2874 696d 6573 6572 6965 732c 2073  tn(timeseries, s
+0000efa0: 3d5b 6e66 6674 5d29 0a20 2020 2066 7265  =[nfft]).    fre
+0000efb0: 7120 3d20 6e70 2e66 6674 2e66 6674 6672  q = np.fft.fftfr
+0000efc0: 6571 286e 6666 742c 2064 3d64 656c 7461  eq(nfft, d=delta
+0000efd0: 290a 0a20 2020 2069 7830 203d 206e 702e  )..    ix0 = np.
+0000efe0: 6172 676d 696e 286e 702e 6162 7328 6672  argmin(np.abs(fr
+0000eff0: 6571 202d 2066 7265 716d 696e 2929 0a20  eq - freqmin)). 
+0000f000: 2020 2069 7831 203d 206e 702e 6172 676d     ix1 = np.argm
+0000f010: 696e 286e 702e 6162 7328 6672 6571 202d  in(np.abs(freq -
+0000f020: 2066 7265 716d 6178 2929 0a0a 2020 2020   freqmax))..    
+0000f030: 6966 2069 7831 202b 206e 5f74 6170 6572  if ix1 + n_taper
+0000f040: 203e 206e 6666 743a 0a20 2020 2020 2020   > nfft:.       
+0000f050: 2069 7831 3120 3d20 6e66 6674 0a20 2020   ix11 = nfft.   
+0000f060: 2065 6c73 653a 0a20 2020 2020 2020 2069   else:.        i
+0000f070: 7831 3120 3d20 6978 3120 2b20 6e5f 7461  x11 = ix1 + n_ta
+0000f080: 7065 720a 0a20 2020 2069 6620 6978 3020  per..    if ix0 
+0000f090: 2d20 6e5f 7461 7065 7220 3c20 303a 0a20  - n_taper < 0:. 
+0000f0a0: 2020 2020 2020 2069 7830 3020 3d20 300a         ix00 = 0.
+0000f0b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000f0c0: 2020 6978 3030 203d 2069 7830 202d 206e    ix00 = ix0 - n
+0000f0d0: 5f74 6170 6572 0a0a 2020 2020 7370 6563  _taper..    spec
+0000f0e0: 5f6f 7574 203d 2073 7065 632e 636f 7079  _out = spec.copy
+0000f0f0: 2829 2020 2320 6d61 7920 6265 2069 6e63  ()  # may be inc
+0000f100: 6f6e 7665 6e69 656e 7420 6475 6520 746f  onvenient due to
+0000f110: 2068 6967 6865 7220 6d65 6d6f 7279 2075   higher memory u
+0000f120: 7361 6765 0a20 2020 2073 7065 635f 6f75  sage.    spec_ou
+0000f130: 745b 3a2c 2030 3a69 7830 305d 203d 2030  t[:, 0:ix00] = 0
+0000f140: 2e30 202b 2030 2e30 6a0a 2020 2020 7370  .0 + 0.0j.    sp
+0000f150: 6563 5f6f 7574 5b3a 2c20 6978 3131 3a5d  ec_out[:, ix11:]
+0000f160: 203d 2030 2e30 202b 2030 2e30 6a0a 0a20   = 0.0 + 0.0j.. 
+0000f170: 2020 2069 6620 736d 6f6f 7468 5f4e 203c     if smooth_N <
+0000f180: 3d20 313a 0a20 2020 2020 2020 2073 7065  = 1:.        spe
+0000f190: 635f 6f75 745b 3a2c 2069 7830 303a 6978  c_out[:, ix00:ix
+0000f1a0: 3131 5d20 3d20 6e70 2e65 7870 2831 2e30  11] = np.exp(1.0
+0000f1b0: 6a20 2a20 6e70 2e61 6e67 6c65 2873 7065  j * np.angle(spe
+0000f1c0: 635f 6f75 745b 3a2c 2069 7830 303a 6978  c_out[:, ix00:ix
+0000f1d0: 3131 5d29 290a 2020 2020 656c 7365 3a0a  11])).    else:.
+0000f1e0: 2020 2020 2020 2020 7370 6563 5f6f 7574          spec_out
+0000f1f0: 5b3a 2c20 6978 3030 3a69 7831 315d 202f  [:, ix00:ix11] /
+0000f200: 3d20 6d6f 7669 6e67 5f61 7665 5f32 4428  = moving_ave_2D(
+0000f210: 6e70 2e61 6273 2873 7065 635f 6f75 745b  np.abs(spec_out[
+0000f220: 3a2c 2069 7830 303a 6978 3131 5d29 2c20  :, ix00:ix11]), 
+0000f230: 736d 6f6f 7468 5f4e 290a 0a20 2020 2078  smooth_N)..    x
+0000f240: 203d 206e 702e 6c69 6e73 7061 6365 286e   = np.linspace(n
+0000f250: 702e 7069 202f 2032 2e30 2c20 6e70 2e70  p.pi / 2.0, np.p
+0000f260: 692c 2069 7830 202d 2069 7830 3029 0a20  i, ix0 - ix00). 
+0000f270: 2020 2073 7065 635f 6f75 745b 3a2c 2069     spec_out[:, i
+0000f280: 7830 303a 6978 305d 202a 3d20 6e70 2e63  x00:ix0] *= np.c
+0000f290: 6f73 2878 2920 2a2a 2032 0a0a 2020 2020  os(x) ** 2..    
+0000f2a0: 7820 3d20 6e70 2e6c 696e 7370 6163 6528  x = np.linspace(
+0000f2b0: 302e 302c 206e 702e 7069 202f 2032 2e30  0.0, np.pi / 2.0
+0000f2c0: 2c20 6978 3131 202d 2069 7831 290a 2020  , ix11 - ix1).  
+0000f2d0: 2020 7370 6563 5f6f 7574 5b3a 2c20 6978    spec_out[:, ix
+0000f2e0: 313a 6978 3131 5d20 2a3d 206e 702e 636f  1:ix11] *= np.co
+0000f2f0: 7328 7829 202a 2a20 320a 0a20 2020 2072  s(x) ** 2..    r
+0000f300: 6574 7572 6e20 7370 6563 5f6f 7574 0a0a  eturn spec_out..
+0000f310: 0a64 6566 2077 6869 7465 6e28 6461 7461  .def whiten(data
+0000f320: 2c20 6666 745f 7061 7261 2c20 6e5f 7461  , fft_para, n_ta
+0000f330: 7065 723d 3130 3029 3a0a 2020 2020 2222  per=100):.    ""
+0000f340: 220a 2020 2020 5468 6973 2066 756e 6374  ".    This funct
+0000f350: 696f 6e20 7461 6b65 7320 6120 7469 6d65  ion takes a time
+0000f360: 7365 7269 6573 2061 7272 6179 2c20 7472  series array, tr
+0000f370: 616e 7366 6f72 6d73 2074 6f20 6672 6571  ansforms to freq
+0000f380: 7565 6e63 7920 646f 6d61 696e 2075 7369  uency domain usi
+0000f390: 6e67 2066 6674 2c0a 2020 2020 7768 6974  ng fft,.    whit
+0000f3a0: 656e 7320 7468 6520 616d 706c 6974 7564  ens the amplitud
+0000f3b0: 6520 6f66 2074 6865 2073 7065 6374 7275  e of the spectru
+0000f3c0: 6d20 696e 2066 7265 7175 656e 6379 2064  m in frequency d
+0000f3d0: 6f6d 6169 6e20 6265 7477 6565 6e20 2a66  omain between *f
+0000f3e0: 7265 716d 696e 2a20 616e 6420 2a66 7265  reqmin* and *fre
+0000f3f0: 716d 6178 2a0a 2020 2020 616e 6420 7265  qmax*.    and re
+0000f400: 7475 726e 7320 7468 6520 7768 6974 656e  turns the whiten
+0000f410: 6564 2066 6674 2e0a 2020 2020 5041 5241  ed fft..    PARA
+0000f420: 4d45 5445 5253 3a0a 2020 2020 2d2d 2d2d  METERS:.    ----
+0000f430: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000f440: 2d2d 0a20 2020 2064 6174 613a 206e 756d  --.    data: num
+0000f450: 7079 2e6e 6461 7272 6179 2063 6f6e 7461  py.ndarray conta
+0000f460: 696e 7320 7468 6520 3144 2074 696d 6520  ins the 1D time 
+0000f470: 7365 7269 6573 2074 6f20 7768 6974 656e  series to whiten
+0000f480: 0a20 2020 2066 6674 5f70 6172 613a 2064  .    fft_para: d
+0000f490: 6963 7420 636f 6e74 6169 6e69 6e67 2061  ict containing a
+0000f4a0: 6c6c 2066 6674 5f63 6320 7061 7261 6d65  ll fft_cc parame
+0000f4b0: 7465 7273 2073 7563 6820 6173 0a20 2020  ters such as.   
+0000f4c0: 2020 2020 2064 743a 2054 6865 2073 616d       dt: The sam
+0000f4d0: 706c 696e 6720 7370 6163 6520 6f66 2074  pling space of t
+0000f4e0: 6865 2060 6461 7461 600a 2020 2020 2020  he `data`.      
+0000f4f0: 2020 6672 6571 6d69 6e3a 2054 6865 206c    freqmin: The l
+0000f500: 6f77 6572 2066 7265 7175 656e 6379 2062  ower frequency b
+0000f510: 6f75 6e64 0a20 2020 2020 2020 2066 7265  ound.        fre
+0000f520: 716d 6178 3a20 5468 6520 7570 7065 7220  qmax: The upper 
+0000f530: 6672 6571 7565 6e63 7920 626f 756e 640a  frequency bound.
+0000f540: 2020 2020 2020 2020 736d 6f6f 7468 5f4e          smooth_N
+0000f550: 3a20 696e 7465 6765 722c 2069 7420 6465  : integer, it de
+0000f560: 6669 6e65 7320 7468 6520 6861 6c66 2077  fines the half w
+0000f570: 696e 646f 7720 6c65 6e67 7468 2074 6f20  indow length to 
+0000f580: 736d 6f6f 7468 0a20 2020 2020 2020 2066  smooth.        f
+0000f590: 7265 715f 6e6f 726d 3a20 7768 6974 656e  req_norm: whiten
+0000f5a0: 696e 6720 6d65 7468 6f64 2062 6574 7765  ing method betwe
+0000f5b0: 656e 2027 6f6e 652d 6269 7427 2061 6e64  en 'one-bit' and
+0000f5c0: 2027 524d 4127 0a20 2020 2052 4554 5552   'RMA'.    RETUR
+0000f5d0: 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  NS:.    --------
+0000f5e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
+0000f5f0: 2020 2046 4654 5261 7753 6967 6e3a 206e     FFTRawSign: n
+0000f600: 756d 7079 2e6e 6461 7272 6179 2063 6f6e  umpy.ndarray con
+0000f610: 7461 696e 7320 7468 6520 4646 5420 6f66  tains the FFT of
+0000f620: 2074 6865 2077 6869 7465 6e65 6420 696e   the whitened in
+0000f630: 7075 7420 7472 6163 6520 6265 7477 6565  put trace betwee
+0000f640: 6e20 7468 6520 6672 6571 7565 6e63 7920  n the frequency 
+0000f650: 626f 756e 6473 0a20 2020 2022 2222 0a0a  bounds.    """..
+0000f660: 2020 2020 2320 5370 6565 6420 7570 2046      # Speed up F
+0000f670: 4654 2062 7920 7061 6464 696e 6720 746f  FT by padding to
+0000f680: 206f 7074 696d 616c 2073 697a 6520 666f   optimal size fo
+0000f690: 7220 4646 5450 4143 4b0a 2020 2020 6966  r FFTPACK.    if
+0000f6a0: 2064 6174 612e 6e64 696d 203d 3d20 313a   data.ndim == 1:
+0000f6b0: 0a20 2020 2020 2020 2046 4654 5261 7753  .        FFTRawS
+0000f6c0: 6967 6e20 3d20 7768 6974 656e 5f31 4428  ign = whiten_1D(
+0000f6d0: 6461 7461 2c20 6666 745f 7061 7261 2c20  data, fft_para, 
+0000f6e0: 6e5f 7461 7065 7229 0a20 2020 2020 2020  n_taper).       
+0000f6f0: 2023 2041 5252 5f4f 5554 3a20 4f6e 6c79   # ARR_OUT: Only
+0000f700: 2066 6f72 2063 6f6e 7369 7374 656e 6379   for consistency
+0000f710: 2077 6974 6820 6e6f 6973 6570 7920 6170   with noisepy ap
+0000f720: 7072 6f61 6368 206f 6620 686f 6c64 696e  proach of holdin
+0000f730: 6720 7468 6520 6675 6c6c 0a20 2020 2020  g the full.     
+0000f740: 2020 2023 2073 7065 6374 7275 6d20 286e     # spectrum (n
+0000f750: 6f74 206a 7573 7420 3020 616e 6420 706f  ot just 0 and po
+0000f760: 7369 7469 7665 2066 7265 712e 2070 6172  sitive freq. par
+0000f770: 7429 0a20 2020 2020 2020 2061 7272 5f6f  t).        arr_o
+0000f780: 7574 203d 206e 702e 7a65 726f 7328 2846  ut = np.zeros((F
+0000f790: 4654 5261 7753 6967 6e2e 7368 6170 655b  FTRawSign.shape[
+0000f7a0: 305d 202d 2031 2920 2a20 3220 2b20 312c  0] - 1) * 2 + 1,
+0000f7b0: 2064 7479 7065 3d63 6f6d 706c 6578 290a   dtype=complex).
+0000f7c0: 2020 2020 2020 2020 6172 725f 6f75 745b          arr_out[
+0000f7d0: 3020 3a20 4646 5452 6177 5369 676e 2e73  0 : FFTRawSign.s
+0000f7e0: 6861 7065 5b30 5d5d 203d 2046 4654 5261  hape[0]] = FFTRa
+0000f7f0: 7753 6967 6e0a 2020 2020 2020 2020 6172  wSign.        ar
+0000f800: 725f 6f75 745b 4646 5452 6177 5369 676e  r_out[FFTRawSign
+0000f810: 2e73 6861 7065 5b30 5d20 3a5d 203d 2046  .shape[0] :] = F
+0000f820: 4654 5261 7753 6967 6e5b 313a 5d2e 636f  FTRawSign[1:].co
+0000f830: 6e6a 7567 6174 6528 295b 3a3a 2d31 5d0a  njugate()[::-1].
+0000f840: 0a20 2020 2065 6c69 6620 6461 7461 2e6e  .    elif data.n
+0000f850: 6469 6d20 3d3d 2032 3a0a 2020 2020 2020  dim == 2:.      
+0000f860: 2020 4646 5452 6177 5369 676e 203d 2077    FFTRawSign = w
+0000f870: 6869 7465 6e5f 3244 2864 6174 612c 2066  hiten_2D(data, f
+0000f880: 6674 5f70 6172 612c 206e 5f74 6170 6572  ft_para, n_taper
+0000f890: 290a 2020 2020 2020 2020 6172 725f 6f75  ).        arr_ou
+0000f8a0: 7420 3d20 6e70 2e7a 6572 6f73 2828 4646  t = np.zeros((FF
+0000f8b0: 5452 6177 5369 676e 2e73 6861 7065 5b30  TRawSign.shape[0
+0000f8c0: 5d2c 2028 4646 5452 6177 5369 676e 2e73  ], (FFTRawSign.s
+0000f8d0: 6861 7065 5b31 5d20 2d20 3129 202a 2032  hape[1] - 1) * 2
+0000f8e0: 202b 2031 292c 2064 7479 7065 3d63 6f6d   + 1), dtype=com
+0000f8f0: 706c 6578 290a 2020 2020 2020 2020 6172  plex).        ar
+0000f900: 725f 6f75 745b 3a2c 2046 4654 5261 7753  r_out[:, FFTRawS
+0000f910: 6967 6e2e 7368 6170 655b 315d 203a 5d20  ign.shape[1] :] 
+0000f920: 3d20 4646 5452 6177 5369 676e 5b3a 2c20  = FFTRawSign[:, 
+0000f930: 313a 5d2e 636f 6e6a 7567 6174 6528 295b  1:].conjugate()[
+0000f940: 3a3a 2d31 5d0a 2020 2020 7265 7475 726e  ::-1].    return
+0000f950: 2046 4654 5261 7753 6967 6e0a 0a0a 6465   FFTRawSign...de
+0000f960: 6620 6164 6170 7469 7665 5f66 696c 7465  f adaptive_filte
+0000f970: 7228 6172 722c 2067 293a 0a20 2020 2022  r(arr, g):.    "
+0000f980: 2222 0a20 2020 2074 6865 2061 6461 7074  "".    the adapt
+0000f990: 6976 6520 636f 7661 7269 616e 6365 2066  ive covariance f
+0000f9a0: 696c 7465 7220 746f 2065 6e68 616e 6365  ilter to enhance
+0000f9b0: 2063 6f68 6572 656e 7420 7369 676e 616c   coherent signal
+0000f9c0: 732e 2046 656c 6c6f 7773 2074 6865 206d  s. Fellows the m
+0000f9d0: 6574 686f 6420 6f66 0a20 2020 204e 616b  ethod of.    Nak
+0000f9e0: 6174 6120 6574 2061 6c2e 2c20 3230 3135  ata et al., 2015
+0000f9f0: 2028 4170 7065 6e64 6978 2042 290a 0a20   (Appendix B).. 
+0000fa00: 2020 2074 6865 2066 696c 7465 7265 6420     the filtered 
+0000fa10: 7369 676e 616c 205b 7831 5d20 6973 2067  signal [x1] is g
+0000fa20: 6976 656e 2062 7920 7831 203d 2069 6666  iven by x1 = iff
+0000fa30: 7428 502a 7831 2877 2929 2077 6865 7265  t(P*x1(w)) where
+0000fa40: 2078 3120 6973 2074 6865 2066 6674 6564   x1 is the ffted
+0000fa50: 2073 7065 6374 7261 0a20 2020 2061 6e64   spectra.    and
+0000fa60: 2050 2069 7320 7468 6520 6669 6c74 6572   P is the filter
+0000fa70: 2e20 5020 6973 2063 6f6e 7374 7275 6374  . P is construct
+0000fa80: 6564 2062 7920 7573 696e 6720 7468 6520  ed by using the 
+0000fa90: 7465 6d70 6f72 616c 2063 6f76 6172 6961  temporal covaria
+0000faa0: 6e63 6520 6d61 7472 6978 2e0a 0a20 2020  nce matrix...   
+0000fab0: 2050 4152 414d 4554 4552 533a 0a20 2020   PARAMETERS:.   
+0000fac0: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
+0000fad0: 2d2d 2d2d 2d2d 2d0a 2020 2020 6172 723a  -------.    arr:
+0000fae0: 206e 756d 7079 2e6e 6461 7272 6179 2063   numpy.ndarray c
+0000faf0: 6f6e 7461 696e 7320 7468 6520 3244 2074  ontains the 2D t
+0000fb00: 7261 6365 7320 6f66 2064 6169 6c79 2f68  races of daily/h
+0000fb10: 6f75 726c 7920 6372 6f73 732d 636f 7272  ourly cross-corr
+0000fb20: 656c 6174 696f 6e20 6675 6e63 7469 6f6e  elation function
+0000fb30: 730a 2020 2020 673a 2061 2070 6f73 6974  s.    g: a posit
+0000fb40: 6976 6520 6e75 6d62 6572 2074 6f20 6164  ive number to ad
+0000fb50: 6a75 7374 2074 6865 2066 696c 7465 7220  just the filter 
+0000fb60: 6861 7273 686e 6573 730a 2020 2020 5245  harshness.    RE
+0000fb70: 5455 524e 533a 0a20 2020 202d 2d2d 2d2d  TURNS:.    -----
+0000fb80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000fb90: 2d0a 2020 2020 6e61 7272 3a20 6e75 6d70  -.    narr: nump
+0000fba0: 7920 7665 6374 6f72 2063 6f6e 7461 696e  y vector contain
+0000fbb0: 7320 7468 6520 7374 6163 6b65 6420 6372  s the stacked cr
+0000fbc0: 6f73 7320 636f 7272 656c 6174 696f 6e20  oss correlation 
+0000fbd0: 6675 6e63 7469 6f6e 0a20 2020 2022 2222  function.    """
+0000fbe0: 0a20 2020 2069 6620 6172 722e 6e64 696d  .    if arr.ndim
+0000fbf0: 203d 3d20 313a 0a20 2020 2020 2020 2072   == 1:.        r
+0000fc00: 6574 7572 6e20 6172 720a 2020 2020 4e2c  eturn arr.    N,
+0000fc10: 204d 203d 2061 7272 2e73 6861 7065 0a20   M = arr.shape. 
+0000fc20: 2020 204e 6666 7420 3d20 6e65 7874 5f66     Nfft = next_f
+0000fc30: 6173 745f 6c65 6e28 4d29 0a0a 2020 2020  ast_len(M)..    
+0000fc40: 2320 6666 7420 7468 6520 3244 2061 7272  # fft the 2D arr
+0000fc50: 6179 0a20 2020 2073 7065 6320 3d20 7363  ay.    spec = sc
+0000fc60: 6970 792e 6666 7470 6163 6b2e 6666 7428  ipy.fftpack.fft(
+0000fc70: 6172 722c 2061 7869 733d 312c 206e 3d4e  arr, axis=1, n=N
+0000fc80: 6666 7429 5b3a 2c20 3a4d 5d0a 0a20 2020  fft)[:, :M]..   
+0000fc90: 2023 206d 616b 6520 6372 6f73 732d 7370   # make cross-sp
+0000fca0: 6563 7472 6d20 6d61 7472 6978 0a20 2020  ectrm matrix.   
+0000fcb0: 2063 7370 6563 203d 206e 702e 7a65 726f   cspec = np.zero
+0000fcc0: 7328 7368 6170 653d 284e 202a 204e 2c20  s(shape=(N * N, 
+0000fcd0: 4d29 2c20 6474 7970 653d 6e70 2e63 6f6d  M), dtype=np.com
+0000fce0: 706c 6578 3634 290a 2020 2020 666f 7220  plex64).    for 
+0000fcf0: 6969 2069 6e20 7261 6e67 6528 4e29 3a0a  ii in range(N):.
+0000fd00: 2020 2020 2020 2020 666f 7220 6a6a 2069          for jj i
+0000fd10: 6e20 7261 6e67 6528 4e29 3a0a 2020 2020  n range(N):.    
+0000fd20: 2020 2020 2020 2020 6b6b 203d 2069 6920          kk = ii 
+0000fd30: 2a20 4e20 2b20 6a6a 0a20 2020 2020 2020  * N + jj.       
+0000fd40: 2020 2020 2063 7370 6563 5b6b 6b5d 203d       cspec[kk] =
+0000fd50: 2073 7065 635b 6969 5d20 2a20 6e70 2e63   spec[ii] * np.c
+0000fd60: 6f6e 6a75 6761 7465 2873 7065 635b 6a6a  onjugate(spec[jj
+0000fd70: 5d29 0a0a 2020 2020 5331 203d 206e 702e  ])..    S1 = np.
+0000fd80: 7a65 726f 7328 4d2c 2064 7479 7065 3d6e  zeros(M, dtype=n
+0000fd90: 702e 636f 6d70 6c65 7836 3429 0a20 2020  p.complex64).   
+0000fda0: 2053 3220 3d20 6e70 2e7a 6572 6f73 284d   S2 = np.zeros(M
+0000fdb0: 2c20 6474 7970 653d 6e70 2e63 6f6d 706c  , dtype=np.compl
+0000fdc0: 6578 3634 290a 2020 2020 2320 636f 6e73  ex64).    # cons
+0000fdd0: 7472 7563 7420 7468 6520 6669 6c74 6572  truct the filter
+0000fde0: 2050 0a20 2020 2066 6f72 2069 6920 696e   P.    for ii in
+0000fdf0: 2072 616e 6765 284e 293a 0a20 2020 2020   range(N):.     
+0000fe00: 2020 206d 6d20 3d20 6969 202a 204e 202b     mm = ii * N +
+0000fe10: 2069 690a 2020 2020 2020 2020 5332 202b   ii.        S2 +
+0000fe20: 3d20 6373 7065 635b 6d6d 5d0a 2020 2020  = cspec[mm].    
+0000fe30: 2020 2020 666f 7220 6a6a 2069 6e20 7261      for jj in ra
+0000fe40: 6e67 6528 4e29 3a0a 2020 2020 2020 2020  nge(N):.        
+0000fe50: 2020 2020 6b6b 203d 2069 6920 2a20 4e20      kk = ii * N 
+0000fe60: 2b20 6a6a 0a20 2020 2020 2020 2020 2020  + jj.           
+0000fe70: 2053 3120 2b3d 2063 7370 6563 5b6b 6b5d   S1 += cspec[kk]
+0000fe80: 0a0a 2020 2020 7020 3d20 6e70 2e70 6f77  ..    p = np.pow
+0000fe90: 6572 2828 5331 202d 2053 3229 202f 2028  er((S1 - S2) / (
+0000fea0: 5332 202a 2028 4e20 2d20 3129 292c 2067  S2 * (N - 1)), g
+0000feb0: 290a 0a20 2020 2023 206d 616b 6520 6966  )..    # make if
+0000fec0: 6674 0a20 2020 206e 6172 7220 3d20 6e70  ft.    narr = np
+0000fed0: 2e72 6561 6c28 7363 6970 792e 6666 7470  .real(scipy.fftp
+0000fee0: 6163 6b2e 6966 6674 286e 702e 6d75 6c74  ack.ifft(np.mult
+0000fef0: 6970 6c79 2870 2c20 7370 6563 292c 204e  iply(p, spec), N
+0000ff00: 6666 742c 2061 7869 733d 3129 5b3a 2c20  fft, axis=1)[:, 
+0000ff10: 3a4d 5d29 0a20 2020 2072 6574 7572 6e20  :M]).    return 
+0000ff20: 6e70 2e6d 6561 6e28 6e61 7272 2c20 6178  np.mean(narr, ax
+0000ff30: 6973 3d30 290a 0a0a 6465 6620 7077 7328  is=0)...def pws(
+0000ff40: 6172 722c 2073 616d 706c 696e 675f 7261  arr, sampling_ra
+0000ff50: 7465 2c20 706f 7765 723d 322c 2070 7773  te, power=2, pws
+0000ff60: 5f74 696d 6567 6174 653d 352e 3029 3a0a  _timegate=5.0):.
+0000ff70: 2020 2020 2222 220a 2020 2020 5065 7266      """.    Perf
+0000ff80: 6f72 6d73 2070 6861 7365 2d77 6569 6768  orms phase-weigh
+0000ff90: 7465 6420 7374 6163 6b20 6f6e 2061 7272  ted stack on arr
+0000ffa0: 6179 206f 6620 7469 6d65 2073 6572 6965  ay of time serie
+0000ffb0: 732e 204d 6f64 6966 6965 6420 6f6e 2074  s. Modified on t
+0000ffc0: 6865 206e 6f69 7365 2066 756e 6374 696f  he noise functio
+0000ffd0: 6e20 6279 2054 696d 2043 6c69 6d65 6e74  n by Tim Climent
+0000ffe0: 732e 0a20 2020 2046 6f6c 6c6f 7773 206d  s..    Follows m
+0000fff0: 6574 686f 6473 206f 6620 5363 6869 6d6d  ethods of Schimm
+00010000: 656c 2061 6e64 2050 6175 6c73 7365 6e2c  el and Paulssen,
+00010010: 2031 3939 372e 0a20 2020 2049 6620 7328   1997..    If s(
+00010020: 7429 2069 7320 7469 6d65 2073 6572 6965  t) is time serie
+00010030: 7320 6461 7461 2028 7365 6973 6d6f 6772  s data (seismogr
+00010040: 616d 2c20 6f72 2063 726f 7373 2d63 6f72  am, or cross-cor
+00010050: 7265 6c61 7469 6f6e 292c 0a20 2020 2053  relation),.    S
+00010060: 2874 2920 3d20 7328 7429 202b 2069 2a48  (t) = s(t) + i*H
+00010070: 2873 2874 2929 2c20 7768 6572 6520 4828  (s(t)), where H(
+00010080: 7328 7429 2920 6973 2048 696c 6265 7274  s(t)) is Hilbert
+00010090: 2074 7261 6e73 666f 726d 206f 6620 7328   transform of s(
+000100a0: 7429 0a20 2020 2053 2874 2920 3d20 7328  t).    S(t) = s(
+000100b0: 7429 202b 2069 2a48 2873 2874 2929 203d  t) + i*H(s(t)) =
+000100c0: 2041 2874 292a 6578 7028 692a 7068 6928   A(t)*exp(i*phi(
+000100d0: 7429 292c 2077 6865 7265 0a20 2020 2041  t)), where.    A
+000100e0: 2874 2920 6973 2065 6e76 656c 6f70 6520  (t) is envelope 
+000100f0: 6f66 2073 2874 2920 616e 6420 7068 6928  of s(t) and phi(
+00010100: 7429 2069 7320 7068 6173 6520 6f66 2073  t) is phase of s
+00010110: 2874 290a 2020 2020 5068 6173 652d 7765  (t).    Phase-we
+00010120: 6967 6874 6564 2073 7461 636b 2c20 6728  ighted stack, g(
+00010130: 7429 2c20 6973 2074 6865 6e3a 0a20 2020  t), is then:.   
+00010140: 2067 2874 2920 3d20 312f 4e20 7375 6d20   g(t) = 1/N sum 
+00010150: 6a20 3d20 313a 4e20 735f 6a28 7429 202a  j = 1:N s_j(t) *
+00010160: 207c 2031 2f4e 2073 756d 206b 203d 2031   | 1/N sum k = 1
+00010170: 3a4e 2065 7870 5b69 202a 2070 6869 5f6b  :N exp[i * phi_k
+00010180: 2874 295d 7c5e 760a 2020 2020 7768 6572  (t)]|^v.    wher
+00010190: 6520 4e20 6973 206e 756d 6265 7220 6f66  e N is number of
+000101a0: 2074 7261 6365 7320 7573 6564 2c20 7620   traces used, v 
+000101b0: 6973 2073 6861 7270 6e65 7373 206f 6620  is sharpness of 
+000101c0: 7068 6173 652d 7765 6967 6874 6564 2073  phase-weighted s
+000101d0: 7461 636b 0a0a 2020 2020 5041 5241 4d45  tack..    PARAME
+000101e0: 5445 5253 3a0a 2020 2020 2d2d 2d2d 2d2d  TERS:.    ------
+000101f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
+00010200: 2020 2020 6172 723a 204e 206c 656e 6774      arr: N lengt
+00010210: 6820 6172 7261 7920 6f66 2074 696d 6520  h array of time 
+00010220: 7365 7269 6573 2064 6174 6120 286e 756d  series data (num
+00010230: 7079 2e6e 6461 7272 6179 290a 2020 2020  py.ndarray).    
+00010240: 7361 6d70 6c69 6e67 5f72 6174 653a 2073  sampling_rate: s
+00010250: 616d 706c 696e 6720 7261 7465 206f 6620  ampling rate of 
+00010260: 7469 6d65 2073 6572 6965 7320 6172 7220  time series arr 
+00010270: 2869 6e74 290a 2020 2020 706f 7765 723a  (int).    power:
+00010280: 2065 7870 6f6e 656e 7420 666f 7220 7068   exponent for ph
+00010290: 6173 6520 7374 6163 6b20 2869 6e74 290a  ase stack (int).
+000102a0: 2020 2020 7077 735f 7469 6d65 6761 7465      pws_timegate
+000102b0: 3a20 6e75 6d62 6572 206f 6620 7365 636f  : number of seco
+000102c0: 6e64 7320 746f 2073 6d6f 6f74 6820 7068  nds to smooth ph
+000102d0: 6173 6520 7374 6163 6b20 2866 6c6f 6174  ase stack (float
+000102e0: 290a 0a20 2020 2052 4554 5552 4e53 3a0a  )..    RETURNS:.
+000102f0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
+00010300: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7765  ---------.    we
+00010310: 6967 6874 6564 3a20 5068 6173 6520 7765  ighted: Phase we
+00010320: 6967 6874 6564 2073 7461 636b 206f 6620  ighted stack of 
+00010330: 7469 6d65 2073 6572 6965 7320 6461 7461  time series data
+00010340: 2028 6e75 6d70 792e 6e64 6172 7261 7929   (numpy.ndarray)
+00010350: 0a20 2020 2022 2222 0a0a 2020 2020 6966  .    """..    if
+00010360: 2061 7272 2e6e 6469 6d20 3d3d 2031 3a0a   arr.ndim == 1:.
+00010370: 2020 2020 2020 2020 7265 7475 726e 2061          return a
+00010380: 7272 0a20 2020 204e 2c20 4d20 3d20 6172  rr.    N, M = ar
+00010390: 722e 7368 6170 650a 2020 2020 616e 616c  r.shape.    anal
+000103a0: 7974 6963 203d 2068 696c 6265 7274 2861  ytic = hilbert(a
+000103b0: 7272 2c20 6178 6973 3d31 2c20 4e3d 6e65  rr, axis=1, N=ne
+000103c0: 7874 5f66 6173 745f 6c65 6e28 4d29 295b  xt_fast_len(M))[
+000103d0: 3a2c 203a 4d5d 0a20 2020 2070 6861 7365  :, :M].    phase
+000103e0: 203d 206e 702e 616e 676c 6528 616e 616c   = np.angle(anal
+000103f0: 7974 6963 290a 2020 2020 7068 6173 655f  ytic).    phase_
+00010400: 7374 6163 6b20 3d20 6e70 2e6d 6561 6e28  stack = np.mean(
+00010410: 6e70 2e65 7870 2831 6a20 2a20 7068 6173  np.exp(1j * phas
+00010420: 6529 2c20 6178 6973 3d30 290a 2020 2020  e), axis=0).    
+00010430: 7068 6173 655f 7374 6163 6b20 3d20 6e70  phase_stack = np
+00010440: 2e61 6273 2870 6861 7365 5f73 7461 636b  .abs(phase_stack
+00010450: 2920 2a2a 2028 706f 7765 7229 0a0a 2020  ) ** (power)..  
+00010460: 2020 2320 736d 6f6f 7468 696e 670a 2020    # smoothing.  
+00010470: 2020 2320 7469 6d65 6761 7465 5f73 616d    # timegate_sam
+00010480: 706c 6573 203d 2069 6e74 2870 7773 5f74  ples = int(pws_t
+00010490: 696d 6567 6174 6520 2a20 7361 6d70 6c69  imegate * sampli
+000104a0: 6e67 5f72 6174 6529 0a20 2020 2023 2070  ng_rate).    # p
+000104b0: 6861 7365 5f73 7461 636b 203d 206d 6f76  hase_stack = mov
+000104c0: 696e 675f 6176 6528 7068 6173 655f 7374  ing_ave(phase_st
+000104d0: 6163 6b2c 7469 6d65 6761 7465 5f73 616d  ack,timegate_sam
+000104e0: 706c 6573 290a 2020 2020 7765 6967 6874  ples).    weight
+000104f0: 6564 203d 206e 702e 6d75 6c74 6970 6c79  ed = np.multiply
+00010500: 2861 7272 2c20 7068 6173 655f 7374 6163  (arr, phase_stac
+00010510: 6b29 0a20 2020 2072 6574 7572 6e20 6e70  k).    return np
+00010520: 2e6d 6561 6e28 7765 6967 6874 6564 2c20  .mean(weighted, 
+00010530: 6178 6973 3d30 290a 0a0a 6465 6620 6e72  axis=0)...def nr
+00010540: 6f6f 745f 7374 6163 6b28 6363 5f61 7272  oot_stack(cc_arr
+00010550: 6179 2c20 706f 7765 7229 3a0a 2020 2020  ay, power):.    
+00010560: 2222 220a 2020 2020 7468 6973 2069 7320  """.    this is 
+00010570: 6e74 682d 726f 6f74 2073 7461 636b 696e  nth-root stackin
+00010580: 6720 616c 676f 7269 7468 6d20 7472 616e  g algorithm tran
+00010590: 736c 6174 6564 2062 6173 6564 206f 6e20  slated based on 
+000105a0: 7468 6520 6d61 746c 6162 2066 756e 6374  the matlab funct
+000105b0: 696f 6e0a 2020 2020 6672 6f6d 2068 7474  ion.    from htt
+000105c0: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
+000105d0: 7874 7961 6e67 7073 702f 5365 6973 5374  xtyangpsp/SeisSt
+000105e0: 6163 6b20 2862 7920 5869 616f 7461 6f20  ack (by Xiaotao 
+000105f0: 5961 6e67 3b20 666f 6c6c 6f77 7320 7468  Yang; follows th
+00010600: 650a 2020 2020 7265 6665 7265 6e63 6520  e.    reference 
+00010610: 6f66 204d 696c 6c65 742c 2046 2065 7420  of Millet, F et 
+00010620: 616c 2e2c 2032 3031 3920 4a47 5229 0a0a  al., 2019 JGR)..
+00010630: 2020 2020 5061 7261 6d65 7465 7273 3a0a      Parameters:.
+00010640: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
+00010650: 0a20 2020 2063 635f 6172 7261 793a 206e  .    cc_array: n
+00010660: 756d 7079 2e6e 6461 7272 6179 2063 6f6e  umpy.ndarray con
+00010670: 7461 696e 7320 7468 6520 3244 2063 726f  tains the 2D cro
+00010680: 7373 2063 6f72 7265 6c61 7469 6f6e 206d  ss correlation m
+00010690: 6174 7269 780a 2020 2020 706f 7765 723a  atrix.    power:
+000106a0: 206e 702e 696e 742c 206e 7468 2072 6f6f   np.int, nth roo
+000106b0: 7420 666f 7220 7468 6520 7374 6163 6b69  t for the stacki
+000106c0: 6e67 0a0a 2020 2020 5265 7475 726e 733a  ng..    Returns:
+000106d0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
+000106e0: 2d0a 2020 2020 6e73 7461 636b 3a20 6e70  -.    nstack: np
+000106f0: 2e6e 6461 7272 6179 2c20 6669 6e61 6c20  .ndarray, final 
+00010700: 7374 6163 6b65 6420 7761 7665 666f 726d  stacked waveform
+00010710: 730a 0a20 2020 2057 7269 7474 656e 2062  s..    Written b
+00010720: 7920 4368 656e 6778 696e 204a 6961 6e67  y Chengxin Jiang
+00010730: 2040 414e 5520 284d 6179 3230 3230 290a   @ANU (May2020).
+00010740: 2020 2020 2222 220a 2020 2020 6966 2063      """.    if c
+00010750: 635f 6172 7261 792e 6e64 696d 203d 3d20  c_array.ndim == 
+00010760: 313a 0a20 2020 2020 2020 2070 7269 6e74  1:.        print
+00010770: 2822 3244 206d 6174 7269 7820 6973 206e  ("2D matrix is n
+00010780: 6565 6465 6420 666f 7220 6e72 6f6f 745f  eeded for nroot_
+00010790: 7374 6163 6b22 290a 2020 2020 2020 2020  stack").        
+000107a0: 7265 7475 726e 2063 635f 6172 7261 790a  return cc_array.
+000107b0: 2020 2020 4e2c 204d 203d 2063 635f 6172      N, M = cc_ar
+000107c0: 7261 792e 7368 6170 650a 2020 2020 646f  ray.shape.    do
+000107d0: 7574 203d 206e 702e 7a65 726f 7328 4d2c  ut = np.zeros(M,
+000107e0: 2064 7479 7065 3d6e 702e 666c 6f61 7433   dtype=np.float3
+000107f0: 3229 0a0a 2020 2020 2320 636f 6e73 7472  2)..    # constr
+00010800: 7563 7420 790a 2020 2020 666f 7220 6969  uct y.    for ii
+00010810: 2069 6e20 7261 6e67 6528 4e29 3a0a 2020   in range(N):.  
+00010820: 2020 2020 2020 6461 7420 3d20 6363 5f61        dat = cc_a
+00010830: 7272 6179 5b69 692c 203a 5d0a 2020 2020  rray[ii, :].    
+00010840: 2020 2020 646f 7574 202b 3d20 6e70 2e73      dout += np.s
+00010850: 6967 6e28 6461 7429 202a 206e 702e 6162  ign(dat) * np.ab
+00010860: 7328 6461 7429 202a 2a20 2831 202f 2070  s(dat) ** (1 / p
+00010870: 6f77 6572 290a 2020 2020 646f 7574 202f  ower).    dout /
+00010880: 3d20 4e0a 0a20 2020 2023 2074 6865 2066  = N..    # the f
+00010890: 696e 616c 2073 7461 636b 6564 2077 6176  inal stacked wav
+000108a0: 6566 6f72 6d0a 2020 2020 6e73 7461 636b  eform.    nstack
+000108b0: 203d 2064 6f75 7420 2a20 6e70 2e61 6273   = dout * np.abs
+000108c0: 2864 6f75 7429 202a 2a20 2870 6f77 6572  (dout) ** (power
+000108d0: 202d 2031 290a 0a20 2020 2072 6574 7572   - 1)..    retur
+000108e0: 6e20 6e73 7461 636b 0a0a 0a64 6566 2073  n nstack...def s
+000108f0: 656c 6563 7469 7665 5f73 7461 636b 2863  elective_stack(c
+00010900: 635f 6172 7261 792c 2065 7073 696c 6f6e  c_array, epsilon
+00010910: 2c20 6363 5f74 6829 3a20 2023 206e 6f71  , cc_th):  # noq
+00010920: 613a 2046 3831 310a 2020 2020 2222 220a  a: F811.    """.
+00010930: 2020 2020 7468 6973 2069 7320 6120 7365      this is a se
+00010940: 6c65 6374 6976 6520 7374 6163 6b69 6e67  lective stacking
+00010950: 2061 6c67 6f72 6974 686d 2064 6576 656c   algorithm devel
+00010960: 6f70 6564 2062 7920 4a61 7265 6420 4272  oped by Jared Br
+00010970: 7961 6e2f 4b75 7261 6d61 204f 6b75 626f  yan/Kurama Okubo
+00010980: 2e0a 0a20 2020 2050 4152 414d 4554 4552  ...    PARAMETER
+00010990: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
+000109a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
+000109b0: 2020 6363 5f61 7272 6179 3a20 6e75 6d70    cc_array: nump
+000109c0: 792e 6e64 6172 7261 7920 636f 6e74 6169  y.ndarray contai
+000109d0: 6e73 2074 6865 2032 4420 6372 6f73 7320  ns the 2D cross 
+000109e0: 636f 7272 656c 6174 696f 6e20 6d61 7472  correlation matr
+000109f0: 6978 0a20 2020 2065 7073 696c 6f6e 3a20  ix.    epsilon: 
+00010a00: 7265 7369 6475 616c 2074 6872 6568 6f6c  residual threhol
+00010a10: 6420 746f 2071 7569 7420 7468 6520 6974  d to quit the it
+00010a20: 6572 6174 696f 6e0a 2020 2020 6363 5f74  eration.    cc_t
+00010a30: 683a 206e 756d 7079 2e66 6c6f 6174 2c20  h: numpy.float, 
+00010a40: 7468 7265 7368 6f6c 6420 6f66 2063 6f72  threshold of cor
+00010a50: 7265 6c61 7469 6f6e 2063 6f65 6666 6963  relation coeffic
+00010a60: 6965 6e74 2074 6f20 6265 2073 656c 6563  ient to be selec
+00010a70: 7465 640a 0a20 2020 2052 4554 5552 4e53  ted..    RETURNS
+00010a80: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
+00010a90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
+00010aa0: 206e 6577 7374 6163 6b3a 206e 756d 7079   newstack: numpy
+00010ab0: 2076 6563 746f 7220 636f 6e74 6169 6e73   vector contains
+00010ac0: 2074 6865 2073 7461 636b 6564 2063 726f   the stacked cro
+00010ad0: 7373 2063 6f72 7265 6c61 7469 6f6e 0a20  ss correlation. 
+00010ae0: 2020 206e 7374 6570 3a20 6e70 2e69 6e74     nstep: np.int
+00010af0: 2c20 746f 7461 6c20 6e75 6d62 6572 206f  , total number o
+00010b00: 6620 6974 6572 6174 696f 6e73 2066 6f72  f iterations for
+00010b10: 2074 6865 2073 7461 636b 696e 670a 0a20   the stacking.. 
+00010b20: 2020 204f 7269 6769 6e61 6c6c 7920 7269     Originally ri
+00010b30: 7474 656e 2062 7920 4d61 7269 6e65 2044  tten by Marine D
+00010b40: 656e 6f6c 6c65 0a20 2020 204d 6f64 6966  enolle.    Modif
+00010b50: 6965 6420 6279 2043 6865 6e67 7869 6e20  ied by Chengxin 
+00010b60: 4a69 616e 6720 4048 6172 7661 7264 2028  Jiang @Harvard (
+00010b70: 4f63 7432 3032 3029 0a20 2020 2022 2222  Oct2020).    """
+00010b80: 0a20 2020 2069 6620 6363 5f61 7272 6179  .    if cc_array
+00010b90: 2e6e 6469 6d20 3d3d 2031 3a0a 2020 2020  .ndim == 1:.    
+00010ba0: 2020 2020 7072 696e 7428 2232 4420 6d61      print("2D ma
+00010bb0: 7472 6978 2069 7320 6e65 6564 6564 2066  trix is needed f
+00010bc0: 6f72 206e 726f 6f74 5f73 7461 636b 2229  or nroot_stack")
+00010bd0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00010be0: 6363 5f61 7272 6179 0a20 2020 204e 2c20  cc_array.    N, 
+00010bf0: 4d20 3d20 6363 5f61 7272 6179 2e73 6861  M = cc_array.sha
+00010c00: 7065 0a0a 2020 2020 7265 7320 3d20 3965  pe..    res = 9e
+00010c10: 3920 2023 2072 6573 6964 7561 6c73 0a20  9  # residuals. 
+00010c20: 2020 2063 6f66 203d 206e 702e 7a65 726f     cof = np.zero
+00010c30: 7328 4e2c 2064 7479 7065 3d6e 702e 666c  s(N, dtype=np.fl
+00010c40: 6f61 7433 3229 0a20 2020 206e 6577 7374  oat32).    newst
+00010c50: 6163 6b20 3d20 6e70 2e6d 6561 6e28 6363  ack = np.mean(cc
+00010c60: 5f61 7272 6179 2c20 6178 6973 3d30 290a  _array, axis=0).
+00010c70: 0a20 2020 206e 7374 6570 203d 2030 0a20  .    nstep = 0. 
+00010c80: 2020 2023 2073 7461 7274 2069 7465 7261     # start itera
+00010c90: 7469 6f6e 0a20 2020 2077 6869 6c65 2072  tion.    while r
+00010ca0: 6573 203e 2065 7073 696c 6f6e 3a0a 2020  es > epsilon:.  
+00010cb0: 2020 2020 2020 666f 7220 6969 2069 6e20        for ii in 
+00010cc0: 7261 6e67 6528 4e29 3a0a 2020 2020 2020  range(N):.      
+00010cd0: 2020 2020 2020 636f 665b 6969 5d20 3d20        cof[ii] = 
+00010ce0: 6e70 2e63 6f72 7263 6f65 6628 6e65 7773  np.corrcoef(news
+00010cf0: 7461 636b 2c20 6363 5f61 7272 6179 5b69  tack, cc_array[i
+00010d00: 692c 203a 5d29 5b30 2c20 315d 0a0a 2020  i, :])[0, 1]..  
+00010d10: 2020 2020 2020 2320 6669 6e64 2067 6f6f        # find goo
+00010d20: 6420 7761 7665 666f 726d 730a 2020 2020  d waveforms.    
+00010d30: 2020 2020 696e 6478 203d 206e 702e 7768      indx = np.wh
+00010d40: 6572 6528 636f 6620 3e3d 2063 635f 7468  ere(cof >= cc_th
+00010d50: 295b 305d 0a20 2020 2020 2020 2069 6620  )[0].        if 
+00010d60: 6e6f 7420 6c65 6e28 696e 6478 293a 0a20  not len(indx):. 
+00010d70: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00010d80: 2056 616c 7565 4572 726f 7228 2263 616e   ValueError("can
+00010d90: 6e6f 7420 6669 6e64 2067 6f6f 6420 7761  not find good wa
+00010da0: 7665 666f 726d 7320 696e 7369 6465 2073  veforms inside s
+00010db0: 656c 6563 7469 7665 2073 7461 636b 696e  elective stackin
+00010dc0: 6722 290a 2020 2020 2020 2020 6f6c 6473  g").        olds
+00010dd0: 7461 636b 203d 206e 6577 7374 6163 6b0a  tack = newstack.
+00010de0: 2020 2020 2020 2020 6e65 7773 7461 636b          newstack
+00010df0: 203d 206e 702e 6d65 616e 2863 635f 6172   = np.mean(cc_ar
+00010e00: 7261 795b 696e 6478 5d2c 2061 7869 733d  ray[indx], axis=
+00010e10: 3029 0a20 2020 2020 2020 2072 6573 203d  0).        res =
+00010e20: 206e 702e 6c69 6e61 6c67 2e6e 6f72 6d28   np.linalg.norm(
+00010e30: 6e65 7773 7461 636b 202d 206f 6c64 7374  newstack - oldst
+00010e40: 6163 6b29 202f 2028 6e70 2e6c 696e 616c  ack) / (np.linal
+00010e50: 672e 6e6f 726d 286e 6577 7374 6163 6b29  g.norm(newstack)
+00010e60: 202a 204d 290a 2020 2020 2020 2020 6e73   * M).        ns
+00010e70: 7465 7020 2b3d 2031 0a0a 2020 2020 7265  tep += 1..    re
+00010e80: 7475 726e 206e 6577 7374 6163 6b2c 206e  turn newstack, n
+00010e90: 7374 6570 0a0a 0a64 6566 2067 6574 5f63  step...def get_c
+00010ea0: 6328 7331 2c20 735f 7265 6629 3a0a 2020  c(s1, s_ref):.  
+00010eb0: 2020 2320 7265 7475 726e 7320 7468 6520    # returns the 
+00010ec0: 636f 7272 656c 6174 696f 6e20 636f 6566  correlation coef
+00010ed0: 6669 6369 656e 7420 6265 7477 6565 6e20  ficient between 
+00010ee0: 7761 7665 666f 726d 7320 696e 2073 3120  waveforms in s1 
+00010ef0: 6167 6169 6e73 7420 7265 6665 7265 6e63  against referenc
+00010f00: 650a 2020 2020 2320 7761 7665 666f 726d  e.    # waveform
+00010f10: 2073 5f72 6566 2e0a 2020 2020 230a 2020   s_ref..    #.  
+00010f20: 2020 6363 203d 206e 702e 7a65 726f 7328    cc = np.zeros(
+00010f30: 7331 2e73 6861 7065 5b30 5d29 0a20 2020  s1.shape[0]).   
+00010f40: 2073 5f72 6566 5f6e 6f72 6d20 3d20 6e70   s_ref_norm = np
+00010f50: 2e6c 696e 616c 672e 6e6f 726d 2873 5f72  .linalg.norm(s_r
+00010f60: 6566 290a 2020 2020 666f 7220 6920 696e  ef).    for i in
+00010f70: 2072 616e 6765 2873 312e 7368 6170 655b   range(s1.shape[
+00010f80: 305d 293a 0a20 2020 2020 2020 2063 635b  0]):.        cc[
+00010f90: 695d 203d 206e 702e 7375 6d28 6e70 2e6d  i] = np.sum(np.m
+00010fa0: 756c 7469 706c 7928 7331 5b69 2c20 3a5d  ultiply(s1[i, :]
+00010fb0: 2c20 735f 7265 6629 2920 2f20 6e70 2e6c  , s_ref)) / np.l
+00010fc0: 696e 616c 672e 6e6f 726d 2873 315b 692c  inalg.norm(s1[i,
+00010fd0: 203a 5d29 202f 2073 5f72 6566 5f6e 6f72   :]) / s_ref_nor
+00010fe0: 6d0a 2020 2020 7265 7475 726e 2063 630a  m.    return cc.
+00010ff0: 0a0a 2323 2323 2323 2323 2323 2323 2323  ..##############
+00011000: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00011010: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00011020: 2323 2323 2323 2323 2323 0a23 2323 2323  ##########.#####
+00011030: 2323 2323 2323 2323 2323 2320 4d4f 4e49  ########### MONI
+00011040: 544f 5249 4e47 2046 554e 4354 494f 4e53  TORING FUNCTIONS
+00011050: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+00011060: 2323 230a 2323 2323 2323 2323 2323 2323  ###.############
+00011070: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00011080: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00011090: 2323 2323 2323 2323 2323 2323 0a0a 2222  ############..""
+000110a0: 220a 6120 636f 6d70 696c 6174 696f 6e20  ".a compilation 
+000110b0: 6f66 2061 6c6c 2061 7661 696c 6162 6c65  of all available
+000110c0: 2063 6f72 6520 6675 6e63 7469 6f6e 7320   core functions 
+000110d0: 666f 7220 636f 6d70 7574 696e 6720 7068  for computing ph
+000110e0: 6173 6520 6465 6c61 7973 2062 6173 6564  ase delays based
+000110f0: 206f 6e20 616d 6269 656e 7420 6e6f 6973   on ambient nois
+00011100: 6520 696e 7465 7266 6572 6f6d 6574 7279  e interferometry
+00011110: 0a0a 7175 6963 6b20 696e 6465 7820 6f66  ..quick index of
+00011120: 2064 762f 7620 6d65 7468 6f64 733a 0a31   dv/v methods:.1
+00011130: 2920 7374 7265 7463 6869 6e67 2028 7469  ) stretching (ti
+00011140: 6d65 2073 7472 6574 6368 696e 673b 2057  me stretching; W
+00011150: 6561 7665 7220 6574 2061 6c20 2832 3031  eaver et al (201
+00011160: 3129 290a 3229 2064 7477 5f64 7676 2028  1)).2) dtw_dvv (
+00011170: 4479 6e61 6d69 6320 5469 6d65 2057 6172  Dynamic Time War
+00011180: 7069 6e67 3b20 4d69 6b65 7365 6c6c 2065  ping; Mikesell e
+00011190: 7420 616c 2e20 3230 3135 290a 3329 206d  t al. 2015).3) m
+000111a0: 7763 735f 6476 7620 284d 6f76 696e 6720  wcs_dvv (Moving 
+000111b0: 5769 6e64 6f77 2043 726f 7373 2053 7065  Window Cross Spe
+000111c0: 6374 7275 6d3b 2043 6c61 726b 2065 7420  ctrum; Clark et 
+000111d0: 616c 2e2c 2032 3031 3129 0a34 2920 6d77  al., 2011).4) mw
+000111e0: 6363 5f64 7676 2028 4d6f 7669 6e67 2057  cc_dvv (Moving W
+000111f0: 696e 646f 7720 4372 6f73 7320 436f 7272  indow Cross Corr
+00011200: 656c 6174 696f 6e3b 2053 6e69 6564 6572  elation; Snieder
+00011210: 2065 7420 616c 2e2c 2032 3031 3229 0a35   et al., 2012).5
+00011220: 2920 7774 735f 6476 7620 2857 6176 656c  ) wts_dvv (Wavel
+00011230: 6574 2053 7472 6563 6869 6e67 3b20 5975  et Streching; Yu
+00011240: 616e 2065 7420 616c 2e2c 2069 6e20 7072  an et al., in pr
+00011250: 6570 290a 3629 2077 7873 5f64 7676 2028  ep).6) wxs_dvv (
+00011260: 5761 7665 6c65 7420 5872 6f73 7320 5370  Wavelet Xross Sp
+00011270: 6563 7472 756d 3b20 4d61 6f20 6574 2061  ectrum; Mao et a
+00011280: 6c2e 2c20 3230 3139 290a 3729 2077 6477  l., 2019).7) wdw
+00011290: 5f64 7676 2028 5761 7665 6c65 7420 4479  _dvv (Wavelet Dy
+000112a0: 6e61 6d69 6320 5761 7270 696e 673b 2059  namic Warping; Y
+000112b0: 7561 6e20 6574 2061 6c2e 2c20 696e 2070  uan et al., in p
+000112c0: 7265 7029 0a22 2222 0a0a 0a64 6566 2073  rep)."""...def s
+000112d0: 7472 6574 6368 696e 6728 7265 662c 2063  tretching(ref, c
+000112e0: 7572 2c20 6476 5f72 616e 6765 2c20 6e62  ur, dv_range, nb
+000112f0: 7472 6961 6c2c 2070 6172 6129 3a0a 2020  trial, para):.  
+00011300: 2020 2222 220a 2020 2020 5468 6973 2066    """.    This f
+00011310: 756e 6374 696f 6e20 636f 6d70 6172 6573  unction compares
+00011320: 2074 6865 2052 6566 6572 656e 6365 2077   the Reference w
+00011330: 6176 6566 6f72 6d20 746f 2073 7472 6574  aveform to stret
+00011340: 6368 6564 2f63 6f6d 7072 6573 7365 6420  ched/compressed 
+00011350: 6375 7272 656e 7420 7761 7665 666f 726d  current waveform
+00011360: 7320 746f 2067 6574 2074 6865 0a20 2020  s to get the.   
+00011370: 2072 656c 6174 6976 6520 7365 6973 6d69   relative seismi
+00011380: 6320 7665 6c6f 6369 7479 2076 6172 6961  c velocity varia
+00011390: 7469 6f6e 2028 616e 6420 6173 736f 6369  tion (and associ
+000113a0: 6174 6564 2065 7272 6f72 292e 0a20 2020  ated error)..   
+000113b0: 2049 7420 616c 736f 2063 6f6d 7075 7465   It also compute
+000113c0: 7320 7468 6520 636f 7272 656c 6174 696f  s the correlatio
+000113d0: 6e20 636f 6566 6669 6369 656e 7420 6265  n coefficient be
+000113e0: 7477 6565 6e20 7468 6520 5265 6665 7265  tween the Refere
+000113f0: 6e63 6520 7761 7665 666f 726d 2061 6e64  nce waveform and
+00011400: 2074 6865 2063 7572 7265 6e74 2077 6176   the current wav
+00011410: 6566 6f72 6d2e 0a0a 2020 2020 5041 5241  eform...    PARA
+00011420: 4d45 5445 5253 3a0a 2020 2020 2d2d 2d2d  METERS:.    ----
+00011430: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
+00011440: 2072 6566 3a20 5265 6665 7265 6e63 6520   ref: Reference 
+00011450: 7761 7665 666f 726d 2028 6e70 2e6e 6461  waveform (np.nda
+00011460: 7272 6179 2c20 7369 7a65 204e 290a 2020  rray, size N).  
+00011470: 2020 6375 723a 2043 7572 7265 6e74 2077    cur: Current w
+00011480: 6176 6566 6f72 6d20 286e 702e 6e64 6172  aveform (np.ndar
+00011490: 7261 792c 2073 697a 6520 4e29 0a20 2020  ray, size N).   
+000114a0: 2064 765f 7261 6e67 653a 2061 6273 6f6c   dv_range: absol
+000114b0: 7574 6520 626f 756e 6420 666f 7220 7468  ute bound for th
+000114c0: 6520 7665 6c6f 6369 7479 2076 6172 6961  e velocity varia
+000114d0: 7469 6f6e 3b20 6578 616d 706c 653a 2064  tion; example: d
+000114e0: 763d 302e 3033 2066 6f72 205b 2d33 2c33  v=0.03 for [-3,3
+000114f0: 5d25 0a20 2020 206f 6620 7265 6c61 7469  ]%.    of relati
+00011500: 7665 2076 656c 6f63 6974 7920 6368 616e  ve velocity chan
+00011510: 6765 2028 2766 6c6f 6174 2729 0a20 2020  ge ('float').   
+00011520: 206e 6274 7269 616c 3a20 6e75 6d62 6572   nbtrial: number
+00011530: 206f 6620 7374 7265 7463 6869 6e67 2063   of stretching c
+00011540: 6f65 6666 6963 6965 6e74 2062 6574 7765  oefficient betwe
+00011550: 656e 2064 766d 696e 2061 6e64 2064 766d  en dvmin and dvm
+00011560: 6178 2c20 6e6f 206e 6565 6420 746f 2062  ax, no need to b
+00011570: 6520 6869 6768 6572 2074 6861 6e20 3130  e higher than 10
+00011580: 3020 2028 2766 6c6f 6174 2729 0a20 2020  0  ('float').   
+00011590: 2070 6172 613a 2076 6563 746f 7220 6f66   para: vector of
+000115a0: 2074 6865 2069 6e64 6963 6573 206f 6620   the indices of 
+000115b0: 7468 6520 6375 7220 616e 6420 7265 6620  the cur and ref 
+000115c0: 7769 6e64 6f77 7320 6f6e 2077 6963 6820  windows on wich 
+000115d0: 796f 7520 7761 6e74 2074 6f20 646f 2074  you want to do t
+000115e0: 6865 206d 6561 7375 7265 6d65 6e74 730a  he measurements.
+000115f0: 2020 2020 286e 702e 6e64 6172 7261 792c      (np.ndarray,
+00011600: 2073 697a 6520 746d 696e 2a64 656c 7461   size tmin*delta
+00011610: 3a74 6d61 782a 6465 6c74 6129 0a20 2020  :tmax*delta).   
+00011620: 2046 6f72 2065 7272 6f72 2063 6f6d 7075   For error compu
+00011630: 7461 7469 6f6e 2c20 7765 206e 6565 6420  tation, we need 
+00011640: 7061 7261 6d65 7465 7273 3a0a 2020 2020  parameters:.    
+00011650: 2020 2020 666d 696e 3a20 6d69 6e69 6d75      fmin: minimu
+00011660: 6d20 6672 6571 7565 6e63 7920 6f66 2074  m frequency of t
+00011670: 6865 2064 6174 610a 2020 2020 2020 2020  he data.        
+00011680: 666d 6178 3a20 6d61 7869 6d75 6d20 6672  fmax: maximum fr
+00011690: 6571 7565 6e63 7920 6f66 2074 6865 2064  equency of the d
+000116a0: 6174 610a 2020 2020 2020 2020 746d 696e  ata.        tmin
+000116b0: 3a20 6d69 6e69 6d75 6d20 7469 6d65 2077  : minimum time w
+000116c0: 696e 646f 7720 7768 6572 6520 7468 6520  indow where the 
+000116d0: 6476 2f76 2069 7320 636f 6d70 7574 6564  dv/v is computed
+000116e0: 0a20 2020 2020 2020 2074 6d61 783a 206d  .        tmax: m
+000116f0: 6178 696d 756d 2074 696d 6520 7769 6e64  aximum time wind
+00011700: 6f77 2077 6865 7265 2074 6865 2064 762f  ow where the dv/
+00011710: 7620 6973 2063 6f6d 7075 7465 640a 2020  v is computed.  
+00011720: 2020 5245 5455 524e 533a 0a20 2020 202d    RETURNS:.    -
+00011730: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
+00011740: 2020 2020 6476 3a20 5265 6c61 7469 7665      dv: Relative
+00011750: 2076 656c 6f63 6974 7920 6368 616e 6765   velocity change
+00011760: 2064 762f 7620 2869 6e20 2529 0a20 2020   dv/v (in %).   
+00011770: 2063 633a 2063 6f72 7265 6c61 7469 6f6e   cc: correlation
+00011780: 2063 6f65 6666 6963 6965 6e74 2062 6574   coefficient bet
+00011790: 7765 656e 2074 6865 2072 6566 6572 656e  ween the referen
+000117a0: 6365 2077 6176 6566 6f72 6d20 616e 6420  ce waveform and 
+000117b0: 7468 6520 6265 7374 2073 7472 6574 6368  the best stretch
+000117c0: 6564 2f63 6f6d 7072 6573 7365 6420 6375  ed/compressed cu
+000117d0: 7272 656e 7420 7761 7665 666f 726d 0a20  rrent waveform. 
+000117e0: 2020 2063 6470 3a20 636f 7272 656c 6174     cdp: correlat
+000117f0: 696f 6e20 636f 6566 6669 6369 656e 7420  ion coefficient 
+00011800: 6265 7477 6565 6e20 7468 6520 7265 6665  between the refe
+00011810: 7265 6e63 6520 7761 7665 666f 726d 2061  rence waveform a
+00011820: 6e64 2074 6865 2069 6e69 7469 616c 2063  nd the initial c
+00011830: 7572 7265 6e74 2077 6176 6566 6f72 6d0a  urrent waveform.
+00011840: 2020 2020 6572 726f 723a 2045 7272 6f72      error: Error
+00011850: 7320 696e 2074 6865 2064 762f 7620 6d65  s in the dv/v me
+00011860: 6173 7572 656d 656e 7473 2062 6173 6564  asurements based
+00011870: 206f 6e20 5765 6176 6572 2065 7420 616c   on Weaver et al
+00011880: 2028 3230 3131 292c 0a20 2020 204f 6e20   (2011),.    On 
+00011890: 7468 6520 7072 6563 6973 696f 6e20 6f66  the precision of
+000118a0: 206e 6f69 7365 2d63 6f72 7265 6c61 7469   noise-correlati
+000118b0: 6f6e 2069 6e74 6572 6665 726f 6d65 7472  on interferometr
+000118c0: 792c 2047 656f 7068 7973 2e20 4a2e 2049  y, Geophys. J. I
+000118d0: 6e74 2e2c 2031 3835 2833 290a 0a20 2020  nt., 185(3)..   
+000118e0: 204e 6f74 653a 2054 6865 2063 6f64 6520   Note: The code 
+000118f0: 6669 7273 7420 6669 6e64 7320 7468 6520  first finds the 
+00011900: 6265 7374 2063 6f72 7265 6c61 7469 6f6e  best correlation
+00011910: 2063 6f65 6666 6963 6965 6e74 2062 6574   coefficient bet
+00011920: 7765 656e 2074 6865 2052 6566 6572 656e  ween the Referen
+00011930: 6365 2077 6176 6566 6f72 6d20 616e 640a  ce waveform and.
+00011940: 2020 2020 7468 6520 7374 7265 7463 6865      the stretche
+00011950: 642f 636f 6d70 7265 7373 6564 2063 7572  d/compressed cur
+00011960: 7265 6e74 2077 6176 6566 6f72 6d20 616d  rent waveform am
+00011970: 6f6e 6720 7468 6520 226e 6274 7269 616c  ong the "nbtrial
+00011980: 2220 7661 6c75 6573 2e0a 2020 2020 4120  " values..    A 
+00011990: 7265 6669 6e65 6420 616e 616c 7973 6973  refined analysis
+000119a0: 2069 7320 7468 656e 2070 6572 666f 726d   is then perform
+000119b0: 6564 2061 726f 756e 6420 7468 6973 2076  ed around this v
+000119c0: 616c 7565 2074 6f20 6f62 7461 696e 2061  alue to obtain a
+000119d0: 206d 6f72 6520 7072 6563 6973 6520 6476   more precise dv
+000119e0: 2f76 206d 6561 7375 7265 6d65 6e74 202e  /v measurement .
+000119f0: 0a0a 2020 2020 4f72 6967 696e 616c 6c79  ..    Originally
+00011a00: 2062 7920 4c2e 2056 6965 6e73 2030 342f   by L. Viens 04/
+00011a10: 3236 2f32 3031 3820 2856 6965 6e73 2065  26/2018 (Viens e
+00011a20: 7420 616c 2e2c 2032 3031 3820 4a47 5229  t al., 2018 JGR)
+00011a30: 0a20 2020 206d 6f64 6966 6965 6420 6279  .    modified by
+00011a40: 2043 6865 6e67 7869 6e20 4a69 616e 670a   Chengxin Jiang.
+00011a50: 2020 2020 2222 220a 2020 2020 2320 6c6f      """.    # lo
+00011a60: 6164 2063 6f6d 6d6f 6e20 7661 7269 6162  ad common variab
+00011a70: 6c65 7320 6672 6f6d 2064 6963 7469 6f6e  les from diction
+00011a80: 6172 790a 2020 2020 7477 696e 203d 2070  ary.    twin = p
+00011a90: 6172 615b 2274 7769 6e22 5d0a 2020 2020  ara["twin"].    
+00011aa0: 6672 6571 203d 2070 6172 615b 2266 7265  freq = para["fre
+00011ab0: 7122 5d0a 2020 2020 6474 203d 2070 6172  q"].    dt = par
+00011ac0: 615b 2264 7422 5d0a 2020 2020 746d 696e  a["dt"].    tmin
+00011ad0: 203d 206e 702e 6d69 6e28 7477 696e 290a   = np.min(twin).
+00011ae0: 2020 2020 746d 6178 203d 206e 702e 6d61      tmax = np.ma
+00011af0: 7828 7477 696e 290a 2020 2020 666d 696e  x(twin).    fmin
+00011b00: 203d 206e 702e 6d69 6e28 6672 6571 290a   = np.min(freq).
+00011b10: 2020 2020 666d 6178 203d 206e 702e 6d61      fmax = np.ma
+00011b20: 7828 6672 6571 290a 2020 2020 7476 6563  x(freq).    tvec
+00011b30: 203d 206e 702e 6172 616e 6765 2874 6d69   = np.arange(tmi
+00011b40: 6e2c 2074 6d61 782c 2064 7429 0a0a 2020  n, tmax, dt)..  
+00011b50: 2020 2320 6d61 6b65 2075 7365 6675 6c20    # make useful 
+00011b60: 6f6e 6520 666f 7220 6d65 6173 7572 656d  one for measurem
+00011b70: 656e 7473 0a20 2020 2064 766d 696e 203d  ents.    dvmin =
+00011b80: 202d 6e70 2e61 6273 2864 765f 7261 6e67   -np.abs(dv_rang
+00011b90: 6529 0a20 2020 2064 766d 6178 203d 206e  e).    dvmax = n
+00011ba0: 702e 6162 7328 6476 5f72 616e 6765 290a  p.abs(dv_range).
+00011bb0: 2020 2020 4570 7320 3d20 3120 2b20 286e      Eps = 1 + (n
+00011bc0: 702e 6c69 6e73 7061 6365 2864 766d 696e  p.linspace(dvmin
+00011bd0: 2c20 6476 6d61 782c 206e 6274 7269 616c  , dvmax, nbtrial
+00011be0: 2929 0a20 2020 2063 6f66 203d 206e 702e  )).    cof = np.
+00011bf0: 7a65 726f 7328 4570 732e 7368 6170 652c  zeros(Eps.shape,
+00011c00: 2064 7479 7065 3d6e 702e 666c 6f61 7433   dtype=np.float3
+00011c10: 3229 0a0a 2020 2020 2320 5365 7420 6f66  2)..    # Set of
+00011c20: 2073 7472 6574 6368 6564 2f63 6f6d 7072   stretched/compr
+00011c30: 6573 7365 6420 6375 7272 656e 7420 7761  essed current wa
+00011c40: 7665 666f 726d 730a 2020 2020 666f 7220  veforms.    for 
+00011c50: 6969 2069 6e20 7261 6e67 6528 6c65 6e28  ii in range(len(
+00011c60: 4570 7329 293a 0a20 2020 2020 2020 206e  Eps)):.        n
+00011c70: 7420 3d20 7476 6563 202a 2045 7073 5b69  t = tvec * Eps[i
+00011c80: 695d 0a20 2020 2020 2020 2073 203d 206e  i].        s = n
+00011c90: 702e 696e 7465 7270 2878 3d74 7665 632c  p.interp(x=tvec,
+00011ca0: 2078 703d 6e74 2c20 6670 3d63 7572 290a   xp=nt, fp=cur).
+00011cb0: 2020 2020 2020 2020 7761 7665 666f 726d          waveform
+00011cc0: 5f72 6566 203d 2072 6566 0a20 2020 2020  _ref = ref.     
+00011cd0: 2020 2077 6176 6566 6f72 6d5f 6375 7220     waveform_cur 
+00011ce0: 3d20 730a 2020 2020 2020 2020 636f 665b  = s.        cof[
+00011cf0: 6969 5d20 3d20 6e70 2e63 6f72 7263 6f65  ii] = np.corrcoe
+00011d00: 6628 7761 7665 666f 726d 5f72 6566 2c20  f(waveform_ref, 
+00011d10: 7761 7665 666f 726d 5f63 7572 295b 302c  waveform_cur)[0,
+00011d20: 2031 5d0a 0a20 2020 2063 6470 203d 206e   1]..    cdp = n
+00011d30: 702e 636f 7272 636f 6566 2863 7572 2c20  p.corrcoef(cur, 
+00011d40: 7265 6629 5b30 2c20 315d 2020 2320 636f  ref)[0, 1]  # co
+00011d50: 7272 656c 6174 696f 6e20 636f 6566 6669  rrelation coeffi
+00011d60: 6369 656e 7420 6265 7477 6565 6e20 7468  cient between th
+00011d70: 6520 7265 6665 7265 6e63 6520 616e 6420  e reference and 
+00011d80: 696e 6974 6961 6c20 6375 7272 656e 7420  initial current 
+00011d90: 7761 7665 666f 726d 730a 0a20 2020 2023  waveforms..    #
+00011da0: 2066 696e 6420 7468 6520 6d61 7869 6d75   find the maximu
+00011db0: 6d20 636f 7272 656c 6174 696f 6e20 636f  m correlation co
+00011dc0: 6566 6669 6369 656e 740a 2020 2020 696d  efficient.    im
+00011dd0: 6178 203d 206e 702e 6e61 6e61 7267 6d61  ax = np.nanargma
+00011de0: 7828 636f 6629 0a20 2020 2069 6620 696d  x(cof).    if im
+00011df0: 6178 203e 3d20 6c65 6e28 4570 7329 202d  ax >= len(Eps) -
+00011e00: 2032 3a0a 2020 2020 2020 2020 696d 6178   2:.        imax
+00011e10: 203d 2069 6d61 7820 2d20 320a 2020 2020   = imax - 2.    
+00011e20: 6966 2069 6d61 7820 3c3d 2032 3a0a 2020  if imax <= 2:.  
+00011e30: 2020 2020 2020 696d 6178 203d 2069 6d61        imax = ima
+00011e40: 7820 2b20 320a 0a20 2020 2023 2050 726f  x + 2..    # Pro
+00011e50: 6365 6564 2074 6f20 7468 6520 7365 636f  ceed to the seco
+00011e60: 6e64 2073 7465 7020 746f 2067 6574 2061  nd step to get a
+00011e70: 206d 6f72 6520 7072 6563 6973 6520 6476   more precise dv
+00011e80: 2f76 206d 6561 7375 7265 6d65 6e74 0a20  /v measurement. 
+00011e90: 2020 2064 7466 696e 6572 203d 206e 702e     dtfiner = np.
+00011ea0: 6c69 6e73 7061 6365 2845 7073 5b69 6d61  linspace(Eps[ima
+00011eb0: 7820 2d20 325d 2c20 4570 735b 696d 6178  x - 2], Eps[imax
+00011ec0: 202b 2032 5d2c 2031 3030 290a 2020 2020   + 2], 100).    
+00011ed0: 6e63 6f66 203d 206e 702e 7a65 726f 7328  ncof = np.zeros(
+00011ee0: 6474 6669 6e65 722e 7368 6170 652c 2064  dtfiner.shape, d
+00011ef0: 7479 7065 3d6e 702e 666c 6f61 7433 3229  type=np.float32)
+00011f00: 0a20 2020 2066 6f72 2069 6920 696e 2072  .    for ii in r
+00011f10: 616e 6765 286c 656e 2864 7466 696e 6572  ange(len(dtfiner
+00011f20: 2929 3a0a 2020 2020 2020 2020 6e74 203d  )):.        nt =
+00011f30: 2074 7665 6320 2a20 6474 6669 6e65 725b   tvec * dtfiner[
+00011f40: 6969 5d0a 2020 2020 2020 2020 7320 3d20  ii].        s = 
+00011f50: 6e70 2e69 6e74 6572 7028 783d 7476 6563  np.interp(x=tvec
+00011f60: 2c20 7870 3d6e 742c 2066 703d 6375 7229  , xp=nt, fp=cur)
+00011f70: 0a20 2020 2020 2020 2077 6176 6566 6f72  .        wavefor
+00011f80: 6d5f 7265 6620 3d20 7265 660a 2020 2020  m_ref = ref.    
+00011f90: 2020 2020 7761 7665 666f 726d 5f63 7572      waveform_cur
+00011fa0: 203d 2073 0a20 2020 2020 2020 206e 636f   = s.        nco
+00011fb0: 665b 6969 5d20 3d20 6e70 2e63 6f72 7263  f[ii] = np.corrc
+00011fc0: 6f65 6628 7761 7665 666f 726d 5f72 6566  oef(waveform_ref
+00011fd0: 2c20 7761 7665 666f 726d 5f63 7572 295b  , waveform_cur)[
+00011fe0: 302c 2031 5d0a 0a20 2020 2063 6320 3d20  0, 1]..    cc = 
+00011ff0: 6e70 2e6d 6178 286e 636f 6629 2020 2320  np.max(ncof)  # 
+00012000: 4669 6e64 206d 6178 696d 756d 2063 6f72  Find maximum cor
+00012010: 7265 6c61 7469 6f6e 2063 6f65 6666 6963  relation coeffic
+00012020: 6965 6e74 206f 6620 7468 6520 7265 6669  ient of the refi
+00012030: 6e65 6420 2061 6e61 6c79 7369 730a 2020  ned  analysis.  
+00012040: 2020 6476 203d 2031 3030 2e30 202a 2064    dv = 100.0 * d
+00012050: 7466 696e 6572 5b6e 702e 6172 676d 6178  tfiner[np.argmax
+00012060: 286e 636f 6629 5d20 2d20 3130 3020 2023  (ncof)] - 100  #
+00012070: 204d 756c 7469 706c 7920 6279 2031 3030   Multiply by 100
+00012080: 2074 6f20 636f 6e76 6572 7420 746f 2070   to convert to p
+00012090: 6572 6365 6e74 6167 6520 2845 7073 696c  ercentage (Epsil
+000120a0: 6f6e 203d 202d 6474 2f74 203d 2064 762f  on = -dt/t = dv/
+000120b0: 7629 0a0a 2020 2020 2320 4572 726f 7220  v)..    # Error 
+000120c0: 636f 6d70 7574 6174 696f 6e20 6261 7365  computation base
+000120d0: 6420 6f6e 2057 6561 7665 7220 6574 2061  d on Weaver et a
+000120e0: 6c20 2832 3031 3129 2c20 4f6e 2074 6865  l (2011), On the
+000120f0: 2070 7265 6369 7369 6f6e 206f 6620 6e6f   precision of no
+00012100: 6973 652d 636f 7272 656c 6174 696f 6e0a  ise-correlation.
+00012110: 2020 2020 2320 696e 7465 7266 6572 6f6d      # interferom
+00012120: 6574 7279 2c20 4765 6f70 6879 732e 204a  etry, Geophys. J
+00012130: 2e20 496e 742e 2c20 3138 3528 3329 0a20  . Int., 185(3). 
+00012140: 2020 2054 203d 2031 202f 2028 666d 6178     T = 1 / (fmax
+00012150: 202d 2066 6d69 6e29 0a20 2020 2058 203d   - fmin).    X =
+00012160: 2063 630a 2020 2020 7763 203d 206e 702e   cc.    wc = np.
+00012170: 7069 202a 2028 666d 696e 202b 2066 6d61  pi * (fmin + fma
+00012180: 7829 0a20 2020 2074 3120 3d20 6e70 2e6d  x).    t1 = np.m
+00012190: 696e 285b 746d 696e 2c20 746d 6178 5d29  in([tmin, tmax])
+000121a0: 0a20 2020 2074 3220 3d20 6e70 2e6d 6178  .    t2 = np.max
+000121b0: 285b 746d 696e 2c20 746d 6178 5d29 0a20  ([tmin, tmax]). 
+000121c0: 2020 2065 7272 6f72 203d 2031 3030 202a     error = 100 *
+000121d0: 2028 0a20 2020 2020 2020 206e 702e 7371   (.        np.sq
+000121e0: 7274 2831 202d 2058 2a2a 3229 202f 2028  rt(1 - X**2) / (
+000121f0: 3220 2a20 5829 202a 206e 702e 7371 7274  2 * X) * np.sqrt
+00012200: 2828 3620 2a20 6e70 2e73 7172 7428 6e70  ((6 * np.sqrt(np
+00012210: 2e70 6920 2f20 3229 202a 2054 2920 2f20  .pi / 2) * T) / 
+00012220: 2877 632a 2a32 202a 2028 7432 2a2a 3320  (wc**2 * (t2**3 
+00012230: 2d20 7431 2a2a 3329 2929 0a20 2020 2029  - t1**3))).    )
+00012240: 0a0a 2020 2020 7265 7475 726e 2064 762c  ..    return dv,
+00012250: 2065 7272 6f72 2c20 6363 2c20 6364 700a   error, cc, cdp.
+00012260: 0a0a 6465 6620 7374 7265 7463 6869 6e67  ..def stretching
+00012270: 5f76 6563 7428 7265 662c 2063 7572 2c20  _vect(ref, cur, 
+00012280: 6476 5f72 616e 6765 2c20 6e62 7472 6961  dv_range, nbtria
+00012290: 6c2c 2070 6172 6129 3a0a 2020 2020 2222  l, para):.    ""
+000122a0: 220a 2020 2020 5468 6973 2066 756e 6374  ".    This funct
+000122b0: 696f 6e20 636f 6d70 6172 6573 2074 6865  ion compares the
+000122c0: 2052 6566 6572 656e 6365 2077 6176 6566   Reference wavef
+000122d0: 6f72 6d20 746f 2073 7472 6574 6368 6564  orm to stretched
+000122e0: 2f63 6f6d 7072 6573 7365 6420 6375 7272  /compressed curr
+000122f0: 656e 7420 7761 7665 666f 726d 730a 2020  ent waveforms.  
+00012300: 2020 746f 2067 6574 2074 6865 2072 656c    to get the rel
+00012310: 6174 6976 6520 7365 6973 6d69 6320 7665  ative seismic ve
+00012320: 6c6f 6369 7479 2076 6172 6961 7469 6f6e  locity variation
+00012330: 2028 616e 6420 6173 736f 6369 6174 6564   (and associated
+00012340: 2065 7272 6f72 292e 0a20 2020 2049 7420   error)..    It 
+00012350: 616c 736f 2063 6f6d 7075 7465 7320 7468  also computes th
+00012360: 6520 636f 7272 656c 6174 696f 6e20 636f  e correlation co
+00012370: 6566 6669 6369 656e 7420 6265 7477 6565  efficient betwee
+00012380: 6e20 7468 6520 5265 6665 7265 6e63 6520  n the Reference 
+00012390: 7761 7665 666f 726d 2061 6e64 2074 6865  waveform and the
+000123a0: 2063 7572 7265 6e74 2077 6176 6566 6f72   current wavefor
+000123b0: 6d2e 0a0a 2020 2020 5041 5241 4d45 5445  m...    PARAMETE
+000123c0: 5253 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  RS:.    --------
+000123d0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2072 6566  --------.    ref
+000123e0: 3a20 5265 6665 7265 6e63 6520 7761 7665  : Reference wave
+000123f0: 666f 726d 2028 6e70 2e6e 6461 7272 6179  form (np.ndarray
+00012400: 2c20 7369 7a65 204e 290a 2020 2020 6375  , size N).    cu
+00012410: 723a 2043 7572 7265 6e74 2077 6176 6566  r: Current wavef
+00012420: 6f72 6d20 286e 702e 6e64 6172 7261 792c  orm (np.ndarray,
+00012430: 2073 697a 6520 4e29 0a20 2020 2064 765f   size N).    dv_
+00012440: 7261 6e67 653a 2061 6273 6f6c 7574 6520  range: absolute 
+00012450: 626f 756e 6420 666f 7220 7468 6520 7665  bound for the ve
+00012460: 6c6f 6369 7479 2076 6172 6961 7469 6f6e  locity variation
+00012470: 3b20 6578 616d 706c 653a 2064 763d 302e  ; example: dv=0.
+00012480: 3033 2066 6f72 205b 2d33 2c33 5d25 0a20  03 for [-3,3]%. 
+00012490: 2020 206f 6620 7265 6c61 7469 7665 2076     of relative v
+000124a0: 656c 6f63 6974 7920 6368 616e 6765 2028  elocity change (
+000124b0: 2766 6c6f 6174 2729 0a20 2020 206e 6274  'float').    nbt
+000124c0: 7269 616c 3a20 6e75 6d62 6572 206f 6620  rial: number of 
+000124d0: 7374 7265 7463 6869 6e67 2063 6f65 6666  stretching coeff
+000124e0: 6963 6965 6e74 2062 6574 7765 656e 2064  icient between d
+000124f0: 766d 696e 2061 6e64 2064 766d 6178 2c20  vmin and dvmax, 
+00012500: 6e6f 206e 6565 6420 746f 2062 6520 6869  no need to be hi
+00012510: 6768 6572 2074 6861 6e20 3130 3020 2028  gher than 100  (
+00012520: 2766 6c6f 6174 2729 0a20 2020 2070 6172  'float').    par
+00012530: 613a 2076 6563 746f 7220 6f66 2074 6865  a: vector of the
+00012540: 2069 6e64 6963 6573 206f 6620 7468 6520   indices of the 
+00012550: 6375 7220 616e 6420 7265 6620 7769 6e64  cur and ref wind
+00012560: 6f77 7320 6f6e 2077 6963 6820 796f 7520  ows on wich you 
+00012570: 7761 6e74 2074 6f20 646f 2074 6865 0a20  want to do the. 
+00012580: 2020 206d 6561 7375 7265 6d65 6e74 7320     measurements 
+00012590: 286e 702e 6e64 6172 7261 792c 2073 697a  (np.ndarray, siz
+000125a0: 6520 746d 696e 2a64 656c 7461 3a74 6d61  e tmin*delta:tma
+000125b0: 782a 6465 6c74 6129 0a20 2020 2046 6f72  x*delta).    For
+000125c0: 2065 7272 6f72 2063 6f6d 7075 7461 7469   error computati
+000125d0: 6f6e 2c20 7765 206e 6565 6420 7061 7261  on, we need para
+000125e0: 6d65 7465 7273 3a0a 2020 2020 2020 2020  meters:.        
+000125f0: 666d 696e 3a20 6d69 6e69 6d75 6d20 6672  fmin: minimum fr
+00012600: 6571 7565 6e63 7920 6f66 2074 6865 2064  equency of the d
+00012610: 6174 610a 2020 2020 2020 2020 666d 6178  ata.        fmax
+00012620: 3a20 6d61 7869 6d75 6d20 6672 6571 7565  : maximum freque
+00012630: 6e63 7920 6f66 2074 6865 2064 6174 610a  ncy of the data.
+00012640: 2020 2020 2020 2020 746d 696e 3a20 6d69          tmin: mi
+00012650: 6e69 6d75 6d20 7469 6d65 2077 696e 646f  nimum time windo
+00012660: 7720 7768 6572 6520 7468 6520 6476 2f76  w where the dv/v
+00012670: 2069 7320 636f 6d70 7574 6564 0a20 2020   is computed.   
+00012680: 2020 2020 2074 6d61 783a 206d 6178 696d       tmax: maxim
+00012690: 756d 2074 696d 6520 7769 6e64 6f77 2077  um time window w
+000126a0: 6865 7265 2074 6865 2064 762f 7620 6973  here the dv/v is
+000126b0: 2063 6f6d 7075 7465 640a 2020 2020 5245   computed.    RE
+000126c0: 5455 524e 533a 0a20 2020 202d 2d2d 2d2d  TURNS:.    -----
+000126d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
+000126e0: 6476 3a20 5265 6c61 7469 7665 2076 656c  dv: Relative vel
+000126f0: 6f63 6974 7920 6368 616e 6765 2064 762f  ocity change dv/
+00012700: 7620 2869 6e20 2529 0a20 2020 2063 633a  v (in %).    cc:
+00012710: 2063 6f72 7265 6c61 7469 6f6e 2063 6f65   correlation coe
+00012720: 6666 6963 6965 6e74 2062 6574 7765 656e  fficient between
+00012730: 2074 6865 2072 6566 6572 656e 6365 2077   the reference w
+00012740: 6176 6566 6f72 6d20 616e 6420 7468 6520  aveform and the 
+00012750: 6265 7374 2073 7472 6574 6368 6564 2f63  best stretched/c
+00012760: 6f6d 7072 6573 7365 6420 6375 7272 656e  ompressed curren
+00012770: 7420 7761 7665 666f 726d 0a20 2020 2063  t waveform.    c
+00012780: 6470 3a20 636f 7272 656c 6174 696f 6e20  dp: correlation 
+00012790: 636f 6566 6669 6369 656e 7420 6265 7477  coefficient betw
+000127a0: 6565 6e20 7468 6520 7265 6665 7265 6e63  een the referenc
+000127b0: 6520 7761 7665 666f 726d 2061 6e64 2074  e waveform and t
+000127c0: 6865 2069 6e69 7469 616c 2063 7572 7265  he initial curre
+000127d0: 6e74 2077 6176 6566 6f72 6d0a 2020 2020  nt waveform.    
+000127e0: 6572 726f 723a 2045 7272 6f72 7320 696e  error: Errors in
+000127f0: 2074 6865 2064 762f 7620 6d65 6173 7572   the dv/v measur
+00012800: 656d 656e 7473 2062 6173 6564 206f 6e20  ements based on 
+00012810: 5765 6176 6572 2065 7420 616c 2028 3230  Weaver et al (20
+00012820: 3131 292c 204f 6e20 7468 6520 7072 6563  11), On the prec
+00012830: 6973 696f 6e0a 2020 2020 6f66 206e 6f69  ision.    of noi
+00012840: 7365 2d63 6f72 7265 6c61 7469 6f6e 2069  se-correlation i
+00012850: 6e74 6572 6665 726f 6d65 7472 792c 2047  nterferometry, G
+00012860: 656f 7068 7973 2e20 4a2e 2049 6e74 2e2c  eophys. J. Int.,
+00012870: 2031 3835 2833 290a 0a20 2020 204e 6f74   185(3)..    Not
+00012880: 653a 2054 6865 2063 6f64 6520 6669 7273  e: The code firs
+00012890: 7420 6669 6e64 7320 7468 6520 6265 7374  t finds the best
+000128a0: 2063 6f72 7265 6c61 7469 6f6e 2063 6f65   correlation coe
+000128b0: 6666 6963 6965 6e74 2062 6574 7765 656e  fficient between
+000128c0: 2074 6865 2052 6566 6572 656e 6365 2077   the Reference w
+000128d0: 6176 6566 6f72 6d20 616e 640a 2020 2020  aveform and.    
+000128e0: 7468 6520 7374 7265 7463 6865 642f 636f  the stretched/co
+000128f0: 6d70 7265 7373 6564 2063 7572 7265 6e74  mpressed current
+00012900: 2077 6176 6566 6f72 6d20 616d 6f6e 6720   waveform among 
+00012910: 7468 6520 226e 6274 7269 616c 2220 7661  the "nbtrial" va
+00012920: 6c75 6573 2e0a 2020 2020 4120 7265 6669  lues..    A refi
+00012930: 6e65 6420 616e 616c 7973 6973 2069 7320  ned analysis is 
+00012940: 7468 656e 2070 6572 666f 726d 6564 2061  then performed a
+00012950: 726f 756e 6420 7468 6973 2076 616c 7565  round this value
+00012960: 2074 6f20 6f62 7461 696e 2061 206d 6f72   to obtain a mor
+00012970: 6520 7072 6563 6973 6520 6476 2f76 206d  e precise dv/v m
+00012980: 6561 7375 7265 6d65 6e74 202e 0a0a 2020  easurement ...  
+00012990: 2020 4f72 6967 696e 616c 6c79 2062 7920    Originally by 
+000129a0: 4c2e 2056 6965 6e73 2030 342f 3236 2f32  L. Viens 04/26/2
+000129b0: 3031 3820 2856 6965 6e73 2065 7420 616c  018 (Viens et al
+000129c0: 2e2c 2032 3031 3820 4a47 5229 0a20 2020  ., 2018 JGR).   
+000129d0: 206d 6f64 6966 6965 6420 6279 2043 6865   modified by Che
+000129e0: 6e67 7869 6e20 4a69 616e 670a 2020 2020  ngxin Jiang.    
+000129f0: 6d6f 6469 6669 6564 2062 7920 4c61 7572  modified by Laur
+00012a00: 6120 4572 6d65 7274 3a20 7665 6374 6f72  a Ermert: vector
+00012a10: 697a 6564 2076 6572 7369 6f6e 0a20 2020  ized version.   
+00012a20: 2022 2222 0a20 2020 2023 206c 6f61 6420   """.    # load 
+00012a30: 636f 6d6d 6f6e 2076 6172 6961 626c 6573  common variables
+00012a40: 2066 726f 6d20 6469 6374 696f 6e61 7279   from dictionary
+00012a50: 0a20 2020 2074 7769 6e20 3d20 7061 7261  .    twin = para
+00012a60: 5b22 7477 696e 225d 0a20 2020 2066 7265  ["twin"].    fre
+00012a70: 7120 3d20 7061 7261 5b22 6672 6571 225d  q = para["freq"]
+00012a80: 0a20 2020 2064 7420 3d20 7061 7261 5b22  .    dt = para["
+00012a90: 6474 225d 0a20 2020 2074 6d69 6e20 3d20  dt"].    tmin = 
+00012aa0: 6e70 2e6d 696e 2874 7769 6e29 0a20 2020  np.min(twin).   
+00012ab0: 2074 6d61 7820 3d20 6e70 2e6d 6178 2874   tmax = np.max(t
+00012ac0: 7769 6e29 0a20 2020 2066 6d69 6e20 3d20  win).    fmin = 
+00012ad0: 6e70 2e6d 696e 2866 7265 7129 0a20 2020  np.min(freq).   
+00012ae0: 2066 6d61 7820 3d20 6e70 2e6d 6178 2866   fmax = np.max(f
+00012af0: 7265 7129 0a20 2020 2074 7665 6320 3d20  req).    tvec = 
+00012b00: 6e70 2e61 7261 6e67 6528 746d 696e 2c20  np.arange(tmin, 
+00012b10: 746d 6178 2c20 6474 290a 0a20 2020 2023  tmax, dt)..    #
+00012b20: 206d 616b 6520 7573 6566 756c 206f 6e65   make useful one
+00012b30: 2066 6f72 206d 6561 7375 7265 6d65 6e74   for measurement
+00012b40: 730a 2020 2020 6476 6d69 6e20 3d20 2d6e  s.    dvmin = -n
+00012b50: 702e 6162 7328 6476 5f72 616e 6765 290a  p.abs(dv_range).
+00012b60: 2020 2020 6476 6d61 7820 3d20 6e70 2e61      dvmax = np.a
+00012b70: 6273 2864 765f 7261 6e67 6529 0a20 2020  bs(dv_range).   
+00012b80: 2045 7073 203d 2031 202b 2028 6e70 2e6c   Eps = 1 + (np.l
+00012b90: 696e 7370 6163 6528 6476 6d69 6e2c 2064  inspace(dvmin, d
+00012ba0: 766d 6178 2c20 6e62 7472 6961 6c29 290a  vmax, nbtrial)).
+00012bb0: 2020 2020 6364 7020 3d20 6e70 2e63 6f72      cdp = np.cor
+00012bc0: 7263 6f65 6628 6375 722c 2072 6566 295b  rcoef(cur, ref)[
+00012bd0: 302c 2031 5d20 2023 2063 6f72 7265 6c61  0, 1]  # correla
+00012be0: 7469 6f6e 2063 6f65 6666 6963 6965 6e74  tion coefficient
+00012bf0: 2062 6574 7765 656e 2074 6865 2072 6566   between the ref
+00012c00: 6572 656e 6365 2061 6e64 2069 6e69 7469  erence and initi
+00012c10: 616c 2063 7572 7265 6e74 2077 6176 6566  al current wavef
+00012c20: 6f72 6d73 0a20 2020 2077 6176 6566 6f72  orms.    wavefor
+00012c30: 6d73 203d 206e 702e 7a65 726f 7328 286e  ms = np.zeros((n
+00012c40: 6274 7269 616c 202b 2031 2c20 6c65 6e28  btrial + 1, len(
+00012c50: 7265 6629 2929 0a20 2020 2077 6176 6566  ref))).    wavef
+00012c60: 6f72 6d73 5b30 2c20 3a5d 203d 2072 6566  orms[0, :] = ref
+00012c70: 0a0a 2020 2020 2320 5365 7420 6f66 2073  ..    # Set of s
+00012c80: 7472 6574 6368 6564 2f63 6f6d 7072 6573  tretched/compres
+00012c90: 7365 6420 6375 7272 656e 7420 7761 7665  sed current wave
+00012ca0: 666f 726d 730a 2020 2020 666f 7220 6969  forms.    for ii
+00012cb0: 2069 6e20 7261 6e67 6528 6e62 7472 6961   in range(nbtria
+00012cc0: 6c29 3a0a 2020 2020 2020 2020 6e74 203d  l):.        nt =
+00012cd0: 2074 7665 6320 2a20 4570 735b 6969 5d0a   tvec * Eps[ii].
+00012ce0: 2020 2020 2020 2020 7320 3d20 6e70 2e69          s = np.i
+00012cf0: 6e74 6572 7028 783d 7476 6563 2c20 7870  nterp(x=tvec, xp
+00012d00: 3d6e 742c 2066 703d 6375 7229 0a20 2020  =nt, fp=cur).   
+00012d10: 2020 2020 2077 6176 6566 6f72 6d73 5b69       waveforms[i
+00012d20: 6920 2b20 312c 203a 5d20 3d20 730a 2020  i + 1, :] = s.  
+00012d30: 2020 636f 6620 3d20 6e70 2e63 6f72 7263    cof = np.corrc
+00012d40: 6f65 6628 7761 7665 666f 726d 7329 5b30  oef(waveforms)[0
+00012d50: 5d5b 313a 5d0a 0a20 2020 2023 2066 696e  ][1:]..    # fin
+00012d60: 6420 7468 6520 6d61 7869 6d75 6d20 636f  d the maximum co
+00012d70: 7272 656c 6174 696f 6e20 636f 6566 6669  rrelation coeffi
+00012d80: 6369 656e 740a 2020 2020 696d 6178 203d  cient.    imax =
+00012d90: 206e 702e 6e61 6e61 7267 6d61 7828 636f   np.nanargmax(co
+00012da0: 6629 0a20 2020 2069 6620 696d 6178 203e  f).    if imax >
+00012db0: 3d20 6c65 6e28 4570 7329 202d 2032 3a0a  = len(Eps) - 2:.
+00012dc0: 2020 2020 2020 2020 696d 6178 203d 2069          imax = i
+00012dd0: 6d61 7820 2d20 320a 2020 2020 6966 2069  max - 2.    if i
+00012de0: 6d61 7820 3c20 323a 0a20 2020 2020 2020  max < 2:.       
+00012df0: 2069 6d61 7820 3d20 696d 6178 202b 2032   imax = imax + 2
+00012e00: 0a0a 2020 2020 2320 5072 6f63 6565 6420  ..    # Proceed 
+00012e10: 746f 2074 6865 2073 6563 6f6e 6420 7374  to the second st
+00012e20: 6570 2074 6f20 6765 7420 6120 6d6f 7265  ep to get a more
+00012e30: 2070 7265 6369 7365 2064 762f 7620 6d65   precise dv/v me
+00012e40: 6173 7572 656d 656e 740a 2020 2020 6474  asurement.    dt
+00012e50: 6669 6e65 7220 3d20 6e70 2e6c 696e 7370  finer = np.linsp
+00012e60: 6163 6528 4570 735b 696d 6178 202d 2032  ace(Eps[imax - 2
+00012e70: 5d2c 2045 7073 5b69 6d61 7820 2b20 325d  ], Eps[imax + 2]
+00012e80: 2c20 6e62 7472 6961 6c29 0a20 2020 2023  , nbtrial).    #
+00012e90: 206e 636f 6620 2020 203d 206e 702e 7a65   ncof    = np.ze
+00012ea0: 726f 7328 6474 6669 6e65 722e 7368 6170  ros(dtfiner.shap
+00012eb0: 652c 6474 7970 653d 6e70 2e66 6c6f 6174  e,dtype=np.float
+00012ec0: 3332 290a 2020 2020 7761 7665 666f 726d  32).    waveform
+00012ed0: 7320 3d20 6e70 2e7a 6572 6f73 2828 6e62  s = np.zeros((nb
+00012ee0: 7472 6961 6c20 2b20 312c 206c 656e 2872  trial + 1, len(r
+00012ef0: 6566 2929 290a 2020 2020 7761 7665 666f  ef))).    wavefo
+00012f00: 726d 735b 302c 203a 5d20 3d20 7265 660a  rms[0, :] = ref.
+00012f10: 2020 2020 666f 7220 6969 2069 6e20 7261      for ii in ra
+00012f20: 6e67 6528 6c65 6e28 6474 6669 6e65 7229  nge(len(dtfiner)
+00012f30: 293a 0a20 2020 2020 2020 206e 7420 3d20  ):.        nt = 
+00012f40: 7476 6563 202a 2064 7466 696e 6572 5b69  tvec * dtfiner[i
+00012f50: 695d 0a20 2020 2020 2020 2073 203d 206e  i].        s = n
+00012f60: 702e 696e 7465 7270 2878 3d74 7665 632c  p.interp(x=tvec,
+00012f70: 2078 703d 6e74 2c20 6670 3d63 7572 290a   xp=nt, fp=cur).
+00012f80: 2020 2020 2020 2020 7761 7665 666f 726d          waveform
+00012f90: 735b 6969 202b 2031 2c20 3a5d 203d 2073  s[ii + 1, :] = s
+00012fa0: 0a20 2020 206e 636f 6620 3d20 6e70 2e63  .    ncof = np.c
+00012fb0: 6f72 7263 6f65 6628 7761 7665 666f 726d  orrcoef(waveform
+00012fc0: 7329 5b30 5d5b 313a 5d0a 2020 2020 6363  s)[0][1:].    cc
+00012fd0: 203d 206e 702e 6d61 7828 6e63 6f66 2920   = np.max(ncof) 
+00012fe0: 2023 2046 696e 6420 6d61 7869 6d75 6d20   # Find maximum 
+00012ff0: 636f 7272 656c 6174 696f 6e20 636f 6566  correlation coef
+00013000: 6669 6369 656e 7420 6f66 2074 6865 2072  ficient of the r
+00013010: 6566 696e 6564 2020 616e 616c 7973 6973  efined  analysis
+00013020: 0a20 2020 2064 7620 3d20 3130 302e 3020  .    dv = 100.0 
+00013030: 2a20 6474 6669 6e65 725b 6e70 2e61 7267  * dtfiner[np.arg
+00013040: 6d61 7828 6e63 6f66 295d 202d 2031 3030  max(ncof)] - 100
+00013050: 2020 2320 4d75 6c74 6970 6c79 2062 7920    # Multiply by 
+00013060: 3130 3020 746f 2063 6f6e 7665 7274 2074  100 to convert t
+00013070: 6f20 7065 7263 656e 7461 6765 2028 4570  o percentage (Ep
+00013080: 7369 6c6f 6e20 3d20 2d64 742f 7420 3d20  silon = -dt/t = 
+00013090: 6476 2f76 290a 0a20 2020 2023 2045 7272  dv/v)..    # Err
+000130a0: 6f72 2063 6f6d 7075 7461 7469 6f6e 2062  or computation b
+000130b0: 6173 6564 206f 6e20 5765 6176 6572 2065  ased on Weaver e
+000130c0: 7420 616c 2028 3230 3131 292c 204f 6e20  t al (2011), On 
+000130d0: 7468 6520 7072 6563 6973 696f 6e20 6f66  the precision of
+000130e0: 206e 6f69 7365 2d63 6f72 7265 6c61 7469   noise-correlati
+000130f0: 6f6e 2069 6e74 6572 6665 726f 6d65 7472  on interferometr
+00013100: 792c 0a20 2020 2023 2047 656f 7068 7973  y,.    # Geophys
+00013110: 2e20 4a2e 2049 6e74 2e2c 2031 3835 2833  . J. Int., 185(3
+00013120: 290a 2020 2020 5420 3d20 3120 2f20 2866  ).    T = 1 / (f
+00013130: 6d61 7820 2d20 666d 696e 290a 2020 2020  max - fmin).    
+00013140: 5820 3d20 6363 0a20 2020 2077 6320 3d20  X = cc.    wc = 
+00013150: 6e70 2e70 6920 2a20 2866 6d69 6e20 2b20  np.pi * (fmin + 
+00013160: 666d 6178 290a 2020 2020 7431 203d 206e  fmax).    t1 = n
+00013170: 702e 6d69 6e28 5b74 6d69 6e2c 2074 6d61  p.min([tmin, tma
+00013180: 785d 290a 2020 2020 7432 203d 206e 702e  x]).    t2 = np.
+00013190: 6d61 7828 5b74 6d69 6e2c 2074 6d61 785d  max([tmin, tmax]
+000131a0: 290a 2020 2020 6572 726f 7220 3d20 3130  ).    error = 10
+000131b0: 3020 2a20 280a 2020 2020 2020 2020 6e70  0 * (.        np
+000131c0: 2e73 7172 7428 3120 2d20 582a 2a32 2920  .sqrt(1 - X**2) 
+000131d0: 2f20 2832 202a 2058 2920 2a20 6e70 2e73  / (2 * X) * np.s
+000131e0: 7172 7428 2836 202a 206e 702e 7371 7274  qrt((6 * np.sqrt
+000131f0: 286e 702e 7069 202f 2032 2920 2a20 5429  (np.pi / 2) * T)
+00013200: 202f 2028 7763 2a2a 3220 2a20 2874 322a   / (wc**2 * (t2*
+00013210: 2a33 202d 2074 312a 2a33 2929 290a 2020  *3 - t1**3))).  
+00013220: 2020 290a 0a20 2020 2072 6574 7572 6e20    )..    return 
+00013230: 6476 2c20 6572 726f 722c 2063 632c 2063  dv, error, cc, c
+00013240: 6470 0a0a 0a64 6566 2064 7477 5f64 7676  dp...def dtw_dvv
+00013250: 2872 6566 2c20 6375 722c 2070 6172 612c  (ref, cur, para,
+00013260: 206d 6178 4c61 672c 2062 2c20 6469 7265   maxLag, b, dire
+00013270: 6374 696f 6e29 3a0a 2020 2020 2222 220a  ction):.    """.
+00013280: 2020 2020 4479 6e61 6d69 6320 7469 6d65      Dynamic time
+00013290: 2077 6172 7069 6e67 2066 6f72 2064 762f   warping for dv/
+000132a0: 7620 6573 7469 6d61 7469 6f6e 2e0a 0a20  v estimation... 
+000132b0: 2020 2050 4152 414d 4554 4552 533a 0a20     PARAMETERS:. 
+000132c0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
+000132d0: 2d2d 2d0a 2020 2020 7265 6620 3a20 7265  ---.    ref : re
+000132e0: 6665 7265 6e63 6520 7369 676e 616c 2028  ference signal (
+000132f0: 6e70 2e61 7272 6179 2c20 7369 7a65 204e  np.array, size N
+00013300: 290a 2020 2020 6375 7220 3a20 6375 7272  ).    cur : curr
+00013310: 656e 7420 7369 676e 616c 2028 6e70 2e61  ent signal (np.a
+00013320: 7272 6179 2c20 7369 7a65 204e 290a 2020  rray, size N).  
+00013330: 2020 7061 7261 3a20 6469 6374 2063 6f6e    para: dict con
+00013340: 7461 696e 696e 6720 7573 6566 756c 2070  taining useful p
+00013350: 6172 616d 6574 6572 7320 6162 6f75 7420  arameters about 
+00013360: 7468 6520 6461 7461 2077 696e 646f 7720  the data window 
+00013370: 616e 6420 7461 7267 6574 6564 2066 7265  and targeted fre
+00013380: 7175 656e 6379 0a20 2020 206d 6178 4c61  quency.    maxLa
+00013390: 6720 3a20 6d61 7820 6e75 6d62 6572 206f  g : max number o
+000133a0: 6620 706f 696e 7473 2074 6f20 7365 6172  f points to sear
+000133b0: 6368 2066 6f72 7761 7264 2061 6e64 2062  ch forward and b
+000133c0: 6163 6b77 6172 642e 0a20 2020 2020 2020  ackward..       
+000133d0: 2020 2020 2053 7567 6765 7374 2073 6574       Suggest set
+000133e0: 7469 6e67 2069 7420 6c61 7267 6572 2069  ting it larger i
+000133f0: 6620 7769 6e64 6f77 2069 7320 7365 7420  f window is set 
+00013400: 6c61 7267 6572 2e0a 2020 2020 6220 3a20  larger..    b : 
+00013410: 622d 7661 6c75 6520 746f 206c 696d 6974  b-value to limit
+00013420: 2073 7472 6169 6e2c 2077 6869 6368 2069   strain, which i
+00013430: 7320 746f 206c 696d 6974 2074 6865 206d  s to limit the m
+00013440: 6178 696d 756d 2076 656c 6f63 6974 7920  aximum velocity 
+00013450: 7065 7274 7572 6261 7469 6f6e 2e0a 2020  perturbation..  
+00013460: 2020 2020 2020 2020 2020 5365 6520 6571            See eq
+00013470: 7561 7469 6f6e 2031 3120 696e 2028 4d69  uation 11 in (Mi
+00013480: 6b65 7365 6c6c 2065 7420 616c 2e20 3230  kesell et al. 20
+00013490: 3135 290a 2020 2020 6469 7265 6374 696f  15).    directio
+000134a0: 6e3a 2064 6972 6563 7469 6f6e 2074 6f20  n: direction to 
+000134b0: 6163 6375 6d75 6c61 7465 2065 7272 6f72  accumulate error
+000134c0: 7320 2831 3d66 6f72 7761 7264 2c20 2d31  s (1=forward, -1
+000134d0: 3d62 6163 6b77 6172 6429 0a20 2020 2052  =backward).    R
+000134e0: 4554 5552 4e53 3a0a 2020 2020 2d2d 2d2d  ETURNS:.    ----
+000134f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
+00013500: 2020 202d 6d30 203a 2065 7374 696d 6174     -m0 : estimat
+00013510: 6564 2064 762f 760a 2020 2020 656d 3020  ed dv/v.    em0 
+00013520: 3a20 6572 726f 7220 6f66 2064 762f 7620  : error of dv/v 
+00013530: 6573 7469 6d61 7469 6f6e 0a0a 2020 2020  estimation..    
+00013540: 4f72 6967 696e 616c 2062 7920 4469 2059  Original by Di Y
+00013550: 616e 670a 2020 2020 4c61 7374 206d 6f64  ang.    Last mod
+00013560: 6966 6965 6420 6279 2044 796c 616e 204d  ified by Dylan M
+00013570: 696b 6573 656c 6c20 2832 3520 4665 622e  ikesell (25 Feb.
+00013580: 2032 3031 3529 0a20 2020 2054 7261 6e73   2015).    Trans
+00013590: 6c61 7465 6420 746f 2070 7974 686f 6e20  lated to python 
+000135a0: 6279 2054 696d 2043 6c65 6d65 6e74 7320  by Tim Clements 
+000135b0: 2831 3720 4175 672e 2032 3031 3829 0a20  (17 Aug. 2018). 
+000135c0: 2020 2022 2222 0a20 2020 2074 7769 6e20     """.    twin 
+000135d0: 3d20 7061 7261 5b22 7477 696e 225d 0a20  = para["twin"]. 
+000135e0: 2020 2064 7420 3d20 7061 7261 5b22 6474     dt = para["dt
+000135f0: 225d 0a20 2020 2074 6d69 6e20 3d20 6e70  "].    tmin = np
+00013600: 2e6d 696e 2874 7769 6e29 0a20 2020 2074  .min(twin).    t
+00013610: 6d61 7820 3d20 6e70 2e6d 6178 2874 7769  max = np.max(twi
+00013620: 6e29 0a20 2020 2074 7665 6374 203d 206e  n).    tvect = n
+00013630: 702e 6172 616e 6765 2874 6d69 6e2c 2074  p.arange(tmin, t
+00013640: 6d61 782c 2064 7429 0a0a 2020 2020 2320  max, dt)..    # 
+00013650: 7365 7475 7020 6f74 6865 7220 7061 7261  setup other para
+00013660: 6d65 7465 7273 0a20 2020 206e 7074 7320  meters.    npts 
+00013670: 3d20 6c65 6e28 7265 6629 2020 2320 6e75  = len(ref)  # nu
+00013680: 6d62 6572 206f 6620 7469 6d65 2073 616d  mber of time sam
+00013690: 706c 6573 0a0a 2020 2020 2320 636f 6d70  ples..    # comp
+000136a0: 7574 6520 6572 726f 7220 6675 6e63 7469  ute error functi
+000136b0: 6f6e 206f 7665 7220 6c61 6773 2c20 7768  on over lags, wh
+000136c0: 6963 6820 6973 2069 6e64 6570 656e 6465  ich is independe
+000136d0: 6e74 206f 6620 7374 7261 696e 206c 696d  nt of strain lim
+000136e0: 6974 2027 6227 2e0a 2020 2020 6572 7220  it 'b'..    err 
+000136f0: 3d20 636f 6d70 7574 6545 7272 6f72 4675  = computeErrorFu
+00013700: 6e63 7469 6f6e 2863 7572 2c20 7265 662c  nction(cur, ref,
+00013710: 206e 7074 732c 206d 6178 4c61 6729 0a0a   npts, maxLag)..
+00013720: 2020 2020 2320 6469 7265 6374 696f 6e20      # direction 
+00013730: 746f 2061 6363 756d 756c 6174 6520 6572  to accumulate er
+00013740: 726f 7273 2028 313d 666f 7277 6172 642c  rors (1=forward,
+00013750: 202d 313d 6261 636b 7761 7264 290a 2020   -1=backward).  
+00013760: 2020 6469 7374 203d 2061 6363 756d 756c    dist = accumul
+00013770: 6174 6545 7272 6f72 4675 6e63 7469 6f6e  ateErrorFunction
+00013780: 2864 6972 6563 7469 6f6e 2c20 6572 722c  (direction, err,
+00013790: 206e 7074 732c 206d 6178 4c61 672c 2062   npts, maxLag, b
+000137a0: 290a 2020 2020 7374 6261 7220 3d20 6261  ).    stbar = ba
+000137b0: 636b 7472 6163 6b44 6973 7461 6e63 6546  cktrackDistanceF
+000137c0: 756e 6374 696f 6e28 2d31 202a 2064 6972  unction(-1 * dir
+000137d0: 6563 7469 6f6e 2c20 6469 7374 2c20 6572  ection, dist, er
+000137e0: 722c 202d 6d61 784c 6167 2c20 6229 0a20  r, -maxLag, b). 
+000137f0: 2020 2073 7462 6172 5469 6d65 203d 2073     stbarTime = s
+00013800: 7462 6172 202a 2064 7420 2023 2063 6f6e  tbar * dt  # con
+00013810: 7665 7274 2066 726f 6d20 7361 6d70 6c65  vert from sample
+00013820: 7320 746f 2074 696d 650a 0a20 2020 2023  s to time..    #
+00013830: 2063 7574 2074 6865 2066 6972 7374 2061   cut the first a
+00013840: 6e64 206c 6173 7420 3525 2066 6f72 2062  nd last 5% for b
+00013850: 6574 7465 7220 7265 6772 6573 7369 6f6e  etter regression
+00013860: 0a20 2020 2069 6e64 7820 3d20 6e70 2e77  .    indx = np.w
+00013870: 6865 7265 2828 7476 6563 7420 3e3d 2030  here((tvect >= 0
+00013880: 2e30 3520 2a20 6e70 7473 202a 2064 7429  .05 * npts * dt)
+00013890: 2026 2028 7476 6563 7420 3c3d 2030 2e39   & (tvect <= 0.9
+000138a0: 3520 2a20 6e70 7473 202a 2064 7429 295b  5 * npts * dt))[
+000138b0: 305d 0a0a 2020 2020 2320 6c69 6e65 6172  0]..    # linear
+000138c0: 2072 6567 7265 7373 696f 6e20 746f 2067   regression to g
+000138d0: 6574 2064 762f 760a 2020 2020 6966 206e  et dv/v.    if n
+000138e0: 7074 7320 3e20 323a 0a20 2020 2020 2020  pts > 2:.       
+000138f0: 2023 2077 6569 6768 7473 0a20 2020 2020   # weights.     
+00013900: 2020 2077 203d 206e 702e 6f6e 6573 286e     w = np.ones(n
+00013910: 7074 7329 0a20 2020 2020 2020 2023 206d  pts).        # m
+00013920: 2c20 612c 2065 6d2c 2065 6120 3d20 6c69  , a, em, ea = li
+00013930: 6e65 6172 5f72 6567 7265 7373 696f 6e28  near_regression(
+00013940: 7469 6d65 5f61 7869 735b 696e 6478 5d2c  time_axis[indx],
+00013950: 2064 656c 7461 5f74 5b69 6e64 785d 2c20   delta_t[indx], 
+00013960: 772c 2069 6e74 6572 6365 7074 5f6f 7269  w, intercept_ori
+00013970: 6769 6e3d 4661 6c73 6529 0a20 2020 2020  gin=False).     
+00013980: 2020 206d 302c 2065 6d30 203d 206c 696e     m0, em0 = lin
+00013990: 6561 725f 7265 6772 6573 7369 6f6e 280a  ear_regression(.
+000139a0: 2020 2020 2020 2020 2020 2020 7476 6563              tvec
+000139b0: 742e 666c 6174 7465 6e28 295b 696e 6478  t.flatten()[indx
+000139c0: 5d2c 0a20 2020 2020 2020 2020 2020 2073  ],.            s
+000139d0: 7462 6172 5469 6d65 2e66 6c61 7474 656e  tbarTime.flatten
+000139e0: 2829 5b69 6e64 785d 2c0a 2020 2020 2020  ()[indx],.      
+000139f0: 2020 2020 2020 772e 666c 6174 7465 6e28        w.flatten(
+00013a00: 295b 696e 6478 5d2c 0a20 2020 2020 2020  )[indx],.       
+00013a10: 2020 2020 2069 6e74 6572 6365 7074 5f6f       intercept_o
+00013a20: 7269 6769 6e3d 5472 7565 2c0a 2020 2020  rigin=True,.    
+00013a30: 2020 2020 290a 0a20 2020 2065 6c73 653a      )..    else:
+00013a40: 0a20 2020 2020 2020 2070 7269 6e74 2822  .        print("
+00013a50: 6e6f 7420 656e 6f75 6768 2070 6f69 6e74  not enough point
+00013a60: 7320 746f 2065 7374 696d 6174 6520 6476  s to estimate dv
+00013a70: 2f76 2066 6f72 2064 7477 2229 0a20 2020  /v for dtw").   
+00013a80: 2020 2020 206d 3020 3d20 300a 2020 2020       m0 = 0.    
+00013a90: 2020 2020 656d 3020 3d20 300a 0a20 2020      em0 = 0..   
+00013aa0: 2072 6574 7572 6e20 6d30 202a 2031 3030   return m0 * 100
+00013ab0: 2c20 656d 3020 2a20 3130 302c 2064 6973  , em0 * 100, dis
+00013ac0: 740a 0a0a 6465 6620 6d77 6373 5f64 7676  t...def mwcs_dvv
+00013ad0: 2872 6566 2c20 6375 722c 206d 6f76 696e  (ref, cur, movin
+00013ae0: 675f 7769 6e64 6f77 5f6c 656e 6774 682c  g_window_length,
+00013af0: 2073 6c69 6465 5f73 7465 702c 2070 6172   slide_step, par
+00013b00: 612c 2073 6d6f 6f74 6869 6e67 5f68 616c  a, smoothing_hal
+00013b10: 665f 7769 6e3d 3529 3a0a 2020 2020 2222  f_win=5):.    ""
+00013b20: 220a 2020 2020 4d6f 7669 6e67 2057 696e  ".    Moving Win
+00013b30: 646f 7720 4372 6f73 7320 5370 6563 7472  dow Cross Spectr
+00013b40: 756d 206d 6574 686f 6420 746f 206d 6561  um method to mea
+00013b50: 7375 7265 2064 762f 7620 2872 656c 7969  sure dv/v (relyi
+00013b60: 6e67 206f 6e20 7068 693d 322a 7069 2a66  ng on phi=2*pi*f
+00013b70: 2a74 2069 6e20 6672 6571 2064 6f6d 6169  *t in freq domai
+00013b80: 6e29 0a0a 2020 2020 5041 5241 4d45 5445  n)..    PARAMETE
+00013b90: 5253 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  RS:.    --------
+00013ba0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2072 6566  --------.    ref
+00013bb0: 3a20 5265 6665 7265 6e63 6520 7761 7665  : Reference wave
+00013bc0: 666f 726d 2028 6e70 2e6e 6461 7272 6179  form (np.ndarray
+00013bd0: 2c20 7369 7a65 204e 290a 2020 2020 6375  , size N).    cu
+00013be0: 723a 2043 7572 7265 6e74 2077 6176 6566  r: Current wavef
+00013bf0: 6f72 6d20 286e 702e 6e64 6172 7261 792c  orm (np.ndarray,
+00013c00: 2073 697a 6520 4e29 0a20 2020 206d 6f76   size N).    mov
+00013c10: 696e 675f 7769 6e64 6f77 5f6c 656e 6774  ing_window_lengt
+00013c20: 683a 206d 6f76 696e 6720 7769 6e64 6f77  h: moving window
+00013c30: 206c 656e 6774 6820 746f 2063 616c 6375   length to calcu
+00013c40: 6c61 7465 2063 726f 7373 2d73 7065 6374  late cross-spect
+00013c50: 7275 6d20 286e 702e 666c 6f61 742c 2069  rum (np.float, i
+00013c60: 6e20 7365 6329 0a20 2020 2073 6c69 6465  n sec).    slide
+00013c70: 5f73 7465 703a 2073 7465 7073 2069 6e20  _step: steps in 
+00013c80: 7469 6d65 2074 6f20 7368 6966 7420 7468  time to shift th
+00013c90: 6520 6d6f 7669 6e67 2077 696e 646f 7720  e moving window 
+00013ca0: 286e 702e 666c 6f61 742c 2069 6e20 7365  (np.float, in se
+00013cb0: 636f 6e64 7329 0a20 2020 2070 6172 613a  conds).    para:
+00013cc0: 2061 2064 6963 7420 636f 6e74 6169 6e69   a dict containi
+00013cd0: 6e67 2070 6172 616d 6574 6572 7320 6162  ng parameters ab
+00013ce0: 6f75 7420 696e 7075 7420 6461 7461 2077  out input data w
+00013cf0: 696e 646f 7720 616e 6420 6672 6571 7565  indow and freque
+00013d00: 6e63 7920 696e 666f 2c20 696e 636c 7564  ncy info, includ
+00013d10: 696e 670a 2020 2020 2020 2020 6465 6c74  ing.        delt
+00013d20: 612d 3e54 6865 2073 616d 706c 696e 6720  a->The sampling 
+00013d30: 7261 7465 206f 6620 7468 6520 696e 7075  rate of the inpu
+00013d40: 7420 7469 6d65 7365 7269 6573 2028 696e  t timeseries (in
+00013d50: 2048 7a29 0a20 2020 2020 2020 2077 696e   Hz).        win
+00013d60: 646f 772d 3e20 5468 6520 7461 7267 6574  dow-> The target
+00013d70: 2077 696e 646f 7720 666f 7220 6d65 6173   window for meas
+00013d80: 7572 696e 6720 6474 2f74 0a20 2020 2020  uring dt/t.     
+00013d90: 2020 2066 7265 712d 3e20 5468 6520 6672     freq-> The fr
+00013da0: 6571 7565 6e63 7920 626f 756e 6420 746f  equency bound to
+00013db0: 2063 6f6d 7075 7465 2074 6865 2064 6570   compute the dep
+00013dc0: 6861 7369 6e67 2028 696e 2048 7a29 0a20  hasing (in Hz). 
+00013dd0: 2020 2020 2020 2074 6d69 6e3a 2054 6865         tmin: The
+00013de0: 206c 6566 746d 6f73 7420 7469 6d65 206c   leftmost time l
+00013df0: 6167 2028 7573 6564 2074 6f20 636f 6d70  ag (used to comp
+00013e00: 7574 6520 7468 6520 2274 696d 6520 6c61  ute the "time la
+00013e10: 6773 2061 7272 6179 2229 0a20 2020 2073  gs array").    s
+00013e20: 6d6f 6f74 6869 6e67 5f68 616c 665f 7769  moothing_half_wi
+00013e30: 6e3a 2049 6620 6469 6666 6572 656e 7420  n: If different 
+00013e40: 6672 6f6d 2030 2c20 6465 6669 6e65 7320  from 0, defines 
+00013e50: 7468 6520 6861 6c66 206c 656e 6774 6820  the half length 
+00013e60: 6f66 2074 6865 2073 6d6f 6f74 6869 6e67  of the smoothing
+00013e70: 2068 616e 6e69 6e67 2077 696e 646f 772e   hanning window.
+00013e80: 0a0a 2020 2020 5245 5455 524e 533a 0a20  ..    RETURNS:. 
+00013e90: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
+00013ea0: 2d2d 2d2d 2d0a 2020 2020 7469 6d65 5f61  -----.    time_a
+00013eb0: 7869 733a 2074 6865 2063 656e 7472 616c  xis: the central
+00013ec0: 2074 696d 6573 206f 6620 7468 6520 7769   times of the wi
+00013ed0: 6e64 6f77 732e 0a20 2020 2064 656c 7461  ndows..    delta
+00013ee0: 5f74 3a20 6474 0a20 2020 2064 656c 7461  _t: dt.    delta
+00013ef0: 5f65 7272 3a65 7272 6f72 0a20 2020 2064  _err:error.    d
+00013f00: 656c 7461 5f6d 636f 683a 206d 6561 6e20  elta_mcoh: mean 
+00013f10: 636f 6865 7265 6e63 650a 0a20 2020 2043  coherence..    C
+00013f20: 6f70 6965 6420 6672 6f6d 204d 534e 6f69  opied from MSNoi
+00013f30: 7365 2028 6874 7470 733a 2f2f 6769 7468  se (https://gith
+00013f40: 7562 2e63 6f6d 2f52 4f42 656c 6769 756d  ub.com/ROBelgium
+00013f50: 2f4d 534e 6f69 7365 2f74 7265 652f 6d61  /MSNoise/tree/ma
+00013f60: 7374 6572 2f6d 736e 6f69 7365 290a 2020  ster/msnoise).  
+00013f70: 2020 4d6f 6469 6669 6564 2062 7920 4368    Modified by Ch
+00013f80: 656e 6778 696e 204a 6961 6e67 0a20 2020  engxin Jiang.   
+00013f90: 2022 2222 0a20 2020 2023 2063 6f6d 6d6f   """.    # commo
+00013fa0: 6e20 7661 7269 6162 6c65 730a 2020 2020  n variables.    
+00013fb0: 7477 696e 203d 2070 6172 615b 2274 7769  twin = para["twi
+00013fc0: 6e22 5d0a 2020 2020 6672 6571 203d 2070  n"].    freq = p
+00013fd0: 6172 615b 2266 7265 7122 5d0a 2020 2020  ara["freq"].    
+00013fe0: 6474 203d 2070 6172 615b 2264 7422 5d0a  dt = para["dt"].
+00013ff0: 2020 2020 746d 696e 203d 206e 702e 6d69      tmin = np.mi
+00014000: 6e28 7477 696e 290a 2020 2020 666d 696e  n(twin).    fmin
+00014010: 203d 206e 702e 6d69 6e28 6672 6571 290a   = np.min(freq).
+00014020: 2020 2020 666d 6178 203d 206e 702e 6d61      fmax = np.ma
+00014030: 7828 6672 6571 290a 0a20 2020 2023 2070  x(freq)..    # p
+00014040: 6172 616d 6574 6572 2069 6e69 7469 616c  arameter initial
+00014050: 697a 650a 2020 2020 6465 6c74 615f 7420  ize.    delta_t 
+00014060: 3d20 5b5d 0a20 2020 2064 656c 7461 5f65  = [].    delta_e
+00014070: 7272 203d 205b 5d0a 2020 2020 6465 6c74  rr = [].    delt
+00014080: 615f 6d63 6f68 203d 205b 5d0a 2020 2020  a_mcoh = [].    
+00014090: 7469 6d65 5f61 7869 7320 3d20 5b5d 0a0a  time_axis = []..
+000140a0: 2020 2020 2320 696e 666f 206f 6e20 7468      # info on th
+000140b0: 6520 6d6f 7669 6e67 2077 696e 646f 770a  e moving window.
+000140c0: 2020 2020 7769 6e64 6f77 5f6c 656e 6774      window_lengt
+000140d0: 685f 7361 6d70 6c65 7320 3d20 6e70 2e69  h_samples = np.i
+000140e0: 6e74 286d 6f76 696e 675f 7769 6e64 6f77  nt(moving_window
+000140f0: 5f6c 656e 6774 6820 2f20 6474 290a 2020  _length / dt).  
+00014100: 2020 7061 6464 203d 2069 6e74 2832 202a    padd = int(2 *
+00014110: 2a20 286e 6578 7470 6f77 3228 7769 6e64  * (nextpow2(wind
+00014120: 6f77 5f6c 656e 6774 685f 7361 6d70 6c65  ow_length_sample
+00014130: 7329 202b 2032 2929 0a20 2020 2063 6f75  s) + 2)).    cou
+00014140: 6e74 203d 2030 0a20 2020 2074 7020 3d20  nt = 0.    tp = 
+00014150: 636f 7369 6e65 5f74 6170 6572 2877 696e  cosine_taper(win
+00014160: 646f 775f 6c65 6e67 7468 5f73 616d 706c  dow_length_sampl
+00014170: 6573 2c20 302e 3135 290a 0a20 2020 206d  es, 0.15)..    m
+00014180: 696e 696e 6420 3d20 300a 2020 2020 6d61  inind = 0.    ma
+00014190: 7869 6e64 203d 2077 696e 646f 775f 6c65  xind = window_le
+000141a0: 6e67 7468 5f73 616d 706c 6573 0a0a 2020  ngth_samples..  
+000141b0: 2020 2320 6c6f 6f70 2074 6872 6f75 6768    # loop through
+000141c0: 2061 6c6c 2073 7562 2d77 696e 646f 7773   all sub-windows
+000141d0: 0a20 2020 2077 6869 6c65 206d 6178 696e  .    while maxin
+000141e0: 6420 3c3d 206c 656e 2872 6566 293a 0a20  d <= len(ref):. 
+000141f0: 2020 2020 2020 2063 6369 203d 2063 7572         cci = cur
+00014200: 5b6d 696e 696e 643a 6d61 7869 6e64 5d0a  [minind:maxind].
+00014210: 2020 2020 2020 2020 6363 6920 3d20 7363          cci = sc
+00014220: 6970 792e 7369 676e 616c 2e64 6574 7265  ipy.signal.detre
+00014230: 6e64 2863 6369 2c20 7479 7065 3d22 6c69  nd(cci, type="li
+00014240: 6e65 6172 2229 0a20 2020 2020 2020 2063  near").        c
+00014250: 6369 202a 3d20 7470 0a0a 2020 2020 2020  ci *= tp..      
+00014260: 2020 6372 6920 3d20 7265 665b 6d69 6e69    cri = ref[mini
+00014270: 6e64 3a6d 6178 696e 645d 0a20 2020 2020  nd:maxind].     
+00014280: 2020 2063 7269 203d 2073 6369 7079 2e73     cri = scipy.s
+00014290: 6967 6e61 6c2e 6465 7472 656e 6428 6372  ignal.detrend(cr
+000142a0: 692c 2074 7970 653d 226c 696e 6561 7222  i, type="linear"
+000142b0: 290a 2020 2020 2020 2020 6372 6920 2a3d  ).        cri *=
+000142c0: 2074 700a 0a20 2020 2020 2020 206d 696e   tp..        min
+000142d0: 696e 6420 2b3d 2069 6e74 2873 6c69 6465  ind += int(slide
+000142e0: 5f73 7465 7020 2f20 6474 290a 2020 2020  _step / dt).    
+000142f0: 2020 2020 6d61 7869 6e64 202b 3d20 696e      maxind += in
+00014300: 7428 736c 6964 655f 7374 6570 202f 2064  t(slide_step / d
+00014310: 7429 0a0a 2020 2020 2020 2020 2320 646f  t)..        # do
+00014320: 2066 6674 0a20 2020 2020 2020 2066 6375   fft.        fcu
+00014330: 7220 3d20 7363 6970 792e 6666 7470 6163  r = scipy.fftpac
+00014340: 6b2e 6666 7428 6363 692c 206e 3d70 6164  k.fft(cci, n=pad
+00014350: 6429 5b3a 2070 6164 6420 2f2f 2032 5d0a  d)[: padd // 2].
+00014360: 2020 2020 2020 2020 6672 6566 203d 2073          fref = s
+00014370: 6369 7079 2e66 6674 7061 636b 2e66 6674  cipy.fftpack.fft
+00014380: 2863 7269 2c20 6e3d 7061 6464 295b 3a20  (cri, n=padd)[: 
+00014390: 7061 6464 202f 2f20 325d 0a0a 2020 2020  padd // 2]..    
+000143a0: 2020 2020 6663 7572 3220 3d20 6e70 2e72      fcur2 = np.r
+000143b0: 6561 6c28 6663 7572 2920 2a2a 2032 202b  eal(fcur) ** 2 +
+000143c0: 206e 702e 696d 6167 2866 6375 7229 202a   np.imag(fcur) *
+000143d0: 2a20 320a 2020 2020 2020 2020 6672 6566  * 2.        fref
+000143e0: 3220 3d20 6e70 2e72 6561 6c28 6672 6566  2 = np.real(fref
+000143f0: 2920 2a2a 2032 202b 206e 702e 696d 6167  ) ** 2 + np.imag
+00014400: 2866 7265 6629 202a 2a20 320a 0a20 2020  (fref) ** 2..   
+00014410: 2020 2020 2023 2067 6574 2063 726f 7373       # get cross
+00014420: 2d73 7065 6374 7275 6d20 2620 646f 2066  -spectrum & do f
+00014430: 696c 7465 7269 6e67 0a20 2020 2020 2020  iltering.       
+00014440: 2058 203d 2066 7265 6620 2a20 2866 6375   X = fref * (fcu
+00014450: 722e 636f 6e6a 2829 290a 2020 2020 2020  r.conj()).      
+00014460: 2020 6966 2073 6d6f 6f74 6869 6e67 5f68    if smoothing_h
+00014470: 616c 665f 7769 6e20 213d 2030 3a0a 2020  alf_win != 0:.  
+00014480: 2020 2020 2020 2020 2020 6463 7572 203d            dcur =
+00014490: 206e 702e 7371 7274 2873 6d6f 6f74 6828   np.sqrt(smooth(
+000144a0: 6663 7572 322c 2077 696e 646f 773d 2268  fcur2, window="h
+000144b0: 616e 6e69 6e67 222c 2068 616c 665f 7769  anning", half_wi
+000144c0: 6e3d 736d 6f6f 7468 696e 675f 6861 6c66  n=smoothing_half
+000144d0: 5f77 696e 2929 0a20 2020 2020 2020 2020  _win)).         
+000144e0: 2020 2064 7265 6620 3d20 6e70 2e73 7172     dref = np.sqr
+000144f0: 7428 736d 6f6f 7468 2866 7265 6632 2c20  t(smooth(fref2, 
+00014500: 7769 6e64 6f77 3d22 6861 6e6e 696e 6722  window="hanning"
+00014510: 2c20 6861 6c66 5f77 696e 3d73 6d6f 6f74  , half_win=smoot
+00014520: 6869 6e67 5f68 616c 665f 7769 6e29 290a  hing_half_win)).
+00014530: 2020 2020 2020 2020 2020 2020 5820 3d20              X = 
+00014540: 736d 6f6f 7468 2858 2c20 7769 6e64 6f77  smooth(X, window
+00014550: 3d22 6861 6e6e 696e 6722 2c20 6861 6c66  ="hanning", half
+00014560: 5f77 696e 3d73 6d6f 6f74 6869 6e67 5f68  _win=smoothing_h
+00014570: 616c 665f 7769 6e29 0a20 2020 2020 2020  alf_win).       
+00014580: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00014590: 2020 2064 6375 7220 3d20 6e70 2e73 7172     dcur = np.sqr
+000145a0: 7428 6663 7572 3229 0a20 2020 2020 2020  t(fcur2).       
+000145b0: 2020 2020 2064 7265 6620 3d20 6e70 2e73       dref = np.s
+000145c0: 7172 7428 6672 6566 3229 0a0a 2020 2020  qrt(fref2)..    
+000145d0: 2020 2020 6463 7320 3d20 6e70 2e61 6273      dcs = np.abs
+000145e0: 2858 290a 0a20 2020 2020 2020 2023 2046  (X)..        # F
+000145f0: 696e 6420 7468 6520 7661 6c75 6573 2074  ind the values t
+00014600: 6865 2066 7265 7175 656e 6379 2072 616e  he frequency ran
+00014610: 6765 206f 6620 696e 7465 7265 7374 0a20  ge of interest. 
+00014620: 2020 2020 2020 2066 7265 715f 7665 6320         freq_vec 
+00014630: 3d20 7363 6970 792e 6666 7470 6163 6b2e  = scipy.fftpack.
+00014640: 6666 7466 7265 7128 6c65 6e28 5829 202a  fftfreq(len(X) *
+00014650: 2032 2c20 6474 295b 3a20 7061 6464 202f   2, dt)[: padd /
+00014660: 2f20 325d 0a20 2020 2020 2020 2069 6e64  / 2].        ind
+00014670: 6578 5f72 616e 6765 203d 206e 702e 6172  ex_range = np.ar
+00014680: 6777 6865 7265 286e 702e 6c6f 6769 6361  gwhere(np.logica
+00014690: 6c5f 616e 6428 6672 6571 5f76 6563 203e  l_and(freq_vec >
+000146a0: 3d20 666d 696e 2c20 6672 6571 5f76 6563  = fmin, freq_vec
+000146b0: 203c 3d20 666d 6178 2929 0a0a 2020 2020   <= fmax))..    
+000146c0: 2020 2020 2320 4765 7420 436f 6865 7265      # Get Cohere
+000146d0: 6e63 6520 616e 6420 6974 7320 6d65 616e  nce and its mean
+000146e0: 2076 616c 7565 0a20 2020 2020 2020 2063   value.        c
+000146f0: 6f68 203d 2067 6574 436f 6865 7265 6e63  oh = getCoherenc
+00014700: 6528 6463 732c 2064 7265 662c 2064 6375  e(dcs, dref, dcu
+00014710: 7229 0a20 2020 2020 2020 206d 636f 6820  r).        mcoh 
+00014720: 3d20 6e70 2e6d 6561 6e28 636f 685b 696e  = np.mean(coh[in
+00014730: 6465 785f 7261 6e67 655d 290a 0a20 2020  dex_range])..   
+00014740: 2020 2020 2023 2047 6574 2057 6569 6768       # Get Weigh
+00014750: 7473 0a20 2020 2020 2020 2077 203d 2031  ts.        w = 1
+00014760: 2e30 202f 2028 312e 3020 2f20 2863 6f68  .0 / (1.0 / (coh
+00014770: 5b69 6e64 6578 5f72 616e 6765 5d20 2a2a  [index_range] **
+00014780: 2032 2920 2d20 312e 3029 0a20 2020 2020   2) - 1.0).     
+00014790: 2020 2077 5b63 6f68 5b69 6e64 6578 5f72     w[coh[index_r
+000147a0: 616e 6765 5d20 3e3d 2030 2e39 395d 203d  ange] >= 0.99] =
+000147b0: 2031 2e30 202f 2028 312e 3020 2f20 302e   1.0 / (1.0 / 0.
+000147c0: 3938 3031 202d 2031 2e30 290a 2020 2020  9801 - 1.0).    
+000147d0: 2020 2020 7720 3d20 6e70 2e73 7172 7428      w = np.sqrt(
+000147e0: 7720 2a20 6e70 2e73 7172 7428 6463 735b  w * np.sqrt(dcs[
+000147f0: 696e 6465 785f 7261 6e67 655d 2929 0a20  index_range])). 
+00014800: 2020 2020 2020 2077 203d 206e 702e 7265         w = np.re
+00014810: 616c 2877 290a 0a20 2020 2020 2020 2023  al(w)..        #
+00014820: 2046 7265 7175 656e 6379 2061 7272 6179   Frequency array
+00014830: 3a0a 2020 2020 2020 2020 7620 3d20 6e70  :.        v = np
+00014840: 2e72 6561 6c28 6672 6571 5f76 6563 5b69  .real(freq_vec[i
+00014850: 6e64 6578 5f72 616e 6765 5d29 202a 2032  ndex_range]) * 2
+00014860: 202a 206e 702e 7069 0a0a 2020 2020 2020   * np.pi..      
+00014870: 2020 2320 5068 6173 653a 0a20 2020 2020    # Phase:.     
+00014880: 2020 2070 6869 203d 206e 702e 616e 676c     phi = np.angl
+00014890: 6528 5829 0a20 2020 2020 2020 2070 6869  e(X).        phi
+000148a0: 5b30 5d20 3d20 302e 300a 2020 2020 2020  [0] = 0.0.      
+000148b0: 2020 7068 6920 3d20 6e70 2e75 6e77 7261    phi = np.unwra
+000148c0: 7028 7068 6929 0a20 2020 2020 2020 2070  p(phi).        p
+000148d0: 6869 203d 2070 6869 5b69 6e64 6578 5f72  hi = phi[index_r
+000148e0: 616e 6765 5d0a 0a20 2020 2020 2020 2023  ange]..        #
+000148f0: 2043 616c 6375 6c61 7465 2074 6865 2073   Calculate the s
+00014900: 6c6f 7065 2077 6974 6820 6120 7765 6967  lope with a weig
+00014910: 6874 6564 206c 6561 7374 2073 7175 6172  hted least squar
+00014920: 6520 6c69 6e65 6172 2072 6567 7265 7373  e linear regress
+00014930: 696f 6e0a 2020 2020 2020 2020 2320 666f  ion.        # fo
+00014940: 7263 6564 2074 6872 6f75 6768 2074 6865  rced through the
+00014950: 206f 7269 6769 6e3b 2077 6569 6768 7473   origin; weights
+00014960: 2066 6f72 2074 6865 2057 4c53 206d 7573   for the WLS mus
+00014970: 7420 6265 2074 6865 2076 6172 6961 6e63  t be the varianc
+00014980: 6520 210a 2020 2020 2020 2020 6d2c 2065  e !.        m, e
+00014990: 6d20 3d20 6c69 6e65 6172 5f72 6567 7265  m = linear_regre
+000149a0: 7373 696f 6e28 762e 666c 6174 7465 6e28  ssion(v.flatten(
+000149b0: 292c 2070 6869 2e66 6c61 7474 656e 2829  ), phi.flatten()
+000149c0: 2c20 772e 666c 6174 7465 6e28 2929 0a20  , w.flatten()). 
+000149d0: 2020 2020 2020 2064 656c 7461 5f74 2e61         delta_t.a
+000149e0: 7070 656e 6428 6d29 0a0a 2020 2020 2020  ppend(m)..      
+000149f0: 2020 2320 7072 696e 7420 7068 692e 7368    # print phi.sh
+00014a00: 6170 652c 2076 2e73 6861 7065 2c20 772e  ape, v.shape, w.
+00014a10: 7368 6170 650a 2020 2020 2020 2020 6520  shape.        e 
+00014a20: 3d20 6e70 2e73 756d 2828 7068 6920 2d20  = np.sum((phi - 
+00014a30: 6d20 2a20 7629 202a 2a20 3229 202f 2028  m * v) ** 2) / (
+00014a40: 6e70 2e73 697a 6528 7629 202d 2031 290a  np.size(v) - 1).
+00014a50: 2020 2020 2020 2020 7332 7832 203d 206e          s2x2 = n
+00014a60: 702e 7375 6d28 762a 2a32 202a 2077 2a2a  p.sum(v**2 * w**
+00014a70: 3229 0a20 2020 2020 2020 2073 7832 203d  2).        sx2 =
+00014a80: 206e 702e 7375 6d28 7720 2a20 762a 2a32   np.sum(w * v**2
+00014a90: 290a 2020 2020 2020 2020 6520 3d20 6e70  ).        e = np
+00014aa0: 2e73 7172 7428 6520 2a20 7332 7832 202f  .sqrt(e * s2x2 /
+00014ab0: 2073 7832 2a2a 3229 0a0a 2020 2020 2020   sx2**2)..      
+00014ac0: 2020 6465 6c74 615f 6572 722e 6170 7065    delta_err.appe
+00014ad0: 6e64 2865 290a 2020 2020 2020 2020 6465  nd(e).        de
+00014ae0: 6c74 615f 6d63 6f68 2e61 7070 656e 6428  lta_mcoh.append(
+00014af0: 6e70 2e72 6561 6c28 6d63 6f68 2929 0a20  np.real(mcoh)). 
+00014b00: 2020 2020 2020 2074 696d 655f 6178 6973         time_axis
+00014b10: 2e61 7070 656e 6428 746d 696e 202b 206d  .append(tmin + m
+00014b20: 6f76 696e 675f 7769 6e64 6f77 5f6c 656e  oving_window_len
+00014b30: 6774 6820 2f20 322e 3020 2b20 636f 756e  gth / 2.0 + coun
+00014b40: 7420 2a20 736c 6964 655f 7374 6570 290a  t * slide_step).
+00014b50: 2020 2020 2020 2020 636f 756e 7420 2b3d          count +=
+00014b60: 2031 0a0a 2020 2020 2020 2020 6465 6c20   1..        del 
+00014b70: 6663 7572 2c20 6672 6566 0a20 2020 2020  fcur, fref.     
+00014b80: 2020 2064 656c 2058 0a20 2020 2020 2020     del X.       
+00014b90: 2064 656c 2066 7265 715f 7665 630a 2020   del freq_vec.  
+00014ba0: 2020 2020 2020 6465 6c20 696e 6465 785f        del index_
+00014bb0: 7261 6e67 650a 2020 2020 2020 2020 6465  range.        de
+00014bc0: 6c20 772c 2076 2c20 652c 2073 3278 322c  l w, v, e, s2x2,
+00014bd0: 2073 7832 2c20 6d2c 2065 6d0a 0a20 2020   sx2, m, em..   
+00014be0: 2069 6620 6d61 7869 6e64 203e 206c 656e   if maxind > len
+00014bf0: 2863 7572 2920 2b20 696e 7428 736c 6964  (cur) + int(slid
+00014c00: 655f 7374 6570 202f 2064 7429 3a0a 2020  e_step / dt):.  
+00014c10: 2020 2020 2020 7072 696e 7428 2254 6865        print("The
+00014c20: 206c 6173 7420 7769 6e64 6f77 2077 6173   last window was
+00014c30: 2074 6f6f 2073 6d61 6c6c 2c20 6275 7420   too small, but 
+00014c40: 7761 7320 636f 6d70 7574 6564 2229 0a0a  was computed")..
+00014c50: 2020 2020 2320 656e 7375 7265 2061 6c6c      # ensure all
+00014c60: 206d 6174 7269 7820 6172 6520 6e70 2061   matrix are np a
+00014c70: 7272 6179 0a20 2020 2064 656c 7461 5f74  rray.    delta_t
+00014c80: 203d 206e 702e 6172 7261 7928 6465 6c74   = np.array(delt
+00014c90: 615f 7429 0a20 2020 2064 656c 7461 5f65  a_t).    delta_e
+00014ca0: 7272 203d 206e 702e 6172 7261 7928 6465  rr = np.array(de
+00014cb0: 6c74 615f 6572 7229 0a20 2020 2064 656c  lta_err).    del
+00014cc0: 7461 5f6d 636f 6820 3d20 6e70 2e61 7272  ta_mcoh = np.arr
+00014cd0: 6179 2864 656c 7461 5f6d 636f 6829 0a20  ay(delta_mcoh). 
+00014ce0: 2020 2074 696d 655f 6178 6973 203d 206e     time_axis = n
+00014cf0: 702e 6172 7261 7928 7469 6d65 5f61 7869  p.array(time_axi
+00014d00: 7329 0a0a 2020 2020 2320 7265 6164 7920  s)..    # ready 
+00014d10: 666f 7220 6c69 6e65 6172 2072 6567 7265  for linear regre
+00014d20: 7373 696f 6e0a 2020 2020 6465 6c74 615f  ssion.    delta_
+00014d30: 6d69 6e63 686f 203d 2030 2e36 350a 2020  mincho = 0.65.  
+00014d40: 2020 6465 6c74 615f 6d61 7865 7272 203d    delta_maxerr =
+00014d50: 2030 2e31 0a20 2020 2064 656c 7461 5f6d   0.1.    delta_m
+00014d60: 6178 6474 203d 2030 2e31 0a20 2020 2069  axdt = 0.1.    i
+00014d70: 6e64 7831 203d 206e 702e 7768 6572 6528  ndx1 = np.where(
+00014d80: 6465 6c74 615f 6d63 6f68 203e 2064 656c  delta_mcoh > del
+00014d90: 7461 5f6d 696e 6368 6f29 0a20 2020 2069  ta_mincho).    i
+00014da0: 6e64 7832 203d 206e 702e 7768 6572 6528  ndx2 = np.where(
+00014db0: 6465 6c74 615f 6572 7220 3c20 6465 6c74  delta_err < delt
+00014dc0: 615f 6d61 7865 7272 290a 2020 2020 696e  a_maxerr).    in
+00014dd0: 6478 3320 3d20 6e70 2e77 6865 7265 2864  dx3 = np.where(d
+00014de0: 656c 7461 5f74 203c 2064 656c 7461 5f6d  elta_t < delta_m
+00014df0: 6178 6474 290a 0a20 2020 2023 202d 2d2d  axdt)..    # ---
+00014e00: 2d2d 6669 6e64 2067 6f6f 6420 6474 206d  --find good dt m
+00014e10: 6561 7375 7265 6d65 6e74 732d 2d2d 2d2d  easurements-----
+00014e20: 0a20 2020 2069 6e64 7820 3d20 6e70 2e69  .    indx = np.i
+00014e30: 6e74 6572 7365 6374 3164 2869 6e64 7831  ntersect1d(indx1
+00014e40: 2c20 696e 6478 3229 0a20 2020 2069 6e64  , indx2).    ind
+00014e50: 7820 3d20 6e70 2e69 6e74 6572 7365 6374  x = np.intersect
+00014e60: 3164 2869 6e64 782c 2069 6e64 7833 290a  1d(indx, indx3).
+00014e70: 0a20 2020 2069 6620 6c65 6e28 696e 6478  .    if len(indx
+00014e80: 2920 3e20 323a 0a20 2020 2020 2020 2023  ) > 2:.        #
+00014e90: 202d 2d2d 2d65 7374 696d 6174 6520 7765   ----estimate we
+00014ea0: 6967 6874 2066 6f72 2072 6567 7265 7373  ight for regress
+00014eb0: 696f 6e2d 2d2d 2d0a 2020 2020 2020 2020  ion----.        
+00014ec0: 7720 3d20 3120 2f20 6465 6c74 615f 6572  w = 1 / delta_er
+00014ed0: 725b 696e 6478 5d0a 2020 2020 2020 2020  r[indx].        
+00014ee0: 775b 7e6e 702e 6973 6669 6e69 7465 2877  w[~np.isfinite(w
+00014ef0: 295d 203d 2031 2e30 0a0a 2020 2020 2020  )] = 1.0..      
+00014f00: 2020 2320 2d2d 2d2d 2d2d 2d2d 2d64 6f20    # ---------do 
+00014f10: 6c69 6e65 6172 2072 6567 7265 7373 696f  linear regressio
+00014f20: 6e2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  n-----------.   
+00014f30: 2020 2020 2023 206d 2c20 612c 2065 6d2c       # m, a, em,
+00014f40: 2065 6120 3d20 6c69 6e65 6172 5f72 6567   ea = linear_reg
+00014f50: 7265 7373 696f 6e28 7469 6d65 5f61 7869  ression(time_axi
+00014f60: 735b 696e 6478 5d2c 2064 656c 7461 5f74  s[indx], delta_t
+00014f70: 5b69 6e64 785d 2c20 772c 2069 6e74 6572  [indx], w, inter
+00014f80: 6365 7074 5f6f 7269 6769 6e3d 4661 6c73  cept_origin=Fals
+00014f90: 6529 0a20 2020 2020 2020 206d 302c 2065  e).        m0, e
+00014fa0: 6d30 203d 206c 696e 6561 725f 7265 6772  m0 = linear_regr
+00014fb0: 6573 7369 6f6e 2874 696d 655f 6178 6973  ession(time_axis
+00014fc0: 5b69 6e64 785d 2c20 6465 6c74 615f 745b  [indx], delta_t[
+00014fd0: 696e 6478 5d2c 2077 2c20 696e 7465 7263  indx], w, interc
+00014fe0: 6570 745f 6f72 6967 696e 3d54 7275 6529  ept_origin=True)
+00014ff0: 0a0a 2020 2020 656c 7365 3a0a 2020 2020  ..    else:.    
+00015000: 2020 2020 7072 696e 7428 226e 6f74 2065      print("not e
+00015010: 6e6f 7567 6820 706f 696e 7473 2074 6f20  nough points to 
+00015020: 6573 7469 6d61 7465 2064 762f 7620 666f  estimate dv/v fo
+00015030: 7220 6d77 6373 2229 0a20 2020 2020 2020  r mwcs").       
+00015040: 206d 3020 3d20 300a 2020 2020 2020 2020   m0 = 0.        
+00015050: 656d 3020 3d20 300a 0a20 2020 2072 6574  em0 = 0..    ret
+00015060: 7572 6e20 2d6d 3020 2a20 3130 302c 2065  urn -m0 * 100, e
+00015070: 6d30 202a 2031 3030 0a0a 0a64 6566 2057  m0 * 100...def W
+00015080: 4343 5f64 7676 2872 6566 2c20 6375 722c  CC_dvv(ref, cur,
+00015090: 206d 6f76 696e 675f 7769 6e64 6f77 5f6c   moving_window_l
+000150a0: 656e 6774 682c 2073 6c69 6465 5f73 7465  ength, slide_ste
+000150b0: 702c 2070 6172 6129 3a0a 2020 2020 2222  p, para):.    ""
+000150c0: 220a 2020 2020 5769 6e64 6f77 6564 2063  ".    Windowed c
+000150d0: 726f 7373 2063 6f72 7265 6c61 7469 6f6e  ross correlation
+000150e0: 2028 5743 4329 2066 6f72 2064 7420 6f72   (WCC) for dt or
+000150f0: 2064 762f 7620 6d65 7375 7265 6d65 6e74   dv/v mesurement
+00015100: 2028 536e 6965 6465 7220 6574 2061 6c2e   (Snieder et al.
+00015110: 2032 3031 3229 0a0a 2020 2020 5061 7261   2012)..    Para
+00015120: 6d65 7465 7273 3a0a 2020 2020 2d2d 2d2d  meters:.    ----
+00015130: 2d2d 2d2d 2d2d 2d0a 2020 2020 7265 663a  -------.    ref:
+00015140: 2054 6865 2022 5265 6665 7265 6e63 6522   The "Reference"
+00015150: 2074 696d 6573 6572 6965 730a 2020 2020   timeseries.    
+00015160: 6375 723a 2054 6865 2022 4375 7272 656e  cur: The "Curren
+00015170: 7422 2074 696d 6573 6572 6965 730a 2020  t" timeseries.  
+00015180: 2020 6d6f 7669 6e67 5f77 696e 646f 775f    moving_window_
+00015190: 6c65 6e67 7468 3a20 5468 6520 6d6f 7669  length: The movi
+000151a0: 6e67 2077 696e 646f 7720 6c65 6e67 7468  ng window length
+000151b0: 2028 696e 2073 6563 6f6e 6473 290a 2020   (in seconds).  
+000151c0: 2020 736c 6964 655f 7374 6570 3a20 5468    slide_step: Th
+000151d0: 6520 7374 6570 2074 6f20 6a75 6d70 2066  e step to jump f
+000151e0: 6f72 2074 6865 206d 6f76 696e 6720 7769  or the moving wi
+000151f0: 6e64 6f77 2028 696e 2073 6563 6f6e 6473  ndow (in seconds
+00015200: 290a 2020 2020 7061 7261 3a20 6120 6469  ).    para: a di
+00015210: 6374 2063 6f6e 7461 696e 696e 6720 6672  ct containing fr
+00015220: 6571 2f74 696d 6520 696e 666f 206f 6620  eq/time info of 
+00015230: 7468 6520 6461 7461 206d 6174 7269 780a  the data matrix.
+00015240: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+00015250: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20    ------------. 
+00015260: 2020 2074 696d 655f 6178 6973 3a20 6365     time_axis: ce
+00015270: 6e74 7261 6c20 7469 6d65 7320 6f66 2074  ntral times of t
+00015280: 6865 206d 6f76 696e 6720 7769 6e64 6f77  he moving window
+00015290: 0a20 2020 2064 656c 7461 5f74 3a20 6474  .    delta_t: dt
+000152a0: 0a20 2020 2064 656c 7461 5f65 7272 3a20  .    delta_err: 
+000152b0: 6572 726f 720a 2020 2020 6465 6c74 615f  error.    delta_
+000152c0: 6d63 6f68 3a20 6d65 616e 2063 6f68 6572  mcoh: mean coher
+000152d0: 656e 6365 2066 6f72 2065 6163 6820 7769  ence for each wi
+000152e0: 6e64 6f77 0a0a 2020 2020 5772 6974 7465  ndow..    Writte
+000152f0: 6e20 6279 2043 6f6e 6763 6f6e 6720 5975  n by Congcong Yu
+00015300: 616e 2028 3120 4a75 6c79 2c20 3230 3139  an (1 July, 2019
+00015310: 290a 2020 2020 2222 220a 2020 2020 2320  ).    """.    # 
+00015320: 636f 6d6d 6f6e 2076 6172 6961 626c 6573  common variables
+00015330: 0a20 2020 2074 7769 6e20 3d20 7061 7261  .    twin = para
+00015340: 5b22 7477 696e 225d 0a20 2020 2064 7420  ["twin"].    dt 
+00015350: 3d20 7061 7261 5b22 6474 225d 0a20 2020  = para["dt"].   
+00015360: 2074 6d69 6e20 3d20 6e70 2e6d 696e 2874   tmin = np.min(t
+00015370: 7769 6e29 0a0a 2020 2020 2320 7061 7261  win)..    # para
+00015380: 6d65 7465 7220 696e 6974 6961 6c69 7a65  meter initialize
+00015390: 0a20 2020 2064 656c 7461 5f74 203d 205b  .    delta_t = [
+000153a0: 5d0a 2020 2020 6465 6c74 615f 745f 636f  ].    delta_t_co
+000153b0: 6566 203d 205b 5d0a 2020 2020 7469 6d65  ef = [].    time
+000153c0: 5f61 7869 7320 3d20 5b5d 0a0a 2020 2020  _axis = []..    
+000153d0: 2320 696e 666f 206f 6e20 7468 6520 6d6f  # info on the mo
+000153e0: 7669 6e67 2077 696e 646f 770a 2020 2020  ving window.    
+000153f0: 7769 6e64 6f77 5f6c 656e 6774 685f 7361  window_length_sa
+00015400: 6d70 6c65 7320 3d20 6e70 2e69 6e74 286d  mples = np.int(m
+00015410: 6f76 696e 675f 7769 6e64 6f77 5f6c 656e  oving_window_len
+00015420: 6774 6820 2f20 6474 290a 2020 2020 636f  gth / dt).    co
+00015430: 756e 7420 3d20 300a 2020 2020 7470 203d  unt = 0.    tp =
+00015440: 2063 6f73 696e 655f 7461 7065 7228 7769   cosine_taper(wi
+00015450: 6e64 6f77 5f6c 656e 6774 685f 7361 6d70  ndow_length_samp
+00015460: 6c65 732c 2030 2e31 3529 0a0a 2020 2020  les, 0.15)..    
+00015470: 6d69 6e69 6e64 203d 2030 0a20 2020 206d  minind = 0.    m
+00015480: 6178 696e 6420 3d20 7769 6e64 6f77 5f6c  axind = window_l
+00015490: 656e 6774 685f 7361 6d70 6c65 730a 0a20  ength_samples.. 
+000154a0: 2020 2023 206c 6f6f 7020 7468 726f 7567     # loop throug
+000154b0: 6820 616c 6c20 7375 622d 7769 6e64 6f77  h all sub-window
+000154c0: 730a 2020 2020 7768 696c 6520 6d61 7869  s.    while maxi
+000154d0: 6e64 203c 3d20 6c65 6e28 7265 6629 3a0a  nd <= len(ref):.
+000154e0: 2020 2020 2020 2020 6363 6920 3d20 6375          cci = cu
+000154f0: 725b 6d69 6e69 6e64 3a6d 6178 696e 645d  r[minind:maxind]
+00015500: 0a20 2020 2020 2020 2063 6369 203d 2073  .        cci = s
+00015510: 6369 7079 2e73 6967 6e61 6c2e 6465 7472  cipy.signal.detr
+00015520: 656e 6428 6363 692c 2074 7970 653d 226c  end(cci, type="l
+00015530: 696e 6561 7222 290a 2020 2020 2020 2020  inear").        
+00015540: 6363 6920 2a3d 2074 700a 0a20 2020 2020  cci *= tp..     
+00015550: 2020 2063 7269 203d 2072 6566 5b6d 696e     cri = ref[min
+00015560: 696e 643a 6d61 7869 6e64 5d0a 2020 2020  ind:maxind].    
+00015570: 2020 2020 6372 6920 3d20 7363 6970 792e      cri = scipy.
+00015580: 7369 676e 616c 2e64 6574 7265 6e64 2863  signal.detrend(c
+00015590: 7269 2c20 7479 7065 3d22 6c69 6e65 6172  ri, type="linear
+000155a0: 2229 0a20 2020 2020 2020 2063 7269 202a  ").        cri *
+000155b0: 3d20 7470 0a0a 2020 2020 2020 2020 6d69  = tp..        mi
+000155c0: 6e69 6e64 202b 3d20 696e 7428 736c 6964  nind += int(slid
+000155d0: 655f 7374 6570 202f 2064 7429 0a20 2020  e_step / dt).   
+000155e0: 2020 2020 206d 6178 696e 6420 2b3d 2069       maxind += i
+000155f0: 6e74 2873 6c69 6465 5f73 7465 7020 2f20  nt(slide_step / 
+00015600: 6474 290a 0a20 2020 2020 2020 2023 206e  dt)..        # n
+00015610: 6f72 6d61 6c69 7a65 2073 6967 6e61 6c73  ormalize signals
+00015620: 2062 6566 6f72 6520 6372 6f73 7320 636f   before cross co
+00015630: 7272 656c 6174 696f 6e0a 2020 2020 2020  rrelation.      
+00015640: 2020 6363 6920 3d20 2863 6369 202d 2063    cci = (cci - c
+00015650: 6369 2e6d 6561 6e28 2929 202f 2063 6369  ci.mean()) / cci
+00015660: 2e73 7464 2829 0a20 2020 2020 2020 2063  .std().        c
+00015670: 7269 203d 2028 6372 6920 2d20 6372 692e  ri = (cri - cri.
+00015680: 6d65 616e 2829 2920 2f20 6372 692e 7374  mean()) / cri.st
+00015690: 6428 290a 0a20 2020 2020 2020 2023 2067  d()..        # g
+000156a0: 6574 206d 6178 696d 756d 2063 6f72 7265  et maximum corre
+000156b0: 6c61 7469 6f6e 2063 6f65 6666 6963 6965  lation coefficie
+000156c0: 6e74 2061 6e64 2069 7473 2069 6e64 6578  nt and its index
+000156d0: 0a20 2020 2020 2020 2063 6332 203d 206e  .        cc2 = n
+000156e0: 702e 636f 7272 656c 6174 6528 6363 692c  p.correlate(cci,
+000156f0: 2063 7269 2c20 6d6f 6465 3d22 7361 6d65   cri, mode="same
+00015700: 2229 0a20 2020 2020 2020 2063 6332 203d  ").        cc2 =
+00015710: 2063 6332 202f 206e 702e 7371 7274 2828   cc2 / np.sqrt((
+00015720: 6363 692a 2a32 292e 7375 6d28 2920 2a20  cci**2).sum() * 
+00015730: 2863 7269 2a2a 3229 2e73 756d 2829 290a  (cri**2).sum()).
+00015740: 0a20 2020 2020 2020 2069 6d61 7863 6332  .        imaxcc2
+00015750: 203d 206e 702e 7768 6572 6528 6363 3220   = np.where(cc2 
+00015760: 3d3d 206e 702e 6d61 7828 6363 3229 295b  == np.max(cc2))[
+00015770: 305d 0a20 2020 2020 2020 206d 6178 6363  0].        maxcc
+00015780: 3220 3d20 6e70 2e6d 6178 2863 6332 290a  2 = np.max(cc2).
+00015790: 0a20 2020 2020 2020 2023 2067 6574 2074  .        # get t
+000157a0: 6865 2074 696d 6520 7368 6966 740a 2020  he time shift.  
+000157b0: 2020 2020 2020 6d20 3d20 2869 6d61 7863        m = (imaxc
+000157c0: 6332 202d 2028 286d 6178 696e 6420 2d20  c2 - ((maxind - 
+000157d0: 6d69 6e69 6e64 2920 2f2f 2032 2929 202a  minind) // 2)) *
+000157e0: 2064 740a 2020 2020 2020 2020 6465 6c74   dt.        delt
+000157f0: 615f 742e 6170 7065 6e64 286d 290a 2020  a_t.append(m).  
+00015800: 2020 2020 2020 6465 6c74 615f 745f 636f        delta_t_co
+00015810: 6566 2e61 7070 656e 6428 6d61 7863 6332  ef.append(maxcc2
+00015820: 290a 0a20 2020 2020 2020 2074 696d 655f  )..        time_
+00015830: 6178 6973 2e61 7070 656e 6428 746d 696e  axis.append(tmin
+00015840: 202b 206d 6f76 696e 675f 7769 6e64 6f77   + moving_window
+00015850: 5f6c 656e 6774 6820 2f20 322e 3020 2b20  _length / 2.0 + 
+00015860: 636f 756e 7420 2a20 736c 6964 655f 7374  count * slide_st
+00015870: 6570 290a 2020 2020 2020 2020 636f 756e  ep).        coun
+00015880: 7420 2b3d 2031 0a0a 2020 2020 6465 6c20  t += 1..    del 
+00015890: 6363 692c 2063 7269 2c20 6363 322c 2069  cci, cri, cc2, i
+000158a0: 6d61 7863 6332 2c20 6d61 7863 6332 0a20  maxcc2, maxcc2. 
+000158b0: 2020 2064 656c 206d 0a0a 2020 2020 6966     del m..    if
+000158c0: 206d 6178 696e 6420 3e20 6c65 6e28 6375   maxind > len(cu
+000158d0: 7229 202b 2069 6e74 2873 6c69 6465 5f73  r) + int(slide_s
+000158e0: 7465 7020 2f20 6474 293a 0a20 2020 2020  tep / dt):.     
+000158f0: 2020 2070 7269 6e74 2822 5468 6520 6c61     print("The la
+00015900: 7374 2077 696e 646f 7720 7761 7320 746f  st window was to
+00015910: 6f20 736d 616c 6c2c 2062 7574 2077 6173  o small, but was
+00015920: 2063 6f6d 7075 7465 6422 290a 0a20 2020   computed")..   
+00015930: 2064 656c 7461 5f74 203d 206e 702e 6172   delta_t = np.ar
+00015940: 7261 7928 6465 6c74 615f 7429 0a20 2020  ray(delta_t).   
+00015950: 2064 656c 7461 5f74 5f63 6f65 6620 3d20   delta_t_coef = 
+00015960: 6e70 2e61 7272 6179 2864 656c 7461 5f74  np.array(delta_t
+00015970: 5f63 6f65 6629 0a20 2020 2074 696d 655f  _coef).    time_
+00015980: 6178 6973 203d 206e 702e 6172 7261 7928  axis = np.array(
+00015990: 7469 6d65 5f61 7869 7329 0a0a 2020 2020  time_axis)..    
+000159a0: 2320 6c69 6e65 6172 2072 6567 7265 7373  # linear regress
+000159b0: 696f 6e20 746f 2067 6574 2064 762f 760a  ion to get dv/v.
+000159c0: 2020 2020 6966 2063 6f75 6e74 203e 2032      if count > 2
+000159d0: 3a0a 2020 2020 2020 2020 2320 7369 6d70  :.        # simp
+000159e0: 6c65 2077 6569 6768 740a 2020 2020 2020  le weight.      
+000159f0: 2020 7720 3d20 6e70 2e6f 6e65 7328 636f    w = np.ones(co
+00015a00: 756e 7429 0a20 2020 2020 2020 2023 206d  unt).        # m
+00015a10: 2c20 612c 2065 6d2c 2065 6120 3d20 6c69  , a, em, ea = li
+00015a20: 6e65 6172 5f72 6567 7265 7373 696f 6e28  near_regression(
+00015a30: 7469 6d65 5f61 7869 735b 696e 6478 5d2c  time_axis[indx],
+00015a40: 2064 656c 7461 5f74 5b69 6e64 785d 2c20   delta_t[indx], 
+00015a50: 772c 2069 6e74 6572 6365 7074 5f6f 7269  w, intercept_ori
+00015a60: 6769 6e3d 4661 6c73 6529 0a20 2020 2020  gin=False).     
+00015a70: 2020 206d 302c 2065 6d30 203d 206c 696e     m0, em0 = lin
+00015a80: 6561 725f 7265 6772 6573 7369 6f6e 2874  ear_regression(t
+00015a90: 696d 655f 6178 6973 2e66 6c61 7474 656e  ime_axis.flatten
+00015aa0: 2829 2c20 6465 6c74 615f 742e 666c 6174  (), delta_t.flat
+00015ab0: 7465 6e28 292c 2077 2e66 6c61 7474 656e  ten(), w.flatten
+00015ac0: 2829 2c20 696e 7465 7263 6570 745f 6f72  (), intercept_or
+00015ad0: 6967 696e 3d54 7275 6529 0a0a 2020 2020  igin=True)..    
+00015ae0: 656c 7365 3a0a 2020 2020 2020 2020 7072  else:.        pr
+00015af0: 696e 7428 226e 6f74 2065 6e6f 7567 6820  int("not enough 
+00015b00: 706f 696e 7473 2074 6f20 6573 7469 6d61  points to estima
+00015b10: 7465 2064 762f 7620 666f 7220 7763 6322  te dv/v for wcc"
+00015b20: 290a 2020 2020 2020 2020 6d30 203d 2030  ).        m0 = 0
+00015b30: 0a20 2020 2020 2020 2065 6d30 203d 2030  .        em0 = 0
+00015b40: 0a0a 2020 2020 7265 7475 726e 202d 6d30  ..    return -m0
+00015b50: 202a 2031 3030 2c20 656d 3020 2a20 3130   * 100, em0 * 10
+00015b60: 300a 0a0a 6465 6620 7778 735f 6476 7628  0...def wxs_dvv(
+00015b70: 0a20 2020 2072 6566 2c0a 2020 2020 6375  .    ref,.    cu
+00015b80: 722c 0a20 2020 2061 6c6c 6672 6571 2c0a  r,.    allfreq,.
+00015b90: 2020 2020 7061 7261 2c0a 2020 2020 646a      para,.    dj
+00015ba0: 3d31 202f 2031 322c 0a20 2020 2073 303d  =1 / 12,.    s0=
+00015bb0: 2d31 2c0a 2020 2020 4a3d 2d31 2c0a 2020  -1,.    J=-1,.  
+00015bc0: 2020 7369 673d 4661 6c73 652c 0a20 2020    sig=False,.   
+00015bd0: 2077 766e 3d22 6d6f 726c 6574 222c 0a20   wvn="morlet",. 
+00015be0: 2020 2075 6e77 7261 7066 6c61 673d 4661     unwrapflag=Fa
+00015bf0: 6c73 652c 0a29 3a0a 2020 2020 2222 220a  lse,.):.    """.
+00015c00: 2020 2020 436f 6d70 7574 6520 6474 206f      Compute dt o
+00015c10: 7220 6476 2f76 2069 6e20 7469 6d65 2061  r dv/v in time a
+00015c20: 6e64 2066 7265 7175 656e 6379 2064 6f6d  nd frequency dom
+00015c30: 6169 6e20 6672 6f6d 2077 6176 656c 6574  ain from wavelet
+00015c40: 2063 726f 7373 2073 7065 6374 7275 6d20   cross spectrum 
+00015c50: 2877 7873 292e 0a20 2020 2066 6f72 2061  (wxs)..    for a
+00015c60: 6c6c 2066 7265 7175 6563 6965 7320 696e  ll frequecies in
+00015c70: 2061 6e20 696e 7465 7265 7374 2072 616e   an interest ran
+00015c80: 6765 0a0a 2020 2020 5061 7261 6d65 7465  ge..    Paramete
+00015c90: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+00015ca0: 2d2d 2d2d 2d0a 2020 2020 7265 663a 2054  -----.    ref: T
+00015cb0: 6865 2022 5265 6665 7265 6e63 6522 2074  he "Reference" t
+00015cc0: 696d 6573 6572 6965 7320 286e 756d 7079  imeseries (numpy
+00015cd0: 2e6e 6461 7272 6179 290a 2020 2020 6375  .ndarray).    cu
+00015ce0: 723a 2054 6865 2022 4375 7272 656e 7422  r: The "Current"
+00015cf0: 2074 696d 6573 6572 6965 7320 286e 756d   timeseries (num
+00015d00: 7079 2e6e 6461 7272 6179 290a 2020 2020  py.ndarray).    
+00015d10: 616c 6c66 7265 713a 2061 2062 6f6f 6c65  allfreq: a boole
+00015d20: 6e20 7661 7269 6162 6c65 2074 6f20 6d61  n variable to ma
+00015d30: 6b65 206d 6561 7375 7265 6d65 6e74 7320  ke measurements 
+00015d40: 6f6e 2061 6c6c 2066 7265 7175 656e 6379  on all frequency
+00015d50: 2072 616e 6765 206f 7220 6e6f 740a 2020   range or not.  
+00015d60: 2020 7061 7261 3a20 6120 6469 6374 2063    para: a dict c
+00015d70: 6f6e 7461 696e 696e 6720 6672 6571 2f74  ontaining freq/t
+00015d80: 696d 6520 696e 666f 206f 6620 7468 6520  ime info of the 
+00015d90: 6461 7461 206d 6174 7269 780a 2020 2020  data matrix.    
+00015da0: 646a 2c20 7330 2c20 4a2c 2073 6967 2c20  dj, s0, J, sig, 
+00015db0: 7776 6e3a 2063 6f6d 6d6f 6e20 7061 7261  wvn: common para
+00015dc0: 6d65 7465 7273 2075 7365 6420 696e 2027  meters used in '
+00015dd0: 7761 7665 6c65 742e 7763 7427 0a20 2020  wavelet.wct'.   
+00015de0: 2075 6e77 7261 7066 6c61 673a 2054 7275   unwrapflag: Tru
+00015df0: 6520 2d20 756e 7772 6170 2070 6861 7365  e - unwrap phase
+00015e00: 2064 656c 6179 732e 2044 6566 6175 6c74   delays. Default
+00015e10: 2069 7320 4661 6c73 650a 0a20 2020 2052   is False..    R
+00015e20: 4554 5552 4e53 3a0a 2020 2020 2d2d 2d2d  ETURNS:.    ----
+00015e30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
+00015e40: 2020 2064 7676 2a31 3030 203a 2065 7374     dvv*100 : est
+00015e50: 696d 6174 6564 2064 762f 7620 696e 2025  imated dv/v in %
+00015e60: 0a20 2020 2065 7272 2a31 3030 203a 2065  .    err*100 : e
+00015e70: 7272 6f72 206f 6620 6476 2f76 2065 7374  rror of dv/v est
+00015e80: 696d 6174 696f 6e20 696e 2025 0a0a 2020  imation in %..  
+00015e90: 2020 4f72 6967 696e 616c 6c79 2077 7269    Originally wri
+00015ea0: 7474 656e 2062 7920 5469 6d20 436c 656d  tten by Tim Clem
+00015eb0: 656e 7473 2028 3120 4d61 7263 682c 2032  ents (1 March, 2
+00015ec0: 3031 3929 0a20 2020 204d 6f64 6966 6965  019).    Modifie
+00015ed0: 6420 6279 2043 6f6e 6763 6f6e 6720 5975  d by Congcong Yu
+00015ee0: 616e 2028 3330 204a 756e 652c 2032 3031  an (30 June, 201
+00015ef0: 3929 2062 6173 6564 206f 6e20 284d 616f  9) based on (Mao
+00015f00: 2065 7420 616c 2e20 3230 3139 292e 0a20   et al. 2019).. 
+00015f10: 2020 2055 7064 6174 6564 2062 7920 4368     Updated by Ch
+00015f20: 656e 6778 696e 204a 6961 6e67 2028 3130  engxin Jiang (10
+00015f30: 204f 6374 2c20 3230 3139 2920 746f 206d   Oct, 2019) to m
+00015f40: 6572 6765 2074 6865 2066 756e 6374 696f  erge the functio
+00015f50: 6e61 6c69 7479 2066 6f72 206d 6573 7572  nality for mesur
+00015f60: 656d 656e 7473 0a20 2020 2061 6372 6f73  ements.    acros
+00015f70: 7320 616c 6c20 6672 6571 7565 6e63 7920  s all frequency 
+00015f80: 616e 6420 6f6e 6520 6672 6571 2072 616e  and one freq ran
+00015f90: 6765 0a20 2020 2022 2222 0a20 2020 2023  ge.    """.    #
+00015fa0: 2063 6f6d 6d6f 6e20 7661 7269 6162 6c65   common variable
+00015fb0: 730a 2020 2020 7477 696e 203d 2070 6172  s.    twin = par
+00015fc0: 615b 2274 7769 6e22 5d0a 2020 2020 6672  a["twin"].    fr
+00015fd0: 6571 203d 2070 6172 615b 2266 7265 7122  eq = para["freq"
+00015fe0: 5d0a 2020 2020 6474 203d 2070 6172 615b  ].    dt = para[
+00015ff0: 2264 7422 5d0a 2020 2020 746d 696e 203d  "dt"].    tmin =
+00016000: 206e 702e 6d69 6e28 7477 696e 290a 2020   np.min(twin).  
+00016010: 2020 746d 6178 203d 206e 702e 6d61 7828    tmax = np.max(
+00016020: 7477 696e 290a 2020 2020 666d 696e 203d  twin).    fmin =
+00016030: 206e 702e 6d69 6e28 6672 6571 290a 2020   np.min(freq).  
+00016040: 2020 666d 6178 203d 206e 702e 6d61 7828    fmax = np.max(
+00016050: 6672 6571 290a 2020 2020 7476 6563 203d  freq).    tvec =
+00016060: 206e 702e 6172 616e 6765 2874 6d69 6e2c   np.arange(tmin,
+00016070: 2074 6d61 782c 2064 7429 0a20 2020 206e   tmax, dt).    n
+00016080: 7074 7320 3d20 6c65 6e28 7476 6563 290a  pts = len(tvec).
+00016090: 0a20 2020 2023 2070 6572 666f 726d 2063  .    # perform c
+000160a0: 726f 7373 2063 6f68 6572 656e 7420 616e  ross coherent an
+000160b0: 616c 7973 6973 2c20 6d6f 6469 6669 6564  alysis, modified
+000160c0: 2066 726f 6d20 6675 6e63 7469 6f6e 2027   from function '
+000160d0: 7761 7665 6c65 742e 6377 7427 0a20 2020  wavelet.cwt'.   
+000160e0: 2057 4354 2c20 6157 4354 2c20 636f 692c   WCT, aWCT, coi,
+000160f0: 2066 7265 712c 2073 6967 203d 2077 6374   freq, sig = wct
+00016100: 5f6d 6f64 6966 6965 6428 7265 662c 2063  _modified(ref, c
+00016110: 7572 2c20 6474 2c20 646a 3d64 6a2c 2073  ur, dt, dj=dj, s
+00016120: 303d 7330 2c20 4a3d 4a2c 2073 6967 3d73  0=s0, J=J, sig=s
+00016130: 6967 2c20 7761 7665 6c65 743d 7776 6e2c  ig, wavelet=wvn,
+00016140: 206e 6f72 6d61 6c69 7a65 3d54 7275 6529   normalize=True)
+00016150: 0a0a 2020 2020 6966 2075 6e77 7261 7066  ..    if unwrapf
+00016160: 6c61 673a 0a20 2020 2020 2020 2070 6861  lag:.        pha
+00016170: 7365 203d 206e 702e 756e 7772 6170 2861  se = np.unwrap(a
+00016180: 5743 542c 2061 7869 733d 2d31 2920 2023  WCT, axis=-1)  #
+00016190: 2061 7869 733d 302c 2075 7077 7261 7020   axis=0, upwrap 
+000161a0: 616c 6f6e 6720 7469 6d65 3b20 6178 6973  along time; axis
+000161b0: 3d2d 312c 2075 6e77 7261 7020 616c 6f6e  =-1, unwrap alon
+000161c0: 6720 6672 6571 7565 6e63 790a 2020 2020  g frequency.    
+000161d0: 656c 7365 3a0a 2020 2020 2020 2020 7068  else:.        ph
+000161e0: 6173 6520 3d20 6157 4354 0a0a 2020 2020  ase = aWCT..    
+000161f0: 2320 7a65 726f 206f 7574 2064 6174 6120  # zero out data 
+00016200: 6f75 7473 6964 6520 6672 6571 7565 6e63  outside frequenc
+00016210: 7920 6261 6e64 0a20 2020 2069 6620 2866  y band.    if (f
+00016220: 6d61 7820 3e20 6e70 2e6d 6178 2866 7265  max > np.max(fre
+00016230: 7129 2920 7c20 2866 6d61 7820 3c3d 2066  q)) | (fmax <= f
+00016240: 6d69 6e29 3a0a 2020 2020 2020 2020 7261  min):.        ra
+00016250: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
+00016260: 4162 6f72 743a 2069 6e70 7574 2066 7265  Abort: input fre
+00016270: 7175 656e 6379 206f 7574 206f 6620 6c69  quency out of li
+00016280: 6d69 7473 2122 290a 2020 2020 656c 7365  mits!").    else
+00016290: 3a0a 2020 2020 2020 2020 6672 6571 5f69  :.        freq_i
+000162a0: 6e64 696e 203d 206e 702e 7768 6572 6528  ndin = np.where(
+000162b0: 2866 7265 7120 3e3d 2066 6d69 6e29 2026  (freq >= fmin) &
+000162c0: 2028 6672 6571 203c 3d20 666d 6178 2929   (freq <= fmax))
+000162d0: 5b30 5d0a 0a20 2020 2023 2066 6f6c 6c6f  [0]..    # follo
+000162e0: 7720 4d57 4353 2074 6f20 646f 2074 776f  w MWCS to do two
+000162f0: 2073 7465 7073 206f 6620 6c69 6e65 6172   steps of linear
+00016300: 2072 6567 7265 7373 696f 6e0a 2020 2020   regression.    
+00016310: 6966 206e 6f74 2061 6c6c 6672 6571 3a0a  if not allfreq:.
+00016320: 2020 2020 2020 2020 6465 6c74 615f 745f          delta_t_
+00016330: 6d2c 2064 656c 7461 5f74 5f75 6e63 203d  m, delta_t_unc =
+00016340: 206e 702e 7a65 726f 7328 6e70 7473 2c20   np.zeros(npts, 
+00016350: 6474 7970 653d 6e70 2e66 6c6f 6174 3332  dtype=np.float32
+00016360: 292c 206e 702e 7a65 726f 7328 6e70 7473  ), np.zeros(npts
+00016370: 2c20 6474 7970 653d 6e70 2e66 6c6f 6174  , dtype=np.float
+00016380: 3332 290a 2020 2020 2020 2020 2320 6173  32).        # as
+00016390: 7375 6d65 2074 6865 2074 7665 6320 6973  sume the tvec is
+000163a0: 2074 6865 2074 696d 6520 7769 6e64 6f77   the time window
+000163b0: 2074 6f20 6d65 6173 7572 6520 6474 0a20   to measure dt. 
+000163c0: 2020 2020 2020 2066 6f72 2069 7420 696e         for it in
+000163d0: 2072 616e 6765 286e 7074 7329 3a0a 2020   range(npts):.  
+000163e0: 2020 2020 2020 2020 2020 7720 3d20 3120            w = 1 
+000163f0: 2f20 5743 545b 6672 6571 5f69 6e64 696e  / WCT[freq_indin
+00016400: 2c20 6974 5d0a 2020 2020 2020 2020 2020  , it].          
+00016410: 2020 775b 7e6e 702e 6973 6669 6e69 7465    w[~np.isfinite
+00016420: 2877 295d 203d 2031 2e30 0a20 2020 2020  (w)] = 1.0.     
+00016430: 2020 2020 2020 2064 656c 7461 5f74 5f6d         delta_t_m
+00016440: 5b69 745d 2c20 6465 6c74 615f 745f 756e  [it], delta_t_un
+00016450: 635b 6974 5d20 3d20 6c69 6e65 6172 5f72  c[it] = linear_r
+00016460: 6567 7265 7373 696f 6e28 6672 6571 5b66  egression(freq[f
+00016470: 7265 715f 696e 6469 6e5d 202a 2032 202a  req_indin] * 2 *
+00016480: 206e 702e 7069 2c20 7068 6173 655b 6672   np.pi, phase[fr
+00016490: 6571 5f69 6e64 696e 2c20 6974 5d2c 2077  eq_indin, it], w
+000164a0: 290a 0a20 2020 2020 2020 2023 206e 6577  )..        # new
+000164b0: 2077 6569 6768 7473 2066 6f72 2072 6567   weights for reg
+000164c0: 7265 7373 696f 6e0a 2020 2020 2020 2020  ression.        
+000164d0: 7732 203d 2031 202f 206e 702e 6d65 616e  w2 = 1 / np.mean
+000164e0: 2857 4354 5b66 7265 715f 696e 6469 6e2c  (WCT[freq_indin,
+000164f0: 203a 5d2c 2061 7869 733d 3029 0a20 2020   :], axis=0).   
+00016500: 2020 2020 2077 325b 7e6e 702e 6973 6669       w2[~np.isfi
+00016510: 6e69 7465 2877 3229 5d20 3d20 312e 300a  nite(w2)] = 1.0.
+00016520: 0a20 2020 2020 2020 2023 206e 6f77 2075  .        # now u
+00016530: 7365 2064 7420 616e 6420 7420 746f 2067  se dt and t to g
+00016540: 6574 2064 762f 760a 2020 2020 2020 2020  et dv/v.        
+00016550: 6966 206c 656e 2877 3229 203e 2032 3a0a  if len(w2) > 2:.
+00016560: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00016570: 6f74 206e 702e 616e 7928 6465 6c74 615f  ot np.any(delta_
+00016580: 745f 6d29 3a0a 2020 2020 2020 2020 2020  t_m):.          
+00016590: 2020 2020 2020 6476 762c 2065 7272 203d        dvv, err =
+000165a0: 206e 702e 6e61 6e2c 206e 702e 6e61 6e0a   np.nan, np.nan.
+000165b0: 2020 2020 2020 2020 2020 2020 6d2c 2065              m, e
+000165c0: 6d20 3d20 6c69 6e65 6172 5f72 6567 7265  m = linear_regre
+000165d0: 7373 696f 6e28 7476 6563 2c20 6465 6c74  ssion(tvec, delt
+000165e0: 615f 745f 6d2c 2077 322c 2069 6e74 6572  a_t_m, w2, inter
+000165f0: 6365 7074 5f6f 7269 6769 6e3d 5472 7565  cept_origin=True
+00016600: 290a 2020 2020 2020 2020 2020 2020 6476  ).            dv
+00016610: 762c 2065 7272 203d 202d 6d2c 2065 6d0a  v, err = -m, em.
+00016620: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00016630: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00016640: 226e 6f74 2065 6e6f 7567 6820 706f 696e  "not enough poin
+00016650: 7473 2074 6f20 6573 7469 6d61 7465 2064  ts to estimate d
+00016660: 762f 7620 666f 7220 7774 7322 290a 2020  v/v for wts").  
+00016670: 2020 2020 2020 2020 2020 6476 762c 2065            dvv, e
+00016680: 7272 203d 206e 702e 6e61 6e2c 206e 702e  rr = np.nan, np.
+00016690: 6e61 6e0a 0a20 2020 2020 2020 2072 6574  nan..        ret
+000166a0: 7572 6e20 6476 7620 2a20 3130 302c 2065  urn dvv * 100, e
+000166b0: 7272 202a 2031 3030 0a0a 2020 2020 2320  rr * 100..    # 
+000166c0: 636f 6e76 6572 7420 7068 6173 6520 6469  convert phase di
+000166d0: 7265 6374 6c79 2074 6f20 6465 6c74 615f  rectly to delta_
+000166e0: 7420 666f 7220 616c 6c20 6672 6571 7565  t for all freque
+000166f0: 6e63 6965 730a 2020 2020 656c 7365 3a0a  ncies.    else:.
+00016700: 2020 2020 2020 2020 2320 636f 6e76 6572          # conver
+00016710: 7420 7068 6173 6520 6465 6c61 7920 746f  t phase delay to
+00016720: 2074 696d 6520 6465 6c61 790a 2020 2020   time delay.    
+00016730: 2020 2020 6465 6c74 615f 7420 3d20 7068      delta_t = ph
+00016740: 6173 6520 2f20 2832 202a 206e 702e 7069  ase / (2 * np.pi
+00016750: 202a 2066 7265 715b 3a2c 204e 6f6e 655d   * freq[:, None]
+00016760: 2920 2023 206e 6f72 6d61 6c69 7a65 2070  )  # normalize p
+00016770: 6861 7365 2062 7920 2832 2a70 692a 6672  hase by (2*pi*fr
+00016780: 6571 7565 6e63 7929 0a20 2020 2020 2020  equency).       
+00016790: 2064 7676 2c20 6572 7220 3d20 6e70 2e7a   dvv, err = np.z
+000167a0: 6572 6f73 2866 7265 715f 696e 6469 6e2e  eros(freq_indin.
+000167b0: 7368 6170 6529 2c20 6e70 2e7a 6572 6f73  shape), np.zeros
+000167c0: 2866 7265 715f 696e 6469 6e2e 7368 6170  (freq_indin.shap
+000167d0: 6529 0a0a 2020 2020 2020 2020 2320 6c6f  e)..        # lo
+000167e0: 6f70 2074 6872 6f75 6768 2066 7265 7120  op through freq 
+000167f0: 666f 7220 6c69 6e65 6172 2072 6567 7265  for linear regre
+00016800: 7373 696f 6e0a 2020 2020 2020 2020 666f  ssion.        fo
+00016810: 7220 6969 2c20 6966 7265 7120 696e 2065  r ii, ifreq in e
+00016820: 6e75 6d65 7261 7465 2866 7265 715f 696e  numerate(freq_in
+00016830: 6469 6e29 3a0a 2020 2020 2020 2020 2020  din):.          
+00016840: 2020 6966 206c 656e 2874 7665 6329 203e    if len(tvec) >
+00016850: 2032 3a0a 2020 2020 2020 2020 2020 2020   2:.            
+00016860: 2020 2020 6966 206e 6f74 206e 702e 616e      if not np.an
+00016870: 7928 6465 6c74 615f 745b 6966 7265 715d  y(delta_t[ifreq]
+00016880: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00016890: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+000168a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000168b0: 2023 2068 6f77 2074 6f20 6265 7474 6572   # how to better
+000168c0: 2061 7070 726f 6163 6820 7468 6520 756e   approach the un
+000168d0: 6365 7274 6169 6e74 7920 6f66 2064 656c  certainty of del
+000168e0: 7461 5f74 0a20 2020 2020 2020 2020 2020  ta_t.           
+000168f0: 2020 2020 2077 203d 2031 202f 2057 4354       w = 1 / WCT
+00016900: 5b69 6672 6571 5d0a 2020 2020 2020 2020  [ifreq].        
+00016910: 2020 2020 2020 2020 775b 7e6e 702e 6973          w[~np.is
+00016920: 6669 6e69 7465 2877 295d 203d 2031 2e30  finite(w)] = 1.0
+00016930: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00016940: 2020 2320 6d2c 2061 2c20 656d 2c20 6561    # m, a, em, ea
+00016950: 203d 206c 696e 6561 725f 7265 6772 6573   = linear_regres
+00016960: 7369 6f6e 2874 696d 655f 6178 6973 5b69  sion(time_axis[i
+00016970: 6e64 785d 2c20 6465 6c74 615f 745b 696e  ndx], delta_t[in
+00016980: 6478 5d2c 2077 2c20 696e 7465 7263 6570  dx], w, intercep
+00016990: 745f 6f72 6967 696e 3d46 616c 7365 290a  t_origin=False).
+000169a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000169b0: 6d2c 2065 6d20 3d20 6c69 6e65 6172 5f72  m, em = linear_r
+000169c0: 6567 7265 7373 696f 6e28 7476 6563 2c20  egression(tvec, 
+000169d0: 6465 6c74 615f 745b 6966 7265 715d 2c20  delta_t[ifreq], 
+000169e0: 772c 2069 6e74 6572 6365 7074 5f6f 7269  w, intercept_ori
+000169f0: 6769 6e3d 5472 7565 290a 2020 2020 2020  gin=True).      
+00016a00: 2020 2020 2020 2020 2020 6476 765b 6969            dvv[ii
+00016a10: 5d2c 2065 7272 5b69 695d 203d 202d 6d2c  ], err[ii] = -m,
+00016a20: 2065 6d0a 2020 2020 2020 2020 2020 2020   em.            
+00016a30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00016a40: 2020 2020 2020 7072 696e 7428 226e 6f74        print("not
+00016a50: 2065 6e6f 7567 6820 706f 696e 7473 2074   enough points t
+00016a60: 6f20 6573 7469 6d61 7465 2064 762f 7620  o estimate dv/v 
+00016a70: 666f 7220 7774 7322 290a 2020 2020 2020  for wts").      
+00016a80: 2020 2020 2020 2020 2020 6476 765b 6969            dvv[ii
+00016a90: 5d2c 2065 7272 5b69 695d 203d 206e 702e  ], err[ii] = np.
+00016aa0: 6e61 6e2c 206e 702e 6e61 6e0a 0a20 2020  nan, np.nan..   
+00016ab0: 2020 2020 2072 6574 7572 6e20 6672 6571       return freq
+00016ac0: 5b66 7265 715f 696e 6469 6e5d 2c20 6476  [freq_indin], dv
+00016ad0: 7620 2a20 3130 302c 2065 7272 202a 2031  v * 100, err * 1
+00016ae0: 3030 0a0a 0a64 6566 2077 7473 5f64 7676  00...def wts_dvv
+00016af0: 280a 2020 2020 7265 662c 0a20 2020 2063  (.    ref,.    c
+00016b00: 7572 2c0a 2020 2020 616c 6c66 7265 712c  ur,.    allfreq,
+00016b10: 0a20 2020 2070 6172 612c 0a20 2020 2064  .    para,.    d
+00016b20: 765f 7261 6e67 652c 0a20 2020 206e 6274  v_range,.    nbt
+00016b30: 7269 616c 2c0a 2020 2020 646a 3d31 202f  rial,.    dj=1 /
+00016b40: 2031 322c 0a20 2020 2073 303d 2d31 2c0a   12,.    s0=-1,.
+00016b50: 2020 2020 4a3d 2d31 2c0a 2020 2020 7776      J=-1,.    wv
+00016b60: 6e3d 226d 6f72 6c65 7422 2c0a 2020 2020  n="morlet",.    
+00016b70: 6e6f 726d 616c 697a 653d 5472 7565 2c0a  normalize=True,.
+00016b80: 293a 0a20 2020 2022 2222 0a20 2020 2041  ):.    """.    A
+00016b90: 7070 6c79 2073 7472 6574 6368 696e 6720  pply stretching 
+00016ba0: 6d65 7468 6f64 2074 6f20 636f 6e74 696e  method to contin
+00016bb0: 756f 7573 2077 6176 656c 6574 2074 7261  uous wavelet tra
+00016bc0: 6e73 666f 726d 6174 696f 6e20 2843 5754  nsformation (CWT
+00016bd0: 2920 6f66 2073 6967 6e61 6c73 0a20 2020  ) of signals.   
+00016be0: 2066 6f72 2061 6c6c 2066 7265 7175 6563   for all frequec
+00016bf0: 6965 7320 696e 2061 6e20 696e 7465 7265  ies in an intere
+00016c00: 7374 2072 616e 6765 0a0a 2020 2020 5061  st range..    Pa
+00016c10: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00016c20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
+00016c30: 7265 663a 2054 6865 2022 5265 6665 7265  ref: The "Refere
+00016c40: 6e63 6522 2074 696d 6573 6572 6965 7320  nce" timeseries 
+00016c50: 286e 756d 7079 2e6e 6461 7272 6179 290a  (numpy.ndarray).
+00016c60: 2020 2020 6375 723a 2054 6865 2022 4375      cur: The "Cu
+00016c70: 7272 656e 7422 2074 696d 6573 6572 6965  rrent" timeserie
+00016c80: 7320 286e 756d 7079 2e6e 6461 7272 6179  s (numpy.ndarray
+00016c90: 290a 2020 2020 616c 6c66 7265 713a 2061  ).    allfreq: a
+00016ca0: 2062 6f6f 6c65 6e20 7661 7269 6162 6c65   boolen variable
+00016cb0: 2074 6f20 6d61 6b65 206d 6561 7375 7265   to make measure
+00016cc0: 6d65 6e74 7320 6f6e 2061 6c6c 2066 7265  ments on all fre
+00016cd0: 7175 656e 6379 2072 616e 6765 206f 7220  quency range or 
+00016ce0: 6e6f 740a 2020 2020 7061 7261 3a20 6120  not.    para: a 
+00016cf0: 6469 6374 2063 6f6e 7461 696e 696e 6720  dict containing 
+00016d00: 6672 6571 2f74 696d 6520 696e 666f 206f  freq/time info o
+00016d10: 6620 7468 6520 6461 7461 206d 6174 7269  f the data matri
+00016d20: 780a 2020 2020 6476 5f72 616e 6765 3a20  x.    dv_range: 
+00016d30: 6162 736f 6c75 7465 2062 6f75 6e64 2066  absolute bound f
+00016d40: 6f72 2074 6865 2076 656c 6f63 6974 7920  or the velocity 
+00016d50: 7661 7269 6174 696f 6e3b 2065 7861 6d70  variation; examp
+00016d60: 6c65 3a20 6476 3d30 2e30 3320 666f 7220  le: dv=0.03 for 
+00016d70: 5b2d 332c 335d 250a 2020 2020 6f66 2072  [-3,3]%.    of r
+00016d80: 656c 6174 6976 6520 7665 6c6f 6369 7479  elative velocity
+00016d90: 2063 6861 6e67 6520 2866 6c6f 6174 290a   change (float).
+00016da0: 2020 2020 6e62 7472 6961 6c3a 206e 756d      nbtrial: num
+00016db0: 6265 7220 6f66 2073 7472 6574 6368 696e  ber of stretchin
+00016dc0: 6720 636f 6566 6669 6369 656e 7420 6265  g coefficient be
+00016dd0: 7477 6565 6e20 6476 6d69 6e20 616e 6420  tween dvmin and 
+00016de0: 6476 6d61 782c 206e 6f20 6e65 6564 2074  dvmax, no need t
+00016df0: 6f20 6265 2068 6967 6865 7220 7468 616e  o be higher than
+00016e00: 2031 3030 2020 2866 6c6f 6174 290a 2020   100  (float).  
+00016e10: 2020 646a 2c20 7330 2c20 4a2c 2073 6967    dj, s0, J, sig
+00016e20: 2c20 7776 6e3a 2063 6f6d 6d6f 6e20 7061  , wvn: common pa
+00016e30: 7261 6d65 7465 7273 2075 7365 6420 696e  rameters used in
+00016e40: 2027 7761 7665 6c65 742e 7763 7427 0a20   'wavelet.wct'. 
+00016e50: 2020 206e 6f72 6d61 6c69 7a65 3a20 6e6f     normalize: no
+00016e60: 726d 616c 697a 6520 7468 6520 7761 7665  rmalize the wave
+00016e70: 6c65 7420 7370 6563 7472 756d 206f 7220  let spectrum or 
+00016e80: 6e6f 742e 2044 6566 6175 6c74 2069 7320  not. Default is 
+00016e90: 5472 7565 0a0a 2020 2020 5245 5455 524e  True..    RETURN
+00016ea0: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
+00016eb0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6476  ---------.    dv
+00016ec0: 763a 2065 7374 696d 6174 6564 2064 762f  v: estimated dv/
+00016ed0: 760a 2020 2020 6572 723a 2065 7272 6f72  v.    err: error
+00016ee0: 206f 6620 6476 2f76 2065 7374 696d 6174   of dv/v estimat
+00016ef0: 696f 6e0a 0a20 2020 2057 7269 7474 656e  ion..    Written
+00016f00: 2062 7920 436f 6e67 636f 6e67 2059 7561   by Congcong Yua
+00016f10: 6e20 2833 3020 4a75 6e2c 2032 3031 3929  n (30 Jun, 2019)
+00016f20: 0a20 2020 2022 2222 0a20 2020 2023 2063  .    """.    # c
+00016f30: 6f6d 6d6f 6e20 7661 7269 6162 6c65 730a  ommon variables.
+00016f40: 2020 2020 6672 6571 203d 2070 6172 615b      freq = para[
+00016f50: 2266 7265 7122 5d0a 2020 2020 6474 203d  "freq"].    dt =
+00016f60: 2070 6172 615b 2264 7422 5d0a 2020 2020   para["dt"].    
+00016f70: 666d 696e 203d 206e 702e 6d69 6e28 6672  fmin = np.min(fr
+00016f80: 6571 290a 2020 2020 666d 6178 203d 206e  eq).    fmax = n
+00016f90: 702e 6d61 7828 6672 6571 290a 0a20 2020  p.max(freq)..   
+00016fa0: 2023 2061 7070 6c79 2063 7774 206f 6e20   # apply cwt on 
+00016fb0: 7477 6f20 7472 6163 6573 0a20 2020 2063  two traces.    c
+00016fc0: 7774 312c 2073 6a2c 2066 7265 712c 2063  wt1, sj, freq, c
+00016fd0: 6f69 2c20 5f2c 205f 203d 2070 7963 7774  oi, _, _ = pycwt
+00016fe0: 2e63 7774 2863 7572 2c20 6474 2c20 646a  .cwt(cur, dt, dj
+00016ff0: 2c20 7330 2c20 4a2c 2077 766e 290a 2020  , s0, J, wvn).  
+00017000: 2020 6377 7432 2c20 736a 2c20 6672 6571    cwt2, sj, freq
+00017010: 2c20 636f 692c 205f 2c20 5f20 3d20 7079  , coi, _, _ = py
+00017020: 6377 742e 6377 7428 7265 662c 2064 742c  cwt.cwt(ref, dt,
+00017030: 2064 6a2c 2073 302c 204a 2c20 7776 6e29   dj, s0, J, wvn)
+00017040: 0a0a 2020 2020 2320 6578 7472 6163 7420  ..    # extract 
+00017050: 7265 616c 2076 616c 7565 7320 6f66 2063  real values of c
+00017060: 7774 0a20 2020 2072 6377 7431 2c20 7263  wt.    rcwt1, rc
+00017070: 7774 3220 3d20 6e70 2e72 6561 6c28 6377  wt2 = np.real(cw
+00017080: 7431 292c 206e 702e 7265 616c 2863 7774  t1), np.real(cwt
+00017090: 3229 0a0a 2020 2020 2320 7a65 726f 206f  2)..    # zero o
+000170a0: 7574 2064 6174 6120 6f75 7473 6964 6520  ut data outside 
+000170b0: 6672 6571 7565 6e63 7920 6261 6e64 0a20  frequency band. 
+000170c0: 2020 2069 6620 2866 6d61 7820 3e20 6e70     if (fmax > np
+000170d0: 2e6d 6178 2866 7265 7129 2920 7c20 2866  .max(freq)) | (f
+000170e0: 6d61 7820 3c3d 2066 6d69 6e29 3a0a 2020  max <= fmin):.  
+000170f0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00017100: 6545 7272 6f72 2822 4162 6f72 743a 2069  eError("Abort: i
+00017110: 6e70 7574 2066 7265 7175 656e 6379 206f  nput frequency o
+00017120: 7574 206f 6620 6c69 6d69 7473 2122 290a  ut of limits!").
+00017130: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00017140: 2020 6672 6571 5f69 6e64 696e 203d 206e    freq_indin = n
+00017150: 702e 7768 6572 6528 2866 7265 7120 3e3d  p.where((freq >=
+00017160: 2066 6d69 6e29 2026 2028 6672 6571 203c   fmin) & (freq <
+00017170: 3d20 666d 6178 2929 5b30 5d0a 0a20 2020  = fmax))[0]..   
+00017180: 2023 2063 6f6e 7665 7274 2077 6176 656c   # convert wavel
+00017190: 6574 2064 6f6d 6169 6e20 6261 636b 2074  et domain back t
+000171a0: 6f20 7469 6d65 2064 6f6d 6169 6e20 287e  o time domain (~
+000171b0: 6669 6c74 6572 696e 6729 0a20 2020 2069  filtering).    i
+000171c0: 6620 6e6f 7420 616c 6c66 7265 713a 0a20  f not allfreq:. 
+000171d0: 2020 2020 2020 2023 2069 6e76 6572 7365         # inverse
+000171e0: 2063 7774 2074 6f20 7469 6d65 2064 6f6d   cwt to time dom
+000171f0: 6169 6e0a 2020 2020 2020 2020 6963 7774  ain.        icwt
+00017200: 3120 3d20 7079 6377 742e 6963 7774 2863  1 = pycwt.icwt(c
+00017210: 7774 315b 6672 6571 5f69 6e64 696e 5d2c  wt1[freq_indin],
+00017220: 2073 6a5b 6672 6571 5f69 6e64 696e 5d2c   sj[freq_indin],
+00017230: 2064 742c 2064 6a2c 2077 766e 290a 2020   dt, dj, wvn).  
+00017240: 2020 2020 2020 6963 7774 3220 3d20 7079        icwt2 = py
+00017250: 6377 742e 6963 7774 2863 7774 325b 6672  cwt.icwt(cwt2[fr
+00017260: 6571 5f69 6e64 696e 5d2c 2073 6a5b 6672  eq_indin], sj[fr
+00017270: 6571 5f69 6e64 696e 5d2c 2064 742c 2064  eq_indin], dt, d
+00017280: 6a2c 2077 766e 290a 0a20 2020 2020 2020  j, wvn)..       
+00017290: 2023 2061 7373 756d 6520 616c 6c20 7469   # assume all ti
+000172a0: 6d65 2077 696e 646f 7720 6973 2075 7365  me window is use
+000172b0: 640a 2020 2020 2020 2020 7763 7774 312c  d.        wcwt1,
+000172c0: 2077 6377 7432 203d 206e 702e 7265 616c   wcwt2 = np.real
+000172d0: 2869 6377 7431 292c 206e 702e 7265 616c  (icwt1), np.real
+000172e0: 2869 6377 7432 290a 0a20 2020 2020 2020  (icwt2)..       
+000172f0: 2023 204e 6f72 6d61 6c69 7a65 7320 626f   # Normalizes bo
+00017300: 7468 2073 6967 6e61 6c73 2c20 6966 2061  th signals, if a
+00017310: 7070 726f 7072 6961 7465 2e0a 2020 2020  ppropriate..    
+00017320: 2020 2020 6966 206e 6f72 6d61 6c69 7a65      if normalize
+00017330: 3a0a 2020 2020 2020 2020 2020 2020 6e63  :.            nc
+00017340: 7774 3120 3d20 2877 6377 7431 202d 2077  wt1 = (wcwt1 - w
+00017350: 6377 7431 2e6d 6561 6e28 2929 202f 2077  cwt1.mean()) / w
+00017360: 6377 7431 2e73 7464 2829 0a20 2020 2020  cwt1.std().     
+00017370: 2020 2020 2020 206e 6377 7432 203d 2028         ncwt2 = (
+00017380: 7763 7774 3220 2d20 7763 7774 322e 6d65  wcwt2 - wcwt2.me
+00017390: 616e 2829 2920 2f20 7763 7774 322e 7374  an()) / wcwt2.st
+000173a0: 6428 290a 2020 2020 2020 2020 656c 7365  d().        else
+000173b0: 3a0a 2020 2020 2020 2020 2020 2020 6e63  :.            nc
+000173c0: 7774 3120 3d20 7763 7774 310a 2020 2020  wt1 = wcwt1.    
+000173d0: 2020 2020 2020 2020 6e63 7774 3220 3d20          ncwt2 = 
+000173e0: 7763 7774 320a 0a20 2020 2020 2020 2023  wcwt2..        #
+000173f0: 2072 756e 2073 7472 6574 6368 696e 670a   run stretching.
+00017400: 2020 2020 2020 2020 6476 762c 2065 7272          dvv, err
+00017410: 2c20 6363 2c20 6364 7020 3d20 7374 7265  , cc, cdp = stre
+00017420: 7463 6869 6e67 286e 6377 7432 2c20 6e63  tching(ncwt2, nc
+00017430: 7774 312c 2064 765f 7261 6e67 652c 206e  wt1, dv_range, n
+00017440: 6274 7269 616c 2c20 7061 7261 290a 2020  btrial, para).  
+00017450: 2020 2020 2020 7265 7475 726e 2064 7676        return dvv
+00017460: 2c20 6572 720a 0a20 2020 2023 2064 6972  , err..    # dir
+00017470: 6563 746c 7920 7461 6b65 2061 6476 616e  ectly take advan
+00017480: 7461 6765 206f 6620 7468 650a 2020 2020  tage of the.    
+00017490: 656c 7365 3a0a 2020 2020 2020 2020 2320  else:.        # 
+000174a0: 696e 6974 6961 6c69 7a65 2076 6172 6961  initialize varia
+000174b0: 626c 650a 2020 2020 2020 2020 6e66 7265  ble.        nfre
+000174c0: 7120 3d20 6c65 6e28 6672 6571 5f69 6e64  q = len(freq_ind
+000174d0: 696e 290a 2020 2020 2020 2020 6476 762c  in).        dvv,
+000174e0: 2063 632c 2063 6470 2c20 6572 7220 3d20   cc, cdp, err = 
+000174f0: 280a 2020 2020 2020 2020 2020 2020 6e70  (.            np
+00017500: 2e7a 6572 6f73 286e 6672 6571 2c20 6474  .zeros(nfreq, dt
+00017510: 7970 653d 6e70 2e66 6c6f 6174 3332 292c  ype=np.float32),
+00017520: 0a20 2020 2020 2020 2020 2020 206e 702e  .            np.
+00017530: 7a65 726f 7328 6e66 7265 712c 2064 7479  zeros(nfreq, dty
+00017540: 7065 3d6e 702e 666c 6f61 7433 3229 2c0a  pe=np.float32),.
+00017550: 2020 2020 2020 2020 2020 2020 6e70 2e7a              np.z
+00017560: 6572 6f73 286e 6672 6571 2c20 6474 7970  eros(nfreq, dtyp
+00017570: 653d 6e70 2e66 6c6f 6174 3332 292c 0a20  e=np.float32),. 
+00017580: 2020 2020 2020 2020 2020 206e 702e 7a65             np.ze
+00017590: 726f 7328 6e66 7265 712c 2064 7479 7065  ros(nfreq, dtype
+000175a0: 3d6e 702e 666c 6f61 7433 3229 2c0a 2020  =np.float32),.  
+000175b0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+000175c0: 2023 206c 6f6f 7020 7468 726f 7567 6820   # loop through 
+000175d0: 6561 6368 2066 7265 710a 2020 2020 2020  each freq.      
+000175e0: 2020 666f 7220 6969 2c20 6966 7265 7120    for ii, ifreq 
+000175f0: 696e 2065 6e75 6d65 7261 7465 2866 7265  in enumerate(fre
+00017600: 715f 696e 6469 6e29 3a0a 2020 2020 2020  q_indin):.      
+00017610: 2020 2020 2020 2320 7072 6570 6172 6520        # prepare 
+00017620: 7769 6e64 6f77 6564 2064 6174 610a 2020  windowed data.  
+00017630: 2020 2020 2020 2020 2020 7763 7774 312c            wcwt1,
+00017640: 2077 6377 7432 203d 2072 6377 7431 5b69   wcwt2 = rcwt1[i
+00017650: 6672 6571 5d2c 2072 6377 7432 5b69 6672  freq], rcwt2[ifr
+00017660: 6571 5d0a 0a20 2020 2020 2020 2020 2020  eq]..           
+00017670: 2023 204e 6f72 6d61 6c69 7a65 7320 626f   # Normalizes bo
+00017680: 7468 2073 6967 6e61 6c73 2c20 6966 2061  th signals, if a
+00017690: 7070 726f 7072 6961 7465 2e0a 2020 2020  ppropriate..    
+000176a0: 2020 2020 2020 2020 6966 206e 6f72 6d61          if norma
+000176b0: 6c69 7a65 3a0a 2020 2020 2020 2020 2020  lize:.          
+000176c0: 2020 2020 2020 6e63 7774 3120 3d20 2877        ncwt1 = (w
+000176d0: 6377 7431 202d 2077 6377 7431 2e6d 6561  cwt1 - wcwt1.mea
+000176e0: 6e28 2929 202f 2077 6377 7431 2e73 7464  n()) / wcwt1.std
+000176f0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00017700: 2020 206e 6377 7432 203d 2028 7763 7774     ncwt2 = (wcwt
+00017710: 3220 2d20 7763 7774 322e 6d65 616e 2829  2 - wcwt2.mean()
+00017720: 2920 2f20 7763 7774 322e 7374 6428 290a  ) / wcwt2.std().
+00017730: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00017740: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017750: 2020 6e63 7774 3120 3d20 7763 7774 310a    ncwt1 = wcwt1.
+00017760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017770: 6e63 7774 3220 3d20 7763 7774 320a 0a20  ncwt2 = wcwt2.. 
+00017780: 2020 2020 2020 2020 2020 2023 2072 756e             # run
+00017790: 2073 7472 6574 6368 696e 670a 2020 2020   stretching.    
+000177a0: 2020 2020 2020 2020 6476 2c20 6572 726f          dv, erro
+000177b0: 722c 2063 312c 2063 3220 3d20 7374 7265  r, c1, c2 = stre
+000177c0: 7463 6869 6e67 286e 6377 7432 2c20 6e63  tching(ncwt2, nc
+000177d0: 7774 312c 2064 765f 7261 6e67 652c 206e  wt1, dv_range, n
+000177e0: 6274 7269 616c 2c20 7061 7261 290a 2020  btrial, para).  
+000177f0: 2020 2020 2020 2020 2020 6476 765b 6969            dvv[ii
+00017800: 5d2c 2063 635b 6969 5d2c 2063 6470 5b69  ], cc[ii], cdp[i
+00017810: 695d 2c20 6572 725b 6969 5d20 3d20 6476  i], err[ii] = dv
+00017820: 2c20 6331 2c20 6332 2c20 6572 726f 720a  , c1, c2, error.
+00017830: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00017840: 6672 6571 5b66 7265 715f 696e 6469 6e5d  freq[freq_indin]
+00017850: 2c20 6476 762c 2065 7272 0a0a 0a64 6566  , dvv, err...def
+00017860: 2077 7464 7477 5f61 6c6c 6672 6571 280a   wtdtw_allfreq(.
+00017870: 2020 2020 7265 662c 0a20 2020 2063 7572      ref,.    cur
+00017880: 2c0a 2020 2020 616c 6c66 7265 712c 0a20  ,.    allfreq,. 
+00017890: 2020 2070 6172 612c 0a20 2020 206d 6178     para,.    max
+000178a0: 4c61 672c 0a20 2020 2062 2c0a 2020 2020  Lag,.    b,.    
+000178b0: 6469 7265 6374 696f 6e2c 0a20 2020 2064  direction,.    d
+000178c0: 6a3d 3120 2f20 3132 2c0a 2020 2020 7330  j=1 / 12,.    s0
+000178d0: 3d2d 312c 0a20 2020 204a 3d2d 312c 0a20  =-1,.    J=-1,. 
+000178e0: 2020 2077 766e 3d22 6d6f 726c 6574 222c     wvn="morlet",
+000178f0: 0a20 2020 206e 6f72 6d61 6c69 7a65 3d54  .    normalize=T
+00017900: 7275 652c 0a29 3a0a 2020 2020 2222 220a  rue,.):.    """.
+00017910: 2020 2020 4170 706c 7920 6479 6e61 6d69      Apply dynami
+00017920: 6320 7469 6d65 2077 6172 7069 6e67 206d  c time warping m
+00017930: 6574 686f 6420 746f 2063 6f6e 7469 6e75  ethod to continu
+00017940: 6f75 7320 7761 7665 6c65 7420 7472 616e  ous wavelet tran
+00017950: 7366 6f72 6d61 7469 6f6e 2028 4357 5429  sformation (CWT)
+00017960: 206f 6620 7369 676e 616c 730a 2020 2020   of signals.    
+00017970: 666f 7220 616c 6c20 6672 6571 7565 6369  for all frequeci
+00017980: 6573 2069 6e20 616e 2069 6e74 6572 6573  es in an interes
+00017990: 7420 7261 6e67 650a 0a20 2020 2050 6172  t range..    Par
+000179a0: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+000179b0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2072  ----------.    r
+000179c0: 6566 3a20 5468 6520 2252 6566 6572 656e  ef: The "Referen
+000179d0: 6365 2220 7469 6d65 7365 7269 6573 2028  ce" timeseries (
+000179e0: 6e75 6d70 792e 6e64 6172 7261 7929 0a20  numpy.ndarray). 
+000179f0: 2020 2063 7572 3a20 5468 6520 2243 7572     cur: The "Cur
+00017a00: 7265 6e74 2220 7469 6d65 7365 7269 6573  rent" timeseries
+00017a10: 2028 6e75 6d70 792e 6e64 6172 7261 7929   (numpy.ndarray)
+00017a20: 0a20 2020 2061 6c6c 6672 6571 3a20 6120  .    allfreq: a 
+00017a30: 626f 6f6c 656e 2076 6172 6961 626c 6520  boolen variable 
+00017a40: 746f 206d 616b 6520 6d65 6173 7572 656d  to make measurem
+00017a50: 656e 7473 206f 6e20 616c 6c20 6672 6571  ents on all freq
+00017a60: 7565 6e63 7920 7261 6e67 6520 6f72 206e  uency range or n
+00017a70: 6f74 0a20 2020 206d 6178 4c61 673a 206d  ot.    maxLag: m
+00017a80: 6178 206e 756d 6265 7220 6f66 2070 6f69  ax number of poi
+00017a90: 6e74 7320 746f 2073 6561 7263 6820 666f  nts to search fo
+00017aa0: 7277 6172 6420 616e 6420 6261 636b 7761  rward and backwa
+00017ab0: 7264 2e0a 2020 2020 623a 2062 2d76 616c  rd..    b: b-val
+00017ac0: 7565 2074 6f20 6c69 6d69 7420 7374 7261  ue to limit stra
+00017ad0: 696e 2c20 7768 6963 6820 6973 2074 6f20  in, which is to 
+00017ae0: 6c69 6d69 7420 7468 6520 6d61 7869 6d75  limit the maximu
+00017af0: 6d20 7665 6c6f 6369 7479 2070 6572 7475  m velocity pertu
+00017b00: 7262 6174 696f 6e2e 0a20 2020 2053 6565  rbation..    See
+00017b10: 2065 7175 6174 696f 6e20 3131 2069 6e20   equation 11 in 
+00017b20: 284d 696b 6573 656c 6c20 6574 2061 6c2e  (Mikesell et al.
+00017b30: 2032 3031 3529 0a20 2020 2064 6972 6563   2015).    direc
+00017b40: 7469 6f6e 3a20 6469 7265 6374 696f 6e20  tion: direction 
+00017b50: 746f 2061 6363 756d 756c 6174 6520 6572  to accumulate er
+00017b60: 726f 7273 2028 313d 666f 7277 6172 642c  rors (1=forward,
+00017b70: 202d 313d 6261 636b 7761 7264 290a 2020   -1=backward).  
+00017b80: 2020 646a 2c20 7330 2c20 4a2c 2073 6967    dj, s0, J, sig
+00017b90: 2c20 7776 6e3a 2063 6f6d 6d6f 6e20 7061  , wvn: common pa
+00017ba0: 7261 6d65 7465 7273 2075 7365 6420 696e  rameters used in
+00017bb0: 2027 7761 7665 6c65 742e 7763 7427 0a20   'wavelet.wct'. 
+00017bc0: 2020 206e 6f72 6d61 6c69 7a65 3a20 6e6f     normalize: no
+00017bd0: 726d 616c 697a 6520 7468 6520 7761 7665  rmalize the wave
+00017be0: 6c65 7420 7370 6563 7472 756d 206f 7220  let spectrum or 
+00017bf0: 6e6f 742e 2044 6566 6175 6c74 2069 7320  not. Default is 
+00017c00: 5472 7565 0a0a 2020 2020 5245 5455 524e  True..    RETURN
+00017c10: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
+00017c20: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6476  ---------.    dv
+00017c30: 763a 2065 7374 696d 6174 6564 2064 762f  v: estimated dv/
+00017c40: 760a 2020 2020 6572 723a 2065 7272 6f72  v.    err: error
+00017c50: 206f 6620 6476 2f76 2065 7374 696d 6174   of dv/v estimat
+00017c60: 696f 6e0a 0a20 2020 2057 7269 7474 656e  ion..    Written
+00017c70: 2062 7920 436f 6e67 636f 6e67 2059 7561   by Congcong Yua
+00017c80: 6e20 2833 3020 4a75 6e2c 2032 3031 3929  n (30 Jun, 2019)
+00017c90: 0a20 2020 2022 2222 0a20 2020 2023 2063  .    """.    # c
+00017ca0: 6f6d 6d6f 6e20 7661 7269 6162 6c65 730a  ommon variables.
+00017cb0: 2020 2020 6672 6571 203d 2070 6172 615b      freq = para[
+00017cc0: 2266 7265 7122 5d0a 2020 2020 6474 203d  "freq"].    dt =
+00017cd0: 2070 6172 615b 2264 7422 5d0a 2020 2020   para["dt"].    
+00017ce0: 666d 696e 203d 206e 702e 6d69 6e28 6672  fmin = np.min(fr
+00017cf0: 6571 290a 2020 2020 666d 6178 203d 206e  eq).    fmax = n
+00017d00: 702e 6d61 7828 6672 6571 290a 0a20 2020  p.max(freq)..   
+00017d10: 2023 2061 7070 6c79 2063 7774 206f 6e20   # apply cwt on 
+00017d20: 7477 6f20 7472 6163 6573 0a20 2020 2063  two traces.    c
+00017d30: 7774 312c 2073 6a2c 2066 7265 712c 2063  wt1, sj, freq, c
+00017d40: 6f69 2c20 5f2c 205f 203d 2070 7963 7774  oi, _, _ = pycwt
+00017d50: 2e63 7774 2863 7572 2c20 6474 2c20 646a  .cwt(cur, dt, dj
+00017d60: 2c20 7330 2c20 4a2c 2077 766e 290a 2020  , s0, J, wvn).  
+00017d70: 2020 6377 7432 2c20 736a 2c20 6672 6571    cwt2, sj, freq
+00017d80: 2c20 636f 692c 205f 2c20 5f20 3d20 7079  , coi, _, _ = py
+00017d90: 6377 742e 6377 7428 7265 662c 2064 742c  cwt.cwt(ref, dt,
+00017da0: 2064 6a2c 2073 302c 204a 2c20 7776 6e29   dj, s0, J, wvn)
+00017db0: 0a0a 2020 2020 2320 6578 7472 6163 7420  ..    # extract 
+00017dc0: 7265 616c 2076 616c 7565 7320 6f66 2063  real values of c
+00017dd0: 7774 0a20 2020 2072 6377 7431 2c20 7263  wt.    rcwt1, rc
+00017de0: 7774 3220 3d20 6e70 2e72 6561 6c28 6377  wt2 = np.real(cw
+00017df0: 7431 292c 206e 702e 7265 616c 2863 7774  t1), np.real(cwt
+00017e00: 3229 0a0a 2020 2020 2320 7a65 726f 206f  2)..    # zero o
+00017e10: 7574 2063 6f6e 6520 6f66 2069 6e66 6c75  ut cone of influ
+00017e20: 656e 6365 2061 6e64 2064 6174 6120 6f75  ence and data ou
+00017e30: 7473 6964 6520 6672 6571 7565 6e63 7920  tside frequency 
+00017e40: 6261 6e64 0a20 2020 2069 6620 2866 6d61  band.    if (fma
+00017e50: 7820 3e20 6e70 2e6d 6178 2866 7265 7129  x > np.max(freq)
+00017e60: 2920 7c20 2866 6d61 7820 3c3d 2066 6d69  ) | (fmax <= fmi
+00017e70: 6e29 3a0a 2020 2020 2020 2020 7261 6973  n):.        rais
+00017e80: 6520 5661 6c75 6545 7272 6f72 2822 4162  e ValueError("Ab
+00017e90: 6f72 743a 2069 6e70 7574 2066 7265 7175  ort: input frequ
+00017ea0: 656e 6379 206f 7574 206f 6620 6c69 6d69  ency out of limi
+00017eb0: 7473 2122 290a 2020 2020 656c 7365 3a0a  ts!").    else:.
+00017ec0: 2020 2020 2020 2020 6672 6571 5f69 6e64          freq_ind
+00017ed0: 696e 203d 206e 702e 7768 6572 6528 2866  in = np.where((f
+00017ee0: 7265 7120 3e3d 2066 6d69 6e29 2026 2028  req >= fmin) & (
+00017ef0: 6672 6571 203c 3d20 666d 6178 2929 5b30  freq <= fmax))[0
+00017f00: 5d0a 0a20 2020 2020 2020 2023 2055 7365  ]..        # Use
+00017f10: 2044 5457 206d 6574 686f 6420 746f 2065   DTW method to e
+00017f20: 7874 7261 6374 2064 7676 0a20 2020 2020  xtract dvv.     
+00017f30: 2020 206e 6672 6571 203d 206c 656e 2866     nfreq = len(f
+00017f40: 7265 715f 696e 6469 6e29 0a20 2020 2020  req_indin).     
+00017f50: 2020 2064 7676 2c20 6572 7220 3d20 6e70     dvv, err = np
+00017f60: 2e7a 6572 6f73 286e 6672 6571 2c20 6474  .zeros(nfreq, dt
+00017f70: 7970 653d 6e70 2e66 6c6f 6174 3332 292c  ype=np.float32),
+00017f80: 206e 702e 7a65 726f 7328 6e66 7265 712c   np.zeros(nfreq,
+00017f90: 2064 7479 7065 3d6e 702e 666c 6f61 7433   dtype=np.float3
+00017fa0: 3229 0a0a 2020 2020 2020 2020 666f 7220  2)..        for 
+00017fb0: 6969 2c20 6966 7265 7120 696e 2065 6e75  ii, ifreq in enu
+00017fc0: 6d65 7261 7465 2866 7265 715f 696e 6469  merate(freq_indi
+00017fd0: 6e29 3a0a 2020 2020 2020 2020 2020 2020  n):.            
+00017fe0: 2320 7072 6570 6172 6520 7769 6e64 6f77  # prepare window
+00017ff0: 6564 2064 6174 610a 2020 2020 2020 2020  ed data.        
+00018000: 2020 2020 7763 7774 312c 2077 6377 7432      wcwt1, wcwt2
+00018010: 203d 2072 6377 7431 5b69 6672 6571 5d2c   = rcwt1[ifreq],
+00018020: 2072 6377 7432 5b69 6672 6571 5d0a 2020   rcwt2[ifreq].  
+00018030: 2020 2020 2020 2020 2020 2320 4e6f 726d            # Norm
+00018040: 616c 697a 6573 2062 6f74 6820 7369 676e  alizes both sign
+00018050: 616c 732c 2069 6620 6170 7072 6f70 7269  als, if appropri
+00018060: 6174 652e 0a20 2020 2020 2020 2020 2020  ate..           
+00018070: 2069 6620 6e6f 726d 616c 697a 653a 0a20   if normalize:. 
+00018080: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00018090: 6377 7431 203d 2028 7763 7774 3120 2d20  cwt1 = (wcwt1 - 
+000180a0: 7763 7774 312e 6d65 616e 2829 2920 2f20  wcwt1.mean()) / 
+000180b0: 7763 7774 312e 7374 6428 290a 2020 2020  wcwt1.std().    
+000180c0: 2020 2020 2020 2020 2020 2020 6e63 7774              ncwt
+000180d0: 3220 3d20 2877 6377 7432 202d 2077 6377  2 = (wcwt2 - wcw
+000180e0: 7432 2e6d 6561 6e28 2929 202f 2077 6377  t2.mean()) / wcw
+000180f0: 7432 2e73 7464 2829 0a20 2020 2020 2020  t2.std().       
+00018100: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00018110: 2020 2020 2020 2020 2020 206e 6377 7431             ncwt1
+00018120: 203d 2077 6377 7431 0a20 2020 2020 2020   = wcwt1.       
+00018130: 2020 2020 2020 2020 206e 6377 7432 203d           ncwt2 =
+00018140: 2077 6377 7432 0a0a 2020 2020 2020 2020   wcwt2..        
+00018150: 2020 2020 2320 7275 6e20 6474 770a 2020      # run dtw.  
+00018160: 2020 2020 2020 2020 2020 6476 2c20 6572            dv, er
+00018170: 726f 722c 2064 6973 7420 3d20 6474 775f  ror, dist = dtw_
+00018180: 6476 7628 6e63 7774 322c 206e 6377 7431  dvv(ncwt2, ncwt1
+00018190: 2c20 7061 7261 2c20 6d61 784c 6167 2c20  , para, maxLag, 
+000181a0: 622c 2064 6972 6563 7469 6f6e 290a 2020  b, direction).  
+000181b0: 2020 2020 2020 2020 2020 6476 765b 6969            dvv[ii
+000181c0: 5d2c 2065 7272 5b69 695d 203d 2064 762c  ], err[ii] = dv,
+000181d0: 2065 7272 6f72 0a0a 2020 2020 6465 6c20   error..    del 
+000181e0: 6377 7431 2c20 6377 7432 2c20 7263 7774  cwt1, cwt2, rcwt
+000181f0: 312c 2072 6377 7432 2c20 6e63 7774 312c  1, rcwt2, ncwt1,
+00018200: 206e 6377 7432 2c20 7763 7774 312c 2077   ncwt2, wcwt1, w
+00018210: 6377 7432 2c20 636f 692c 2073 6a2c 2064  cwt2, coi, sj, d
+00018220: 6973 740a 0a20 2020 2069 6620 6e6f 7420  ist..    if not 
+00018230: 616c 6c66 7265 713a 0a20 2020 2020 2020  allfreq:.       
+00018240: 2072 6574 7572 6e20 6e70 2e6d 6561 6e28   return np.mean(
+00018250: 6476 7629 2c20 6e70 2e6d 6561 6e28 6572  dvv), np.mean(er
+00018260: 7229 0a20 2020 2065 6c73 653a 0a20 2020  r).    else:.   
+00018270: 2020 2020 2072 6574 7572 6e20 6672 6571       return freq
+00018280: 5b66 7265 715f 696e 6469 6e5d 2c20 6476  [freq_indin], dv
+00018290: 762c 2065 7272 0a0a 0a23 2323 2323 2323  v, err...#######
+000182a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000182b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000182c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000182d0: 2323 2323 2323 0a23 2323 2323 2323 2323  ######.#########
+000182e0: 2323 2323 2323 2320 4d4f 4e49 544f 5249  ####### MONITORI
+000182f0: 4e47 2055 5449 4c49 5459 2046 554e 4354  NG UTILITY FUNCT
+00018300: 494f 4e53 2023 2323 2323 2323 2323 2323  IONS ###########
+00018310: 2323 2323 0a23 2323 2323 2323 2323 2323  ####.###########
+00018320: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00018330: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00018340: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00018350: 2323 0a0a 2222 220a 6265 6c6f 7720 6172  ##..""".below ar
+00018360: 6520 6173 7365 6d62 6c79 206f 6620 7468  e assembly of th
+00018370: 6520 6d6f 6e69 746f 7269 6e67 2075 7469  e monitoring uti
+00018380: 6c69 7479 2066 756e 6374 696f 6e73 2063  lity functions c
+00018390: 616c 6c65 6420 6279 206d 6f6e 6974 6f72  alled by monitor
+000183a0: 696e 6720 6675 6e63 7469 6f6e 730a 2222  ing functions.""
+000183b0: 220a 0a0a 6465 6620 736d 6f6f 7468 2878  "...def smooth(x
+000183c0: 2c20 7769 6e64 6f77 3d22 626f 7863 6172  , window="boxcar
+000183d0: 222c 2068 616c 665f 7769 6e3d 3329 3a0a  ", half_win=3):.
+000183e0: 2020 2020 2222 220a 2020 2020 7065 7266      """.    perf
+000183f0: 6f72 6d73 2073 6d6f 6f74 6869 6e67 2069  orms smoothing i
+00018400: 6e20 696e 7465 7265 7374 6564 2074 696d  n interested tim
+00018410: 6520 7769 6e64 6f77 0a0a 2020 2020 5061  e window..    Pa
+00018420: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00018430: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
+00018440: 783a 2074 696d 6573 6572 6973 2064 6174  x: timeseris dat
+00018450: 610a 2020 2020 7769 6e64 6f77 3a20 7479  a.    window: ty
+00018460: 7065 7320 6f66 2077 696e 646f 7720 746f  pes of window to
+00018470: 2064 6f20 736d 6f6f 7468 696e 670a 2020   do smoothing.  
+00018480: 2020 6861 6c66 5f77 696e 3a20 6861 6c66    half_win: half
+00018490: 2077 696e 646f 7720 6c65 6e67 7468 0a0a   window length..
+000184a0: 2020 2020 5245 5455 524e 533a 0a20 2020      RETURNS:.   
+000184b0: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
+000184c0: 2d2d 2d0a 2020 2020 793a 2073 6d6f 6f74  ---.    y: smoot
+000184d0: 6865 6420 7469 6d65 2077 696e 646f 770a  hed time window.
+000184e0: 2020 2020 2222 220a 2020 2020 2320 544f      """.    # TO
+000184f0: 444f 3a20 646f 6373 7469 6e67 0a20 2020  DO: docsting.   
+00018500: 2077 696e 646f 775f 6c65 6e20 3d20 3220   window_len = 2 
+00018510: 2a20 6861 6c66 5f77 696e 202b 2031 0a20  * half_win + 1. 
+00018520: 2020 2023 2065 7874 656e 6469 6e67 2074     # extending t
+00018530: 6865 2064 6174 6120 6174 2062 6567 696e  he data at begin
+00018540: 6e69 6e67 2061 6e64 2061 7420 7468 6520  ning and at the 
+00018550: 656e 640a 2020 2020 2320 746f 2061 7070  end.    # to app
+00018560: 6c79 2074 6865 2077 696e 646f 7720 6174  ly the window at
+00018570: 2074 6865 2062 6f72 6465 7273 0a20 2020   the borders.   
+00018580: 2073 203d 206e 702e 725f 5b78 5b77 696e   s = np.r_[x[win
+00018590: 646f 775f 6c65 6e20 2d20 3120 3a20 3020  dow_len - 1 : 0 
+000185a0: 3a20 2d31 5d2c 2078 2c20 785b 2d31 3a2d  : -1], x, x[-1:-
+000185b0: 7769 6e64 6f77 5f6c 656e 3a2d 315d 5d0a  window_len:-1]].
+000185c0: 2020 2020 6966 2077 696e 646f 7720 3d3d      if window ==
+000185d0: 2022 626f 7863 6172 223a 0a20 2020 2020   "boxcar":.     
+000185e0: 2020 2077 203d 2073 6369 7079 2e73 6967     w = scipy.sig
+000185f0: 6e61 6c2e 626f 7863 6172 2877 696e 646f  nal.boxcar(windo
+00018600: 775f 6c65 6e29 2e61 7374 7970 6528 2263  w_len).astype("c
+00018610: 6f6d 706c 6578 2229 0a20 2020 2065 6c73  omplex").    els
+00018620: 653a 0a20 2020 2020 2020 2077 203d 2073  e:.        w = s
+00018630: 6369 7079 2e73 6967 6e61 6c2e 6861 6e6e  cipy.signal.hann
+00018640: 696e 6728 7769 6e64 6f77 5f6c 656e 292e  ing(window_len).
+00018650: 6173 7479 7065 2822 636f 6d70 6c65 7822  astype("complex"
+00018660: 290a 2020 2020 7920 3d20 6e70 2e63 6f6e  ).    y = np.con
+00018670: 766f 6c76 6528 7720 2f20 772e 7375 6d28  volve(w / w.sum(
+00018680: 292c 2073 2c20 6d6f 6465 3d22 7661 6c69  ), s, mode="vali
+00018690: 6422 290a 2020 2020 7265 7475 726e 2079  d").    return y
+000186a0: 5b68 616c 665f 7769 6e20 3a20 6c65 6e28  [half_win : len(
+000186b0: 7929 202d 2068 616c 665f 7769 6e5d 0a0a  y) - half_win]..
+000186c0: 0a64 6566 206e 6578 7470 6f77 3228 7829  .def nextpow2(x)
+000186d0: 3a0a 2020 2020 2222 220a 2020 2020 5265  :.    """.    Re
+000186e0: 7475 726e 7320 7468 6520 6e65 7874 2070  turns the next p
+000186f0: 6f77 6572 206f 6620 3220 6f66 2078 2e0a  ower of 2 of x..
+00018700: 2020 2020 2222 220a 2020 2020 7265 7475      """.    retu
+00018710: 726e 2069 6e74 286e 702e 6365 696c 286e  rn int(np.ceil(n
+00018720: 702e 6c6f 6732 286e 702e 6162 7328 7829  p.log2(np.abs(x)
+00018730: 2929 290a 0a0a 6465 6620 6765 7443 6f68  )))...def getCoh
+00018740: 6572 656e 6365 2864 6373 2c20 6473 312c  erence(dcs, ds1,
+00018750: 2064 7332 293a 0a20 2020 2022 2222 0a20   ds2):.    """. 
+00018760: 2020 2067 6574 2063 726f 7373 2063 6f68     get cross coh
+00018770: 6572 656e 6365 2062 6574 7765 656e 2072  erence between r
+00018780: 6566 6572 656e 6365 2061 6e64 2063 7572  eference and cur
+00018790: 7265 6e74 2077 6176 6566 6f72 6d73 2066  rent waveforms f
+000187a0: 6f6c 6c6f 7769 6e67 2065 7175 6174 696f  ollowing equatio
+000187b0: 6e20 6f66 2041 3320 696e 2043 6c61 726b  n of A3 in Clark
+000187c0: 2065 7420 616c 2e2c 2032 3031 310a 0a20   et al., 2011.. 
+000187d0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+000187e0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
+000187f0: 0a20 2020 2064 6373 3a20 616d 706c 6974  .    dcs: amplit
+00018800: 7564 6520 6f66 2074 6865 2063 726f 7373  ude of the cross
+00018810: 2073 7065 6374 7275 6d0a 2020 2020 6473   spectrum.    ds
+00018820: 313a 2061 6d70 6c69 7475 6465 206f 6620  1: amplitude of 
+00018830: 7468 6520 7370 6563 7472 756d 206f 6620  the spectrum of 
+00018840: 6375 7272 656e 7420 7761 7665 666f 726d  current waveform
+00018850: 0a20 2020 2064 7332 3a20 616d 706c 6974  .    ds2: amplit
+00018860: 7564 6520 6f66 2074 6865 2073 7065 6374  ude of the spect
+00018870: 7275 6d20 6f66 2072 6566 6572 656e 6365  rum of reference
+00018880: 2077 6176 6566 6f72 6d0a 0a20 2020 2052   waveform..    R
+00018890: 4554 5552 4e53 3a0a 2020 2020 2d2d 2d2d  ETURNS:.    ----
+000188a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
+000188b0: 2020 2063 6f68 3a20 636f 6872 6572 656e     coh: cohreren
+000188c0: 6379 206d 6174 7269 7820 7573 6564 2066  cy matrix used f
+000188d0: 6f72 2065 7374 696d 6174 6520 7468 6520  or estimate the 
+000188e0: 726f 6275 7374 6e65 7373 206f 6620 7468  robustness of th
+000188f0: 6520 6372 6f73 7320 7370 6563 7472 756d  e cross spectrum
+00018900: 0a20 2020 2022 2222 0a20 2020 206e 203d  .    """.    n =
+00018910: 206c 656e 2864 6373 290a 2020 2020 636f   len(dcs).    co
+00018920: 6820 3d20 6e70 2e7a 6572 6f73 286e 292e  h = np.zeros(n).
+00018930: 6173 7479 7065 2822 636f 6d70 6c65 7822  astype("complex"
+00018940: 290a 2020 2020 7661 6c69 6473 203d 206e  ).    valids = n
+00018950: 702e 6172 6777 6865 7265 286e 702e 6c6f  p.argwhere(np.lo
+00018960: 6769 6361 6c5f 616e 6428 6e70 2e61 6273  gical_and(np.abs
+00018970: 2864 7331 2920 3e20 302c 206e 702e 6162  (ds1) > 0, np.ab
+00018980: 7328 6473 3229 203e 2030 2929 0a20 2020  s(ds2) > 0)).   
+00018990: 2063 6f68 5b76 616c 6964 735d 203d 2064   coh[valids] = d
+000189a0: 6373 5b76 616c 6964 735d 202f 2028 6473  cs[valids] / (ds
+000189b0: 315b 7661 6c69 6473 5d20 2a20 6473 325b  1[valids] * ds2[
+000189c0: 7661 6c69 6473 5d29 0a20 2020 2063 6f68  valids]).    coh
+000189d0: 5b63 6f68 203e 2028 312e 3020 2b20 306a  [coh > (1.0 + 0j
+000189e0: 295d 203d 2031 2e30 202b 2030 6a0a 2020  )] = 1.0 + 0j.  
+000189f0: 2020 7265 7475 726e 2063 6f68 0a0a 0a64    return coh...d
+00018a00: 6566 2063 6f6d 7075 7465 4572 726f 7246  ef computeErrorF
+00018a10: 756e 6374 696f 6e28 7531 2c20 7530 2c20  unction(u1, u0, 
+00018a20: 6e53 616d 706c 652c 206c 6167 2c20 6e6f  nSample, lag, no
+00018a30: 726d 3d22 4c32 2229 3a0a 2020 2020 2222  rm="L2"):.    ""
+00018a40: 220a 2020 2020 636f 6d70 7574 6520 4572  ".    compute Er
+00018a50: 726f 7220 4675 6e63 7469 6f6e 2075 7365  ror Function use
+00018a60: 6420 696e 2044 5457 2e20 5468 6520 6572  d in DTW. The er
+00018a70: 726f 7220 6675 6e63 7469 6f6e 2069 7320  ror function is 
+00018a80: 6571 7561 7469 6f6e 2031 2069 6e20 4861  equation 1 in Ha
+00018a90: 6c65 2c20 3230 3133 2e20 596f 7520 636f  le, 2013. You co
+00018aa0: 756c 6420 756e 636f 6d6d 656e 7420 7468  uld uncomment th
+00018ab0: 650a 2020 2020 4c31 206e 6f72 6d20 616e  e.    L1 norm an
+00018ac0: 6420 636f 6d6d 656e 7420 7468 6520 4c32  d comment the L2
+00018ad0: 206e 6f72 6d20 6966 2079 6f75 2077 616e   norm if you wan
+00018ae0: 7420 6f6e 204c 696e 6520 3239 0a0a 2020  t on Line 29..  
+00018af0: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00018b00: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a   --------------.
+00018b10: 2020 2020 7531 3a20 2074 7261 6365 2074      u1:  trace t
+00018b20: 6861 7420 7765 2077 616e 7420 746f 2077  hat we want to w
+00018b30: 6172 703b 2073 697a 6520 3d20 286e 7361  arp; size = (nsa
+00018b40: 6d70 2c31 290a 2020 2020 7530 3a20 2072  mp,1).    u0:  r
+00018b50: 6566 6572 656e 6365 2074 7261 6365 2074  eference trace t
+00018b60: 6f20 636f 6d70 6172 6520 7769 7468 3a20  o compare with: 
+00018b70: 7369 7a65 203d 2028 6e73 616d 702c 3129  size = (nsamp,1)
+00018b80: 0a20 2020 206e 5361 6d70 6c65 3a20 6e75  .    nSample: nu
+00018b90: 6d65 7220 6f66 2070 6f69 6e74 7320 746f  mer of points to
+00018ba0: 2063 6f6d 7061 7265 2069 6e20 7468 6520   compare in the 
+00018bb0: 7472 6163 6573 0a20 2020 206c 6167 3a20  traces.    lag: 
+00018bc0: 6d61 7869 6d75 6d20 6c61 6720 696e 2073  maximum lag in s
+00018bd0: 616d 706c 6520 6e75 6d62 6572 2074 6f20  ample number to 
+00018be0: 7365 6172 6368 0a20 2020 206e 6f72 6d3a  search.    norm:
+00018bf0: 2027 4c32 2720 6f72 2027 4c31 2720 2864   'L2' or 'L1' (d
+00018c00: 6566 6175 6c74 2069 7320 274c 3227 290a  efault is 'L2').
+00018c10: 0a20 2020 2052 4554 5552 4e53 3a0a 2020  .    RETURNS:.  
+00018c20: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
+00018c30: 2d2d 2d2d 0a20 2020 2065 7272 3a20 7468  ----.    err: th
+00018c40: 6520 3244 2065 7272 6f72 2066 756e 6374  e 2D error funct
+00018c50: 696f 6e3b 2073 697a 6520 3d20 286e 7361  ion; size = (nsa
+00018c60: 6d70 2c32 2a6c 6167 2b31 290a 0a20 2020  mp,2*lag+1)..   
+00018c70: 204f 7269 6769 6e61 6c20 6279 2044 6920   Original by Di 
+00018c80: 5961 6e67 0a20 2020 204c 6173 7420 6d6f  Yang.    Last mo
+00018c90: 6469 6669 6564 2062 7920 4479 6c61 6e20  dified by Dylan 
+00018ca0: 4d69 6b65 7365 6c6c 2028 3235 2046 6562  Mikesell (25 Feb
+00018cb0: 2e20 3230 3135 290a 2020 2020 5472 616e  . 2015).    Tran
+00018cc0: 736c 6174 6564 2074 6f20 7079 7468 6f6e  slated to python
+00018cd0: 2062 7920 5469 6d20 436c 656d 656e 7473   by Tim Clements
+00018ce0: 2028 3137 2041 7567 2e20 3230 3138 290a   (17 Aug. 2018).
+00018cf0: 0a20 2020 2022 2222 0a0a 2020 2020 6966  .    """..    if
+00018d00: 206c 6167 203e 3d20 6e53 616d 706c 653a   lag >= nSample:
+00018d10: 0a20 2020 2020 2020 2072 6169 7365 2056  .        raise V
+00018d20: 616c 7565 4572 726f 7228 2263 6f6d 7075  alueError("compu
+00018d30: 7465 4572 726f 7246 756e 6374 696f 6e3a  teErrorFunction:
+00018d40: 6c61 6750 726f 626c 656d 222c 2022 6c61  lagProblem", "la
+00018d50: 6720 6d75 7374 2062 6520 736d 616c 6c65  g must be smalle
+00018d60: 7220 7468 616e 206e 5361 6d70 6c65 2229  r than nSample")
+00018d70: 0a0a 2020 2020 2320 416c 6c6f 6361 7465  ..    # Allocate
+00018d80: 2065 7272 6f72 2066 756e 6374 696f 6e20   error function 
+00018d90: 7661 7269 6162 6c65 0a20 2020 2065 7272  variable.    err
+00018da0: 203d 206e 702e 7a65 726f 7328 5b6e 5361   = np.zeros([nSa
+00018db0: 6d70 6c65 2c20 3220 2a20 6c61 6720 2b20  mple, 2 * lag + 
+00018dc0: 315d 290a 0a20 2020 2023 2069 6e69 7469  1])..    # initi
+00018dd0: 616c 2065 7272 6f72 2063 616c 6375 6c61  al error calcula
+00018de0: 7469 6f6e 0a20 2020 2023 206c 6f6f 7020  tion.    # loop 
+00018df0: 6f76 6572 206c 6167 730a 2020 2020 666f  over lags.    fo
+00018e00: 7220 6c6c 2069 6e20 6e70 2e61 7261 6e67  r ll in np.arang
+00018e10: 6528 2d6c 6167 2c20 6c61 6720 2b20 3129  e(-lag, lag + 1)
+00018e20: 3a0a 2020 2020 2020 2020 7468 6973 4c61  :.        thisLa
+00018e30: 6720 3d20 6c6c 202b 206c 6167 0a0a 2020  g = ll + lag..  
+00018e40: 2020 2020 2020 2320 6c6f 6f70 206f 7665        # loop ove
+00018e50: 7220 7361 6d70 6c65 730a 2020 2020 2020  r samples.      
+00018e60: 2020 666f 7220 6969 2069 6e20 7261 6e67    for ii in rang
+00018e70: 6528 6e53 616d 706c 6529 3a0a 2020 2020  e(nSample):.    
+00018e80: 2020 2020 2020 2020 2320 736b 6970 2063          # skip c
+00018e90: 6f72 6e65 7273 2066 6f72 206e 6f77 2c20  orners for now, 
+00018ea0: 7765 2077 696c 6c20 636f 6d65 2062 6163  we will come bac
+00018eb0: 6b20 746f 2074 6865 7365 0a20 2020 2020  k to these.     
+00018ec0: 2020 2020 2020 2069 6620 2869 6920 2b20         if (ii + 
+00018ed0: 6c6c 203e 3d20 3029 2026 2028 6969 202b  ll >= 0) & (ii +
+00018ee0: 206c 6c20 3c20 6e53 616d 706c 6529 3a0a   ll < nSample):.
+00018ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f00: 6572 725b 6969 2c20 7468 6973 4c61 675d  err[ii, thisLag]
+00018f10: 203d 2075 315b 6969 5d20 2d20 7530 5b69   = u1[ii] - u0[i
+00018f20: 6920 2b20 6c6c 5d0a 0a20 2020 2069 6620  i + ll]..    if 
+00018f30: 6e6f 726d 203d 3d20 224c 3222 3a0a 2020  norm == "L2":.  
+00018f40: 2020 2020 2020 6572 7220 3d20 6572 722a        err = err*
+00018f50: 2a32 0a20 2020 2065 6c69 6620 6e6f 726d  *2.    elif norm
+00018f60: 203d 3d20 224c 3122 3a0a 2020 2020 2020   == "L1":.      
+00018f70: 2020 6572 7220 3d20 6e70 2e61 6273 2865    err = np.abs(e
+00018f80: 7272 290a 0a20 2020 2023 204e 6f77 2066  rr)..    # Now f
+00018f90: 6978 2063 6f72 6e65 7273 2077 6974 6820  ix corners with 
+00018fa0: 636f 6e73 7461 6e74 2065 7874 7261 706f  constant extrapo
+00018fb0: 6c61 7469 6f6e 0a20 2020 2066 6f72 206c  lation.    for l
+00018fc0: 6c20 696e 206e 702e 6172 616e 6765 282d  l in np.arange(-
+00018fd0: 6c61 672c 206c 6167 202b 2031 293a 0a20  lag, lag + 1):. 
+00018fe0: 2020 2020 2020 2074 6869 734c 6167 203d         thisLag =
+00018ff0: 206c 6c20 2b20 6c61 670a 0a20 2020 2020   ll + lag..     
+00019000: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
+00019010: 6765 286e 5361 6d70 6c65 293a 0a20 2020  ge(nSample):.   
+00019020: 2020 2020 2020 2020 2069 6620 6969 202b           if ii +
+00019030: 206c 6c20 3c20 303a 0a20 2020 2020 2020   ll < 0:.       
+00019040: 2020 2020 2020 2020 2065 7272 5b69 692c           err[ii,
+00019050: 2074 6869 734c 6167 5d20 3d20 6572 725b   thisLag] = err[
+00019060: 2d6c 6c2c 2074 6869 734c 6167 5d0a 0a20  -ll, thisLag].. 
+00019070: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00019080: 6969 202b 206c 6c20 3e20 6e53 616d 706c  ii + ll > nSampl
+00019090: 6520 2d20 313a 0a20 2020 2020 2020 2020  e - 1:.         
+000190a0: 2020 2020 2020 2065 7272 5b69 692c 2074         err[ii, t
+000190b0: 6869 734c 6167 5d20 3d20 6572 725b 6e53  hisLag] = err[nS
+000190c0: 616d 706c 6520 2d20 6c6c 202d 2031 2c20  ample - ll - 1, 
+000190d0: 7468 6973 4c61 675d 0a0a 2020 2020 7265  thisLag]..    re
+000190e0: 7475 726e 2065 7272 0a0a 0a64 6566 2061  turn err...def a
+000190f0: 6363 756d 756c 6174 6545 7272 6f72 4675  ccumulateErrorFu
+00019100: 6e63 7469 6f6e 2864 6972 2c20 6572 722c  nction(dir, err,
+00019110: 206e 5361 6d70 6c65 2c20 6c61 672c 2062   nSample, lag, b
+00019120: 293a 0a20 2020 2022 2222 0a20 2020 2061  ):.    """.    a
+00019130: 6363 756d 756c 6174 696f 6e20 6f66 2074  ccumulation of t
+00019140: 6865 2065 7272 6f72 2c20 7768 6963 6820  he error, which 
+00019150: 666f 6c6c 6f77 7320 7468 6520 6571 7561  follows the equa
+00019160: 7469 6f6e 2036 2069 6e20 4861 6c65 2c20  tion 6 in Hale, 
+00019170: 3230 3133 2e0a 0a20 2020 2050 6172 616d  2013...    Param
+00019180: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
+00019190: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2064 6972  --------.    dir
+000191a0: 3a20 6163 6375 6d75 6c61 7469 6f6e 2064  : accumulation d
+000191b0: 6972 6563 7469 6f6e 2028 2064 6972 203e  irection ( dir >
+000191c0: 2030 203d 2066 6f72 7761 7264 2069 6e20   0 = forward in 
+000191d0: 7469 6d65 2c20 6469 7220 3c3d 2030 203d  time, dir <= 0 =
+000191e0: 2062 6163 6b77 6172 6420 696e 2074 696d   backward in tim
+000191f0: 6529 0a20 2020 2065 7272 3a20 7468 6520  e).    err: the 
+00019200: 3244 2065 7272 6f72 2066 756e 6374 696f  2D error functio
+00019210: 6e3b 2073 697a 6520 3d20 286e 7361 6d70  n; size = (nsamp
+00019220: 2c32 2a6c 6167 2b31 290a 2020 2020 6e53  ,2*lag+1).    nS
+00019230: 616d 706c 653a 206e 756d 6572 206f 6620  ample: numer of 
+00019240: 706f 696e 7473 2074 6f20 636f 6d70 6172  points to compar
+00019250: 6520 696e 2074 6865 2074 7261 6365 730a  e in the traces.
+00019260: 2020 2020 6c61 673a 206d 6178 696d 756d      lag: maximum
+00019270: 206c 6167 2069 6e20 7361 6d70 6c65 206e   lag in sample n
+00019280: 756d 6265 7220 746f 2073 6561 7263 680a  umber to search.
+00019290: 2020 2020 623a 2073 7472 6169 6e20 6c69      b: strain li
+000192a0: 6d69 7420 2869 6e74 6567 6572 2076 616c  mit (integer val
+000192b0: 7565 203e 3d20 3129 0a0a 2020 2020 5245  ue >= 1)..    RE
+000192c0: 5455 524e 533a 0a20 2020 202d 2d2d 2d2d  TURNS:.    -----
+000192d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
+000192e0: 2020 643a 2074 6865 2032 4420 6469 7374    d: the 2D dist
+000192f0: 616e 6365 2066 756e 6374 696f 6e3b 2073  ance function; s
+00019300: 697a 6520 3d20 286e 7361 6d70 2c32 2a6c  ize = (nsamp,2*l
+00019310: 6167 2b31 290a 0a20 2020 204f 7269 6769  ag+1)..    Origi
+00019320: 6e61 6c20 6279 2044 6920 5961 6e67 0a20  nal by Di Yang. 
+00019330: 2020 204c 6173 7420 6d6f 6469 6669 6564     Last modified
+00019340: 2062 7920 4479 6c61 6e20 4d69 6b65 7365   by Dylan Mikese
+00019350: 6c6c 2028 3235 2046 6562 2e20 3230 3135  ll (25 Feb. 2015
+00019360: 290a 2020 2020 5472 616e 736c 6174 6564  ).    Translated
+00019370: 2074 6f20 7079 7468 6f6e 2062 7920 5469   to python by Ti
+00019380: 6d20 436c 656d 656e 7473 2028 3137 2041  m Clements (17 A
+00019390: 7567 2e20 3230 3138 290a 0a20 2020 2022  ug. 2018)..    "
+000193a0: 2222 0a0a 2020 2020 2320 6e75 6d62 6572  ""..    # number
+000193b0: 206f 6620 6c61 6773 2066 726f 6d20 5b20   of lags from [ 
+000193c0: 2d6c 6167 203a 202b 6c61 6720 5d0a 2020  -lag : +lag ].  
+000193d0: 2020 6e4c 6167 203d 2028 3220 2a20 6c61    nLag = (2 * la
+000193e0: 6729 202b 2031 0a0a 2020 2020 2320 616c  g) + 1..    # al
+000193f0: 6c6f 6361 7465 2064 6973 7461 6e63 6520  locate distance 
+00019400: 6d61 7472 6978 0a20 2020 2064 203d 206e  matrix.    d = n
+00019410: 702e 7a65 726f 7328 5b6e 5361 6d70 6c65  p.zeros([nSample
+00019420: 2c20 6e4c 6167 5d29 0a0a 2020 2020 2320  , nLag])..    # 
+00019430: 5365 7475 7020 696e 6469 6365 7320 6261  Setup indices ba
+00019440: 7365 6420 6f6e 2066 6f72 7761 7264 206f  sed on forward o
+00019450: 7220 6261 636b 7761 7264 2061 6363 756d  r backward accum
+00019460: 756c 6174 696f 6e20 6469 7265 6374 696f  ulation directio
+00019470: 6e0a 2020 2020 6966 2064 6972 203e 2030  n.    if dir > 0
+00019480: 3a20 2023 2046 4f52 5741 5244 0a20 2020  :  # FORWARD.   
+00019490: 2020 2020 2069 4265 6769 6e2c 2069 456e       iBegin, iEn
+000194a0: 642c 2069 496e 6320 3d20 302c 206e 5361  d, iInc = 0, nSa
+000194b0: 6d70 6c65 202d 2031 2c20 310a 2020 2020  mple - 1, 1.    
+000194c0: 656c 7365 3a20 2023 2042 4143 4b57 4152  else:  # BACKWAR
+000194d0: 440a 2020 2020 2020 2020 6942 6567 696e  D.        iBegin
+000194e0: 2c20 6945 6e64 2c20 6949 6e63 203d 206e  , iEnd, iInc = n
+000194f0: 5361 6d70 6c65 202d 2031 2c20 302c 202d  Sample - 1, 0, -
+00019500: 310a 0a20 2020 2023 204c 6f6f 7020 7468  1..    # Loop th
+00019510: 726f 7567 6820 616c 6c20 7469 6d65 7320  rough all times 
+00019520: 6969 2069 6e20 666f 7277 6172 6420 6f72  ii in forward or
+00019530: 2062 6163 6b77 6172 6420 6469 7265 6374   backward direct
+00019540: 696f 6e0a 2020 2020 666f 7220 6969 2069  ion.    for ii i
+00019550: 6e20 7261 6e67 6528 6942 6567 696e 2c20  n range(iBegin, 
+00019560: 6945 6e64 202b 2069 496e 632c 2069 496e  iEnd + iInc, iIn
+00019570: 6329 3a0a 2020 2020 2020 2020 2320 6d69  c):.        # mi
+00019580: 6e2f 6d61 7820 746f 2061 6363 6f75 6e74  n/max to account
+00019590: 2066 6f72 2074 6865 2065 6467 6573 2f62   for the edges/b
+000195a0: 6f75 6e64 6172 6965 730a 2020 2020 2020  oundaries.      
+000195b0: 2020 6a69 203d 206d 6178 285b 302c 206d    ji = max([0, m
+000195c0: 696e 285b 6e53 616d 706c 6520 2d20 312c  in([nSample - 1,
+000195d0: 2069 6920 2d20 6949 6e63 5d29 5d29 0a20   ii - iInc])]). 
+000195e0: 2020 2020 2020 206a 6220 3d20 6d61 7828         jb = max(
+000195f0: 5b30 2c20 6d69 6e28 5b6e 5361 6d70 6c65  [0, min([nSample
+00019600: 202d 2031 2c20 6969 202d 2069 496e 6320   - 1, ii - iInc 
+00019610: 2a20 625d 295d 290a 0a20 2020 2020 2020  * b])])..       
+00019620: 2023 206c 6f6f 7020 7468 726f 7567 6820   # loop through 
+00019630: 616c 6c20 6c61 670a 2020 2020 2020 2020  all lag.        
+00019640: 666f 7220 6c6c 2069 6e20 7261 6e67 6528  for ll in range(
+00019650: 6e4c 6167 293a 0a20 2020 2020 2020 2020  nLag):.         
+00019660: 2020 2023 2063 6865 636b 206c 696d 6974     # check limit
+00019670: 7320 6f6e 206c 6167 2069 6e64 6963 6573  s on lag indices
+00019680: 0a20 2020 2020 2020 2020 2020 206c 4d69  .            lMi
+00019690: 6e75 7331 203d 206c 6c20 2d20 310a 0a20  nus1 = ll - 1.. 
+000196a0: 2020 2020 2020 2020 2020 2023 2063 6865             # che
+000196b0: 636b 206c 6167 2069 6e64 6578 2069 7320  ck lag index is 
+000196c0: 6772 6561 7465 7220 7468 616e 2030 0a20  greater than 0. 
+000196d0: 2020 2020 2020 2020 2020 2069 6620 6c4d             if lM
+000196e0: 696e 7573 3120 3c20 303a 0a20 2020 2020  inus1 < 0:.     
+000196f0: 2020 2020 2020 2020 2020 206c 4d69 6e75             lMinu
+00019700: 7331 203d 2030 2020 2320 6d61 6b65 206c  s1 = 0  # make l
+00019710: 6167 203d 2066 6972 7374 206c 6167 0a0a  ag = first lag..
+00019720: 2020 2020 2020 2020 2020 2020 6c50 6c75              lPlu
+00019730: 7331 203d 206c 6c20 2b20 3120 2023 206c  s1 = ll + 1  # l
+00019740: 6167 2061 7420 6c2b 310a 0a20 2020 2020  ag at l+1..     
+00019750: 2020 2020 2020 2023 2063 6865 636b 206c         # check l
+00019760: 6167 2069 6e64 6578 206c 6573 7320 7468  ag index less th
+00019770: 616e 206d 6178 206c 6167 0a20 2020 2020  an max lag.     
+00019780: 2020 2020 2020 2069 6620 6c50 6c75 7331         if lPlus1
+00019790: 203e 206e 4c61 6720 2d20 313a 0a20 2020   > nLag - 1:.   
+000197a0: 2020 2020 2020 2020 2020 2020 206c 506c               lPl
+000197b0: 7573 3120 3d20 6e4c 6167 202d 2031 0a0a  us1 = nLag - 1..
+000197c0: 2020 2020 2020 2020 2020 2020 2320 6765              # ge
+000197d0: 7420 6469 7374 616e 6365 2061 7420 6c61  t distance at la
+000197e0: 6773 2028 6c6c 2d31 2c20 6c6c 2c20 6c6c  gs (ll-1, ll, ll
+000197f0: 2b31 290a 2020 2020 2020 2020 2020 2020  +1).            
+00019800: 6469 7374 4c6d 696e 7573 3120 3d20 645b  distLminus1 = d[
+00019810: 6a62 2c20 6c4d 696e 7573 315d 2020 2320  jb, lMinus1]  # 
+00019820: 6d69 6e75 733a 2020 645b 692d 622c 206a  minus:  d[i-b, j
+00019830: 2d31 5d0a 2020 2020 2020 2020 2020 2020  -1].            
+00019840: 6469 7374 4c20 3d20 645b 6a69 2c20 6c6c  distL = d[ji, ll
+00019850: 5d20 2023 2061 6374 7561 6c20 645b 692d  ]  # actual d[i-
+00019860: 312c 206a 5d0a 2020 2020 2020 2020 2020  1, j].          
+00019870: 2020 6469 7374 4c70 6c75 7331 203d 2064    distLplus1 = d
+00019880: 5b6a 622c 206c 506c 7573 315d 2020 2320  [jb, lPlus1]  # 
+00019890: 706c 7573 2064 5b69 2d62 2c20 6a2b 315d  plus d[i-b, j+1]
+000198a0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+000198b0: 206a 6920 213d 206a 623a 2020 2320 6571   ji != jb:  # eq
+000198c0: 7561 7469 6f6e 2031 3020 696e 2048 616c  uation 10 in Hal
+000198d0: 652c 2032 3031 330a 2020 2020 2020 2020  e, 2013.        
+000198e0: 2020 2020 2020 2020 666f 7220 6b62 2069          for kb i
+000198f0: 6e20 7261 6e67 6528 6a69 2c20 6a62 202b  n range(ji, jb +
+00019900: 2069 496e 6320 2d20 312c 202d 6949 6e63   iInc - 1, -iInc
+00019910: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00019920: 2020 2020 2020 2064 6973 744c 6d69 6e75         distLminu
+00019930: 7331 203d 2064 6973 744c 6d69 6e75 7331  s1 = distLminus1
+00019940: 202b 2065 7272 5b6b 622c 206c 4d69 6e75   + err[kb, lMinu
+00019950: 7331 5d0a 2020 2020 2020 2020 2020 2020  s1].            
+00019960: 2020 2020 2020 2020 6469 7374 4c70 6c75          distLplu
+00019970: 7331 203d 2064 6973 744c 706c 7573 3120  s1 = distLplus1 
+00019980: 2b20 6572 725b 6b62 2c20 6c50 6c75 7331  + err[kb, lPlus1
+00019990: 5d0a 0a20 2020 2020 2020 2020 2020 2023  ]..            #
+000199a0: 2065 7175 6174 696f 6e20 3620 2869 6620   equation 6 (if 
+000199b0: 623d 3129 206f 7220 3130 2028 6966 2062  b=1) or 10 (if b
+000199c0: 3e31 2920 696e 2048 616c 6520 2832 3031  >1) in Hale (201
+000199d0: 3329 2061 6674 6572 2074 7265 6174 696e  3) after treatin
+000199e0: 6720 626f 756e 6461 7269 6573 0a20 2020  g boundaries.   
+000199f0: 2020 2020 2020 2020 2064 5b69 692c 206c           d[ii, l
+00019a00: 6c5d 203d 2065 7272 5b69 692c 206c 6c5d  l] = err[ii, ll]
+00019a10: 202b 206d 696e 285b 6469 7374 4c6d 696e   + min([distLmin
+00019a20: 7573 312c 2064 6973 744c 2c20 6469 7374  us1, distL, dist
+00019a30: 4c70 6c75 7331 5d29 0a0a 2020 2020 7265  Lplus1])..    re
+00019a40: 7475 726e 2064 0a0a 0a64 6566 2062 6163  turn d...def bac
+00019a50: 6b74 7261 636b 4469 7374 616e 6365 4675  ktrackDistanceFu
+00019a60: 6e63 7469 6f6e 2864 6972 2c20 642c 2065  nction(dir, d, e
+00019a70: 7272 2c20 6c6d 696e 2c20 6229 3a0a 2020  rr, lmin, b):.  
+00019a80: 2020 2222 220a 2020 2020 5468 6520 6675    """.    The fu
+00019a90: 6e63 7469 6f6e 2069 7320 6571 7561 7469  nction is equati
+00019aa0: 6f6e 2032 2069 6e20 4861 6c65 2c20 3230  on 2 in Hale, 20
+00019ab0: 3133 2e0a 0a20 2020 2050 6172 616d 6574  13...    Paramet
+00019ac0: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
+00019ad0: 2d2d 2d2d 2d2d 0a20 2020 2064 6972 3a20  ------.    dir: 
+00019ae0: 7369 6465 2074 6f20 7374 6172 7420 6d69  side to start mi
+00019af0: 6e69 6d69 7a61 7469 6f6e 2028 2064 6972  nimization ( dir
+00019b00: 203e 2030 203d 2066 726f 6e74 2c20 6469   > 0 = front, di
+00019b10: 7220 3c3d 2030 203d 2020 6261 636b 290a  r <= 0 =  back).
+00019b20: 2020 2020 6420 3a20 7468 6520 3244 2064      d : the 2D d
+00019b30: 6973 7461 6e63 6520 6675 6e63 7469 6f6e  istance function
+00019b40: 3b20 7369 7a65 203d 2028 6e73 616d 702c  ; size = (nsamp,
+00019b50: 322a 6c61 672b 3129 0a20 2020 2065 7272  2*lag+1).    err
+00019b60: 3a20 7468 6520 3244 2065 7272 6f72 2066  : the 2D error f
+00019b70: 756e 6374 696f 6e3b 2073 697a 6520 3d20  unction; size = 
+00019b80: 286e 7361 6d70 2c32 2a6c 6167 2b31 290a  (nsamp,2*lag+1).
+00019b90: 2020 2020 6c6d 696e 3a20 6d69 6e69 6d75      lmin: minimu
+00019ba0: 6d20 6c61 6720 746f 2073 6561 7263 6820  m lag to search 
+00019bb0: 6f76 6572 0a20 2020 2062 203a 2073 7472  over.    b : str
+00019bc0: 6169 6e20 6c69 6d69 7420 2869 6e74 6567  ain limit (integ
+00019bd0: 6572 2076 616c 7565 203e 3d20 3129 0a0a  er value >= 1)..
+00019be0: 2020 2020 5245 5455 524e 533a 0a20 2020      RETURNS:.   
+00019bf0: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
+00019c00: 2d2d 2d0a 2020 2020 7374 6261 723a 2076  ---.    stbar: v
+00019c10: 6563 746f 7220 6f66 2069 6e74 6567 6572  ector of integer
+00019c20: 2073 6869 6674 7320 7375 626a 6563 7420   shifts subject 
+00019c30: 746f 207c 7528 6929 2d75 2869 2d31 297c  to |u(i)-u(i-1)|
+00019c40: 203c 3d20 312f 620a 0a20 2020 204f 7269   <= 1/b..    Ori
+00019c50: 6769 6e61 6c20 6279 2044 6920 5961 6e67  ginal by Di Yang
+00019c60: 0a20 2020 204c 6173 7420 6d6f 6469 6669  .    Last modifi
+00019c70: 6564 2062 7920 4479 6c61 6e20 4d69 6b65  ed by Dylan Mike
+00019c80: 7365 6c6c 2028 3139 2044 6563 2e20 3230  sell (19 Dec. 20
+00019c90: 3134 290a 0a20 2020 2054 7261 6e73 6c61  14)..    Transla
+00019ca0: 7465 6420 746f 2070 7974 686f 6e20 6279  ted to python by
+00019cb0: 2054 696d 2043 6c65 6d65 6e74 7320 2831   Tim Clements (1
+00019cc0: 3720 4175 672e 2032 3031 3829 0a0a 2020  7 Aug. 2018)..  
+00019cd0: 2020 2222 220a 0a20 2020 206e 5361 6d70    """..    nSamp
+00019ce0: 6c65 2c20 6e4c 6167 203d 2064 2e73 6861  le, nLag = d.sha
+00019cf0: 7065 0a20 2020 2073 7462 6172 203d 206e  pe.    stbar = n
+00019d00: 702e 7a65 726f 7328 6e53 616d 706c 6529  p.zeros(nSample)
+00019d10: 0a0a 2020 2020 2320 5365 7475 7020 696e  ..    # Setup in
+00019d20: 6469 6365 7320 6261 7365 6420 6f6e 2066  dices based on f
+00019d30: 6f72 7761 7264 206f 7220 6261 636b 7761  orward or backwa
+00019d40: 7264 2061 6363 756d 756c 6174 696f 6e20  rd accumulation 
+00019d50: 6469 7265 6374 696f 6e0a 2020 2020 6966  direction.    if
+00019d60: 2064 6972 203e 2030 3a20 2023 2046 4f52   dir > 0:  # FOR
+00019d70: 5741 5244 0a20 2020 2020 2020 2069 4265  WARD.        iBe
+00019d80: 6769 6e2c 2069 456e 642c 2069 496e 6320  gin, iEnd, iInc 
+00019d90: 3d20 302c 206e 5361 6d70 6c65 202d 2031  = 0, nSample - 1
+00019da0: 2c20 310a 2020 2020 656c 7365 3a20 2023  , 1.    else:  #
+00019db0: 2042 4143 4b57 4152 440a 2020 2020 2020   BACKWARD.      
+00019dc0: 2020 6942 6567 696e 2c20 6945 6e64 2c20    iBegin, iEnd, 
+00019dd0: 6949 6e63 203d 206e 5361 6d70 6c65 202d  iInc = nSample -
+00019de0: 2031 2c20 302c 202d 310a 0a20 2020 2023   1, 0, -1..    #
+00019df0: 2073 7461 7274 2066 726f 6d20 7468 6520   start from the 
+00019e00: 656e 6420 2866 726f 6e74 206f 7220 6261  end (front or ba
+00019e10: 636b 290a 2020 2020 6c6c 203d 206e 702e  ck).    ll = np.
+00019e20: 6172 676d 696e 2864 5b69 4265 6769 6e2c  argmin(d[iBegin,
+00019e30: 203a 5d29 2020 2320 6669 6e64 206d 696e   :])  # find min
+00019e40: 696d 756d 2061 6363 756d 756c 6174 6564  imum accumulated
+00019e50: 2064 6973 7461 6e63 6520 6174 2066 726f   distance at fro
+00019e60: 6e74 206f 7220 6261 636b 2064 6570 656e  nt or back depen
+00019e70: 6469 6e67 206f 6e20 2764 6972 270a 2020  ding on 'dir'.  
+00019e80: 2020 7374 6261 725b 6942 6567 696e 5d20    stbar[iBegin] 
+00019e90: 3d20 6c6c 202b 206c 6d69 6e20 2023 2061  = ll + lmin  # a
+00019ea0: 6273 6f6c 7574 6520 7661 6c75 6520 6f66  bsolute value of
+00019eb0: 2069 6e74 6567 6572 2073 6869 6674 0a0a   integer shift..
+00019ec0: 2020 2020 2320 6d6f 7665 2074 6872 6f75      # move throu
+00019ed0: 6768 2061 6c6c 2074 696d 6520 7361 6d70  gh all time samp
+00019ee0: 6c65 7320 696e 2066 6f72 7761 7264 206f  les in forward o
+00019ef0: 7220 6261 636b 7761 7264 2064 6972 6563  r backward direc
+00019f00: 7469 6f6e 0a20 2020 2069 6920 3d20 6942  tion.    ii = iB
+00019f10: 6567 696e 0a0a 2020 2020 7768 696c 6520  egin..    while 
+00019f20: 6969 2021 3d20 6945 6e64 3a0a 2020 2020  ii != iEnd:.    
+00019f30: 2020 2020 2320 6d69 6e2f 6d61 7820 666f      # min/max fo
+00019f40: 7220 6564 6765 732f 626f 756e 6461 7269  r edges/boundari
+00019f50: 6573 0a20 2020 2020 2020 206a 6920 3d20  es.        ji = 
+00019f60: 6e70 2e6d 6178 285b 302c 206e 702e 6d69  np.max([0, np.mi
+00019f70: 6e28 5b6e 5361 6d70 6c65 202d 2031 2c20  n([nSample - 1, 
+00019f80: 6969 202b 2069 496e 635d 295d 290a 2020  ii + iInc])]).  
+00019f90: 2020 2020 2020 6a62 203d 206e 702e 6d61        jb = np.ma
+00019fa0: 7828 5b30 2c20 6e70 2e6d 696e 285b 6e53  x([0, np.min([nS
+00019fb0: 616d 706c 6520 2d20 312c 2069 6920 2b20  ample - 1, ii + 
+00019fc0: 6949 6e63 202a 2062 5d29 5d29 0a0a 2020  iInc * b])])..  
+00019fd0: 2020 2020 2020 2320 6368 6563 6b20 6c69        # check li
+00019fe0: 6d69 7473 206f 6e20 6c61 6720 696e 6469  mits on lag indi
+00019ff0: 6365 730a 2020 2020 2020 2020 6c4d 696e  ces.        lMin
+0001a000: 7573 3120 3d20 6c6c 202d 2031 0a0a 2020  us1 = ll - 1..  
+0001a010: 2020 2020 2020 6966 206c 4d69 6e75 7331        if lMinus1
+0001a020: 203c 2030 3a20 2023 2063 6865 636b 206c   < 0:  # check l
+0001a030: 6167 2069 6e64 6578 2069 7320 6772 6561  ag index is grea
+0001a040: 7465 7220 7468 616e 2031 0a20 2020 2020  ter than 1.     
+0001a050: 2020 2020 2020 206c 4d69 6e75 7331 203d         lMinus1 =
+0001a060: 2030 2020 2320 6d61 6b65 206c 6167 203d   0  # make lag =
+0001a070: 2066 6972 7374 206c 6167 0a0a 2020 2020   first lag..    
+0001a080: 2020 2020 6c50 6c75 7331 203d 206c 6c20      lPlus1 = ll 
+0001a090: 2b20 310a 0a20 2020 2020 2020 2069 6620  + 1..        if 
+0001a0a0: 6c50 6c75 7331 203e 206e 4c61 6720 2d20  lPlus1 > nLag - 
+0001a0b0: 313a 2020 2320 6368 6563 6b20 6c61 6720  1:  # check lag 
+0001a0c0: 696e 6465 7820 6c65 7373 2074 6861 6e20  index less than 
+0001a0d0: 6d61 7820 6c61 670a 2020 2020 2020 2020  max lag.        
+0001a0e0: 2020 2020 6c50 6c75 7331 203d 206e 4c61      lPlus1 = nLa
+0001a0f0: 6720 2d20 310a 0a20 2020 2020 2020 2023  g - 1..        #
+0001a100: 2067 6574 2064 6973 7461 6e63 6520 6174   get distance at
+0001a110: 206c 6167 7320 286c 6c2d 312c 206c 6c2c   lags (ll-1, ll,
+0001a120: 206c 6c2b 3129 0a20 2020 2020 2020 2064   ll+1).        d
+0001a130: 6973 744c 6d69 6e75 7331 203d 2064 5b6a  istLminus1 = d[j
+0001a140: 622c 206c 4d69 6e75 7331 5d20 2023 206d  b, lMinus1]  # m
+0001a150: 696e 7573 3a20 2064 5b69 2d62 2c20 6a2d  inus:  d[i-b, j-
+0001a160: 315d 0a20 2020 2020 2020 2064 6973 744c  1].        distL
+0001a170: 203d 2064 5b6a 692c 206c 6c5d 2020 2320   = d[ji, ll]  # 
+0001a180: 6163 7475 616c 2064 5b69 2d31 2c20 6a5d  actual d[i-1, j]
+0001a190: 0a20 2020 2020 2020 2064 6973 744c 706c  .        distLpl
+0001a1a0: 7573 3120 3d20 645b 6a62 2c20 6c50 6c75  us1 = d[jb, lPlu
+0001a1b0: 7331 5d20 2023 2070 6c75 7320 645b 692d  s1]  # plus d[i-
+0001a1c0: 622c 206a 2b31 5d0a 0a20 2020 2020 2020  b, j+1]..       
+0001a1d0: 2023 2065 7175 6174 696f 6e20 3130 2069   # equation 10 i
+0001a1e0: 6e20 4861 6c65 2028 3230 3133 290a 2020  n Hale (2013).  
+0001a1f0: 2020 2020 2020 2320 7375 6d20 6572 726f        # sum erro
+0001a200: 7273 206f 7665 7220 692d 313a 692d 622b  rs over i-1:i-b+
+0001a210: 310a 2020 2020 2020 2020 6966 206a 6920  1.        if ji 
+0001a220: 213d 206a 623a 0a20 2020 2020 2020 2020  != jb:.         
+0001a230: 2020 2066 6f72 206b 6220 696e 2072 616e     for kb in ran
+0001a240: 6765 286a 692c 206a 6220 2d20 6949 6e63  ge(ji, jb - iInc
+0001a250: 202d 2031 2c20 6949 6e63 293a 0a20 2020   - 1, iInc):.   
+0001a260: 2020 2020 2020 2020 2020 2020 2064 6973               dis
+0001a270: 744c 6d69 6e75 7331 203d 2064 6973 744c  tLminus1 = distL
+0001a280: 6d69 6e75 7331 202b 2065 7272 5b6b 622c  minus1 + err[kb,
+0001a290: 206c 4d69 6e75 7331 5d0a 2020 2020 2020   lMinus1].      
+0001a2a0: 2020 2020 2020 2020 2020 6469 7374 4c70            distLp
+0001a2b0: 6c75 7331 203d 2064 6973 744c 706c 7573  lus1 = distLplus
+0001a2c0: 3120 2b20 6572 725b 6b62 2c20 6c50 6c75  1 + err[kb, lPlu
+0001a2d0: 7331 5d0a 0a20 2020 2020 2020 2023 2075  s1]..        # u
+0001a2e0: 7064 6174 6520 6d69 6e69 6d75 6d20 6469  pdate minimum di
+0001a2f0: 7374 616e 6365 2074 6f20 7072 6576 696f  stance to previo
+0001a300: 7573 2073 616d 706c 650a 2020 2020 2020  us sample.      
+0001a310: 2020 646c 203d 206e 702e 6d69 6e28 5b64    dl = np.min([d
+0001a320: 6973 744c 6d69 6e75 7331 2c20 6469 7374  istLminus1, dist
+0001a330: 4c2c 2064 6973 744c 706c 7573 315d 290a  L, distLplus1]).
+0001a340: 0a20 2020 2020 2020 2069 6620 646c 2021  .        if dl !
+0001a350: 3d20 6469 7374 4c3a 2020 2320 7468 656e  = distL:  # then
+0001a360: 206c 6c20 7e3d 206c 6c20 616e 6420 7765   ll ~= ll and we
+0001a370: 2063 6865 636b 2066 6f72 7761 7264 2061   check forward a
+0001a380: 6e64 2062 6163 6b77 6172 640a 2020 2020  nd backward.    
+0001a390: 2020 2020 2020 2020 6966 2064 6c20 3d3d          if dl ==
+0001a3a0: 2064 6973 744c 6d69 6e75 7331 3a0a 2020   distLminus1:.  
+0001a3b0: 2020 2020 2020 2020 2020 2020 2020 6c6c                ll
+0001a3c0: 203d 206c 4d69 6e75 7331 0a20 2020 2020   = lMinus1.     
+0001a3d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001a3e0: 2020 2020 2020 2020 2020 2020 206c 6c20               ll 
+0001a3f0: 3d20 6c50 6c75 7331 0a0a 2020 2020 2020  = lPlus1..      
+0001a400: 2020 2320 6173 7375 6d65 2069 6920 3d20    # assume ii = 
+0001a410: 6969 202d 2031 0a20 2020 2020 2020 2069  ii - 1.        i
+0001a420: 6920 2b3d 2069 496e 630a 0a20 2020 2020  i += iInc..     
+0001a430: 2020 2023 2061 6273 6f6c 7574 6520 696e     # absolute in
+0001a440: 7465 6765 7220 6f66 206c 6167 0a20 2020  teger of lag.   
+0001a450: 2020 2020 2073 7462 6172 5b69 695d 203d       stbar[ii] =
+0001a460: 206c 6c20 2b20 6c6d 696e 0a0a 2020 2020   ll + lmin..    
+0001a470: 2020 2020 2320 6e6f 7720 6d6f 7665 2074      # now move t
+0001a480: 6f20 636f 7272 6563 7420 7469 6d65 2069  o correct time i
+0001a490: 6e64 6578 2c20 6966 2073 6d6f 6f74 6869  ndex, if smoothi
+0001a4a0: 6e67 2064 6966 6665 7265 6e63 6520 6f76  ng difference ov
+0001a4b0: 6572 206d 616e 790a 2020 2020 2020 2020  er many.        
+0001a4c0: 2320 7469 6d65 2073 616d 706c 6573 2075  # time samples u
+0001a4d0: 7369 6e67 2027 6227 0a20 2020 2020 2020  sing 'b'.       
+0001a4e0: 2069 6620 286c 6c20 3d3d 206c 4d69 6e75   if (ll == lMinu
+0001a4f0: 7331 2920 7c20 286c 6c20 3d3d 206c 506c  s1) | (ll == lPl
+0001a500: 7573 3129 3a20 2023 2063 6865 636b 2065  us1):  # check e
+0001a510: 6467 6573 2074 6f20 7365 6520 6162 6f75  dges to see abou
+0001a520: 7420 6220 7661 6c75 6573 0a20 2020 2020  t b values.     
+0001a530: 2020 2020 2020 2069 6620 6a69 2021 3d20         if ji != 
+0001a540: 6a62 3a20 2023 2069 6620 623e 3120 7468  jb:  # if b>1 th
+0001a550: 656e 206e 6565 6420 746f 206d 6f76 6520  en need to move 
+0001a560: 6d6f 7265 2073 7465 7073 0a20 2020 2020  more steps.     
+0001a570: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+0001a580: 6220 696e 2072 616e 6765 286a 692c 206a  b in range(ji, j
+0001a590: 6220 2d20 6949 6e63 202d 2031 2c20 6949  b - iInc - 1, iI
+0001a5a0: 6e63 293a 0a20 2020 2020 2020 2020 2020  nc):.           
+0001a5b0: 2020 2020 2020 2020 2069 6920 3d20 6969           ii = ii
+0001a5c0: 202b 2069 496e 6320 2023 206d 6f76 6520   + iInc  # move 
+0001a5d0: 6672 6f6d 2069 2d31 3a69 2d62 2d31 0a20  from i-1:i-b-1. 
+0001a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a5f0: 2020 2073 7462 6172 5b69 695d 203d 206c     stbar[ii] = l
+0001a600: 6c20 2b20 6c6d 696e 2020 2320 636f 6e73  l + lmin  # cons
+0001a610: 7461 6e74 206c 6167 206f 7665 7220 7468  tant lag over th
+0001a620: 6174 2074 696d 650a 0a20 2020 2072 6574  at time..    ret
+0001a630: 7572 6e20 7374 6261 720a 0a0a 6465 6620  urn stbar...def 
+0001a640: 7763 745f 6d6f 6469 6669 6564 280a 2020  wct_modified(.  
+0001a650: 2020 7931 2c20 7932 2c20 6474 2c20 646a    y1, y2, dt, dj
+0001a660: 3d31 202f 2031 322c 2073 303d 2d31 2c20  =1 / 12, s0=-1, 
+0001a670: 4a3d 2d31 2c20 7369 673d 5472 7565 2c20  J=-1, sig=True, 
+0001a680: 7369 676e 6966 6963 616e 6365 5f6c 6576  significance_lev
+0001a690: 656c 3d30 2e39 352c 2077 6176 656c 6574  el=0.95, wavelet
+0001a6a0: 3d22 6d6f 726c 6574 222c 206e 6f72 6d61  ="morlet", norma
+0001a6b0: 6c69 7a65 3d54 7275 652c 202a 2a6b 7761  lize=True, **kwa
+0001a6c0: 7267 730a 293a 0a20 2020 2022 2222 0a20  rgs.):.    """. 
+0001a6d0: 2020 2020 2020 2057 6176 656c 6574 2063         Wavelet c
+0001a6e0: 6f68 6572 656e 6365 2074 7261 6e73 666f  oherence transfo
+0001a6f0: 726d 2028 5743 5429 2e0a 2020 2020 e280  rm (WCT)..    ..
+0001a700: 8b0a 2020 2020 2020 2020 5468 6520 5743  ..        The WC
+0001a710: 5420 6669 6e64 7320 7265 6769 6f6e 7320  T finds regions 
+0001a720: 696e 2074 696d 6520 6672 6571 7565 6e63  in time frequenc
+0001a730: 7920 7370 6163 6520 7768 6572 6520 7468  y space where th
+0001a740: 6520 7477 6f20 7469 6d65 0a20 2020 2020  e two time.     
+0001a750: 2020 2073 6572 6965 7320 636f 2d76 6172     series co-var
+0001a760: 792c 2062 7574 2064 6f20 6e6f 7420 6e65  y, but do not ne
+0001a770: 6365 7373 6172 696c 7920 6861 7665 2068  cessarily have h
+0001a780: 6967 6820 706f 7765 722e 0a20 2020 20e2  igh power..    .
+0001a790: 808b 0a20 2020 2020 2020 2050 6172 616d  ...        Param
+0001a7a0: 6574 6572 730a 2020 2020 2020 2020 2d2d  eters.        --
+0001a7b0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+0001a7c0: 2079 312c 2079 3220 3a20 6e75 6d70 792e   y1, y2 : numpy.
+0001a7d0: 6e64 6172 7261 792c 206c 6973 740a 2020  ndarray, list.  
+0001a7e0: 2020 2020 2020 2020 2020 496e 7075 7420            Input 
+0001a7f0: 7369 676e 616c 732e 0a20 2020 2020 2020  signals..       
+0001a800: 2064 7420 3a20 666c 6f61 740a 2020 2020   dt : float.    
+0001a810: 2020 2020 2020 2020 5361 6d70 6c65 2073          Sample s
+0001a820: 7061 6369 6e67 2e0a 2020 2020 2020 2020  pacing..        
+0001a830: 646a 203a 2066 6c6f 6174 2c20 6f70 7469  dj : float, opti
+0001a840: 6f6e 616c 0a20 2020 2020 2020 2020 2020  onal.           
+0001a850: 2053 7061 6369 6e67 2062 6574 7765 656e   Spacing between
+0001a860: 2064 6973 6372 6574 6520 7363 616c 6573   discrete scales
+0001a870: 2e20 4465 6661 756c 7420 7661 6c75 6520  . Default value 
+0001a880: 6973 2031 2f31 322e 0a20 2020 2020 2020  is 1/12..       
+0001a890: 2020 2020 2053 6d61 6c6c 6572 2076 616c       Smaller val
+0001a8a0: 7565 7320 7769 6c6c 2072 6573 756c 7420  ues will result 
+0001a8b0: 696e 2062 6574 7465 7220 7363 616c 6520  in better scale 
+0001a8c0: 7265 736f 6c75 7469 6f6e 2c20 6275 740a  resolution, but.
+0001a8d0: 2020 2020 2020 2020 2020 2020 736c 6f77              slow
+0001a8e0: 6572 2063 616c 6375 6c61 7469 6f6e 2061  er calculation a
+0001a8f0: 6e64 2070 6c6f 742e 0a20 2020 2020 2020  nd plot..       
+0001a900: 2073 3020 3a20 666c 6f61 742c 206f 7074   s0 : float, opt
+0001a910: 696f 6e61 6c0a 2020 2020 2020 2020 2020  ional.          
+0001a920: 2020 536d 616c 6c65 7374 2073 6361 6c65    Smallest scale
+0001a930: 206f 6620 7468 6520 7761 7665 6c65 742e   of the wavelet.
+0001a940: 2044 6566 6175 6c74 2076 616c 7565 2069   Default value i
+0001a950: 7320 322a 6474 2e0a 2020 2020 2020 2020  s 2*dt..        
+0001a960: 4a20 3a20 666c 6f61 742c 206f 7074 696f  J : float, optio
+0001a970: 6e61 6c0a 2020 2020 2020 2020 2020 2020  nal.            
+0001a980: 4e75 6d62 6572 206f 6620 7363 616c 6573  Number of scales
+0001a990: 206c 6573 7320 6f6e 652e 2053 6361 6c65   less one. Scale
+0001a9a0: 7320 7261 6e67 6520 6672 6f6d 2073 3020  s range from s0 
+0001a9b0: 7570 2074 6f0a 2020 2020 2020 2020 2020  up to.          
+0001a9c0: 2020 7330 202a 2032 2a2a 284a 202a 2064    s0 * 2**(J * d
+0001a9d0: 6a29 2c20 7768 6963 6820 6769 7665 7320  j), which gives 
+0001a9e0: 6120 746f 7461 6c20 6f66 2028 4a20 2b20  a total of (J + 
+0001a9f0: 3129 2073 6361 6c65 732e 0a20 2020 2020  1) scales..     
+0001aa00: 2020 2020 2020 2044 6566 6175 6c74 2069         Default i
+0001aa10: 7320 4a20 3d20 286c 6f67 3228 4e2a 6474  s J = (log2(N*dt
+0001aa20: 2f73 6f29 292f 646a 2e0a 2020 2020 2020  /so))/dj..      
+0001aa30: 2020 7369 676e 6966 6963 616e 6365 5f6c    significance_l
+0001aa40: 6576 656c 2028 666c 6f61 742c 206f 7074  evel (float, opt
+0001aa50: 696f 6e61 6c29 203a 0a20 2020 2020 2020  ional) :.       
+0001aa60: 2020 2020 2053 6967 6e69 6669 6361 6e63       Significanc
+0001aa70: 6520 6c65 7665 6c20 746f 2075 7365 2e20  e level to use. 
+0001aa80: 4465 6661 756c 7420 6973 2030 2e39 352e  Default is 0.95.
+0001aa90: 0a20 2020 2020 2020 206e 6f72 6d61 6c69  .        normali
+0001aaa0: 7a65 2028 626f 6f6c 6561 6e2c 206f 7074  ze (boolean, opt
+0001aab0: 696f 6e61 6c29 203a 0a20 2020 2020 2020  ional) :.       
+0001aac0: 2020 2020 2049 6620 7365 7420 746f 2074       If set to t
+0001aad0: 7275 652c 206e 6f72 6d61 6c69 7a65 7320  rue, normalizes 
+0001aae0: 4357 5420 6279 2074 6865 2073 7461 6e64  CWT by the stand
+0001aaf0: 6172 6420 6465 7669 6174 696f 6e20 6f66  ard deviation of
+0001ab00: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
+0001ab10: 2073 6967 6e61 6c73 2e0a 2020 2020 e280   signals..    ..
+0001ab20: 8b0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+0001ab30: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+0001ab40: 2d0a 2020 2020 2020 2020 544f 444f 3a20  -.        TODO: 
+0001ab50: 536f 6d65 7468 696e 6720 5442 4120 616e  Something TBA an
+0001ab60: 6420 5442 430a 2020 2020 e280 8b0a 2020  d TBC.    ....  
+0001ab70: 2020 2020 2020 5365 6520 616c 736f 0a20        See also. 
+0001ab80: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d0a         --------.
+0001ab90: 2020 2020 2020 2020 6377 742c 2078 7774          cwt, xwt
+0001aba0: 0a20 2020 20e2 808b 0a20 2020 2022 2222  .    ....    """
+0001abb0: 0a0a 2020 2020 7761 7665 6c65 7420 3d20  ..    wavelet = 
+0001abc0: 7079 6377 742e 7761 7665 6c65 742e 5f63  pycwt.wavelet._c
+0001abd0: 6865 636b 5f70 6172 616d 6574 6572 5f77  heck_parameter_w
+0001abe0: 6176 656c 6574 2877 6176 656c 6574 290a  avelet(wavelet).
+0001abf0: 2020 2020 2320 4368 6563 6b69 6e67 2073      # Checking s
+0001ac00: 6f6d 6520 696e 7075 7420 7061 7261 6d65  ome input parame
+0001ac10: 7465 7273 0a20 2020 2069 6620 7330 203d  ters.    if s0 =
+0001ac20: 3d20 2d31 3a0a 2020 2020 2020 2020 2320  = -1:.        # 
+0001ac30: 4e75 6d62 6572 206f 6620 7363 616c 6573  Number of scales
+0001ac40: 0a20 2020 2020 2020 2073 3020 3d20 3220  .        s0 = 2 
+0001ac50: 2a20 6474 202f 2077 6176 656c 6574 2e66  * dt / wavelet.f
+0001ac60: 6c61 6d62 6461 2829 0a20 2020 2069 6620  lambda().    if 
+0001ac70: 4a20 3d3d 202d 313a 0a20 2020 2020 2020  J == -1:.       
+0001ac80: 2023 204e 756d 6265 7220 6f66 2073 6361   # Number of sca
+0001ac90: 6c65 730a 2020 2020 2020 2020 4a20 3d20  les.        J = 
+0001aca0: 6e70 2e69 6e74 286e 702e 726f 756e 6428  np.int(np.round(
+0001acb0: 6e70 2e6c 6f67 3228 7931 2e73 697a 6520  np.log2(y1.size 
+0001acc0: 2a20 6474 202f 2073 3029 202f 2064 6a29  * dt / s0) / dj)
+0001acd0: 290a 0a20 2020 2023 204d 616b 6573 2073  )..    # Makes s
+0001ace0: 7572 6520 696e 7075 7420 7369 676e 616c  ure input signal
+0001acf0: 7320 6172 6520 6e75 6d70 7920 6172 7261  s are numpy arra
+0001ad00: 7973 2e0a 2020 2020 7931 203d 206e 702e  ys..    y1 = np.
+0001ad10: 6173 6172 7261 7928 7931 290a 2020 2020  asarray(y1).    
+0001ad20: 7932 203d 206e 702e 6173 6172 7261 7928  y2 = np.asarray(
+0001ad30: 7932 290a 2020 2020 2320 4361 6c63 756c  y2).    # Calcul
+0001ad40: 6174 6573 2074 6865 2073 7461 6e64 6172  ates the standar
+0001ad50: 6420 6465 7669 6174 696f 6e20 6f66 2062  d deviation of b
+0001ad60: 6f74 6820 696e 7075 7420 7369 676e 616c  oth input signal
+0001ad70: 732e 0a20 2020 2073 7464 3120 3d20 7931  s..    std1 = y1
+0001ad80: 2e73 7464 2829 0a20 2020 2073 7464 3220  .std().    std2 
+0001ad90: 3d20 7932 2e73 7464 2829 0a20 2020 2023  = y2.std().    #
+0001ada0: 204e 6f72 6d61 6c69 7a65 7320 626f 7468   Normalizes both
+0001adb0: 2073 6967 6e61 6c73 2c20 6966 2061 7070   signals, if app
+0001adc0: 726f 7072 6961 7465 2e0a 2020 2020 6966  ropriate..    if
+0001add0: 206e 6f72 6d61 6c69 7a65 3a0a 2020 2020   normalize:.    
+0001ade0: 2020 2020 7931 5f6e 6f72 6d61 6c20 3d20      y1_normal = 
+0001adf0: 2879 3120 2d20 7931 2e6d 6561 6e28 2929  (y1 - y1.mean())
+0001ae00: 202f 2073 7464 310a 2020 2020 2020 2020   / std1.        
+0001ae10: 7932 5f6e 6f72 6d61 6c20 3d20 2879 3220  y2_normal = (y2 
+0001ae20: 2d20 7932 2e6d 6561 6e28 2929 202f 2073  - y2.mean()) / s
+0001ae30: 7464 320a 2020 2020 656c 7365 3a0a 2020  td2.    else:.  
+0001ae40: 2020 2020 2020 7931 5f6e 6f72 6d61 6c20        y1_normal 
+0001ae50: 3d20 7931 0a20 2020 2020 2020 2079 325f  = y1.        y2_
+0001ae60: 6e6f 726d 616c 203d 2079 320a 0a20 2020  normal = y2..   
+0001ae70: 2023 2043 616c 6375 6c61 7465 7320 7468   # Calculates th
+0001ae80: 6520 4357 5420 6f66 2074 6865 2074 696d  e CWT of the tim
+0001ae90: 652d 7365 7269 6573 206d 616b 696e 6720  e-series making 
+0001aea0: 7375 7265 2074 6865 2073 616d 6520 7061  sure the same pa
+0001aeb0: 7261 6d65 7465 7273 0a20 2020 2023 2061  rameters.    # a
+0001aec0: 7265 2075 7365 6420 696e 2062 6f74 6820  re used in both 
+0001aed0: 6361 6c63 756c 6174 696f 6e73 2e0a 2020  calculations..  
+0001aee0: 2020 5f6b 7761 7267 7320 3d20 6469 6374    _kwargs = dict
+0001aef0: 2864 6a3d 646a 2c20 7330 3d73 302c 204a  (dj=dj, s0=s0, J
+0001af00: 3d4a 2c20 7761 7665 6c65 743d 7761 7665  =J, wavelet=wave
+0001af10: 6c65 7429 0a20 2020 2057 312c 2073 6a2c  let).    W1, sj,
+0001af20: 2066 7265 712c 2063 6f69 2c20 5f2c 205f   freq, coi, _, _
+0001af30: 203d 2070 7963 7774 2e63 7774 2879 315f   = pycwt.cwt(y1_
+0001af40: 6e6f 726d 616c 2c20 6474 2c20 2a2a 5f6b  normal, dt, **_k
+0001af50: 7761 7267 7329 0a20 2020 2057 322c 2073  wargs).    W2, s
+0001af60: 6a2c 2066 7265 712c 2063 6f69 2c20 5f2c  j, freq, coi, _,
+0001af70: 205f 203d 2070 7963 7774 2e63 7774 2879   _ = pycwt.cwt(y
+0001af80: 325f 6e6f 726d 616c 2c20 6474 2c20 2a2a  2_normal, dt, **
+0001af90: 5f6b 7761 7267 7329 0a0a 2020 2020 7363  _kwargs)..    sc
+0001afa0: 616c 6573 3120 3d20 6e70 2e6f 6e65 7328  ales1 = np.ones(
+0001afb0: 5b31 2c20 7931 2e73 697a 655d 2920 2a20  [1, y1.size]) * 
+0001afc0: 736a 5b3a 2c20 4e6f 6e65 5d0a 2020 2020  sj[:, None].    
+0001afd0: 7363 616c 6573 3220 3d20 6e70 2e6f 6e65  scales2 = np.one
+0001afe0: 7328 5b31 2c20 7932 2e73 697a 655d 2920  s([1, y2.size]) 
+0001aff0: 2a20 736a 5b3a 2c20 4e6f 6e65 5d0a 0a20  * sj[:, None].. 
+0001b000: 2020 2023 2053 6d6f 6f74 6820 7468 6520     # Smooth the 
+0001b010: 7761 7665 6c65 7420 7370 6563 7472 6120  wavelet spectra 
+0001b020: 6265 666f 7265 2074 7275 6e63 6174 696e  before truncatin
+0001b030: 672e 0a20 2020 2053 3120 3d20 7761 7665  g..    S1 = wave
+0001b040: 6c65 742e 736d 6f6f 7468 286e 702e 6162  let.smooth(np.ab
+0001b050: 7328 5731 2920 2a2a 2032 202f 2073 6361  s(W1) ** 2 / sca
+0001b060: 6c65 7331 2c20 6474 2c20 646a 2c20 736a  les1, dt, dj, sj
+0001b070: 290a 2020 2020 5332 203d 2077 6176 656c  ).    S2 = wavel
+0001b080: 6574 2e73 6d6f 6f74 6828 6e70 2e61 6273  et.smooth(np.abs
+0001b090: 2857 3229 202a 2a20 3220 2f20 7363 616c  (W2) ** 2 / scal
+0001b0a0: 6573 322c 2064 742c 2064 6a2c 2073 6a29  es2, dt, dj, sj)
+0001b0b0: 0a0a 2020 2020 2320 4e6f 7720 7468 6520  ..    # Now the 
+0001b0c0: 7761 7665 6c65 7420 7472 616e 7366 6f72  wavelet transfor
+0001b0d0: 6d20 636f 6865 7265 6e63 650a 2020 2020  m coherence.    
+0001b0e0: 5731 3220 3d20 5731 202a 2057 322e 636f  W12 = W1 * W2.co
+0001b0f0: 6e6a 2829 0a20 2020 2073 6361 6c65 7320  nj().    scales 
+0001b100: 3d20 6e70 2e6f 6e65 7328 5b31 2c20 7931  = np.ones([1, y1
+0001b110: 2e73 697a 655d 2920 2a20 736a 5b3a 2c20  .size]) * sj[:, 
+0001b120: 4e6f 6e65 5d0a 2020 2020 5331 3220 3d20  None].    S12 = 
+0001b130: 7761 7665 6c65 742e 736d 6f6f 7468 2857  wavelet.smooth(W
+0001b140: 3132 202f 2073 6361 6c65 732c 2064 742c  12 / scales, dt,
+0001b150: 2064 6a2c 2073 6a29 0a20 2020 2057 4354   dj, sj).    WCT
+0001b160: 203d 206e 702e 6162 7328 5331 3229 202a   = np.abs(S12) *
+0001b170: 2a20 3220 2f20 2853 3120 2a20 5332 290a  * 2 / (S1 * S2).
+0001b180: 2020 2020 6157 4354 203d 206e 702e 616e      aWCT = np.an
+0001b190: 676c 6528 5731 3229 0a0a 2020 2020 2320  gle(W12)..    # 
+0001b1a0: 4361 6c63 756c 6174 6573 2074 6865 2073  Calculates the s
+0001b1b0: 6967 6e69 6669 6361 6e63 6520 7573 696e  ignificance usin
+0001b1c0: 6720 4d6f 6e74 6520 4361 726c 6f20 7369  g Monte Carlo si
+0001b1d0: 6d75 6c61 7469 6f6e 7320 7769 7468 2039  mulations with 9
+0001b1e0: 3525 0a20 2020 2023 2063 6f6e 6669 6465  5%.    # confide
+0001b1f0: 6e63 6520 6173 2061 2066 756e 6374 696f  nce as a functio
+0001b200: 6e20 6f66 2073 6361 6c65 2e0a 0a20 2020  n of scale...   
+0001b210: 2069 6620 7369 673a 0a20 2020 2020 2020   if sig:.       
+0001b220: 2061 312c 2062 312c 2063 3120 3d20 7079   a1, b1, c1 = py
+0001b230: 6377 742e 6172 3128 7931 290a 2020 2020  cwt.ar1(y1).    
+0001b240: 2020 2020 6132 2c20 6232 2c20 6332 203d      a2, b2, c2 =
+0001b250: 2070 7963 7774 2e61 7231 2879 3229 0a20   pycwt.ar1(y2). 
+0001b260: 2020 2020 2020 2073 6967 203d 2070 7963         sig = pyc
+0001b270: 7774 2e77 6374 5f73 6967 6e69 6669 6361  wt.wct_significa
+0001b280: 6e63 6528 0a20 2020 2020 2020 2020 2020  nce(.           
+0001b290: 2061 312c 2061 322c 2064 743d 6474 2c20   a1, a2, dt=dt, 
+0001b2a0: 646a 3d64 6a2c 2073 303d 7330 2c20 4a3d  dj=dj, s0=s0, J=
+0001b2b0: 4a2c 2073 6967 6e69 6669 6361 6e63 655f  J, significance_
+0001b2c0: 6c65 7665 6c3d 7369 676e 6966 6963 616e  level=significan
+0001b2d0: 6365 5f6c 6576 656c 2c20 7761 7665 6c65  ce_level, wavele
+0001b2e0: 743d 7761 7665 6c65 742c 202a 2a6b 7761  t=wavelet, **kwa
+0001b2f0: 7267 730a 2020 2020 2020 2020 290a 2020  rgs.        ).  
+0001b300: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001b310: 7369 6720 3d20 6e70 2e61 7361 7272 6179  sig = np.asarray
+0001b320: 285b 305d 290a 0a20 2020 2072 6574 7572  ([0])..    retur
+0001b330: 6e20 5743 542c 2061 5743 542c 2063 6f69  n WCT, aWCT, coi
+0001b340: 2c20 6672 6571 2c20 7369 670a 0a0a 2323  , freq, sig...##
+0001b350: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b360: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b370: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b380: 2323 2323 2323 2323 2323 2323 2323 0a23  ##############.#
+0001b390: 2323 2323 2323 2323 2323 2323 2323 2320  ############### 
+0001b3a0: 4449 5350 4552 5349 4f4e 2045 5854 5241  DISPERSION EXTRA
+0001b3b0: 4354 494f 4e20 4655 4e43 5449 4f4e 5320  CTION FUNCTIONS 
+0001b3c0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+0001b3d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b3e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b3f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b400: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b410: 0a0a 0a23 2066 756e 6374 696f 6e20 746f  ...# function to
+0001b420: 2065 7874 7261 6374 2074 6865 2064 6973   extract the dis
+0001b430: 7065 7273 696f 6e20 6672 6f6d 2074 6865  persion from the
+0001b440: 2069 6d61 6765 0a64 6566 2065 7874 7261   image.def extra
+0001b450: 6374 5f64 6973 7065 7273 696f 6e28 616d  ct_dispersion(am
+0001b460: 702c 2070 6572 2c20 7665 6c29 3a0a 2020  p, per, vel):.  
+0001b470: 2020 2222 220a 2020 2020 7468 6973 2066    """.    this f
+0001b480: 756e 6374 696f 6e20 7461 6b65 7320 7468  unction takes th
+0001b490: 6520 6469 7370 6572 7369 6f6e 2069 6d61  e dispersion ima
+0001b4a0: 6765 2066 726f 6d20 4357 5420 6173 2069  ge from CWT as i
+0001b4b0: 6e70 7574 2c20 7472 6163 6b73 2074 6865  nput, tracks the
+0001b4c0: 2067 6c6f 6261 6c20 6d61 7869 6e75 6d20   global maxinum 
+0001b4d0: 6f6e 0a20 2020 2074 6865 2077 6176 656c  on.    the wavel
+0001b4e0: 6574 2073 7065 6374 7275 6d20 616d 706c  et spectrum ampl
+0001b4f0: 6974 7564 6520 616e 6420 6578 7472 6163  itude and extrac
+0001b500: 7420 7468 6520 7365 6374 696f 6e73 2077  t the sections w
+0001b510: 6974 6820 636f 6e74 696e 6f75 7320 616e  ith continous an
+0001b520: 6420 6869 6768 2071 7561 6c69 7479 2064  d high quality d
+0001b530: 6174 610a 0a20 2020 2050 4152 414d 4554  ata..    PARAMET
+0001b540: 4552 533a 0a20 2020 202d 2d2d 2d2d 2d2d  ERS:.    -------
+0001b550: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 616d  ---------.    am
+0001b560: 703a 2032 4420 616d 706c 6974 7564 6520  p: 2D amplitude 
+0001b570: 6d61 7472 6978 206f 6620 7468 6520 7761  matrix of the wa
+0001b580: 7665 6c65 7420 7370 6563 7472 756d 0a20  velet spectrum. 
+0001b590: 2020 2070 6861 7365 3a20 3244 2070 6861     phase: 2D pha
+0001b5a0: 7365 206d 6174 7269 7820 6f66 2074 6865  se matrix of the
+0001b5b0: 2077 6176 656c 6574 2073 7065 6374 7275   wavelet spectru
+0001b5c0: 6d0a 2020 2020 7065 723a 2020 7065 7269  m.    per:  peri
+0001b5d0: 6f64 2076 6563 746f 7220 666f 7220 7468  od vector for th
+0001b5e0: 6520 3244 206d 6174 7269 780a 2020 2020  e 2D matrix.    
+0001b5f0: 7665 6c3a 2020 7665 6c20 7665 6374 6f72  vel:  vel vector
+0001b600: 206f 6620 7468 6520 3244 206d 6174 7269   of the 2D matri
+0001b610: 780a 2020 2020 5245 5455 524e 533a 0a20  x.    RETURNS:. 
+0001b620: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
+0001b630: 2d2d 2d0a 2020 2020 7065 723a 2020 6365  ---.    per:  ce
+0001b640: 6e74 7261 6c20 6672 6571 7565 6e63 7920  ntral frequency 
+0001b650: 6f66 2065 6163 6820 7761 7665 6c65 7420  of each wavelet 
+0001b660: 7363 616c 6520 7769 7468 2067 6f6f 6420  scale with good 
+0001b670: 6461 7461 0a20 2020 2067 763a 2020 2067  data.    gv:   g
+0001b680: 726f 7570 2076 656c 6f63 6974 7920 7665  roup velocity ve
+0001b690: 6374 6f72 2061 7420 6561 6368 2066 7265  ctor at each fre
+0001b6a0: 7175 656e 6379 0a20 2020 2022 2222 0a20  quency.    """. 
+0001b6b0: 2020 206d 6178 6761 7020 3d20 350a 2020     maxgap = 5.  
+0001b6c0: 2020 6e70 6572 203d 2061 6d70 2e73 6861    nper = amp.sha
+0001b6d0: 7065 5b30 5d0a 2020 2020 6776 203d 206e  pe[0].    gv = n
+0001b6e0: 702e 7a65 726f 7328 6e70 6572 2c20 6474  p.zeros(nper, dt
+0001b6f0: 7970 653d 6e70 2e66 6c6f 6174 3332 290a  ype=np.float32).
+0001b700: 2020 2020 6476 656c 203d 2076 656c 5b31      dvel = vel[1
+0001b710: 5d20 2d20 7665 6c5b 305d 0a0a 2020 2020  ] - vel[0]..    
+0001b720: 2320 6669 6e64 2067 6c6f 6261 6c20 6d61  # find global ma
+0001b730: 7869 6d75 6d0a 2020 2020 666f 7220 6969  ximum.    for ii
+0001b740: 2069 6e20 7261 6e67 6528 6e70 6572 293a   in range(nper):
+0001b750: 0a20 2020 2020 2020 206d 6178 7661 6c75  .        maxvalu
+0001b760: 6520 3d20 6e70 2e6d 6178 2861 6d70 5b69  e = np.max(amp[i
+0001b770: 695d 2c20 6178 6973 3d30 290a 2020 2020  i], axis=0).    
+0001b780: 2020 2020 696e 6478 203d 206c 6973 7428      indx = list(
+0001b790: 616d 705b 6969 5d29 2e69 6e64 6578 286d  amp[ii]).index(m
+0001b7a0: 6178 7661 6c75 6529 0a20 2020 2020 2020  axvalue).       
+0001b7b0: 2067 765b 6969 5d20 3d20 7665 6c5b 696e   gv[ii] = vel[in
+0001b7c0: 6478 5d0a 0a20 2020 2023 2063 6865 636b  dx]..    # check
+0001b7d0: 2074 6865 2063 6f6e 7469 6e75 6f75 7320   the continuous 
+0001b7e0: 6f66 2074 6865 2064 6973 7065 7273 696f  of the dispersio
+0001b7f0: 6e0a 2020 2020 666f 7220 6969 2069 6e20  n.    for ii in 
+0001b800: 7261 6e67 6528 312c 206e 7065 7220 2d20  range(1, nper - 
+0001b810: 3135 293a 0a20 2020 2020 2020 2023 2031  15):.        # 1
+0001b820: 3520 6973 2074 6865 206d 696e 756d 756d  5 is the minumum
+0001b830: 206c 656e 6774 6820 6e65 6564 6564 2066   length needed f
+0001b840: 6f72 206f 7574 7075 740a 2020 2020 2020  or output.      
+0001b850: 2020 666f 7220 6a6a 2069 6e20 7261 6e67    for jj in rang
+0001b860: 6528 3135 293a 0a20 2020 2020 2020 2020  e(15):.         
+0001b870: 2020 2069 6620 6e70 2e61 6273 2867 765b     if np.abs(gv[
+0001b880: 6969 202b 206a 6a5d 202d 2067 765b 6969  ii + jj] - gv[ii
+0001b890: 202b 2031 202b 206a 6a5d 2920 3e20 6d61   + 1 + jj]) > ma
+0001b8a0: 7867 6170 202a 2064 7665 6c3a 0a20 2020  xgap * dvel:.   
+0001b8b0: 2020 2020 2020 2020 2020 2020 2067 765b               gv[
+0001b8c0: 6969 5d20 3d20 300a 2020 2020 2020 2020  ii] = 0.        
+0001b8d0: 2020 2020 2020 2020 6272 6561 6b0a 0a20          break.. 
+0001b8e0: 2020 2023 2072 656d 6f76 6520 7468 6520     # remove the 
+0001b8f0: 6261 6420 6f6e 6573 0a20 2020 2069 6e64  bad ones.    ind
+0001b900: 7820 3d20 6e70 2e77 6865 7265 2867 7620  x = np.where(gv 
+0001b910: 3e20 3029 5b30 5d0a 0a20 2020 2072 6574  > 0)[0]..    ret
+0001b920: 7572 6e20 7065 725b 696e 6478 5d2c 2067  urn per[indx], g
+0001b930: 765b 696e 6478 5d0a                      v[indx].
```

### Comparing `noisepy_seis-0.5.9/src/noisepy/seis/plotting_modules.py` & `noisepy_seis-0.7.0/src/noisepy/seis/plotting_modules.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,17 +1,22 @@
+import logging
 import os
 
 import matplotlib.pyplot as plt
 import numpy as np
 import obspy
 import pyasdf
 import scipy
 from obspy.signal.filter import bandpass
 from scipy.fftpack import next_fast_len
 
+from noisepy.seis.constants import PROGRESS_DATATYPE
+
+logging.getLogger("matplotlib.font_manager").disabled = True
+
 """
 Ensembles of plotting functions to display intermediate/final waveforms from the NoisePy package.
 by Chengxin Jiang @Harvard (May.04.2019)
 
 Specifically, this plotting module includes functions of:
     1) plot_waveform     -> display the downloaded waveform for specific station
     2) plot_substack_cc  -> plot 2D matrix of the CC functions for one time-chunck (e.g., 2 days)
@@ -160,14 +165,16 @@
     # t is the time labels for plotting
     t = np.arange(-int(disp_lag), int(disp_lag) + dt, step=int(2 * int(disp_lag) / 4))
     # windowing the data
     indx1 = int((maxlag - disp_lag) / dt)
     indx2 = indx1 + 2 * int(disp_lag / dt) + 1
 
     for spair in spairs:
+        if spair == PROGRESS_DATATYPE:
+            continue
         ttr = spair.split("_")
         net1, sta1 = ttr[0].split(".")
         net2, sta2 = ttr[1].split(".")
         for ipath in path_lists:
             chan1, chan2 = ipath.split("_")
             try:
                 dist = ds.auxiliary_data[spair][ipath].parameters["dist"]
```

### Comparing `noisepy_seis-0.5.9/src/noisepy/seis/application_modules/comp_stacking.py` & `noisepy_seis-0.7.0/src/noisepy/seis/application_modules/comp_stacking.py`

 * *Files identical despite different names*

### Comparing `noisepy_seis-0.5.9/src/noisepy/seis/application_modules/dispersion_analysis.py` & `noisepy_seis-0.7.0/src/noisepy/seis/application_modules/dispersion_analysis.py`

 * *Files identical despite different names*

### Comparing `noisepy_seis-0.5.9/src/noisepy/seis/application_modules/measure_dvv.py` & `noisepy_seis-0.7.0/src/noisepy/seis/application_modules/measure_dvv.py`

 * *Files identical despite different names*

### Comparing `noisepy_seis-0.5.9/src/noisepy/seis/application_modules/write_sac.py` & `noisepy_seis-0.7.0/src/noisepy/seis/application_modules/write_sac.py`

 * *Files identical despite different names*

### Comparing `noisepy_seis-0.5.9/LICENSE` & `noisepy_seis-0.7.0/LICENSE`

 * *Files identical despite different names*

### Comparing `noisepy_seis-0.5.9/pyproject.toml` & `noisepy_seis-0.7.0/pyproject.toml`

 * *Files 16% similar despite different names*

```diff
@@ -1,20 +1,20 @@
 [build-system]
-requires = ["hatchling"]
+requires = ["hatchling", "hatch-vcs"]
 build-backend = "hatchling.build"
 
 [project]
 name = "noisepy-seis"
 dynamic = ["version"]
 description = "A High-performance Computing Python Package for Ambient Noise Analysis"
 readme = "README.md"
 license = {file= "LICENSE"}
 requires-python = ">=3.8,<=3.10"
 authors = [
-    { email = "mdenolle@fas.harvard.edu", name = "Marine Denolle" },
+    { email = "mdenolle@uw.edu", name = "Marine Denolle" },
     { email = "chengxin_jiang@fas.harvard.edu", name = "Chengxin Jiang" },
 ]
 keywords = [
     "ambient",
     "change",
     "cross-correlation",
     "dispersion",
@@ -29,29 +29,37 @@
     "Environment :: Console",
     "Intended Audience :: Developers",
     "Intended Audience :: Science/Research",
     "Operating System :: OS Independent",
     "Programming Language :: Python :: 3.8",
 ]
 dependencies = [
+    "DateTimeRange==2.0.0",
     "h5py>=3.8.0",
     "mpi4py>=3.1.4",
     "numba>=0.56.4",
     "numpy>=1.22.0",
     "pandas>=1.5.3",
     "pyasdf>=0.7.5",
     "pycwt>=0.3.0a22",
+    "diskcache>=5.5",
 ]
 
 
 [project.urls]
 Homepage = "https://github.com/mdenolle/NoisePy"
 
 [tool.hatch.version]
-path = "src/noisepy/seis/__init__.py"
+source = "vcs"
+
+[tool.hatch.build.hooks.vcs]
+version-file = "src/noisepy/seis/_version.py"
+
+[tool.hatch.version.raw-options]
+local_scheme = "no-local-version"
 
 [tool.hatch.build.targets.sdist]
 include = [
     "src/noisepy",
 ]
 
 [tool.hatch.build.targets.wheel]
```

